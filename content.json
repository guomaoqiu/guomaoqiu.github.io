{"meta":{"title":"OpsThoughts","subtitle":"Devopsã€Linuxã€Kubernetesã€Dockerã€Flaskã€Pythonã€Shellã€SRE","description":"Happiness is not something ready-made. It comes from your own actionsğŸ’ªğŸ».","author":"NoardGuo-Ops","url":"https://blog.sctux.cc"},"pages":[{"title":"ğŸŒŸ å…³äºæˆ‘","date":"2018-12-12T03:26:52.000Z","updated":"2025-09-02T12:17:06.987Z","comments":true,"path":"about/index.html","permalink":"https://blog.sctux.cc/about/index.html","excerpt":"","text":"å¥½è®°æ€§ï¼Œä¸å¦‚çƒ‚ç¬”å¤´ âœï¸ ğŸš€ åšå®¢å†ç¨‹51cto 2013â€”â€”2014 è‡ªå»ºWordpress 2014â€”â€”2015 Hexo + Github 2015â€”â€”è‡³ä»Š ğŸ‘¨â€ğŸ’» ä¸ªäººç®€ä»‹ğŸ“ å®šå±…æˆéƒ½è‡ª2010å¹´è¸å…¥è®¡ç®—æœºé¢†åŸŸï¼Œç‹¬èº«åŒ—ä¸Šæ±‚å­¦ï¼Œå¥ å®šæŠ€æœ¯æ ¹åŸºã€‚2012å¹´æ­£å¼æŠ•èº«è¡Œä¸šï¼Œé•¿æœŸä¸“æ³¨äºæœåŠ¡å™¨è¿ç»´ä¸æŠ€æœ¯æ¶æ„å·¥ä½œã€‚åœ¨è¿ç»´é¢†åŸŸæ‹¥æœ‰æ‰å®çš„å®è·µç»éªŒï¼Œæ“…é•¿é«˜å¹¶å‘ç³»ç»Ÿä¿éšœã€è‡ªåŠ¨åŒ–è¿ç»´ä½“ç³»æ„å»ºä¸æ€§èƒ½æ·±åº¦ä¼˜åŒ–ï¼Œå§‹ç»ˆåšæŒé€šè¿‡æŠ€æœ¯åˆ›æ–°é©±åŠ¨ä¸šåŠ¡ç¨³å®šä¸æ•ˆç‡æå‡ã€‚ ğŸ¨ ä¸ªäººå…´è¶£ä¹¦æ³• å‰ä»– æ‘„å½± ç¼–ç¨‹ æ—…æ¸¸ çƒ¹é¥ª ğŸ”§ æŠ€æœ¯ä¸“é•¿è¿½å´‡ DevOpsç†å¿µï¼Œè‡´åŠ›äºå®ç°ï¼š æµç¨‹åŒ– âš¡ å·¥å…·åŒ– ğŸ› ï¸ å¹³å°åŒ– ğŸŒ è‡ªåŠ¨åŒ– ğŸ¤– ğŸ›  æŠ€æœ¯æ ˆç³»ç»Ÿä¸è¿ç»´ï¼šLinux Shell Zabbix ELK SaltStack Jenkins å¼€å‘ä¸ç¼–ç¨‹ï¼šPython Flask BlueKing Platform LNMP äº‘å¹³å°ï¼šAliCloud Aws HuaweiCloud å®¹å™¨ä¸ç¼–æ’ï¼šDocker Kubernetes ç‰ˆæœ¬æ§åˆ¶ï¼šGit Github Gitlab Gogs ğŸ”® æœªæ¥å±•æœ› å¯¹äºæœªæ¥ä¸æ•¢æƒ³å¤ªå¤šï¼Œåšå¥½å½“ä¸‹å§~I am too lazy, So, I want make everything automation! ğŸº ä¿æŒçƒ­çˆ±ï¼ŒæŒç»­å­¦ä¹ ï¼Œè‡ªåŠ¨åŒ–ä¸€åˆ‡å¯è‡ªåŠ¨åŒ–çš„äº‹æƒ…ï¼ ğŸš€ ğŸ“ è”ç³»äº¤æµæ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸æˆ‘äº¤æµï¼š ğŸ“§ é‚®ç®±ï¼šguomaoqiu@icloud.com ğŸ“ TG: @noardguo_devops ğŸ’» GitHubï¼šhttps://github.com/guomaoqiu ä¸å¿˜åˆå¿ƒï¼Œæ–¹å¾—å§‹ç»ˆ ğŸŒˆ"},{"title":"æˆ‘çš„ç®€å†","date":"2025-09-03T19:00:00.000Z","updated":"2025-09-03T16:51:37.343Z","comments":true,"path":"resume/index.html","permalink":"https://blog.sctux.cc/resume/index.html","excerpt":"è¯·è¾“å…¥å¯†ç æŸ¥çœ‹å¹¶ä¸‹è½½æˆ‘çš„ç®€å†ã€‚","text":"ff81b43b7e43c5a636aafda9fb25250358d091e1582be1ce2bc4a2d658f70b882ccdddf85a772efcfa8160d7f2d35a36829692f7085e62afef59f113de75c9c75ee2c7e4a968286d55f62fbac971b8e96c0e75e923fad7db7752b3d9012e507a964af6d85963917eb0c53a2cd3dbd1c4e1eee38714546ace9c358a3e68ca14a0c7dda7b499c30c060b9afca3d34b061155f5a8014c72d10a4adaf58781e123946ec153b562dc14b8c9d949b4e50e4f6d51810d731446dc6703df121c22f3fcc28240f08a61961d9e2c6462c07b8ef0fe34c42b41fa50254ca28daa541e96a45104ccee1e9a461fa1b8f581d9fd5b211d322df4876267aafc02324dec2ff9cba704276e2b41091f1a904b56b2ffe14b9eb5c4a7ba7d684e33237e220696eb3f8ffca01c20f0ee9a111ea4520e4193ace3a39ddcc82f9c7c8d9b0414037fe850b63b1ed0e3225400ac5ad2fb49da22f6a7e37ab9e459577bfd964f36c7512d21ab9ae7cd176754c4fbb25d01922f806fa6230a22924a273212ec0e4d1f1e3ac5adef14eac05ec37ad955e511c888f41eac2afaf63612ee27182e5850ab7144f121 è¯·è”ç³»æˆ‘æœ¬äººç´¢å–å¯†ç ï¼Œè°¢è°¢ã€‚"},{"title":"Categories","date":"2025-09-01T01:59:09.360Z","updated":"2025-09-01T01:59:09.360Z","comments":false,"path":"categories/index.html","permalink":"https://blog.sctux.cc/categories/index.html","excerpt":"","text":""},{"title":"Tags","date":"2025-09-01T01:59:09.358Z","updated":"2025-09-01T01:59:09.358Z","comments":false,"path":"tags/index.html","permalink":"https://blog.sctux.cc/tags/index.html","excerpt":"","text":""},{"title":"ğŸš€ ä¸ªäººå¼€æºä½œå“é›†","date":"2018-12-12T03:26:52.000Z","updated":"2025-09-01T01:59:09.358Z","comments":true,"path":"works/index.html","permalink":"https://blog.sctux.cc/works/index.html","excerpt":"","text":"ğŸ”§ è¿ç»´å¼€å‘å¹³å°1. åŸºäºè…¾è®¯è“é²¸é›†æˆå¹³å°å¼€å‘çš„è¿ç»´åå° æŠ€æœ¯æ ˆ: è…¾è®¯è“é²¸å¹³å° | Python | Django ç®€ä»‹: ä¼ä¸šçº§è¿ç»´è‡ªåŠ¨åŒ–è§£å†³æ–¹æ¡ˆï¼Œé›†æˆCMDBã€ä½œä¸šå¹³å°ç­‰æ ¸å¿ƒåŠŸèƒ½ 2. åŸºäºè…¾è®¯è“é²¸é›†æˆå¹³å°å¼€å‘çš„ App æƒé™ç®¡æ§å¹³å° æŠ€æœ¯æ ˆ: è…¾è®¯è“é²¸å¹³å° | æƒé™ç®¡ç† | RBAC ç®€ä»‹: ç»†ç²’åº¦çš„åº”ç”¨æƒé™ç®¡ç†ç³»ç»Ÿï¼Œä¿éšœå¹³å°å®‰å…¨è®¿é—® 3. åŸºäº Flask+Bootstrap å¼€å‘çš„è¿ç»´ç®¡ç†åå° ğŸŒ Demo: http://demo.sctux.cc æŠ€æœ¯æ ˆ: Flask | Bootstrap | MySQL æ³¨: Demoç¯å¢ƒéƒ¨ç½²åœ¨æµ·å¤–æœåŠ¡å™¨ï¼Œè®¿é—®ç¼“æ…¢æ—¶å¯å°è¯•ä½¿ç”¨ç½‘ç»œåŠ é€Ÿå·¥å…· â° ä»»åŠ¡è°ƒåº¦å¹³å°4. å®šæ—¶ä½œä¸šä»»åŠ¡å¹³å° ğŸŒ Demo: http://jobcenter.sctux.cc åŠŸèƒ½: åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ | æ‰§è¡Œå†å² | å®æ—¶æ—¥å¿— 5. Supervisor å¤šèŠ‚ç‚¹ç®¡ç†å¹³å° ğŸŒ Demo: http://super.sctux.cc åŠŸèƒ½: å¤šèŠ‚ç‚¹ç›‘æ§ | è¿›ç¨‹ç®¡ç† | çŠ¶æ€å¯è§†åŒ– â˜ï¸ äº‘å¹³å°å·¥å…·6. ä¸“å±äº‘å·¡æ£€å¹³å° ğŸ“– è¯¦ç»†ä»‹ç»: è‡ªåŠ¨åŒ–å·¡æ£€çš„å¿…è¦æ€§ä»¥åŠé‡è¦æ€§ åŠŸèƒ½: è‡ªåŠ¨åŒ–å·¡æ£€ | å¥åº·æ£€æŸ¥ | æŠ¥è¡¨ç”Ÿæˆ ğŸŒ³ æŠ€èƒ½å›¾è°±7. æˆ‘çš„æŠ€èƒ½æ ‘ å†…å®¹: æŠ€æœ¯æ ˆå…¨æ™¯ | ç†Ÿç»ƒç¨‹åº¦ | å­¦ä¹ è·¯å¾„ 8. æŠ€æœ¯è¯ä¹¦CKA æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ iframeã€‚ ç‚¹å‡»è¿™é‡Œä¸‹è½½ PDFã€‚ RHCE æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ iframeã€‚ ç‚¹å‡»è¿™é‡Œä¸‹è½½ PDFã€‚ ğŸ“« è”ç³»æˆ‘å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–åˆä½œæ„å‘ï¼Œæ¬¢è¿é€šè¿‡ GitHub æäº¤ Issue æˆ–é€šè¿‡åšå®¢ç•™è¨€è”ç³»ï¼ ä¿æŒå¼€æºç²¾ç¥ï¼Œå…±åŒè¿›æ­¥ï¼ ğŸ¯"},{"title":"","date":"2025-09-01T01:59:09.360Z","updated":"2025-09-01T01:59:09.360Z","comments":true,"path":"kubernetes/yaml/static-pod.json","permalink":"https://blog.sctux.cc/kubernetes/yaml/static-pod.json","excerpt":"","text":"{\"apiVersion\":\"v1\",\"kind\":\"Pod\",\"metadata\":{\"name\":\"static-web-from-url\",\"labels\":{\"role\":\"myrole\"}},\"spec\":{\"containers\":[{\"name\":\"web\",\"image\":\"nginx\",\"ports\":[{\"name\":\"web\",\"containerPort\":80,\"protocol\":\"TCP\"}]}]}}"}],"posts":[{"title":"æ±‚èŒ-ç³»ç»Ÿè¿ç»´/SREæ–¹å‘","slug":"æ±‚èŒå¸–","date":"2025-09-03T16:01:01.000Z","updated":"2025-09-04T04:53:51.963Z","comments":true,"path":"2025/09/04/æ±‚èŒå¸–/","permalink":"https://blog.sctux.cc/2025/09/04/%E6%B1%82%E8%81%8C%E5%B8%96/","excerpt":"å„ä½æœ‹å‹ï¼Œå¤§å®¶å¥½ï¼ æˆ‘äºä»Šå¹´7æœˆåº•æ­£å¼ç¦»èŒï¼Œç»“æŸäº†ä¸Šä¸€æ®µå·¥ä½œæ—…ç¨‹ã€‚ç›®å‰æ­£åœ¨å¯»æ‰¾ä¸‹ä¸€ä»½ç³»ç»Ÿè¿ç»´æˆ–SREç›¸å…³çš„å·¥ä½œï¼Œå¸Œæœ›èƒ½å€ŸåŠ©å¤§å®¶çš„åŠ›é‡ã€‚ æˆ‘æœ‰10å¹´å·¦å³çš„è¿ç»´ç»éªŒï¼Œåœ¨è¿™æœŸé—´ä»äº‹è¿‡IDCã€æ¸¸æˆã€ç‰©è”ç½‘ã€åŒºå—é“¾è¡Œä¸šã€‚ç†Ÿç»ƒä½¿ç”¨Linuxæ“ä½œç³»ç»Ÿã€Kubernetesé›†ç¾¤éƒ¨ç½²ç»´æŠ¤ã€ç›‘æ§ç³»ç»Ÿéƒ¨ç½²ç»´æŠ¤ä»¥åŠäºŒæ¬¡å¼€å‘ä»¥åŠä¸€äº›è‡ªåŠ¨åŒ–è„šæœ¬å·¥å…·å¼€å‘çš„èƒ½åŠ›ã€‚åœ¨è¿‡å»çš„å·¥ä½œä¸­ï¼Œæˆ‘è´Ÿè´£ç»´æŠ¤ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œï¼Œå¤„ç†è¿‡ä¸€äº›æ•…éšœï¼Œä¹Ÿå‚ä¸ä»ä¼ ç»Ÿæ¶æ„åˆ°äº‘åŸç”Ÿæ¶æ„çš„è¿ç§»å’Œè½¬å‹ã€‚æˆ‘ä¸æ˜¯æœ€é¡¶å°–çš„å¤§ç‰›ï¼Œä½†æˆ‘ç›¸ä¿¡è‡ªå·±æœ‰å¾ˆå¼ºçš„è´£ä»»å¿ƒã€å­¦ä¹ èƒ½åŠ›å’Œå›¢é˜Ÿåä½œç²¾ç¥ï¼Œèƒ½è„šè¸å®åœ°åœ°å®Œæˆä»»åŠ¡ã€‚ æˆ‘ä¸ªäººéå¸¸çƒ­çˆ±è¿ç»´è¿™ä¸ªäº‹ä¸šï¼Œä½œä¸ºè¿ç»´/SREåœ¨ä¸ºå…¬å¸åˆ›é€ ä»·å€¼çš„åŒæ—¶èƒ½æ»¡è¶³è‡ªå·±çš„æˆå°±æ„Ÿæ˜¯éå¸¸å®Œç¾çš„ä¸€ä»¶äº‹æƒ…ã€‚éå¸¸æ¸´æœ›èƒ½åŠ å…¥ä¸€ä¸ªä¼˜ç§€çš„å›¢é˜Ÿï¼Œä¸å¤§å®¶å…±åŒæˆé•¿ï¼Œä¸ºå…¬å¸è´¡çŒ®å‡ºè‡ªå·±çš„å…¨éƒ¨èƒ½åŠ›ã€‚ å¦‚æœæ‚¨æ‰€åœ¨å›¢é˜Ÿæœ‰æ‹›è˜éœ€æ±‚ï¼Œæˆ–è€…æœ‰ç›¸å…³çš„ä¿¡æ¯ï¼Œæ³è¯·æ‚¨ä¸åæ¨èæˆ–è”ç³»æˆ‘ã€‚æ„Ÿæ¿€ä¸å°½ï¼ ğŸ“ æˆ‘çš„è”ç³»æ–¹å¼æ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸æˆ‘äº¤æµï¼š ğŸ“§ é‚®ç®±ï¼šguomaoqiu@icloud.com ğŸ“ TG: @noardguo_devops ğŸ’» GitHubï¼šhttps://github.com/guomaoqiu","text":"å„ä½æœ‹å‹ï¼Œå¤§å®¶å¥½ï¼ æˆ‘äºä»Šå¹´7æœˆåº•æ­£å¼ç¦»èŒï¼Œç»“æŸäº†ä¸Šä¸€æ®µå·¥ä½œæ—…ç¨‹ã€‚ç›®å‰æ­£åœ¨å¯»æ‰¾ä¸‹ä¸€ä»½ç³»ç»Ÿè¿ç»´æˆ–SREç›¸å…³çš„å·¥ä½œï¼Œå¸Œæœ›èƒ½å€ŸåŠ©å¤§å®¶çš„åŠ›é‡ã€‚ æˆ‘æœ‰10å¹´å·¦å³çš„è¿ç»´ç»éªŒï¼Œåœ¨è¿™æœŸé—´ä»äº‹è¿‡IDCã€æ¸¸æˆã€ç‰©è”ç½‘ã€åŒºå—é“¾è¡Œä¸šã€‚ç†Ÿç»ƒä½¿ç”¨Linuxæ“ä½œç³»ç»Ÿã€Kubernetesé›†ç¾¤éƒ¨ç½²ç»´æŠ¤ã€ç›‘æ§ç³»ç»Ÿéƒ¨ç½²ç»´æŠ¤ä»¥åŠäºŒæ¬¡å¼€å‘ä»¥åŠä¸€äº›è‡ªåŠ¨åŒ–è„šæœ¬å·¥å…·å¼€å‘çš„èƒ½åŠ›ã€‚åœ¨è¿‡å»çš„å·¥ä½œä¸­ï¼Œæˆ‘è´Ÿè´£ç»´æŠ¤ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œï¼Œå¤„ç†è¿‡ä¸€äº›æ•…éšœï¼Œä¹Ÿå‚ä¸ä»ä¼ ç»Ÿæ¶æ„åˆ°äº‘åŸç”Ÿæ¶æ„çš„è¿ç§»å’Œè½¬å‹ã€‚æˆ‘ä¸æ˜¯æœ€é¡¶å°–çš„å¤§ç‰›ï¼Œä½†æˆ‘ç›¸ä¿¡è‡ªå·±æœ‰å¾ˆå¼ºçš„è´£ä»»å¿ƒã€å­¦ä¹ èƒ½åŠ›å’Œå›¢é˜Ÿåä½œç²¾ç¥ï¼Œèƒ½è„šè¸å®åœ°åœ°å®Œæˆä»»åŠ¡ã€‚ æˆ‘ä¸ªäººéå¸¸çƒ­çˆ±è¿ç»´è¿™ä¸ªäº‹ä¸šï¼Œä½œä¸ºè¿ç»´/SREåœ¨ä¸ºå…¬å¸åˆ›é€ ä»·å€¼çš„åŒæ—¶èƒ½æ»¡è¶³è‡ªå·±çš„æˆå°±æ„Ÿæ˜¯éå¸¸å®Œç¾çš„ä¸€ä»¶äº‹æƒ…ã€‚éå¸¸æ¸´æœ›èƒ½åŠ å…¥ä¸€ä¸ªä¼˜ç§€çš„å›¢é˜Ÿï¼Œä¸å¤§å®¶å…±åŒæˆé•¿ï¼Œä¸ºå…¬å¸è´¡çŒ®å‡ºè‡ªå·±çš„å…¨éƒ¨èƒ½åŠ›ã€‚ å¦‚æœæ‚¨æ‰€åœ¨å›¢é˜Ÿæœ‰æ‹›è˜éœ€æ±‚ï¼Œæˆ–è€…æœ‰ç›¸å…³çš„ä¿¡æ¯ï¼Œæ³è¯·æ‚¨ä¸åæ¨èæˆ–è”ç³»æˆ‘ã€‚æ„Ÿæ¿€ä¸å°½ï¼ ğŸ“ æˆ‘çš„è”ç³»æ–¹å¼æ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸æˆ‘äº¤æµï¼š ğŸ“§ é‚®ç®±ï¼šguomaoqiu@icloud.com ğŸ“ TG: @noardguo_devops ğŸ’» GitHubï¼šhttps://github.com/guomaoqiu","categories":[],"tags":[],"keywords":[]},{"title":"Dockeræ„å»ºæ—¥å¿—æ”¶é›†å¹³å°EFK(TLS)","slug":"Dockeræ„å»ºæ—¥å¿—æ”¶é›†å¹³å°EFK-TLS","date":"2024-07-23T01:56:27.000Z","updated":"2025-09-01T01:59:08.871Z","comments":true,"path":"2024/07/23/Dockeræ„å»ºæ—¥å¿—æ”¶é›†å¹³å°EFK-TLS/","permalink":"https://blog.sctux.cc/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/","excerpt":"å‰è¨€å¦‚é¢˜ï¼Œ ä¸»è¦è®°å½•ä¸€ä¸‹ä¹‹å‰æ­å»ºéƒ¨ç½²çš„ä¸€å¥—æ—¥å¿—æ”¶é›†ç³»ç»Ÿã€‚è¿™é‡Œé‡‡ç”¨docker-composeçš„æ–¹å¼è¿è¡Œï¼Œè¿˜æ˜¯é‚£å¥è¯ä¸»è¦æ˜¯æ€è·¯ã€‚ æ–¹å¼: ä¸€å°æœåŠ¡å™¨ä¸Šé¢åˆ©ç”¨docker-composeè¿è¡Œä¸‰ä¸ªESèŠ‚ç‚¹è·ŸKibana,å¹¶å¯ç”¨SSL,å†ä½¿ç”¨Filebeatæ¥æ”¶é›†æœåŠ¡å™¨ä¸Šé¢çš„åº”ç”¨æ—¥å¿—åˆ°ESï¼Œ æœ€åKibanaæ¥åšå±•ç¤º é…ç½®ç›®å½•åˆ›å»º1234mkdir -p /data/{es/node-1/{data,certs,logs,config},plugins}mkdir -p /data/{es/node-2/{data,certs,logs,config},plugins}mkdir -p /data/{es/node-3/{data,certs,logs,config},plugins}mkdir -p /data/kibana/{certs,config} -p éƒ¨ç½²æ–‡ä»¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131version: \"3\"services: node-1: image: registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:7.17.5 networks: bitdata: ipv4_address: 172.20.0.3 container_name: node-1 hostname: node-1 environment: - \"ES_JAVA_OPTS=-Xms1024m -Xmx1024m\" - \"TZ=Asia/Shanghai\" ulimits: memlock: soft: -1 hard: -1 nofile: soft: 65536 hard: 65536 ports: - \"9200:9200\" logging: driver: \"json-file\" options: max-size: \"50m\" volumes: - ./es/node-1/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml - ./es/plugins:/usr/share/elasticsearch/plugins - ./es/node-1/data:/usr/share/elasticsearch/data - ./es/node-1/certs:/usr/share/elasticsearch/config/certs - ./es/node-1/log:/usr/share/elasticsearch/log healthcheck: test: [\"CMD-SHELL\", \"curl -I http://localhost:9200 || exit 1\"] interval: 10s timeout: 10s retries: 5 node-2: image: registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:7.17.5 networks: bitdata: ipv4_address: 172.20.0.4 container_name: node-2 hostname: node-2 environment: - \"ES_JAVA_OPTS=-Xms1024m -Xmx1024m\" - \"TZ=Asia/Shanghai\" ulimits: memlock: soft: -1 hard: -1 nofile: soft: 65536 hard: 65536 ports: - \"9201:9200\" logging: driver: \"json-file\" options: max-size: \"50m\" volumes: - ./es/node-2/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml - ./es/plugins:/usr/share/elasticsearch/plugins - ./es/node-2/data:/usr/share/elasticsearch/data - ./es/node-2/certs:/usr/share/elasticsearch/config/certs - ./es/node-2/log:/usr/share/elasticsearch/log healthcheck: test: [\"CMD-SHELL\", \"curl -I http://localhost:9200 || exit 1\"] interval: 10s timeout: 10s retries: 5 node-3: image: registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:7.17.5 networks: bitdata: ipv4_address: 172.20.0.5 container_name: node-3 hostname: node-3 environment: - \"ES_JAVA_OPTS=-Xms1024m -Xmx1024m\" - \"TZ=Asia/Shanghai\" ulimits: memlock: soft: -1 hard: -1 nofile: soft: 65536 hard: 65536 ports: - \"9202:9200\" logging: driver: \"json-file\" options: max-size: \"50m\" volumes: - ./es/node-3/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml - ./es/plugins:/usr/share/elasticsearch/plugins - ./es/node-3/data:/usr/share/elasticsearch/data - ./es/node-3/certs:/usr/share/elasticsearch/config/certs - ./es/node-3/log:/usr/share/elasticsearch/log healthcheck: test: [\"CMD-SHELL\", \"curl -I http://localhost:9200 || exit 1\"] interval: 10s timeout: 10s retries: 5 kibana: networks: bitdata: ipv4_address: 172.20.0.6 container_name: kibana hostname: kibana image: registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/kibana:7.17.5 environment: TZ: 'Asia/Shanghai' volumes: - ./kibana/cert:/etc/kibana/cert - ./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml ports: - 5601:5601 healthcheck: test: [\"CMD-SHELL\", \"curl -I http://localhost:5601 || exit 1\"] interval: 10s timeout: 10s retries: 5# è¿æ¥å¤–éƒ¨ç½‘ç»œnetworks: bitdata: driver: bridge ipam: config: - subnet: 172.20.0.0/24 éSSLelasticsearch.yamlé…ç½®æ–‡ä»¶","text":"å‰è¨€å¦‚é¢˜ï¼Œ ä¸»è¦è®°å½•ä¸€ä¸‹ä¹‹å‰æ­å»ºéƒ¨ç½²çš„ä¸€å¥—æ—¥å¿—æ”¶é›†ç³»ç»Ÿã€‚è¿™é‡Œé‡‡ç”¨docker-composeçš„æ–¹å¼è¿è¡Œï¼Œè¿˜æ˜¯é‚£å¥è¯ä¸»è¦æ˜¯æ€è·¯ã€‚ æ–¹å¼: ä¸€å°æœåŠ¡å™¨ä¸Šé¢åˆ©ç”¨docker-composeè¿è¡Œä¸‰ä¸ªESèŠ‚ç‚¹è·ŸKibana,å¹¶å¯ç”¨SSL,å†ä½¿ç”¨Filebeatæ¥æ”¶é›†æœåŠ¡å™¨ä¸Šé¢çš„åº”ç”¨æ—¥å¿—åˆ°ESï¼Œ æœ€åKibanaæ¥åšå±•ç¤º é…ç½®ç›®å½•åˆ›å»º1234mkdir -p /data/{es/node-1/{data,certs,logs,config},plugins}mkdir -p /data/{es/node-2/{data,certs,logs,config},plugins}mkdir -p /data/{es/node-3/{data,certs,logs,config},plugins}mkdir -p /data/kibana/{certs,config} -p éƒ¨ç½²æ–‡ä»¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131version: \"3\"services: node-1: image: registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:7.17.5 networks: bitdata: ipv4_address: 172.20.0.3 container_name: node-1 hostname: node-1 environment: - \"ES_JAVA_OPTS=-Xms1024m -Xmx1024m\" - \"TZ=Asia/Shanghai\" ulimits: memlock: soft: -1 hard: -1 nofile: soft: 65536 hard: 65536 ports: - \"9200:9200\" logging: driver: \"json-file\" options: max-size: \"50m\" volumes: - ./es/node-1/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml - ./es/plugins:/usr/share/elasticsearch/plugins - ./es/node-1/data:/usr/share/elasticsearch/data - ./es/node-1/certs:/usr/share/elasticsearch/config/certs - ./es/node-1/log:/usr/share/elasticsearch/log healthcheck: test: [\"CMD-SHELL\", \"curl -I http://localhost:9200 || exit 1\"] interval: 10s timeout: 10s retries: 5 node-2: image: registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:7.17.5 networks: bitdata: ipv4_address: 172.20.0.4 container_name: node-2 hostname: node-2 environment: - \"ES_JAVA_OPTS=-Xms1024m -Xmx1024m\" - \"TZ=Asia/Shanghai\" ulimits: memlock: soft: -1 hard: -1 nofile: soft: 65536 hard: 65536 ports: - \"9201:9200\" logging: driver: \"json-file\" options: max-size: \"50m\" volumes: - ./es/node-2/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml - ./es/plugins:/usr/share/elasticsearch/plugins - ./es/node-2/data:/usr/share/elasticsearch/data - ./es/node-2/certs:/usr/share/elasticsearch/config/certs - ./es/node-2/log:/usr/share/elasticsearch/log healthcheck: test: [\"CMD-SHELL\", \"curl -I http://localhost:9200 || exit 1\"] interval: 10s timeout: 10s retries: 5 node-3: image: registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:7.17.5 networks: bitdata: ipv4_address: 172.20.0.5 container_name: node-3 hostname: node-3 environment: - \"ES_JAVA_OPTS=-Xms1024m -Xmx1024m\" - \"TZ=Asia/Shanghai\" ulimits: memlock: soft: -1 hard: -1 nofile: soft: 65536 hard: 65536 ports: - \"9202:9200\" logging: driver: \"json-file\" options: max-size: \"50m\" volumes: - ./es/node-3/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml - ./es/plugins:/usr/share/elasticsearch/plugins - ./es/node-3/data:/usr/share/elasticsearch/data - ./es/node-3/certs:/usr/share/elasticsearch/config/certs - ./es/node-3/log:/usr/share/elasticsearch/log healthcheck: test: [\"CMD-SHELL\", \"curl -I http://localhost:9200 || exit 1\"] interval: 10s timeout: 10s retries: 5 kibana: networks: bitdata: ipv4_address: 172.20.0.6 container_name: kibana hostname: kibana image: registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/kibana:7.17.5 environment: TZ: 'Asia/Shanghai' volumes: - ./kibana/cert:/etc/kibana/cert - ./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml ports: - 5601:5601 healthcheck: test: [\"CMD-SHELL\", \"curl -I http://localhost:5601 || exit 1\"] interval: 10s timeout: 10s retries: 5# è¿æ¥å¤–éƒ¨ç½‘ç»œnetworks: bitdata: driver: bridge ipam: config: - subnet: 172.20.0.0/24 éSSLelasticsearch.yamlé…ç½®æ–‡ä»¶è¿™é‡Œä»¥node-1ä¸ºä¾‹ï¼Œå…¶ä»–ä¸åŒçš„åœ°æ–¹å°±æ˜¯ node.name 12345678910111213141516171819202122232425262728293031323334353637383940vim /data/es/node-1/config/elasticsearch.yml#é›†ç¾¤åç§°cluster.name: elastic#å½“å‰è¯¥èŠ‚ç‚¹çš„åç§°node.name: node-1#æ˜¯ä¸æ˜¯æœ‰èµ„æ ¼ç«é€‰ä¸»èŠ‚ç‚¹node.master: true#æ˜¯å¦å­˜å‚¨æ•°æ®node.data: true#æœ€å¤§é›†ç¾¤èŠ‚ç‚¹æ•°node.max_local_storage_nodes: 3#ç»™å½“å‰èŠ‚ç‚¹è‡ªå®šä¹‰å±æ€§ï¼ˆå¯ä»¥çœç•¥ï¼‰#node.attr.rack: r1#æ•°æ®å­˜æ¡£ä½ç½®path.data: /usr/share/elasticsearch/data#æ—¥å¿—å­˜æ”¾ä½ç½®path.logs: /usr/share/elasticsearch/log#æ˜¯å¦å¼€å¯æ—¶é”å®šå†…å­˜ï¼ˆé»˜è®¤ä¸ºæ˜¯ï¼‰#bootstrap.memory_lock: true#è®¾ç½®ç½‘å…³åœ°å€ï¼Œæˆ‘æ˜¯è¢«è¿™ä¸ªå‘æ­»äº†ï¼Œè¿™ä¸ªåœ°å€æˆ‘åŸå…ˆå¡«å†™äº†è‡ªå·±çš„å®é™…ç‰©ç†IPåœ°å€ï¼Œ#ç„¶åå¯åŠ¨ä¸€ç›´æŠ¥æ— æ•ˆçš„IPåœ°å€ï¼Œæ— æ³•æ³¨å…¥9300ç«¯å£ï¼Œè¿™é‡Œåªéœ€è¦å¡«å†™0.0.0.0network.host: 0.0.0.0#è®¾ç½®æ˜ å°„ç«¯å£http.port: 9200#å†…éƒ¨èŠ‚ç‚¹ä¹‹é—´æ²Ÿé€šç«¯å£transport.tcp.port: 9300#é›†ç¾¤å‘ç°é»˜è®¤å€¼ä¸º127.0.0.1:9300,å¦‚æœè¦åœ¨å…¶ä»–ä¸»æœºä¸Šå½¢æˆåŒ…å«èŠ‚ç‚¹çš„ç¾¤é›†,å¦‚æœæ­å»ºé›†ç¾¤åˆ™éœ€è¦å¡«å†™#es7.x ä¹‹åæ–°å¢çš„é…ç½®ï¼Œå†™å…¥å€™é€‰ä¸»èŠ‚ç‚¹çš„è®¾å¤‡åœ°å€ï¼Œåœ¨å¼€å¯æœåŠ¡åå¯ä»¥è¢«é€‰ä¸ºä¸»èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å†™ä¸Šdiscovery.seed_hosts: [\"172.20.0.3\",\"172.20.0.4\",\"172.17.0.5\"]#å½“ä½ åœ¨æ­å»ºé›†ç¾¤çš„æ—¶å€™ï¼Œé€‰å‡ºåˆæ ¼çš„èŠ‚ç‚¹é›†ç¾¤ï¼Œæœ‰äº›äººè¯´çš„å¤ªå®˜æ–¹äº†ï¼Œ#å…¶å®å°±æ˜¯ï¼Œè®©ä½ é€‰æ‹©æ¯”è¾ƒå¥½çš„å‡ ä¸ªèŠ‚ç‚¹ï¼Œåœ¨ä½ èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œåœ¨è¿™äº›èŠ‚ç‚¹ä¸­é€‰ä¸€ä¸ªåšé¢†å¯¼è€…ï¼Œ#å¦‚æœä½ ä¸è®¾ç½®å‘¢ï¼Œelasticsearchå°±ä¼šè‡ªå·±é€‰ä¸¾ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠä¸‰ä¸ªèŠ‚ç‚¹éƒ½å†™ä¸Šcluster.initial_master_nodes: [\"node-1\",\"node-2\",\"node-3\"]#åœ¨ç¾¤é›†å®Œå…¨é‡æ–°å¯åŠ¨åé˜»æ­¢åˆå§‹æ¢å¤ï¼Œç›´åˆ°å¯åŠ¨Nä¸ªèŠ‚ç‚¹#ç®€å•ç‚¹è¯´åœ¨é›†ç¾¤å¯åŠ¨åï¼Œè‡³å°‘å¤æ´»å¤šå°‘ä¸ªèŠ‚ç‚¹ä»¥ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡æ‰å¯ä»¥è¢«ä½¿ç”¨ï¼Œå¦åˆ™ä¸å¯ä»¥è¢«ä½¿ç”¨ï¼Œgateway.recover_after_nodes: 2#åˆ é™¤ç´¢å¼•æ˜¯æ˜¯å¦éœ€è¦æ˜¾ç¤ºå…¶åç§°ï¼Œé»˜è®¤ä¸ºæ˜¾ç¤º#action.destructive_requires_name: true# ç¦ç”¨å®‰å…¨é…ç½®xpack.security.enabled: false kibana.yaml1234567891011121314vim /data/kibana/config/kibana.ymlserver.host: 0.0.0.0# ç›‘å¬ç«¯å£server.port: 5601server.name: \"kibana\"# kibanaè®¿é—®esæœåŠ¡å™¨çš„URL,å°±å¯ä»¥æœ‰å¤šä¸ªï¼Œä»¥é€—å·\",\"éš”å¼€elasticsearch.hosts: [\"http://172.20.0.3:9200\",\"http://172.20.0.4:9200\",\"http://172.20.0.5:9200\"]monitoring.ui.container.elasticsearch.enabled: true# kibanaè®¿é—®Elasticsearchçš„è´¦å·ä¸å¯†ç (å¦‚æœElasticSearchè®¾ç½®äº†çš„è¯)elasticsearch.username: \"\"elasticsearch.password: \"\"# kibana webè¯­è¨€i18n.locale: \"zh-CN\" å¯åŠ¨12345678910111213root@ip-10-10-10-29:/data# docker-compose up -d[+] Running 5/5 â ¿ Network data_bitdata Created 0.0s â ¿ Container node-2 Started 0.6s â ¿ Container node-3 Started 0.8s â ¿ Container node-1 Started 0.8s â ¿ Container kibana Started 0.5sCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES4d5dae9021be registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:7.17.5 \"/bin/tini -- /usr/lâ€¦\" About a minute ago Up About a minute (healthy) 0.0.0.0:9200-&gt;9200/tcp, :::9200-&gt;9200/tcp, 9300/tcp node-184e191d6f875 registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:7.17.5 \"/bin/tini -- /usr/lâ€¦\" About a minute ago Up About a minute (healthy) 9300/tcp, 0.0.0.0:9202-&gt;9200/tcp, :::9202-&gt;9200/tcp node-3758a4bff2a73 registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:7.17.5 \"/bin/tini -- /usr/lâ€¦\" About a minute ago Up About a minute (healthy) 9300/tcp, 0.0.0.0:9201-&gt;9200/tcp, :::9201-&gt;9200/tcp node-2fe55f0446902 registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/kibana:7.17.5 \"/bin/tini -- /usr/lâ€¦\" About a minute ago Up About a minute (healthy) 0.0.0.0:5601-&gt;5601/tcp, :::5601-&gt;5601/tcp kibana ä¸Šé¢å·²ç»å¯åŠ¨ï¼Œå¦‚æœæœ‰æŠ¥é”™æŸ¥çœ‹å®¹å™¨æ—¥å¿—å°±è¡Œäº†ï¼Œä¹‹å‰éƒ¨ç½²çš„æ—¶å€™æŠ¥é”™å†…å®¹è¿˜æ˜¯å¾ˆæ¸…æ™° è¿›å…¥å®¹å™¨æŸ¥çœ‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091root@node-1:/usr/share/elasticsearch# curl localhost:9200{ \"name\" : \"node-1\", \"cluster_name\" : \"elastic\", \"cluster_uuid\" : \"tcKUxyWVQb-7LV4zmomsgg\", \"version\" : { \"number\" : \"7.17.5\", \"build_flavor\" : \"default\", \"build_type\" : \"docker\", \"build_hash\" : \"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84\", \"build_date\" : \"2022-06-23T21:57:28.736740635Z\", \"build_snapshot\" : false, \"lucene_version\" : \"8.11.1\", \"minimum_wire_compatibility_version\" : \"6.8.0\", \"minimum_index_compatibility_version\" : \"6.0.0-beta1\" }, \"tagline\" : \"You Know, for Search\"}root@node-1:/usr/share/elasticsearch# curl 172.20.3:9200{ \"name\" : \"node-1\", \"cluster_name\" : \"elastic\", \"cluster_uuid\" : \"tcKUxyWVQb-7LV4zmomsgg\", \"version\" : { \"number\" : \"7.17.5\", \"build_flavor\" : \"default\", \"build_type\" : \"docker\", \"build_hash\" : \"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84\", \"build_date\" : \"2022-06-23T21:57:28.736740635Z\", \"build_snapshot\" : false, \"lucene_version\" : \"8.11.1\", \"minimum_wire_compatibility_version\" : \"6.8.0\", \"minimum_index_compatibility_version\" : \"6.0.0-beta1\" }, \"tagline\" : \"You Know, for Search\"}root@node-1:/usr/share/elasticsearch# curl 172.20.4:9200{ \"name\" : \"node-2\", \"cluster_name\" : \"elastic\", \"cluster_uuid\" : \"tcKUxyWVQb-7LV4zmomsgg\", \"version\" : { \"number\" : \"7.17.5\", \"build_flavor\" : \"default\", \"build_type\" : \"docker\", \"build_hash\" : \"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84\", \"build_date\" : \"2022-06-23T21:57:28.736740635Z\", \"build_snapshot\" : false, \"lucene_version\" : \"8.11.1\", \"minimum_wire_compatibility_version\" : \"6.8.0\", \"minimum_index_compatibility_version\" : \"6.0.0-beta1\" }, \"tagline\" : \"You Know, for Search\"}root@node-1:/usr/share/elasticsearch# curl 172.20.5:9200{ \"name\" : \"node-3\", \"cluster_name\" : \"elastic\", \"cluster_uuid\" : \"tcKUxyWVQb-7LV4zmomsgg\", \"version\" : { \"number\" : \"7.17.5\", \"build_flavor\" : \"default\", \"build_type\" : \"docker\", \"build_hash\" : \"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84\", \"build_date\" : \"2022-06-23T21:57:28.736740635Z\", \"build_snapshot\" : false, \"lucene_version\" : \"8.11.1\", \"minimum_wire_compatibility_version\" : \"6.8.0\", \"minimum_index_compatibility_version\" : \"6.0.0-beta1\" }, \"tagline\" : \"You Know, for Search\"}root@ip-10-10-10-29:/data# curl -s 172.20.0.3:9200/_cluster/health | python3 -m json.tool{ \"cluster_name\": \"elastic\", \"status\": \"green\", \"timed_out\": false, \"number_of_nodes\": 3, \"number_of_data_nodes\": 3, \"active_primary_shards\": 3, \"active_shards\": 6, \"relocating_shards\": 0, \"initializing_shards\": 0, \"unassigned_shards\": 0, \"delayed_unassigned_shards\": 0, \"number_of_pending_tasks\": 0, \"number_of_in_flight_fetch\": 0, \"task_max_waiting_in_queue_millis\": 0, \"active_shards_percent_as_number\": 100.0} ä»¥ä¸Šè¯´æ˜ESé›†ç¾¤å·²ç»æ­£å¸¸å·¥ä½œï¼Œçœ‹ä¸€ä¸‹é€šè¿‡nginxä»£ç†è½¬å‘åˆ°kibanaçš„ç»“æœ kibanaä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼Œåªæ˜¯è¿™é‡Œåœ¨è®¿é—®çš„æ—¶å€™ç›´æ¥å°±è¿›å…¥äº†kibanaï¼Œå¦‚æœä¸åŠ ä¸€ä¸ªèº«ä»½éªŒè¯åŠŸèƒ½ï¼Œè¿™å°±ç­‰äºè£¸å¥”ï¼Œå³ä¾¿åœ¨æ”¾åœ¨å†…ç½‘ä¹Ÿæ˜¯æå…¶ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸€ä¸ªèº«ä»½éªŒè¯ã€‚ SSLæ–¹å¼åˆ©ç”¨è‡ªå¸¦çš„å·¥å…·ç”Ÿæˆè¯ä¹¦ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œç”Ÿæˆè¯ä¹¦ï¼Œä½†æ³¨æ„è¦é™åˆ¶åŸŸåå’ŒIPï¼Œå¦åˆ™åœ¨è¿›è¡Œhttpsé€šè®¯æ—¶ä¼šæ ¡éªŒå¤±è´¥ è¿›å…¥node-1å®¹å™¨ ï¼Œæ“ä½œ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394root@ip-10-10-10-29:~# docker exec -it node-1 bashroot@node-1:/usr/share/elasticsearch## æ ¹æ®å®é™…æƒ…å†µé…ç½®ç”Ÿæˆè¯ä¹¦çš„yamlcat &lt;&lt;EOF &gt; /usr/share/elasticsearch/node.ymlinstances: - name: \"node\" ip: - \"172.20.0.3\" - \"172.20.0.4\" - \"172.20.0.5\" - \"127.0.0.1\" - \"172.20.0.6\" - \"10.10.10.29\" # è¿™ä¸ªIPæ˜¯æœåŠ¡å™¨çš„IPåœ°å€ï¼Œå› ä¸ºæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯dockerè¿è¡Œesé›†ç¾¤ï¼Œè¿™ä¸ªå¿…é¡»åŠ ä¸Šå» dns: - \"node-1\" - \"node-2\" - \"node-3 \" - \"localhost\" - \"kibana\" - \"others\"EOF# ç”Ÿæˆcaè¯ä¹¦ï¼Œé»˜è®¤æ–‡ä»¶åä¸ºelastic-stack-ca.p12ï¼Œå¯æ·»åŠ å¯†ç bin/elasticsearch-certutil ca # ä¸€è·¯å›è½¦å³å¯# ç”Ÿæˆè¯ä¹¦ï¼Œé»˜è®¤æ–‡ä»¶åä¸ºcertificate-bundle.zipbin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 --silent --in node.yml # ä¸€è·¯å›è½¦å³å¯# å°†è¯ä¹¦å¤åˆ¶åˆ°node-1é…ç½®ç›®å½•ä¸‹root@node-1:/usr/share/elasticsearch# cp certificate-bundle.zip elastic-stack-ca.p12 config/certs/root@node-1:/usr/share/elasticsearch# cd config/certs/root@node-1:/usr/share/elasticsearch/config/certs# lscertificate-bundle.zip elastic-stack-ca.p12# è§£å‹è¯ä¹¦ï¼Œç›®å½•ç»“æ„ä¸º å®ä¾‹å/å®ä¾‹å.p12 ,æ­¤å¤„ä¸ºnode/node.p12root@node-1:/usr/share/elasticsearch/config/certs# unzip certificate-bundle.zip Archive: certificate-bundle.zip creating: node/ inflating: node/node.p12 root@node-1:/usr/share/elasticsearch/config/certs# lscertificate-bundle.zip elastic-stack-ca.p12 noderoot@node-1:/usr/share/elasticsearch/config/certs# ls node/node.p12root@node-1:/usr/share/elasticsearch/config/certs# rm -rf node certificate-bundle.ziproot@node-1:/usr/share/elasticsearch/config/certs# lscertificate-bundle.zip elastic-stack-ca.p12 node.p12# ä¿®æ”¹è¯ä¹¦è®¿é—®æƒé™root@node-1:/usr/share/elasticsearch/config# chown -R root:elasticsearch certs/ root@node-1:/usr/share/elasticsearch/config# chmod -R a+rx certs/# æ­¤æ—¶æˆ‘ä»¬éœ€è¦çš„è¯ä¹¦å·²ç»ç”Ÿæˆäº†ï¼ŒåŒæ ·çš„æ–¹å¼å¤åˆ¶åˆ°node-2,node3åä¿®æ”¹æƒé™ï¼Œä¿®æ”¹å±ä¸»ç­‰æ“ä½œ# é€€å‡ºå®¹å™¨,è¿›å…¥node-1çš„æŒ‚åœ¨ç›®å½•ï¼šroot@ip-10-10-10-29:/data/es/node-1/certs# pwd/data/es/node-1/certsroot@ip-10-10-10-29:/data/es/node-1/certs# cd ..root@ip-10-10-10-29:/data/es/node-1# lscerts config data logroot@ip-10-10-10-29:/data/es/node-1# cp -rf certs ../node-2/root@ip-10-10-10-29:/data/es/node-1# cp -rf certs ../node-3/root@ip-10-10-10-29:/data/es/node-1# # è¯ä¹¦å·²ç»å‡†å¤‡å®Œæ¯•es/â”œâ”€â”€ node-1â”‚&nbsp;&nbsp; â”œâ”€â”€ certsâ”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elastic-stack-ca.p12â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ node.p12â”‚&nbsp;&nbsp; â”œâ”€â”€ configâ”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elasticsearch.ymlâ”‚&nbsp;&nbsp; â”œâ”€â”€ dataâ”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ nodesâ”‚&nbsp;&nbsp; â””â”€â”€ logâ”œâ”€â”€ node-2â”‚&nbsp;&nbsp; â”œâ”€â”€ certsâ”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elastic-stack-ca.p12â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ node.p12â”‚&nbsp;&nbsp; â”œâ”€â”€ configâ”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elasticsearch.ymlâ”‚&nbsp;&nbsp; â”œâ”€â”€ dataâ”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ nodesâ”‚&nbsp;&nbsp; â””â”€â”€ logâ”œâ”€â”€ node-3â”‚&nbsp;&nbsp; â”œâ”€â”€ certsâ”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elastic-stack-ca.p12â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ node.p12â”‚&nbsp;&nbsp; â”œâ”€â”€ configâ”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elasticsearch.ymlâ”‚&nbsp;&nbsp; â”œâ”€â”€ dataâ”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ nodesâ”‚&nbsp;&nbsp; â””â”€â”€ logâ””â”€â”€ plugins ä¿®æ”¹é…ç½®æ–‡ä»¶/data/es/node-1/config/elasticsearch.yml. ä»¥èŠ‚ç‚¹node-1ä¸ºä¾‹ 12345678910111213141516# è¿™é‡Œçš„å†…å®¹åŒéssléƒ¨ç½²ä¸€æ ·..............# å¼€å¯xpackå®‰å…¨ç‰¹æ€§xpack.security.enabled: truexpack.security.authc.api_key.enabled: true# å¼€å¯httpså¹¶é…ç½®è¯ä¹¦xpack.security.http.ssl.enabled: truexpack.security.http.ssl.keystore.path: certs/node.p12xpack.security.http.ssl.truststore.path: certs/node.p12# å¼€å¯èŠ‚ç‚¹é—´é€šè®¯sslå¹¶é…ç½®è¯ä¹¦xpack.security.transport.ssl.enabled: truexpack.security.transport.ssl.verification_mode: certificatexpack.security.transport.ssl.client_authentication: requiredxpack.security.transport.ssl.keystore.path: certs/node.p12xpack.security.transport.ssl.truststore.path: certs/node.p12 æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€ä¿®æ”¹åï¼Œé‡å¯ä¸€ä¸‹esé›†ç¾¤ é‡å¯å®Œæ¯•åï¼ŒæŸ¥çœ‹çŠ¶æ€å’Œæ—¥å¿—ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸ è‹¥æ— å¼‚å¸¸ï¼Œå¯ä»¥å¼€å§‹è®¾ç½®å¯†ç ï¼Œ è¿›å…¥å®¹å™¨ node-1 1234567891011121314root@ip-10-10-10-29:/data# docker exec -it node-1 bashroot@node-1:/usr/share/elasticsearch# ./bin/elasticsearch-setup-passwords auto Initiating the setup of passwords for reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.The passwords will be randomly generated and printed to the console.Please confirm that you would like to continue [y/N]y# è‹¥é›†ç¾¤æ²¡é—®é¢˜çš„è¯è¿™é‡Œå°±ä¼šè‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿçš„ä¸€äº›å¯†ç ï¼š............................# ä¹Ÿå¯ä»¥æ‰‹åŠ¨è‡ªå®šä¹‰å¯†ç ./bin/elasticsearch-setup-passwords interactive ä½¿ç”¨ ES API æ£€æŸ¥å„ä¸ªèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸ 123curl -k --user elastic:å¯†ç  -X GET \"https://172.20.0.3:9200\" --cert-type P12 --cert /usr/share/elasticsearch/config/certs/node.p12curl -k --user elastic:å¯†ç  -X GET \"https://172.20.0.4:9200\" --cert-type P12 --cert /usr/share/elasticsearch/config/certs/node.p12curl -k --user elastic:å¯†ç  -X GET \"https://172.20.0.5:9200\" --cert-type P12 --cert /usr/share/elasticsearch/config/certs/node.p12 æ­¤æ—¶sslå·²é…ç½®å®Œæ¯•ï¼Œé…ç½®kibana 123456# æŠŠä¹‹å‰æ”¾åœ¨node-1ä¸‹é¢çš„è¯ä¹¦å¤åˆ¶åˆ°kibana/certä¸‹é¢ï¼š# æå–å…¬é’¥openssl pkcs12 -in elastic-stack-ca.p12 -out elastic-stack-ca.pem -nokeys -clcertsopenssl pkcs12 -in node.p12 -out node.pem -nokeys -clcerts# æå–ç§é’¥openssl pkcs12 -in node.p12 -out node.key -nocerts -nodes ä¿®æ”¹é…ç½®æ–‡ä»¶kibana/config/kibana.yml 12345678910111213141516171819server.host: 0.0.0.0# ç›‘å¬ç«¯å£server.port: 5601server.name: \"kibana\"# kibanaè®¿é—®esæœåŠ¡å™¨çš„URL,å°±å¯ä»¥æœ‰å¤šä¸ªï¼Œä»¥é€—å·\",\"éš”å¼€# es å¼€å¯äº† sslï¼Œæ‰€ä»¥è¿™é‡Œçš„url å¿…é¡»ä½¿ç”¨httpsåè®®elasticsearch.hosts: [\"https://172.20.0.3:9200\",\"https://172.20.0.4:9200\",\"https://172.20.0.5:9200\"]monitoring.ui.container.elasticsearch.enabled: true# kibanaè®¿é—®Elasticsearchçš„è´¦å·ä¸å¯†ç (å¦‚æœElasticSearchè®¾ç½®äº†çš„è¯)elasticsearch.username: \"kibana_system\"elasticsearch.password: \"xxxxxxxxxxxx\"# kibana webè¯­è¨€i18n.locale: \"zh-CN\"# esè¯ä¹¦é…ç½®, è¿™é‡Œæ˜¯åœ¨docker-composeä¸­å·²ç»æŒ‚è½½è¿›å®¹å™¨äº†elasticsearch.ssl.certificate: /etc/kibana/cert/node.pemelasticsearch.ssl.key: /etc/kibana/cert/node.key# esçš„caè¯ä¹¦elasticsearch.ssl.certificateAuthorities: [ \"/etc/kibana/cert/elastic-stack-ca.pem\" ] ä¿®æ”¹å®Œæ¯•å ï¼Œé‡æ–°éƒ¨ç½²ä¸€ä¸‹ kibanaæœåŠ¡å³å¯ ä»¥ä¸Šåªè¦ç™»å½•å°±å¯ä»¥ä½¿ç”¨äº†ã€‚ Filebeat æ—¥å¿—é‡‡é›†è¿™é‡Œæˆ‘æ‰ç”¨çš„æ–¹å¼æ˜¯ dockerè¿è¡Œ filebeatæœåŠ¡ï¼Œç„¶åå°†ç½‘å…³æœåŠ¡å™¨çš„Nginxæ—¥å¿—æŒ‚è½½è¿›filebeat 1234567891011121314vim /opt/filbeat/docker-compose.yamlversion: \"3\"services: filebeat: container_name: filebeat_test image: elastic/filebeat:7.9.0 user: root volumes: - /data/wwwlogs/:/var/log/nginx:ro - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro - ./ca.crt:/usr/share/filebeat/certs/ca.crt # è¿™ä¸ªè¯ä¹¦åœ¨æ¥å…¥kibanaçš„æ—¶å€™å·²ç»æå–å‡ºæ¥äº†ï¼Œå³æ–‡ä»¶ï¼šelastic-stack-ca.pem # ä»–ä»¬å†…å®¹æ˜¯ä¸€æ ·çš„åªæ˜¯æ–‡ä»¶åã€æ ¼å¼ä¸ä¸€æ · command: filebeat -e filebeatçš„é…ç½®æ–‡ä»¶åœ¨ /opt/filebeat/filebeat.yml 1234567891011121314151617181920212223242526272829303132333435363738vim /opt/filebeat/filebeat.ymlfilebeat.inputs: ##################################################################################- type: log paths: - /var/log/nginx/testnet-xxxxxxxxxxxx.com.log tags: [\"proxy-testnet-xxxxxxxxxxxx.com.log\"] fields: index: \"proxy-testnet-xxxxxxxxxxxx.com.log\" json.keys_under_root: true json.overwrite_keys: true processors: - add_kubernetes_metadata: matchers: - logs_path: logs_path: \"/var/log/nginx/\" - decode_json_fields: when: regexp: message: \"{*}\" fields: [\"message\"] overwrite_keys: true ##################################################################################output.elasticsearch: hosts: [\"https://10.10.10.29:9200\",\"https://10.10.10.29:9201\",\"https://10.10.10.29:9201\"] username: elastic password: vDNnbd8FXqR2i13NYGfj ssl.certificate_authorities: - /usr/share/filebeat/certs/ca.crt indices: - index: \"proxy-testnet-xxxxxxxxxxxx.com.log-%{+yyyy.MM.dd}\" when.contains: fields: index: \"proxy-testnet-xxxxxxxxxxxx.com.log\" setup.kibana: hosts: \"http://10.10.10.29:5601\" username: \"elastic\" password: \"xxxxxxxxxxxx\" é…ç½®å®Œæ¯•ä¹‹åï¼ŒæŸ¥çœ‹æ—¥å¿—æ˜¯å¦å¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œåˆ°node-1ä¸Šé¢é€šè¿‡ES APIæŸ¥è¯¢æ˜¯å¦æœ‰indexç”Ÿæˆ 12345678root@node-1:/usr/share/elasticsearch# curl -k --user elastic:xxxxxxxxxxxx -X GET \"https://172.20.0.3:9200/_cat/indices \" --cert-type P12 --cert /usr/share/elasticsearch/config/certs/node.p12..................green open proxy-testnet-xxxxxxxxxxxx.com.log-2024.07.23 Su-T62zGTheqbDsDZLzH_A 1 1 2911 0 1.7mb 914.2kb.................. Kibanaé…ç½®ä¸Šé¢å¯ä»¥çœ‹åˆ°filebeatå·²ç»æ­£å¸¸å¾€ESå†™å…¥æ•°æ®ï¼Œåœ¨kibanaä¸­é…ç½®ä¸€ä¸‹ï¼š Stack Manager - Index Patterns - Create index pattern ç›´æ¥åˆ›å»ºåèœå•æ ï¼š Discover é€‰æ‹©åˆšåˆšåˆ›å»ºçš„è¿™ä¸ªIndex Pattern æœ€åç›´æ¥å°±å¯ä»¥çœ‹åˆ°æ”¶é›†åˆ°çš„æ—¥å¿—kibanaå·²ç»åšå¥½äº†å­—æ®µåˆ†éš”ï¼Œåªéœ€è¦é€‰æ‹©éœ€è¦çš„å­—æ®µï¼Œæˆ–è€…åŒ¹é…æŸäº›å­—æ®µå°±å¯ä»¥äº†ã€‚ æ¯”å¦‚ æˆ‘æƒ³çœ‹çŠ¶æ€ç å¤§äºç­‰äº500çš„ï¼š status &gt;= 500ï¼Œéƒ½å¯ä»¥åœ¨ä¸Šé¢çš„æœç´¢æ¡†ä¸­å»å®šä¹‰ç­›é€‰ å½“ç„¶ä¹Ÿå¯ä»¥æŠŠè¿™ä¸ªæ—¥å¿—åšæˆå¯è§†åŒ–ï¼Œä½†é€‰æ‹©æŸä¸ªæŒ‡æ ‡çš„æ—¶å€™ï¼Œå…¶ä»–æŒ‡æ ‡ä¹Ÿå¯ä»¥è”åŠ¨èµ·æ¥ï¼Œä¾‹å¦‚ï¼š æœ€åå†ç»“åˆå‰é¢å†™è¿‡çš„ å¦‚ä½•åˆ©ç”¨ElastAlert2å¯¹ESä¸­çš„æ—¥å¿—åˆ›å»ºå‘Šè­¦ å°±å¯ä»¥è½»æ¾çš„å¯¹æ—¥å¿—è¿›è¡Œç›‘æ§å‘Šè­¦å•¦~ å†™åœ¨æœ€å ä¸Šé¢è¿‡ç¨‹ä»…ä»…æ˜¯è®°å½•ï¼Œä¸»è¦è¿˜æ˜¯æ€è·¯ã€‚ k8s version123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189--- apiVersion: v1 kind: ConfigMap metadata: name: filebeat-config namespace: ops labels: k8s-app: filebeat data: filebeat.yml: |- #====================== input ================= filebeat.inputs: # nginx-ingress - type: container paths: - /var/log/containers/*goerli-testnet-collector*.log tags: [\"goerli-testnet-collector\"] fields: index: \"goerli-testnet-collector\" processors: - add_kubernetes_metadata: host: ${NODE_NAME} matchers: - logs_path: logs_path: \"/var/log/containers/\" - decode_json_fields: when: regexp: message: \"{*}\" fields: [\"message\"] overwrite_keys: true target: \"\" # testnet-bsc-collector - type: container paths: - /var/log/containers/*testnet-bsc-collector*.log tags: [\"testnet-bsc-collector\"] fields: index: \"testnet-bsc-collector\" processors: - add_kubernetes_metadata: host: ${NODE_NAME} matchers: - logs_path: logs_path: \"/var/log/containers/\" - decode_json_fields: when: regexp: message: \"{*}\" fields: [\"message\"] #overwrite_keys: true target: \"\" #================ output ===================== output.elasticsearch: hosts: [\"https://10.10.20.23:9200\", \"https://10.10.20.120:9200\", \"https://10.10.20.160:9200\"] username: elastic password: r40SgkMhmjwK8rIpClFM ssl.certificate_authorities: - /usr/share/filebeat/ca.crt indices: - index: \"INDEX-NAME-%{+yyyy.MM.dd}\" when.contains: fields: index: \"INDEX-NAME\" - index: \"testnet-bsc-collector-%{+yyyy.MM.dd}\" when.contains: fields: index: \"testnet-bsc-collector\" #============== Elasticsearch template setting ========== setup.ilm.enabled: false setup.template.name: 'k8s-logs' setup.template.pattern: 'k8s-logs-*' processors: - drop_fields: fields: [\"agent\",\"kubernetes.labels\",\"input.type\",\"log\",\"ecs.version\",\"host.name\",\"kubernetes.replicaset.name\",\"kubernetes.pod.uid\",\"kubernetes.pod.uid\",\"tags\",\"stream\",\"kubernetes.container.name\"] --- apiVersion: apps/v1 kind: DaemonSet metadata: name: filebeat namespace: ops labels: k8s-app: filebeat spec: selector: matchLabels: k8s-app: filebeat template: metadata: labels: k8s-app: filebeat spec: serviceAccountName: filebeat terminationGracePeriodSeconds: 30 hostNetwork: true dnsPolicy: ClusterFirstWithHostNet tolerations: - effect: NoSchedule operator: Exists containers: - name: filebeat image: elastic/filebeat:7.9.0 args: [ \"-c\", \"/etc/filebeat.yml\", \"-e\", ] env: - name: NODE_NAME valueFrom: fieldRef: fieldPath: spec.nodeName securityContext: runAsUser: 0 # If using Red Hat OpenShift uncomment this: #privileged: true resources: limits: memory: 200Mi requests: cpu: 100m memory: 100Mi volumeMounts: - name: config mountPath: /etc/filebeat.yml readOnly: true subPath: filebeat.yml - name: data mountPath: /usr/share/filebeat/data - name: varlibdockercontainers mountPath: /var/lib/containerd/ readOnly: true - name: varlog mountPath: /var/log readOnly: true volumes: - name: config configMap: defaultMode: 0600 name: filebeat-config - name: varlibdockercontainers hostPath: path: /var/lib/containerd/ - name: varlog hostPath: path: /var/log # data folder stores a registry of read status for all files, so we don't send everything again on a Filebeat pod restart - name: data hostPath: path: /var/lib/filebeat-data type: DirectoryOrCreate --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: filebeat subjects: - kind: ServiceAccount name: filebeat namespace: opsroleRef: kind: ClusterRole name: filebeat apiGroup: rbac.authorization.k8s.io --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: filebeat labels: k8s-app: filebeat rules: - apiGroups: [\"\"] # \"\" indicates the core API group resources: - namespaces - pods verbs: - get - watch - list --- apiVersion: v1 kind: ServiceAccount metadata: name: filebeat namespace: ops labels: k8s-app: filebeat ---","categories":[],"tags":[],"keywords":[]},{"title":"å¦‚ä½•åˆ©ç”¨ElastAlert2å¯¹ESä¸­çš„æ—¥å¿—åˆ›å»ºå‘Šè­¦","slug":"å¦‚ä½•åˆ©ç”¨ElastAlert2å¯¹ESä¸­çš„æ—¥å¿—åˆ›å»ºå‘Šè­¦","date":"2024-07-16T09:56:39.000Z","updated":"2025-09-01T01:59:08.942Z","comments":true,"path":"2024/07/16/å¦‚ä½•åˆ©ç”¨ElastAlert2å¯¹ESä¸­çš„æ—¥å¿—åˆ›å»ºå‘Šè­¦/","permalink":"https://blog.sctux.cc/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/","excerpt":"èƒŒæ™¯çº¿ä¸ŠAPIæœåŠ¡å‡ºç°äº†5xxçš„è¯·æ±‚é”™è¯¯, æœªèƒ½åœ¨ç¬¬ä¸€æ—¶é—´å‘ç°å¯¼è‡´ç”¨æˆ·ä¸»åŠ¨å‘å›¢é˜ŸæŠ¥å‘Šæ¥å£æœ‰å¼‚å¸¸ï¼Œ ç”±äºAPIçš„æ¥å£æ¯”è¾ƒå¤šï¼Œä¹Ÿåªæ˜¯ç›‘æ§äº†éƒ¨åˆ†ï¼Œäº‹åé€šè¿‡æ—¥å¿—æ‰å‘ç°çš„ç¡®ç”¨æˆ·ä¾§åœ¨å¯¹æŸä¸ªæ¥å£è®¿é—®æ—¶ï¼Œé¢‘ç¹å‡ºç°5xxå‘Šè­¦ï¼Œæˆ‘è¿™è¾¹ä¹Ÿæ²¡æœ‰æ”¶åˆ°ä»€ä¹ˆé€šçŸ¥ï¼Œç›®å‰å…ˆæš‚ä¸”ä¸è¯´å‡ºç°5xxæ˜¯ä»€ä¹ˆé€ æˆçš„ï¼Œè€Œæ˜¯åœ¨APIæ¥å£å“åº”çŠ¶æ€çš„ç›‘æ§æ–¹é¢æ²¡æœ‰åšåˆ°å¾ˆåˆ°ä½ï¼Œ æ‰€ä»¥éœ€è¦å¯¹Nginxæ—¥å¿—ä¸­çš„çŠ¶æ€ä¸º5xxçš„è¯·æ±‚ç›‘æ§å‘Šè­¦ï¼Œä»¥ä¾¿èƒ½å¿«é€Ÿå“åº”ï¼Œè§£å†³é—®é¢˜ã€‚ ElastAlert2ElastAlert 2æ˜¯ä¸€ä¸ªç®€å•çš„æ¡†æ¶ï¼Œç”¨äºå¯¹æ¥è‡ª Elasticsearch å’Œ OpenSearch çš„æ•°æ®çš„å¼‚å¸¸ã€å°–å³°æˆ–å…¶ä»–æ„Ÿå…´è¶£çš„æ¨¡å¼å‘å‡ºè­¦æŠ¥ã€‚ å®˜æ–¹æ–‡æ¡£ï¼šhttps://elastalert2.readthedocs.io/en/latest/ Github: https://github.com/jertel/elastalert2 é…ç½®éƒ¨ç½²å½“ç„¶è¿˜æ˜¯é€‰æ‹©å®¹å™¨åŒ–æ–¹å¼è¿è¡Œï¼Œå®˜æ–¹ä¹Ÿæä¾›å¾—æœ‰é•œåƒï¼š 1docker pull docker pull jertel/elastalert2 é…ç½®æ–‡ä»¶é…ç½®","text":"èƒŒæ™¯çº¿ä¸ŠAPIæœåŠ¡å‡ºç°äº†5xxçš„è¯·æ±‚é”™è¯¯, æœªèƒ½åœ¨ç¬¬ä¸€æ—¶é—´å‘ç°å¯¼è‡´ç”¨æˆ·ä¸»åŠ¨å‘å›¢é˜ŸæŠ¥å‘Šæ¥å£æœ‰å¼‚å¸¸ï¼Œ ç”±äºAPIçš„æ¥å£æ¯”è¾ƒå¤šï¼Œä¹Ÿåªæ˜¯ç›‘æ§äº†éƒ¨åˆ†ï¼Œäº‹åé€šè¿‡æ—¥å¿—æ‰å‘ç°çš„ç¡®ç”¨æˆ·ä¾§åœ¨å¯¹æŸä¸ªæ¥å£è®¿é—®æ—¶ï¼Œé¢‘ç¹å‡ºç°5xxå‘Šè­¦ï¼Œæˆ‘è¿™è¾¹ä¹Ÿæ²¡æœ‰æ”¶åˆ°ä»€ä¹ˆé€šçŸ¥ï¼Œç›®å‰å…ˆæš‚ä¸”ä¸è¯´å‡ºç°5xxæ˜¯ä»€ä¹ˆé€ æˆçš„ï¼Œè€Œæ˜¯åœ¨APIæ¥å£å“åº”çŠ¶æ€çš„ç›‘æ§æ–¹é¢æ²¡æœ‰åšåˆ°å¾ˆåˆ°ä½ï¼Œ æ‰€ä»¥éœ€è¦å¯¹Nginxæ—¥å¿—ä¸­çš„çŠ¶æ€ä¸º5xxçš„è¯·æ±‚ç›‘æ§å‘Šè­¦ï¼Œä»¥ä¾¿èƒ½å¿«é€Ÿå“åº”ï¼Œè§£å†³é—®é¢˜ã€‚ ElastAlert2ElastAlert 2æ˜¯ä¸€ä¸ªç®€å•çš„æ¡†æ¶ï¼Œç”¨äºå¯¹æ¥è‡ª Elasticsearch å’Œ OpenSearch çš„æ•°æ®çš„å¼‚å¸¸ã€å°–å³°æˆ–å…¶ä»–æ„Ÿå…´è¶£çš„æ¨¡å¼å‘å‡ºè­¦æŠ¥ã€‚ å®˜æ–¹æ–‡æ¡£ï¼šhttps://elastalert2.readthedocs.io/en/latest/ Github: https://github.com/jertel/elastalert2 é…ç½®éƒ¨ç½²å½“ç„¶è¿˜æ˜¯é€‰æ‹©å®¹å™¨åŒ–æ–¹å¼è¿è¡Œï¼Œå®˜æ–¹ä¹Ÿæä¾›å¾—æœ‰é•œåƒï¼š 1docker pull docker pull jertel/elastalert2 é…ç½®æ–‡ä»¶é…ç½®å¯å‚è€ƒ https://github.com/jertel/elastalert2 ç›®å½•ä¸­çš„ examples/config.yaml.example 1234567891011121314151617181920mkdir -p /opt/elastalert2/{data,rules}vim /opt/elastalert2/config.yamlrules_folder: rules # å­˜æ”¾è§„åˆ™æ–‡ä»¶çš„ç›®å½•ï¼Œè¿™ä¸ªç›®å½•éœ€è¦æŒ‚è½½åˆ°/opt/elastalert/ä¸‹run_every: minutes: 1buffer_time: minutes: 15es_host: 10.10.20.23es_port: 9200use_ssl: Trueverify_certs: Trueca_certs: /opt/elastalert/ca.crt # å¦‚æœé›†ç¾¤å¯ç”¨äº†sslè®°å¾—è¦æŠŠcaè¯ä¹¦æŒ‚åœ¨åˆ°å®¹å™¨çš„è¿™ä¸ªä½ç½®ssl_show_warn: Truees_send_get_body_as: GETes_username: # YOUR ES USERNAMEes_password: # YOUR ES PASSWORDwriteback_index: elastalert_statusalert_time_limit: days: 2 Ruleè§„åˆ™é…ç½®æˆ‘ä»¬ç½‘å…³æœåŠ¡å™¨çš„Nginxæ—¥å¿—æ˜¯é€šè¿‡filebeatå†™åˆ°Elasticsearchçš„ï¼Œä¹Ÿåšå¥½äº†indexï¼Œå…¶å®åœ¨ELK ç•Œé¢ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™äº›çŠ¶æ€æ•°æ®ï¼Œä½†æ˜¯ä»…ä»…åªæ˜¯å±•ç¤ºï¼Œæ²¡æœ‰å‘Šè­¦ï¼Œæ‰€ä»¥æ‰æœ‰äº†è¿™ç¯‡blogã€‚ åˆ›å»ºä¸€ä¸ªé’ˆå¯¹ æŸä¸ªAPIåŸŸåçš„æ—¥å¿—çš„çŠ¶æ€ç›‘æ§æ–‡ä»¶ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960vim /opt/elastalert2/rules/mainnet-api.xxxxx.yaml#ruleåå­—,å¿…é¡»å”¯ä¸€name: The number of times this request responds with a status code of 5xx in the log is greater than 5 times within 1 minute, please pay attention(mainnet-api.xxxxx)!#ç±»å‹,å®˜æ–¹æä¾›å¤šç§ç±»å‹type: frequency#ESç´¢å¼•,æ”¯æŒé€šé…ç¬¦index: proxy-mainnet-api.xxxxx.log-*#åœ¨timeframeæ—¶é—´å†…,åŒ¹é…åˆ°å¤šå°‘ä¸ªç»“æœä¾¿å‘Šè­¦num_events: 1#ç›‘æ§å‘¨æœŸ.é»˜è®¤æ˜¯minutes: 1timeframe: seconds: 5#åŒ¹é…æ¨¡å¼.è¿™é‡Œæˆ‘åŒ¹é…çš„æ˜¯500â€”599çš„æ‰€æœ‰å¯èƒ½ä¼šå‡ºç°çš„çŠ¶æ€ç filter:- range: status: from: 500 to: 599# è‡ªå®šä¹‰å‘é€æ ¼å¼(start)# è¯´æ˜ï¼š ä»¥ä¸‹å¯ä»¥è‡ªå®šä¹‰å‘é€çš„å†…å®¹ï¼Œå¦‚æœä»€ä¹ˆéƒ½ä¸æŒ‡å®šï¼Œä¼šå‘é€ElastAlert2åŸç”Ÿçš„ä¸€å¤§å †jsonæ ¼å¼çš„å†…å®¹ï¼Œæ˜“è¯»æ€§å¾ˆä½ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºäº†å†…å®¹ç®€ä»‹ï¼Œæˆ‘è¿™é‡Œå°±åªæ˜¯å®šä¹‰äº†è¿™äº›å†…å®¹ï¼šalert_text_type: alert_text_onlyalert_text: \" å“åº”çŠ¶æ€ç : {} \\n å‘ç”Ÿæ—¶é—´UTC: {} \\n ES Index: {} \\n num_hits: {} \\n è¯·æ±‚URL: https://mainnet-api.xxxxx{} \\n ClientIP: {} \\n num_matches: {} \\n http_user_agent: {}\"alert_text_args: - status - \"@timestamp\" - _index - num_hits - request_uri - http_x_forwarded_for - num_matches - http_user_agent# è‡ªå®šä¹‰å‘é€æ ¼å¼(end)# è¿™é‡Œé€‰æ‹©ä½¿ç”¨çš„æ˜¯Discordæ¥æ¥æ”¶é€šçŸ¥ï¼ŒElastAlert2å…¶å®å¾ˆå¼ºå¤§ï¼Œæ”¯æŒå¾ˆå¤šæ¸ é“çš„å‘Šè­¦# è¿™é‡Œå‘ç°å¹¶ä¸èƒ½åŒæ—¶å¤šä¸ªæ¸ é“å‘é€å‘Šè­¦æ¶ˆæ¯# å¦‚æœéœ€è¦å¤šä¸ªå‘Šè­¦æ¸ é“ï¼Œå¯ä»¥å†™ä¸€ä¸ªç±»ä¼¼äºAlertCenterçš„æœåŠ¡ï¼Œé€šè¿‡è¿™ä¸ªæœåŠ¡æ•´åˆåå‘é€åˆ°ä¸åŒçš„æ¸ é“ï¼Œè¿™é‡Œè¿™æ˜¯ä¸ªæ€è·¯ï¼Œç›®å‰å…ˆæ»¡è¶³éœ€æ±‚alert:- \"discord\"discord_webhook_url: \"YOUR DISCORD WEBHOOK URL\"discord_emoji_title: \":lock:\"discord_embed_color: 0xE24D42discord_embed_footer: \"Message sent by from api status moniotor(for @noardguo)\"discord_embed_icon_url: \"https://humancoders-formations.s3.amazonaws.com/uploads/course/logo/38/thumb_bigger_formation-elasticsearch.png\" éƒ¨ç½²è¿è¡Œä¸Šé¢å·²ç»å‡†å¤‡å¥½äº†æ‰€éœ€è¦çš„æ–‡ä»¶ï¼š 123456789root@ip-10-10-10-11:/opt/elastalert2# tree -L 2.â”œâ”€â”€ ca.crtâ”œâ”€â”€ config.yamlâ”œâ”€â”€ dataâ””â”€â”€ rules â”œâ”€â”€ mainnet-api.xxxxx.yml2 directories, 3 files docker æ–¹å¼è¿è¡Œï¼š 1234567891011121314151617181920docker run -d --name=elastalert2 \\ --env=TZ=Asia/Shanghai \\ --volume=/opt/elastalert2/data:/opt/elastalert/data \\ --volume=/opt/elastalert2/config.yaml:/opt/elastalert/config.yaml \\ --volume=/opt/elastalert2/rules:/opt/elastalert/rules \\ --volume=/opt/elastalert2/ca.crt:/opt/elastalert/ca.crt \\ --restart=always \\ jertel/elastalert2 root@ip-10-10-10-11:/opt/elastalert2# docker logs -f wonderful_tharpReading Elastic 7 index mappings:Reading index mapping 'es_mappings/7/silence.json'Reading index mapping 'es_mappings/7/elastalert_status.json'Reading index mapping 'es_mappings/7/elastalert.json'Reading index mapping 'es_mappings/7/past_elastalert.json'Reading index mapping 'es_mappings/7/elastalert_error.json'Index elastalert_status already exists. Skipping index creation.WARNING:py.warnings:/usr/local/lib/python3.12/site-packages/elasticsearch/connection/base.py:193: ElasticsearchDeprecationWarning: Camel case format name dateOptionalTime is deprecated and will be removed in a future version. Use snake case name date_optional_time instead. warnings.warn(message, category=ElasticsearchDeprecationWarning) å¦‚æœæ²¡æœ‰æŠ¥é”™å°±è¯´æ˜è¿è¡Œæ­£å¸¸ï¼Œæ­¤æ—¶ä»kibanaé¢æ¿ä¹Ÿå¯ä»¥çœ‹åˆ°ElaltAlert2ç”Ÿæˆäº†ç›‘æ§å‘Šè­¦æ‰€éœ€è¦çš„index: æµ‹è¯•å½“è¿è¡Œèµ·æ¥åï¼Œæ­¤æ—¶å°±æ˜¯æ˜¯æ—¶é—´ç›‘æ§æ—¥å¿—æ–‡ä»¶çš„ä¸€ä¸ªçŠ¶æ€ åœ¨ç½‘å…³æœåŠ¡å™¨ä¸Šé¢echoä¸€æ®µå¸¦æœ‰statusä¸º500çš„messageåˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼š 1echo '''{\"@timestamp\":\"2024-07-16T20:28:10+08:00\",\"server_addr\":\"110.10.30.187\",\"remote_addr\":\"10.10.10.248\",\"http_x_forwarded_for\":\"172.104.86.126, 172.68.119.188\",\"scheme\":\"http\",\"request_method\":\"POST\",\"request_uri\": \"Alert_Test\",\"request_length\": \"953\",\"uri\": \"/api/v1/alerttest\", \"request_time\":0.002,\"body_bytes_sent\":0,\"bytes_sent\":335,\"status\":\"500\",\"upstream_time\":\"0.002\",\"upstream_host\":\"10.10.10.139:31333\",\"upstream_status\":\"200\",\"host\":\"mainnet-api.xxxxxx\",\"http_referer\":\"https://test.xyz/\",\"http_user_agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36\"}''' &gt;&gt; mainnet-api.xxxxxx.log æ­¤æ—¶æŸ¥çœ‹ indexå·²ç»è®°å½•åˆ°è¿™æ¡å‘Šè­¦æ¶ˆæ¯, é€šè¿‡æŸ¥è¯¢ç´¢å¼•ä¹Ÿæ‰¾åˆ°äº†è¿™ä¸ªè¯·æ±‚ åŒæ—¶ï¼ŒDiscordä¹Ÿæ”¶åˆ°äº†å‘Šè­¦é€šçŸ¥ æœ€åï¼Œå› ä¸ºæˆ‘ä»¬è·‘äº†k8s,ä¸‹é¢ç›´æ¥æŠŠç›¸å…³æ–‡ä»¶ç”¨configmapæ–¹å¼æŒ‚è½½è¿›å»ï¼Œè¿è¡Œä¸€ä¸ªDeploymentå‰¯æœ¬å³å¯ã€‚ elastalert-config.yaml 123456789101112131415161718192021222324apiVersion: v1data: config.yaml: |- rules_folder: rules run_every: minutes: 1 buffer_time: minutes: 15 es_host: 10.10.20.23 es_port: 9200 use_ssl: True verify_certs: True ca_certs: /opt/elastalert/ca.crt ssl_show_warn: True es_send_get_body_as: GET es_username: elastic es_password: A2VdKUHHFoUmlyekVFgd writeback_index: elastalert_status alert_time_limit: days: 2metadata: name: elastalert-config namespace: monitor ealstalert-rules.yaml 123456789101112131415161718192021apiVersion: v1data: mainnet-api.xxxxxx.yml: \"#ruleåå­—,å¿…é¡»å”¯ä¸€\\nname: The number of times this request responds with a status code of 5xx in the log is greater than 5 times within 1 minute, please pay attention(mainnet-api.xxxxx)!\\n\\n#ç±»å‹,å®˜æ–¹æä¾›å¤šç§ç±»å‹\\ntype: frequency\\n\\n#ESç´¢å¼•,æ”¯æŒé€šé…ç¬¦\\nindex: proxy-mainnet-api.xxxxx.log-*\\n\\n#åœ¨timeframeæ—¶é—´å†…,åŒ¹é…åˆ°å¤šå°‘ä¸ªç»“æœä¾¿å‘Šè­¦\\nnum_events: 1\\n\\n#ç›‘æ§å‘¨æœŸ.é»˜è®¤æ˜¯minutes: 1\\ntimeframe:\\n seconds: 5 \\n \\n#åŒ¹é…æ¨¡å¼.\\nfilter:\\n- range:\\n \\ status:\\n from: 500\\n to: 599\\n \\nalert_text_type: alert_text_only\\nalert_text: \\\" \\n å“åº”çŠ¶æ€ç : {} \\\\n\\n å‘ç”Ÿæ—¶é—´UTC: {} \\\\n\\n ES Index: {} \\\\n\\n num_hits: {} \\\\n\\n \\ è¯·æ±‚URL: https://mainnet-api.xxxxx.org{} \\\\n\\n ClientIP: {} \\\\n\\n num_matches: {} \\\\n\\n http_user_agent: {}\\n\\\"\\nalert_text_args:\\n - status\\n - \\\"@timestamp\\\"\\n \\ - _index\\n - num_hits\\n - request_uri\\n - http_x_forwarded_for\\n \\ - num_matches\\n - http_user_agent\\n \\n \\nalert:\\n- \\\"discord\\\"\\n#discord_webhook_url: \\\"DISCORD_WEBHOOK_URL\"\\ndiscord_webhook_url: \\\"https://https://discord.com/api/webhooks/1196752947493752933/VRQ01W1pT0PHpl55z0hayqsyjWzt3bzXUMSA4-_5W56fn9j5Nl1zDQT7ZtU_CQWnnlYH\\\"\\ndiscord_emoji_title: \\\":lock:\\\"\\ndiscord_embed_color: 0xE24D42\\ndiscord_embed_footer: \\\"Message sent by from api status moniotor(for @Ops-NoardGuo)\\\"\\ndiscord_embed_icon_url: \\\"https://humancoders-formations.s3.amazonaws.com/uploads/course/logo/38/thumb_bigger_formation-elasticsearch.png\\\"kind: ConfigMapmetadata: name: ealstalert-rules namespace: monitor ca.crtç•¥ elastalert-deployment.yaml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566---apiVersion: apps/v1kind: Deploymentmetadata: annotations: k8s.kuboard.cn/displayName: elastalert labels: k8s.kuboard.cn/name: elastalert name: elastalert namespace: monitorspec: progressDeadlineSeconds: 600 replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: k8s.kuboard.cn/name: elastalert strategy: rollingUpdate: maxSurge: 25% maxUnavailable: 25% type: RollingUpdate template: metadata: labels: k8s.kuboard.cn/name: elastalert spec: containers: - args: - '--verbose' # è¿™é‡ŒæŒ‡å®šå‚æ•°æ˜¯é»˜è®¤é•œåƒé‡Œé¢å¯ä»¥è·å–çš„å‚æ•°ï¼Œç”¨äºå®šä¹‰æ—¥å¿—è®°å½• æ’é”™æˆ–è€…è¿è¡ŒçŠ¶æ€æŸ¥çœ‹ - image: jertel/elastalert2 imagePullPolicy: IfNotPresent name: elastalert resources: {} terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumeMounts: - mountPath: /opt/elastalert/config.yaml name: volume-ps74r subPath: config.yaml - mountPath: /opt/elastalert/rules/ name: rules - mountPath: /opt/elastalert/ca.crt name: volume-zmdx7 subPath: ca.crt dnsPolicy: ClusterFirst restartPolicy: Always schedulerName: default-scheduler securityContext: {} terminationGracePeriodSeconds: 30 volumes: - configMap: defaultMode: 420 name: elastalert-config name: volume-ps74r - configMap: defaultMode: 420 items: - key: mainnet-api.xxxxx.yml path: mainnet-api.xxxxx.yml name: ealstalert-rules name: rules - configMap: defaultMode: 420 name: elasticsearch-ca.crt name: volume-zmdx7 è‡³æ­¤å‘Šè­¦åŠŸèƒ½å·²ç»å®ç°ï¼Œä»¥ä¸Šåªæ˜¯ä¸€ä¸ªå¤§ä½“çš„æ€è·¯ï¼Œä¸ä»…ä»…ç›‘æ§çš„å¯ä»¥æ˜¯çŠ¶æ€ç ï¼Œåº”è¯¥æ˜¯ä½ èƒ½æƒ³åˆ°çš„ï¼Œä»–èƒ½æä¾›çš„éƒ½å¯ä»¥ç›‘æ§èµ·æ¥ã€‚ å¥½å•¦ï¼Œæˆ‘è¦å»çœ‹5xxçš„æŠ¥é”™åŸå› äº†ğŸ˜€","categories":[],"tags":[],"keywords":[]},{"title":"å¦‚ä½•åˆ©ç”¨Pythonè·å–æ‰€æœ‰podå®¹å™¨çŠ¶æ€","slug":"å¦‚ä½•åˆ©ç”¨Pythonè·å–æ‰€æœ‰podå®¹å™¨çŠ¶æ€","date":"2024-07-09T09:38:00.000Z","updated":"2025-09-01T07:57:25.123Z","comments":true,"path":"2024/07/09/å¦‚ä½•åˆ©ç”¨Pythonè·å–æ‰€æœ‰podå®¹å™¨çŠ¶æ€/","permalink":"https://blog.sctux.cc/2024/07/09/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Python%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89pod%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81/","excerpt":"åœ¨æ—¥å¸¸å·¡æ£€è¿‡ç¨‹å½“ä¸­ï¼Œä¸éœ€è¦ç™»å½•æœåŠ¡å™¨å»æŸ¥çœ‹ï¼Œé€šè¿‡è°ƒç”¨k8s apiçš„æ–¹å¼è·å–æ‰€æœ‰podçš„çŠ¶æ€ ç„¶ååœ¨æ¯å¤©9ç‚¹æ‰§è¡Œæœ¬è„šæœ¬å³å¯ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101from kubernetes import client, configfrom kubernetes.client.rest import ApiExceptionfrom datetime import datetime, timezoneimport requestsimport jsonimport sysimport pytz# åŠ è½½ Kubernetes é…ç½®#é»˜è®¤ä¼šåœ¨masterèŠ‚ç‚¹å»è¯»å– ~/.kube/config æ–‡ä»¶config.load_kube_config()# åˆ›å»º Kubernetes API å®¢æˆ·ç«¯å®ä¾‹api_instance = client.CoreV1Api()# æŒ‡å®šè¦è·å–çš„å‘½åç©ºé—´åˆ—è¡¨target_namespaces = [sys.argv[1]] # æ›¿æ¢ä¸ºä½ çš„ç›®æ ‡å‘½åç©ºé—´åˆ—è¡¨filtered_keywords = [\"mysql\", \"redis\", \"memcached\", \"postgres\", \"backend\"]# Discord Webhook URLdiscord_webhook_url = \"\" # FOR TEST# æ›¿æ¢ä¸ºä½ çš„ Discord Webhook URLcontainers_without_restart = [] # æ²¡æœ‰é‡å¯åŸå› çš„å®¹å™¨åˆ—è¡¨containers_with_restart = [] # å…·æœ‰é‡å¯åŸå› çš„å®¹å™¨åˆ—è¡¨try: for target_namespace in target_namespaces: # è·å–å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ Pod pods = api_instance.list_namespaced_pod(namespace=target_namespace).items for pod in pods: pod_name = pod.metadata.name pod_status = pod.status.phase pod_restart_reason = \"\" pod_start_time = pod.metadata.creation_timestamp if any(keyword in pod_name for keyword in filtered_keywords): continue # è·å–å½“å‰æ—¶é—´ cst_timezone = pytz.timezone(\"Asia/Shanghai\") current_time = datetime.now(timezone.utc) # è®¡ç®—è¿è¡Œæ—¶é•¿ if pod_start_time is not None: pod_duration = current_time - pod_start_time pod_duration_str = str(pod_duration).split(\".\")[0] # æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå»æ‰å°æ•°éƒ¨åˆ† else: pod_duration_str = \"Unknown\" # æ£€æŸ¥ Pod æ˜¯å¦æœ‰é‡å¯è®°å½• if pod.status.container_statuses is not None: for container_status in pod.status.container_statuses: restart_count = container_status.restart_count # å¦‚æœé‡å¯æ¬¡æ•°å¤§äº 0ï¼Œåˆ™è·å–é‡å¯åŸå›  if restart_count &gt; 0: pod_restart_reason = container_status.last_state.terminated.reason if pod_restart_reason: containers_with_restart.append( (pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count) ) else: containers_without_restart.append( (pod_name, pod_status, pod_duration_str) ) # ç”Ÿæˆæ¶ˆæ¯ message = \"ç¯å¢ƒ: {0} è·å–æ—¶é—´ï¼š{1}\\n\\n\".format(target_namespace,datetime.now(cst_timezone).strftime(\"%Y-%m-%d %H:%M:%S\") + \" CST\") # æ·»åŠ æ²¡æœ‰é‡å¯åŸå› çš„å®¹å™¨ä¿¡æ¯ for container in containers_without_restart: pod_name, pod_status, pod_duration_str = container message += \"å®¹å™¨åç§°: {0} å½“å‰çŠ¶æ€: {1} è¿è¡Œæ—¶é•¿: {2}\\n\".format( pod_name, pod_status, pod_duration_str ) message += \"------------------------------------------------------\\n\" # æ·»åŠ å…·æœ‰é‡å¯åŸå› çš„å®¹å™¨ä¿¡æ¯ for container in containers_with_restart: pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count = container message += \"å®¹å™¨åç§°: {0} å½“å‰çŠ¶æ€: {1} è¿è¡Œæ—¶é•¿: {2} é‡å¯åŸå› : {3} é‡å¯æ¬¡æ•°ï¼š{4}\\n\".format( pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count ) message = \"```{0}```\".format(message) # å‘é€æ¶ˆæ¯åˆ° Discord payload = {\"content\": message} headers = {\"Content-Type\": \"application/json\"} response = requests.post( discord_webhook_url, data=json.dumps(payload), headers=headers ) print(response.content) if response.status_code == 204: print(\"Message sent to Discord successfully\") else: print(f\"Failed to send message to Discord. Status code: {response.status_code}\")except ApiException as e: print(f\"Exception when calling CoreV1Api: {e}\\n\")","text":"åœ¨æ—¥å¸¸å·¡æ£€è¿‡ç¨‹å½“ä¸­ï¼Œä¸éœ€è¦ç™»å½•æœåŠ¡å™¨å»æŸ¥çœ‹ï¼Œé€šè¿‡è°ƒç”¨k8s apiçš„æ–¹å¼è·å–æ‰€æœ‰podçš„çŠ¶æ€ ç„¶ååœ¨æ¯å¤©9ç‚¹æ‰§è¡Œæœ¬è„šæœ¬å³å¯ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101from kubernetes import client, configfrom kubernetes.client.rest import ApiExceptionfrom datetime import datetime, timezoneimport requestsimport jsonimport sysimport pytz# åŠ è½½ Kubernetes é…ç½®#é»˜è®¤ä¼šåœ¨masterèŠ‚ç‚¹å»è¯»å– ~/.kube/config æ–‡ä»¶config.load_kube_config()# åˆ›å»º Kubernetes API å®¢æˆ·ç«¯å®ä¾‹api_instance = client.CoreV1Api()# æŒ‡å®šè¦è·å–çš„å‘½åç©ºé—´åˆ—è¡¨target_namespaces = [sys.argv[1]] # æ›¿æ¢ä¸ºä½ çš„ç›®æ ‡å‘½åç©ºé—´åˆ—è¡¨filtered_keywords = [\"mysql\", \"redis\", \"memcached\", \"postgres\", \"backend\"]# Discord Webhook URLdiscord_webhook_url = \"\" # FOR TEST# æ›¿æ¢ä¸ºä½ çš„ Discord Webhook URLcontainers_without_restart = [] # æ²¡æœ‰é‡å¯åŸå› çš„å®¹å™¨åˆ—è¡¨containers_with_restart = [] # å…·æœ‰é‡å¯åŸå› çš„å®¹å™¨åˆ—è¡¨try: for target_namespace in target_namespaces: # è·å–å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ Pod pods = api_instance.list_namespaced_pod(namespace=target_namespace).items for pod in pods: pod_name = pod.metadata.name pod_status = pod.status.phase pod_restart_reason = \"\" pod_start_time = pod.metadata.creation_timestamp if any(keyword in pod_name for keyword in filtered_keywords): continue # è·å–å½“å‰æ—¶é—´ cst_timezone = pytz.timezone(\"Asia/Shanghai\") current_time = datetime.now(timezone.utc) # è®¡ç®—è¿è¡Œæ—¶é•¿ if pod_start_time is not None: pod_duration = current_time - pod_start_time pod_duration_str = str(pod_duration).split(\".\")[0] # æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå»æ‰å°æ•°éƒ¨åˆ† else: pod_duration_str = \"Unknown\" # æ£€æŸ¥ Pod æ˜¯å¦æœ‰é‡å¯è®°å½• if pod.status.container_statuses is not None: for container_status in pod.status.container_statuses: restart_count = container_status.restart_count # å¦‚æœé‡å¯æ¬¡æ•°å¤§äº 0ï¼Œåˆ™è·å–é‡å¯åŸå›  if restart_count &gt; 0: pod_restart_reason = container_status.last_state.terminated.reason if pod_restart_reason: containers_with_restart.append( (pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count) ) else: containers_without_restart.append( (pod_name, pod_status, pod_duration_str) ) # ç”Ÿæˆæ¶ˆæ¯ message = \"ç¯å¢ƒ: {0} è·å–æ—¶é—´ï¼š{1}\\n\\n\".format(target_namespace,datetime.now(cst_timezone).strftime(\"%Y-%m-%d %H:%M:%S\") + \" CST\") # æ·»åŠ æ²¡æœ‰é‡å¯åŸå› çš„å®¹å™¨ä¿¡æ¯ for container in containers_without_restart: pod_name, pod_status, pod_duration_str = container message += \"å®¹å™¨åç§°: {0} å½“å‰çŠ¶æ€: {1} è¿è¡Œæ—¶é•¿: {2}\\n\".format( pod_name, pod_status, pod_duration_str ) message += \"------------------------------------------------------\\n\" # æ·»åŠ å…·æœ‰é‡å¯åŸå› çš„å®¹å™¨ä¿¡æ¯ for container in containers_with_restart: pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count = container message += \"å®¹å™¨åç§°: {0} å½“å‰çŠ¶æ€: {1} è¿è¡Œæ—¶é•¿: {2} é‡å¯åŸå› : {3} é‡å¯æ¬¡æ•°ï¼š{4}\\n\".format( pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count ) message = \"```{0}```\".format(message) # å‘é€æ¶ˆæ¯åˆ° Discord payload = {\"content\": message} headers = {\"Content-Type\": \"application/json\"} response = requests.post( discord_webhook_url, data=json.dumps(payload), headers=headers ) print(response.content) if response.status_code == 204: print(\"Message sent to Discord successfully\") else: print(f\"Failed to send message to Discord. Status code: {response.status_code}\")except ApiException as e: print(f\"Exception when calling CoreV1Api: {e}\\n\")","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8s,pod","slug":"k8s-pod","permalink":"https://blog.sctux.cc/tags/k8s-pod/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"K8Sä¸­MySQLä½¿ç”¨NFSæŒ‚è½½çš„å¼‚å¸¸é—®é¢˜å¤„ç†","slug":"K8Sä¸­MySQLä½¿ç”¨NFSæŒ‚è½½çš„å¼‚å¸¸é—®é¢˜å¤„ç†","date":"2024-05-10T12:58:02.000Z","updated":"2025-09-01T01:59:08.984Z","comments":true,"path":"2024/05/10/K8Sä¸­MySQLä½¿ç”¨NFSæŒ‚è½½çš„å¼‚å¸¸é—®é¢˜å¤„ç†/","permalink":"https://blog.sctux.cc/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/","excerpt":"é—®é¢˜åŸå› åœ¨k8sä¸­ä½¿ç”¨nfsä½œä¸ºæŒä¹…å­˜å‚¨æ–¹å¼ï¼Œæ ¹æ®ä¸åŒç¯å¢ƒå¯¹åº”ä¸åŒåç§°ç©ºé—´çš„podä½¿ç”¨çš„å­˜å‚¨ç±»/å­˜å‚¨å· ç›¸å¯¹åº”ï¼Œå‘ç°mysql8.0.23 åœ¨å¯åŠ¨æ—¶æŒ‚è½½NFSä¼šå¡ä½çš„æƒ…å†µï¼š é—®é¢˜å¤ç°è¿™é‡Œåœ¨æŸå°å®¿ä¸»æœºä¸Šé¢åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°ç›®å½•ï¼Œç„¶åæŒ‰ç…§é»˜è®¤æ–¹å¼ï¼š 1mount -t nfs 10.10.10.142:/data/bbb /tmp/cc å°†nfsæŒ‚è½½åˆ°æœ¬åœ°ï¼Œç„¶åæ˜ å°„åˆ°å®¹å™¨ä¸­å»ï¼Œæ‰€ä»¥è¿™é‡Œè·Ÿk8sç¯å¢ƒæ²¡å¤šå¤§è”ç³»ï¼Œä¸»è¦æ˜¯nfsæŒ‚è½½é—®é¢˜ï¼š åˆå§‹åŒ–ä¸€ç›´å¡ç€ï¼Œè€Œä¸”åœ¨æŒ‚è½½ç›®å½•å‘ç°åªæœ‰è¿™ä¸ªæ–‡ä»¶ï¼š é—®é¢˜æ’æŸ¥","text":"é—®é¢˜åŸå› åœ¨k8sä¸­ä½¿ç”¨nfsä½œä¸ºæŒä¹…å­˜å‚¨æ–¹å¼ï¼Œæ ¹æ®ä¸åŒç¯å¢ƒå¯¹åº”ä¸åŒåç§°ç©ºé—´çš„podä½¿ç”¨çš„å­˜å‚¨ç±»/å­˜å‚¨å· ç›¸å¯¹åº”ï¼Œå‘ç°mysql8.0.23 åœ¨å¯åŠ¨æ—¶æŒ‚è½½NFSä¼šå¡ä½çš„æƒ…å†µï¼š é—®é¢˜å¤ç°è¿™é‡Œåœ¨æŸå°å®¿ä¸»æœºä¸Šé¢åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°ç›®å½•ï¼Œç„¶åæŒ‰ç…§é»˜è®¤æ–¹å¼ï¼š 1mount -t nfs 10.10.10.142:/data/bbb /tmp/cc å°†nfsæŒ‚è½½åˆ°æœ¬åœ°ï¼Œç„¶åæ˜ å°„åˆ°å®¹å™¨ä¸­å»ï¼Œæ‰€ä»¥è¿™é‡Œè·Ÿk8sç¯å¢ƒæ²¡å¤šå¤§è”ç³»ï¼Œä¸»è¦æ˜¯nfsæŒ‚è½½é—®é¢˜ï¼š åˆå§‹åŒ–ä¸€ç›´å¡ç€ï¼Œè€Œä¸”åœ¨æŒ‚è½½ç›®å½•å‘ç°åªæœ‰è¿™ä¸ªæ–‡ä»¶ï¼š é—®é¢˜æ’æŸ¥æ£€æŸ¥ä¸€ä¸‹nfsæŒ‚è½½çš„å‚æ•°æƒ…å†µï¼š 12345mount -v | grep nfs10.10.10.137:/data/nfs_share_137 on /tmp/fans type nfs (rw,relatime,vers=3,rsize=1048576,wsize=1048576,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.10.10.137,mountvers=3,mo=udp,local_lock=none,addr=10.10.10.137)10.10.10.142:/data/bbb on /tmp/cc type nfs (rw,relatime,vers=3,rsize=1048576,wsize=1048576,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.10.10.142,mountvers=3,mountport=569lock=none,addr=10.10.10.142) å¦‚ä¸Šå¯ä»¥çœ‹å‡ºæˆ‘ä»¬å¦‚æœä½¿ç”¨é»˜è®¤çš„æ–¹å¼ç›´æ¥æŒ‚è½½ï¼Œå®ƒä¼šæœ‰ä¸€äº›é»˜è®¤å‚æ•° åé¢ä¹Ÿæ˜¯é€šè¿‡è¯¥å®¹å™¨è¿è¡Œçš„å®¿ä¸»æœºä¸Šçš„å†…æ ¸æ—¥å¿—æ‰å‘ç°ï¼Œè¿™ä¸ªé—®é¢˜ï¼š é—®é¢˜å¤„ç†è¿™ä¸ªé”™è¯¯æç¤ºå®é™…ä¸Šæ˜¯NFSå®¢æˆ·ç«¯æ— æ³•è·å¾—æ–‡ä»¶é”å®šï¼Œè€Œä¸æ˜¯æ— æ³•ä¸NFSæœåŠ¡å™¨å»ºç«‹è”ç³»ã€‚å½“NFSå®¢æˆ·ç«¯æ— æ³•è·å¾—æ–‡ä»¶é”å®šæ—¶ï¼Œå®ƒä¼šå°è¯•å‘NFSæœåŠ¡å™¨å‘é€é”å®šè¯·æ±‚ï¼Œå¹¶ç­‰å¾…æœåŠ¡å™¨å“åº”ã€‚å¦‚æœNFSæœåŠ¡å™¨æ²¡æœ‰å“åº”ï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°ç±»ä¼¼çš„é”™è¯¯æç¤ºã€‚å¯èƒ½é€ æˆè¿™ä¸ªé”™è¯¯çš„åŸå› å¦‚ä¸‹ï¼š æ£€æŸ¥NFSæœåŠ¡å™¨çš„è´Ÿè½½æƒ…å†µï¼Œå¦‚æœè´Ÿè½½è¿‡é«˜ï¼Œåˆ™å¯èƒ½éœ€è¦ä¼˜åŒ–æœåŠ¡å™¨é…ç½®æˆ–å¢åŠ æœåŠ¡å™¨æ•°é‡ã€‚ æ£€æŸ¥NFSå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œå¦‚æœå­˜åœ¨ç½‘ç»œæ•…éšœï¼Œåˆ™å¯èƒ½éœ€è¦ä¿®å¤ç½‘ç»œé—®é¢˜æˆ–æ›´æ”¹ç½‘ç»œé…ç½®ã€‚ è€ƒè™‘ä½¿ç”¨NFSæŒ‚è½½é€‰é¡¹æ¥ä¼˜åŒ–NFSå®¢æˆ·ç«¯çš„è¡Œä¸ºï¼Œä¾‹å¦‚ä½¿ç”¨softé€‰é¡¹è€Œä¸æ˜¯hardé€‰é¡¹ï¼Œæˆ–è€…ä½¿ç”¨intré€‰é¡¹å…è®¸ä¸­æ–­NFSæ“ä½œã€‚ å¦‚æœNFSå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨ä¸åŒçš„æ—¶åŒºä¸­è¿è¡Œï¼Œåˆ™å¯èƒ½éœ€è¦ä½¿ç”¨noacé€‰é¡¹æ¥ç¦ç”¨NFSå®¢æˆ·ç«¯çš„å±æ€§ç¼“å­˜ï¼Œä»¥ç¡®ä¿æ–‡ä»¶é”å®šè¯·æ±‚å’Œå“åº”çš„æ—¶é—´æˆ³æ˜¯æ­£ç¡®çš„ã€‚ å¦‚æœæ‚¨çš„NFSå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¿è¡Œçš„æ˜¯ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œåˆ™å¯èƒ½éœ€è¦ä½¿ç”¨é€‚å½“çš„æŒ‚è½½é€‰é¡¹æ¥ç¡®ä¿æ–‡ä»¶é”å®šæœºåˆ¶å¾—åˆ°æ­£ç¡®æ”¯æŒï¼Œä¾‹å¦‚ä½¿ç”¨nolocké€‰é¡¹æ¥ç¦ç”¨æ–‡ä»¶é”å®šæœºåˆ¶ã€‚ å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†kuboard, æ— æ³•å…¨å±€å¯¹è¿™ä¸ªå­˜å‚¨ç±»åšæš‚æ—¶ä¸èƒ½å½±å“ä¸šåŠ¡ï¼Œä¸èƒ½æ‰€æœ‰å˜æ›´ï¼š è¿™é‡Œåªæ˜¯å•ç‹¬è¿™ä¸ªmysqlæœåŠ¡æ²¡æœ‰åŠæ³•æŒ‚åœ¨ä½¿ç”¨ï¼Œæ˜¯ç”±éœ€è¦æ·»åŠ æŒ‚è½½å‚æ•°ï¼š æ‰¾åˆ°æˆ‘ä»¬åœ¨é¡µé¢ä¸Šæ–°å»ºçš„pv: 123456789101112131415161718192021222324252627282930313233343536373839 kubectl edit pv -n testnet pvc-b0de2c7f-49de-4e16-83cc-492de8292e5f# Please edit the object below. Lines beginning with a '#' will be ignored,# and an empty file will abort the edit. If an error occurs while saving this file will be# reopened with the relevant failures.#apiVersion: v1kind: PersistentVolumemetadata: annotations: pv.kubernetes.io/provisioned-by: nfs-testnet creationTimestamp: \"2023-07-20T16:29:30Z\" finalizers: - kubernetes.io/pv-protection name: pvc-b0de2c7f-49de-4e16-83cc-492de8292e5f resourceVersion: \"147600146\" uid: e9f111ac-2932-46a0-b6bc-876275dfa02fspec: accessModes: - ReadWriteOnce capacity: storage: 2G claimRef: apiVersion: v1 kind: PersistentVolumeClaim name: dassssssssssssssss namespace: testnet resourceVersion: \"147600141\" uid: b0de2c7f-49de-4e16-83cc-492de8292e5f nfs: path: /data/testnet-dassssssssssssssss-pvc-b0de2c7f-49de-4e16-83cc-492de8292e5f server: 10.10.10.142 persistentVolumeReclaimPolicy: Retain storageClassName: testnet volumeMode: Filesystemstatus: phase: Bound ç„¶åæˆ‘ä»¬åœ¨volumeModeåŒçº§ å°±å¯ä»¥å®šä¹‰æŒ‚è½½å‚æ•°(å…·ä½“å‚æ•°ï¼šhttps://poe.com/s/FyTCOkthr3VREHU3mByA)ï¼š 12345mountOptions:- nolock- timeo=120- intr- retrans=10 è¿™æ ·æˆ‘ä»¬å•ç‹¬ä¸ºMySQLæœåŠ¡åˆ›å»ºçš„è¿™ä¸ªpvcå°±æ‹¥æœ‰äº†è¿™äº›æŒ‚è½½å‚æ•°ï¼Œåˆå§‹åŒ–ï¼Œè¿è¡Œæ­£å¸¸ï¼š åœ¨è¿™ä¸ªpodè¿è¡Œçš„å®¿ä¸»æœºä¸Š æŸ¥çœ‹ç»“æœï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¿®æ”¹pvåçš„å‚æ•°å·²ç»ç”Ÿæ•ˆï¼Œå¹¶ä¸”åœ¨nfsæœåŠ¡ç«¯å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„MySQLåˆå§‹åŒ–æ–‡ä»¶å·²ç»ç”Ÿæˆï¼š æœ€ç»ˆè¯¥æŒ‚è½½é—®é¢˜å®Œç¾è§£å†³ã€‚ å¯¹äºç‰¹æ®Šï¼Œä¸åŒçš„deployment å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡ŒæŒ‰ç…§mysqlçš„éƒ¨ç½²ï¼Œè®°å½•ä¸€ä¸‹é¡ºåº åˆ›å»ºpvc ä¿®æ”¹é»˜è®¤pvcé…ç½®ï¼Œå¢åŠ nfsæŒ‚è½½å‚æ•° å¯åŠ¨pod æ£€æŸ¥æŒ‚è½½ç›®å½•æ•°æ®æ˜¯å¦æ­£å¸¸ç”Ÿæˆ æ£€æŸ¥æŒ‚è½½é€‰é¡¹æ˜¯å¦å·²ç»å¢åŠ  By the way:è°è¯´çš„K8Sä¸èƒ½è·‘MySQLï¼Œ æˆ‘å«©æ­»TA ğŸ”ªğŸ”ªğŸ”ª","categories":[],"tags":[{"name":"NFS","slug":"NFS","permalink":"https://blog.sctux.cc/tags/NFS/"}],"keywords":[]},{"title":"Prometheus+Consulå®ç°ä¼ä¸šçº§å®¿ä¸»æœº+å®¹å™¨ç›‘æ§å‘Šè­¦","slug":"Prometheus-Consulå®ç°ä¼ä¸šçº§å®¿ä¸»æœº-å®¹å™¨ç›‘æ§å‘Šè­¦","date":"2022-09-12T06:45:26.000Z","updated":"2025-09-01T01:59:08.871Z","comments":true,"path":"2022/09/12/Prometheus-Consulå®ç°ä¼ä¸šçº§å®¿ä¸»æœº-å®¹å™¨ç›‘æ§å‘Šè­¦/","permalink":"https://blog.sctux.cc/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/","excerpt":"ä¸€ã€èƒŒæ™¯å› å…¬å¸å†å²é—ç•™åŸå› æœ‰ä¸ªåˆ«ç¯å¢ƒæš‚æ—¶æ²¡æœ‰ä½¿ç”¨kubernets, ç°åœ¨éœ€è¦å°†è¿™æ‰¹æœåŠ¡å™¨çš„ç›‘æ§ç³»ç»Ÿä»zabbixæ›¿æ¢åˆ°Prometheus, äºæ˜¯ä¹è¿™è¾¹æœ‰ä¸ªé—®é¢˜å°±æ˜¯éœ€è¦å°†æ‰€æœ‰æœåŠ¡å™¨ä¸Šé¢çš„æ‰€æœ‰çš„exporter merticsï¼ˆå³ targetï¼‰åœ°å€å†™åˆ°Prometheusé…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶ï¼Œä¼¼ä¹è¿˜ç®—å¯ä»¥ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘é‡‡ç”¨Prometheus+Consulçš„æ–¹å¼æ¥ç®¡ç†æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰exporterï¼Œ é‚£ä¹ˆè¿™æ ·åšçš„å¥½å¤„æ˜¯æˆ‘ä»¬èƒ½æ›´æ¸…æ™°çš„é€šè¿‡Consulæ¥ç®¡ç†ä¸Šé¢çš„æ¯ä¸ªexporter url , ä»¥åŠé€šè¿‡consulè‡ªå¸¦çš„è‡ªå®šä¹‰å…ƒæ•°æ®ï¼Œå†ç»“åˆPromethuesæ— ç–‘æ˜¯ä¸ªå¾ˆçµæ´»çš„æ–¹å¼ã€‚ äºŒã€æ¶æ„ promtheusé…ç½®æ•°æ®æºä¸ºconsu_sd_configs åœ°å€æŒ‡å‘ä¸€ä¸ªconsulå®¢æˆ·ç«¯åœ°å€ï¼› é€šè¿‡è„šæœ¬è°ƒç”¨consulapiçš„æ–¹å¼å°†å®¿ä¸»æœºä¸Šé¢çš„cadvisor-exporter,node-exporter metricsçš„åœ°å€æ³¨å†Œåˆ°consulä¸­ï¼› promtheus æ£€æµ‹åˆ°äº†æ–°å¢æœåŠ¡åï¼Œä¼šé€šè¿‡è¿™ä¸ªhttp://xxxxxx:xxx/metrics url æŠ“å–é‡‡é›†æ•°æ®ï¼› åç»­çš„æ•°æ®é‡‡é›†å°±è·Ÿå¹³å¸¸æˆ‘ä»¬ä½¿ç”¨çš„æ–¹å¼ä¸€æ ·äº†ï¼Œé‡‡é›†åˆ°çš„æ•°æ®æ—¶åºä¿å­˜åœ¨promtheusï¼› Grafanaä½œä¸ºé‡‡é›†æ•°æ®çš„ä¸€ä¸ªå±•ç¤º,é€šè¿‡å„ç§labelï¼Œæ›´åŠ æ–¹ä¾¿çš„å¯¹é¢æ¿è¿›è¡Œé…ç½®ï¼› æ·»åŠ node-exporterï¼Œ cadvisor-exporterçš„æŒ‡æ ‡æŠ¥è­¦è§„åˆ™ï¼Œé€šè¿‡Alertmanager å‘å‡ºä¸»æœºæˆ–å®¹å™¨çš„å‘Šè­¦ï¼› ä¸‰ã€å®ç°Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²è¯¥ç¼–æ’æ–‡ä»¶ä¸­éƒ¨ç½²äº† Prometheus: ç›‘æ§ç³»ç»Ÿä¸»ç¨‹åº Alertmanager: å‘Šè­¦å‘é€ Grafana: æ•°æ®å±•ç¤º Prometheus-dingding-webhook: é’‰é’‰å‘Šè­¦æ¨é€ alertmanager-dashboard: ä¸»è¦ç”¨äºå‘Šè­¦æ¡ç›®å±•ç¤ºï¼Œè¯¥è½¯ä»¶æ˜¯å¼€æºé¡¹ç›®ï¼Œéšæ„ä¸‹è½½éƒ¨ç½² 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104cat &gt; docker-compose.yaml &lt;&lt; EOFversion: '3.7'services: prometheus: image: prom/prometheus:latest volumes: - ./prometheus/:/etc/prometheus/ - /data/prometheus-data:/prometheus command: - '--config.file=/etc/prometheus/prometheus.yml' - '--storage.tsdb.path=/prometheus' - '--web.console.libraries=/usr/share/prometheus/console_libraries' - '--web.console.templates=/usr/share/prometheus/consoles' - '--web.enable-lifecycle' - '--web.external-url=http://192.168.18.178:9090' ports: - 9090:9090 links: - alertmanager:alertmanager restart: always deploy: resources: limits: cpus: \"1.0\" memory: 500M alertmanager: image: prom/alertmanager ports: - 9093:9093 volumes: - ./alertmanager/:/etc/alertmanager/ restart: always command: - '--config.file=/etc/alertmanager/config.yml' - '--storage.path=/alertmanager' deploy: resources: limits: cpus: \"1.0\" memory: 500M grafana: image: grafana/grafana:8.4.0 depends_on: - prometheus ports: - 3000:3000 volumes: - /data/grafana-data:/var/lib/grafana - ./grafana/provisioning/:/etc/grafana/provisioning/ env_file: - ./grafana/config.monitoring restart: always deploy: resources: limits: cpus: \"1.0\" memory: 500M webhook: image: timonwong/prometheus-webhook-dingtalk depends_on: - prometheus volumes: - ./prometheus-webhook-dingtalk/config.yml:/config/config.yml - ./prometheus-webhook-dingtalk/dingding.tmpl:/config/dingding.tmpl ports: - 9060:8060 command: - '--web.listen-address=:8060' - '--config.file=/config/config.yml' - '--web.enable-ui' - '--web.enable-lifecycle' restart: always deploy: resources: limits: cpus: \"1.0\" memory: 500M alertmanager-dashboard: image: ghcr.io/prymitive/karma:latest ports: - 9094:8080 restart: always environment: - ALERTMANAGER_URI=http://192.168.18.178:9093 deploy: resources: limits: cpus: \"1.0\" memory: 500MEOF# runèµ·æ¥docker-compose up -d","text":"ä¸€ã€èƒŒæ™¯å› å…¬å¸å†å²é—ç•™åŸå› æœ‰ä¸ªåˆ«ç¯å¢ƒæš‚æ—¶æ²¡æœ‰ä½¿ç”¨kubernets, ç°åœ¨éœ€è¦å°†è¿™æ‰¹æœåŠ¡å™¨çš„ç›‘æ§ç³»ç»Ÿä»zabbixæ›¿æ¢åˆ°Prometheus, äºæ˜¯ä¹è¿™è¾¹æœ‰ä¸ªé—®é¢˜å°±æ˜¯éœ€è¦å°†æ‰€æœ‰æœåŠ¡å™¨ä¸Šé¢çš„æ‰€æœ‰çš„exporter merticsï¼ˆå³ targetï¼‰åœ°å€å†™åˆ°Prometheusé…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶ï¼Œä¼¼ä¹è¿˜ç®—å¯ä»¥ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘é‡‡ç”¨Prometheus+Consulçš„æ–¹å¼æ¥ç®¡ç†æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰exporterï¼Œ é‚£ä¹ˆè¿™æ ·åšçš„å¥½å¤„æ˜¯æˆ‘ä»¬èƒ½æ›´æ¸…æ™°çš„é€šè¿‡Consulæ¥ç®¡ç†ä¸Šé¢çš„æ¯ä¸ªexporter url , ä»¥åŠé€šè¿‡consulè‡ªå¸¦çš„è‡ªå®šä¹‰å…ƒæ•°æ®ï¼Œå†ç»“åˆPromethuesæ— ç–‘æ˜¯ä¸ªå¾ˆçµæ´»çš„æ–¹å¼ã€‚ äºŒã€æ¶æ„ promtheusé…ç½®æ•°æ®æºä¸ºconsu_sd_configs åœ°å€æŒ‡å‘ä¸€ä¸ªconsulå®¢æˆ·ç«¯åœ°å€ï¼› é€šè¿‡è„šæœ¬è°ƒç”¨consulapiçš„æ–¹å¼å°†å®¿ä¸»æœºä¸Šé¢çš„cadvisor-exporter,node-exporter metricsçš„åœ°å€æ³¨å†Œåˆ°consulä¸­ï¼› promtheus æ£€æµ‹åˆ°äº†æ–°å¢æœåŠ¡åï¼Œä¼šé€šè¿‡è¿™ä¸ªhttp://xxxxxx:xxx/metrics url æŠ“å–é‡‡é›†æ•°æ®ï¼› åç»­çš„æ•°æ®é‡‡é›†å°±è·Ÿå¹³å¸¸æˆ‘ä»¬ä½¿ç”¨çš„æ–¹å¼ä¸€æ ·äº†ï¼Œé‡‡é›†åˆ°çš„æ•°æ®æ—¶åºä¿å­˜åœ¨promtheusï¼› Grafanaä½œä¸ºé‡‡é›†æ•°æ®çš„ä¸€ä¸ªå±•ç¤º,é€šè¿‡å„ç§labelï¼Œæ›´åŠ æ–¹ä¾¿çš„å¯¹é¢æ¿è¿›è¡Œé…ç½®ï¼› æ·»åŠ node-exporterï¼Œ cadvisor-exporterçš„æŒ‡æ ‡æŠ¥è­¦è§„åˆ™ï¼Œé€šè¿‡Alertmanager å‘å‡ºä¸»æœºæˆ–å®¹å™¨çš„å‘Šè­¦ï¼› ä¸‰ã€å®ç°Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²è¯¥ç¼–æ’æ–‡ä»¶ä¸­éƒ¨ç½²äº† Prometheus: ç›‘æ§ç³»ç»Ÿä¸»ç¨‹åº Alertmanager: å‘Šè­¦å‘é€ Grafana: æ•°æ®å±•ç¤º Prometheus-dingding-webhook: é’‰é’‰å‘Šè­¦æ¨é€ alertmanager-dashboard: ä¸»è¦ç”¨äºå‘Šè­¦æ¡ç›®å±•ç¤ºï¼Œè¯¥è½¯ä»¶æ˜¯å¼€æºé¡¹ç›®ï¼Œéšæ„ä¸‹è½½éƒ¨ç½² 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104cat &gt; docker-compose.yaml &lt;&lt; EOFversion: '3.7'services: prometheus: image: prom/prometheus:latest volumes: - ./prometheus/:/etc/prometheus/ - /data/prometheus-data:/prometheus command: - '--config.file=/etc/prometheus/prometheus.yml' - '--storage.tsdb.path=/prometheus' - '--web.console.libraries=/usr/share/prometheus/console_libraries' - '--web.console.templates=/usr/share/prometheus/consoles' - '--web.enable-lifecycle' - '--web.external-url=http://192.168.18.178:9090' ports: - 9090:9090 links: - alertmanager:alertmanager restart: always deploy: resources: limits: cpus: \"1.0\" memory: 500M alertmanager: image: prom/alertmanager ports: - 9093:9093 volumes: - ./alertmanager/:/etc/alertmanager/ restart: always command: - '--config.file=/etc/alertmanager/config.yml' - '--storage.path=/alertmanager' deploy: resources: limits: cpus: \"1.0\" memory: 500M grafana: image: grafana/grafana:8.4.0 depends_on: - prometheus ports: - 3000:3000 volumes: - /data/grafana-data:/var/lib/grafana - ./grafana/provisioning/:/etc/grafana/provisioning/ env_file: - ./grafana/config.monitoring restart: always deploy: resources: limits: cpus: \"1.0\" memory: 500M webhook: image: timonwong/prometheus-webhook-dingtalk depends_on: - prometheus volumes: - ./prometheus-webhook-dingtalk/config.yml:/config/config.yml - ./prometheus-webhook-dingtalk/dingding.tmpl:/config/dingding.tmpl ports: - 9060:8060 command: - '--web.listen-address=:8060' - '--config.file=/config/config.yml' - '--web.enable-ui' - '--web.enable-lifecycle' restart: always deploy: resources: limits: cpus: \"1.0\" memory: 500M alertmanager-dashboard: image: ghcr.io/prymitive/karma:latest ports: - 9094:8080 restart: always environment: - ALERTMANAGER_URI=http://192.168.18.178:9093 deploy: resources: limits: cpus: \"1.0\" memory: 500MEOF# runèµ·æ¥docker-compose up -d ä»¥ä¸Šè¿è¡Œèµ·æ¥åï¼ŒåŸºæœ¬çš„åŠŸèƒ½å·²ç»å®Œæˆï¼Œæ­¤æ—¶åªéœ€è¦å°†targetæ·»åŠ åˆ°prometheusä¸­å°±å¯ä»¥äº† 3.2 exporter(æ•°æ®é‡‡é›†å™¨)éƒ¨ç½²ä¸Šé¢æåˆ°æˆ‘ä»¬è¿™éƒ¨åˆ†ç¯å¢ƒæ²¡æœ‰è¿ç§»åˆ°k8sï¼Œæ‰€æœ‰å¾®æœåŠ¡éƒ½æ˜¯dockeræ–¹å¼è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šé¢çš„ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œéœ€è¦å•ç‹¬éœ€è¦å»éƒ¨ç½²å¯¹å®¿ä¸»æœºè·Ÿå®¹å™¨çš„eporter(æ•°æ®é‡‡é›†å™¨), ç›®å‰çš„éœ€æ±‚å°±æ˜¯ç›‘æ§å®¿ä¸»æœºä»¥åŠå®¹å™¨ï¼Œå¹¶å°†é‡‡é›†åˆ°çš„æ•°æ®è¿›è¡Œå±•ç¤ºã€å‘Šè­¦ç­‰ã€‚ å®¿ä¸»æœºçš„ç›‘æ§ï¼šåˆ©ç”¨Prometheusæ­å»ºéƒ¨ç½²ç›‘æ§ç³»ç»Ÿï¼Œé‚£ä¹ˆå¯¹äºæœåŠ¡å™¨å±‚é¢çš„æ•°æ®é‡‡é›†æˆ‘ä»¬é¦–é€‰çš„æ˜¯node-exporterï¼› å®¹å™¨çš„ç›‘æ§ï¼šåœ¨è°ƒç ”å®¹å™¨ç›‘æ§è¿™å—å„¿çš„æ—¶å€™å‘ç°container-exporterç›‘æ§æŒ‡æ ‡è™½ç„¶èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯å‘ç°é‡‡é›†çš„æ•°æ®è¿‡äºç®€æ´ä¸”åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šé€ æˆå†…å­˜ç§¯å‹æœ€ç»ˆå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œé™¤éæ˜¯äººä¸ºå¹²æ¶‰é‡å¯ä¸€ä¸‹ï¼Œé‡Šæ”¾å†…å­˜ï¼Œä½†æ˜¯è¿™ç§äº‹å„¿ä¸åº”è¯¥å‘ç”Ÿã€‚å› æ­¤è¿˜æ˜¯é‡‡ç”¨cadvisor exporteræ¥è¿›è¡Œå®¹å™¨çš„æ•°æ®é‡‡é›† éœ€è¦åœ¨æ¯å°å®¿ä¸»æœºä¸Šé¢éƒ¨ç½²ä¸¤ä¸ªexporter åˆ›å»ºç›®å½•(ä¸€èˆ¬æ”¾åˆ°æ™®é€šç”¨æˆ·appå®¶ç›®å½•å³å¯)1mkdir exporter-deploy &amp;&amp; cd exporter-deploy ç¼–æ’æ–‡ä»¶å‡†å¤‡12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455cat &gt; docker-compose.yaml &lt;&lt; EOFversion: '3.7'services: # å®¿ä¸»æœºæ•°æ®é‡‡é›† node-exporter: image: bitnami/node-exporter:latest volumes: - /proc:/host/proc:ro - /sys:/host/sys:ro - /:/rootfs:ro - /:/host:ro,rslave command: - '--path.rootfs=/host' - '--path.procfs=/host/proc' - '--path.sysfs=/host/sys' - --web.disable-exporter-metrics - --collector.filesystem.ignored-mount-points - \"^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)\" ports: - 9100:9100 restart: always deploy: resources: limits: cpus: \"1.0\" memory: 500M # å®¹å™¨æ•°æ®é‡‡é›† cadvisor-exporter: image: gcr.io/cadvisor/cadvisor/cadvisor:v0.45.0 volumes: - /:/rootfs:ro - /var/run:/var/run:rw - /sys:/sys:ro - /var/lib/docker/:/var/lib/docker:ro command: - \"-docker_only=true\" - \"-housekeeping_interval=10s\" - \"-docker_only=true\" - \"--allow_dynamic_housekeeping=false\" - \"--storage_duration=20s\" ports: - 9105:8080 restart: always deploy: mode: global resources: limits: cpus: \"2.0\" memory: 500MEOF # runèµ·æ¥docker-compose up -d ä»¥ä¸Šï¼Œåªéœ€è¦æ­¤é…ç½®æ–‡ä»¶å°±éƒ¨ç½²å¥½äº† â€œexporterå®¢æˆ·ç«¯â€ ä¸‹é¢å°±æ˜¯ å°†è¿™å°æœåŠ¡å™¨ä»¥åŠè¿ä¸ªexporterçš„url æ³¨å†Œåˆ°consulä¸­ï¼Œå¦‚æœæœ‰æ‰¹é‡å®‰è£…éœ€æ±‚ï¼Œç›´æ¥åœ¨jumpä¸Šé¢é€šè¿‡ansible æ¨é€å³å¯ 3.3 consul é›†ç¾¤éƒ¨ç½²æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªdocker ç½‘ç»œ1docker network create --driver bridge --subnet 10.10.0.0/24 consul-network åˆ›å»ºconsulçš„æ•°æ®ã€é…ç½®ç›®å½•12sudo mkdir -p /data/consul/consul-server{1..3}/{data,config}sudo mkdir -p /data/consul/consul-client{1..2}/{data,config} ç¼–è¾‘docker-composeé…ç½®1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889cat &gt; docker-compose-consul-cluster.yaml &lt;&lt; \\EOFversion: '3.7' services: consul-server1: image: consul:latest network_mode: consul-network container_name: consul-server1 restart: always command: agent -server -client=0.0.0.0 -bootstrap-expect=3 -node=consul-server1 -bind=0.0.0.0 -config-dir=/consul/config volumes: - /data/consul/consul-server1/data:/consul/data - /data/consul/consul-server1/config:/consul/config consul-server2: image: consul:latest network_mode: consul-network container_name: consul-server2 restart: always command: agent -server -client=0.0.0.0 -retry-join=consul-server1 -node=consul-server2 -bind=0.0.0.0 -config-dir=/consul/config volumes: - /data/consul/consul-server2/data:/consul/data - /data/consul/consul-server2/config:/consul/config depends_on: - consul-server1 consul-server3: image: consul:latest network_mode: consul-network container_name: consul-server3 restart: always command: agent -server -client=0.0.0.0 -retry-join=consul-server1 -node=consul-server3 -bind=0.0.0.0 -config-dir=/consul/config volumes: - /data/consul/consul-server3/data:/consul/data - /data/consul/consul-server3/config:/consul/config depends_on: - consul-server1 consul-client1: image: consul:latest network_mode: consul-network container_name: consul-client1 restart: always ports: - 8500:8500 command: agent -client=0.0.0.0 -retry-join=consul-server1 -ui -node=consul-client1 -bind=0.0.0.0 -config-dir=/consul/config volumes: - /data/consul/consul-client1/data:/consul/data - /data/consul/consul-client1/config:/consul/config depends_on: - consul-server2 - consul-server3 consul-client2: image: consul:latest network_mode: consul-network container_name: consul-client2 restart: always ports: - 8501:8500 command: agent -client=0.0.0.0 -retry-join=consul-server1 -ui -node=consul-client2 -bind=0.0.0.0 -config-dir=/consul/config volumes: - /data/consul/consul-client2/data:/consul/data - /data/consul/consul-client2/config:/consul/config depends_on: - consul-server2 - consul-server3EOF # è¿è¡Œèµ·æ¥ï¼šdocker-compose -f docker-compose-consul-cluster.yaml up -d docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES223826237a7b consul:latest \"docker-entrypoint.sâ€¦\" 3 seconds ago Up 2 seconds 8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8501-&gt;8500/tcp, :::8501-&gt;8500/tcp consul-client2337a3188fb75 consul:latest \"docker-entrypoint.sâ€¦\" 3 seconds ago Up 2 seconds 8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8500-&gt;8500/tcp, :::8500-&gt;8500/tcp consul-client1685440aefca3 consul:latest \"docker-entrypoint.sâ€¦\" 4 seconds ago Up 3 seconds 8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp consul-server25f9927f2ecac consul:latest \"docker-entrypoint.sâ€¦\" 4 seconds ago Up 3 seconds 8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp consul-server3612b93b95ad9 consul:latest \"docker-entrypoint.sâ€¦\" 5 seconds ago Up 4 seconds 8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp consul-server1 # æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼šdocker exec -it consul-server1 consul membersNode Address Status Type Build Protocol DC Partition Segmentconsul-server1 10.10.0.2:8301 alive server 1.13.1 2 dc1 default &lt;all&gt;consul-server2 10.10.0.3:8301 alive server 1.13.1 2 dc1 default &lt;all&gt;consul-server3 10.10.0.4:8301 alive server 1.13.1 2 dc1 default &lt;all&gt;consul-client1 10.10.0.6:8301 alive client 1.13.1 2 dc1 default &lt;default&gt;consul-client2 10.10.0.5:8301 alive client 1.13.1 2 dc1 default &lt;default&gt; è®¿é—®consulçš„webé¡µé¢http://192.168.18.179:8501/ui/dc1/overview/server-status æ­¤æ—¶é›†ç¾¤å·²ç»æ­å»ºå®Œæ¯• å°†æœåŠ¡å™¨çš„exporteræ³¨å†Œåˆ°consulåœ¨consul uiä¸­å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ç»“æœ ä»¥ä¸Šå°±æ˜¯å°†191.168.18.21ä¸»æœºä¸Šçš„cadvisoræœåŠ¡æ³¨å†Œåˆ°äº†consuä¸Šé¢ï¼Œå°†è¿™ç±»æœåŠ¡çš„åç§°ç»Ÿç§°ä¸º cadvisor-exporter ,å› ä¸ºæœåŠ¡å®ä¾‹idå¿…é¡»å”¯ä¸€ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç‰¹æ®Šå®šä¹‰ä¸€ä¸‹ exporter type - ä¸»æœºå - ipåœ°å€ æœ€åå°±æ˜¯å°†ä¸¤ä¸ªepxorteréƒ½å°†21è¿™å°ä¸»æœºçš„ä¸¤ä¸ªexporteréƒ½æ³¨å†Œåˆ°äº†consul. é…ç½®promeheus ä½¿å…¶æ”¯æŒconsul1234567891011121314151617181920212223242526272829303132..................scrape_configs: - job_name: 'prometheus' scrape_interval: 15s static_configs: - targets: ['localhost:9090'] - job_name: \"cnosul-prometheus\" consul_sd_configs: - server: \"192.168.18.178:8501\" services: [] relabel_configs: # relabe é‡å†™ - source_labels: [__meta_consul_service] # serviceæºæ ‡ç­¾ regex: \"consul\" # serviceåŒ¹é… action: drop # æ‰§è¡Œçš„åŠ¨ä½œ, è¿™é‡Œä¸éœ€è¦consulçš„metricsï¼Œæ‰€ä»¥dropæ‰ - source_labels: [__meta_consul_service_metadata_hostname] # å°†æ­¤æ ‡ç­¾çš„å€¼é‡å†™ä¸ºinstance target_label: instance action: replace - source_labels: [__meta_consul_service_metadata_group] target_label: group action: replace - source_labels: [__scheme__, __address__, __metrics_path__] regex: \"(http|https)(.*)\" # ä¸¤ä¸ªåˆ†ç»„ separator: \"\" target_label: \"endpoint\" replacement: \"${1}://${2}\" # å¼•ç”¨ä¸¤ä¸ªåˆ†ç»„ action: replace.................. æ–°å¢åŠ ä»¥ä¸Šé…ç½®ä»¥åé‡æ–°åŠ è½½é…ç½®promtheusæœåŠ¡ curl -I -X POST http://127.0.0.1:9090/-/reload æ³¨æ„ï¼šprometheuså¼€å¯apiçƒ­åŠ è½½ï¼Œéœ€è¦åŠ ä¸Šå¯åŠ¨å‚æ•°ï¼š â€“web.enable-lifecycle consulæ³¨å†ŒæœåŠ¡/å®ä¾‹çš„æ—¶å€™å°±éœ€è¦æ·»åŠ è¿™ä¸¤ä¸ªå…ƒæ ‡ç­¾ï¼Œå†é€šè¿‡æ ‡ç­¾é‡æ–° ä¸ºæˆ‘ä»¬éœ€è¦çš„labelï¼Œä¾¿äºåé¢prometheus/grafanaä½¿ç”¨ ä»¥ä¸Šï¼Œé€šè¿‡é…ç½® prometheus ä¸º consul_sd_configsï¼Œä¹‹åèƒ½å¤Ÿæ­£ç¡®é€šè¿‡æœåŠ¡å‘ç°è·å–åˆ°ä¸¤ä¸ªæœåŠ¡å¾—metircs urlã€‚ æœåŠ¡å™¨ä¼—å¤šçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é‚£ä¹ˆè¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡è„šæœ¬çš„æ–¹å¼å»æ·»åŠ ï¼Œå› ä¸ºconsulæœ‰ä»¥ä¸‹å…ƒæ ‡ç­¾ï¼Œé‚£ä¹ˆæ›´å®¹æ˜“ä½¿å¾—æˆ‘ä»¬çš„æ•°æ®å¯æ§ï¼Œä¾‹å¦‚ä¸Šé¢æˆ‘ä»¬åœ¨æ³¨å†ŒæœåŠ¡çš„æ—¶å€™åŠ äº†ä¸€ä¸ª group ï¼Œhostname, consulä¼ é€’åˆ°promtheusä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡relableçš„æ–¹å¼å»é‡å†™, ä»¥ä¸Šä»£è¡¨çš„å°±æ˜¯è¿™ä¸ªä¸»æœºå±äºå“ªä¸ªåˆ†ç»„ï¼Œåç»­å¯ä»¥ä½œä¸ºgrafané¢æ¿ä¸­ï¼Œæˆ–è€…æŠ¥è­¦ä¸­çš„ä¸€ä¸ªå…³é”®æŒ‡æ ‡ã€‚ å¦‚ä½•æ‰¹é‡æ³¨å†Œcadvisor/node exporter åˆ° consulconsul è‡ªèº«æä¾›äº†APIï¼Œ å°±åƒä¸Šé¢ä¸€æ ·åšæˆè„šæœ¬ä»¥åï¼Œæ‰¹é‡æ³¨å†ŒæœåŠ¡/å®ä¾‹å³å¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103cat &gt; register_exporter_to_consul.py &lt;&lt; \\EOF # -*- coding:utf-8 -*-# date: 2022-09-06# author: guomaoqiu# desc: æ‰¹é‡æ³¨å†Œcadvisor-exporter, node-exporteræœåŠ¡åˆ°consul import jsonimport requestsimport json consul_url = \"http://192.168.18.179:8501/v1/agent/service/register\" # æ³¨å†Œnode-exporterdef register_node_exporter(ip,hostname,group): nodedata = { \"id\": \"node-exporter-{0}-{1}\".format(hostname,ip), # \"id\": hostname, \"name\": \"node-exporter\", \"address\": ip, \"port\": 9100, \"tags\": [], \"meta\": { \"hostname\": hostname, \"group\": group }, \"checks\": [ { \"http\": \"http://{0}:9100/metrics\".format(ip), \"interval\": \"5s\" } ] } print(nodedata) try: r = requests.put(url=consul_url, data=json.dumps(nodedata)) if r.status_code == 200: print(ip, \"Node Exporter æ³¨å†ŒæˆåŠŸ\") else: print(ip, \"Node Exporter æ³¨å†Œå¤±è´¥\") except Exception as e: print(e) # æ³¨å†Œcadvisor-exporterdef register_container_exporter(ip,hostname,group): container_data = { \"id\": \"cadvisor-exporter-{0}-{1}\".format(hostname,ip), \"name\": \"cadvisor-exporter\", \"address\": ip, \"port\": 9105, \"tags\": [], \"meta\": { \"hostname\": hostname, \"group\": group }, \"checks\": [ { \"http\": \"http://{0}:9105/metrics\".format(ip), \"interval\": \"5s\" } ] } try: r = requests.put(url=consul_url, data=json.dumps(container_data)) print(r.status_code,r.content) if r.status_code == 200: print(ip, \"Container Exporter æ³¨å†ŒæˆåŠŸ\") else: print(ip, \"Container Exporter æ³¨å†Œå¤±è´¥\") except Exception as e: print(e) def register(): with open(\"server_list.txt\",\"r\") as f: lines = (f.readlines()) for data in lines: ip = (str(data).split(\"\\t\")[1].strip(\"\\n\")) group = (str(data).split(\"\\t\")[2].strip(\"\\n\")) hostname = (str(data).split(\"\\t\")[0]) register_node_exporter(ip=ip,hostname=hostname,group=group) register_container_exporter(ip=ip,hostname=hostname,group=group) register() EOF ### ä»¥ä¸Šéœ€è¦æå‰å‡†å¤‡å¥½ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡Œä¸€æ¡æ•°æ®é‡Œé¢æ ¼å¼å¦‚ä¸‹ï¼š cat server_list.txthostname1 192.168.18.21 IDEhostname2 192.168.18.22 IDEhostname3 192.168.18.31 IDE..................... # è¿™é‡Œæ˜¯çº¿ä¸‹ç¯å¢ƒçš„ä¸€ä¸ªé…ç½®ï¼Œæ‰€ä»¥å•çº¯åªæ˜¯å°†ç¯å¢ƒä½œä¸ºåˆ†ç»„ï¼Œè¿™é‡Œå¯ä»¥è‡ªå®šä¹‰ï¼Œä½†æ˜¯ä¸èƒ½å°‘äº†æˆ–å¤šäº†å­—æ®µæ•°æ®# æ‰§è¡Œè„šæœ¬ï¼špython3 register_exporter_to_consul.py æ‰§è¡Œä»¥ä¸Šè„šæœ¬ä»¥åå°±å¯ä»¥åœ¨consulä»¥åŠpromtheus webé¡µé¢è¿›è¡ŒæŸ¥çœ‹æ£€éªŒäº†ï¼š ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°å·²ç»æ³¨å†Œäº†54ä¸ªï¼Œä½†æ˜¯è¿™å…¶å®åªæ·»åŠ äº†27å°æœåŠ¡å™¨è€Œå·²ï¼Œå› ä¸ºæ¯å°æœåŠ¡å™¨ä¸Šé¢è¿è¡Œäº†ä¸¤ä¸ªexporter,ä¸€ä¸ªæ˜¯node-exporter,ä¸€ä¸ªæ˜¯cadvisor-exporterï¼Œ ä»–ä»¬æœ‰å„è‡ªçš„metrics URL ,æœ€åå†åˆ°prometheusæ£€æŸ¥æ˜¯å¦æ·»åŠ å³å¯ã€‚ ä»¥ä¸Šå¯ä»¥çœ‹åˆ° ï¼ŒæœåŠ¡æ•°é‡ã€exporteræ•°æ®è·å–æ­£å¸¸ã€‚ è‡³æ­¤ï¼Œconsulçš„éƒ¨ç½²ï¼ŒæœåŠ¡/å®ä¾‹çš„æ³¨å†Œï¼Œpromtheusçš„consul_sd_configsæœåŠ¡è‡ªåŠ¨å‘ç° ï¼Œæ•°æ®é‡‡é›†å·²ç»å®Œæˆï¼Œåç»­å°±æ˜¯å°†prometheus æ¥å…¥åˆ° grafanaï¼š ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°é€šè¿‡è‡ªå®šä¹‰çš„labelè¿›è¡Œåˆ†ç»„ å‘Šè­¦ç³»ç»Ÿæ¥å…¥å·²ç»å¯ä»¥çœ‹åˆ°å®¹å™¨&amp;å®¿ä¸»æœºçš„æ•°æ®å·²ç»æ­£å¸¸é‡‡é›†å¹¶ä¸”å·²ç»èƒ½å¤Ÿåœ¨grafané¢æ¿ä¸Šè¿›è¡Œå±•ç¤º æŠ¥è­¦ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Alertmanager æ­é… Webhookæ¥å®ç°ï¼š alertmanageré…ç½®1234567891011121314151617181920212223242526272829303132333435363738394041424344cat &gt; alertmanager/config.yml &lt;&lt; EOFglobal: # å…¨å±€é…ç½® resolve_timeout: 10m # è¶…æ—¶æ—¶é—´ é»˜è®¤10minhibit_rules: - source_match: ## æºæŠ¥è­¦è§„åˆ™ alertname: 'critical' target_match: alertname: 'warning' equal: ['alertname'] # é€šè¿‡alertnameå»æŠ‘åˆ¶route: receiver: default-receiver group_wait: 30s group_interval: 5m repeat_interval: 3h group_by: ['alertname'] routes: - receiver: webhook-ide matchers: - group = IDE # é€šè¿‡prometehus alert rule æŸ¥è¯¢å‡ºæ¥çš„ç»“æœå¿…é¡»åŒ…å« groupå­—æ®µï¼Œå¦åˆ™è¯¥æ¡æŠ¥è­¦ä¸èƒ½å‘é€å‡ºæ¥ - receiver: webhook-stage matchers: - group = Stage - receiver: webhook-Pet matchers: - group = Petreceivers:- name: default-receiver # è¿™é‡Œä¸éœ€è¦è®¾ç½®ï¼Œéœ€è¦ç²¾ç¡®åŒ¹é…åˆ°æ¯ä¸€æ¡å‘Šè§„åˆ™ ï¼Œä½†æ˜¯è¿™é‡Œå¿…é¡»è¦å­˜åœ¨ï¼Œä¸Šé¢å¼ºè°ƒäº†å¿…é¡»è¦æœ‰ä¸€ä¸ªé»˜è®¤çš„receiver- name: webhook-ide webhook_configs: # webhookå‘Šè­¦é…ç½® - url: 'http://192.168.18.178:9060/dingtalk/webhook-ide/send' send_resolved: true- name: webhook-stage webhook_configs: # webhookå‘Šè­¦é…ç½® - url: 'http://192.168.18.178:9060/dingtalk/webhook-stage/send' send_resolved: true- name: webhook-Pet webhook_configs: # webhookå‘Šè­¦é…ç½® - url: 'http://192.168.18.178:9060/dingtalk/webhook-Pet/send' send_resolved: true EOF# é‡å¯æœåŠ¡åŠ è½½ dingding-webhooké…ç½®è¿™é‡ŒæŒ‰ç…§ç¯å¢ƒè¿›è¡Œäº†åˆ†ç»„ï¼Œå°†ä¸åŒçš„å‘Šè­¦ä¿¡æ¯é€šè¿‡ç¯å¢ƒå‘é€åˆ°ä¸åŒçš„é’‰é’‰ç¾¤ 1234567891011121314151617181920212223242526272829303132333435363738cat &gt; prometheus-dingding-webhook/config.yml &lt;&lt; EOF## Request timeout# timeout: 5s ## Uncomment following line in order to write template from scratch (be careful!)#no_builtin_template: false ## Customizable templates path#templates:# - /config/dingding.tmpltemplates: - /config/template.tmpl## You can also override default template using `default_message`## The following example to use the 'legacy' template from v0.3.0#default_message: # title: '{{ template \"legacy.title\" . }}'# text: '{{ template \"legacy.content\" . }}'## Targets, previously was known as \"profiles\"# text: '{{ template \"_dingtalk.link.content\" . }}'targets: webhook1: url: https://oapi.dingtalk.com/robot/send?access_token=92268cd2c48db0ec2a10a753213dda6a11e4d54ea8fdbce356f217fa44925a7f secret: å¡«å†™ä½ çš„é’‰é’‰secret webhook-ide: url: https://oapi.dingtalk.com/robot/send?access_token=92268cd2c48db0ec2a10a753213dda6a11e4d54ea8fdbce356f217fa44925a7f secret: å¡«å†™ä½ çš„é’‰é’‰secret webhook-stage: url: https://oapi.dingtalk.com/robot/send?access_token=9d7172785d72f50ab335367bd7db8cb013073f62bd0fd7bfc9605020a6a4b95c secret: å¡«å†™ä½ çš„é’‰é’‰secret webhook-Pet: url: https://oapi.dingtalk.com/robot/send?access_token=89b881f5798ec7cdff1538ecf3a7001dd30d19c7e5281e5e8329cb1e243b813e secret: ä½ çš„é’‰é’‰secret EOF è¿™é‡Œè¿˜è‡ªå®šä¹‰äº†æŠ¥è­¦æ¨¡æ¿ï¼Œä¸Šè¿°æ–‡ä»¶ä¸­éœ€è¦å¼•å…¥ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667cat &gt; dingding.tmpl &lt;&lt; EOF{{ define \"__subject\" }}[{{ .Status | toUpper }}{{ if eq .Status \"firing\" }}:{{ .Alerts.Firing | len }}{{ end }}]{{ end }}{{ define \"__alert_list\" }}{{ range . }}---**å‘Šè­¦åç§°**: {{ index .Annotations \"title\" }}**å‘Šè­¦çº§åˆ«**: {{ .Labels.severity }}**å‘Šè­¦ä¸»æœºç»„**: {{ .Labels.group }}**å‘Šè­¦ä¸»æœº**: {{ .Labels.instance }}**å›¾è¡¨æ•°æ®**: [Click]({{ .GeneratorURL }})**å‘Šè­¦ä¿¡æ¯**: {{ index .Annotations \"description\" }}**å‘Šè­¦æ—¶é—´**: {{ dateInZone \"2006.01.02 15:04:05\" (.StartsAt) \"Asia/Shanghai\" }}**é¢„æ¡ˆé“¾æ¥**: [CONFæ–‡æ¡£]({{ index .Annotations \"plan_url\" }}){{ end }}{{ end }}{{ define \"__resolved_list\" }}{{ range . }}---**å‘Šè­¦åç§°**: {{ index .Annotations \"title\" }}**å‘Šè­¦çº§åˆ«**: {{ .Labels.severity }}**å‘Šè­¦ä¸»æœº**: {{ .Labels.instance }}**å›¾è¡¨æ•°æ®**: [Click]({{ .GeneratorURL }})**å‘Šè­¦ä¿¡æ¯**: {{ index .Annotations \"description\" }}**å‘Šè­¦æ—¶é—´**: {{ dateInZone \"2006.01.02 15:04:05\" (.StartsAt) \"Asia/Shanghai\" }}**æ¢å¤æ—¶é—´**: {{ dateInZone \"2006.01.02 15:04:05\" (.EndsAt) \"Asia/Shanghai\" }}{{ end }}{{ end }}{{ define \"default.title\" }}{{ template \"__subject\" . }}{{ end }}{{ define \"default.content\" }}{{ if gt (len .Alerts.Firing) 0 }}**ğŸ’”ğŸ’”ğŸ’”ä¾¦æµ‹åˆ°{{ .Alerts.Firing | len }}ä¸ªå‘Šè­¦ğŸ’”ğŸ’”ğŸ’”**{{ template \"__alert_list\" .Alerts.Firing }}---{{ end }}{{ if gt (len .Alerts.Resolved) 0 }}**ğŸ’šğŸ’šğŸ’šæ¢å¤{{ .Alerts.Resolved | len }}ä¸ªå‘Šè­¦ğŸ’šğŸ’šğŸ’š**{{ template \"__resolved_list\" .Alerts.Resolved }}{{ end }}{{ end }}{{ define \"ding.link.title\" }}{{ template \"default.title\" . }}{{ end }}{{ define \"ding.link.content\" }}{{ template \"default.content\" . }}{{ end }}{{ template \"default.title\" . }}{{ template \"default.content\" . }}EOF è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ¨¡æ¿ä¸­æˆ‘ä»¬åŠ äº†è‡ªå®šä¹‰çš„ä¸€äº›è‡ªå·±æƒ³è¦çš„ä¸œè¥¿ï¼š éœ€è¦åœ¨å‘Šè­¦çš„æ—¶å€™åŠ ä¸Šé’ˆå¯¹æ¯ä¸ªå‘Šè­¦çš„æ—¥å¸¸å¤„ç†æ–¹å¼çš„ä¸€ä¸ªé¢„æ¡ˆï¼Œé‚£ä¹ˆè¿™ä¸ªå°±ç»™å‡ºä¸€ä¸ªæ–‡æ¡£çš„é“¾æ¥å°±è¡Œäº†ï¼Œæ—¥å¸¸è¿ç»´äººå‘˜çœ‹åˆ°å‘Šè­¦ä¹‹åï¼Œä¸€èˆ¬éƒ½ä¼šè¿›è¡Œä¸€ä¸ªæ•…éšœå¤„ç†è¿‡ç¨‹æˆ–è®°å½•å§ï¼Œè¿™æ ·èƒ½æ›´åŠ å‹å¥½ã€‚é‚£å¦‚ä½•å®šä¹‰ï¼Ÿé¦–å…ˆåœ¨å‘Šè­¦è§„åˆ™ä¸­å»å®šä¹‰å­—æ®µ,æ¯”å¦‚è¿™é‡Œæˆ‘æ·»åŠ äº†ä¸€ä¸ª plan_url:ç„¶åå†æ¨¡æ¿ä¸­å¼•ç”¨å³å¯. Prometheusä¸­éœ€è¦å¼€å¯ å¤–éƒ¨url è®¿é—®ï¼Œå³åœ¨å¯åŠ¨çš„æ—¶å€™åŠ å…¥å‚æ•°- '--web.external-url=http://192.168.18.178:9090', å¦åˆ™å‘Šè­¦æ¨¡æ¿ä¸­çš„ .GeneratorURL è¿™ä¸ªå€¼åº”ç”¨çš„æ˜¯prometheusçš„ä¸»æœºåï¼Œå³è¿è¡Œprometheusçš„é‚£ä¸ªå®¹å™¨çš„ä¸»æœºåï¼Œé‚£æ ·è®¿é—®æ˜¯è®¿é—®ä¸åˆ°çš„ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ å¦å¤–åœ¨éƒ¨ç½²prometheus æˆ‘ä»¬è¿˜éƒ¨ç½²äº†ä¸€ä¸ªå®¹å™¨ä¸Šæ˜¯githubä¸Šæœ‰äººå¼€æºäº†ä¸€ä¸ªæ¥å…¥alertmanager api çš„æ–¹å¼è·å–æŠ¥è­¦å†…å®¹å¹¶è¿›è¡Œå±•ç¤ºã€‚æ¯”èµ·alertmanagerè¿™ä¸ªç»„ä»¶è‡ªèº«çš„é‚£ä¸ªuiæ›´åŠ å¥½ç”¨ã€‚å‡ºå¤„ï¼š(https://github.com/prymitive/karmaï¼‰ è‡³æ­¤æ•´ä¸ªç›‘æ§ç³»ç»Ÿå°±æ­å»ºå®Œæ¯•ï¼Œè¿˜æ˜¯æœ‰æ¯”è¾ƒç»†èŠ‚çš„åœ°æ–¹éœ€è¦å¤„ç†æ¯”å¦‚å‘Šè­¦è§„åˆ™ã€å‘Šè­¦é¢‘ç‡è¿™äº›éœ€è¦å»ä¼˜åŒ–ã€‚","categories":[{"name":"monitor","slug":"monitor","permalink":"https://blog.sctux.cc/categories/monitor/"}],"tags":[{"name":"Prometheus","slug":"Prometheus","permalink":"https://blog.sctux.cc/tags/Prometheus/"},{"name":"Consul","slug":"Consul","permalink":"https://blog.sctux.cc/tags/Consul/"},{"name":"Alertmanager","slug":"Alertmanager","permalink":"https://blog.sctux.cc/tags/Alertmanager/"}],"keywords":[{"name":"monitor","slug":"monitor","permalink":"https://blog.sctux.cc/categories/monitor/"}]},{"title":"åŸºäºå®¹å™¨åŒ–éƒ¨ç½²Nacosé›†ç¾¤","slug":"åŸºäºå®¹å™¨åŒ–éƒ¨ç½²Nacosé›†ç¾¤","date":"2022-06-22T14:41:33.000Z","updated":"2025-09-01T01:59:08.862Z","comments":true,"path":"2022/06/22/åŸºäºå®¹å™¨åŒ–éƒ¨ç½²Nacosé›†ç¾¤/","permalink":"https://blog.sctux.cc/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/","excerpt":"ä¸€ã€æ­å»ºæ¶æ„â— 3ä¸ªæˆ–3ä¸ªä»¥ä¸ŠNacosèŠ‚ç‚¹æ‰èƒ½æ„æˆé›†ç¾¤ï¼›â— Nacos Nginx Proxyç”¨äºä»£ç†è½¬å‘ï¼› äºŒã€å‡†å¤‡å·¥ä½œNacos2.0ç‰ˆæœ¬ç›¸æ¯”1.Xæ–°å¢äº†gRPCçš„é€šä¿¡æ–¹å¼ï¼Œå› æ­¤éœ€è¦å¢åŠ 2ä¸ªç«¯å£ã€‚æ–°å¢ç«¯å£æ˜¯åœ¨é…ç½®çš„ä¸»ç«¯å£(server.port)åŸºç¡€ä¸Šï¼Œè¿›è¡Œä¸€å®šåç§»é‡è‡ªåŠ¨ç”Ÿæˆã€‚ ç«¯å£ ä¸ä¸»ç«¯å£çš„åç§»é‡ æè¿° 8848 0 Nacosç¨‹åºä¸»é…ç½®ç«¯å£ 9848 +1000 å®¢æˆ·ç«¯gRPCè¯·æ±‚æœåŠ¡ç«¯ç«¯å£ï¼Œç”¨äºå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥å’Œè¯·æ±‚ 9849 +1001 æœåŠ¡ç«¯gRPCè¯·æ±‚æœåŠ¡ç«¯ç«¯å£ï¼Œç”¨äºæœåŠ¡é—´åŒæ­¥ç­‰ 7848 -1000 Nacos é›†ç¾¤é€šä¿¡ç«¯å£ï¼Œç”¨äºNacos é›†ç¾¤é—´è¿›è¡Œé€‰ä¸¾ï¼Œæ£€æµ‹ç­‰ ä½¿ç”¨VIP/nginxè¯·æ±‚æ—¶ï¼Œéœ€è¦é…ç½®æˆTCPè½¬å‘ï¼Œä¸èƒ½é…ç½®http2è½¬å‘ï¼Œå¦åˆ™è¿æ¥ä¼šè¢«nginxæ–­å¼€ æŒ‰ç…§ä¸Šè¿°å®˜æ–¹çš„ç«¯å£åˆ†é…è¦æ±‚ ï¼Œæ­¤å¤„éƒ¨ç½²çš„ä½¿ç”¨ä¸‰å°æœåŠ¡å™¨ä¸Šé¢åˆ›å»ºçš„Nacosé›†ç¾¤ç«¯å£åˆ†é…å¦‚ä¸‹ï¼š èŠ‚ç‚¹ IP ç«¯å£ï¼ˆæ‰€éœ€æš´éœ²ï¼‰ å¤‡æ³¨ ç‰ˆæœ¬ å½“å‰çº¿ä¸‹ç¯å¢ƒéƒ¨ç½²æ–‡ä»¶è·¯å¾„ Nacos_1 192168.18.73 å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 Nacos èŠ‚ç‚¹ä¸€ nacos/nacos-server:2.0.2 /root/nacos-deploy/ Nacos_2 192168.18.74 å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 Nacos èŠ‚ç‚¹äºŒ nacos/nacos-server:2.0.2 /root/nacos-deploy/ Nacos_3 192168.18.75 å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 Nacos èŠ‚ç‚¹ä¸‰ nacos/nacos-server:2.0.2 /root/nacos-deploy/ Nacos DB 192168.18.75 å®¿ä¸»æœºï¼š3306 å®¹å™¨ï¼š3306 Nacosæ‰€éœ€æ•°æ®åº“ mysql:5.7.34 /root/nacos-mysql-deploy Nacos Nginx Proxy 192168.18.75 å®¿ä¸»æœºï¼š80 å®¹å™¨ï¼š80 Nacosä»£ç† nginx:stable-alpine /root/nacos-proxy-deploy 2.1 åˆ›å»ºNacosæ•°æ®åº“","text":"ä¸€ã€æ­å»ºæ¶æ„â— 3ä¸ªæˆ–3ä¸ªä»¥ä¸ŠNacosèŠ‚ç‚¹æ‰èƒ½æ„æˆé›†ç¾¤ï¼›â— Nacos Nginx Proxyç”¨äºä»£ç†è½¬å‘ï¼› äºŒã€å‡†å¤‡å·¥ä½œNacos2.0ç‰ˆæœ¬ç›¸æ¯”1.Xæ–°å¢äº†gRPCçš„é€šä¿¡æ–¹å¼ï¼Œå› æ­¤éœ€è¦å¢åŠ 2ä¸ªç«¯å£ã€‚æ–°å¢ç«¯å£æ˜¯åœ¨é…ç½®çš„ä¸»ç«¯å£(server.port)åŸºç¡€ä¸Šï¼Œè¿›è¡Œä¸€å®šåç§»é‡è‡ªåŠ¨ç”Ÿæˆã€‚ ç«¯å£ ä¸ä¸»ç«¯å£çš„åç§»é‡ æè¿° 8848 0 Nacosç¨‹åºä¸»é…ç½®ç«¯å£ 9848 +1000 å®¢æˆ·ç«¯gRPCè¯·æ±‚æœåŠ¡ç«¯ç«¯å£ï¼Œç”¨äºå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥å’Œè¯·æ±‚ 9849 +1001 æœåŠ¡ç«¯gRPCè¯·æ±‚æœåŠ¡ç«¯ç«¯å£ï¼Œç”¨äºæœåŠ¡é—´åŒæ­¥ç­‰ 7848 -1000 Nacos é›†ç¾¤é€šä¿¡ç«¯å£ï¼Œç”¨äºNacos é›†ç¾¤é—´è¿›è¡Œé€‰ä¸¾ï¼Œæ£€æµ‹ç­‰ ä½¿ç”¨VIP/nginxè¯·æ±‚æ—¶ï¼Œéœ€è¦é…ç½®æˆTCPè½¬å‘ï¼Œä¸èƒ½é…ç½®http2è½¬å‘ï¼Œå¦åˆ™è¿æ¥ä¼šè¢«nginxæ–­å¼€ æŒ‰ç…§ä¸Šè¿°å®˜æ–¹çš„ç«¯å£åˆ†é…è¦æ±‚ ï¼Œæ­¤å¤„éƒ¨ç½²çš„ä½¿ç”¨ä¸‰å°æœåŠ¡å™¨ä¸Šé¢åˆ›å»ºçš„Nacosé›†ç¾¤ç«¯å£åˆ†é…å¦‚ä¸‹ï¼š èŠ‚ç‚¹ IP ç«¯å£ï¼ˆæ‰€éœ€æš´éœ²ï¼‰ å¤‡æ³¨ ç‰ˆæœ¬ å½“å‰çº¿ä¸‹ç¯å¢ƒéƒ¨ç½²æ–‡ä»¶è·¯å¾„ Nacos_1 192168.18.73 å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 Nacos èŠ‚ç‚¹ä¸€ nacos/nacos-server:2.0.2 /root/nacos-deploy/ Nacos_2 192168.18.74 å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 Nacos èŠ‚ç‚¹äºŒ nacos/nacos-server:2.0.2 /root/nacos-deploy/ Nacos_3 192168.18.75 å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858 Nacos èŠ‚ç‚¹ä¸‰ nacos/nacos-server:2.0.2 /root/nacos-deploy/ Nacos DB 192168.18.75 å®¿ä¸»æœºï¼š3306 å®¹å™¨ï¼š3306 Nacosæ‰€éœ€æ•°æ®åº“ mysql:5.7.34 /root/nacos-mysql-deploy Nacos Nginx Proxy 192168.18.75 å®¿ä¸»æœºï¼š80 å®¹å™¨ï¼š80 Nacosä»£ç† nginx:stable-alpine /root/nacos-proxy-deploy 2.1 åˆ›å»ºNacosæ•°æ®åº“è¿™é‡Œä½¿ç”¨çš„æ˜¯å®¹å™¨åŒ–è¿è¡Œnacosï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå¹¶ä»å®˜æ–¹å¯¹åº”çš„ç‰ˆæœ¬ä¸­å»å¯¼å…¥åŸºæœ¬æ•°æ®åº“ç»“æ„çš„æ•°æ®æ–‡ä»¶ 2.1.1 è·å–nacos 2.0.2 åŒ…æ–‡ä»¶ä¸­çš„åŸºç¡€è¡¨ç»“æ„æ•°æ®123456789101112131415161718192021222324https://github.com/alibaba/nacos/releases/download/2.0.2/nacos-server-2.0.2.tar.gz# tar -xf nacos-server-2.0.2.tar.gz# cd nacos# tree -L 2.â”œâ”€â”€ binâ”‚ â”œâ”€â”€ shutdown.cmdâ”‚ â”œâ”€â”€ shutdown.shâ”‚ â”œâ”€â”€ startup.cmdâ”‚ â””â”€â”€ startup.shâ”œâ”€â”€ confâ”‚ â”œâ”€â”€ 1.4.0-ipv6_support-update.sqlâ”‚ â”œâ”€â”€ application.propertiesâ”‚ â”œâ”€â”€ application.properties.exampleâ”‚ â”œâ”€â”€ cluster.conf.exampleâ”‚ â”œâ”€â”€ nacos-logback.xmlâ”‚ â”œâ”€â”€ nacos-mysql.sqlâ”‚ â””â”€â”€ schema.sqlâ”œâ”€â”€ LICENSEâ”œâ”€â”€ NOTICEâ””â”€â”€ target â””â”€â”€ nacos-server.jarä»¥ä¸Šæ˜¯nacosçš„äºŒè¿›åˆ¶åŒ…æ–‡ä»¶ ï¼Œè¿™é‡Œåªç”¨åˆ°äº† nacos-mysql.sql è¿™ä¸ªæ–‡ä»¶ 2.1.2 åˆ›å»ºmysqlæœåŠ¡123456789101112131415161718192021222324252627282930313233# 192.168.18.75sudo -i mkdir /data/mysqlcat &lt;&lt; EOF &gt; /root/nacos-mysql-deploy/mysql.yamlversion: \"3\"services: mysql-db: container_name: nacos-mysql image: mysql:5.7.34 ports: - \"3306:3306\" environment: MYSQL_ROOT_PASSWORD: xxxxxxxxxxxx volumes: - \"/data/mysql:/var/lib/mysql\" restart: alwaysEOFdocker-compose -f /root/nacos-mysql-deploy/mysql.yaml up -d# å¯¼å…¥å®˜æ–¹è¡¨æ•°æ®docker cp /root/nacos/conf/nacos-mysql.sql nacos-mysql:/tmpdocker exec -it nacos-mysql shmysql -uroot -pxxxxxxxxxxxxcreate database nacos;use nacos;source /tmp/nacos-mysql.sql; 2.2 NaocsæœåŠ¡2.2.1 åˆ›å»ºã€ç¼–å†™yamlæ–‡ä»¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104sudo -imkdir /data/nacos2.0.2_1/logs -pmkdir /root/nacos-deploy/cat &lt;&lt; EOF &gt; /root/nacos-deploy/nacos1.yamlversion: \"3\"services: nacos1: hostname: nacos2.0.2_1 container_name: nacos2.0.2_1 image: nacos/nacos-server:2.0.2 volumes: - /data/nacos2.0.2_1/logs:/home/nacos/logs - /data/nacos2.0.2_1/custom.properties:/home/nacos/init.d/custom.properties ports: - \"8858:8858\" - \"9858:9858\" - \"9859:9859\" - \"7858:7858\" environment: - MODE=cluster - PREFER_HOST_MODE=hostname - NACOS_SERVER_IP=192.168.18.73 - NACOS_APPLICATION_PORT=8858 - NACOS_SERVERS=192.168.18.73:8858 192.168.18.74:8858 192.168.18.75:8858 - SPRING_DATASOURCE_PLATFORM=mysql - MYSQL_SERVICE_HOST=192.168.18.75 - MYSQL_SERVICE_DB_NAME=nacos - MYSQL_SERVICE_PORT=3306 - MYSQL_SERVICE_USER=root - MYSQL_SERVICE_PASSWORD=xxxxxxxxxxx - NACOS_AUTH_ENABLE=true - MYSQL_DATABASE_NUM=1 restart: alwaysEOF######################sudo -imkdir /data/nacos2.0.2_2/logs -pmkdir /root/nacos-deploy/cat &lt;&lt; EOF &gt; /root/nacos-deploy/nacos2.yamlversion: \"3\"services: nacos2: hostname: nacos2.0.2_2 container_name: nacos2.0.2_2 image: nacos/nacos-server:2.0.2 volumes: - /data/nacos2.0.2_2/logs:/home/nacos/logs - /data/nacos2.0.2_2/custom.properties:/home/nacos/init.d/custom.properties ports: - \"8858:8858\" - \"9858:9858\" - \"9859:9859\" - \"7858:7858\" environment: - MODE=cluster - PREFER_HOST_MODE=hostname - NACOS_SERVER_IP=192.168.18.74 - NACOS_APPLICATION_PORT=8858 - NACOS_SERVERS=192.168.18.73:8858 192.168.18.74:8858 192.168.18.75:8858 - SPRING_DATASOURCE_PLATFORM=mysql - MYSQL_SERVICE_HOST=192.168.18.75 - MYSQL_SERVICE_DB_NAME=nacos - MYSQL_SERVICE_PORT=3306 - MYSQL_SERVICE_USER=root - MYSQL_SERVICE_PASSWORD=xxxxxxxxxxx - NACOS_AUTH_ENABLE=true - MYSQL_DATABASE_NUM=1 restart: alwaysEOF######################sudo -imkdir /data/nacos2.0.2_3/logs -pmkdir /root/nacos-deploy/cat &lt;&lt; EOF &gt; /root/nacos-deploy/nacos3.yamlversion: \"3\"services: nacos3: hostname: nacos2.0.2_3 container_name: nacos2.0.2_3 image: nacos/nacos-server:2.0.2 volumes: - /data/nacos2.0.2_3/logs:/home/nacos/logs - /data/nacos2.0.2_3/custom.properties:/home/nacos/init.d/custom.properties ports: - \"8858:8858\" - \"9858:9858\" - \"9859:9859\" - \"7858:7858\" environment: - MODE=cluster - PREFER_HOST_MODE=hostname - NACOS_SERVER_IP=192.168.18.75 - NACOS_APPLICATION_PORT=8858 - NACOS_SERVERS=192.168.18.73:8858 192.168.18.74:8858 192.168.18.75:8858 - SPRING_DATASOURCE_PLATFORM=mysql - MYSQL_SERVICE_HOST=192.168.18.75 - MYSQL_SERVICE_DB_NAME=nacos - MYSQL_SERVICE_PORT=3306 - MYSQL_SERVICE_USER=root - MYSQL_SERVICE_PASSWORD=xxxxxxxxxxx - NACOS_AUTH_ENABLE=true - MYSQL_DATABASE_NUM=1 restart: alwaysEOF ä»¥ä¸Š å„é…ç½®ä¸­çš„ç«¯å£éæ ‡å‡†ç«¯å£ï¼Œéœ€è¦æ³¨æ„ç¯å¢ƒå˜é‡ NACOS_APPLICATION_PORT å¦‚æœä¸æŒ‡å®šä¸ºéç‰¹å®šç«¯å£ï¼Œé‚£ä¹ˆç¼ºçœåœ¨é…ç½®ä¸­çš„ç¯å¢ƒå˜é‡åˆ™ä¸º 8848 ï¼Œåœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œä¸‰ä¸ªèŠ‚ç‚¹ä¼šå‡ºç°é—®é¢˜ï¼ 2.2.2 è¿è¡ŒNacoså„èŠ‚ç‚¹è¿è¡Œå³å¯ 12345678# 192.168.18.73docker-compose -f /root/nacos-deploy/nacos1.yaml up -d# 192.168.18.74docker-compose -f /root/nacos-deploy/nacos2.yaml up -d# 192.168.18.75docker-compose -f /root/nacos-deploy/nacos3.yaml up -d ä¸Šå›¾ ä¸‰ä¸ªèŠ‚ç‚¹å•ç‹¬è®¿é—®é¡µé¢æ­£å¸¸ï¼›é€šè¿‡ä»£ç†è®¿é—®æ­£å¸¸ï¼› æ³¨æ„ï¼šwebé¡µé¢å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯gRPCè°ƒç”¨æœåŠ¡ï¼Œä½†æ˜¯åœ¨ç¨‹åºä¸­éœ€è¦è¯·æ±‚å¯¹åº”çš„ç«¯å£ï¼Œæ‰€ä»¥åŠ¡å¿…éœ€è¦æš´éœ²å‡ºæ¥ï¼Œå› ä¸ºä½¿ç”¨äº†éæ ‡å‡†ç«¯å£ï¼Œé‚£ä¹ˆåœ¨nginxåšä»£ç†æ—¶å°±ç›´æ¥(ä¼ªè£…)æ˜ å°„æˆæ ‡å‡†ç«¯å£å³å¯ã€‚ 2.3 Nginxä»£ç†é…ç½®æ­¤å¤„ä»ç„¶ä½¿ç”¨å®¹å™¨åŒ–æ–¹å¼è¿è¡Œã€‚é…ç½®nginxä»£ç† 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374mkdir /root/nacos-proxy-deploycd /root/nacos-proxy-deploycat &lt;&lt;EOF &gt; nginx.conf user nginx;worker_processes auto; error_log /var/log/nginx/error.log notice;pid /var/run/nginx.pid; events { worker_connections 65535;} stream { upstream nacos-server-grpc9848 { server 192.168.18.73:9858 max_fails=1 fail_timeout=30s; server 192.168.18.74:9858 max_fails=1 fail_timeout=30s; server 192.168.18.75:9858 max_fails=1 fail_timeout=30s } server { listen 9848; proxy_pass nacos-server-grpc9848; } upstream nacos-server-grpc9849 { server 192.168.18.73:9859 max_fails=1 fail_timeout=30s; server 192.168.18.74:9859 max_fails=1 fail_timeout=30s; server 192.168.18.75:9859 max_fails=1 fail_timeout=30s; } server { listen 9849; proxy_pass nacos-server-grpc9849; }} http { include /etc/nginx/mime.types; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /var/log/nginx/access.log main; sendfile on; #tcp_nopush on; keepalive_timeout 65; #gzip on; upstream NACOS { server 192.168.18.73:8858 max_fails=1 fail_timeout=30s; server 192.168.18.74:8858 max_fails=1 fail_timeout=30s; server 192.168.18.75:8858 max_fails=1 fail_timeout=30s; } server { listen 8848 default_server; server_name _; location / { proxy_pass http://NACOS; } } include /etc/nginx/conf.d/*.conf;}EOF ä»£ç†å®¹å™¨yamlæ–‡ä»¶ç¼–å†™ 123456789101112131415161718cat &gt; nacos-nginx-proxy.yaml &lt;&lt; EOF version: \"3\"services: nacos_proxy: container_name: nacos_nginx_proxy image: \"nginx:stable-alpine\" ports: - 80: 8848 #è¿™é‡Œå®šä¹‰ä¸€ä¸ª80æ˜¯ä¸ºäº†å‰ç«¯è®¿é—®ï¼Œæˆ–å®¢æˆ·ç«¯é…ç½®å®šä¹‰æ—¶æ— éœ€å†åŠ ç«¯å£ï¼Œä¸€ä¸ªipæˆ–è€…åŸŸåå³å¯ - 8848:8848 - 9848:9848 - 9849:9849 volumes: - /root/nacos-proxy-deploy/nginx.conf:/etc/nginx/nginx.conf:ro restart: alwaysEOF# å®¹å™¨è¿è¡Œdocker-compose -f nacos-proxy.yaml up -d è‡³æ­¤æ­å»ºå®Œæ¯•ï¼Œä½†æ˜¯å®¹å™¨è¿è¡Œæ­£å¸¸ä¸ä¸€å®šæœåŠ¡å°±æ˜¯æ­£å¸¸ï¼Œè¿™æ—¶éœ€è¦æµ‹è¯•å®ä¾‹æœåŠ¡æ³¨å†Œæ˜¯å¦æ­£å¸¸ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193cat &gt; nacos_check_status.py &lt;&lt; EOF# author: maoqiu.guo# desc: NacosæœåŠ¡æ³¨å†ŒåŠŸèƒ½æµ‹è¯•ã€çŠ¶æ€ç›‘æ§# dateï¼š2022-06-11 import requestsimport jsonimport timeimport loggingfrom logging.handlers import RotatingFileHandlerimport sys logging.basicConfig(level=logging.DEBUG)# åˆ›å»ºæ—¥å¿—è®°å½•å™¨ï¼ŒæŒ‡æ˜æ—¥å¿—ä¿å­˜çš„è·¯å¾„ï¼Œæ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å€¼ï¼Œä¿å­˜çš„æ—¥å¿—æ–‡ä»¶ä¸ªæ•°ä¸Šé™log_handle = RotatingFileHandler('./log.txt', maxBytes=1024*1024, backupCount=5)# åˆ›å»ºæ—¥å¿—è®°å½•çš„æ ¼å¼formatter = logging.Formatter(\"format = '%(asctime)s - %(name)s - %(levelname)s - %(message)s-%(funcName)s',\")# ä¸ºåˆ›å»ºçš„æ—¥å¿—è®°å½•å™¨è®¾ç½®æ—¥å¿—è®°å½•æ ¼å¼log_handle.setFormatter(formatter)# ä¸ºå…¨å±€çš„æ—¥å¿—å·¥å…·å¯¹è±¡æ·»åŠ æ—¥å¿—è®°å½•å™¨logging.getLogger().addHandler(log_handle) # è¿›åº¦æ¡def progress_bar(timmer): for i in range(1, 101): print(\"\\r\", end=\"\") print(\"Waiting: {}%: \".format(i), \"â–‹\" * (i // 2), end=\"\") sys.stdout.flush() time.sleep(timmer) class Nacos(): def __init__(self): self.webhookurl=\"https://oapi.dingtalk.com/robot/send?access_token=1968dd11647dfd686c4e1107cf1ad3d0d21c3813a824ee632728327722d9fa82\" self.login_url = \"/nacos/v1/auth/users/login\" self.accessToken=None self.service_url = \"/nacos/v1/ns/catalog/services\" self.instance_url = \"/nacos/v1/ns/instance\" @staticmethod def dingding(self, content): data = { \"msgtype\": \"text\", \"text\": { \"content\": \"Nacos-\" + content, }, } headers = {'Content-Type': 'application/json;charset=utf-8'} response = requests.post(self.webhookurl, data=json.dumps(data), headers=headers) print(response.content) def get_access_token(self, nacos_server): logging.info(\"\\n\\n************** NacosServer: {0} **************\".format(nacos_server)) \"ç™»å½•è·å–nacos accessToken\" params= \"username=nacos&amp;password=nacos\" try: r = json.loads(requests.post(params=params, url=\"http://\" + nacos_server + self.login_url, timeout=5).text) accessToken = str((r['accessToken'])) return {\"accessToken\": accessToken, \"result\": True, \"server\": nacos_server, \"msg\": \"Login Nacos Success...[{0}]\".format(nacos_server)} except Exception as e: return {\"accessToken\": None, \"result\": False, \"server\": nacos_server, \"msg\": \"Login Nacos Falied...[{0}] Error: {1}\".format(nacos_server, str(e))} def register_test(self, accessToken, nacos_server): ''' 1. åˆ›å»ºå®ä¾‹ 2. æ³¨å†ŒæœåŠ¡ 3. åˆ é™¤å®ä¾‹ 4. åˆ é™¤æœåŠ¡ ''' data={ \"serviceName\": \"test_service_instance\", \"namespaceId\": \"public\", \"accessToken\": accessToken, \"ip\": nacos_server.split(\":\")[0], \"port\": nacos_server.split(\":\")[1], \"ephemeral\": False } # åˆ›å»ºæœåŠ¡(æ³¨å†Œå®ä¾‹) try: r = (requests.post(params=data, url=\"http://\" + nacos_server + self.instance_url, timeout=5).text) if r == \"ok\": msg = \"[æ³¨å†Œå®ä¾‹&amp;åˆ›å»ºæœåŠ¡æˆåŠŸ] Service: {0} NameSpace: {1} {2} InstanceIP: {3}\".format(data['serviceName'], data['namespaceId'], nacos_server, data['ip']) logging.info(msg) else: msg = \"[æ³¨å†Œå®ä¾‹&amp;åˆ›å»ºæœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}\".format(data['serviceName'], data['namespaceId'], nacos_server, r) logging.error(msg) self.dingding(self, content=msg) except Exception as e: msg = \"[æ³¨å†Œå®ä¾‹&amp;åˆ›å»ºæœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}\".format(data['serviceName'], data['namespaceId'], nacos_server, r) logging.error(msg) self.dingding(self, content=msg) # åˆ é™¤å®ä¾‹ def delete_instance_service(self, accessToken, nacos_server): data={ \"serviceName\": \"test_service_instance\", \"namespaceId\": \"public\", \"accessToken\": accessToken, \"ip\": nacos_server.split(\":\")[0], \"port\": nacos_server.split(\":\")[1], \"ephemeral\": False } # æ³¨é”€å®ä¾‹ try: r = (requests.delete(params=data, url=\"http://\" + nacos_server + self.instance_url, timeout=5).text) if r == \"ok\": msg = \"[æ³¨é”€å®ä¾‹æˆåŠŸ] Service: {0} NameSpace: {1} {2} \".format(data['serviceName'], data['namespaceId'], nacos_server) logging.info(msg) else: msg = \"[æ³¨é”€å®ä¾‹å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}\".format(data['serviceName'], data['namespaceId'], nacos_server, r) logging.error(msg) self.dingding(self, content=msg) except Exception as e: msg = \"[æ³¨é”€å®ä¾‹å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}\".format(data['serviceName'], data['namespaceId'], nacos_server, r) logging.error(msg) self.dingding(self, content=msg) progress_bar(timmer=0.08) # åˆ é™¤æœåŠ¡ try: r = (requests.delete(params=data, url=\"http://\" + nacos_server + \"/nacos/v1/ns/service\", timeout=5).text) if r == \"ok\": msg = \"[åˆ é™¤æœåŠ¡æˆåŠŸ] Service: {0} NameSpace: {1} {2} \".format(data['serviceName'], data['namespaceId'], nacos_server) logging.info(msg) else: msg = \"[åˆ é™¤æœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}\".format(data['serviceName'], data['namespaceId'], nacos_server, r) logging.error(msg) self.dingding(self, content=msg) except Exception as e: msg = \"[åˆ é™¤æœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}\".format(data['serviceName'], data['namespaceId'], nacos_server, r) logging.error(msg) self.dingding(self, content=msg) progress_bar(timmer=0.1) def get_service_list(self, accessToken, nacos_server): \"è¯·æ±‚è®¿é—®æŸä¸ªç¯å¢ƒçš„æŸä¸€ä¸ªæœåŠ¡åˆ—è¡¨, æ£€æŸ¥è¿”å›æ•°æ®æ˜¯å¦ä¸ºç©º,ä¸ºç©ºåˆ™ä¸ºä¸æ­£å¸¸\" payload={ \"accessToken\": accessToken, \"pageNo\": 1, \"pageSize\": 10, \"namespaceId\": \"stage\" } try: r = json.loads(requests.get(params=payload, url=\"http://\" + nacos_server + self.service_url).text) if r['count'] == 0: msg = \"[è·å–æ³¨å†ŒæœåŠ¡æ•°æ®å¤±è´¥] Nacos Server {0} å½“å‰StageæœåŠ¡åˆ—è¡¨ä¸ºç©º!\".format(nacos_server) logging.info(msg) self.dingding(self, content=msg) else: # print(\"Nacos æ³¨å†ŒæœåŠ¡æ•°æ®æ­£å¸¸...[{0}]\".format(nacos_server)) logging.info(\"[è·å–æ³¨å†ŒæœåŠ¡æ•°æ®æˆåŠŸ] ServiceTotal {1} on {0} - SercieName: stage \".format(nacos_server,r['count'])) except Exception as e: pass def letsgo(self, nacos_server): # ç™»å½•è·å–token login_nacos_res = (self.get_access_token(nacos_server)) if login_nacos_res[\"result\"]: logging.info(\"[ç™»å½•è·å–accessToken æˆåŠŸ] Nacos Server {0} \".format((login_nacos_res['server']))) self.get_service_list(login_nacos_res['accessToken'], login_nacos_res['server'] ) # åˆ›å»ºå®ä¾‹&amp;æœåŠ¡ self.register_test(login_nacos_res['accessToken'], login_nacos_res['server'] ) #time.sleep(60 * 2) progress_bar(timmer=0.1) self.delete_instance_service(login_nacos_res['accessToken'], login_nacos_res['server'] ) else: msg = \"[ç™»å½•è·å–accessToken å¤±è´¥] {0} \".format((login_nacos_res['msg'])) logging.info(msg) self.dingding(self, content=msg) if __name__ == \"__main__\": while True: nacos_server_list=[ #\"nacos.axiba.com\", \"192.168.18.75:80\", \"192.168.18.75:8848\", \"192.168.18.73:8858\", \"192.168.18.74:8858\", \"192.168.18.75:8858\", ] for i in nacos_server_list: Nacos().letsgo(i)EOF è¿è¡Œåï¼š ä»¥ä¸Šè„šæœ¬é€šè¿‡Nacosçš„OpenApiå¾ªç¯å¼é€šè¿‡ä»æ¯ä¸ªèŠ‚ç‚¹è®¿é—®åå‘èµ·ä»¥åŠé€šè¿‡Nginxä»£ç†å‘èµ·æœåŠ¡å®ä¾‹çš„æŸ¥è¯¢ã€æ³¨å†Œã€åˆ é™¤æ“ä½œã€‚ ç™»å½•è·å–AccessToke(æ¯ä¸ªè¯·æ±‚éœ€è¦æºå¸¦) åœ¨ è·å–stageç¯å¢ƒçš„æœåŠ¡åˆ—è¡¨æ•°æ®ï¼Œè¿™æ˜¯ä¸ºäº†ç›‘æµ‹è¿”å›æ•°æ®æ˜¯å¦æ­£å¸¸ï¼Œå› ä¸ºè¿™é‡Œåˆšæ­å»ºèµ·æ¥ï¼Œå¦‚æœé‡Œé¢æœåŠ¡æ•°æ®ä¸æ­£å¸¸åˆ™ä¼šå‡ºç°ä¸Šé¢æç¤ºï¼Œå¹¶å‘é€æ¶ˆæ¯åˆ°é’‰é’‰ï¼› ä¸Šå›¾æ˜¯é€šè¿‡ä»£ç†è®¿é—®è·å–stageä¸­çš„æœåŠ¡ä¸º0ï¼Œåå‘é€é€šçŸ¥ï¼Œè¯´æ˜æ­¤æ—¶å¯èƒ½(å› ä¸ºé€šè¿‡è´Ÿè½½å¹¶ä¸çŸ¥é“è¯¥è¯·æ±‚æ˜¯è½åœ¨äº†å“ªä¸€ä¸ªNacosèŠ‚ç‚¹)é›†ç¾¤ä¸­æŸä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœæ•°æ®ä¸æ­£å¸¸äº†ï¼Œä½†æ˜¯åœ¨æ£€æµ‹è„šæœ¬ä¸­ä¼šé€šè¿‡æ¯ä¸ªèŠ‚ç‚¹å»æ³¨å†Œï¼Œé‚£ä¹ˆä¸€å®šä¼šåœ¨å‡ºç°é€šçŸ¥æŸä¸ªèŠ‚ç‚¹æ•…éšœã€‚4. åœ¨publicç¯å¢ƒä¸­é€šè¿‡è°ƒç”¨OpenApiæ–¹å¼åˆ›å»ºã€æ³¨å†Œä¸€ä¸ªå®ä¾‹ test_service_instance è·ŸæœåŠ¡ï¼Œç„¶åæ³¨é”€å®ä¾‹ï¼Œå¹¶åˆ é™¤æœåŠ¡ï¼Œè¿™æ˜¯ä¸ºäº†ç›‘æµ‹é›†ç¾¤æ˜¯å¦æ­£å¸¸ã€‚ ä¸‰ã€å°è®° è™½ç„¶æ–‡æ¡£ç»™å‡ºçš„æè¿°æ˜¯åªæœ‰å½“æœåŠ¡ä¸‹å®ä¾‹æ•°ä¸º0æ—¶å…è®¸åˆ é™¤ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶æ²¡æœ‰å¼ºåˆ¶æ£€æŸ¥æ ¡éªŒæœåŠ¡ä¸‹çš„å®ä¾‹æ•°æ˜¯å¦ä¸º0ã€‚Nacosçš„æœåŠ¡åˆ›å»ºæœ‰å¤šç§æ–¹å¼ï¼Œå¯ä»¥ä¸»åŠ¨åˆ›å»ºå¯ä»¥åœ¨æ³¨å†Œå®ä¾‹çš„æ—¶å€™åˆ›å»ºï¼Œå¯ä»¥åœ¨å®ä¾‹å‘é€å¿ƒè·³æ—¶åˆ›å»ºï¼Œæ‰€ä»¥å“ªæ€•ä¸»åŠ¨åˆ é™¤äº†è¿˜ä¼šè‡ªåŠ¨åˆ›å»ºå›æ¥ã€‚ï¼› æ‰€æœ‰å·²æ³¨å†ŒæœåŠ¡åœ¨å®¹å™¨é‡å¯åä¼šä¸¢å¤±ï¼Œä½†æ˜¯åªè¦ä¿è¯é›†ç¾¤ä¸­æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ­£å¸¸ï¼Œé‚£ä¹ˆé‡å¯åçš„æœåŠ¡æ•°æ®ä¼šåŒæ­¥å…¶ä»–æ­£å¸¸èŠ‚ç‚¹çš„ï¼Œå³éœ€è¦å®¢æˆ·ç«¯é‡æ–°æ³¨å†Œï¼› æ­£å¸¸æƒ…å†µåœ¨æŸä¸ªèŠ‚ç‚¹æ³¨å†Œäº†æœåŠ¡åä¼šåŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ å„èŠ‚ç‚¹æ— æ³•é€‰ä¸¾ä¸€ä¸ªleaderæ—¶ æŸ¥çœ‹æ—¥å¿—ï¼š/data/nacos2.0.2_1/logs/alipay-jraft.log å®ä¾‹æœåŠ¡ç›¸å…³æ—¥å¿—: /data/nacos2.0.2_1/naming-raft.log é€šè¿‡æ—¥å¿—å‘ç°ï¼Œæš´éœ²8848ç«¯å£æ˜¯ä¸ºäº†nacoså®¢æˆ·ç«¯ç™»é™†è·å–Tokenï¼Œåç»­æ“ä½œéƒ½ä¼šæºå¸¦Tokenè¿›è¡Œèµ„æºæ“ä½œï¼›ç„¶åæš´éœ²9848ç«¯å£æ˜¯å®¢æˆ·ç«¯ç”¨äºgRPCçš„è¯·æ±‚ï¼Œæ‰€ä»¥å¦‚æœæ˜¯è®¾ç½®äº†ä»£ç†è½¬å‘ï¼ŒåŠ¡å¿…å°†å…¶æš´éœ²ï¼Œå¦åˆ™è¿æ¥å¤±è´¥å¤±è´¥ã€‚ å››ã€åæ§½Nacos å®˜æ–¹ä¸ºäº†æ¨å•†ä¸šç‰ˆï¼Œç¤¾åŒºç‰ˆå‡ ä¹æ¯›ç—…ç™¾å‡ºï¼Œä¸ç®¡ä¸é¡¾ï¼Œæ–‡æ¡£ä¹Ÿæ˜¯å†™å¾—ä¸€å›¢ç³Ÿ~ æ— åŠ›åæ§½","categories":[{"name":"åŸºç¡€ç»„ä»¶","slug":"åŸºç¡€ç»„ä»¶","permalink":"https://blog.sctux.cc/categories/%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/"},{"name":"éƒ¨ç½²","slug":"åŸºç¡€ç»„ä»¶/éƒ¨ç½²","permalink":"https://blog.sctux.cc/categories/%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/%E9%83%A8%E7%BD%B2/"}],"tags":[{"name":"nacos","slug":"nacos","permalink":"https://blog.sctux.cc/tags/nacos/"}],"keywords":[{"name":"åŸºç¡€ç»„ä»¶","slug":"åŸºç¡€ç»„ä»¶","permalink":"https://blog.sctux.cc/categories/%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/"},{"name":"éƒ¨ç½²","slug":"åŸºç¡€ç»„ä»¶/éƒ¨ç½²","permalink":"https://blog.sctux.cc/categories/%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/%E9%83%A8%E7%BD%B2/"}]},{"title":"è¿ç»´å·¥ä½œä¸­è‡ªåŠ¨åŒ–å·¡æ£€çš„å¿…è¦æ€§ä»¥åŠé‡è¦æ€§","slug":"è‡ªåŠ¨åŒ–å·¡æ£€çš„å¿…è¦æ€§ä»¥åŠé‡è¦æ€§","date":"2022-05-12T02:42:13.000Z","updated":"2025-09-01T01:59:08.876Z","comments":true,"path":"2022/05/12/è‡ªåŠ¨åŒ–å·¡æ£€çš„å¿…è¦æ€§ä»¥åŠé‡è¦æ€§/","permalink":"https://blog.sctux.cc/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/","excerpt":"ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€ å½“å‰å¹³å°æ¶æ„å¤æ‚ï¼Œä¸­é—´ä»¶ç¹å¤šï¼Œç»„ä»¶ä¹‹é—´è€¦åˆåº¦é«˜ï¼Œå¾®æœåŠ¡è¿˜æœªè¾¾åˆ°æ•…éšœè‡ªæ„ˆæ°´å¹³ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å‘Šè­¦æˆ–å·¡æ£€ç­‰æ‰‹æ®µå‘ç°é—®é¢˜æ¥ä¿éšœå¹³å°æŒç»­ç¨³å®šè¿è¡Œã€‚ å½“å‰æœ‰å®¢æˆ·å¯¹å¹³å°åŠä¸Šå±‚åº”ç”¨ä½¿ç”¨é¢‘ç‡ä½ï¼Œä¾‹å¦‚ä¸‰å››å¤©ç™»å½•æŸ¥çœ‹ä¸€æ¬¡æ•°æ®ï¼Œä½†æ˜¯è®¾å¤‡æ˜¯æ­£å¸¸è¿è½¬çš„ï¼Œä¸€æ—¦å¹³å°å‡ºç°é—®é¢˜ï¼Œåˆšå¥½å®¢æˆ·å‘ç°é—®é¢˜ï¼Œè¿ç»´ æ‰å»è§£å†³å°±ä¸ºæ—¶å·²æ™šã€‚ å®šæœŸå·¡æ£€æ–¹æ¡ˆæ˜¯æ¨¡æ‹Ÿäººå·¥ç™»å½•å„ä¸šåŠ¡é¡µé¢ï¼Œè€Œéæ¥å£è°ƒç”¨ï¼Œæ›´èƒ½çœŸå®åœ°å‘ç°é—®é¢˜ï¼Œå¹¶é€šè¿‡æˆªå›¾çœŸå®ä¿ç•™å¹³å°è¿è¡ŒçŠ¶æ€ã€‚ Prometheuså¹³å°çš„ç›‘æ§æŠ¥è­¦åŠŸèƒ½è¿˜æœªè¦†ç›–åˆ°æ•´ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œéƒ¨åˆ†é—®é¢˜è¿˜æœªèƒ½å®æ—¶ç›‘æ§åˆ°ï¼Œå¯¼è‡´å¹³å°å‡ºç°å¼‚å¸¸åè€Œæ— æ³•æ„ŸçŸ¥ã€‚ å½“å‰å¹¶ä¸èƒ½ä¿è¯å®¢æˆ·ç¯å¢ƒçš„Prometheuså¹³å°æœ¬èº«ä¸å­˜åœ¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ç§ä¸ç¡®å®šæ€§ï¼Œå®šæœŸå·¡æ£€æ˜¯ä¸€ä¸ªä¿éšœå¹³å°ç¨³å®šæ€§çš„æ–¹æ¡ˆï¼Œå®ç°å¹³å°åŒä¿éšœã€‚ éƒ¨åˆ†å®¢æˆ·ç¯å¢ƒä¸èƒ½å¤Ÿè¿æ¥å¤–ç½‘ï¼ŒPrometheusçš„ç›‘æ§å‘Šè­¦ä¿¡æ¯æ— æ³•åŒæ­¥åˆ°å¾®ä¿¡ã€é£ä¹¦ç­‰ï¼Œä½†å¯ä»¥é€šè¿‡å®šæœŸå·¡æ£€æ–¹æ¡ˆæ¥ä¿éšœå¹³å°ç¨³å®šè¿è¡Œã€‚ ç”±äºä»¥ä¸ŠåŸå› ï¼Œä¸ºäº†ä¿è¯SLAï¼Œå¿…é¡»è¿›è¡Œå®šæœŸå·¡æ£€ã€‚ äºŒã€å·¡æ£€æ£€æŸ¥é¡¹2.1 æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯ cpu åˆ©ç”¨ç‡ ç£ç›˜åˆ©ç”¨ç‡ å†…å­˜åˆ©ç”¨ç‡ æœåŠ¡å™¨æ—¶é—´åŒæ­¥ æ—¥å¸¸æ•°æ®å¤‡ä»½æ–‡ä»¶æ£€æŸ¥ 2.2 k8sé›†ç¾¤çŠ¶æ€ è¯ä¹¦è¿‡æœŸæ£€æŸ¥ APIé€šä¿¡æ˜¯å¦æ­£å¸¸ å„åç§°ç©ºé—´ä¸‹çš„podè¿è¡ŒçŠ¶æ€ cephå…±äº«å­˜å‚¨æ˜¯å¦æ­£å¸¸ 2.3 ä¸šåŠ¡çŠ¶æ€ ä¸šåŠ¡å¹³å°ç™»å½•æ˜¯å¦æ­£å¸¸ kafkaæ˜¯å¦ç§¯å‹ kafkaæ¶ˆè´¹é€Ÿç‡","text":"ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€ å½“å‰å¹³å°æ¶æ„å¤æ‚ï¼Œä¸­é—´ä»¶ç¹å¤šï¼Œç»„ä»¶ä¹‹é—´è€¦åˆåº¦é«˜ï¼Œå¾®æœåŠ¡è¿˜æœªè¾¾åˆ°æ•…éšœè‡ªæ„ˆæ°´å¹³ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å‘Šè­¦æˆ–å·¡æ£€ç­‰æ‰‹æ®µå‘ç°é—®é¢˜æ¥ä¿éšœå¹³å°æŒç»­ç¨³å®šè¿è¡Œã€‚ å½“å‰æœ‰å®¢æˆ·å¯¹å¹³å°åŠä¸Šå±‚åº”ç”¨ä½¿ç”¨é¢‘ç‡ä½ï¼Œä¾‹å¦‚ä¸‰å››å¤©ç™»å½•æŸ¥çœ‹ä¸€æ¬¡æ•°æ®ï¼Œä½†æ˜¯è®¾å¤‡æ˜¯æ­£å¸¸è¿è½¬çš„ï¼Œä¸€æ—¦å¹³å°å‡ºç°é—®é¢˜ï¼Œåˆšå¥½å®¢æˆ·å‘ç°é—®é¢˜ï¼Œè¿ç»´ æ‰å»è§£å†³å°±ä¸ºæ—¶å·²æ™šã€‚ å®šæœŸå·¡æ£€æ–¹æ¡ˆæ˜¯æ¨¡æ‹Ÿäººå·¥ç™»å½•å„ä¸šåŠ¡é¡µé¢ï¼Œè€Œéæ¥å£è°ƒç”¨ï¼Œæ›´èƒ½çœŸå®åœ°å‘ç°é—®é¢˜ï¼Œå¹¶é€šè¿‡æˆªå›¾çœŸå®ä¿ç•™å¹³å°è¿è¡ŒçŠ¶æ€ã€‚ Prometheuså¹³å°çš„ç›‘æ§æŠ¥è­¦åŠŸèƒ½è¿˜æœªè¦†ç›–åˆ°æ•´ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œéƒ¨åˆ†é—®é¢˜è¿˜æœªèƒ½å®æ—¶ç›‘æ§åˆ°ï¼Œå¯¼è‡´å¹³å°å‡ºç°å¼‚å¸¸åè€Œæ— æ³•æ„ŸçŸ¥ã€‚ å½“å‰å¹¶ä¸èƒ½ä¿è¯å®¢æˆ·ç¯å¢ƒçš„Prometheuså¹³å°æœ¬èº«ä¸å­˜åœ¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ç§ä¸ç¡®å®šæ€§ï¼Œå®šæœŸå·¡æ£€æ˜¯ä¸€ä¸ªä¿éšœå¹³å°ç¨³å®šæ€§çš„æ–¹æ¡ˆï¼Œå®ç°å¹³å°åŒä¿éšœã€‚ éƒ¨åˆ†å®¢æˆ·ç¯å¢ƒä¸èƒ½å¤Ÿè¿æ¥å¤–ç½‘ï¼ŒPrometheusçš„ç›‘æ§å‘Šè­¦ä¿¡æ¯æ— æ³•åŒæ­¥åˆ°å¾®ä¿¡ã€é£ä¹¦ç­‰ï¼Œä½†å¯ä»¥é€šè¿‡å®šæœŸå·¡æ£€æ–¹æ¡ˆæ¥ä¿éšœå¹³å°ç¨³å®šè¿è¡Œã€‚ ç”±äºä»¥ä¸ŠåŸå› ï¼Œä¸ºäº†ä¿è¯SLAï¼Œå¿…é¡»è¿›è¡Œå®šæœŸå·¡æ£€ã€‚ äºŒã€å·¡æ£€æ£€æŸ¥é¡¹2.1 æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯ cpu åˆ©ç”¨ç‡ ç£ç›˜åˆ©ç”¨ç‡ å†…å­˜åˆ©ç”¨ç‡ æœåŠ¡å™¨æ—¶é—´åŒæ­¥ æ—¥å¸¸æ•°æ®å¤‡ä»½æ–‡ä»¶æ£€æŸ¥ 2.2 k8sé›†ç¾¤çŠ¶æ€ è¯ä¹¦è¿‡æœŸæ£€æŸ¥ APIé€šä¿¡æ˜¯å¦æ­£å¸¸ å„åç§°ç©ºé—´ä¸‹çš„podè¿è¡ŒçŠ¶æ€ cephå…±äº«å­˜å‚¨æ˜¯å¦æ­£å¸¸ 2.3 ä¸šåŠ¡çŠ¶æ€ ä¸šåŠ¡å¹³å°ç™»å½•æ˜¯å¦æ­£å¸¸ kafkaæ˜¯å¦ç§¯å‹ kafkaæ¶ˆè´¹é€Ÿç‡ ä¸‰ã€å®ç°æ–¹å¼å‰æœŸï¼šå‰æœŸå·¡æ£€åŒäº‹ç™»å½•å„å®¢æˆ·ç¯å¢ƒè¿›è¡Œäººå·¥æ‰‹åŠ¨å·¡æ£€(ç™»å½•VPNã€è¿æ¥è·³æ¿æœºã€ç™»å½•ä¸šåŠ¡å¹³å°ã€ç™»å½•grafanaå¹³å°ç­‰ç­‰)ä¸€äº›åˆ—æ“ä½œä¸‹æ¥ï¼Œä¸€è½®å·¡æ£€å·¥ä½œå¤§çº¦åœ¨2-3hoursã€‚ ç›®å‰ï¼šé€šè¿‡è‡ªåŠ¨åŒ–çš„æ–¹å¼(shell+python+webæ¡†æ¶flask)å®ç°äº†ï¼Œäººå·¥åœ¨windowsè·³æ¿æœºä¸Šã€LinuxæœåŠ¡å™¨ä¸­çš„æ¨¡æ‹Ÿäººå·¥æ“ä½œè¿æ¥VPNã€ç™»å½•ä¸šåŠ¡å¹³å°ã€ç™»å½•grafanaå¹³å°ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œå®šæœŸå®šæ—¶å°†å·¡æ£€ä»»åŠ¡ç»“æœå‘é€è‡³ä¼ä¸šå¾®ä¿¡ç¾¤å†…ï¼›ä»å•äººå•æ¬¡å·¡æ£€çš„2-3å°æ—¶ï¼Œç›´æ¥ææ•ˆåˆ°äº†5-10minï¼Œæå¤§ç¨‹åº¦ä¸Šæé«˜äº†æ—¥å¸¸å·¡æ£€çš„å·¥ä½œæ•ˆç‡ã€‚ é‚£ä¹ˆï¼Œåœ¨å®¢æˆ·ç¯å¢ƒæ•°é‡è¾¾åˆ°ä¸€å®šä½“é‡æ—¶ï¼Œç¾¤æ¶ˆæ¯æ¥æ”¶ä¹Ÿä¼šé€ æˆå·¡æ£€é—æ¼çš„æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹éœ€è¦ä¸€ä¸ªé›†ä¸­åŒ–çš„å¹³å°ä½œä¸ºå±•ç¤ºï¼Œäºæ˜¯å°†å·¡æ£€ç»“æœå‘é€åˆ°ç¾¤å†…çš„åŒæ—¶ä¹Ÿä¼šå°†æ¶ˆæ¯æ ¼å¼åŒ–(æ³¨ï¼šå›¾ç‰‡æ˜¯é€šè¿‡Pythonæˆªå›¾ç”Ÿæˆåå°†å…¶è½¬æ¢ä¸ºbase64ç¼–ç ï¼Œç„¶åå°†å…¶ä»–å·¡æ£€ç»“æœå†…å®¹æ ¼å¼åŒ–ä¸ºjsonåpoståˆ°webåç«¯ï¼Œå†åœ¨webå‰ç«¯è¿›è¡Œå±•ç¤º) Detail: é€šè¿‡ç‚¹å‡»åå¼¹å‡ºæ•´ä¸ªå·¡æ£€è¿‡ç¨‹ä»¥åŠç»“æœä¿¡æ¯ï¼› Screenshoot: é€šè¿‡ç‚¹å‡»åå°†ä¼šå¼¹å‡ºbase64ç¼–ç è½¬æ¢ä¸ºå›¾ç‰‡çš„ä¸šåŠ¡å¹³å°åŠgrafanaæˆªå›¾ æœ€åï¼Œå·¡æ£€äººå‘˜åªéœ€è¦å®šæœŸæµè§ˆæ­¤æ±‡æ€»å±•ç¤ºå¹³å°å³å¯ï¼ (äººå·¥æ“ä½œæ˜¯åŸºç¡€ï¼Œè‡ªåŠ¨åŒ–æ“ä½œæ‰æ˜¯ç‹é“ğŸ˜€ ) æŠ€æœ¯ç‚¹ Pythonè‡ªåŠ¨åŒ– Seleniumçˆ¬è™«æŠ€æœ¯(ç½‘é¡µå†…å®¹è·å–) Windowsç«¯UIè‡ªåŠ¨åŒ–(ç”¨äºè‡ªåŠ¨å¯åŠ¨VPNç¨‹åºï¼Œå¹¶å¡«å†™è´¦å·å¯†ç åè¿›è¡Œç™»å½•æ“ä½œ) Flaskå‰åç«¯å¼€å‘(å¹³å°å±•ç¤ºï¼Œå†…å®¹æ¥æ”¶å…¥åº“) ä¼ä¸šå¾®ä¿¡æœºå™¨äººWebhooké›†æˆ","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"},{"name":"Python","slug":"Python","permalink":"https://blog.sctux.cc/tags/Python/"},{"name":"Flask","slug":"Flask","permalink":"https://blog.sctux.cc/tags/Flask/"}],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"å¦‚ä½•è®©æ·»åŠ å®šæ—¶ä½œä¸šä»»åŠ¡å˜å¾—æ›´åŠ ä¼˜é›…","slug":"Flaskç»“åˆAPSchedulerå®ç°å®šæ—¶ä»»åŠ¡æ¡†æ¶å¹³å°","date":"2019-03-19T06:32:01.000Z","updated":"2025-09-01T01:59:08.973Z","comments":true,"path":"2019/03/19/Flaskç»“åˆAPSchedulerå®ç°å®šæ—¶ä»»åŠ¡æ¡†æ¶å¹³å°/","permalink":"https://blog.sctux.cc/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/","excerpt":"åº APSCheduler ç®€ä»‹åœ¨å¹³å¸¸çš„å·¥ä½œä¸­æœ‰äº›å·¥ä½œéƒ½éœ€è¦å®šæ—¶ä»»åŠ¡æ¥æ¨åŠ¨ï¼Œä¾‹å¦‚é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªå®šæ—¶åˆ·æ–°æ’è¡Œæ¦œçš„ç¨‹åºè„šæœ¬ã€å®šæ—¶çˆ¬å‡ºç½‘ç«™çš„URLç¨‹åºã€å®šæ—¶æ£€æµ‹é’“é±¼ç½‘ç«™çš„ç¨‹åºç­‰ç­‰ï¼Œéƒ½æ¶‰åŠåˆ°äº†å…³äºå®šæ—¶ä»»åŠ¡çš„é—®é¢˜ï¼›è™½ç„¶è¿™äº›å®šæ—¶ä»»åŠ¡åœ¨æœåŠ¡å™¨ä¸Šé¢éƒ½èƒ½é€šè¿‡crontabæ¥åšï¼›å…¶æ¬¡æƒ³åˆ°çš„æ˜¯åˆ©ç”¨timeæ¨¡å—çš„time.sleep()æ–¹æ³•ä½¿ç¨‹åºä¼‘çœ æ¥è¾¾åˆ°å®šæ—¶ä»»åŠ¡çš„ç›®çš„ï¼Œè™½ç„¶å‰ä¸¤è€…ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æ€»è§‰å¾—ä¸æ˜¯é‚£ä¹ˆçš„ä¸“ä¸šï¼ŒğŸ˜æ‰€ä»¥å°±æ‰¾åˆ°äº†pythonçš„å®šæ—¶ä»»åŠ¡æ¨¡å—APScheduler; APScheduleråŸºäºQuartzçš„ä¸€ä¸ªPythonå®šæ—¶ä»»åŠ¡æ¡†æ¶ï¼Œå®ç°äº†Quartzçš„æ‰€æœ‰åŠŸèƒ½ï¼Œä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ã€‚æä¾›äº†åŸºäºæ—¥æœŸã€å›ºå®šæ—¶é—´é—´éš”ä»¥åŠcrontabç±»å‹çš„ä»»åŠ¡ï¼Œå¹¶ä¸”å¯ä»¥æŒä¹…åŒ–ä»»åŠ¡ã€‚åŸºäºè¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ä¸€ä¸ªpythonå®šæ—¶ä»»åŠ¡ç³»ç»Ÿã€‚ åŒæ—¶APSchedulerè¿˜æä¾›äº†Flaskçš„æ‰©å±•Flask-Apscheduler, é‚£æ­£å¥½å°±å¯ä»¥æ‹¿æ¥åšä¸€ä¸ªé›†æˆå®šæ—¶ä»»åŠ¡å¹³å°; APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ† è§¦å‘å™¨(trigger)åŒ…å«è°ƒåº¦é€»è¾‘ï¼Œæ¯ä¸€ä¸ªä½œä¸šæœ‰å®ƒè‡ªå·±çš„è§¦å‘å™¨ï¼Œç”¨äºå†³å®šæ¥ä¸‹æ¥å“ªä¸€ä¸ªä½œä¸šä¼šè¿è¡Œã€‚é™¤äº†ä»–ä»¬è‡ªå·±åˆå§‹é…ç½®æ„å¤–ï¼Œè§¦å‘å™¨å®Œå…¨æ˜¯æ— çŠ¶æ€çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738cron: ç±»linuxä¸‹çš„crontabæ ¼å¼,å±äºå®šæ—¶è°ƒåº¦interval:æ¯éš”å¤šä¹…è°ƒåº¦ä¸€æ¬¡date:ä¸€æ¬¡æ€§è°ƒåº¦#1. croné£æ ¼(int|str) è¡¨ç¤ºå‚æ•°æ—¢å¯ä»¥æ˜¯intç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯strç±»å‹(datetime | str) è¡¨ç¤ºå‚æ•°æ—¢å¯ä»¥æ˜¯datetimeç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯strç±»å‹year (int|str) â€“ 4-digit year -ï¼ˆè¡¨ç¤ºå››ä½æ•°çš„å¹´ä»½ï¼Œå¦‚2008å¹´ï¼‰month (int|str) â€“ month (1-12) -ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º1-12æœˆï¼‰day (int|str) â€“ day of the (1-31) -ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º1-31æ—¥ï¼‰week (int|str) â€“ ISO week (1-53) -ï¼ˆæ ¼é‡Œå†2006å¹´12æœˆ31æ—¥å¯ä»¥å†™æˆ2006å¹´-W52-7ï¼ˆæ‰©å±•å½¢å¼ï¼‰æˆ–2006W527ï¼ˆç´§å‡‘å½¢å¼ï¼‰ï¼‰day_of_week (int|str) â€“ number or name of weekday (0-6 or mon,tue,wed,thu,fri,sat,sun) - ï¼ˆè¡¨ç¤ºä¸€å‘¨ä¸­çš„ç¬¬å‡ å¤©ï¼Œæ—¢å¯ä»¥ç”¨0-6è¡¨ç¤ºä¹Ÿå¯ä»¥ç”¨å…¶è‹±è¯­ç¼©å†™è¡¨ç¤ºï¼‰hour (int|str) â€“ hour (0-23) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º0-23æ—¶ï¼‰minute (int|str) â€“ minute (0-59) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º0-59åˆ†ï¼‰second (int|str) â€“ second (0-59) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º0-59ç§’ï¼‰start_date (datetime|str) â€“ earliest possible date/time to trigger on (inclusive) - ï¼ˆè¡¨ç¤ºå¼€å§‹æ—¶é—´ï¼‰end_date (datetime|str) â€“ latest possible date/time to trigger on (inclusive) - ï¼ˆè¡¨ç¤ºç»“æŸæ—¶é—´ï¼‰timezone (datetime.tzinfo|str) â€“ time zone to use for the date/time calculations (defaults to scheduler timezone) -ï¼ˆè¡¨ç¤ºæ—¶åŒºå–å€¼ï¼‰#å¦‚:åœ¨6,7,8,11,12æœˆä»½çš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”çš„00:00,01:00,02:00,03:00 æ‰§è¡Œè¯¥ç¨‹åºsched.add_job(my_job, 'cron', month='6-8,11-12', day='3rd fri', hour='0-3')#2.intervalé£æ ¼weeks (int) â€“ number of weeks to waitdays (int) â€“ number of days to waithours (int) â€“ number of hours to waitminutes (int) â€“ number of minutes to waitseconds (int) â€“ number of seconds to waitstart_date (datetime|str) â€“ starting point for the interval calculationend_date (datetime|str) â€“ latest possible date/time to trigger ontimezone (datetime.tzinfo|str) â€“ time zone to use for the date/time calculations#å¦‚:æ¯éš”2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡scheduler.add_job(myfunc, 'interval', minutes=2)#3.dateé£æ ¼run_date (datetime|str) â€“ the date/time to run the job at -ï¼ˆä»»åŠ¡å¼€å§‹çš„æ—¶é—´ï¼‰timezone (datetime.tzinfo|str) â€“ time zone for run_date if it doesnâ€™t have one already#å¦‚:åœ¨2009å¹´11æœˆ6å·16æ—¶30åˆ†5ç§’æ—¶æ‰§è¡Œsched.add_job(my_job, 'date', run_date=datetime(2009, 11, 6, 16, 30, 5), args=['text']) ä½œä¸šå­˜å‚¨(job store)å­˜å‚¨è¢«è°ƒåº¦çš„ä½œä¸šï¼Œé»˜è®¤çš„ä½œä¸šå­˜å‚¨æ˜¯ç®€å•åœ°æŠŠä½œä¸šä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå…¶ä»–çš„ä½œä¸šå­˜å‚¨æ˜¯å°†ä½œä¸šä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚ä¸€ä¸ªä½œä¸šçš„æ•°æ®è®²åœ¨ä¿å­˜åœ¨æŒä¹…åŒ–ä½œä¸šå­˜å‚¨æ—¶è¢«åºåˆ—åŒ–ï¼Œå¹¶åœ¨åŠ è½½æ—¶è¢«ååºåˆ—åŒ–ã€‚è°ƒåº¦å™¨ä¸èƒ½åˆ†äº«åŒä¸€ä¸ªä½œä¸šå­˜å‚¨ã€‚ jobstoreåˆ™æ˜¯æŒ‡çš„æ˜¯jobæŒä¹…åŒ–,é»˜è®¤jobè¿è¡Œåœ¨å†…å­˜ä¸­,å¯æŒä¹…åŒ–åœ¨æ•°æ®åº“,æŒ‡å®šä¸ºmongoçš„MongoDBJobStoreæˆ–è€…æ˜¯ä½¿ç”¨sqliteçš„SQLAlchemyJobStore,åŒæ—¶å¯æŒ‡å®šå¤šç§jobstore æ‰§è¡Œå™¨(executor)å¤„ç†ä½œä¸šçš„è¿è¡Œï¼Œä»–ä»¬é€šå¸¸é€šè¿‡åœ¨ä½œä¸šä¸­æäº¤åˆ¶å®šçš„å¯è°ƒç”¨å¯¹è±¡åˆ°ä¸€ä¸ªçº¿ç¨‹æˆ–è€…è¿›åŸæ± æ¥è¿›è¡Œã€‚å½“ä½œä¸šå®Œæˆæ—¶ï¼Œæ‰§è¡Œå™¨å°†ä¼šé€šçŸ¥è°ƒåº¦å™¨ã€‚ è¯´ç™½äº†å°±æ˜¯æŒ‡å®šä»»åŠ¡æ˜¯ä»¥çº¿ç¨‹æ± /è¿›ç¨‹æ± é‡Œè¿è¡Œ,è¿™åœ¨åˆå§‹åŒ–æ—¶å¯ä»¥æŒ‡å®š,åŒæ—¶å¯ä»¥æŒ‡å®šæœ€å¤§çš„å·¥ä½œæ± ,é»˜è®¤çš„ä¸ºdefault: ThreadPoolExecutor,max-workerä¸º20,å½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šä¸ºprocesspool,é»˜è®¤max-workerä¸º5 è°ƒåº¦å™¨(scheduler)æ˜¯å…¶ä»–çš„ç»„æˆéƒ¨åˆ†ã€‚ä½ é€šå¸¸åœ¨åº”ç”¨åªæœ‰ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œåº”ç”¨çš„å¼€å‘è€…é€šå¸¸ä¸ä¼šç›´æ¥å¤„ç†ä½œä¸šå­˜å‚¨ã€è°ƒåº¦å™¨å’Œè§¦å‘å™¨ï¼Œç›¸åï¼Œè°ƒåº¦å™¨æä¾›äº†å¤„ç†è¿™äº›çš„åˆé€‚çš„æ¥å£ã€‚é…ç½®ä½œä¸šå­˜å‚¨å’Œæ‰§è¡Œå™¨å¯ä»¥åœ¨è°ƒåº¦å™¨ä¸­å®Œæˆï¼Œä¾‹å¦‚æ·»åŠ ã€ä¿®æ”¹å’Œç§»é™¤ä½œä¸šã€‚è°ƒåº¦å™¨åˆ†ä¸ºä»¥ä¸‹å‡ ç§,å¯æ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯é€‰ç”¨ä¸åŒçš„è°ƒåº¦å™¨: 1234567BlockingScheduler: å¾ˆæ˜æ˜¾è¿™æ˜¯ç§é˜»å¡å‹,ä¸€èˆ¬ç”¨åœ¨æ²¡æœ‰å…¶å®ƒè¿›ç¨‹è¿è¡Œçš„åœºæ™¯ä¸‹BackGroundScheduler: åå°å¼,ä¹Ÿå°±æ˜¯å•èµ·ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹è¿è¡Œè¯¥ä»»åŠ¡,ä¸å½±å“ä¸»ç¨‹åºASyncIOScheduler:GeventScheduler:TornadoScheduler:TwistedScheduler:QtScheduler: æœ¬äººåªä½¿ç”¨è¿‡BlockingSchedulerè·ŸBackGroundScheduler,flask-schedulerä½¿ç”¨çš„å³ä¸ºBackGroundScheduler,å…¶å®ƒçš„åç»­å†ç ”ç©¶ç ”ç©¶ é€‰æ‹©ç±»å‹ä¹Ÿå¾ˆç®€å•,åˆå§‹åŒ–æ—¶ç›´æ¥å®ä¾‹åŒ–: 1234from apscheduler.schedulers.background import BackgroundSchedulerscheduler = BackgroundScheduler()#å¯åŠ¨scheduler.start() ä»¥ä¸Šå°±æ˜¯apschedulerä¸»è¦ç»„æˆçš„å››ä¸ªæ–¹é¢ã€‚é‚£ä¹ˆæ—¢ç„¶æœ‰æä¾›flask-apschedulerè¿™ä¸ªæ‰©å±•ï¼Œé‚£ä¸€å®šæ˜¯æŠŠapschedulerå°è£…è¿‡åä¸ºæˆ‘ä»¬æä¾›æ›´åŠ æ–¹ä¾¿çš„é›†æˆå¼€å‘ï¼Œè¿™é‡Œæˆ‘çš„å­˜å‚¨é€‰æ‹©äº†MySQLä½œä¸ºä½œä¸šä»»åŠ¡å­˜å‚¨ï¼Œå› ä¸ºæˆ‘è¿™é‡Œçš„å¹³å°çš„ç”¨æˆ·æ˜¯ç”¨å®ƒæ¥å­˜å‚¨çš„ï¼›ä¸ºäº†æ–¹ä¾¿ç»Ÿä¸€ä½¿ç”¨äº†MySQL;","text":"åº APSCheduler ç®€ä»‹åœ¨å¹³å¸¸çš„å·¥ä½œä¸­æœ‰äº›å·¥ä½œéƒ½éœ€è¦å®šæ—¶ä»»åŠ¡æ¥æ¨åŠ¨ï¼Œä¾‹å¦‚é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªå®šæ—¶åˆ·æ–°æ’è¡Œæ¦œçš„ç¨‹åºè„šæœ¬ã€å®šæ—¶çˆ¬å‡ºç½‘ç«™çš„URLç¨‹åºã€å®šæ—¶æ£€æµ‹é’“é±¼ç½‘ç«™çš„ç¨‹åºç­‰ç­‰ï¼Œéƒ½æ¶‰åŠåˆ°äº†å…³äºå®šæ—¶ä»»åŠ¡çš„é—®é¢˜ï¼›è™½ç„¶è¿™äº›å®šæ—¶ä»»åŠ¡åœ¨æœåŠ¡å™¨ä¸Šé¢éƒ½èƒ½é€šè¿‡crontabæ¥åšï¼›å…¶æ¬¡æƒ³åˆ°çš„æ˜¯åˆ©ç”¨timeæ¨¡å—çš„time.sleep()æ–¹æ³•ä½¿ç¨‹åºä¼‘çœ æ¥è¾¾åˆ°å®šæ—¶ä»»åŠ¡çš„ç›®çš„ï¼Œè™½ç„¶å‰ä¸¤è€…ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æ€»è§‰å¾—ä¸æ˜¯é‚£ä¹ˆçš„ä¸“ä¸šï¼ŒğŸ˜æ‰€ä»¥å°±æ‰¾åˆ°äº†pythonçš„å®šæ—¶ä»»åŠ¡æ¨¡å—APScheduler; APScheduleråŸºäºQuartzçš„ä¸€ä¸ªPythonå®šæ—¶ä»»åŠ¡æ¡†æ¶ï¼Œå®ç°äº†Quartzçš„æ‰€æœ‰åŠŸèƒ½ï¼Œä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ã€‚æä¾›äº†åŸºäºæ—¥æœŸã€å›ºå®šæ—¶é—´é—´éš”ä»¥åŠcrontabç±»å‹çš„ä»»åŠ¡ï¼Œå¹¶ä¸”å¯ä»¥æŒä¹…åŒ–ä»»åŠ¡ã€‚åŸºäºè¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ä¸€ä¸ªpythonå®šæ—¶ä»»åŠ¡ç³»ç»Ÿã€‚ åŒæ—¶APSchedulerè¿˜æä¾›äº†Flaskçš„æ‰©å±•Flask-Apscheduler, é‚£æ­£å¥½å°±å¯ä»¥æ‹¿æ¥åšä¸€ä¸ªé›†æˆå®šæ—¶ä»»åŠ¡å¹³å°; APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ† è§¦å‘å™¨(trigger)åŒ…å«è°ƒåº¦é€»è¾‘ï¼Œæ¯ä¸€ä¸ªä½œä¸šæœ‰å®ƒè‡ªå·±çš„è§¦å‘å™¨ï¼Œç”¨äºå†³å®šæ¥ä¸‹æ¥å“ªä¸€ä¸ªä½œä¸šä¼šè¿è¡Œã€‚é™¤äº†ä»–ä»¬è‡ªå·±åˆå§‹é…ç½®æ„å¤–ï¼Œè§¦å‘å™¨å®Œå…¨æ˜¯æ— çŠ¶æ€çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738cron: ç±»linuxä¸‹çš„crontabæ ¼å¼,å±äºå®šæ—¶è°ƒåº¦interval:æ¯éš”å¤šä¹…è°ƒåº¦ä¸€æ¬¡date:ä¸€æ¬¡æ€§è°ƒåº¦#1. croné£æ ¼(int|str) è¡¨ç¤ºå‚æ•°æ—¢å¯ä»¥æ˜¯intç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯strç±»å‹(datetime | str) è¡¨ç¤ºå‚æ•°æ—¢å¯ä»¥æ˜¯datetimeç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯strç±»å‹year (int|str) â€“ 4-digit year -ï¼ˆè¡¨ç¤ºå››ä½æ•°çš„å¹´ä»½ï¼Œå¦‚2008å¹´ï¼‰month (int|str) â€“ month (1-12) -ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º1-12æœˆï¼‰day (int|str) â€“ day of the (1-31) -ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º1-31æ—¥ï¼‰week (int|str) â€“ ISO week (1-53) -ï¼ˆæ ¼é‡Œå†2006å¹´12æœˆ31æ—¥å¯ä»¥å†™æˆ2006å¹´-W52-7ï¼ˆæ‰©å±•å½¢å¼ï¼‰æˆ–2006W527ï¼ˆç´§å‡‘å½¢å¼ï¼‰ï¼‰day_of_week (int|str) â€“ number or name of weekday (0-6 or mon,tue,wed,thu,fri,sat,sun) - ï¼ˆè¡¨ç¤ºä¸€å‘¨ä¸­çš„ç¬¬å‡ å¤©ï¼Œæ—¢å¯ä»¥ç”¨0-6è¡¨ç¤ºä¹Ÿå¯ä»¥ç”¨å…¶è‹±è¯­ç¼©å†™è¡¨ç¤ºï¼‰hour (int|str) â€“ hour (0-23) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º0-23æ—¶ï¼‰minute (int|str) â€“ minute (0-59) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º0-59åˆ†ï¼‰second (int|str) â€“ second (0-59) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º0-59ç§’ï¼‰start_date (datetime|str) â€“ earliest possible date/time to trigger on (inclusive) - ï¼ˆè¡¨ç¤ºå¼€å§‹æ—¶é—´ï¼‰end_date (datetime|str) â€“ latest possible date/time to trigger on (inclusive) - ï¼ˆè¡¨ç¤ºç»“æŸæ—¶é—´ï¼‰timezone (datetime.tzinfo|str) â€“ time zone to use for the date/time calculations (defaults to scheduler timezone) -ï¼ˆè¡¨ç¤ºæ—¶åŒºå–å€¼ï¼‰#å¦‚:åœ¨6,7,8,11,12æœˆä»½çš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”çš„00:00,01:00,02:00,03:00 æ‰§è¡Œè¯¥ç¨‹åºsched.add_job(my_job, 'cron', month='6-8,11-12', day='3rd fri', hour='0-3')#2.intervalé£æ ¼weeks (int) â€“ number of weeks to waitdays (int) â€“ number of days to waithours (int) â€“ number of hours to waitminutes (int) â€“ number of minutes to waitseconds (int) â€“ number of seconds to waitstart_date (datetime|str) â€“ starting point for the interval calculationend_date (datetime|str) â€“ latest possible date/time to trigger ontimezone (datetime.tzinfo|str) â€“ time zone to use for the date/time calculations#å¦‚:æ¯éš”2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡scheduler.add_job(myfunc, 'interval', minutes=2)#3.dateé£æ ¼run_date (datetime|str) â€“ the date/time to run the job at -ï¼ˆä»»åŠ¡å¼€å§‹çš„æ—¶é—´ï¼‰timezone (datetime.tzinfo|str) â€“ time zone for run_date if it doesnâ€™t have one already#å¦‚:åœ¨2009å¹´11æœˆ6å·16æ—¶30åˆ†5ç§’æ—¶æ‰§è¡Œsched.add_job(my_job, 'date', run_date=datetime(2009, 11, 6, 16, 30, 5), args=['text']) ä½œä¸šå­˜å‚¨(job store)å­˜å‚¨è¢«è°ƒåº¦çš„ä½œä¸šï¼Œé»˜è®¤çš„ä½œä¸šå­˜å‚¨æ˜¯ç®€å•åœ°æŠŠä½œä¸šä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå…¶ä»–çš„ä½œä¸šå­˜å‚¨æ˜¯å°†ä½œä¸šä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚ä¸€ä¸ªä½œä¸šçš„æ•°æ®è®²åœ¨ä¿å­˜åœ¨æŒä¹…åŒ–ä½œä¸šå­˜å‚¨æ—¶è¢«åºåˆ—åŒ–ï¼Œå¹¶åœ¨åŠ è½½æ—¶è¢«ååºåˆ—åŒ–ã€‚è°ƒåº¦å™¨ä¸èƒ½åˆ†äº«åŒä¸€ä¸ªä½œä¸šå­˜å‚¨ã€‚ jobstoreåˆ™æ˜¯æŒ‡çš„æ˜¯jobæŒä¹…åŒ–,é»˜è®¤jobè¿è¡Œåœ¨å†…å­˜ä¸­,å¯æŒä¹…åŒ–åœ¨æ•°æ®åº“,æŒ‡å®šä¸ºmongoçš„MongoDBJobStoreæˆ–è€…æ˜¯ä½¿ç”¨sqliteçš„SQLAlchemyJobStore,åŒæ—¶å¯æŒ‡å®šå¤šç§jobstore æ‰§è¡Œå™¨(executor)å¤„ç†ä½œä¸šçš„è¿è¡Œï¼Œä»–ä»¬é€šå¸¸é€šè¿‡åœ¨ä½œä¸šä¸­æäº¤åˆ¶å®šçš„å¯è°ƒç”¨å¯¹è±¡åˆ°ä¸€ä¸ªçº¿ç¨‹æˆ–è€…è¿›åŸæ± æ¥è¿›è¡Œã€‚å½“ä½œä¸šå®Œæˆæ—¶ï¼Œæ‰§è¡Œå™¨å°†ä¼šé€šçŸ¥è°ƒåº¦å™¨ã€‚ è¯´ç™½äº†å°±æ˜¯æŒ‡å®šä»»åŠ¡æ˜¯ä»¥çº¿ç¨‹æ± /è¿›ç¨‹æ± é‡Œè¿è¡Œ,è¿™åœ¨åˆå§‹åŒ–æ—¶å¯ä»¥æŒ‡å®š,åŒæ—¶å¯ä»¥æŒ‡å®šæœ€å¤§çš„å·¥ä½œæ± ,é»˜è®¤çš„ä¸ºdefault: ThreadPoolExecutor,max-workerä¸º20,å½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šä¸ºprocesspool,é»˜è®¤max-workerä¸º5 è°ƒåº¦å™¨(scheduler)æ˜¯å…¶ä»–çš„ç»„æˆéƒ¨åˆ†ã€‚ä½ é€šå¸¸åœ¨åº”ç”¨åªæœ‰ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œåº”ç”¨çš„å¼€å‘è€…é€šå¸¸ä¸ä¼šç›´æ¥å¤„ç†ä½œä¸šå­˜å‚¨ã€è°ƒåº¦å™¨å’Œè§¦å‘å™¨ï¼Œç›¸åï¼Œè°ƒåº¦å™¨æä¾›äº†å¤„ç†è¿™äº›çš„åˆé€‚çš„æ¥å£ã€‚é…ç½®ä½œä¸šå­˜å‚¨å’Œæ‰§è¡Œå™¨å¯ä»¥åœ¨è°ƒåº¦å™¨ä¸­å®Œæˆï¼Œä¾‹å¦‚æ·»åŠ ã€ä¿®æ”¹å’Œç§»é™¤ä½œä¸šã€‚è°ƒåº¦å™¨åˆ†ä¸ºä»¥ä¸‹å‡ ç§,å¯æ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯é€‰ç”¨ä¸åŒçš„è°ƒåº¦å™¨: 1234567BlockingScheduler: å¾ˆæ˜æ˜¾è¿™æ˜¯ç§é˜»å¡å‹,ä¸€èˆ¬ç”¨åœ¨æ²¡æœ‰å…¶å®ƒè¿›ç¨‹è¿è¡Œçš„åœºæ™¯ä¸‹BackGroundScheduler: åå°å¼,ä¹Ÿå°±æ˜¯å•èµ·ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹è¿è¡Œè¯¥ä»»åŠ¡,ä¸å½±å“ä¸»ç¨‹åºASyncIOScheduler:GeventScheduler:TornadoScheduler:TwistedScheduler:QtScheduler: æœ¬äººåªä½¿ç”¨è¿‡BlockingSchedulerè·ŸBackGroundScheduler,flask-schedulerä½¿ç”¨çš„å³ä¸ºBackGroundScheduler,å…¶å®ƒçš„åç»­å†ç ”ç©¶ç ”ç©¶ é€‰æ‹©ç±»å‹ä¹Ÿå¾ˆç®€å•,åˆå§‹åŒ–æ—¶ç›´æ¥å®ä¾‹åŒ–: 1234from apscheduler.schedulers.background import BackgroundSchedulerscheduler = BackgroundScheduler()#å¯åŠ¨scheduler.start() ä»¥ä¸Šå°±æ˜¯apschedulerä¸»è¦ç»„æˆçš„å››ä¸ªæ–¹é¢ã€‚é‚£ä¹ˆæ—¢ç„¶æœ‰æä¾›flask-apschedulerè¿™ä¸ªæ‰©å±•ï¼Œé‚£ä¸€å®šæ˜¯æŠŠapschedulerå°è£…è¿‡åä¸ºæˆ‘ä»¬æä¾›æ›´åŠ æ–¹ä¾¿çš„é›†æˆå¼€å‘ï¼Œè¿™é‡Œæˆ‘çš„å­˜å‚¨é€‰æ‹©äº†MySQLä½œä¸ºä½œä¸šä»»åŠ¡å­˜å‚¨ï¼Œå› ä¸ºæˆ‘è¿™é‡Œçš„å¹³å°çš„ç”¨æˆ·æ˜¯ç”¨å®ƒæ¥å­˜å‚¨çš„ï¼›ä¸ºäº†æ–¹ä¾¿ç»Ÿä¸€ä½¿ç”¨äº†MySQL; ä»¥ä¸‹æ˜¯è¿™ä¸ªé¡¹ç›®çš„ç»“æ„: 123456789101112131415161718192021 /data/study/github_repo/JobCenter $ tree -L 2.â”œâ”€â”€ LICENSEâ”œâ”€â”€ Pipfileâ”œâ”€â”€ Pipfile.lockâ”œâ”€â”€ README.mdâ”œâ”€â”€ appâ”‚&nbsp;&nbsp; â”œâ”€â”€ __init__.pyâ”‚&nbsp;&nbsp; â”œâ”€â”€ auth/ # å¹³å°ç™»å½•ç›¸å…³â”‚&nbsp;&nbsp; â”œâ”€â”€ commands.pyâ”‚&nbsp;&nbsp; â”œâ”€â”€ config.py # å¹³å°é…ç½®ç›¸å…³â”‚&nbsp;&nbsp; â”œâ”€â”€ decorators.pyâ”‚&nbsp;&nbsp; â”œâ”€â”€ email.py # é‚®ä»¶å‘é€â”‚&nbsp;&nbsp; â”œâ”€â”€ extensions.pyâ”‚&nbsp;&nbsp; â”œâ”€â”€ job/ # å®šæ—¶ä»»åŠ¡ä¸»è¦æ¨¡å—â”‚&nbsp;&nbsp; â”œâ”€â”€ main/ # ä¸»è¦ç”¨äºè·¯ç”±â”‚&nbsp;&nbsp; â”œâ”€â”€ models.py # æ•°æ®æ¨¡å‹â”‚&nbsp;&nbsp; â”œâ”€â”€ static â”‚&nbsp;&nbsp; â”œâ”€â”€ templatesâ””â”€â”€ test.py ç›®å‰ä¸»è¦å®ç°çš„åŠŸèƒ½æœ‰: å¯è§†åŒ–ç•Œé¢æ“ä½œ å®šæ—¶ä»»åŠ¡ç»Ÿä¸€ç®¡ç† å®Œå…¨å…¼å®¹Crontab æ”¯æŒç§’çº§å®šæ—¶ä»»åŠ¡ ä½œä¸šä»»åŠ¡å¯æœç´¢ã€æš‚åœã€ç¼–è¾‘ã€åˆ é™¤ ä½œä¸šä»»åŠ¡æŒä¹…åŒ–å­˜å‚¨ã€ä¸‰ç§ä¸åŒè§¦å‘å™¨ç±»å‹ä½œä¸šåŠ¨æ€æ·»åŠ  æ¬¢è¿star æ¬¢è¿æå»ºè®®~é¡¹ç›®åœ°å€: https://github.com/guomaoqiu/JobCenterDemoåœ°å€: https://jobcenter.sctux.cc","categories":[{"name":"å®šæ—¶ä»»åŠ¡","slug":"å®šæ—¶ä»»åŠ¡","permalink":"https://blog.sctux.cc/categories/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"}],"tags":[{"name":"Flask APScheduler","slug":"Flask-APScheduler","permalink":"https://blog.sctux.cc/tags/Flask-APScheduler/"}],"keywords":[{"name":"å®šæ—¶ä»»åŠ¡","slug":"å®šæ—¶ä»»åŠ¡","permalink":"https://blog.sctux.cc/categories/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"}]},{"title":"åŸºäºHarboræ­å»ºä¼ä¸šçº§ç§æœ‰é•œåƒä»“åº“","slug":"docker-harbor","date":"2019-01-07T10:23:27.000Z","updated":"2025-09-01T01:59:08.881Z","comments":true,"path":"2019/01/07/docker-harbor/","permalink":"https://blog.sctux.cc/2019/01/07/docker-harbor/","excerpt":"åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“èƒŒæ™¯dockerä¸­è¦ä½¿ç”¨é•œåƒï¼Œä¸€èˆ¬ä¼šä»æœ¬åœ°ã€docker Hupå…¬å…±ä»“åº“å’Œå…¶å®ƒç¬¬ä¸‰æ–¹å…¬å…±ä»“åº“ä¸­ä¸‹è½½é•œåƒï¼Œä¸€èˆ¬å‡ºäºå®‰å…¨å’Œå¤–ç½‘(å¢™)èµ„æºä¸‹è½½é€Ÿç‡çš„åŸå› è€ƒè™‘ä¼ä¸šçº§ä¸Šä¸ä¼šè½»æ˜“ä½¿ç”¨ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§åŠæ³•å¯ä»¥å­˜å‚¨è‡ªå·±çš„é•œåƒåˆæœ‰å®‰å…¨è®¤è¯çš„ä»“åº“å‘¢? â€”-&gt; ä¼ä¸šçº§ç¯å¢ƒä¸­åŸºäºHarboræ­å»ºè‡ªå·±çš„å®‰å…¨è®¤è¯ä»“åº“ã€‚ Harboræ˜¯VMwareå…¬å¸æœ€è¿‘å¼€æºçš„ä¼ä¸šçº§Docker Registryé¡¹ç›®, å…¶ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·è¿…é€Ÿæ­å»ºä¸€ä¸ªä¼ä¸šçº§çš„Docker registryæœåŠ¡ã€‚ å®‰è£…Harborharboréœ€è¦å®‰è£…dockerå’Œdocker-composeæ‰èƒ½ä½¿ç”¨ï¼Œå®‰è£…dockeræ­¥éª¤çœç•¥ï¼Œ å®‰è£…docker-domposedocker-domposeå®‰è£…æ­¥éª¤å¦‚ä¸‹ï¼š ä¸‹è½½æœ€æ–°ç‰ˆçš„docker-composeæ–‡ä»¶","text":"åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“èƒŒæ™¯dockerä¸­è¦ä½¿ç”¨é•œåƒï¼Œä¸€èˆ¬ä¼šä»æœ¬åœ°ã€docker Hupå…¬å…±ä»“åº“å’Œå…¶å®ƒç¬¬ä¸‰æ–¹å…¬å…±ä»“åº“ä¸­ä¸‹è½½é•œåƒï¼Œä¸€èˆ¬å‡ºäºå®‰å…¨å’Œå¤–ç½‘(å¢™)èµ„æºä¸‹è½½é€Ÿç‡çš„åŸå› è€ƒè™‘ä¼ä¸šçº§ä¸Šä¸ä¼šè½»æ˜“ä½¿ç”¨ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§åŠæ³•å¯ä»¥å­˜å‚¨è‡ªå·±çš„é•œåƒåˆæœ‰å®‰å…¨è®¤è¯çš„ä»“åº“å‘¢? â€”-&gt; ä¼ä¸šçº§ç¯å¢ƒä¸­åŸºäºHarboræ­å»ºè‡ªå·±çš„å®‰å…¨è®¤è¯ä»“åº“ã€‚ Harboræ˜¯VMwareå…¬å¸æœ€è¿‘å¼€æºçš„ä¼ä¸šçº§Docker Registryé¡¹ç›®, å…¶ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·è¿…é€Ÿæ­å»ºä¸€ä¸ªä¼ä¸šçº§çš„Docker registryæœåŠ¡ã€‚ å®‰è£…Harborharboréœ€è¦å®‰è£…dockerå’Œdocker-composeæ‰èƒ½ä½¿ç”¨ï¼Œå®‰è£…dockeræ­¥éª¤çœç•¥ï¼Œ å®‰è£…docker-domposedocker-domposeå®‰è£…æ­¥éª¤å¦‚ä¸‹ï¼š ä¸‹è½½æœ€æ–°ç‰ˆçš„docker-composeæ–‡ä»¶ 1$ curl -L https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose æ·»åŠ å¯æ‰§è¡Œæƒé™ 1$ chmod +x /usr/local/bin/docker-compose éªŒè¯ç‰ˆæœ¬ 12$ docker-compose -vdocker-compose version 1.23.2, build 1110ad01 è·å–Harborè½¯ä»¶åŒ…1https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-offline-installer-v1.7.1.tgz è§£å‹ 1tar -xf harbor-offline-installer-v1.7.1.tgz -C /usr/local/ ç¼–è¾‘é…ç½®æ–‡ä»¶ 12345678910$ cd /usr/local/harbor$ vim harbor.cfghostname = reg.for-k8s.com # æœ¬æœºå¤–ç½‘IPæˆ–åŸŸåï¼Œè¯¥åœ°å€ä¾›ç”¨æˆ·é€šè¿‡UIè¿›è¡Œè®¿é—®ï¼Œä¸è¦ä½¿ç”¨127.0.0.1ui_url_protocol = https # ç”¨æˆ·è®¿é—®ç§ä»“æ—¶ä½¿ç”¨çš„åè®®ï¼Œé»˜è®¤æ—¶httpï¼Œé…ç½®æˆhttpsdb_password = root123 # æŒ‡å®šmysqlæ•°æ®åº“ç®¡ç†å‘˜å¯†ç harbor_admin_passwordï¼šHarbor12345 # harborçš„ç®¡ç†å‘˜è´¦æˆ·å¯†ç ssl_cert = /data/cert/reg.for-k8s.com.crt # è®¾ç½®è¯ä¹¦æ–‡ä»¶è·¯å¾„ssl_cert_key = /data/cert/reg.for-k8s.com.key # è®¾ç½®è¯ä¹¦å¯†é’¥æ–‡ä»¶è·¯å¾„# å…¶ä»–é…ç½®é€‰é¡¹æŒ‰éœ€å¡«å†™å³å¯ ç”Ÿæˆsslè¯ä¹¦ç”Ÿæˆæ ¹è¯ä¹¦ 123$ cd /dada/cert/$ openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 365 -out ca.crt -subj \"/C=CN/L=Shanghai/O=harbor/CN=harbor-registry\" ç”Ÿæˆä¸€ä¸ªè¯ä¹¦ç­¾å, è®¾ç½®è®¿é—®åŸŸåä¸º reg.for-k8s.com 1$ openssl req -newkey rsa:4096 -nodes -sha256 -keyout reg.for-k8s.com.key -out server.csr -subj \"/C=CN/L=Shanghai/O=harbor/CN=reg.for-k8s.com\" ç”Ÿæˆä¸»æœºè¯ä¹¦ 1$ openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out reg.for-k8s.com.crt é€šè¿‡è‡ªå¸¦è„šæœ¬ä¸€é”®å®‰è£…12345678910$ cd /usr/local/harbor/./install.sh..................âœ” ----Harbor has been installed and started successfully.----Now you should be able to visit the admin portal at https://reg.for-k8s.com.For more details, please visit https://github.com/goharbor/harbor . ç„¶åç»‘å®šhostsè®¿é—®å³å¯: é»˜è®¤è´¦å·å¯†ç admin / Harbor12345 ok é‚£ä¸Šé¢çš„ç§æœ‰ä»“åº“æœåŠ¡å·²ç»æ­å»ºå®Œæ¯•äº†ï¼Œè¯¥æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ é¦–å…ˆåœ¨harborä¸Šåˆ›å»ºä¸€ä¸ªé¡¹ç›®myproject(æˆ‘è¿™é‡Œä¸ä½¿ç”¨é»˜è®¤çš„libary)è¿™é‡Œæˆ‘é€‰æ‹©ç§æœ‰ä»“åº“, pull/pushéƒ½éœ€è¦åœ¨ä¸»æœºä¸Šé¢æ‰§è¡Œdocker loginæ‰è¡Œ; å½“æˆ‘é€šè¿‡Dockerfileæ„å»ºä¸€ä¸ªæ–°é•œåƒçš„æ—¶å€™, ç›´æ¥æŒ‡æ˜registryå’Œæ ‡ç­¾, æ¯”å¦‚: 123456789101112131415$ docker build -t reg.for-k8s.com/myproject/mydocker-image:v1.0.1 .Sending build context to Docker daemon 97.21MBStep 1/12 : FROM 1and1internet/ubuntu-16 ---&gt; dbf985f1f449Step 2/12 : MAINTAINER guomaoqiu &lt;guomaoqiu@gmail.com&gt; ---&gt; Using cache ---&gt; 598894333db9............Successfully built b190966f3773Successfully tagged reg.for-k8s.com/myproject/mydocker-image:v1.0.1$ docker images | grep myprojectreg.for-k8s.com/myproject/mydocker-image v1.0.1 b190966f3773 44 seconds ago 482MB åŠ å…¥å½“ä½ ä»åˆ«å¤„è·å–çš„é•œåƒæƒ³ä¸Šä¼ åˆ°ç§æœ‰ä»“åº“å‘¢ï¼Ÿå°±æ˜¯æ‰“ä¸ªtagå°±è¡Œå•¦, æ¯”å¦‚æˆ‘æƒ³æŠŠä»å®˜ç½‘çš„è¿™ä¸ªnginxé•œåƒæ”¾åˆ°æˆ‘çš„ä»“åº“: 1234$ docker tag nginx reg.for-k8s.com/myproject/mynginx:latest$ docker images | grep myprojectreg.for-k8s.com/myproject/mydocker-image v1.0.1 b190966f3773 2 minutes ago 482MBreg.for-k8s.com/myproject/mynginx latest 568c4670fa80 5 weeks ago 109MB ç™»å½•ä»“åº“ 123456789$ docker login -u admin -p Harbor12345 reg.for-k8s.comUsername: adminPassword:WARNING! Your password will be stored unencrypted in /root/.docker/config.json.Configure a credential helper to remove this warning. Seehttps://docs.docker.com/engine/reference/commandline/login/#credentials-storeLogin Succeeded æœ€åæŠŠæœ¬åœ°çš„é•œåƒpushåˆ°ä»“åº“å½“æˆ‘æ‰§è¡Œè¿™ä¸ªçš„æ—¶å€™æŠ¥é”™äº†ï¼š 12docker push reg.for-k8s.com/myproject/mynginx:latestError response from daemon: Get https://reg.for-k8s.com/v2/: x509: certificate signed by unknown authority è§£å†³åŠæ³•å°±æ˜¯å¦‚æœä¸åœ¨å®¢æˆ·ç«¯éƒ¨ç½²è¯ä¹¦ï¼Œé‚£ä¹ˆåœ¨Dockerå¯åŠ¨æ—¶è®¾ç½®å‚æ•° â€œâ€“insecure-registry IP/ä»“åº“åŸŸåâ€,ç„¶åé‡è½½æœåŠ¡é‡å¯dockerè¿›ç¨‹ï¼›æ³¨æ„çš„æ˜¯æˆ‘è¿™é‡Œä½¿ç”¨çš„è¿™ä¸ªåŸŸåæ˜¯è‡ªå®šä¹‰çš„ï¼Œé‚£ä¹ˆéœ€è¦åœ¨éœ€è¦ä¸Šä¼ ä¸‹è½½é•œåƒçš„æœºå™¨ä¸Šï¼ŒåŒæ ·éœ€è¦ä¿®æ”¹dockerè¿›ç¨‹å‚æ•°ï¼Œå¹¶ä¸”ç»‘å®šhosts,å¦åˆ™å³ä½¿é…ç½®äº†å‚æ•°ï¼Œè¿™ä¸ªåŸŸåæ²¡æ³•è§£æä¹Ÿæ˜¯push/pullä¸åˆ°é•œåƒçš„ã€‚ å†æ¬¡æ‰§è¡Œpushæ“ä½œ: 12345678910111213141516171819202122$ docker push reg.for-k8s.com/myproject/mynginx:latestThe push refers to repository [reg.for-k8s.com/myproject/mynginx]b7efe781401d: Pushedc9c2a3696080: Pushed7b4e562e58dc: Pushedlatest: digest: sha256:e2847e35d4e0e2d459a7696538cbfea42ea2d3b8a1ee8329ba7e68694950afd3 size: 948$ [root@k8s-m1 kubectl-terminal-ubuntu]# docker push reg.for-k8s.com/myproject/mydocker-image:v1.0.1The push refers to repository [reg.for-k8s.com/myproject/mydocker-image]96dca48ee72c: Pushedfa879b69764c: Pushed4d823b00e6b7: Pushed6bf6e96da4a0: Pushedeedda540c6a8: Pushedf2a971e53afa: Pushed3ee1a3b3fd18: Pushed8a225cfa6dea: Pushed428c1ba11354: Pushedb097f5edab7b: Pushed27712caf4371: Pushed8241afc74c6f: Pushedv1.0.1: digest: sha256:a20629f62d73cff93bf73b31958878a1d76c2dd42e36ebb2cb6d0ac294a46da7 size: 2826 ä»¥ä¸ŠpushæˆåŠŸï¼› æµ‹è¯•pullé‚£ä¸ºäº†æµ‹è¯•pullå¹¶ä¸”èƒ½æˆåŠŸè¿è¡Œï¼Œæˆ‘è¿™é‡Œé€šè¿‡kuernetesè¿è¡Œä¸€ä¸ªDaemonSetï¼Œé•œåƒé‡‡ç”¨: mynginx ,å¹¶ä¸”è®¾ç½®é•œåƒpullç­–ç•¥ä¸ºAlways, ç„¶ååˆ›å»ºä¸€ä¸ªæœåŠ¡åœ¨é›†ç¾¤å†…éƒ¨é€šè¿‡ClusterIPèƒ½å¤Ÿè®¿é—®, yamlå¦‚ä¸‹: 1234567891011121314151617181920212223242526272829303132333435363738394041$ cat &gt;&gt; test.yaml &lt;&lt; EOFapiVersion: v1kind: Servicemetadata: labels: app: mynginx-service name: mynginx-servicespec: ports: - name: 80-80 port: 80 protocol: TCP targetPort: 80 selector: run: mynginx type: ClusterIP---apiVersion: extensions/v1beta1kind: DaemonSetmetadata: labels: run: mynginx name: mynginxspec: selector: matchLabels: run: mynginx template: metadata: labels: run: mynginx spec: containers: - image: reg.for-k8s.com/myproject/mynginx:latest imagePullPolicy: Always name: mynginxEOF$ kubectl apply -f daemonset.yamlservice/mynginx-service createddaemonset.extensions/mynginx create ç”±äºæˆ‘åˆšæ‰åˆ›å»ºä»“åº“çš„æ—¶å€™è®¾ç½®çš„ä»“åº“éšç§æ€§ä¸ºç§æœ‰çš„éœ€è¦docker login ç™»å½•æˆåŠŸä¹‹åï¼Œk8s kubectl create å°±æ‹‰å–ä¸äº†é•œåƒï¼›å¦‚æœè®¾ç½®ä¸ºå…¬å¼€ï¼Œé‚£ä¹ˆä¹…ä¸éœ€è¦é…ç½®è¿™ä¸€æ­¥éª¤ã€‚åªéœ€è¦docker login ç™»å½•æˆåŠŸä¹‹åï¼Œk8s kubectl create å°±å¯ä»¥æ‹‰å–é•œåƒ; ä½†æ˜¯æˆ‘ä¸æƒ³è®©å…¶ä¸ºå…¬å¼€çš„ï¼›æ‰€ä»¥è¿˜éœ€è¦é…ç½®å¦‚ä¸‹æ­¥éª¤ï¼š é…ç½®ä¸€ä¸ªç§æœ‰ä»“åº“harborçš„secretï¼š 123kubectl create secret docker-registry registry-secret --namespace=default \\--docker-server=https://reg.for-k8s.com --docker-username=admin \\--docker-password=Harbor12345 éƒ¨ç½²æ—¶æŒ‡å®šimagePullSecrets, ä¿®æ”¹åœ¨ä¸Šé¢çš„yamlä¸­æ·»åŠ è¿™ä¸ªé€‰é¡¹: 12345678910111213141516171819202122232425262728293031323334353637383940414243$ cat &gt;&gt; test.yaml &lt;&lt; EOFapiVersion: v1kind: Servicemetadata: labels: app: mynginx-service name: mynginx-servicespec: ports: - name: 80-80 port: 80 protocol: TCP targetPort: 80 selector: run: mynginx type: ClusterIP---apiVersion: extensions/v1beta1kind: DaemonSetmetadata: labels: run: mynginx name: mynginxspec: selector: matchLabels: run: mynginx template: metadata: labels: run: mynginx spec: containers: - image: reg.for-k8s.com/myproject/mynginx:latest imagePullPolicy: Always name: mynginx imagePullSecrets: - name: registry-secretEOF$ kubectl apply -f daemonset.yamlservice/mynginx-service createddaemonset.extensions/mynginx create","categories":[{"name":"docker","slug":"docker","permalink":"https://blog.sctux.cc/categories/docker/"}],"tags":[{"name":"docker-registry","slug":"docker-registry","permalink":"https://blog.sctux.cc/tags/docker-registry/"}],"keywords":[{"name":"docker","slug":"docker","permalink":"https://blog.sctux.cc/categories/docker/"}]},{"title":"CKA(Certified Kubernetes Adminsitrator)è®¤è¯è·å–å†ç¨‹","slug":"road-to-cka","date":"2019-01-07T02:00:40.000Z","updated":"2025-09-01T01:59:08.876Z","comments":true,"path":"2019/01/07/road-to-cka/","permalink":"https://blog.sctux.cc/2019/01/07/road-to-cka/","excerpt":"my experience with cka exam preparation What is CKA?CKAå…¨ç§°å°±æ˜¯Certified Kubernetes Adminsitratorï¼Œæ˜¯ç”±CNCF(Cloud Native Computing Foundation äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š)æä¾›çš„è®¤è¯é¡¹ç›®ï¼Œè€ƒè¯•è´¹ç”¨ä¸º300ç¾é‡‘ï¼Œå¿…é¡»è¦åŒå¸è¡Œç”¨å¡ï¼Œè€ƒè¯•è¿‡ç¨‹ä¸º3ä¸ªå°æ—¶ã€‚æˆ‘åŠç†çš„æ˜¯æ‹›è¡Œçš„MasterCardï¼Œç»™äº†20å—åŠ æ€¥ï¼›ç¼´è€ƒè¯•è´¹åˆ°è€ƒå®Œæ•´ä¸ªæµç¨‹æ–¹é¢è¿˜æ˜¯éå¸¸ç®€å•çš„ã€‚ ![](road-to-cka/WechatIMG319.jpeg) å¦‚æœè€ƒè¯•ç¬¬ä¸€æ¬¡è€ƒè¯•ä¸é€šè¿‡ï¼Œè´¦å·å†…ä¼šç”Ÿæˆä¸€ä¸ª`Free Retake`ï¼Œåœ¨ä¸€å¹´ä¹‹å†…æœ‰ä¸€æ¬¡å…è´¹é‡è€ƒçš„æœºä¼šã€‚ Why should obtain certificationå¾ˆæœ‰å¹¸åœ¨æ˜¥èŠ‚å‰(2019/01/06)å®Œæˆäº†2018ä¸‹åŠå¹´æ—¢å®šçš„ç›®æ ‡ï¼Œå°†CKAé¡ºåˆ©æ‹¿ä¸‹ã€‚å¾ˆå·§åˆçš„æ˜¯åœ¨6å¹´å‰ä¹Ÿå°±æ˜¯2013å¹´1æœˆ5å·æˆ‘é€šè¿‡äº†RHCEè®¤è¯è€ƒè¯•(è™½ç„¶æˆ‘çš„RHCEè®¤è¯æ—©å·²è¿‡æœŸï¼Œä½†æ˜¯æˆ‘æ›´æƒ³è¯´çš„æ˜¯: ä¸‡å˜ä¸ç¦»å…¶å®— ) å½“K8Så·²ç»è¿›å…¥åˆ°å„è¡Œå„ä¸šï¼Œé‚£ä¹ˆä¸€å¥—å…¬æ­£æƒå¨çš„ç®¡ç†å‘˜æµ‹è¯„ä½“ç³»å¿…ç„¶å°±å‘¼ä¹‹æ¬²å‡ºäº†ã€‚ä¹Ÿè®¸ä½ ä¼šè¯´äº’è”ç½‘ä¼ä¸šä¸ç›¸ä¿¡è®¤è¯ï¼Œç¡®å®ä¸€å¼ çº¸å¹¶ä¸èƒ½è¯´æ˜ä»€ä¹ˆã€‚è¿™äº›è®¤è¯çš„æ„ä¹‰ä½•åœ¨ï¼Œæˆ–è€…æ€ä¹ˆæ‰èƒ½å‘åˆ«äººè¯æ˜ä½ ä¼šç”¨å‘¢ï¼Ÿç­”æ¡ˆè‡ªç„¶å°±æ˜¯è€ƒè¯äº†ã€‚RHCEä¹Ÿå¥½ã€CKAä¹Ÿå¥½å¯¹æˆ‘è€Œè¨€å…¶å®æ›´å¤šçš„æ˜¯ä¸€ç§é­ç­–ï¼Œè®©è‡ªå·±å¿ƒé‡Œæœ‰ä¸ªå°ç›®æ ‡ï¼ŒåŒæ—¶èƒ½å¤Ÿä»¥è¿ç»´äººå‘˜çš„èº«ä»½å»ç³»ç»Ÿçš„å­¦ä¹ ã€ä½¿ç”¨ä»–ä»¬ã€‚ ç»è¿‡æˆ‘ä¸ªäººçš„å­¦ä¹ ï¼Œå‚è€ƒè¿‡ç¨‹ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªè®¤è¯çš„æ„ä¹‰å’Œä»·å€¼å¦‚ä¸‹ï¼š ä»è€ƒè¯•å¤§çº²å¯ä»¥çœ‹å‡ºè€ƒè¯•å†…å®¹æ¶µç›–çš„çŸ¥è¯†ç‚¹å¾ˆå…¨é¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ éœ€è¦å­¦ä¹ æˆ–è€…äº†è§£çš„çŸ¥è¯†ç‚¹ä¹Ÿå°±å¾ˆå¤š; å¯¹äºè®¡åˆ’æ„å»ºè‡ªå·±k8sé›†ç¾¤çš„ä¸ªäººå’Œä¼ä¸šï¼Œæœ‰CKAåœ¨ä½ çš„å›¢é˜Ÿé‡Œèƒ½è®©ä½ æ›´å¿«æ›´ç¨³çš„å¼€å§‹ä½ çš„å®è·µã€‚æ¯•ç«Ÿè¿™å¸®äººæ˜¯ä»å¾’æ‰‹æ­é›†ç¾¤å¼€å§‹çš„ã€‚ å‚åŠ è¿™ä¸ªè€ƒè¯•çš„æ—¶é—´éå¸¸ç´§å¼ ï¼Œå‚åŠ äººå¿…é¡»å¯¹k8så¤§éƒ¨åˆ†èµ„æºçš„yamlå’Œå‘½ä»¤çƒ‚ç†Ÿäºå¿ƒã€‚ä½ éšä¾¿æ‰¾ä¸ªckaæ¥ï¼Œè®©ä»–å¾’æ‰‹ç»™ä½ å†™ä¸€ä¸ªåº”ç”¨çš„ç¼–æ’å‡ºæ¥ï¼Œä»deploy åˆ°pvåˆ°serviceï¼Œä¹Ÿè®¸ä»–ä¸ªåˆ«ç»†èŠ‚å’Œè¯æ³•å¯èƒ½ä¼šå†™é”™ï¼Œå¤§ä½“å†™å‡ºæ¥æ˜¯ä¸€ç‚¹é—®é¢˜éƒ½æ²¡æœ‰çš„ï¼ŒæœŸé—´å®Œå…¨ä¸ç”¨å‚è€ƒæ–‡æ¡£ã€‚æˆ‘è¦è¯´çš„æ˜¯ckaçš„åŸºæœ¬æŠ€èƒ½éå¸¸è¿‡ç¡¬ã€‚ æˆªè‡³åˆ°ç°åœ¨ï¼Œæˆ‘æ²¡æœ‰è§è¿‡ä»»ä½•ç»„ç»‡å’Œä¸ªäººæä¾›ckaå¿…è¿‡æ‰‹å†Œï¼ˆä¹Ÿå°±æ˜¯ä¼ è¯´ä¸­çš„bibleï¼‰ã€‚è¿™ä¸ªè®¤è¯è¯ç”Ÿä¹Ÿå°±ä¸€ã€ä¸¤å¹´çš„æ—¶é—´ï¼Œ å› æ­¤ç°åœ¨é€šè¿‡çš„äººéƒ½æ˜¯è´§çœŸä»·å®è€ƒå‡ºæ¥çš„ï¼ˆç›¸å¯¹äºå…¶ä»–å…¬å¸çš„æŸcmï¼ŒæŸæŸcaç­‰ç­‰ï¼‰ï¼Œè¿™ä¸ªä»·å€¼ä¼šä½“ç°åœ¨è¯ä¹¦ç¼–å·ä¸Šã€‚å†è¿‡å‡ å¹´ï¼Œä»¥æˆ‘ä»¬ä¸­å›½äººçš„è€ƒè¯•èƒ½åŠ›æ¥è¯´ï¼Œä½ æ‡‚çš„â€¦ æœ¬è€ƒè¯•ä»æŠ¥åè€ƒè¯•åˆ°æ¥æ´½å‚è€ƒï¼Œå…¨ç¨‹è‹±æ–‡äº¤æµï¼Œèƒ½è€ƒè¿‡çš„äººè‹±æ–‡æ°´å¹³è¿˜ç®—è¯´å¾—è¿‡å»å§ã€‚","text":"my experience with cka exam preparation What is CKA?CKAå…¨ç§°å°±æ˜¯Certified Kubernetes Adminsitratorï¼Œæ˜¯ç”±CNCF(Cloud Native Computing Foundation äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š)æä¾›çš„è®¤è¯é¡¹ç›®ï¼Œè€ƒè¯•è´¹ç”¨ä¸º300ç¾é‡‘ï¼Œå¿…é¡»è¦åŒå¸è¡Œç”¨å¡ï¼Œè€ƒè¯•è¿‡ç¨‹ä¸º3ä¸ªå°æ—¶ã€‚æˆ‘åŠç†çš„æ˜¯æ‹›è¡Œçš„MasterCardï¼Œç»™äº†20å—åŠ æ€¥ï¼›ç¼´è€ƒè¯•è´¹åˆ°è€ƒå®Œæ•´ä¸ªæµç¨‹æ–¹é¢è¿˜æ˜¯éå¸¸ç®€å•çš„ã€‚ ![](road-to-cka/WechatIMG319.jpeg) å¦‚æœè€ƒè¯•ç¬¬ä¸€æ¬¡è€ƒè¯•ä¸é€šè¿‡ï¼Œè´¦å·å†…ä¼šç”Ÿæˆä¸€ä¸ª`Free Retake`ï¼Œåœ¨ä¸€å¹´ä¹‹å†…æœ‰ä¸€æ¬¡å…è´¹é‡è€ƒçš„æœºä¼šã€‚ Why should obtain certificationå¾ˆæœ‰å¹¸åœ¨æ˜¥èŠ‚å‰(2019/01/06)å®Œæˆäº†2018ä¸‹åŠå¹´æ—¢å®šçš„ç›®æ ‡ï¼Œå°†CKAé¡ºåˆ©æ‹¿ä¸‹ã€‚å¾ˆå·§åˆçš„æ˜¯åœ¨6å¹´å‰ä¹Ÿå°±æ˜¯2013å¹´1æœˆ5å·æˆ‘é€šè¿‡äº†RHCEè®¤è¯è€ƒè¯•(è™½ç„¶æˆ‘çš„RHCEè®¤è¯æ—©å·²è¿‡æœŸï¼Œä½†æ˜¯æˆ‘æ›´æƒ³è¯´çš„æ˜¯: ä¸‡å˜ä¸ç¦»å…¶å®— ) å½“K8Så·²ç»è¿›å…¥åˆ°å„è¡Œå„ä¸šï¼Œé‚£ä¹ˆä¸€å¥—å…¬æ­£æƒå¨çš„ç®¡ç†å‘˜æµ‹è¯„ä½“ç³»å¿…ç„¶å°±å‘¼ä¹‹æ¬²å‡ºäº†ã€‚ä¹Ÿè®¸ä½ ä¼šè¯´äº’è”ç½‘ä¼ä¸šä¸ç›¸ä¿¡è®¤è¯ï¼Œç¡®å®ä¸€å¼ çº¸å¹¶ä¸èƒ½è¯´æ˜ä»€ä¹ˆã€‚è¿™äº›è®¤è¯çš„æ„ä¹‰ä½•åœ¨ï¼Œæˆ–è€…æ€ä¹ˆæ‰èƒ½å‘åˆ«äººè¯æ˜ä½ ä¼šç”¨å‘¢ï¼Ÿç­”æ¡ˆè‡ªç„¶å°±æ˜¯è€ƒè¯äº†ã€‚RHCEä¹Ÿå¥½ã€CKAä¹Ÿå¥½å¯¹æˆ‘è€Œè¨€å…¶å®æ›´å¤šçš„æ˜¯ä¸€ç§é­ç­–ï¼Œè®©è‡ªå·±å¿ƒé‡Œæœ‰ä¸ªå°ç›®æ ‡ï¼ŒåŒæ—¶èƒ½å¤Ÿä»¥è¿ç»´äººå‘˜çš„èº«ä»½å»ç³»ç»Ÿçš„å­¦ä¹ ã€ä½¿ç”¨ä»–ä»¬ã€‚ ç»è¿‡æˆ‘ä¸ªäººçš„å­¦ä¹ ï¼Œå‚è€ƒè¿‡ç¨‹ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªè®¤è¯çš„æ„ä¹‰å’Œä»·å€¼å¦‚ä¸‹ï¼š ä»è€ƒè¯•å¤§çº²å¯ä»¥çœ‹å‡ºè€ƒè¯•å†…å®¹æ¶µç›–çš„çŸ¥è¯†ç‚¹å¾ˆå…¨é¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ éœ€è¦å­¦ä¹ æˆ–è€…äº†è§£çš„çŸ¥è¯†ç‚¹ä¹Ÿå°±å¾ˆå¤š; å¯¹äºè®¡åˆ’æ„å»ºè‡ªå·±k8sé›†ç¾¤çš„ä¸ªäººå’Œä¼ä¸šï¼Œæœ‰CKAåœ¨ä½ çš„å›¢é˜Ÿé‡Œèƒ½è®©ä½ æ›´å¿«æ›´ç¨³çš„å¼€å§‹ä½ çš„å®è·µã€‚æ¯•ç«Ÿè¿™å¸®äººæ˜¯ä»å¾’æ‰‹æ­é›†ç¾¤å¼€å§‹çš„ã€‚ å‚åŠ è¿™ä¸ªè€ƒè¯•çš„æ—¶é—´éå¸¸ç´§å¼ ï¼Œå‚åŠ äººå¿…é¡»å¯¹k8så¤§éƒ¨åˆ†èµ„æºçš„yamlå’Œå‘½ä»¤çƒ‚ç†Ÿäºå¿ƒã€‚ä½ éšä¾¿æ‰¾ä¸ªckaæ¥ï¼Œè®©ä»–å¾’æ‰‹ç»™ä½ å†™ä¸€ä¸ªåº”ç”¨çš„ç¼–æ’å‡ºæ¥ï¼Œä»deploy åˆ°pvåˆ°serviceï¼Œä¹Ÿè®¸ä»–ä¸ªåˆ«ç»†èŠ‚å’Œè¯æ³•å¯èƒ½ä¼šå†™é”™ï¼Œå¤§ä½“å†™å‡ºæ¥æ˜¯ä¸€ç‚¹é—®é¢˜éƒ½æ²¡æœ‰çš„ï¼ŒæœŸé—´å®Œå…¨ä¸ç”¨å‚è€ƒæ–‡æ¡£ã€‚æˆ‘è¦è¯´çš„æ˜¯ckaçš„åŸºæœ¬æŠ€èƒ½éå¸¸è¿‡ç¡¬ã€‚ æˆªè‡³åˆ°ç°åœ¨ï¼Œæˆ‘æ²¡æœ‰è§è¿‡ä»»ä½•ç»„ç»‡å’Œä¸ªäººæä¾›ckaå¿…è¿‡æ‰‹å†Œï¼ˆä¹Ÿå°±æ˜¯ä¼ è¯´ä¸­çš„bibleï¼‰ã€‚è¿™ä¸ªè®¤è¯è¯ç”Ÿä¹Ÿå°±ä¸€ã€ä¸¤å¹´çš„æ—¶é—´ï¼Œ å› æ­¤ç°åœ¨é€šè¿‡çš„äººéƒ½æ˜¯è´§çœŸä»·å®è€ƒå‡ºæ¥çš„ï¼ˆç›¸å¯¹äºå…¶ä»–å…¬å¸çš„æŸcmï¼ŒæŸæŸcaç­‰ç­‰ï¼‰ï¼Œè¿™ä¸ªä»·å€¼ä¼šä½“ç°åœ¨è¯ä¹¦ç¼–å·ä¸Šã€‚å†è¿‡å‡ å¹´ï¼Œä»¥æˆ‘ä»¬ä¸­å›½äººçš„è€ƒè¯•èƒ½åŠ›æ¥è¯´ï¼Œä½ æ‡‚çš„â€¦ æœ¬è€ƒè¯•ä»æŠ¥åè€ƒè¯•åˆ°æ¥æ´½å‚è€ƒï¼Œå…¨ç¨‹è‹±æ–‡äº¤æµï¼Œèƒ½è€ƒè¿‡çš„äººè‹±æ–‡æ°´å¹³è¿˜ç®—è¯´å¾—è¿‡å»å§ã€‚ æˆ‘çš„å­¦ä¹ è¿‡ç¨‹ã€é€”å¾„: å…¶å®æ—©åœ¨2015å¹´å°±åœ¨æ¥è§¦å®¹å™¨æŠ€æœ¯ï¼Œä»LXCåˆ°Dockerå†åˆ°ç°åœ¨çš„kubernetes, æ—¥å¸¸å·¥ä½œä¸­çš„ä¹Ÿå°½é‡æŠŠä¸€äº›åº”ç”¨åšæˆdockerå»è·‘ï¼›çœä¸‹äº†ä¸å°‘ç²¾åŠ›æ—¶é—´å»åšä¸€äº›é‡å¤å¤æ‚æ€§çš„å·¥ä½œï¼›æ¯”å¦‚ä»¥å‰è·‘ä¸ªgitLabçš„ç¯å¢ƒï¼Œäº¦æˆ–æ˜¯æƒ³è¦ä¸ªPythonåº”ç”¨è¿è¡Œçš„ç¯å¢ƒï¼Œé™¤äº†è¦æŠŠæœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œè¿˜éœ€è¦ä¸€äº›ç¹ççš„é…ç½®ï¼Œæœ‰äº†dockerä¹‹åï¼Œé€šè¿‡dockerfile/docker-composeå°±å¯ä»¥å¾ˆè½»æ¾çš„å®ç°ä¸€äº›åº”ç”¨è·‘åœ¨å®¹å™¨é‡Œé¢äº†ã€‚2018å¹´5æœˆä»½å¼€å§‹ç ”ç©¶å­¦ä¹ kubernetesç›¸å…³ä¸œè¥¿ï¼Œè™½ç„¶å­¦ä¹ å¾—ä¸æ˜¯å¾ˆç³»ç»Ÿï¼Œä½†æ˜¯è¿˜æ˜¯å®Œæˆäº†ä¸€ä¸ªå°å°çš„é¡¹ç›®ï¼Œæ„Ÿå…´è¶£çš„ç‚¹è¿™é‡Œ å¯ä»¥ä½œä¸ºå­¦ä¹ ç»ƒä¹ çš„é¡¹ç›®;æ—¢ç„¶å­¦äº†å°±è¦ç”¨ä¸Šï¼›ä¸ç„¶ä¹Ÿæ˜¯å¾’åŠ³ã€‚ K8s.ioé‡Œé¢tasksç›¸å…³çš„ä¸œè¥¿éƒ½éœ€è¦è‡ªå·±å®è·µä¸‹ï¼Œè¿˜æ˜¯æœ‰äº›æ—¥å¸¸æ²¡æ€ä¹ˆç”¨åˆ°çš„,æœ€å¥½æŠŠæ•´ä¸ªæ–‡æ¡£éƒ½çœ‹ä¸€éã€‚ å®‹å¤§ç¥çš„åšå®¢: https://jimmysong.io/kubernetes-handbook/ å­¦ä¹ å®æ“ç¯å¢ƒåšæœ€å¥½æ˜¯é€šè¿‡äºŒè¿›åˆ¶çš„æ–¹å¼æ¥æ­å»ºï¼Œæ¯•ç«Ÿå¦‚æœä½ ä½¿ç”¨kubeadmæ¥æ­å»ºçš„è¯å¾ˆå¤šçš„äº‹æƒ…å®ƒå·²ç»å¸®ä½ å®Œæˆè®¾å®šäº†ï¼Œä¹Ÿå°±æ²¡ç†è§£ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšã€‚æ¯ä¸ªç»„ä»¶ç»“åˆèµ·æ¥ä¹‹åæ•´ä¸ªæ¶æ„åœ¨è„‘å­é‡Œé¢å°±ä¼šéå¸¸çš„æ¸…æ¥šï¼Œæ’é”™èµ·æ¥ä¹Ÿæ›´åŠ å®¹æ˜“ä¸€äº›ã€‚è€ƒè¯•ä¸éš¾ï¼Œåªè¦ç»è¿‡å¤§é‡çš„å®è·µç»ƒä¹ å°±å¯ä»¥å•¦~ æ³¨: è¿™æ¬¡CKAè€ƒè¯•ï¼Œæˆ‘æ²¡æœ‰å‚åŠ ä»»ä½•å›½å†…åŸ¹è®­ï¼Œä¸»è¦æ˜¯æ ¹æ®è€ƒè¯•å¤§çº²ã€å®˜æ–¹æ–‡æ¡£ä»¥åŠCNCFæ¨å‡ºçš„ä¸€å¥—å…è´¹è¯¾ç¨‹è¿›è¡Œè‡ªå­¦ã€‚ è€ƒå‰æ³¨æ„äº‹é¡¹ è€ƒè¯•å¹³å°æ˜¯ç”±CNCFå§”æ‰˜çš„ä¸€ä¸ªè®¡ç®—æœºæ–¹é¢éå¸¸ä¸“ä¸šçš„æœåŠ¡å•†PSIæ¥è¿›è¡Œç›‘ç£è€ƒè¯•ï¼› å®˜æ–¹è®¤è¯è¯ä»¶ï¼šéœ€è¦æœ‰ç…§ç‰‡å’ŒLatinå­—æ¯å†™çš„å…¨åï¼Œæˆ‘ç”¨çš„æ˜¯æŠ¤ç…§; è€ƒè¯•ä¸­ä¸èƒ½å–æ°´ã€åƒä¸œè¥¿ï¼Œå¯ä»¥ç”³è¯·ä¼‘æ¯ï¼Œä½†æ˜¯ä¸æ¸…æ¥šèƒ½ä¸èƒ½ç¦»å¼€æ‘„åƒå¤´ç›‘è§†èŒƒå›´å†…ï¼Œæ²¡è¯·è¿‡ï¼Œåæ­£æˆ‘å…¨ç¨‹æ— å°¿ç‚¹ã€‚ è€ƒè¯•çš„ç½‘é¡µä¸€åŠæ˜¯è¯•é¢˜ã€ä¸€åŠæ˜¯GateOneçš„ç»ˆç«¯ç•Œé¢ï¼Œæœ€å¥½èƒ½æœ‰ä¸€å°macç”µè„‘ç„¶åå¤–æ¥æ˜¾ç¤ºå™¨ã€é”®ç›˜ï¼Œé¼ æ ‡ï¼Œmacç³»ç»Ÿæ¯”windowsæœ‰ä¼˜åŠ¿ï¼Œå†ä¸€ä¸ªå°±æ˜¯ç»ˆç«¯å°±æ˜¾å¾—ä¸æ˜¯å¾ˆå°äº†ï¼Œæ“ä½œä¹Ÿé¡ºæ‰‹; (å¦å¤–ä¸ºäº†æå‰ç†Ÿæ‚‰ä½¿ç”¨gateoneç»ˆç«¯æˆ‘è¿™é‡Œä¹Ÿåšäº†ä¸€ä¸ªé•œåƒï¼Œå…·ä½“é£Ÿç”¨æ–¹æ³•å‚è§README.md) ä¸€ä¸ªæ²¡æœ‰å…¶ä»–äººçš„ç©ºæˆ¿é—´ï¼Œç©ºæ¡Œå­ï¼Œä¸èƒ½å¸¦æ‰‹æœºï¼Œä¸èƒ½æœ‰ä¹¦æœ¬ï¼Œç›‘è€ƒå®˜ä¼šè®©ä½ æ‹¿ç€ç”µè„‘å±•ç¤ºä½ å‘¨å›´çš„æ‰€æœ‰ç¯å¢ƒï¼Œæˆ‘çš„è€ƒè¯•æ˜¯é¢„çº¦åœ¨å‘¨æœ«ä¸‹åˆåœ¨å…¬å¸ä¸€ä¸ªä¼šè®®å®¤å®Œæˆçš„; æŒ‰ç…§å®˜æ–¹è€ƒè¯•æµç¨‹æŒ‡å¯¼è¿˜éœ€è¦åšä¸€ä¸‹ç¡¬ä»¶è¦æ±‚æ€§çš„æµ‹è¯•: ä½¿ç”¨Chromeæµè§ˆå™¨è®¿é—®https://www.examslocal.com/ScheduleExam/Home/CompatibilityCheck é€‰æ‹©â€Linux Foundationâ€ as the Exam Sponsor and â€œCKAâ€ as the Examæ ¹æ®æç¤ºå®‰è£…ä¸€ä¸ªchromeæ’ä»¶ï¼ˆå®æµ‹æœ‰é¡¹ç½‘é€Ÿçš„æ£€æŸ¥ï¼Œéœ€è¦æœ‰ä¸ªç¨³å®šçš„ç§‘å­¦ä¸Šç½‘å·¥å…·ï¼‰ 180åˆ†é’Ÿï¼Œ24é“é¢˜(æ¶µç›–æ‰€æœ‰k8såŸºç¡€çŸ¥è¯†ç‚¹),å¹³å‡ä¸€é“é¢˜7.5åˆ†é’Ÿï¼Œæ—¶é—´æ˜¯éå¸¸ç´§çš„ï¼›ä¸€é“é¢˜åšå®Œè¦å»éªŒè¯ï¼Œæœ‰æŠŠæ¡æ²¡é—®é¢˜çš„å°±æœæ–­ä¸‹ä¸€é¢˜ï¼Œåƒä¸‡ä¸è¦çŠ¹è±«ï¼›æ‰“è„‘å£³çš„é‚£ç§é¢˜è®°ä½é¢˜å·ï¼Œåšå®Œç®€å•çš„åœ¨å›è¿‡å¤´æ¥æ•´ã€‚ è€ƒè¯•ç»“æŸæ³¨æ„äº‹é¡¹åœ¨è€ƒè¯•ç»“æŸä¹‹åï¼Œ36ä¸ªå°æ—¶ä¹‹å†…ï¼ŒCNCFå°±ä¼šé€šè¿‡é‚®ä»¶å‘Šè¯‰ä½ è€ƒè¯•æˆç»©äº†ï¼Œå¦‚æœä½ çš„åˆ†æ•°å¤§äº74%ï¼Œé‚£ä¹ˆæ­å–œä½ é€šè¿‡äº†ï¼å¹¶ä¸”é™„ä»¶å°±ç›´æ¥ä¼šæœ‰ä½ çš„é€šè¿‡çš„è¯ä¹¦ã€‚å¦‚æœè€ƒè¯•ä¸é€šè¿‡ï¼Œä½ çš„è´¦å·ä¸Šå°±ä¼šç›´æ¥æœ‰ä¸€æ¬¡Free Retakeè€ƒè¯•çš„æœºä¼šã€‚ ğŸ˜¢ä¸¢äº†3åˆ†ï¼Œå®˜æ–¹ä¹Ÿä¸ä¼šå‘Šè¯‰ä½ åˆ°åº•é”™åœ¨å“ªé‡Œäº†ï¼›å°±åªæœ‰è¿™ä¹ˆä¸€ä¸ªæˆç»©è·Ÿè¯ä¹¦å‘è¿‡æ¥ã€‚ ä»¥ä¸Šï¼Œå¸Œæœ›å¯ä»¥å¸®åˆ°ä½ ã€‚ ps: _è¯¥è€ƒè¯•ç­¾è®¢äº†ä¿å¯†åè®®ï¼ŒSo è€ƒè¯•åŸé¢˜æ— æ³•åˆ†äº«~~~_~~","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/tags/kubernetes/"},{"name":"CKA","slug":"CKA","permalink":"https://blog.sctux.cc/tags/CKA/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"ä½¿ç”¨Bootstrap Tokenå®ŒæˆTLS Bootstrapping","slug":"kubernetes-bootstrapping","date":"2018-12-30T10:24:10.000Z","updated":"2025-09-01T01:59:08.973Z","comments":true,"path":"2018/12/30/kubernetes-bootstrapping/","permalink":"https://blog.sctux.cc/2018/12/30/kubernetes-bootstrapping/","excerpt":"ä¸€ã€æ¦‚è¿°æœ¬æ–‡ä¸»è¦è®°å½•ä¸€ä¸‹æ­å»ºä¸€ä¸ªkubeletæ­å»ºåˆ°åŠ å…¥é›†ç¾¤åˆ°æ‰‹åŠ¨ã€è‡ªåŠ¨(è¯ä¹¦è½®æ¢çš„)è¯ä¹¦è®¤è¯è¿‡ç¨‹, é‚£ä¹ˆæˆ‘çš„ç¯å¢ƒæ˜¯ç”¨çš„v1.12.4ç‰ˆæœ¬ï¼Œæœ‰ä¸€å°master,é™¤äº†masterä¸Šé¢çš„ä¸€äº›ç»„ä»¶å·²ç»æ­å»ºå®Œæ¯•ï¼Œä¸»è¦é‡ç‚¹æ˜¯åœ¨kubeletä¸Šé¢ï¼Œæ‰€ä»¥ç°åœ¨å°±æ˜¯masterå·²ç»å·¥ä½œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼ŒåŠ å…¥æ–°çš„kubelet(workerèŠ‚ç‚¹)éœ€è¦åšä¸€äº›ä»€ä¹ˆæ ·çš„æ“ä½œã€‚ç„¶åéœ€è¦å®ç°çš„æ˜¯: é€šè¿‡bootstrap tokenä»¥åŠboostrap.kubeconfigæ¥å¼•å¯¼workerèŠ‚ç‚¹ç”³è¯·è¯ä¹¦ å¦‚æœç¬¬ä¸€æ­¥ç”³è¯·å‘å‡ºå»ä¹‹åï¼Œåœ¨æ‰‹åŠ¨åœ¨masterç«¯è¿›è¡Œæ‰‹åŠ¨æ‰¹å‡†è¯ä¹¦ç”³è¯·ï¼Œç„¶åå‘æ”¾kubeletè¯ä¹¦ å®ç°kubeletè¯ä¹¦çš„è‡ªåŠ¨æ‰¹å‡† å®ç°kubeletè¯ä¹¦çš„è‡ªåŠ¨è½®æ¢æ“ä½œ ç®€å•ç†ä¸€ä¸‹TLS Bootstrappingçš„ä¸€ä¸ªå¼•å¯¼è¿‡ç¨‹ masterç«¯åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯å³ç”Ÿæˆ apiserver.pem/apiserver-key.pem/apiserver.csr; åœ¨é›†ç¾¤å†…åˆ›å»ºç‰¹å®šçš„ Bootstrap Token Secretï¼Œè¯¥ Secret å°†æ›¿ä»£ä»¥å‰çš„ token.csv å†…ç½®ç”¨æˆ·å£°æ˜æ–‡ä»¶; åœ¨é›†ç¾¤å†…åˆ›å»ºé¦–æ¬¡ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„ ClusterRole å³system:node-bootstrapper,å¹¶å°†ä¸Šé¢çš„bootstrap token secretè¿›è¡Œç»‘å®šå³ clusterrolebinding kubelet-bootstrapï¼Œè¿™æ ·é€šè¿‡ç»‘å®šå°±èƒ½ä»¥è¿™ä¸ªå†…ç½®ç”¨æˆ·ç»„ä¿¡æ¯å»å‘èµ·CSRè¯·æ±‚å•¦ï¼› ç”Ÿæˆç‰¹å®šçš„åŒ…å« TLS Bootstrapping Token çš„ bootstrap.kubeconfig; è°ƒæ•´kubeleteå¯åŠ¨å‚æ•°ï¼ŒæŒ‡å®šå¼•å¯¼æ–‡ä»¶bootstrap.kubeconfig; é‡è½½é…ç½®ã€é‡å¯æœåŠ¡ï¼Œmasterç«¯æ‰‹åŠ¨æ‰¹å‡†å®ŒæˆworkerèŠ‚ç‚¹çš„CSRè¯·æ±‚; åç»­å¦‚æœæ²¡æœ‰é…ç½®è¯ä¹¦è½®æ¢çš„è¯ï¼Œå°±ä¼šä¸€ç›´ä½¿ç”¨ç”±controller-manageræ‰¹å‡†é¢å‘çš„è¯ä¹¦æ–‡ä»¶äº†ï¼Œæœ‰æ•ˆæœŸæ˜¯ä¸€å¹´ã€‚(è‡ªåŠ¨æ‰¹å‡†&amp;è¯ä¹¦è½®æ¢ä¸‹é¢å†è¯´) å½“ç„¶ä»¥æˆ‘çš„ç†è§£è¦è¦å®ç°è¯ä¹¦è½®æ¢é‚£ä¹ˆè‚¯å®šæ˜¯æ²¡æœ‰å¤–ç•Œå¹²é¢„çš„æƒ…å†µä¸‹è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œé‚£è¿™ä¸ªåŠŸèƒ½ä¹Ÿè‚¯å®šæ˜¯éœ€è¦è‡ªåŠ¨æ‰¹å‡†è¿™ä¸ªåŠŸèƒ½çš„ã€‚ é‚£ä¹ˆè‡ªåŠ¨æ‰¹å‡†éœ€è¦åšçš„ä¸€äº›äº‹æƒ…å´æ˜¯åœ¨æ‰‹åŠ¨æ‰¹å‡†çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›æ“ä½œ: åˆ›å»ºCSRè¯·æ±‚çš„ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„renew Kubelet client/server çš„ ClusterRoleï¼Œä»¥åŠå…¶ç›¸å…³å¯¹åº”çš„ ClusterRoleBindingï¼›å¹¶ç»‘å®šåˆ°å¯¹åº”çš„ç»„æˆ–ç”¨æˆ· è°ƒæ•´ Controller Manager é…ç½®ï¼Œä»¥ä½¿å…¶èƒ½è‡ªåŠ¨ç­¾ç½²ç›¸å…³è¯ä¹¦å’Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ TLS Bootstrapping Token å¯é€‰çš„: é›†ç¾¤æ­å»ºæˆåŠŸåç«‹å³æ¸…é™¤ Bootstrap Token Secretï¼Œæˆ–ç­‰å¾… Controller Manager å¾…å…¶è¿‡æœŸååˆ é™¤ï¼Œä»¥é˜²æ­¢è¢«æ¶æ„åˆ©ç”¨ äºŒã€æ‰‹åŠ¨æ‰¹å‡†2.1 åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯","text":"ä¸€ã€æ¦‚è¿°æœ¬æ–‡ä¸»è¦è®°å½•ä¸€ä¸‹æ­å»ºä¸€ä¸ªkubeletæ­å»ºåˆ°åŠ å…¥é›†ç¾¤åˆ°æ‰‹åŠ¨ã€è‡ªåŠ¨(è¯ä¹¦è½®æ¢çš„)è¯ä¹¦è®¤è¯è¿‡ç¨‹, é‚£ä¹ˆæˆ‘çš„ç¯å¢ƒæ˜¯ç”¨çš„v1.12.4ç‰ˆæœ¬ï¼Œæœ‰ä¸€å°master,é™¤äº†masterä¸Šé¢çš„ä¸€äº›ç»„ä»¶å·²ç»æ­å»ºå®Œæ¯•ï¼Œä¸»è¦é‡ç‚¹æ˜¯åœ¨kubeletä¸Šé¢ï¼Œæ‰€ä»¥ç°åœ¨å°±æ˜¯masterå·²ç»å·¥ä½œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼ŒåŠ å…¥æ–°çš„kubelet(workerèŠ‚ç‚¹)éœ€è¦åšä¸€äº›ä»€ä¹ˆæ ·çš„æ“ä½œã€‚ç„¶åéœ€è¦å®ç°çš„æ˜¯: é€šè¿‡bootstrap tokenä»¥åŠboostrap.kubeconfigæ¥å¼•å¯¼workerèŠ‚ç‚¹ç”³è¯·è¯ä¹¦ å¦‚æœç¬¬ä¸€æ­¥ç”³è¯·å‘å‡ºå»ä¹‹åï¼Œåœ¨æ‰‹åŠ¨åœ¨masterç«¯è¿›è¡Œæ‰‹åŠ¨æ‰¹å‡†è¯ä¹¦ç”³è¯·ï¼Œç„¶åå‘æ”¾kubeletè¯ä¹¦ å®ç°kubeletè¯ä¹¦çš„è‡ªåŠ¨æ‰¹å‡† å®ç°kubeletè¯ä¹¦çš„è‡ªåŠ¨è½®æ¢æ“ä½œ ç®€å•ç†ä¸€ä¸‹TLS Bootstrappingçš„ä¸€ä¸ªå¼•å¯¼è¿‡ç¨‹ masterç«¯åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯å³ç”Ÿæˆ apiserver.pem/apiserver-key.pem/apiserver.csr; åœ¨é›†ç¾¤å†…åˆ›å»ºç‰¹å®šçš„ Bootstrap Token Secretï¼Œè¯¥ Secret å°†æ›¿ä»£ä»¥å‰çš„ token.csv å†…ç½®ç”¨æˆ·å£°æ˜æ–‡ä»¶; åœ¨é›†ç¾¤å†…åˆ›å»ºé¦–æ¬¡ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„ ClusterRole å³system:node-bootstrapper,å¹¶å°†ä¸Šé¢çš„bootstrap token secretè¿›è¡Œç»‘å®šå³ clusterrolebinding kubelet-bootstrapï¼Œè¿™æ ·é€šè¿‡ç»‘å®šå°±èƒ½ä»¥è¿™ä¸ªå†…ç½®ç”¨æˆ·ç»„ä¿¡æ¯å»å‘èµ·CSRè¯·æ±‚å•¦ï¼› ç”Ÿæˆç‰¹å®šçš„åŒ…å« TLS Bootstrapping Token çš„ bootstrap.kubeconfig; è°ƒæ•´kubeleteå¯åŠ¨å‚æ•°ï¼ŒæŒ‡å®šå¼•å¯¼æ–‡ä»¶bootstrap.kubeconfig; é‡è½½é…ç½®ã€é‡å¯æœåŠ¡ï¼Œmasterç«¯æ‰‹åŠ¨æ‰¹å‡†å®ŒæˆworkerèŠ‚ç‚¹çš„CSRè¯·æ±‚; åç»­å¦‚æœæ²¡æœ‰é…ç½®è¯ä¹¦è½®æ¢çš„è¯ï¼Œå°±ä¼šä¸€ç›´ä½¿ç”¨ç”±controller-manageræ‰¹å‡†é¢å‘çš„è¯ä¹¦æ–‡ä»¶äº†ï¼Œæœ‰æ•ˆæœŸæ˜¯ä¸€å¹´ã€‚(è‡ªåŠ¨æ‰¹å‡†&amp;è¯ä¹¦è½®æ¢ä¸‹é¢å†è¯´) å½“ç„¶ä»¥æˆ‘çš„ç†è§£è¦è¦å®ç°è¯ä¹¦è½®æ¢é‚£ä¹ˆè‚¯å®šæ˜¯æ²¡æœ‰å¤–ç•Œå¹²é¢„çš„æƒ…å†µä¸‹è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œé‚£è¿™ä¸ªåŠŸèƒ½ä¹Ÿè‚¯å®šæ˜¯éœ€è¦è‡ªåŠ¨æ‰¹å‡†è¿™ä¸ªåŠŸèƒ½çš„ã€‚ é‚£ä¹ˆè‡ªåŠ¨æ‰¹å‡†éœ€è¦åšçš„ä¸€äº›äº‹æƒ…å´æ˜¯åœ¨æ‰‹åŠ¨æ‰¹å‡†çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›æ“ä½œ: åˆ›å»ºCSRè¯·æ±‚çš„ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„renew Kubelet client/server çš„ ClusterRoleï¼Œä»¥åŠå…¶ç›¸å…³å¯¹åº”çš„ ClusterRoleBindingï¼›å¹¶ç»‘å®šåˆ°å¯¹åº”çš„ç»„æˆ–ç”¨æˆ· è°ƒæ•´ Controller Manager é…ç½®ï¼Œä»¥ä½¿å…¶èƒ½è‡ªåŠ¨ç­¾ç½²ç›¸å…³è¯ä¹¦å’Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ TLS Bootstrapping Token å¯é€‰çš„: é›†ç¾¤æ­å»ºæˆåŠŸåç«‹å³æ¸…é™¤ Bootstrap Token Secretï¼Œæˆ–ç­‰å¾… Controller Manager å¾…å…¶è¿‡æœŸååˆ é™¤ï¼Œä»¥é˜²æ­¢è¢«æ¶æ„åˆ©ç”¨ äºŒã€æ‰‹åŠ¨æ‰¹å‡†2.1 åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯æˆ‘è¿™é‡Œå·²ç»æœ‰caæ ¹è¯ä¹¦æ–‡ä»¶äº†ï¼Œé‚£å°±ä»åˆ›å»ºapiserverè¯ä¹¦å¼€å§‹ 12345678910111213141516171819202122232425262728$ cat &gt;&gt; apiserver-csr.json &lt;&lt; EOF{ \"CN\": \"kube-apiserver\", \"hosts\": [ \"10.96.0.1\", \"127.0.0.1\", \"192.168.56.201\", \"kubernetes\", \"kubernetes.default\", \"kubernetes.default.svc\", \"kubernetes.default.svc.cluster\", \"kubernetes.default.svc.cluster.local\" ], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"Hangzhou\", \"L\": \"Hangzhou\", \"O\": \"Kubernetes\", \"OU\": \"Kubernetes-manual\" } ]}EOF æˆ‘è¿™é‡Œå°±å•å°master,æ‰€ä»¥å°±å†™äº†ä¸ªè¿™ä¸€ä¸ªIPåœ°å€ 12345678910# æ‰§è¡Œåˆ›å»º:$cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ apiserver-csr.json | cfssljson -bare ${PKI_DIR}/apiserverls /etc/kubernetes/pki/apiserver*.pem/etc/kubernetes/pki/apiserver-key.pem /etc/kubernetes/pki/apiserver.pem 2.2 åˆ›å»ºå¼•å¯¼é…ç½®æ–‡ä»¶ bootstrap-kubelet.kubeconfig2.2.1 ç”Ÿæˆbootsrapâ€”token123export TOKEN_ID=$(openssl rand 3 -hex)export TOKEN_SECRET=$(openssl rand 8 -hex)export BOOTSTRAP_TOKEN=${TOKEN_ID}.${TOKEN_SECRET} å…³äºè¿™ä¸ªtokençš„æ ¼å¼è¦æ±‚å‚è§è¿™é‡Œ 2.2.2 åˆ›å»ºboostrap token secret123456789101112131415161718192021222324252627282930313233343536cat &gt;&gt; bootstrap-token-Secret.yml &lt;&lt; EOFapiVersion: v1kind: Secretmetadata: name: bootstrap-token-{TOKEN_ID} namespace: kube-systemtype: bootstrap.kubernetes.io/tokenstringData: token-id: {TOKEN_ID} token-secret: {TOKEN_SECRET} usage-bootstrap-authentication: \"true\" usage-bootstrap-signing: \"true\" auth-extra-groups: system:bootstrappers:default-node-tokenEOF# å°†ä»¥ä¸Šå˜é‡èµ‹å€¼è¿›å»sed -ri \"s#\\{TOKEN_ID\\}#${TOKEN_ID}#g\" bootstrap-token-Secret.ymlsed -ri \"/token-id/s#\\S+\\$#'&amp;'#\" resources/bootstrap-token-Secret.ymlsed -ri \"s#\\{TOKEN_SECRET\\}#${TOKEN_SECRET}#g\" resources/bootstrap-token-Secret.ymlkubectl create -f resources/bootstrap-token-Secret.yml# æŸ¥çœ‹è¯¦æƒ…ï¼Œä¸€å®šè¦æ”¾åˆ°kube-systemè¿™ä¸ªnamespace$ kubectl describe secret bootstrap-token-b8cf79 -n kube-systemName: bootstrap-token-b8cf79Namespace: kube-systemLabels: &lt;none&gt;Annotations:Type: bootstrap.kubernetes.io/tokenData====auth-extra-groups: 39 bytestoken-id: 6 bytestoken-secret: 16 bytesusage-bootstrap-authentication: 4 bytesusage-bootstrap-signing: 4 bytes 2.2.2 åˆ›å»ºå¯åŠ¨å¼•å¯¼é…ç½®123456789101112131415161718192021# bootstrap set cluster$ kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=192.168.56.202 \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig# bootstrap set credentials$ kubectl config set-credentials tls-bootstrap-token-user \\ --token=${BOOTSTRAP_TOKEN} \\ --kubeconfig=/etc/kubernetes//bootstrap-kubelet.kubeconfig# bootstrap set context$ kubectl config set-context tls-bootstrap-token-user@kubernetes \\ --cluster=kubernetes \\ --user=tls-bootstrap-token-user \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig# bootstrap use default context$ kubectl config use-context tls-bootstrap-token-user@kubernetes \\ --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig è¯¥æ–‡ä»¶ç”Ÿæˆä¹‹åéœ€è¦æ‹·è´è‡³workerèŠ‚ç‚¹ä¸Šé¢å»ï¼Œå¹¶ä¸”ä¿®æ”¹é…ç½®ï¼ŒæŒ‡å®šè¯¥å¼•å¯¼é…ç½®æ–‡ä»¶è¿™ä¸ªæµç¨‹åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæœ‰æè¿°:bootstrapåˆå§‹åŒ–è¿‡ç¨‹ 2.2.3 è°ƒæ•´workerèŠ‚ç‚¹kubeletå¯åŠ¨é…ç½®æ–‡ä»¶åŠ ä¸Šè¿™ä¸ªå¼•å¯¼æ–‡ä»¶(å‚æ•°)123456789101112[Service]ExecStart=/usr/local/bin/kubelet --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\ --network-plugin=cni \\ --cni-conf-dir=/etc/cni/net.d \\ --cni-bin-dir=/opt/cni/bin \\ --logtostderr=false \\ --log-dir=/etc/kubernetes/log \\ --config=/etc/kubernetes/kubelet-conf.yml \\ --node-labels=node-role.kubernetes.io/master='' \\ --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1 \\ --v=2 æ­¤æ—¶å¦‚æœå¯åŠ¨kubeletæœåŠ¡çš„è¯åœ¨apiserverå°†ä¼šæŠ¥é”™ï¼š è¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œkubelet é€šè¿‡ bootstrap.kubeconfig ä¸­çš„é¢„è®¾ç”¨æˆ· Token å£°æ˜äº†è‡ªå·±çš„èº«ä»½ï¼Œç„¶ååˆ›å»º CSR è¯·æ±‚ï¼›ä½†æ˜¯ä¸è¦å¿˜è®°è¿™ä¸ªç”¨æˆ·åœ¨æˆ‘ä»¬ä¸å¤„ç†çš„æƒ…å†µä¸‹ä»–æ²¡ä»»ä½•æƒé™çš„ï¼ŒåŒ…æ‹¬åˆ›å»º CSR è¯·æ±‚ï¼›æ‰€ä»¥éœ€è¦å¦‚ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ª ClusterRoleBindingï¼Œå°†é¢„è®¾ç”¨æˆ· kubelet-bootstrap ä¸å†…ç½®çš„ ClusterRole system:node-bootstrapper ç»‘å®šåˆ°ä¸€èµ·ï¼Œä½¿å…¶èƒ½å¤Ÿå‘èµ· CSR è¯·æ±‚ 1234567891011121314cat &gt;&gt; kubelet-bootstrap-clusterrolebinding.yaml &lt;&lt; EOFapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: kubelet-bootstraproleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:node-bootstrappersubjects:- apiGroup: rbac.authorization.k8s.io kind: Group name: system:bootstrappers:default-node-tokenEOF å°†ä¸Šé¢åˆ›å»ºåå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡æ‰‹åŠ¨æ‰¹å‡†ä¹‹åworkerèŠ‚ç‚¹å°±åŠ å…¥åˆ°é›†ç¾¤å½“ä¸­æ¥äº†è€Œä¸”åœ¨workerèŠ‚ç‚¹çš„/var/lib/kubelet/pkiç›®å½•ä¸‹å·²ç»è·å¾—controller-manageré¢å‘ä¸‹æ¥çš„è¯ä¹¦,å¹¶ä¸”è¿˜åˆ†å‘äº†ä¸€ä¸ªkubelet.kubeconfigçš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶è™½ç„¶é…ç½®ä¸­æŒ‡å®šäº†ï¼Œä½†è¿™ä¸ªä¹Ÿæ˜¯ç”±controller-manageråˆ†å‘ç»™workerèŠ‚ç‚¹çš„ã€‚ 123456[root@k8s-n0 kubernetes]# ll /var/lib/kubelet/pki/total 12-rw------- 1 root root 1293 Dec 30 10:14 kubelet-client-2018-12-30-10-14-50.pemlrwxrwxrwx 1 root root 59 Dec 30 10:14 kubelet-client-current.pem -&gt; /var/lib/kubelet/pki/kubelet-client-2018-12-30-10-14-50.pem-rw-r--r-- 1 root root 2153 Dec 30 10:14 kubelet.crt-rw------- 1 root root 1679 Dec 30 10:14 kubelet.key è¿˜æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œé›†ç¾¤å·²ç»å®Œæˆï¼Œåœ¨æˆ‘æ‰§è¡Œexecæƒ³è¿›å…¥ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™å´å‡ºç°äº†forbiddençš„é—®é¢˜: 12[root@k8s-m1 resources]# kubectl exec -it kubectl-terminal-ubuntu /bin/basherror: unable to upgrade connection: Forbidden (user=kube-apiserver, verb=create, resource=nodes, subresource=proxy) è¿™æ˜¯å› ä¸ºkube-apiserveruserå¹¶æ²¡æœ‰nodesçš„èµ„æºå­˜å–æƒé™,å±äºæ­£å¸¸ã€‚ç”±äº API æƒé™,æ•…éœ€è¦å»ºç«‹ä¸€ä¸ª RBAC Role æ¥è·å–å­˜å–æƒé™; 1234567891011121314151617181920212223242526272829303132333435cat &gt;&gt; apiserver-to-kubelet-rbac.yml &lt;&lt; EOFapiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \"true\" labels: kubernetes.io/bootstrapping: rbac-defaults name: system:kube-apiserver-to-kubeletrules: - apiGroups: - \"\" resources: - nodes/proxy - nodes/stats - nodes/log - nodes/spec - nodes/metrics verbs: - \"*\"---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: system:kube-apiserver namespace: \"\"roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:kube-apiserver-to-kubeletsubjects: - apiGroup: rbac.authorization.k8s.io kind: User name: kube-apiserverEOF åˆ›å»ºå¥½ä¹‹åå°±å¯ä»¥execå•¦~ ä»¥ä¸Šï¼ŒTLS Bootstrappingçš„æ‰‹åŠ¨æ‰¹å‡†å·²ç»å®Œæˆã€‚ ä¸‰ã€è‡ªåŠ¨æ‰¹å‡†ä¸Šé¢å·²ç»å®Œæˆäº†æ‰‹åŠ¨æ‰¹å‡†çš„æ“ä½œï¼Œé‚£æ¥ä¸‹æ¥å°±æ˜¯å®ç°ä»¥ä¸‹è‡ªåŠ¨æ‰¹å‡†ä»¥åŠè¯ä¹¦è½®æ¢çš„å®ç° ä¸Šé¢éœ€è¦çš„é…ç½®å…¶å®éƒ½å·®ä¸å¤šäº†ï¼Œåªéœ€è¦å†åšä¸€äº›é…ç½®å³å¯å®Œæˆï¼› kubelet æ‰€å‘èµ·çš„ CSR è¯·æ±‚æ˜¯ç”± controller manager ç­¾ç½²çš„ï¼›å¦‚æœæƒ³è¦æ˜¯å®ç°è‡ªåŠ¨ç»­æœŸï¼Œå°±éœ€è¦è®© controller manager èƒ½å¤Ÿåœ¨ kubelet å‘èµ·è¯ä¹¦è¯·æ±‚çš„æ—¶å€™è‡ªåŠ¨å¸®åŠ©å…¶ç­¾ç½²è¯ä¹¦ï¼›é‚£ä¹ˆ controller manager ä¸å¯èƒ½å¯¹æ‰€æœ‰çš„ CSR è¯ä¹¦ç”³è¯·éƒ½è‡ªåŠ¨ç­¾ç½²ï¼Œè¿™æ—¶å€™å°±éœ€è¦é…ç½® RBAC è§„åˆ™ï¼Œä¿è¯ controller manager åªå¯¹ kubelet å‘èµ·çš„ç‰¹å®š CSR è¯·æ±‚è‡ªåŠ¨æ‰¹å‡†å³å¯ï¼›åœ¨ TLS bootstrapping å®˜æ–¹æ–‡æ¡£ä¸­ï¼ŒCSRæœ‰ä¸‰ç§è¯·æ±‚ç±»å‹: nodeclient: kubelet ä»¥ O=system:nodes å’Œ CN=system:node:(node name) å½¢å¼å‘èµ·çš„ CSR è¯·æ±‚ selfnodeclient: kubelet client renew è‡ªå·±çš„è¯ä¹¦å‘èµ·çš„ CSR è¯·æ±‚(ä¸ä¸Šä¸€ä¸ªè¯ä¹¦å°±æœ‰ç›¸åŒçš„ O å’Œ CN) selfnodeserver: kubelet server renew è‡ªå·±çš„è¯ä¹¦å‘èµ·çš„ CSR è¯·æ±‚ é€šä¿—ç‚¹è®²å°±æ˜¯:nodeclient ç±»å‹çš„ CSR ä»…åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ä¼šäº§ç”Ÿï¼Œselfnodeclient ç±»å‹çš„ CSR è¯·æ±‚å®é™…ä¸Šå°±æ˜¯ kubelet renew è‡ªå·±ä½œä¸º client è·Ÿ apiserver é€šè®¯æ—¶ä½¿ç”¨çš„è¯ä¹¦äº§ç”Ÿçš„ï¼Œselfnodeserver ç±»å‹çš„ CSR è¯·æ±‚åˆ™æ˜¯ kubelet é¦–æ¬¡ç”³è¯·æˆ–åç»­ renew è‡ªå·±çš„ 10250 api ç«¯å£è¯ä¹¦æ—¶äº§ç”Ÿçš„ é‚£ä¹ˆé’ˆå¯¹ä»¥ä¸Š3ç§CSRè¯·æ±‚åˆ†åˆ«ç»™å‡ºäº†3ç§å¯¹åº”çš„ ClusterRoleï¼Œå¦‚ä¸‹æ‰€ç¤º 1234567891011121314151617181920212223242526272829303132# A ClusterRole which instructs the CSR approver to approve a user requesting# node client credentials.kind: ClusterRoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: system:certificates.k8s.io:certificatesigningrequests:nodeclientrules:- apiGroups: [\"certificates.k8s.io\"] resources: [\"certificatesigningrequests/nodeclient\"] verbs: [\"create\"]---# A ClusterRole which instructs the CSR approver to approve a node renewing its# own client credentials.kind: ClusterRoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclientrules:- apiGroups: [\"certificates.k8s.io\"] resources: [\"certificatesigningrequests/selfnodeclient\"] verbs: [\"create\"]---# A ClusterRole which instructs the CSR approver to approve a node requesting a# serving cert matching its client cert.kind: ClusterRoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserverrules:- apiGroups: [\"certificates.k8s.io\"] resources: [\"certificatesigningrequests/selfnodeserver\"] verbs: [\"create\"] å…¶ä¸­selfnodeclient,nodeclient å·²ç»æ˜¯é›†ç¾¤å†…ç½®çš„äº†; 1234567$ kubectl get clusterrole............system:certificates.k8s.io:certificatesigningrequests:nodeclient 28hsystem:certificates.k8s.io:certificatesigningrequests:selfnodeclient 28h............ ç„¶åæ˜¯ä¸‰ä¸ª ClusterRole å¯¹åº”çš„ ä¸‰ä¸ªClusterRoleBindingï¼›éœ€è¦æ³¨æ„çš„æ˜¯ åœ¨ä½¿ç”¨ Bootstrap Token è¿›è¡Œå¼•å¯¼æ—¶ï¼ŒKubelet ç»„ä»¶ä½¿ç”¨ Token å‘èµ·çš„è¯·æ±‚å…¶ç”¨æˆ·åä¸ºsystem:bootstrap:&lt;token id&gt;ï¼Œç”¨æˆ·ç»„ä¸º system:bootstrappersï¼›æ‰€ä»¥ æˆ‘ä»¬åœ¨åˆ›å»º ClusterRoleBinding æ—¶è¦ç»‘å®šåˆ°è¿™ä¸ªç”¨æˆ·æˆ–è€…ç»„ä¸Šï¼›è¿™é‡Œæˆ‘é€‰æ‹©å…¨éƒ¨ç»‘å®šåˆ°ç»„ä¸Šï¼š 12345678910111213cat &gt;&gt; kubelet-bootstrap-rbac.yml &lt;&lt; EOF# å…è®¸ system:bootstrappers ç»„ç”¨æˆ·åˆ›å»º CSR è¯·æ±‚# (è¿™ä¸€æ­¥æˆ‘åœ¨ä¸Šé¢å·²ç»åšè¿‡å•¦)kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers# è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚kubectl create clusterrolebinding node-client-auto-approve-csr --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient --group=system:bootstrappers# è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚kubectl create clusterrolebinding node-client-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient --group=system:nodes# è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet 10250 api ç«¯å£è¯ä¹¦çš„ CSR è¯·æ±‚kubectl create clusterrolebinding node-server-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeserver --group=system:nodes å³: kubelet workerèŠ‚ç‚¹è¯ä¹¦æ‰‹åŠ¨æˆ–è‡ªåŠ¨æ‰¹å‡†éœ€è¦ç”¨åˆ°çš„è§’è‰²ä»¥åŠè§’è‰²ç»‘å®šæœ‰: 1234567891011121314151617181920212223# ClusterRole$ kubectl get clusterrole............system:certificates.k8s.io:certificatesigningrequests:nodeclient 2dsystem:certificates.k8s.io:certificatesigningrequests:selfnodeclient 2dsystem:certificates.k8s.io:certificatesigningrequests:selfnodeserver 5msystem:node-bootstrapper 2dsystem:kube-apiserver-to-kubelet 17h............# ClusterRoleBinding$ kubectl get clusterrolebinding | grep auto............node-client-auto-approve-csr 16hnode-client-auto-renew-crt 16hnode-server-auto-renew-crt 16hsystem:kube-apiserver 17hkubelet-bootstrap 18h............ åˆ›å»ºå¥½å¯¹åº”çš„è§’è‰²åŠè§’è‰²ç»‘å®šä¹‹åå°±å¯ä»¥ä¿®æ”¹è¿™ä¸ªè¯ä¹¦çš„æœ‰æ•ˆæœŸå•¦ï¼›åªè¦åœ¨Description=Kubernetes Controller Manager æœåŠ¡çš„å¯åŠ¨é…ç½®å‚æ•°ä¸­åŠ å…¥: 123--experimental-cluster-signing-duration=10m0s \\--feature-gates=RotateKubeletClientCertificate=true \\--feature-gates=RotateKubeletServerCertificate=true ä»¥åŠkubeletæœåŠ¡å¯åŠ¨é…ç½®å‚æ•°ä¸­åŠ å…¥: 12--feature-gates=RotateKubeletClientCertificate=true \\--feature-gates=RotateKubeletServerCertificate=true é€šè¿‡æ–‡æ¡£äº†è§£åˆ°--feature-gates è¿™ä¸ªæ˜¯kubernetesä¸­ç‰¹æœ‰çš„ä¸€äº›åŠŸèƒ½ï¼Œæœ‰äº›åŠŸèƒ½æ˜¯å¤„äºå¼€å‘ç‰ˆæœ¬çš„ï¼Œå…·ä½“å¯ä»¥å‚çœ‹è¿™é‡Œ ä»¥ä¸‹å°±æ˜¯kubeletè¿è¡Œä¸€æ®µæ—¶é—´åï¼Œé€šè¿‡åœ¨controller-managerè®¾ç½®çš„è¯ä¹¦æœ‰æ•ˆæœŸå¿«è¿‡æœŸçš„æ—¶å€™é€šè¿‡è‡ªåŠ¨ç”³è¯·å¹¶è‡ªåŠ¨æ‰¹å‡†çš„ç»“æœï¼›å¯ä»¥çœ‹å‡ºæ¥node-csr-ysGrNbyioCNnj3UUFiQGn5WwLGF1P6wJ4DTIib1IcqQ è¿™ä¸ªCSRæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶çš„ç”¨æˆ·system:bootstrap:fd2f4fçš„è¯ä¹¦è¯·æ±‚ã€‚ å¹¶ä¸”åœ¨è¯ä¹¦è½®æ¢çš„è¿‡ç¨‹ä¹Ÿå¯ä»¥é€šè¿‡æ—¥å¿—å‘ç° 1Dec 31 04:10:06 k8s-n0 kubelet: I1231 17:10:06.753064 18294 transport.go:132] certificate rotation detected, shutting down client connections to start using new credentials é‚£ä¹ˆä»¥ä¸Šå°±æ˜¯kubeletè¯ä¹¦çš„æ•´ä¸ªæ‰¹å‡†ä»¥åŠè¯ä¹¦è½®æ¢çš„è¿‡ç¨‹ã€‚ å››ã€TLS Bootstrappingæ€»ç»“æµç¨‹æ€»ç»“ kubelet é¦–æ¬¡å¯åŠ¨é€šè¿‡åŠ è½½ bootstrap.kubeconfig ä¸­çš„ç”¨æˆ· Token å’Œ apiserver CA è¯ä¹¦å‘èµ·é¦–æ¬¡ CSR è¯·æ±‚ï¼Œè¿™ä¸ª Token è¢«é¢„å…ˆå†…ç½®åœ¨ apiserver èŠ‚ç‚¹çš„ token.csv(æ–°ç‰ˆæœ¬ä¸­å·²ç»æ¨èä½¿ç”¨Bootstrap Token Secert) ä¸­ï¼Œå…¶èº«ä»½ä¸º kubelet-bootstrap ç”¨æˆ·å’Œ system:bootstrappers ç”¨æˆ·ç»„ï¼›æƒ³è¦é¦–æ¬¡ CSR è¯·æ±‚èƒ½æˆåŠŸ(æˆåŠŸæŒ‡çš„æ˜¯ä¸ä¼šè¢« apiserver 401 æ‹’ç»)ï¼Œåˆ™éœ€è¦å…ˆå°† kubelet-bootstrap ç”¨æˆ·å’Œ system:node-bootstrapper å†…ç½® ClusterRole ç»‘å®šï¼› å¯¹äºé¦–æ¬¡ CSR è¯·æ±‚å¯ä»¥æ‰‹åŠ¨ç­¾å‘ï¼Œä¹Ÿå¯ä»¥å°† system:bootstrappers ç”¨æˆ·ç»„ä¸ approve-node-client-csr ClusterRole ç»‘å®šå®ç°è‡ªåŠ¨ç­¾å‘(1.8 ä¹‹å‰è¿™ä¸ª ClusterRole éœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼Œ1.8 å apiserver è‡ªåŠ¨åˆ›å»ºï¼Œå¹¶æ›´åä¸º system:certificates.k8s.io:certificatesigningrequests:nodeclient) é»˜è®¤ç­¾ç½²çš„çš„è¯ä¹¦åªæœ‰ 1 å¹´æœ‰æ•ˆæœŸï¼Œå¦‚æœæƒ³è¦è°ƒæ•´è¯ä¹¦æœ‰æ•ˆæœŸå¯ä»¥é€šè¿‡è®¾ç½® kube-controller-manager çš„ --experimental-cluster-signing-duration å‚æ•°å®ç°ï¼Œè¯¥å‚æ•°é»˜è®¤å€¼ä¸º 8760h0m0s å¯¹äºè¯ä¹¦è½®æ¢ï¼Œéœ€è¦é€šè¿‡åè°ƒä¸¤ä¸ªæ–¹é¢å®ç°ï¼›ç¬¬ä¸€ï¼Œæƒ³è¦ kubelet åœ¨è¯ä¹¦åˆ°æœŸåè‡ªåŠ¨å‘èµ·ç»­æœŸè¯·æ±‚ï¼Œåˆ™éœ€è¦åœ¨ kubelet å¯åŠ¨æ—¶å¢åŠ  --feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true æ¥å®ç°ï¼›ç¬¬äºŒï¼Œæƒ³è¦è®© controller manager è‡ªåŠ¨æ‰¹å‡†ç»­ç­¾çš„ CSR è¯·æ±‚éœ€è¦åœ¨ controller manager å¯åŠ¨æ—¶å¢åŠ  --feature-gates=RotateKubeletServerCertificate=true å‚æ•°ï¼Œå¹¶ç»‘å®šå¯¹åº”çš„ RBAC è§„åˆ™","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/tags/kubernetes/"},{"name":"TLS bootstrapping","slug":"TLS-bootstrapping","permalink":"https://blog.sctux.cc/tags/TLS-bootstrapping/"},{"name":"è¯ä¹¦æ‰‹åŠ¨ç­¾å‘","slug":"è¯ä¹¦æ‰‹åŠ¨ç­¾å‘","permalink":"https://blog.sctux.cc/tags/%E8%AF%81%E4%B9%A6%E6%89%8B%E5%8A%A8%E7%AD%BE%E5%8F%91/"},{"name":"è¯ä¹¦è‡ªåŠ¨ç­¾å‘","slug":"è¯ä¹¦è‡ªåŠ¨ç­¾å‘","permalink":"https://blog.sctux.cc/tags/%E8%AF%81%E4%B9%A6%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%8F%91/"},{"name":"è¯ä¹¦è½®æ¢(è‡ªåŠ¨ç»­æœŸ)","slug":"è¯ä¹¦è½®æ¢-è‡ªåŠ¨ç»­æœŸ","permalink":"https://blog.sctux.cc/tags/%E8%AF%81%E4%B9%A6%E8%BD%AE%E6%8D%A2-%E8%87%AA%E5%8A%A8%E7%BB%AD%E6%9C%9F/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"ç†è§£Kuberneteså®‰å…¨çš„æŒä¹…åŒ–ä¿å­˜é”®å€¼-Etcd","slug":"kubernetes-etcd-secret","date":"2018-12-23T06:47:38.000Z","updated":"2025-09-01T01:59:08.942Z","comments":true,"path":"2018/12/23/kubernetes-etcd-secret/","permalink":"https://blog.sctux.cc/2018/12/23/kubernetes-etcd-secret/","excerpt":"æ¦‚è¿°etcdæ˜¯CoreOSå›¢é˜Ÿäº2013å¹´6æœˆå‘èµ·çš„å¼€æºé¡¹ç›®ï¼Œå®ƒçš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªé«˜å¯ç”¨çš„åˆ†å¸ƒå¼é”®å€¼(key-value)æ•°æ®åº“ã€‚etcdå†…éƒ¨é‡‡ç”¨raftåè®®ä½œä¸ºä¸€è‡´æ€§ç®—æ³•ï¼ŒetcdåŸºäºGoè¯­è¨€å®ç°ã€‚ etcdä½œä¸ºæœåŠ¡å‘ç°ç³»ç»Ÿï¼Œæœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š ç®€å•ï¼šå®‰è£…é…ç½®ç®€å•ï¼Œè€Œä¸”æä¾›äº†HTTP APIè¿›è¡Œäº¤äº’ï¼Œä½¿ç”¨ä¹Ÿå¾ˆç®€å•å®‰å…¨ï¼šæ”¯æŒSSLè¯ä¹¦éªŒè¯å¿«é€Ÿï¼šæ ¹æ®å®˜æ–¹æä¾›çš„benchmarkæ•°æ®ï¼Œå•å®ä¾‹æ”¯æŒæ¯ç§’2k+è¯»æ“ä½œå¯é ï¼šé‡‡ç”¨raftç®—æ³•ï¼Œå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®çš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§ etcdé¡¹ç›®åœ°å€ï¼šhttps://github.com/coreos/etcd/ kubernetesä¸­çš„ä½¿ç”¨ç›®å‰etcdæ˜¯ä½œä¸ºkubernetesé›†ç¾¤å½“ä¸­çš„å­˜å‚¨åç«¯ åœ¨kuernetesä¸­etcdæ¶‰åŠåˆ°çš„å®‰å…¨ç›¸å…³çš„ä¸»è¦æœ‰: etcdæ”¯æŒå¤‡ä»½æ¢å¤æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®è¢«è¯¯åˆ å¯¼è‡´æ•°æ®ä¸¢å¤± ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯å»ºè®®æ”¾åœ¨secretç±»å‹çš„èµ„æºä¸­ï¼Œè¯¥ç±»å‹èµ„æºæ˜¯åŠ å¯†å­˜å‚¨åœ¨etcdä¸­çš„ etcdæ”¯æŒhttps, kube-apiserverè®¿é—®etcdä½¿ç”¨httpsåè®®","text":"æ¦‚è¿°etcdæ˜¯CoreOSå›¢é˜Ÿäº2013å¹´6æœˆå‘èµ·çš„å¼€æºé¡¹ç›®ï¼Œå®ƒçš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªé«˜å¯ç”¨çš„åˆ†å¸ƒå¼é”®å€¼(key-value)æ•°æ®åº“ã€‚etcdå†…éƒ¨é‡‡ç”¨raftåè®®ä½œä¸ºä¸€è‡´æ€§ç®—æ³•ï¼ŒetcdåŸºäºGoè¯­è¨€å®ç°ã€‚ etcdä½œä¸ºæœåŠ¡å‘ç°ç³»ç»Ÿï¼Œæœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š ç®€å•ï¼šå®‰è£…é…ç½®ç®€å•ï¼Œè€Œä¸”æä¾›äº†HTTP APIè¿›è¡Œäº¤äº’ï¼Œä½¿ç”¨ä¹Ÿå¾ˆç®€å•å®‰å…¨ï¼šæ”¯æŒSSLè¯ä¹¦éªŒè¯å¿«é€Ÿï¼šæ ¹æ®å®˜æ–¹æä¾›çš„benchmarkæ•°æ®ï¼Œå•å®ä¾‹æ”¯æŒæ¯ç§’2k+è¯»æ“ä½œå¯é ï¼šé‡‡ç”¨raftç®—æ³•ï¼Œå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®çš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§ etcdé¡¹ç›®åœ°å€ï¼šhttps://github.com/coreos/etcd/ kubernetesä¸­çš„ä½¿ç”¨ç›®å‰etcdæ˜¯ä½œä¸ºkubernetesé›†ç¾¤å½“ä¸­çš„å­˜å‚¨åç«¯ åœ¨kuernetesä¸­etcdæ¶‰åŠåˆ°çš„å®‰å…¨ç›¸å…³çš„ä¸»è¦æœ‰: etcdæ”¯æŒå¤‡ä»½æ¢å¤æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®è¢«è¯¯åˆ å¯¼è‡´æ•°æ®ä¸¢å¤± ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯å»ºè®®æ”¾åœ¨secretç±»å‹çš„èµ„æºä¸­ï¼Œè¯¥ç±»å‹èµ„æºæ˜¯åŠ å¯†å­˜å‚¨åœ¨etcdä¸­çš„ etcdæ”¯æŒhttps, kube-apiserverè®¿é—®etcdä½¿ç”¨httpsåè®® åœ¨kubernetesä¸­çš„é…ç½®: Client -&gt; Server123456789101112client-transport-security: # é€šé“ä»¥TLSåè®®åŠ å¯† ca-file: '/etc/etcd/ssl/etcd-ca.pem' cert-file: '/etc/etcd/ssl/etcd.pem' key-file: '/etc/etcd/ssl/etcd-key.pem' # æœåŠ¡ç«¯ä¼šè®¤è¯å®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦å—ä¿¡ä»»CAç­¾å‘ client-cert-auth: true trusted-ca-file: '/etc/etcd/ssl/etcd-ca.pem' # æ˜¯å¦ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆè¯ä¹¦ auto-tls: true Server -&gt; Server123456789101112peer-transport-security: # é€šé“ä»¥TLSåè®®åŠ å¯† ca-file: '/etc/etcd/ssl/etcd-ca.pem' cert-file: '/etc/etcd/ssl/etcd.pem' key-file: '/etc/etcd/ssl/etcd-key.pem' # æœåŠ¡ç«¯ä¼šè®¤è¯å®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦å—ä¿¡ä»»CAç­¾å‘ peer-client-cert-auth: true trusted-ca-file: '/etc/etcd/ssl/etcd-ca.pem' # æ˜¯å¦ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆè¯ä¹¦ auto-tls: true etcdçš„å¤‡ä»½å¯¹äº API 3 å¤‡ä»½ä¸æ¢å¤æ–¹æ³•å®˜æ–¹ v3 admin guideåœ¨ä½¿ç”¨ API 3 æ—¶éœ€è¦ä½¿ç”¨ç¯å¢ƒå˜é‡ ETCDCTL_API æ˜ç¡®æŒ‡å®šã€‚åœ¨å‘½ä»¤è¡Œè®¾ç½®ï¼š 1$ export ETCDCTL_API=3 å¤‡ä»½æ•°æ®ï¼š 12$ etcdctl --endpoints=[localhost:2379] snapshot save snapshot.db æ¢å¤ï¼š 1$ etcdctl snapshot restore snapshot.db --name m3 --data-dir=/home/etcd_data æ¢å¤åçš„æ–‡ä»¶éœ€è¦ä¿®æ”¹æƒé™ä¸º etcd:etcdâ€“name:é‡æ–°æŒ‡å®šä¸€ä¸ªæ•°æ®ç›®å½•ï¼Œå¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤ä¸º default.etcdâ€“data-dirï¼šæŒ‡å®šæ•°æ®ç›®å½•å»ºè®®ä½¿ç”¨æ—¶ä¸æŒ‡å®š name ä½†æŒ‡å®š data-dirï¼Œå¹¶å°† data-dir å¯¹åº”äº etcd æœåŠ¡ä¸­é…ç½®çš„ data-dir etcd é›†ç¾¤éƒ½æ˜¯è‡³å°‘ 3 å°æœºå™¨ï¼Œå®˜æ–¹ä¹Ÿè¯´æ˜äº†é›†ç¾¤å®¹é”™ä¸º (N-1)/2ï¼Œæ‰€ä»¥å¤‡ä»½æ•°æ®ä¸€èˆ¬éƒ½æ˜¯ç”¨ä¸åˆ°ï¼Œä½†æ˜¯é‰´ä¸Šæ¬¡ gitlab å‡ºç°çš„é—®é¢˜ï¼Œå¯¹äºå¤‡ä»½æ•°æ®ä¹Ÿè¦éå¸¸é‡è§†ã€‚","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/tags/kubernetes/"},{"name":"etcd cluster","slug":"etcd-cluster","permalink":"https://blog.sctux.cc/tags/etcd-cluster/"},{"name":"etcd secret","slug":"etcd-secret","permalink":"https://blog.sctux.cc/tags/etcd-secret/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"ç†è§£kubernetesä¸­çš„é™æ€Pod","slug":"kubernetes-static-pod","date":"2018-12-22T03:02:30.000Z","updated":"2025-09-01T01:59:08.872Z","comments":true,"path":"2018/12/22/kubernetes-static-pod/","permalink":"https://blog.sctux.cc/2018/12/22/kubernetes-static-pod/","excerpt":"æ¦‚è¿°ä»Šå„¿æ˜¯å†¬è‡³ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œå­¦ä¹ çš„è„šæ­¥è¿˜æ˜¯ä¸èƒ½åœä¸‹ï¼Œä»Šå¤©å­¦ä¹ å®è·µä¸€ä¸‹kubernetesä¸­çš„é™æ€podæ˜¯ä»€ä¹ˆï¼Ÿ æˆ‘ä»¬çŸ¥é“åœ¨å‰é¢Podçš„å£°æ˜å‘¨æœŸç®¡ç†éƒ½æ˜¯é€šè¿‡åƒDaemonSetã€StatefulSetã€Deploymentè¿™ç§æ–¹å¼åˆ›å»ºç®¡ç†çš„ï¼Œè€Œå®˜æ–¹æ–‡æ¡£ä»‹ç»äº†ä¸€ç§ç‰¹æ®Šçš„podå°±æ˜¯é™æ€Podï¼Œ ä»€ä¹ˆæ˜¯é™æ€Podé™æ€Podæ˜¯ç”±kubeletè¿›è¡Œç®¡ç†ï¼Œä»…å­˜åœ¨äºç‰¹å®šNodeä¸Šçš„Podã€‚å®ƒä»¬ä¸èƒ½é€šè¿‡API Serverè¿›è¡Œç®¡ç†ï¼Œæ— æ³•ä¸ReplicationControllerã€Deploymentæˆ–DaemonSetè¿›è¡Œå…³è”ï¼Œå¹¶ä¸”kubeletä¹Ÿæ— æ³•å¯¹å…¶å¥åº·æ£€æŸ¥ã€‚ é™æ€Podçš„åˆ›å»º:é™æ€podå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼åˆ›å»ºï¼šä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–HTTPã€‚ é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»ºé…ç½®æ–‡ä»¶åªæ˜¯ç‰¹å®šç›®å½•ä¸­jsonæˆ–yamlæ ¼å¼çš„æ ‡å‡†podå®šä¹‰ã€‚ä»–é€šè¿‡åœ¨kubeletå®ˆæŠ¤è¿›ç¨‹ä¸­æ·»åŠ é…ç½®å‚æ•°--pod-manifest-path=&lt;the directory&gt; æ¥è¿è¡Œé™æ€Podï¼Œkubeletç»å¸¸ä¼šå®ƒå®šæœŸæ‰«æç›®å½•ï¼› ä¾‹å¦‚ï¼Œå¦‚ä½•å°†ä¸€ä¸ªç®€å•webæœåŠ¡ä½œä¸ºé™æ€podå¯åŠ¨","text":"æ¦‚è¿°ä»Šå„¿æ˜¯å†¬è‡³ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œå­¦ä¹ çš„è„šæ­¥è¿˜æ˜¯ä¸èƒ½åœä¸‹ï¼Œä»Šå¤©å­¦ä¹ å®è·µä¸€ä¸‹kubernetesä¸­çš„é™æ€podæ˜¯ä»€ä¹ˆï¼Ÿ æˆ‘ä»¬çŸ¥é“åœ¨å‰é¢Podçš„å£°æ˜å‘¨æœŸç®¡ç†éƒ½æ˜¯é€šè¿‡åƒDaemonSetã€StatefulSetã€Deploymentè¿™ç§æ–¹å¼åˆ›å»ºç®¡ç†çš„ï¼Œè€Œå®˜æ–¹æ–‡æ¡£ä»‹ç»äº†ä¸€ç§ç‰¹æ®Šçš„podå°±æ˜¯é™æ€Podï¼Œ ä»€ä¹ˆæ˜¯é™æ€Podé™æ€Podæ˜¯ç”±kubeletè¿›è¡Œç®¡ç†ï¼Œä»…å­˜åœ¨äºç‰¹å®šNodeä¸Šçš„Podã€‚å®ƒä»¬ä¸èƒ½é€šè¿‡API Serverè¿›è¡Œç®¡ç†ï¼Œæ— æ³•ä¸ReplicationControllerã€Deploymentæˆ–DaemonSetè¿›è¡Œå…³è”ï¼Œå¹¶ä¸”kubeletä¹Ÿæ— æ³•å¯¹å…¶å¥åº·æ£€æŸ¥ã€‚ é™æ€Podçš„åˆ›å»º:é™æ€podå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼åˆ›å»ºï¼šä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–HTTPã€‚ é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»ºé…ç½®æ–‡ä»¶åªæ˜¯ç‰¹å®šç›®å½•ä¸­jsonæˆ–yamlæ ¼å¼çš„æ ‡å‡†podå®šä¹‰ã€‚ä»–é€šè¿‡åœ¨kubeletå®ˆæŠ¤è¿›ç¨‹ä¸­æ·»åŠ é…ç½®å‚æ•°--pod-manifest-path=&lt;the directory&gt; æ¥è¿è¡Œé™æ€Podï¼Œkubeletç»å¸¸ä¼šå®ƒå®šæœŸæ‰«æç›®å½•ï¼› ä¾‹å¦‚ï¼Œå¦‚ä½•å°†ä¸€ä¸ªç®€å•webæœåŠ¡ä½œä¸ºé™æ€podå¯åŠ¨ é€‰æ‹©è¿è¡Œé™æ€podçš„èŠ‚ç‚¹æœåŠ¡å™¨ä¸ä¸€å®šæ˜¯nodeèŠ‚ç‚¹ï¼Œåªè¦æœ‰kubeletè¿›ç¨‹æ‰€åœ¨çš„èŠ‚ç‚¹éƒ½å¯ä»¥è¿è¡Œé™æ€pod æˆ‘åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªæ”¾ç½®ä¸€ä¸ªWebæœåŠ¡å™¨podå®šä¹‰çš„æè¿°æ–‡ä»¶æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚/etc/kubelet.d/static-web.yaml 1234567891011121314151617181920$ mkdir /etc/kubelet.d/$ cat &lt;&lt;EOF &gt;/etc/kubelet.d/static-web.yamlapiVersion: v1kind: Podmetadata: name: static-web labels: role: myrolespec: containers: - name: web image: nginx ports: - name: web containerPort: 80 protocol: TCPEOF$ ls /etc/kubelet.d/static-web.yaml é€šè¿‡ä½¿ç”¨â€“pod-manifest-path=/etc/kubelet.d/å‚æ•°è¿è¡Œå®ƒï¼Œåœ¨èŠ‚ç‚¹ä¸Šé…ç½®æˆ‘çš„kubeletå®ˆæŠ¤ç¨‹åºä»¥ä½¿ç”¨æ­¤ç›®å½•ã€‚æ¯”å¦‚æˆ‘è¿™é‡Œkubeletå¯åŠ¨å‚æ•°ä½äº/etc/systemd/system/kubelet.service.d/10-kubelet.conf, ä¿®æ”¹é…ç½®ï¼Œç„¶åå°†å‚æ•°åŠ å…¥åˆ°ç°æœ‰å‚æ•°é…ç½®é¡¹ä¸­(å®‰è£…æ–¹å¼ä¸å°½ç›¸åŒï¼Œä½†æ˜¯é“ç†ä¸€æ ·) 123456$ vim /etc/systemd/system/kubelet.service.d/10-kubelet.confÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Environment=\"KUBELET_EXTRA_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local --pod-manifest-path=/etc/kubelet.d/\"Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· ä¿å­˜é€€å‡ºï¼Œreloadä¸€ä¸‹systemd daeomon ,é‡å¯kubeletæœåŠ¡è¿›ç¨‹ 12$ systemctl daemon-reload$ systemctl restart kubelet å‰é¢è¯´å•¦ï¼Œå½“kubeletå¯åŠ¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å¯åŠ¨åœ¨æŒ‡å®šçš„ç›®å½•â€“pod-manifest-path=æˆ–â€“manifest-url=å‚æ•°ä¸­å®šä¹‰çš„æ‰€æœ‰pod ï¼Œå³æˆ‘ä»¬çš„static-webã€‚å†è¯¥èŠ‚ç‚¹ä¸Šæ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š 123$ kubectl get pods -o wideNAME READY STATUS RESTARTS AGE IP NODE static-web-k8s-m1 1/1 Running 0 2m 10.244.2.32 k8s-m1 ä¸Šé¢ä¹Ÿæåˆ°äº†ï¼Œä»–ä¸å½’ä»»ä½•éƒ¨ç½²æ–¹å¼æ¥ç®¡ç†ï¼Œå³ä½¿æˆ‘ä»¬å°è¯•kubeletå‘½ä»¤å»åˆ é™¤ 12345$ kubectl delete pod static-web-k8s-m1pod \"static-web-k8s-m1\" deleted$ kubectl get pods -o wideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODEstatic-web-k8s-m1 0/1 Pending 0 2s &lt;none&gt; k8s-m1 &lt;none&gt; å¯ä»¥çœ‹å‡ºé™æ€podé€šè¿‡è¿™ç§æ–¹å¼æ˜¯æ²¡æ³•åˆ é™¤çš„ é‚£æˆ‘å¦‚ä½•å»åˆ é™¤æˆ–è€…è¯´æ˜¯åŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªpodå‘¢ï¼Ÿè¿™ç§æœºåˆ¶å·²ç»çŸ¥é“ï¼Œkubeletè¿›ç¨‹ä¼šå®šæœŸæ‰«æé…ç½®çš„ç›®å½•ï¼ˆ/etc/kubelet.dåœ¨æˆ‘çš„ç¤ºä¾‹ï¼‰ä»¥è¿›è¡Œæ›´æ”¹ï¼Œå¹¶åœ¨æ–‡ä»¶å‡ºç°/æ¶ˆå¤±åœ¨æ­¤ç›®å½•ä¸­æ—¶æ·»åŠ /åˆ é™¤podã€‚ é€šè¿‡urlæ¥åˆ›å»º:ä¾‹å¦‚ï¼Œæˆ‘åœ¨è¿™ä¸ªurlæ”¾ç½®äº†ä¸€ä¸ªpodåˆ›å»ºçš„æè¿°æ–‡ä»¶ é‚£ä¹ˆä¸Šé¢æåˆ°äº†å¦‚ä½•ä¿®æ”¹ï¼Ÿé€šè¿‡urlæ¥åˆ›å»ºçš„ï¼Ÿå°±æ˜¯kubeletå¯åŠ¨é…ç½®å‚æ•°ä¸­é…ç½®--manifest-urlæŒ‡å‘å³å¯ ok ä»¥ä¸Šå°±æ˜¯å¦‚ä½•åˆ›å»ºé™æ€Podçš„å…·ä½“é£Ÿç”¨æ–¹æ³•ï¼Œé‚£ä»€ä¹ˆåœºæ™¯éœ€è¦ç”¨åˆ°å®ƒï¼Œè¿™ä¸ªæˆ‘ä¸ªäººè§‰å¾—è¿˜æ˜¯å› äººæˆ–å› ç¯å¢ƒè€Œå·²ï¼Œæ¯•ç«Ÿkuberneteså¼€å‘å‡ºäº†è¿™ä¸ªåŠŸèƒ½ï¼Œå°±è¯´æ˜æœ‰ç”¨æ­¦ä¹‹åœ°çš„ã€‚ åŒæ—¶åœ¨kubelet-conf.ymlå¯ä»¥æŒ‡å®šç›´æ¥æŒ‡å®šè¿™ä¸ªStaticPodçš„æè¿°æ–‡ä»¶å­˜æ”¾ç›®å½•: 123456$ cat kubelet-conf.yml............staticPodPath: /etc/kubernetes/manifests............ ä½†æ˜¯è¿˜æ˜¯éœ€è¦åœ¨å¯åŠ¨å‚æ•°ä¸­é…ç½® --pod-manifest-path","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/tags/kubernetes/"},{"name":"Static Pod","slug":"Static-Pod","permalink":"https://blog.sctux.cc/tags/Static-Pod/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"ç†è§£kubernetesä¸­çš„Secret","slug":"kubernetes-secret","date":"2018-12-20T14:50:30.000Z","updated":"2025-09-01T01:59:08.921Z","comments":true,"path":"2018/12/20/kubernetes-secret/","permalink":"https://blog.sctux.cc/2018/12/20/kubernetes-secret/","excerpt":"æ¦‚è¿°Secretå¯¹è±¡ä¸ConfigMapå¯¹è±¡ç±»ä¼¼ï¼Œä½†å®ƒä¸»è¦ç”¨äºå­˜å‚¨ä»¥ä¸‹æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ï¼ŒOAuth tokenå’ŒSSH keyç­‰ç­‰ã€‚å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨secretä¸­ï¼Œå’Œç›´æ¥å­˜å‚¨åœ¨Podçš„å®šä¹‰ä¸­ï¼Œæˆ–Dockeré•œåƒå®šä¹‰ä¸­ç›¸æ¯”ï¼Œæ›´åŠ å®‰å…¨å’Œçµæ´»ã€‚ kuberntesä¸­å†…ç½®äº†ä¸‰ç§secretç±»å‹: Opaqueï¼šä½¿ç”¨base64ç¼–ç å­˜å‚¨ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡base64 â€“decodeè§£ç è·å¾—åŸå§‹æ•°æ®ï¼Œå› æ­¤å®‰å…¨æ€§å¼±ã€‚ kubernetes.io/dockerconfigjsonï¼šç”¨äºå­˜å‚¨docker registryçš„è®¤è¯ä¿¡æ¯ã€‚ kubernetes.io/service-account-tokenï¼šç”¨äºè¢« serviceaccount å¼•ç”¨ã€‚serviceaccout åˆ›å»ºæ—¶ Kubernetes ä¼šé»˜è®¤åˆ›å»ºå¯¹åº”çš„ secretã€‚Pod å¦‚æœä½¿ç”¨äº† serviceaccountï¼Œå¯¹åº”çš„ secret ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„ /run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­ã€‚(å‰é¢åšæ–‡è®°å½•è¿‡å®è·µåçš„é£Ÿç”¨æ–¹æ³•) Opaque SecretOpaqueç±»å‹çš„Secretï¼Œå…¶valueä¸ºbase64ç¼–ç åçš„å€¼ã€‚ åˆ›å»ºæ–¹å¼ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret12$ echo -n \"admin\" &gt; ./username.txt$ echo -n \"1f2d1e2e67df\" &gt; ./password.txt ä½¿ç”¨kubectl create secretå‘½ä»¤åˆ›å»ºsecretï¼š","text":"æ¦‚è¿°Secretå¯¹è±¡ä¸ConfigMapå¯¹è±¡ç±»ä¼¼ï¼Œä½†å®ƒä¸»è¦ç”¨äºå­˜å‚¨ä»¥ä¸‹æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ï¼ŒOAuth tokenå’ŒSSH keyç­‰ç­‰ã€‚å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨secretä¸­ï¼Œå’Œç›´æ¥å­˜å‚¨åœ¨Podçš„å®šä¹‰ä¸­ï¼Œæˆ–Dockeré•œåƒå®šä¹‰ä¸­ç›¸æ¯”ï¼Œæ›´åŠ å®‰å…¨å’Œçµæ´»ã€‚ kuberntesä¸­å†…ç½®äº†ä¸‰ç§secretç±»å‹: Opaqueï¼šä½¿ç”¨base64ç¼–ç å­˜å‚¨ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡base64 â€“decodeè§£ç è·å¾—åŸå§‹æ•°æ®ï¼Œå› æ­¤å®‰å…¨æ€§å¼±ã€‚ kubernetes.io/dockerconfigjsonï¼šç”¨äºå­˜å‚¨docker registryçš„è®¤è¯ä¿¡æ¯ã€‚ kubernetes.io/service-account-tokenï¼šç”¨äºè¢« serviceaccount å¼•ç”¨ã€‚serviceaccout åˆ›å»ºæ—¶ Kubernetes ä¼šé»˜è®¤åˆ›å»ºå¯¹åº”çš„ secretã€‚Pod å¦‚æœä½¿ç”¨äº† serviceaccountï¼Œå¯¹åº”çš„ secret ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„ /run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­ã€‚(å‰é¢åšæ–‡è®°å½•è¿‡å®è·µåçš„é£Ÿç”¨æ–¹æ³•) Opaque SecretOpaqueç±»å‹çš„Secretï¼Œå…¶valueä¸ºbase64ç¼–ç åçš„å€¼ã€‚ åˆ›å»ºæ–¹å¼ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret12$ echo -n \"admin\" &gt; ./username.txt$ echo -n \"1f2d1e2e67df\" &gt; ./password.txt ä½¿ç”¨kubectl create secretå‘½ä»¤åˆ›å»ºsecretï¼š 12345678910111213141516171819# åˆ›å»º$ kubectl create secret generic db-user-passwd --from-file=./username.txt --from-file=./password.txtsecret \"db-user-passwd\" created# æŸ¥çœ‹åˆ›å»ºç»“æœ$ kubectl get secrets db-user-passwdapiVersion: v1data: password.txt: MWYyZDFlMmU2N2Rm username.txt: YWRtaW4=kind: Secretmetadata: creationTimestamp: 2018-12-21T08:58:33Z name: db-user-passwd namespace: default resourceVersion: \"57310\" selfLink: /api/v1/namespaces/default/secrets/db-user-passwd uid: 98488947-04fe-11e9-97cd-00505621dd5btype: Opaque ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºSecreté¦–å…ˆä½¿ç”¨base64å¯¹æ•°æ®è¿›è¡Œç¼–ç ï¼š 1234$ echo -n \"admin\" | base64YWRtaW4=$ echo -n \"1f2d1e2e67df\" | base64MWYyZDFlMmU2N2Rm åˆ›å»ºä¸€ä¸ªç±»å‹ä¸ºSecretçš„æè¿°æ–‡ä»¶ï¼š 123456789101112131415161718192021222324252627282930$ cat &gt;&gt; secret.yaml &lt;&lt; EOFapiVersion: v1kind: Secretmetadata: name: mysecrettype: Opaquedata: username: YWRtaW4= password: MWYyZDFlMmU2N2RmEOF# åˆ›å»º$ kubectl create -f secret.yaml secret/mysecret created# æŸ¥çœ‹åˆ›å»ºç»“æœ$ kubectl get secrets mysecret -o yamlapiVersion: v1data: password: MWYyZDFlMmU2N2Rm username: YWRtaW4=kind: Secretmetadata: creationTimestamp: 2018-12-21T09:03:52Z name: mysecret namespace: default resourceVersion: \"57767\" selfLink: /api/v1/namespaces/default/secrets/mysecret uid: 564bd4da-04ff-11e9-97cd-00505621dd5btype: Opaque é£Ÿç”¨æ–¹å¼åˆ›å»ºå¥½Secretä¹‹åï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼é£Ÿç”¨ï¼š ä»¥Volumeæ–¹å¼ ä»¥ç¯å¢ƒå˜é‡æ–¹å¼ å°† Secret æŒ‚è½½åˆ° Volume ä¸­1234567891011121314151617181920212223242526$ cat &gt;&gt; redis-pod.yaml &lt;&lt; EOFapiVersion: v1kind: Podmetadata: name: redis labels: app: redisspec: nodeName: k8s-m1 containers: - name: container-0 image: redis imagePullPolicy: IfNotPresent volumeMounts: - name: foo mountPath: /etc/foo readOnly: true volumes: - name: foo secret: secretName: db-user-passwdEOF$ åˆ›å»º:$ kubectl create -f redis-pod.yamlpod/redis created è¿›å…¥å®¹å™¨æ£€æŸ¥ 12345678$ ls -l /etc/foo/total 0lrwxrwxrwx 1 root root 19 Dec 21 09:14 password.txt -&gt; ..data/password.txtlrwxrwxrwx 1 root root 19 Dec 21 09:14 username.txt -&gt; ..data/username.txt$ cat /etc/foo/username.txt admin$ cat /etc/foo/password.txt 1f2d1e2e67df ä¹Ÿå¯ä»¥åªæŒ‚è½½Secretä¸­ç‰¹å®šçš„keyï¼š 1234567891011121314151617181920212223242526272829$ cat &gt;&gt; redis-pod2.yaml &lt;&lt; EOFapiVersion: v1kind: Podmetadata: name: redis2 labels: app: redisspec: nodeName: k8s-m1 containers: - name: redis image: redis imagePullPolicy: IfNotPresent volumeMounts: - name: foo mountPath: /etc/foo readOnly: true volumes: - name: foo secret: secretName: mysecret items: - key: username path: my-group/my-usernameEOF# åˆ›å»º$ kubectl create -f redis-pod2.yaml pod/redis2 created è¿›å…¥å®¹å™¨æ£€æŸ¥ 12345$ kubectl exec -it redis5 /bin/bash$ ls -l /etc/foo/my-group/my-username -rw-r--r-- 1 root root 5 Dec 21 10:26 /etc/foo/my-group/my-username$ cat /etc/foo/my-group/my-usernameadmin åœ¨è¿™ç§æƒ…å†µä¸‹ï¼š username å­˜å‚¨åœ¨/etc/foo/my-group/my-usernameä¸­passwordæœªè¢«æŒ‚è½½æ³¨æ„: æŒ‡å®škeyçš„è¿™ç§æŒ‚è½½æ–¹å¼åªé€‚ç”¨äºæ˜¯é€šè¿‡ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºçš„Secret,ä»æ–‡ä»¶ä¸­åˆ›å»ºçš„é‚£ç§SecretæŒ‚è½½ä¼šæŠ¥é”™: 12345$ å½“æˆ‘æŒ‚è½½ Secret db-user-passwd çš„æ—¶å€™podåˆ›å»ºäº‹ä»¶:Events: Type Reason Age From Message ---- ------ ---- ---- ------- Warning FailedMount 5s (x5 over 12s) kubelet, k8s-m1 MountVolume.SetUp failed for volume \"foo\" : references non-existent secret key å…·ä½“åŸå› ç›®å‰æ— è§£,æœ‰çŸ¥é“çš„å¤§å“¥å¯ä»¥è¯„è®ºç•™è¨€å‘ŠçŸ¥ä¸€äºŒï¼Œè°¢è°¢ å°† Secret å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸­1234567891011121314151617181920212223242526272829303132$ cat &gt;&gt; redis3.yaml &lt;&lt; EOFapiVersion: v1kind: Podmetadata: name: redis3 labels: app: redisspec: nodeName: k8s-m1 containers: - name: redis image: redis imagePullPolicy: IfNotPresent env: - name: SECRET_USERNAME valueFrom: secretKeyRef: name: mysecret key: username - name: SECRET_PASSWORD valueFrom: secretKeyRef: name: mysecret key: passwordEOF# è¿›å…¥å®¹å™¨æŸ¥çœ‹ç»“æœ$ kubectl exec -it redis3 /bin/bash$ echo $SECRET_USERNAMEadmin$ echo $SECRET_PASSWORD1f2d1e2e67df ok , é€šè¿‡ä¸åŒæ–¹å¼æŒ‚è½½è¿›å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥æ‹¿æ¥ç”¨å•¦ï¼Œå…·ä½“é€‰æ‹©å“ªç§æ–¹å¼æŒ‚è½½è¿˜æ˜¯éœ€è¦çœ‹å®é™…ç¯å¢ƒï¼›å¥½å•¦ï¼Œä»¥ä¸Šå°±æ˜¯Secretçš„ç®€å•é£Ÿç”¨æ–¹æ³•ï¼Œæ›´å¤šå¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"kuberntes","slug":"kuberntes","permalink":"https://blog.sctux.cc/tags/kuberntes/"},{"name":"secret","slug":"secret","permalink":"https://blog.sctux.cc/tags/secret/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"Kuberneteså®¹å™¨å­˜æ´»æ¢æµ‹&åº”ç”¨è‡ªæ¢å¤","slug":"kubernetes-liveness","date":"2018-12-18T15:12:40.000Z","updated":"2025-09-01T01:59:08.959Z","comments":true,"path":"2018/12/18/kubernetes-liveness/","permalink":"https://blog.sctux.cc/2018/12/18/kubernetes-liveness/","excerpt":"æ¦‚è¿°å½“ä½ ä½¿ç”¨kuberentesçš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰é‡åˆ°è¿‡Podåœ¨å¯åŠ¨åä¸€ä¼šå°±æŒ‚æ‰ç„¶ååˆé‡æ–°å¯åŠ¨è¿™æ ·çš„æ¶æ€§å¾ªç¯ï¼Ÿä½ æœ‰æ²¡æœ‰æƒ³è¿‡kubernetesæ˜¯å¦‚ä½•æ£€æµ‹podæ˜¯å¦è¿˜å­˜æ´»ï¼Ÿè™½ç„¶å®¹å™¨å·²ç»å¯åŠ¨ï¼Œä½†æ˜¯kuberneteså¦‚ä½•çŸ¥é“å®¹å™¨çš„è¿›ç¨‹æ˜¯å¦å‡†å¤‡å¥½å¯¹å¤–æä¾›æœåŠ¡äº†å‘¢ï¼Ÿ æœ¬åšæ–‡ä¸»è¦è®°å½•å®è·µå¦‚ä½•é…ç½®å®¹å™¨çš„å­˜æ´»å’Œå°±ç»ªæ¢é’ˆã€‚ liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå³Podæ˜¯å¦ä¸ºrunningçŠ¶æ€ï¼Œå¦‚æœLivenessProbeæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œåˆ™kubeletå°†killæ‰å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥æ˜¯å¦é‡å¯ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨ä¸åŒ…å«LivenessProbeæ¢é’ˆï¼Œåˆ™Kubeletè®¤ä¸ºå®¹å™¨çš„LivenessProbeæ¢é’ˆçš„è¿”å›å€¼æ°¸è¿œæˆåŠŸã€‚ readiness probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆï¼Œå³å®¹å™¨çš„Readyæ˜¯å¦ä¸ºTrueï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœReadinessProbeæ¢æµ‹å¤±è´¥ï¼Œåˆ™å®¹å™¨çš„Readyå°†ä¸ºFalseï¼Œæ§åˆ¶å™¨å°†æ­¤Podçš„Endpointä»å¯¹åº”çš„serviceçš„Endpointåˆ—è¡¨ä¸­ç§»é™¤ï¼Œä»æ­¤ä¸å†å°†ä»»ä½•è¯·æ±‚è°ƒåº¦æ­¤Podä¸Šï¼Œç›´åˆ°ä¸‹æ¬¡æ¢æµ‹æˆåŠŸã€‚ æ¯ç±»æ¢é’ˆéƒ½æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹æ³• execï¼šé€šè¿‡æ‰§è¡Œå‘½ä»¤æ¥æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œé’ˆå¯¹å¤æ‚æ£€æµ‹æˆ–æ— HTTPæ¥å£çš„æœåŠ¡ï¼Œå‘½ä»¤è¿”å›å€¼ä¸º0åˆ™è¡¨ç¤ºå®¹å™¨å¥åº·ã€‚ httpGetï¼šé€šè¿‡å‘é€httpè¯·æ±‚æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œè¿”å›200-399çŠ¶æ€ç åˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚ tcpSocketï¼šé€šè¿‡å®¹å™¨çš„IPå’ŒPortæ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚ æ¯ç§æ–¹å¼éƒ½å¯ä»¥å®šä¹‰åœ¨readiness æˆ–è€…liveness ä¸­ã€‚æ¯”å¦‚å®šä¹‰readiness ä¸­http get å°±æ˜¯æ„æ€è¯´å¦‚æœæˆ‘å®šä¹‰çš„è¿™ä¸ªpathçš„http get è¯·æ±‚è¿”å›200-400ä»¥å¤–çš„http code å°±æŠŠæˆ‘ä»æ‰€æœ‰æœ‰æˆ‘çš„æœåŠ¡é‡Œé¢åˆ äº†å§ï¼Œå¦‚æœå®šä¹‰åœ¨livenessé‡Œé¢å°±æ˜¯æŠŠæˆ‘kill äº†ã€‚æ³¨æ„ï¼Œlivenessä¸ä¼šé‡å¯podï¼Œpodæ˜¯å¦ä¼šé‡å¯ç”±ä½ çš„restart policy æ§åˆ¶ã€‚ æ¢é’ˆæ¢æµ‹çš„ç»“æœæœ‰ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€ Successï¼šContaineré€šè¿‡äº†æ£€æŸ¥ã€‚ Failureï¼šContaineræœªé€šè¿‡æ£€æŸ¥ã€‚ Unknownï¼šæœªèƒ½æ‰§è¡Œæ£€æŸ¥ï¼Œå› æ­¤ä¸é‡‡å–ä»»ä½•æªæ–½ã€‚","text":"æ¦‚è¿°å½“ä½ ä½¿ç”¨kuberentesçš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰é‡åˆ°è¿‡Podåœ¨å¯åŠ¨åä¸€ä¼šå°±æŒ‚æ‰ç„¶ååˆé‡æ–°å¯åŠ¨è¿™æ ·çš„æ¶æ€§å¾ªç¯ï¼Ÿä½ æœ‰æ²¡æœ‰æƒ³è¿‡kubernetesæ˜¯å¦‚ä½•æ£€æµ‹podæ˜¯å¦è¿˜å­˜æ´»ï¼Ÿè™½ç„¶å®¹å™¨å·²ç»å¯åŠ¨ï¼Œä½†æ˜¯kuberneteså¦‚ä½•çŸ¥é“å®¹å™¨çš„è¿›ç¨‹æ˜¯å¦å‡†å¤‡å¥½å¯¹å¤–æä¾›æœåŠ¡äº†å‘¢ï¼Ÿ æœ¬åšæ–‡ä¸»è¦è®°å½•å®è·µå¦‚ä½•é…ç½®å®¹å™¨çš„å­˜æ´»å’Œå°±ç»ªæ¢é’ˆã€‚ liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå³Podæ˜¯å¦ä¸ºrunningçŠ¶æ€ï¼Œå¦‚æœLivenessProbeæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œåˆ™kubeletå°†killæ‰å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥æ˜¯å¦é‡å¯ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨ä¸åŒ…å«LivenessProbeæ¢é’ˆï¼Œåˆ™Kubeletè®¤ä¸ºå®¹å™¨çš„LivenessProbeæ¢é’ˆçš„è¿”å›å€¼æ°¸è¿œæˆåŠŸã€‚ readiness probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆï¼Œå³å®¹å™¨çš„Readyæ˜¯å¦ä¸ºTrueï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœReadinessProbeæ¢æµ‹å¤±è´¥ï¼Œåˆ™å®¹å™¨çš„Readyå°†ä¸ºFalseï¼Œæ§åˆ¶å™¨å°†æ­¤Podçš„Endpointä»å¯¹åº”çš„serviceçš„Endpointåˆ—è¡¨ä¸­ç§»é™¤ï¼Œä»æ­¤ä¸å†å°†ä»»ä½•è¯·æ±‚è°ƒåº¦æ­¤Podä¸Šï¼Œç›´åˆ°ä¸‹æ¬¡æ¢æµ‹æˆåŠŸã€‚ æ¯ç±»æ¢é’ˆéƒ½æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹æ³• execï¼šé€šè¿‡æ‰§è¡Œå‘½ä»¤æ¥æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œé’ˆå¯¹å¤æ‚æ£€æµ‹æˆ–æ— HTTPæ¥å£çš„æœåŠ¡ï¼Œå‘½ä»¤è¿”å›å€¼ä¸º0åˆ™è¡¨ç¤ºå®¹å™¨å¥åº·ã€‚ httpGetï¼šé€šè¿‡å‘é€httpè¯·æ±‚æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œè¿”å›200-399çŠ¶æ€ç åˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚ tcpSocketï¼šé€šè¿‡å®¹å™¨çš„IPå’ŒPortæ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚ æ¯ç§æ–¹å¼éƒ½å¯ä»¥å®šä¹‰åœ¨readiness æˆ–è€…liveness ä¸­ã€‚æ¯”å¦‚å®šä¹‰readiness ä¸­http get å°±æ˜¯æ„æ€è¯´å¦‚æœæˆ‘å®šä¹‰çš„è¿™ä¸ªpathçš„http get è¯·æ±‚è¿”å›200-400ä»¥å¤–çš„http code å°±æŠŠæˆ‘ä»æ‰€æœ‰æœ‰æˆ‘çš„æœåŠ¡é‡Œé¢åˆ äº†å§ï¼Œå¦‚æœå®šä¹‰åœ¨livenessé‡Œé¢å°±æ˜¯æŠŠæˆ‘kill äº†ã€‚æ³¨æ„ï¼Œlivenessä¸ä¼šé‡å¯podï¼Œpodæ˜¯å¦ä¼šé‡å¯ç”±ä½ çš„restart policy æ§åˆ¶ã€‚ æ¢é’ˆæ¢æµ‹çš„ç»“æœæœ‰ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€ Successï¼šContaineré€šè¿‡äº†æ£€æŸ¥ã€‚ Failureï¼šContaineræœªé€šè¿‡æ£€æŸ¥ã€‚ Unknownï¼šæœªèƒ½æ‰§è¡Œæ£€æŸ¥ï¼Œå› æ­¤ä¸é‡‡å–ä»»ä½•æªæ–½ã€‚ é‡å¯ç­–ç•¥ Always: æ€»æ˜¯é‡å¯ OnFailure: å¦‚æœå¤±è´¥å°±é‡å¯ Never: æ°¸è¿œä¸é‡å¯ LivenessProbeæ¢é’ˆé…ç½®ç¤ºä¾‹ä¸€: é€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹12345678910111213141516171819202122exec-liveness.yaml apiVersion: v1kind: Podmetadata: labels: test: liveness name: liveness-execspec: containers: - name: liveness image: k8s.gcr.io/busybox args: - /bin/sh - -c - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600 livenessProbe: exec: command: - cat - /tmp/healthy initialDelaySeconds: 5 periodSeconds: 5 åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯¹å®¹å™¨æ‰§è¡ŒlivenessProbeæ£€æŸ¥ï¼ŒperiodSecondså­—æ®µæŒ‡å®škubeletæ¯5sæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œæ£€æŸ¥çš„å‘½ä»¤ä¸ºcat /tmp/healthyï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletåº”è¯¥åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥ä¹‹å‰ç­‰å¾…5ç§’ï¼Œå¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›0ï¼Œé‚£ä¹ˆkubeletå°±è®¤ä¸ºå®¹å™¨æ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸ºé0ï¼Œåˆ™Kubeletä¼šKillæ‰å®¹å™¨å¹¶æ ¹æ®é‡å¯ç­–ç•¥æ¥å†³å®šæ˜¯å¦éœ€è¦é‡å¯(kubernetesé»˜è®¤ä¸ºPODé…ç½®çš„é‡å¯ç­–ç•¥ä¸ºAlways) å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š 1/bin/sh -c \"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600\" å¯¹äºå®¹å™¨çš„å‰30ç§’ï¼Œæœ‰ä¸€ä¸ª/tmp/healthyæ–‡ä»¶ã€‚å› æ­¤ï¼Œåœ¨å‰30ç§’å†…ï¼Œè¯¥å‘½ä»¤cat /tmp/healthyè¿”å›æˆåŠŸä»£ç ã€‚30ç§’åï¼Œcat /tmp/healthyè¿”å›å¤±è´¥ä»£ç ã€‚ åœ¨30ç§’å†…ï¼ŒæŸ¥çœ‹Podäº‹ä»¶ï¼š 1234567891011$ kubectl describe pod liveness-exec............Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 15m default-scheduler Successfully assigned default/liveness-exec to k8s-m3 Normal Pulled 3m (x3 over 5m) kubelet, k8s-m3 Successfully pulled image \"k8s.gcr.io/busybox\" Normal Created 3m (x3 over 5m) kubelet, k8s-m3 Created container Normal Started 3m (x3 over 5m) kubelet, k8s-m3 Started container åœ¨30ç§’åï¼ŒæŸ¥çœ‹Podäº‹ä»¶ï¼š 1234567891011$ kubectl describe pod liveness-execEvents: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 16m default-scheduler Successfully assigned default/liveness-exec to k8s-m3 Normal Pulled 5m (x3 over 7m) kubelet, k8s-m3 Successfully pulled image \"k8s.gcr.io/busybox\" Normal Created 5m (x3 over 7m) kubelet, k8s-m3 Created container Normal Started 5m (x3 over 7m) kubelet, k8s-m3 Started container Warning Unhealthy 4m (x9 over 7m) kubelet, k8s-m3 Liveness probe failed: cat: can't open '/tmp/healthy': No such file or directory Normal Pulling 4m (x4 over 7m) kubelet, k8s-m3 pulling image \"k8s.gcr.io/busybox\" Normal Killing 2m (x4 over 6m) kubelet, k8s-m3 Killing container with id docker://liveness:Container failed liveness probe.. Container will be killed and recreated. å†ç­‰30ç§’ï¼Œç¡®è®¤Containerå·²é‡æ–°å¯åŠ¨, ä¸‹é¢è¾“å‡ºä¸­RESTARTSçš„æ¬¡æ•°å·²å¢åŠ ï¼š 123$ kubectl get pod liveness-execNAME READY STATUS RESTARTS AGEliveness-exec 1/1 Running 1 1m ç¤ºä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹123456789101112131415161718192021apiVersion: v1kind: Podmetadata: labels: test: liveness name: liveness-httpspec: containers: - name: liveness image: k8s.gcr.io/liveness # å®˜æ–¹ç”¨æˆ·æµ‹è¯•çš„demoé•œåƒ args: - /server livenessProbe: httpGet: path: /healthz port: 8080 httpHeaders: - name: X-Custom-Header value: Awesome initialDelaySeconds: 3 periodSeconds: 3 åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨k8s.gcr.io/livenessé•œåƒï¼Œåˆ›å»ºå‡ºä¸€ä¸ªPodï¼Œå…¶ä¸­periodSecondså­—æ®µæŒ‡å®škubeletæ¯3ç§’æ‰§è¡Œä¸€æ¬¡æ¢æµ‹ï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletå»¶è¿Ÿç­‰å¾…3ç§’ï¼Œæ¢æµ‹æ–¹å¼ä¸ºå‘å®¹å™¨ä¸­è¿è¡Œçš„æœåŠ¡å‘é€HTTP GETè¯·æ±‚ï¼Œè¯·æ±‚8080ç«¯å£ä¸‹çš„/healthz, ä»»ä½•å¤§äºæˆ–ç­‰äº200ä¸”å°äº400çš„ä»£ç è¡¨ç¤ºæˆåŠŸã€‚ä»»ä½•å…¶ä»–ä»£ç è¡¨ç¤ºå¤±è´¥ã€‚ 10ç§’åï¼ŒæŸ¥çœ‹Podäº‹ä»¶ä»¥éªŒè¯livenessæ¢æµ‹å¤±è´¥å¹¶ä¸”Containerå·²é‡æ–°å¯åŠ¨ï¼š 123$ kubectl describe pod liveness-httpNAME READY STATUS RESTARTS AGEliveness-http 1/1 RUNNING 1 1m httpGetæ¢æµ‹æ–¹å¼æœ‰å¦‚ä¸‹å¯é€‰çš„æ§åˆ¶å­—æ®µ hostï¼šè¦è¿æ¥çš„ä¸»æœºåï¼Œé»˜è®¤ä¸ºPod IPï¼Œå¯ä»¥åœ¨http request headä¸­è®¾ç½®hostå¤´éƒ¨ã€‚ scheme: ç”¨äºè¿æ¥hostçš„åè®®ï¼Œé»˜è®¤ä¸ºHTTPã€‚ pathï¼šhttpæœåŠ¡å™¨ä¸Šçš„è®¿é—®URIã€‚ httpHeadersï¼šè‡ªå®šä¹‰HTTPè¯·æ±‚headersï¼ŒHTTPå…è®¸é‡å¤headersã€‚ portï¼š å®¹å™¨ä¸Šè¦è®¿é—®ç«¯å£å·æˆ–åç§°ã€‚ ç¤ºä¾‹ä¸‰ï¼šé€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹Kubeletå°†å°è¯•åœ¨æŒ‡å®šçš„ç«¯å£ä¸Šæ‰“å¼€å®¹å™¨ä¸Šçš„å¥—æ¥å­—ï¼Œå¦‚æœèƒ½å»ºç«‹è¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚ 12345678910111213141516171819202122apiVersion: v1kind: Podmetadata: name: goproxy labels: app: goproxyspec: containers: - name: goproxy image: k8s.gcr.io/goproxy:0.1 ports: - containerPort: 8080 readinessProbe: tcpSocket: port: 8080 initialDelaySeconds: 5 periodSeconds: 10 livenessProbe: tcpSocket: port: 8080 initialDelaySeconds: 15 periodSeconds: 20 TCPæ£€æŸ¥æ–¹å¼å’ŒHTTPæ£€æŸ¥æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œç¤ºä¾‹ä¸­ä¸¤ç§æ¢é’ˆéƒ½ä½¿ç”¨äº†ï¼Œåœ¨å®¹å™¨å¯åŠ¨5ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªreadinessProbeæ¢é’ˆï¼Œè¿™å°†è¿æ¥åˆ°å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœæ¢æµ‹æˆåŠŸï¼Œåˆ™è¯¥Podå°†è¢«æ ‡è¯†ä¸ºreadyï¼Œ10ç§’åï¼Œkubeletå°†è¿›è¡Œç¬¬äºŒæ¬¡è¿æ¥ã€‚é™¤æ­¤ä¹‹åï¼Œæ­¤é…ç½®è¿˜åŒ…å«äº†livenessProbeæ¢é’ˆï¼Œåœ¨å®¹å™¨å¯åŠ¨15ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªlivenessProbeæ¢é’ˆï¼Œä»ç„¶å°è¯•è¿æ¥å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœè¿æ¥å¤±è´¥åˆ™é‡å¯å®¹å™¨ã€‚ 12345678ports:- name: liveness-port containerPort: 8080 hostPort: 8080livenessProbe: httpGet: path: /healthz port: liveness-port ReadinessProbeæ¢é’ˆé…ç½®ï¼šReadinessProbeæ¢é’ˆçš„ä½¿ç”¨åœºæ™¯livenessProbeç¨æœ‰ä¸åŒï¼Œæœ‰çš„æ—¶å€™åº”ç”¨ç¨‹åºå¯èƒ½æš‚æ—¶æ— æ³•æ¥å—è¯·æ±‚ï¼Œæ¯”å¦‚Podå·²ç»Runningäº†ï¼Œä½†æ˜¯å®¹å™¨å†…åº”ç”¨ç¨‹åºå°šæœªå¯åŠ¨æˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰ReadinessProbeï¼Œåˆ™Kubernetesè®¤ä¸ºå®ƒå¯ä»¥å¤„ç†è¯·æ±‚äº†ï¼Œç„¶è€Œæ­¤æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ç¨‹åºè¿˜æ²¡å¯åŠ¨æˆåŠŸæ˜¯ä¸èƒ½æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¸å¸Œæœ›kubernetesæŠŠè¯·æ±‚è°ƒåº¦ç»™å®ƒï¼Œåˆ™ä½¿ç”¨ReadinessProbeæ¢é’ˆã€‚ReadinessProbeå’ŒlivenessProbeå¯ä»¥ä½¿ç”¨ç›¸åŒæ¢æµ‹æ–¹å¼ï¼Œåªæ˜¯å¯¹Podçš„å¤„ç½®æ–¹å¼ä¸åŒï¼ŒReadinessProbeæ˜¯å°†Pod IP:Portä»å¯¹åº”çš„EndPointåˆ—è¡¨ä¸­åˆ é™¤ï¼Œè€ŒlivenessProbeåˆ™Killå®¹å™¨å¹¶æ ¹æ®Podçš„é‡å¯ç­–ç•¥æ¥å†³å®šä½œå‡ºå¯¹åº”çš„æªæ–½ã€‚ ReadinessProbeæ¢é’ˆæ¢æµ‹å®¹å™¨æ˜¯å¦å·²å‡†å¤‡å°±ç»ªï¼Œå¦‚æœæœªå‡†å¤‡å°±ç»ªåˆ™kubernetesä¸ä¼šå°†æµé‡è½¬å‘ç»™æ­¤Podã€‚ ReadinessProbeæ¢é’ˆä¸livenessProbeä¸€æ ·ä¹Ÿæ”¯æŒexecã€httpGetã€TCPçš„æ¢æµ‹æ–¹å¼ï¼Œé…ç½®æ–¹å¼ç›¸åŒï¼Œåªä¸è¿‡æ˜¯å°†livenessProbeå­—æ®µä¿®æ”¹ä¸ºReadinessProbeã€‚ 1234567readinessProbe: exec: command: - cat - /tmp/healthy initialDelaySeconds: 5 periodSeconds: 5 ç¤ºä¾‹ä¸€: ReadinessProbeç¤ºä¾‹ç°åœ¨æ¥çœ‹ä¸€ä¸ªåŠ å…¥ReadinessProbeæ¢é’ˆå’Œä¸€ä¸ªæ²¡æœ‰ReadinessProbeæ¢é’ˆçš„ç¤ºä¾‹ï¼šè¯¥ç¤ºä¾‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªdeployï¼Œåä¸ºgogsï¼Œå¯åŠ¨çš„å®¹å™¨è¿è¡Œä¸€ä¸ªç±»ä¼¼äºgitlabçš„åº”ç”¨ç¨‹åºï¼Œç¨‹åºç›‘å¬ç«¯å£ä¸º3000ã€‚è¿™é‡Œä¸ºäº†æ¨¡æ‹Ÿæ•ˆæœæˆ‘è¿™é‡ŒåŸé•œåƒåšäº†ä¸€ä¸‹ä¿®æ”¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†å»¶è¿Ÿä»–çš„å¯åŠ¨æ—¶é—´ä¸º40såå†å»å¯åŠ¨gogsçš„åº”ç”¨ç¨‹åºï¼Œæ­¤æ—¶å°±ä¼šå¼€å¯3000ç«¯å£ï¼Œ (æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸€ä¸‹ï¼Œéå¸¸çˆ½çš„ä¸€ä¸ªè‡ªåŠ©gitwebå¹³å°Gogs) 12345678910111213141516171819202122232425262728293031323334353637383940414243kind: ServiceapiVersion: v1metadata: name: gogs namespace: defaultspec: selector: test: gogs ports: - protocol: TCP port: 3000---kind: DeploymentapiVersion: apps/v1metadata: name: gogs namespace: defaultspec: replicas: 1 selector: matchLabels: test: gogs template: metadata: labels: test: gogs spec: containers: - image: test imagePullPolicy: IfNotPresent name: gogs ports: - containerPort: 3000 affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - k8s-m1 ![Not add readinessProbe result](kubernetes-liveness/image1.png) ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œå½“æˆ‘åˆ›å»ºéƒ¨ç½²ä¹‹åï¼ŒPodå¯åŠ¨18sï¼Œè‡ªèº«çŠ¶æ€å·²Runningï¼Œå…¶READå­—æ®µï¼Œ1/1 è¡¨ç¤º1ä¸ªå®¹å™¨çŠ¶æ€å·²å‡†å¤‡å°±ç»ªäº†ï¼Œæ­¤æ—¶ï¼Œå¯¹äºkubernetesè€Œè¨€ï¼Œå®ƒå·²ç»å¯ä»¥æ¥æ”¶è¯·æ±‚äº†ï¼Œè€Œå®é™…ä¸Šæˆ‘åœ¨å»è®¿é—®çš„æ—¶å€™æœåŠ¡è¿˜æ— æ³•è®¿é—®ï¼Œå› ä¸ºGogoç¨‹åºè¿˜å°šå¯åŠ¨èµ·æ¥ï¼Œ40sä¹‹åæ–¹å¯æ­£å¸¸è®¿é—®ï¼Œæ‰€ä»¥é’ˆå¯¹äºæœåŠ¡å¯åŠ¨æ…¢æˆ–è€…å…¶ä»–åŸå› çš„æ­¤ç±»ç¨‹åºï¼Œå¿…é¡»é…ç½®ReadinessProbeã€‚ ä¸‹é¢æˆ‘åŠ å…¥readinessProbe 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748kind: ServiceapiVersion: v1metadata: name: gogs namespace: defaultspec: selector: test: gogs ports: - protocol: TCP port: 3000---kind: DeploymentapiVersion: apps/v1metadata: name: gogs namespace: defaultspec: replicas: 1 selector: matchLabels: test: gogs template: metadata: labels: test: gogs spec: containers: - image: test imagePullPolicy: IfNotPresent name: gogs ports: - containerPort: 3000 readinessProbe: tcpSocket: port: 3000 initialDelaySeconds: 10 # å¯åŠ¨å10ç§’å¼€å§‹æ¢æµ‹ periodSeconds: 5 # æ¯5ç§’æ¢æµ‹ä¸€æ¬¡ affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - k8s-m1 ![Add readinessProbe result](kubernetes-liveness/image1.png) ä¸Šå›¾å¯ä»¥çœ‹å‡ºPodè™½ç„¶å·²å¤„äºRunnigçŠ¶æ€ï¼Œä½†æ˜¯ç”±äºç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æœªåˆ°ï¼Œæ‰€ä»¥READYå­—æ®µä¸º0/1ï¼Œå³å®¹å™¨çš„çŠ¶æ€ä¸ºæœªå‡†å¤‡å°±ç»ªï¼Œåœ¨æœªå‡†å¤‡å°±ç»ªçš„æƒ…å†µä¸‹ï¼Œå…¶Podå¯¹åº”çš„Serviceä¸‹çš„Endpointä¹Ÿä¸ºç©ºï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ä»»ä½•è¯·æ±‚è¢«è°ƒåº¦è¿›æ¥ã€‚ å½“é€šè¿‡ç¬¬ä¸€æ¬¡æ¢æµ‹çš„æ£€æŸ¥é€šè¿‡åï¼Œå®¹å™¨çš„çŠ¶æ€è‡ªç„¶ä¼šè½¬ä¸ºREADçŠ¶æ€ã€‚ æ­¤åæ ¹æ®æŒ‡å®šçš„é—´éš”æ—¶é—´10såå†æ¬¡æ¢æµ‹ï¼Œå¦‚æœä¸é€šè¿‡ï¼Œåˆ™kuberneteså°±ä¼šå°†Pod IPä»EndPointåˆ—è¡¨ä¸­ç§»é™¤ã€‚ é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§æ¢é’ˆ(Probe)æœ‰è®¸å¤šå¯é€‰å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æ›´åŠ ç²¾ç¡®çš„æ§åˆ¶Livenesså’ŒReadinessä¸¤ç§æ¢é’ˆçš„è¡Œä¸º(Probe)ï¼š initialDelaySecondsï¼šPodå¯åŠ¨åå»¶è¿Ÿå¤šä¹…æ‰è¿›è¡Œæ£€æŸ¥ï¼Œå•ä½ï¼šç§’ã€‚periodSecondsï¼šæ£€æŸ¥çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤ä¸º10ï¼Œå•ä½ï¼šç§’ã€‚timeoutSecondsï¼šæ¢æµ‹çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º1ï¼Œå•ä½ï¼šç§’ã€‚successThresholdï¼šæ¢æµ‹å¤±è´¥åè®¤ä¸ºæˆåŠŸçš„æœ€å°è¿æ¥æˆåŠŸæ¬¡æ•°ï¼Œé»˜è®¤ä¸º1ï¼Œåœ¨Livenessæ¢é’ˆä¸­å¿…é¡»ä¸º1ï¼Œæœ€å°å€¼ä¸º1ã€‚failureThresholdï¼šæ¢æµ‹å¤±è´¥çš„é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•ä¸€å®šæ¬¡æ•°åå°†è®¤ä¸ºå¤±è´¥ï¼Œåœ¨readinessæ¢é’ˆä¸­ï¼ŒPodä¼šè¢«æ ‡è®°ä¸ºæœªå°±ç»ªï¼Œé»˜è®¤ä¸º3ï¼Œæœ€å°å€¼ä¸º1ã€‚ å‚è€ƒ:https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"liveness probe","slug":"liveness-probe","permalink":"https://blog.sctux.cc/tags/liveness-probe/"},{"name":"readiness probe","slug":"readiness-probe","permalink":"https://blog.sctux.cc/tags/readiness-probe/"},{"name":"restartPolicy","slug":"restartPolicy","permalink":"https://blog.sctux.cc/tags/restartPolicy/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"ç†è§£Kubernetesä¸­çš„è®¤è¯&æˆæƒ&å‡†å…¥æœºåˆ¶","slug":"kubernetes-auth","date":"2018-12-16T07:35:24.000Z","updated":"2025-09-01T01:59:08.920Z","comments":true,"path":"2018/12/16/kubernetes-auth/","permalink":"https://blog.sctux.cc/2018/12/16/kubernetes-auth/","excerpt":"æ¦‚è¿°é¦–å…ˆéœ€è¦äº†è§£è¿™ä¸‰ç§æœºåˆ¶çš„åŒºåˆ«ï¼š è®¤è¯(Authenticating)æ˜¯å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ï¼Œé€šä¿—ç‚¹å°±æ˜¯ç”¨æˆ·åå¯†ç éªŒè¯ï¼Œ æˆæƒ(Authorization)æ˜¯å¯¹èµ„æºçš„æˆæƒï¼Œk8sä¸­çš„èµ„æºæ— éæ˜¯å®¹å™¨ï¼Œæœ€ç»ˆå…¶å®å°±æ˜¯å®¹å™¨çš„è®¡ç®—ï¼Œç½‘ç»œï¼Œå­˜å‚¨èµ„æºï¼Œå½“ä¸€ä¸ªè¯·æ±‚ç»è¿‡è®¤è¯åï¼Œéœ€è¦è®¿é—®æŸä¸€ä¸ªèµ„æºï¼ˆæ¯”å¦‚åˆ›å»ºä¸€ä¸ªpodï¼‰ï¼Œæˆæƒæ£€æŸ¥éƒ½ä¼šé€šè¿‡è®¿é—®ç­–ç•¥æ¯”è¾ƒè¯¥è¯·æ±‚ä¸Šä¸‹æ–‡çš„å±æ€§ï¼Œï¼ˆæ¯”å¦‚ç”¨æˆ·ï¼Œèµ„æºå’ŒNamespaceï¼‰ï¼Œæ ¹æ®æˆæƒè§„åˆ™åˆ¤å®šè¯¥èµ„æºï¼ˆæ¯”å¦‚æŸnamespaceä¸‹çš„podï¼‰æ˜¯å¦æ˜¯è¯¥å®¢æˆ·å¯è®¿é—®çš„ã€‚ å‡†å…¥(Admission Control)æœºåˆ¶æ˜¯ä¸€ç§åœ¨æ”¹å˜èµ„æºçš„æŒä¹…åŒ–ä¹‹å‰ï¼ˆæ¯”å¦‚æŸäº›èµ„æºçš„åˆ›å»ºæˆ–åˆ é™¤ï¼Œä¿®æ”¹ç­‰ä¹‹å‰ï¼‰çš„æœºåˆ¶ã€‚åœ¨k8sä¸­ï¼Œè¿™ä¸‰ç§æœºåˆ¶å¦‚ä¸‹å›¾ï¼šk8sçš„æ•´ä½“æ¶æ„ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡çš„æ¶æ„ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªGateWayï¼Œä¹Ÿå°±æ˜¯kube-apiserverè¿™ä¸ªç»„ä»¶ï¼ˆå¯¹å¤–æä¾›RESTæœåŠ¡ï¼‰ï¼Œç”±å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œk8sä¸­å®¢æˆ·ç«¯æœ‰ä¸¤ç±»ï¼Œä¸€ç§æ˜¯æ™®é€šç”¨æˆ·ï¼Œä¸€ç§æ˜¯é›†ç¾¤å†…çš„Podï¼Œè¿™ä¸¤ç§å®¢æˆ·ç«¯çš„è®¤è¯æœºåˆ¶ç•¥æœ‰ä¸åŒï¼Œåæ–‡ä¼šè¯¦è¿°ã€‚ä½†æ— è®ºæ˜¯å“ªä¸€ç§ï¼Œéƒ½éœ€è¦ä¾æ¬¡ç»è¿‡è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥è¿™ä¸‰ä¸ªæœºåˆ¶ã€‚ kubernetes ä¸­çš„è®¤è¯æœºåˆ¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œkubernetesè™½ç„¶æä¾›äº†å¤šç§è®¤è¯æœºåˆ¶ï¼Œä½†å¹¶æ²¡æœ‰æä¾›user å®ä½“ä¿¡æ¯çš„å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè´¦æˆ·ä½“ç³»éœ€è¦æˆ‘ä»¬è‡ªå·±å»åšç»´æŠ¤ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥æ¥å…¥ç¬¬ä¸‰æ–¹è´¦æˆ·ä½“ç³»ï¼ˆå¦‚è°·æ­Œè´¦æˆ·ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¼€æºçš„keystoneå»åšæ•´åˆã€‚kubernetes æ”¯æŒå¤šç§è®¤è¯æœºåˆ¶ï¼Œå¯ä»¥é…ç½®æˆå¤šä¸ªè®¤è¯ä½“åˆ¶å…±å­˜ï¼Œè¿™æ ·ï¼Œåªè¦æœ‰ä¸€ä¸ªè®¤è¯é€šè¿‡ï¼Œè¿™ä¸ªrequestå°±è®¤è¯é€šè¿‡äº†ã€‚ä¸‹é¢åˆ—ä¸¾çš„æ˜¯å®˜ç½‘å‡ ç§å¸¸è§è®¤è¯æœºåˆ¶ï¼š X509 Client Certs Static Token File Bootstrap Tokens Static Password File Service Account Tokens OpenID Connect Tokens è¿™é‡Œæˆ‘ä¸»è¦è¿˜æ˜¯ç†è§£ä¸€ä¸‹å¸¸ç”¨è®¤è¯æ–¹å¼: X509 Client Certsä¹Ÿå«ä½œåŒå‘æ•°å­—è¯ä¹¦è®¤è¯ï¼ŒHTTPSè¯ä¹¦è®¤è¯ï¼Œæ˜¯åŸºäºCAæ ¹è¯ä¹¦ç­¾åçš„åŒå‘æ•°å­—è¯ä¹¦è®¤è¯æ–¹å¼ï¼Œæ˜¯æ‰€æœ‰è®¤è¯æ–¹å¼ä¸­æœ€ä¸¥æ ¼çš„è®¤è¯ã€‚é»˜è®¤åœ¨kubeadmåˆ›å»ºçš„é›†ç¾¤ä¸­æ˜¯enabledçš„ï¼Œå¯ä»¥åœ¨master nodeä¸ŠæŸ¥çœ‹kube-apiserverçš„podé…ç½®æ–‡ä»¶ï¼š 12345678910111213141516171819202122232425$ cat /usr/lib/systemd/system/kube-apiserver.service....................ExecStart=/usr/local/bin/kube-apiserver \\ --v=2 \\ --logtostderr=true \\ --allow-privileged=true \\ --bind-address=0.0.0.0 \\ --secure-port=6443 \\ --insecure-port=0 \\ --advertise-address=192.168.56.110 \\ --service-cluster-ip-range=10.96.0.0/12 \\ --service-node-port-range=30000-32767 \\ --etcd-servers=https://192.168.56.111:2379,https://192.168.56.112:2379,https://192.168.56.113:2379 \\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\....................","text":"æ¦‚è¿°é¦–å…ˆéœ€è¦äº†è§£è¿™ä¸‰ç§æœºåˆ¶çš„åŒºåˆ«ï¼š è®¤è¯(Authenticating)æ˜¯å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ï¼Œé€šä¿—ç‚¹å°±æ˜¯ç”¨æˆ·åå¯†ç éªŒè¯ï¼Œ æˆæƒ(Authorization)æ˜¯å¯¹èµ„æºçš„æˆæƒï¼Œk8sä¸­çš„èµ„æºæ— éæ˜¯å®¹å™¨ï¼Œæœ€ç»ˆå…¶å®å°±æ˜¯å®¹å™¨çš„è®¡ç®—ï¼Œç½‘ç»œï¼Œå­˜å‚¨èµ„æºï¼Œå½“ä¸€ä¸ªè¯·æ±‚ç»è¿‡è®¤è¯åï¼Œéœ€è¦è®¿é—®æŸä¸€ä¸ªèµ„æºï¼ˆæ¯”å¦‚åˆ›å»ºä¸€ä¸ªpodï¼‰ï¼Œæˆæƒæ£€æŸ¥éƒ½ä¼šé€šè¿‡è®¿é—®ç­–ç•¥æ¯”è¾ƒè¯¥è¯·æ±‚ä¸Šä¸‹æ–‡çš„å±æ€§ï¼Œï¼ˆæ¯”å¦‚ç”¨æˆ·ï¼Œèµ„æºå’ŒNamespaceï¼‰ï¼Œæ ¹æ®æˆæƒè§„åˆ™åˆ¤å®šè¯¥èµ„æºï¼ˆæ¯”å¦‚æŸnamespaceä¸‹çš„podï¼‰æ˜¯å¦æ˜¯è¯¥å®¢æˆ·å¯è®¿é—®çš„ã€‚ å‡†å…¥(Admission Control)æœºåˆ¶æ˜¯ä¸€ç§åœ¨æ”¹å˜èµ„æºçš„æŒä¹…åŒ–ä¹‹å‰ï¼ˆæ¯”å¦‚æŸäº›èµ„æºçš„åˆ›å»ºæˆ–åˆ é™¤ï¼Œä¿®æ”¹ç­‰ä¹‹å‰ï¼‰çš„æœºåˆ¶ã€‚åœ¨k8sä¸­ï¼Œè¿™ä¸‰ç§æœºåˆ¶å¦‚ä¸‹å›¾ï¼šk8sçš„æ•´ä½“æ¶æ„ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡çš„æ¶æ„ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªGateWayï¼Œä¹Ÿå°±æ˜¯kube-apiserverè¿™ä¸ªç»„ä»¶ï¼ˆå¯¹å¤–æä¾›RESTæœåŠ¡ï¼‰ï¼Œç”±å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œk8sä¸­å®¢æˆ·ç«¯æœ‰ä¸¤ç±»ï¼Œä¸€ç§æ˜¯æ™®é€šç”¨æˆ·ï¼Œä¸€ç§æ˜¯é›†ç¾¤å†…çš„Podï¼Œè¿™ä¸¤ç§å®¢æˆ·ç«¯çš„è®¤è¯æœºåˆ¶ç•¥æœ‰ä¸åŒï¼Œåæ–‡ä¼šè¯¦è¿°ã€‚ä½†æ— è®ºæ˜¯å“ªä¸€ç§ï¼Œéƒ½éœ€è¦ä¾æ¬¡ç»è¿‡è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥è¿™ä¸‰ä¸ªæœºåˆ¶ã€‚ kubernetes ä¸­çš„è®¤è¯æœºåˆ¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œkubernetesè™½ç„¶æä¾›äº†å¤šç§è®¤è¯æœºåˆ¶ï¼Œä½†å¹¶æ²¡æœ‰æä¾›user å®ä½“ä¿¡æ¯çš„å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè´¦æˆ·ä½“ç³»éœ€è¦æˆ‘ä»¬è‡ªå·±å»åšç»´æŠ¤ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥æ¥å…¥ç¬¬ä¸‰æ–¹è´¦æˆ·ä½“ç³»ï¼ˆå¦‚è°·æ­Œè´¦æˆ·ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¼€æºçš„keystoneå»åšæ•´åˆã€‚kubernetes æ”¯æŒå¤šç§è®¤è¯æœºåˆ¶ï¼Œå¯ä»¥é…ç½®æˆå¤šä¸ªè®¤è¯ä½“åˆ¶å…±å­˜ï¼Œè¿™æ ·ï¼Œåªè¦æœ‰ä¸€ä¸ªè®¤è¯é€šè¿‡ï¼Œè¿™ä¸ªrequestå°±è®¤è¯é€šè¿‡äº†ã€‚ä¸‹é¢åˆ—ä¸¾çš„æ˜¯å®˜ç½‘å‡ ç§å¸¸è§è®¤è¯æœºåˆ¶ï¼š X509 Client Certs Static Token File Bootstrap Tokens Static Password File Service Account Tokens OpenID Connect Tokens è¿™é‡Œæˆ‘ä¸»è¦è¿˜æ˜¯ç†è§£ä¸€ä¸‹å¸¸ç”¨è®¤è¯æ–¹å¼: X509 Client Certsä¹Ÿå«ä½œåŒå‘æ•°å­—è¯ä¹¦è®¤è¯ï¼ŒHTTPSè¯ä¹¦è®¤è¯ï¼Œæ˜¯åŸºäºCAæ ¹è¯ä¹¦ç­¾åçš„åŒå‘æ•°å­—è¯ä¹¦è®¤è¯æ–¹å¼ï¼Œæ˜¯æ‰€æœ‰è®¤è¯æ–¹å¼ä¸­æœ€ä¸¥æ ¼çš„è®¤è¯ã€‚é»˜è®¤åœ¨kubeadmåˆ›å»ºçš„é›†ç¾¤ä¸­æ˜¯enabledçš„ï¼Œå¯ä»¥åœ¨master nodeä¸ŠæŸ¥çœ‹kube-apiserverçš„podé…ç½®æ–‡ä»¶ï¼š 12345678910111213141516171819202122232425$ cat /usr/lib/systemd/system/kube-apiserver.service....................ExecStart=/usr/local/bin/kube-apiserver \\ --v=2 \\ --logtostderr=true \\ --allow-privileged=true \\ --bind-address=0.0.0.0 \\ --secure-port=6443 \\ --insecure-port=0 \\ --advertise-address=192.168.56.110 \\ --service-cluster-ip-range=10.96.0.0/12 \\ --service-node-port-range=30000-32767 \\ --etcd-servers=https://192.168.56.111:2379,https://192.168.56.112:2379,https://192.168.56.113:2379 \\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\.................... ç›¸å…³çš„ä¸‰ä¸ªå¯åŠ¨å‚æ•°ï¼š client-ca-file: æŒ‡å®šCAæ ¹è¯ä¹¦æ–‡ä»¶ä¸º/etc/kubernetes/pki/ca.pem tls-private-key-file: æŒ‡å®šApiServerç§é’¥æ–‡ä»¶ä¸º/etc/kubernetes/pki/apiserver-key.pem tls-cert-fileï¼šæŒ‡å®šApiServerè¯ä¹¦æ–‡ä»¶ä¸º/etc/kubernetes/pki/apiserver.pem è¯·æ±‚ä¸­éœ€è¦å¸¦æœ‰ç”±è¯¥è¯ä¹¦ç­¾åçš„è¯ä¹¦ï¼Œæ‰èƒ½è®¤è¯é€šè¿‡ï¼Œå®¢æˆ·ç«¯ç­¾ç½²çš„è¯ä¹¦é‡ŒåŒ…å«user,groupä¿¡æ¯ï¼Œå…·ä½“ä¸ºè¯ä¹¦çš„subject.CommonName(username)ä»¥åŠsubject.Organization(group) ![x509](kubernetes-auth/x509.png) Service Account TokensService Account Token æ˜¯ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„è®¤è¯æœºåˆ¶ï¼Œé€‚ç”¨äºä¸Šæ–‡ä¸­æåˆ°çš„podå†…éƒ¨æœåŠ¡éœ€è¦è®¿é—®apiserverçš„è®¤è¯æƒ…å†µï¼Œé»˜è®¤enabledã€‚è¿˜æ˜¯çœ‹ä¸Šæ–‡ä¸­apiserver çš„å¯åŠ¨é…ç½®å‚æ•°æœ‰â€“service-account-key-fileï¼Œå¦‚æœæ²¡æœ‰æŒ‡æ˜æ–‡ä»¶ï¼Œé»˜è®¤ä½¿ç”¨â€“tls-private-key-fileçš„å€¼ï¼Œå³API Serverçš„ç§é’¥ã€‚ ![ServiceAccountå·¥ä½œæµç¨‹](kubernetes-auth/sa.png) é€šè¿‡æ§åˆ¶å™¨ServiceAccountControllerä¼šå»list,watch k8s apiserverå¯¹äºå‘½åç©ºé—´çš„åˆ›å»ºã€åˆ é™¤ï¼›å°±ä¼šåœ¨æ–°åˆ›å»ºçš„åç§°ç©ºé—´ä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºâ€defaultâ€çš„service account; TokenController æ ¹æ®åˆ›å»ºçš„ServiceAccountä¸‹é¢å…³è”ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰Tokençš„secretã€‚Admission æ˜¯åœ¨é€šè¿‡è®¤è¯è¿›è¡Œé‰´æƒçš„ä¸€ä¸ªé˜¶æ®µï¼Œé‚£ä¹ˆä»–ä¼šé»˜è®¤ç»™å½“å‰åç§°ç©ºé—´ä¸‹çš„podæ‰“ä¸Šï¼Œå½“å‰åç§°ç©ºé—´çš„é‚£ä¸ªServiceAccountã€‚ service accoutæœ¬èº«æ˜¯ä½œä¸ºä¸€ç§èµ„æºåœ¨k8sé›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè·å– 1234567891011121314151617181920212223242526272829303132333435363738394041$ kubectl get sa --all-namespacesNAMESPACE NAME SECRETS AGEdefault default 1 16dkube-system default 1 16dkube-public default 1 16dkube-system attachdetach-controller 1 16dkube-system bootstrap-signer 1 16dkube-system calico-node 1 16......................$ kubectl describe serviceaccount/default -n kube-systemName: defaultNamespace: kube-systemLabels: &lt;none&gt;Annotations: &lt;none&gt;Image pull secrets: &lt;none&gt;Mountable secrets: default-token-q9s9lTokens: default-token-q9s9lEvents: &lt;none&gt;$ kubectl get secret default-token-q9s9l -o yaml -n kube-systemapiVersion: v1data: ca.crt: LS0tLS1CRUdJ ...............ç•¥ namespace: a3ViZS1zeXN0ZW0= token: ZXlKaGJHY2lPaUpTVX- ...............ç•¥kind: Secretmetadata: annotations: kubernetes.io/service-account.name: default kubernetes.io/service-account.uid: a5568634-f445-11e8-b4c4-000c295134cf creationTimestamp: 2018-11-30T02:14:19Z name: default-token-q9s9l namespace: kube-system resourceVersion: \"337\" selfLink: /api/v1/namespaces/kube-system/secrets/default-token-q9s9l uid: a56521fd-f445-11e8-aa44-000c29fe5618type: kubernetes.io/service-account-token[root@k8s-m1 kubelet]# å¯ä»¥çœ‹åˆ°service-account-tokençš„secretèµ„æºåŒ…å«çš„æ•°æ®æœ‰ä¸‰éƒ¨åˆ†ï¼š ca.crtï¼Œè¿™æ˜¯API Serverçš„CAå…¬é’¥è¯ä¹¦ï¼Œç”¨äºPodä¸­çš„Processå¯¹API Serverçš„æœåŠ¡ç«¯æ•°å­—è¯ä¹¦è¿›è¡Œæ ¡éªŒæ—¶ä½¿ç”¨çš„ï¼› namespaceï¼Œè¿™æ˜¯Secretæ‰€åœ¨namespaceçš„å€¼çš„base64ç¼–ç ï¼š# echo -n â€œkube-systemâ€|base64 =&gt; â€œa3ViZS1zeXN0ZW0=â€ tokenï¼šè¯¥tokenå°±æ˜¯ç”±service-account-key-fileçš„å€¼ç­¾ç½²(sign)ç”Ÿæˆã€‚ API Serverçš„service account authentication(èº«ä»½éªŒè¯)å‰é¢è¯´è¿‡ï¼Œservice accountä¸ºPodä¸­çš„Processæä¾›äº†ä¸€ç§èº«ä»½æ ‡è¯†ï¼Œåœ¨Kubernetesçš„èº«ä»½æ ¡éªŒ(authenticating)ç¯èŠ‚ï¼Œä»¥æŸä¸ªservice accountæä¾›èº«ä»½çš„Podçš„ç”¨æˆ·åä¸ºï¼š 1system:serviceaccount:(NAMESPACE):(SERVICEACCOUNT) ä»¥ä¸Šé¢é‚£ä¸ªkube-system namespaceä¸‹çš„default service accountä¸ºä¾‹ï¼Œä½¿ç”¨å®ƒçš„Podçš„usernameå…¨ç§°ä¸ºï¼š 1system:serviceaccount:kube-system:default é»˜è®¤çš„service accountKubernetesä¼šä¸ºæ¯ä¸ªclusterä¸­çš„namespaceè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„service accountèµ„æºï¼Œå¹¶å‘½åä¸ºâ€defaultâ€. å¦‚æœPodä¸­æ²¡æœ‰æ˜¾å¼æŒ‡å®šspec.serviceAccountå­—æ®µå€¼(è‡ªå®šä¹‰Admission)ï¼Œé‚£ä¹ˆKubernetesä¼šé»˜è®¤å°†è¯¥namespaceä¸‹çš„default service accountè‡ªåŠ¨mountåˆ°åœ¨è¿™ä¸ªnamespaceä¸­åˆ›å»ºçš„Podé‡Œï¼Œé‚£è¿™ä¸ªæ“ä½œå°±æ˜¯é€šè¿‡ä¸Šé¢æ‰€è¯´çš„ServiceAccountAdmissionæ¥å®ç°çš„ã€‚æˆ‘ä»¬ä»¥namespace â€œdefaultâ€ä¸ºä¾‹ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹å…¶ä¸­çš„ä¸€ä¸ªPodçš„ä¿¡æ¯ï¼š 123456789101112131415161718192021222324$ kubectl describe pod nginx-64f497f8fd-lkmdrName: nginx-64f497f8fd-lkmdrNamespace: default............Containers:............ Mounts: /var/run/secrets/kubernetes.io/serviceaccount from default-token-d5d8g (ro)Conditions: Type Status Initialized True Ready False ContainersReady False PodScheduled TrueVolumes: ...... ......Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 27s default-scheduler Successfully assigned default/nginx-64f497f8fd-lkmdr to k8s-m3 Normal Pulling 17s kubelet, k8s-m3 pulling image \"nginx\" å¯ä»¥çœ‹åˆ°ï¼Œkuberneteså°†default namespaceä¸­çš„service account â€œdefaultâ€çš„service account tokenæŒ‚è½½(mount)åˆ°äº†Podä¸­å®¹å™¨çš„/var/run/secrets/kubernetes.io/serviceaccountè·¯å¾„ä¸‹ã€‚ æ·±å…¥å®¹å™¨å†…éƒ¨ï¼ŒæŸ¥çœ‹mountçš„serviceaccountè·¯å¾„ä¸‹çš„ç»“æ„ï¼š 123456$ kubectl exec nginx-64f497f8fd-lkmdr -- ls /var/run/secrets/kubernetes.io/serviceaccountca.crtnamespacetoken# è¿™ä¸‰ä¸ªæ–‡ä»¶ä¸ä¸Šé¢æåˆ°çš„service accountçš„tokenä¸­çš„æ•°æ®æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ å¦‚ä½•åˆ›å»ºä¸€ä¸ªServiceAccount1234567891011121314# é€šè¿‡å‘½ä»¤è¡Œç›´æ¥åˆ›å»º$ kubectl create sa myk8ssaserviceaccount/myk8ssa created$ kubectl describe sa/myk8ssaName: mysaNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Image pull secrets: &lt;none&gt;Mountable secrets: mysa-token-kcwqmTokens: mysa-token-kcwqmEvents: &lt;none&gt;# å¦‚ä½•ä½¿ç”¨ï¼Ÿä¸‹é¢æˆ‘åœ¨è®¨è®º kubernetes ä¸­çš„é‰´æƒæœºåˆ¶ç›®å‰ï¼Œk8s ä¸­ä¸€å…±æœ‰ 4 ç§é‰´æƒæƒé™æ¨¡å¼ï¼š Node: ä¸€ç§ç‰¹æ®Šç›®çš„çš„æˆæƒæ¨¡å¼ï¼Œä¸»è¦ç”¨æ¥è®© kubernetes éµä» node çš„ç¼–æ’è§„åˆ™ï¼Œå®é™…ä¸Šæ˜¯ RBAC çš„ä¸€éƒ¨åˆ†ï¼Œç›¸å½“äºåªå®šä¹‰äº† node è¿™ä¸ªè§’è‰²ä»¥åŠå®ƒçš„æƒé™ï¼› ABAC: Attribute-based access controlï¼› RBAC: Role-based access controlï¼› Webhook: ä»¥ HTTP Callback çš„æ–¹å¼ï¼Œåˆ©ç”¨å¤–éƒ¨æˆæƒæ¥å£æ¥è¿›è¡Œæƒé™æ§åˆ¶ï¼› è¿™é‡Œæˆ‘ä¸»è¦å­¦ä¹ æ€»ç»“æœ€å¸¸ç”¨çš„é‰´æƒæ–¹å¼â€”RBACRBACçš„é‰´æƒç­–ç•¥å¯ä»¥åˆ©ç”¨ kubectl æˆ–è€… Kubernetes API ç›´æ¥è¿›è¡Œé…ç½®ã€‚RBAC å¯ä»¥æˆæƒç»™ç”¨æˆ·ï¼Œè®©ç”¨æˆ·æœ‰æƒè¿›è¡Œæˆæƒç®¡ç†ï¼Œè¿™æ ·å°±å¯ä»¥æ— éœ€æ¥è§¦èŠ‚ç‚¹ï¼Œç›´æ¥è¿›è¡Œæˆæƒç®¡ç†ã€‚RBAC åœ¨ Kubernetes ä¸­è¢«æ˜ å°„ä¸º API èµ„æºå’Œæ“ä½œã€‚ ![RBAC](kubernetes-auth/RBAC.png) éœ€è¦ç†è§£ RBAC ä¸€äº›åŸºç¡€çš„æ¦‚å¿µå’Œæ€è·¯ï¼ŒRBAC æ˜¯è®©ç”¨æˆ·èƒ½å¤Ÿè®¿é—® Kubernetes API èµ„æºçš„æˆæƒæ–¹å¼ã€‚ roleè§’è‰²æ˜¯ä¸€ç³»åˆ—æƒé™çš„é›†åˆï¼Œä¾‹å¦‚ä¸€ä¸ªè§’è‰²å¯ä»¥åŒ…å«è¯»å– Pod çš„æƒé™å’Œåˆ—å‡º Pod çš„æƒé™ï¼Œ ClusterRole è·Ÿ Role ç±»ä¼¼ï¼Œä½†æ˜¯å¯ä»¥åœ¨é›†ç¾¤ä¸­åˆ°å¤„ä½¿ç”¨ï¼ˆ Role æ˜¯ namespace ä¸€çº§çš„ï¼‰ã€‚role bindingRoleBinding æŠŠè§’è‰²æ˜ å°„åˆ°ç”¨æˆ·ï¼Œä»è€Œè®©è¿™äº›ç”¨æˆ·ç»§æ‰¿è§’è‰²åœ¨ namespace ä¸­çš„æƒé™ã€‚ClusterRoleBinding è®©ç”¨æˆ·ç»§æ‰¿ ClusterRole åœ¨æ•´ä¸ªé›†ç¾¤ä¸­çš„æƒé™ã€‚ å¦å¤–è¿˜è¦è€ƒè™‘cluster roleså’Œcluster role bindingã€‚cluster roleå’Œcluster role bindingæ–¹æ³•è·Ÿroleå’Œrole bindingä¸€æ ·ï¼Œå‡ºäº†å®ƒä»¬æœ‰æ›´å¹¿çš„scopeã€‚ Kubernetesä¸­çš„RBACRBAC ç°åœ¨è¢« Kubernetes æ·±åº¦é›†æˆï¼Œå¹¶ä½¿ç”¨ä»–ç»™ç³»ç»Ÿç»„ä»¶è¿›è¡Œæˆæƒã€‚System Roles ä¸€èˆ¬å…·æœ‰å‰ç¼€system:ï¼Œå¾ˆå®¹æ˜“è¯†åˆ«ï¼š 1234567891011121314151617181920212223242526$ kubectl get clusterroles --namespace=kube-systemNAME AGEadmin 16danonymous-dashboard-proxy-role 16dcalico-node 16dcalicoctl 16dcluster-admin 16dedit 16dsystem:aggregate-to-admin 16dsystem:aggregate-to-edit 16dsystem:aggregate-to-view 16dsystem:auth-delegator 16dsystem:aws-cloud-provider 16dsystem:basic-user 16dsystem:certificates.k8s.io:certificatesigningrequests:nodeclient 16dsystem:certificates.k8s.io:certificatesigningrequests:selfnodeclient 16dsystem:controller:attachdetach-controller 16dsystem:controller:certificate-controller 16dsystem:controller:clusterrole-aggregation-controller 16dsystem:controller:cronjob-controller 16dsystem:controller:daemon-set-controller 16dsystem:controller:deployment-controller 16dsystem:controller:disruption-controller 16dsystem:controller:endpoint-controller 16dsystem:controller:expand-controller 16d......ç•¥ ç¤ºä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657$ cat &gt;&gt; role.yaml &lt;&lt; EOFkind: RoleapiVersion: rbac.authorization.k8s.io/v1metadata: namespace: default name: pod-readerrules: - apiGroups: [\"\"] # \"\" indicates the core API group resources: [\"pods\"] # å¯ç”¨æ“ä½œèµ„æºå¯¹è±¡ verbs: [\"get\", \"watch\", \"list\"] # å¯¹ä¸Šé¢å®šä¹‰èµ„æºæœ‰å“ªäº›æ“ä½œæƒé™EOF$ cat &gt;&gt; rolebinding.yaml &lt;&lt; EOFkind: RoleBindingapiVersion: rbac.authorization.k8s.io/v1beta1metadata: name: pod-reader-binding namespace: defaultsubjects: - kind: ServiceAccount name: mysa namespace: defaultroleRef: kind: Role name: pod-reader apiGroup: rbac.authorization.k8s.ioEOF# æ‰§è¡Œåˆ›å»º$ kubectl create -f role.yamlrole.rbac.authorization.k8s.io/pod-reader created$ kubectl create -f rolebinding.yamlrolebinding.rbac.authorization.k8s.io/pod-reader-binding created[root@k8s-m1 ~]# kubectl get roleNAME AGEpod-reader 36s[root@k8s-m1 ~]# kubectl describe role pod-readerName: pod-readerLabels: &lt;none&gt;Annotations: &lt;none&gt;PolicyRule: Resources Non-Resource URLs Resource Names Verbs --------- ----------------- -------------- ----- pods [] [] [get watch list]$ kubectl describe rolebinding pod-reader-bindingName: pod-reader-bindingLabels: &lt;none&gt;Annotations: &lt;none&gt;Role: Kind: Role Name: pod-readerSubjects: Kind Name Namespace ---- ---- --------- ServiceAccount mysa default ä¸Šé¢ï¼Œ æˆ‘å®šä¹‰äº†ä¸€ä¸ªpod-readerçš„role,å…¶ä¸­å®ƒçš„æƒé™å®šä¹‰å¦‚ä¸Šæ–¹å®šä¹‰çš„get,watch,list; ç„¶åå®šä¹‰äº†ä¸€ä¸ªpod-reader-bindingçš„rolebindingå‰é¢æåˆ°è¿‡ï¼›ç”¨æˆ·é€šè¿‡è®¤è¯ä¹‹åå°±æ˜¯é‰´æƒï¼Œé€šè¿‡SAçš„è®¤è¯æ–¹å¼ä¹‹åæ‹¿åˆ°userinfo,ç„¶åç»‘å®šåˆ°roleé‡Œé¢ï¼›é‚£ä¹ˆæ­¤æ—¶å¯¹åº”çš„ç”¨æˆ·æƒé™å°±æ˜¯roleé‡Œé¢å®šä¹‰çš„æƒé™ï¼Œsubjectsåº”ç”¨çš„å¯¹è±¡ç±»å‹ä¹Ÿå¯ä»¥æ˜¯User,Group;æ€»ä¹‹æ­¤æ—¶è¿™ä¸€æ­¥å°±æ˜¯è·å–åˆ°userinfoä¿¡æ¯ï¼Œç„¶åé€šè¿‡è§’è‰²ç»‘å®šã€‚ç›¸å¯¹åº”çš„æƒé™å°±ä¼šèµ‹äºˆè¯¥ç”¨æˆ·ã€‚é‚£ç”¨æˆ·ä»ä½•è€Œæ¥ï¼Ÿä¸‹é¢å°±éœ€è¦åˆ›å»ºä¸€ä¸ªç”¨æˆ·æ¥è®¿é—®æˆ‘ä»¬çš„é›†ç¾¤äº†ã€‚ é‚£å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ServiceAccountæ¥ç™»å½•å¹¶ä¸”é€šè¿‡è‡ªå®šä¹‰çš„è¿™ä¸ªRBACæ¥é‰´æƒå‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°äº†kubeconfigæ–‡ä»¶ç”Ÿæˆçš„é—®é¢˜äº† åˆ›å»ºkubeconfigè·å–ä¸Šé¢å·²åˆ›å»ºçš„ServiceAccountçš„Seteråç§°è¿™é‡Œæˆ‘æ˜¯åœ¨é»˜è®¤namespaceä¸‹é¢åˆ›å»ºçš„ã€‚ 123456789$ kubectl describe sa/myk8ssaName: myk8ssaNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Image pull secrets: &lt;none&gt;Mountable secrets: myk8ssa-token-2kntdTokens: myk8ssa-token-2kntdEvents: &lt;none&gt; è·å–secretä¸‹çš„tokenï¼Œå¹¶base64è§£ç è·å–tokenæ˜æ–‡123$ token=`kubectl get secret myk8ssa-token-2kntd -oyaml |grep token: | awk '{print $2}' | xargs echo -n | base64 -d`$ echo $tokeneyJhbGciOiJSUzI1......ç•¥ æ–°å¢ç”¨æˆ·guomaoqiu123456789101112131415$ kubectl config set-cluster my-k8s --server=https://192.168.56.110:8443 \\--certificate-authority=/etc/kubernetes/pki/ca.pem \\--embed-certs=trueCluster \"my-k8s\" set.$ kubectl config set-credentials guomaoqiu --token=$tokenUser \"guomaoqiu\" set.# è®¾ç½®ä¸Šä¸‹æ–‡$ kubectl config set-context my-k8s --cluster=kubernetesContext \"my-k8s\" created.# ç¡®è®¤ç”¨æˆ·ä¿¡æ¯$ kubectl config set-context my-k8s --user=guomaoqiuContext \"my-k8s\" modified. éªŒè¯123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354$ kubectl config get-contextsCURRENT NAME CLUSTER AUTHINFO NAMESPACE kubernetes-admin@kubernetes kubernetes kubernetes-admin* my-k8s kubernetes guomaoqiu# å°†å…¶è®¾ç½®ä¸ºå½“å‰é»˜è®¤ä¸Šä¸‹æ–‡:$ kubectl config use-context my-k8sSwitched to context \"my-k8s\".# è·å–POD:$ kubectl get podNAME READY STATUS RESTARTS AGEnginx-64f497f8fd-4qdnt 1/1 Running 0 10m# å°è¯•åˆ é™¤POD:$ kubectl delete pod nginx-64f497f8fd-4qdntError from server (Forbidden): pods \"nginx-64f497f8fd-4qdnt\" is forbidden: User \"system:serviceaccount:default:myk8ssa\" cannot delete pods in the namespace \"default\"# å¯è§ï¼Œè¯¥ç”¨æˆ·çš„çš„æƒé™åªæœ‰å¯è¯»ï¼Œè€Œæ²¡æœ‰åˆ é™¤çš„æƒé™ï¼›# è¯´æ˜é…ç½®æ˜¯æˆåŠŸäº†çš„ã€‚# æµè§ˆä¸€ä¸‹å½“å‰æˆ‘ç¯å¢ƒä¸­æœ‰å“ªäº›kubeconfig?$ kubectl config viewapiVersion: v1clusters:- cluster: certificate-authority-data: REDACTED server: https://192.168.56.110:8443 name: kubernetes- cluster: certificate-authority-data: REDACTED server: https://192.168.56.110:8443 name: my-k8scontexts:- context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetes- context: cluster: kubernetes user: guomaoqiu name: my-k8scurrent-context: my-k8s # å½“å‰ç¯å¢ƒkind: Configpreferences: {}users:- name: guomaoqiu user: token:......ç•¥- name: kubernetes-admin user: client-certificate-data: REDACTED client-key-data: REDACTED é€šè¿‡namespaceæˆ‘ä»¬å¯ä»¥åšåˆ°ä¸åŒä¸šåŠ¡ä¹‹é—´çš„éš”ç¦»ï¼Œå¦‚æœå†åŠ ä¸Šå¦‚ä¸Šè¿™ç§æƒé™æ§åˆ¶å°†ä¼šæ›´åŠ ç»†åŒ–ã€ä»¥ä¸Šå®éªŒä¸»è¦æ˜¯åœ¨é»˜è®¤çš„namespaceä¸‹é¢æ“ä½œï¼Œé™¤æ­¤ä¹‹å¤–ä¹Ÿå¯ä»¥æ–°å»ºnamespaceç„¶åè¿›è¡ŒéªŒè¯æ“ä½œã€‚kubeconfigåˆ‡æ¢ä¸Šä¸‹æ–‡ä¹Ÿæ˜¯éå¸¸å®ç”¨çš„ä¸€ç§åŠŸèƒ½ã€‚å¸¸ç”¨å‘½ä»¤ï¼š 12345678kubectl - ä½¿ç”¨kubectlæ¥ç®¡ç†Kubernetesé›†ç¾¤ã€‚kubectl config set - åœ¨kubeconfigé…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªå•ç‹¬çš„å€¼ã€‚kubectl config set-cluster - åœ¨kubeconfigé…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªé›†ç¾¤é¡¹ã€‚kubectl config set-context - åœ¨kubeconfigé…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªç¯å¢ƒé¡¹ã€‚kubectl config set-credentials - åœ¨kubeconfigé…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªç”¨æˆ·é¡¹ã€‚kubectl config unset - åœ¨kubeconfigé…ç½®æ–‡ä»¶ä¸­æ¸…é™¤ä¸€ä¸ªå•ç‹¬çš„å€¼ã€‚kubectl config use-context - ä½¿ç”¨kubeconfigä¸­çš„ä¸€ä¸ªç¯å¢ƒé¡¹ä½œä¸ºå½“å‰é…ç½®ã€‚kubectl config view - æ˜¾ç¤ºåˆå¹¶åçš„kubeconfigè®¾ç½®ï¼Œæˆ–è€…ä¸€ä¸ªæŒ‡å®šçš„kubeconfigé…ç½®æ–‡ä»¶ã€‚ kubernetes ä¸­çš„å‡†å…¥æœºåˆ¶Kubernetesçš„Admission Controlå®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡†å…¥æ§åˆ¶å™¨(Admission Controller)æ’ä»¶åˆ—è¡¨ï¼Œå‘é€åˆ°APIServerçš„è¯·æ±‚éƒ½éœ€è¦ç»è¿‡è¿™ä¸ªåˆ—è¡¨ä¸­çš„æ¯ä¸ªå‡†å…¥æ§åˆ¶å™¨æ’ä»¶çš„æ£€æŸ¥ï¼Œå¦‚æœæŸä¸€ä¸ªæ§åˆ¶å™¨æ’ä»¶å‡†å…¥å¤±è´¥ï¼Œå°±å‡†å…¥å¤±è´¥ã€‚æ›´å¤šå¯æŸ¥çœ‹: http://docs.kubernetes.org.cn/144.htmlè¿™é‡Œæˆ‘ä»¬ä¸»è¦å­¦ä¹ PodSecurityPolicy å®‰å…¨ä¸Šä¸‹æ–‡(Pod SecurityContext)åˆ†ä¸ºPodçº§åˆ«å’Œå®¹å™¨çº§åˆ«ï¼Œå®¹å™¨çº§åˆ«çš„ä¼šè¦†ç›–Podçº§åˆ«çš„ç›¸åŒè®¾ç½®ã€‚åœ¨æœ‰PodSecurityPolicyç­–ç•¥çš„æƒ…å†µä¸‹ï¼Œä¸¤è€…éœ€è¦é…åˆä½¿ç”¨; 12345678910111213141516171819202122232425262728293031323334353637383940414243cat &gt;&gt; pod-security-policy.yaml &lt;&lt; EOFapiVersion: v1kind: Podmetadata: name: test-podspec: volumes: - name: test emptyDir: {} containers: - name: test-pod image: alpine imagePullPolicy: IfNotPresent command: ['sh', '-c', 'echo The app is running! &amp;&amp; sleep 36000'] volumeMounts: - name: test mountPath: /data/test securityContext: # è®¾ç½®å®¹å™¨å®‰å…¨ä¸Šä¸‹æ–‡ readOnlyRootFilesystem: false # å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æ˜¯åªè¯» privileged: false # æ˜¯å¦ä¸ºç‰¹æƒå®¹å™¨ runAsUser: 1000 # è¿›ç¨‹è¿è¡Œç”¨æˆ·UIDEOF# æ‰§è¡Œåˆ›å»º:$ kubectl create -f pod-security-policy.yamlpod/test-pod created# è¿›å…¥å®¹å™¨éªŒè¯ï¼š$ kubectl exec -it test-pod sh/ $ iduid=1000 gid=0(root)/ $ ps -efPID USER TIME COMMAND 1 1000 0:00 sleep 36000 6 1000 0:00 sh 15 1000 0:00 sh 21 1000 0:00 ps -ef/ $ sysctl -w net.ipv4.tcp_recovery=2sysctl: error setting key 'net.ipv4.tcp_recovery': Read-only file system/ $# ä»¥ä¸Šæˆ‘è®¾ç½®é™åˆ¶äº†podæ˜¯å¦å¼€å¯ç‰¹æƒæ¨¡å¼ï¼Œå¹¶ä¸”è¿è¡Œç”¨æˆ·uidä¸º1000# é‚£ä¹ˆå¦‚æœåœ¨podçº§åˆ«è®¾ç½®ä¸Šä¸‹æ–‡çš„è¯ï¼Œå®¹å™¨çº§åˆ«çš„ä¼šè¦†ç›–Podçº§åˆ«çš„ç›¸åŒè®¾ç½®(å·²éªŒè¯) å…¶ä»–æ›´å¤šå‚æ•°å‚è§: https://kubernetes.io/docs/concepts/policy/pod-security-policy/ è¿è¡Œæ€çš„å®‰å…¨æ§åˆ¶â€”ç½‘ç»œç­–ç•¥(NetworkPolicy)Kubernetesè¦æ±‚é›†ç¾¤ä¸­æ‰€æœ‰podï¼Œæ— è®ºæ˜¯èŠ‚ç‚¹å†…è¿˜æ˜¯è·¨èŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥ç›´æ¥é€šä¿¡ï¼Œæˆ–è€…è¯´æ‰€æœ‰podå·¥ä½œåœ¨åŒä¸€è·¨èŠ‚ç‚¹ç½‘ç»œï¼Œæ­¤ç½‘ç»œä¸€èˆ¬æ˜¯äºŒå±‚è™šæ‹Ÿç½‘ç»œï¼Œç§°ä¸ºpodç½‘ç»œã€‚åœ¨å®‰è£…å¼•å¯¼kubernetesæ—¶ï¼Œç”±é€‰æ‹©å¹¶å®‰è£…çš„network pluginå®ç°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä¸­æ‰€æœ‰podä¹‹é—´ã€podä¸èŠ‚ç‚¹ä¹‹é—´å¯ä»¥äº’é€šã€‚ ç½‘ç»œä¸»è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯è¿é€šæ€§ï¼Œå®ä½“ä¹‹é—´èƒ½å¤Ÿé€šè¿‡ç½‘ç»œäº’é€šã€‚å¦ä¸€ä¸ªæ˜¯éš”ç¦»æ€§ï¼Œå‡ºäºå®‰å…¨ã€é™åˆ¶ç½‘ç»œæµé‡çš„ç›®çš„ï¼Œåˆè¦æ§åˆ¶å®ä½“ä¹‹é—´çš„è¿é€šæ€§ã€‚Network Policyç”¨æ¥å®ç°éš”ç¦»æ€§ï¼Œåªæœ‰åŒ¹é…è§„åˆ™çš„æµé‡æ‰èƒ½è¿›å…¥podï¼ŒåŒç†åªæœ‰åŒ¹é…è§„åˆ™çš„æµé‡æ‰å¯ä»¥ç¦»å¼€podã€‚ ä½†è¯·æ³¨æ„ï¼Œkubernetesæ”¯æŒçš„ç”¨ä»¥å®ç°podç½‘ç»œçš„network pluginæœ‰å¾ˆå¤šç§ï¼Œå¹¶ä¸æ˜¯å…¨éƒ¨éƒ½æ”¯æŒNetwork Policyï¼Œä¸ºkubernetesé€‰æ‹©network pluginæ—¶éœ€è¦è€ƒè™‘åˆ°è¿™ç‚¹ï¼Œæ˜¯å¦éœ€è¦éš”ç¦»ï¼Ÿå¯ç”¨network pluginåŠæ˜¯å¦æ”¯æŒNetwork Policyè¯·å‚è€ƒè¿™é‡Œã€‚ åŸºæœ¬åŸç†Network Policyæ˜¯kubernetesä¸­çš„ä¸€ç§èµ„æºç±»å‹ï¼Œå®ƒä»å±äºæŸä¸ªnamespaceã€‚å…¶å†…å®¹ä»é€»è¾‘ä¸Šçœ‹åŒ…å«ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ï¼Œä¸€æ˜¯podé€‰æ‹©å™¨ï¼ŒåŸºäºæ ‡ç­¾é€‰æ‹©ç›¸åŒnamespaceä¸‹çš„podï¼Œå°†å…¶ä¸­å®šä¹‰çš„è§„åˆ™ä½œç”¨äºé€‰ä¸­çš„podã€‚å¦ä¸€ä¸ªå°±æ˜¯è§„åˆ™äº†ï¼Œå°±æ˜¯ç½‘ç»œæµé‡è¿›å‡ºpodçš„è§„åˆ™ï¼Œå…¶é‡‡ç”¨çš„æ˜¯ç™½åå•æ¨¡å¼ï¼Œç¬¦åˆè§„åˆ™çš„é€šè¿‡ï¼Œä¸ç¬¦åˆè§„åˆ™çš„æ‹’ç»ã€‚ 123456789101112131415161718192021222324252627282930313233apiVersion: networking.k8s.io/v1kind: NetworkPolicymetadata: name: test-network-policy namespace: defaultspec: podSelector: matchLabels: # è§„åˆ™é€‰æ‹©å™¨ï¼Œé€‰æ‹©åŒ¹é…çš„POD role: db policyTypes: - Ingress - Egress ingress: - from: - ipBlock: # è¿œç«¯(è®¿é—®ç«¯)IPç™½åå•å¼€æ”¾ cidr: 172.17.0.0/16 except: - 172.17.1.0/24 - namespaceSelector: # è¿œç«¯(è®¿é—®ç«¯)namespacesç™½åå•å¼€æ”¾ matchLabels: project: myproject - podSelector: # è¿œç«¯(è®¿é—®ç«¯)Podç™½åå•å¼€æ”¾ matchLabels: role: frontend ports: # æœ¬ç«¯(è¢«è®¿é—®ç«¯)å…è®¸è¢«è®¿é—®çš„ç«¯å£å’Œåè®® - protocol: TCP port: 6379 egress: - to: - ipBlock: cidr: 10.0.0.0/24 ports: - protocol: TCP å¯¹è±¡åˆ›å»ºæ–¹æ³•ä¸å…¶å®ƒå¦‚ReplicaSetç›¸åŒã€‚apiVersionã€kindã€metadataä¸å…¶å®ƒç±»å‹å¯¹è±¡å«ä¹‰ç›¸åŒï¼Œä¸è¯¦ç»†æè¿°ã€‚ .spec.PodSelectoré¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯podé€‰æ‹©å™¨ï¼ŒåŸºäºæ ‡ç­¾é€‰æ‹©ä¸Network Policyå¤„äºåŒä¸€namespaceä¸‹çš„podï¼Œå¦‚æœpodè¢«é€‰ä¸­ï¼Œåˆ™å¯¹å…¶åº”ç”¨Network Policyä¸­å®šä¹‰çš„è§„åˆ™ã€‚æ­¤ä¸ºå¯é€‰å­—æ®µï¼Œå½“æ²¡æœ‰æ­¤å­—æ®µæ—¶ï¼Œè¡¨ç¤ºé€‰ä¸­æ‰€æœ‰podã€‚ .spec.PolicyTypesNetwork Policyå®šä¹‰çš„è§„åˆ™å¯ä»¥åˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯å…¥podçš„Ingressè§„åˆ™ï¼Œä¸€ç§æ˜¯å‡ºpodçš„Egressè§„åˆ™ã€‚æœ¬å­—æ®µå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå¼€å…³ï¼Œå¦‚æœå…¶ä¸­åŒ…å«Ingressï¼Œåˆ™Ingresséƒ¨åˆ†å®šä¹‰çš„è§„åˆ™ç”Ÿæ•ˆï¼Œå¦‚æœæ˜¯Egressåˆ™Egresséƒ¨åˆ†å®šä¹‰çš„è§„åˆ™ç”Ÿæ•ˆï¼Œå¦‚æœéƒ½åŒ…å«åˆ™å…¨éƒ¨ç”Ÿæ•ˆã€‚å½“ç„¶æ­¤å­—æ®µä¹Ÿå¯é€‰ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œåˆ™é»˜è®¤Ingressç”Ÿæ•ˆï¼Œå¦‚æœEgresséƒ¨åˆ†æœ‰å®šä¹‰çš„è¯ï¼ŒEgressæ‰ç”Ÿæ•ˆã€‚æ€ä¹ˆç†è§£è¿™å¥è¯ï¼Œä¸‹æ–‡ä¼šæåˆ°ï¼Œæ²¡æœ‰æ˜ç¡®å®šä¹‰Ingressã€Egresséƒ¨åˆ†ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ç§è§„åˆ™ï¼Œé»˜è®¤è§„åˆ™è€Œéæ²¡æœ‰è§„åˆ™ã€‚ .spec.ingressä¸.spec.egresså‰è€…å®šä¹‰å…¥podè§„åˆ™ï¼Œåè€…å®šä¹‰å‡ºpodè§„åˆ™ï¼Œè¯¦ç»†å‚è€ƒè¿™é‡Œï¼Œè¿™é‡Œåªè®²ä¸€ä¸‹é‡ç‚¹ã€‚ä¸Šä¾‹ä¸­ingressä¸egresséƒ½åªåŒ…å«ä¸€æ¡è§„åˆ™ï¼Œä¸¤è€…éƒ½æ˜¯æ•°ç»„ï¼Œå¯ä»¥åŒ…å«å¤šæ¡è§„åˆ™ã€‚å½“åŒ…å«å¤šæ¡æ—¶ï¼Œæ¡ç›®ä¹‹é—´çš„é€»è¾‘å…³ç³»æ˜¯â€œæˆ–â€ï¼Œåªè¦åŒ¹é…å…¶ä¸­ä¸€æ¡å°±å¯ä»¥ã€‚.spec.ingress[].fromä¹Ÿæ˜¯æ•°ç»„ï¼Œæ•°ç»„æˆå‘˜å¯¹è®¿é—®podçš„å¤–éƒ¨sourceè¿›è¡Œæè¿°ï¼Œç¬¦åˆæ¡ä»¶çš„sourceæ‰å¯ä»¥è®¿é—®podï¼Œæœ‰å¤šç§æ–¹æ³•ï¼Œå¦‚ç¤ºä¾‹ä¸­çš„ipåœ°å€å—ã€åç§°ç©ºé—´ã€podæ ‡ç­¾ç­‰ï¼Œæ•°ç»„ä¸­çš„æˆå‘˜ä¹Ÿæ˜¯é€»è¾‘æˆ–çš„å…³ç³»ã€‚spec.ingress[].from.protsè¡¨ç¤ºå…è®¸é€šè¿‡çš„åè®®åŠç«¯å£å·ã€‚ .spec.egress.to å®šä¹‰çš„æ˜¯podæƒ³è¦è®¿é—®çš„å¤–éƒ¨destinationï¼Œå…¶å®ƒä¸ingressç›¸åŒã€‚ kubernetes é»˜è®¤NetworkPolicy:12345678910111213141516171819202122232425262728293031323334353637383940414243#é»˜è®¤ç¦æ­¢æ‰€æœ‰å‡ºå£è¯·æ±‚apiVersion: networking.k8s.io/v1kind: NetworkPolicymetadata: name: default-denyspec: podSelector: {} policyTypes: - Egress# é»˜è®¤ç¦æ­¢æ‰€æœ‰å…¥å£è¯·æ±‚apiVersion: networking.k8s.io/v1kind: NetworkPolicymetadata: name: default-denyspec: podSelector: {} policyTypes: - Ingress# é»˜è®¤å…è®¸æ‰€æœ‰å‡ºå£è¯·æ±‚apiVersion: networking.k8s.io/v1kind: NetworkPolicymetadata: name: allow-allspec: podSelector: {} egress: - {} policyTypes: - Egress# é»˜è®¤å…è®¸æ‰€æœ‰å…¥å£è¯·æ±‚apiVersion: networking.k8s.io/v1kind: NetworkPolicymetadata: name: allow-allspec: podSelector: {} egress: - {} policyTypes: - Ingress é»˜è®¤ç­–ç•¥ æ— éœ€è¯¦è§£ï¼Œä½†è¯·æ³¨æ„ï¼Œpodä¸æ‰€è¿è¡ŒèŠ‚ç‚¹ä¹‹é—´æµé‡ä¸å—Network Policyé™åˆ¶ã€‚ ç¤ºä¾‹ä¸‹é¢é€šè¿‡ä¸€ä¸ªçœŸå®ç¤ºä¾‹å±•ç¤ºNetwork Policyæ™®é€šç”¨æ³•ã€‚ ç”¨Deploymentåˆ›å»ºnginx podå®ä¾‹å¹¶ç”¨serviceæš´éœ²1234$ kubectl run nginx --image=nginx --replicas=3deployment.apps/nginx created$ kubectl expose deployment nginx --port=80service/nginx exposed ç¡®è®¤åˆ›å»ºç»“æœ123456789$ kubectl get pod,svcNAME READY STATUS RESTARTS AGEpod/nginx-64f497f8fd-9mfd7 1/1 Running 0 2mpod/nginx-64f497f8fd-nss94 1/1 Running 0 2mpod/nginx-64f497f8fd-zs926 1/1 Running 0 2mNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEservice/kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 3dservice/nginx ClusterIP 10.111.254.191 &lt;none&gt; 80/TCP 14s æµ‹è¯•nginxæœåŠ¡è¿é€šæ€§12345$ kubectl run busybox --rm -it --image=busybox /bin/shIf you don't see a command prompt, try pressing enter./ # wget --spider --timeout=3 nginxConnecting to nginx (10.111.254.191:80) # è¯´æ˜é€šçš„/ # é€šè¿‡åˆ›å»ºNetwork Policyå¯¹è±¡æ·»åŠ éš”ç¦»æ€§123456789101112131415161718192021222324252627282930313233343536$ cat &gt;&gt; pod-network-policy.yaml &lt;&lt; EOFkind: NetworkPolicyapiVersion: networking.k8s.io/v1metadata: name: access-nginxspec: podSelector: matchLabels: # é»˜è®¤è¯¥podå°±æœ‰run=appè¿™ä¸ªæ ‡ç­¾äº†ï¼Œæˆ‘è¿™é‡Œæ— éœ€åœ¨ä»æ–°å®šä¹‰ run: nginx ingress: - from: - podSelector: matchLabels: access: \"true\"EOF# æ‰§è¡Œåˆ›å»º$ kubectl create -f pod-network-policy.yamlnetworkpolicy.networking.k8s.io/access-nginx created# æŸ¥çœ‹å…·ä½“éš”ç¦»ç­–ç•¥$ kubectl describe networkpolicy access-nginxName: access-nginxNamespace: defaultCreated on: 2018-12-17 01:16:57 -0500 ESTLabels: &lt;none&gt;Annotations: &lt;none&gt;Spec: PodSelector: run=nginx Allowing ingress traffic: To Port: &lt;any&gt; (traffic allowed to all ports) From: PodSelector: access=true Allowing egress traffic: &lt;none&gt; (Selected pods are isolated for egress connectivity) Policy Types: Ingress æµ‹è¯•éš”ç¦»æ€§12345$ kubectl run busybox --rm -it --image=busybox /bin/shIf you don't see a command prompt, try pressing enter./ # wget --spider --timeout=3 nginxConnecting to nginx (10.111.254.191:80)wget: download timed out # å·²ç»è¶…æ—¶ï¼Œè¯´æ˜å·²ç»ä¸èƒ½è®¿é—®äº† ä¸ºpodæ·»åŠ access: â€œtrueâ€æ ‡ç­¾åå†æ¬¡æµ‹è¯•è¿é€šæ€§1234$ kubectl run busybox --rm -it --labels=\"access=true\" --image=busybox /bin/shIf you don't see a command prompt, try pressing enter./ # wget --spider --timeout=3 nginxConnecting to nginx (10.111.254.191:80) å‚è€ƒ:https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/https://kubernetes.io/docs/reference/access-authn-authz/rbac/https://kubernetes.io/docs/concepts/services-networking/network-policies/https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/https://kubernetes.io/docs/concepts/policy/pod-security-policy/","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/tags/kubernetes/"},{"name":"ServiceAccount","slug":"ServiceAccount","permalink":"https://blog.sctux.cc/tags/ServiceAccount/"},{"name":"Kubeconfig","slug":"Kubeconfig","permalink":"https://blog.sctux.cc/tags/Kubeconfig/"},{"name":"RBAC","slug":"RBAC","permalink":"https://blog.sctux.cc/tags/RBAC/"},{"name":"Admission","slug":"Admission","permalink":"https://blog.sctux.cc/tags/Admission/"},{"name":"PodSecurityContext","slug":"PodSecurityContext","permalink":"https://blog.sctux.cc/tags/PodSecurityContext/"},{"name":"NetworkPolicy","slug":"NetworkPolicy","permalink":"https://blog.sctux.cc/tags/NetworkPolicy/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"ç†è§£kubernetesä¸­çš„Storage","slug":"kubernetes-storage","date":"2018-12-15T00:27:08.000Z","updated":"2025-09-01T01:59:08.868Z","comments":true,"path":"2018/12/15/kubernetes-storage/","permalink":"https://blog.sctux.cc/2018/12/15/kubernetes-storage/","excerpt":"åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·å®¹å™¨éƒ¨ç½²è¿‡ç¨‹ä¸­ä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§æ•°æ®: å¯åŠ¨æ—¶éœ€è¦çš„åˆå§‹æ•°æ®ï¼Œå¯ä»¥æ˜¯é…ç½®æ–‡ä»¶ å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®ï¼Œè¯¥ä¸´æ—¶æ•°æ®éœ€è¦å¤šä¸ªå®¹å™¨é—´å…±äº« å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æŒä¹…åŒ–æ•°æ® ä»¥ä¸Šä¸‰ç§æ•°æ®éƒ½ä¸å¸Œæœ›åœ¨å®¹å™¨é‡å¯æ—¶å°±æ¶ˆå¤±ï¼Œå­˜å‚¨å·ç”±æ­¤è€Œæ¥ï¼Œå®ƒå¯ä»¥æ ¹æ®ä¸åŒåœºæ™¯æä¾›ä¸åŒç±»å‹çš„å­˜å‚¨èƒ½åŠ›ã€‚å„ç±»å·: ![æˆªå›¾æ¥æºåä¸ºäº‘cceè¯¾å ‚](kubernetes-storage/volume.png) spec.volumesï¼šé€šè¿‡æ­¤å­—æ®µæä¾›æŒ‡å®šçš„å­˜å‚¨å· spec.containers.volumeMountsï¼šé€šè¿‡æ­¤å­—æ®µå°†å­˜å‚¨å·æŒ‚æ¥åˆ°å®¹å™¨ä¸­ ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•:å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®1. ConfigMapä¸Šå›¾ä¹Ÿè¯´äº†å®ƒæ˜¯åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä»¥æ¥çš„æ•°æ®æ¥æº","text":"åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·å®¹å™¨éƒ¨ç½²è¿‡ç¨‹ä¸­ä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§æ•°æ®: å¯åŠ¨æ—¶éœ€è¦çš„åˆå§‹æ•°æ®ï¼Œå¯ä»¥æ˜¯é…ç½®æ–‡ä»¶ å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®ï¼Œè¯¥ä¸´æ—¶æ•°æ®éœ€è¦å¤šä¸ªå®¹å™¨é—´å…±äº« å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æŒä¹…åŒ–æ•°æ® ä»¥ä¸Šä¸‰ç§æ•°æ®éƒ½ä¸å¸Œæœ›åœ¨å®¹å™¨é‡å¯æ—¶å°±æ¶ˆå¤±ï¼Œå­˜å‚¨å·ç”±æ­¤è€Œæ¥ï¼Œå®ƒå¯ä»¥æ ¹æ®ä¸åŒåœºæ™¯æä¾›ä¸åŒç±»å‹çš„å­˜å‚¨èƒ½åŠ›ã€‚å„ç±»å·: ![æˆªå›¾æ¥æºåä¸ºäº‘cceè¯¾å ‚](kubernetes-storage/volume.png) spec.volumesï¼šé€šè¿‡æ­¤å­—æ®µæä¾›æŒ‡å®šçš„å­˜å‚¨å· spec.containers.volumeMountsï¼šé€šè¿‡æ­¤å­—æ®µå°†å­˜å‚¨å·æŒ‚æ¥åˆ°å®¹å™¨ä¸­ ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•:å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®1. ConfigMapä¸Šå›¾ä¹Ÿè¯´äº†å®ƒæ˜¯åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä»¥æ¥çš„æ•°æ®æ¥æº ç¤ºä¾‹ï¼š12345678910111213141516171819202122232425262728293031323334353637383940# 1.åˆ›å»ºconfigmapé¢„åˆ¶æ•°æ®å·cat &gt;&gt; configmap.yaml &lt;&lt; EOFapiVersion: v1data: guomaoqiu: hello-worldkind: ConfigMapmetadata: name: testEOF$ kubectl create -f configmap.yamlconfigmap/test created# 2. åˆ›å»ºpodæ¥ä½¿ç”¨è¿™ä¸ªconfigmap# è¿™é‡Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªnginx pod è®©ä»–å¯åŠ¨æ˜¯æŒ‚è½½è¿™ä¸ªæ•°æ®$ cat nginx-deployment.yaml............ spec: containers: - image: nginx name: nginx resources: {} volumeMounts: - name: test mountPath: /tmp # æŒ‚è½½ç‚¹ volumes: - name: test configMap: name: test # ConfigMap name defaultMode: 420 # æŒ‡å®šæŒ‚è½½åˆ°podæ–‡ä»¶çš„æƒé™............# 3.æ£€æŸ¥æ•°æ®æ˜¯å¦æŒ‚è½½è¿›podkubectl exec nginx-7d8bb9c4fc-bxxkt -- ls /tmpguomaoqiukubectl exec nginx-7d8bb9c4fc-bxxkt -- cat /tmp/guomaoqiuhello-world $# ä»¥ä¸Šå¯ä»¥çœ‹åˆ°å°†configmapçš„keyä½œä¸ºäº†æ–‡ä»¶åï¼Œå°†valueä½œä¸ºäº†æ–‡ä»¶çš„å†…å®¹ã€‚# ä»–çš„ä½œç”¨ä¹Ÿå°±æ˜¯å…è®¸æ‚¨å°†é…ç½®æ–‡ä»¶ä»å®¹å™¨é•œåƒä¸­è§£è€¦ï¼Œä»è€Œå¢å¼ºå®¹å™¨åº”ç”¨çš„å¯ç§»æ¤æ€§# æ›´å¤šå¯æŸ¥çœ‹: https://k8smeetup.github.io/docs/tasks/configure-pod-container/configmap/ 2. SerectSecret æ˜¯ä¸€ç§åŒ…å«å°‘é‡æ•æ„Ÿä¿¡æ¯ä¾‹å¦‚å¯†ç ã€token æˆ– key çš„å¯¹è±¡ã€‚è¿™æ ·çš„ä¿¡æ¯å¯èƒ½ä¼šè¢«æ”¾åœ¨ Pod spec ä¸­æˆ–è€…é•œåƒä¸­ï¼›å°†å…¶æ”¾åœ¨ä¸€ä¸ª secret å¯¹è±¡ä¸­å¯ä»¥æ›´å¥½åœ°æ§åˆ¶å®ƒçš„ç”¨é€”ï¼Œå¹¶é™ä½æ„å¤–æš´éœ²çš„é£é™©ã€‚ ç”¨æˆ·å¯ä»¥åˆ›å»º secretï¼ŒåŒæ—¶ç³»ç»Ÿä¹Ÿåˆ›å»ºäº†ä¸€äº› secretã€‚è¦ä½¿ç”¨ secretï¼Œpod éœ€è¦å¼•ç”¨ secretã€‚Pod å¯ä»¥ç”¨ä¸¤ç§æ–¹å¼ä½¿ç”¨ secretï¼šä½œä¸º volume ä¸­çš„æ–‡ä»¶è¢«æŒ‚è½½åˆ° pod ä¸­çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨é‡Œï¼Œæˆ–è€…å½“ kubelet ä¸º pod æ‹‰å–é•œåƒæ—¶ä½¿ç”¨ã€‚ ç¤ºä¾‹ï¼šå‡è®¾æœ‰äº› pod éœ€è¦è®¿é—®æ•°æ®åº“ã€‚è¿™äº› pod éœ€è¦ä½¿ç”¨çš„ç”¨æˆ·åå’Œå¯†ç åœ¨æ‚¨æœ¬åœ°æœºå™¨çš„ ./username.txt å’Œ ./password.txt æ–‡ä»¶é‡Œã€‚ 123# Create files needed for rest of example.echo -n \"admin\" &gt; ./username.txtecho -n \"1f2d1e2e67df\" &gt; ./password.txt kubectl create secret å‘½ä»¤å°†è¿™äº›æ–‡ä»¶æ‰“åŒ…åˆ°ä¸€ä¸ª Secret ä¸­å¹¶åœ¨ API server ä¸­åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ã€‚ 1234567891011121314151617$ kubectl create secret generic db-user-pass --from-file=./username.txt --from-file=./password.txtsecret/db-user-pass created$ kubectl describe secret db-user-passName: db-user-passNamespace: defaultLabels: &lt;none&gt;Annotations: &lt;none&gt;Type: OpaqueData====password.txt: 12 bytesusername.txt: 5 bytes# é»˜è®¤æƒ…å†µä¸‹ï¼Œget å’Œ describe å‘½ä»¤éƒ½ä¸ä¼šæ˜¾ç¤ºæ–‡ä»¶çš„å†…å®¹ã€‚# è¿™æ˜¯ä¸ºäº†é˜²æ­¢å°† secret ä¸­çš„å†…å®¹è¢«æ„å¤–æš´éœ²ç»™ä»ç»ˆç«¯æ—¥å¿—è®°å½•ä¸­åˆ»æ„å¯»æ‰¾å®ƒä»¬çš„äººã€‚ åœ¨ Pod ä¸­ä½¿ç”¨ Secret æ–‡ä»¶åœ¨æŒ‚è½½çš„ secret volume çš„å®¹å™¨å†…ï¼Œsecret key å°†ä½œä¸ºæ–‡ä»¶ï¼Œå¹¶ä¸” secret çš„å€¼ä½¿ç”¨ base-64 è§£ç å¹¶å­˜å‚¨åœ¨è¿™äº›æ–‡ä»¶ä¸­ã€‚è¿™æ˜¯åœ¨ä¸Šé¢çš„ç¤ºä¾‹å®¹å™¨å†…æ‰§è¡Œçš„å‘½ä»¤çš„ç»“æœï¼š 12345 kubectl exec -it mypod /bin/bashroot@mypod:/# cat /etc/foo/username.txtadminroot@mypod:/# cat /etc/foo/password.txt1f2d1e2e67df å®¹å™¨ä¸­çš„ç¨‹åºè´Ÿè´£ä»æ–‡ä»¶ä¸­è¯»å– secretã€‚å…³äºsecretæŒ‚è½½ä½¿ç”¨æ–¹æ³• æ›´å¤šï¼šhttps://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-%E4%B8%8E-pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E8%81%94%E7%B3%BB ä¸´æ—¶æ•°æ®å­˜å‚¨1. emptryDirå½“ Pod è¢«åˆ†é…ç»™èŠ‚ç‚¹æ—¶ï¼Œé¦–å…ˆåˆ›å»º emptyDir å·ï¼Œå¹¶ä¸”åªè¦è¯¥ Pod åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œè¯¥å·å°±ä¼šå­˜åœ¨ã€‚æ­£å¦‚å·çš„åå­—æ‰€è¿°ï¼Œå®ƒæœ€åˆæ˜¯ç©ºçš„ã€‚Pod ä¸­çš„å®¹å™¨å¯ä»¥è¯»å–å’Œå†™å…¥ emptyDir å·ä¸­çš„ç›¸åŒæ–‡ä»¶ï¼Œå°½ç®¡è¯¥å·å¯ä»¥æŒ‚è½½åˆ°æ¯ä¸ªå®¹å™¨ä¸­çš„ç›¸åŒæˆ–ä¸åŒè·¯å¾„ä¸Šã€‚å½“å‡ºäºä»»ä½•åŸå› ä»èŠ‚ç‚¹ä¸­åˆ é™¤ Pod æ—¶ï¼ŒemptyDir ä¸­çš„æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚ æ³¨æ„ï¼šå®¹å™¨å´©æºƒä¸ä¼šä»èŠ‚ç‚¹ä¸­ç§»é™¤ podï¼Œå› æ­¤ emptyDir å·ä¸­çš„æ•°æ®åœ¨å®¹å™¨å´©æºƒæ—¶æ˜¯å®‰å…¨çš„ã€‚ ç¼ºçœæƒ…å†µä¸‹ï¼ŒEmptyDir æ˜¯ä½¿ç”¨ä¸»æœºç£ç›˜è¿›è¡Œå­˜å‚¨çš„ï¼Œä¹Ÿå¯ä»¥è®¾ç½®emptyDir.medium å­—æ®µçš„å€¼ä¸ºMemoryï¼Œæ¥æé«˜è¿è¡Œé€Ÿåº¦ï¼Œä½†æ˜¯è¿™ç§è®¾ç½®ï¼Œå¯¹è¯¥å·çš„å ç”¨ä¼šæ¶ˆè€—å®¹å™¨çš„å†…å­˜ä»½é¢ã€‚ emptyDir çš„ç”¨æ³•æœ‰ï¼š æš‚å­˜ç©ºé—´ï¼Œä¾‹å¦‚ç”¨äºåŸºäºç£ç›˜çš„åˆå¹¶æ’åº ç”¨ä½œé•¿æ—¶é—´è®¡ç®—å´©æºƒæ¢å¤æ—¶çš„æ£€æŸ¥ç‚¹ WebæœåŠ¡å™¨å®¹å™¨æä¾›æ•°æ®æ—¶ï¼Œä¿å­˜å†…å®¹ç®¡ç†å™¨å®¹å™¨æå–çš„æ–‡ä»¶ å¯ä»¥åœ¨åŒä¸€ Pod å†…çš„ä¸åŒå®¹å™¨ä¹‹é—´å…±äº«å·¥ä½œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–‡ä»¶ã€‚ ç¤ºä¾‹123456789101112131415apiVersion: v1kind: Podmetadata: name: test-emptydir-podspec: containers: - image: nginx imagePullPolicy: IfNotPresent name: test-emptydir-pod volumeMounts: - mountPath: /temp-data # æŒ‚è½½ç‚¹ name: temp-data volumes: - name: temp-data emptyDir: {} åˆ›å»ºpod 12345 kubectl create -f test-emptydir-pod.yamlpod/test-emptydir-pod created$ kubectl get pods -o wideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODEtest-emptydir-pod 1/1 Running 0 18s 10.244.0.23 k8s-m3 &lt;none&gt; æ­¤æ—¶Emptydirå·²ç»åˆ›å»ºæˆåŠŸï¼Œåœ¨å®¿ä¸»æœºä¸Šçš„è®¿é—®è·¯å¾„ä¸º/var/lib/kubelet/pods//volumes/kubernetes.io~empty-dir/temp-data,å¦‚æœåœ¨æ­¤ç›®å½•ä¸­åˆ›å»ºåˆ é™¤æ–‡ä»¶ï¼Œéƒ½å°†å¯¹å®¹å™¨ä¸­çš„/dataç›®å½•æœ‰å½±å“ï¼Œå¦‚æœåˆ é™¤Podï¼Œæ–‡ä»¶å°†å…¨éƒ¨åˆ é™¤ï¼Œå³ä½¿æ˜¯åœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºçš„æ–‡ä»¶ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œåœ¨å®¿ä¸»æœºä¸Šåˆ é™¤å®¹å™¨åˆ™k8sä¼šå†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œæ­¤æ—¶æ–‡ä»¶ä»ç„¶å­˜åœ¨ã€‚ 12345678# è·å– pod uidkubectl get pod test-emptydir-pod -o yaml | grep -n uid11: uid: 3328c9e1-ff8f-11e8-b6d6-00505621dd5b# ç™»å½•åˆ°èŠ‚ç‚¹k8s-m3 æŸ¥çœ‹ ll /var/lib/kubelet/pods/3328c9e1-ff8f-11e8-b6d6-00505621dd5b/volumes/kubernetes.io~empty-dir/total 0drwxrwxrwx 2 root root 6 Dec 14 05:58 temp-data 2. hostPathhostPath volumeæ˜ å°„nodeæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æˆ–è€…ç›®å½•åˆ°podé‡Œã€‚å¤§å¤šæ•°Podéƒ½ä¸éœ€è¦è¿™ä¸ªåŠŸèƒ½ï¼Œä½†å¯¹äºä¸€äº›ç‰¹å®šçš„åœºæ™¯ï¼Œè¯¥ç‰¹æ€§è¿˜æ˜¯å¾ˆæœ‰ä½œç”¨çš„ã€‚è¿™äº›åœºæ™¯åŒ…æ‹¬ï¼š è¿è¡Œçš„å®¹å™¨éœ€è¦è®¿é—®Dockerå†…éƒ¨ç»“æ„ï¼šä½¿ç”¨hostPathæ˜ å°„/var/lib/docker åœ¨å®¹å™¨ä¸­è¿è¡ŒcAdvisorï¼Œä½¿ç”¨hostPathæ˜ å°„/dev/cgroups ä¸è¿‡ï¼Œä½¿ç”¨è¿™ç§volumeè¦å°å¿ƒï¼Œå› ä¸ºï¼š é…ç½®ç›¸åŒçš„podï¼ˆå¦‚é€šè¿‡podTemplateåˆ›å»ºï¼‰ï¼Œå¯èƒ½åœ¨ä¸åŒçš„Nodeä¸Šè¡¨ç°ä¸åŒï¼Œå› ä¸ºä¸åŒèŠ‚ç‚¹ä¸Šæ˜ å°„çš„æ–‡ä»¶å†…å®¹ä¸åŒ å½“Kuberneteså¢åŠ äº†èµ„æºæ•æ„Ÿçš„è°ƒåº¦ç¨‹åºï¼ŒhostPathä½¿ç”¨çš„èµ„æºä¸ä¼šè¢«è®¡ç®—åœ¨å†… å®¿ä¸»æœºä¸‹åˆ›å»ºçš„ç›®å½•åªæœ‰rootæœ‰å†™æƒé™ã€‚ä½ éœ€è¦è®©ä½ çš„ç¨‹åºè¿è¡Œåœ¨privileged containerä¸Šï¼Œæˆ–è€…ä¿®æ”¹å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶æƒé™ã€‚ ç¤ºä¾‹ï¼šå‡è®¾æˆ‘ä»¬åœ¨åˆ›å»ºdockeré•œåƒçš„æ—¶å€™å¿˜è®°äº†æ›´æ”¹å®¹å™¨ä¸­çš„æ—¶åŒºæ–‡ä»¶ï¼›è¿™æ—¶å€™æƒ³æŠŠå®¿ä¸»æœºçš„/usr/share/zoneinfo/Asia/ShanghaiæŒ‚åˆ°podä¸­çš„å®¹å™¨å†…(è¿™é‡Œä¸ºäº†å­¦ä¹ æŒ‚è½½æ–¹å¼ï¼Œæš‚ä¸”ä¸è°ˆä¸åŒç³»ç»Ÿæˆ–ä¸åŒå®¿ä¸»æœºçš„ä¸€äº›é…ç½®æˆ–è·¯å¾„) 12345678910111213141516apiVersion: v1kind: Podmetadata: name: test-emptydir-podspec: containers: - image: nginx imagePullPolicy: IfNotPresent name: test-emptydir-pod volumeMounts: - name: container-time mountPath: /etc/localtime # æŒ‚è½½ç‚¹ï¼Œcontainerå¯åŠ¨åç›´æ¥æŒ‚è½½è¦†ç›–æ­¤æ–‡ä»¶ volumes: - name: container-time hostPath: path: /usr/share/zoneinfo/Asia/Shanghai # æŒ‚è½½æ—¶åŒºæ–‡ä»¶åˆ°containerä¸­ é€šè¿‡åˆ›å»ºpodåç™»å½•æ£€æŸ¥æ—¶åŒºæ­£å¸¸. äºŒã€æŒä¹…å­˜å‚¨å·çš„ç”¨æ³•:å­¦ä¹ æŒä¹…åŒ–å­˜å‚¨ä¹‹å‰éœ€è¦å­¦ä¹ ä¸€ä¸‹ä»¥ä¸‹æ¦‚å¿µï¼šVolume æä¾›äº†éå¸¸å¥½çš„æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆï¼Œä¸è¿‡åœ¨å¯ç®¡ç†æ€§ä¸Šè¿˜æœ‰ä¸è¶³ã€‚æ‹¿å‰é¢ AWS EBS çš„ä¾‹å­æ¥è¯´ï¼Œè¦ä½¿ç”¨ Volumeï¼ŒPod å¿…é¡»äº‹å…ˆçŸ¥é“å¦‚ä¸‹ä¿¡æ¯ï¼š å½“å‰ Volume æ¥è‡ª AWS EBSã€‚ EBS Volume å·²ç»æå‰åˆ›å»ºï¼Œå¹¶ä¸”çŸ¥é“ç¡®åˆ‡çš„ volume-idã€‚ Pod é€šå¸¸æ˜¯ç”±åº”ç”¨çš„å¼€å‘äººå‘˜ç»´æŠ¤ï¼Œè€Œ Volume åˆ™é€šå¸¸æ˜¯ç”±å­˜å‚¨ç³»ç»Ÿçš„ç®¡ç†å‘˜ç»´æŠ¤ã€‚å¼€å‘äººå‘˜è¦è·å¾—ä¸Šé¢çš„ä¿¡æ¯ï¼š è¦ä¹ˆè¯¢é—®ç®¡ç†å‘˜ã€‚ è¦ä¹ˆè‡ªå·±å°±æ˜¯ç®¡ç†å‘˜ã€‚ è¿™æ ·å°±å¸¦æ¥ä¸€ä¸ªç®¡ç†ä¸Šçš„é—®é¢˜ï¼šåº”ç”¨å¼€å‘äººå‘˜å’Œç³»ç»Ÿç®¡ç†å‘˜çš„èŒè´£è€¦åˆåœ¨ä¸€èµ·äº†ã€‚å¦‚æœç³»ç»Ÿè§„æ¨¡è¾ƒå°æˆ–è€…å¯¹äºå¼€å‘ç¯å¢ƒè¿™æ ·çš„æƒ…å†µè¿˜å¯ä»¥æ¥å—ã€‚ä½†å½“é›†ç¾¤è§„æ¨¡å˜å¤§ï¼Œç‰¹åˆ«æ˜¯å¯¹äºç”Ÿæˆç¯å¢ƒï¼Œè€ƒè™‘åˆ°æ•ˆç‡å’Œå®‰å…¨æ€§ï¼Œè¿™å°±æˆäº†å¿…é¡»è¦è§£å†³çš„é—®é¢˜ã€‚ Kubernetes ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯ PersistentVolume å’Œ PersistentVolumeClaimã€‚ PersistentVolume (PV) æ˜¯å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿä¸­çš„ä¸€å—å­˜å‚¨ç©ºé—´ï¼Œç”±ç®¡ç†å‘˜åˆ›å»ºå’Œç»´æŠ¤ã€‚ä¸ Volume ä¸€æ ·ï¼ŒPV å…·æœ‰æŒä¹…æ€§ï¼Œç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äº Podã€‚ PersistentVolumeClaim (PVC) æ˜¯å¯¹ PV çš„ç”³è¯· (Claim)ã€‚PVC é€šå¸¸ç”±æ™®é€šç”¨æˆ·åˆ›å»ºå’Œç»´æŠ¤ã€‚éœ€è¦ä¸º Pod åˆ†é…å­˜å‚¨èµ„æºæ—¶ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»ºä¸€ä¸ª PVCï¼ŒæŒ‡æ˜å­˜å‚¨èµ„æºçš„å®¹é‡å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼ˆæ¯”å¦‚åªè¯»ï¼‰ç­‰ä¿¡æ¯ï¼ŒKubernetes ä¼šæŸ¥æ‰¾å¹¶æä¾›æ»¡è¶³æ¡ä»¶çš„ PVã€‚ æœ‰äº† PersistentVolumeClaimï¼Œç”¨æˆ·åªéœ€è¦å‘Šè¯‰ Kubernetes éœ€è¦ä»€ä¹ˆæ ·çš„å­˜å‚¨èµ„æºï¼Œè€Œä¸å¿…å…³å¿ƒçœŸæ­£çš„ç©ºé—´ä»å“ªé‡Œåˆ†é…ï¼Œå¦‚ä½•è®¿é—®ç­‰åº•å±‚ç»†èŠ‚ä¿¡æ¯ã€‚è¿™äº› Storage Provider çš„åº•å±‚ä¿¡æ¯äº¤ç»™ç®¡ç†å‘˜æ¥å¤„ç†ï¼Œåªæœ‰ç®¡ç†å‘˜æ‰åº”è¯¥å…³å¿ƒåˆ›å»º PersistentVolume çš„ç»†èŠ‚ä¿¡æ¯ã€‚ Kubernetes æ”¯æŒå¤šç§ç±»å‹çš„ PersistentVolumeï¼Œæ¯”å¦‚ AWS EBSã€Cephã€NFS ç­‰ï¼Œå®Œæ•´åˆ—è¡¨è¯·å‚è€ƒ https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes ä¸»è¦åŒ…æ‹¬:NFS/GlusterFS/CephFS/AWS/GCEç­‰ç­‰ä½œä¸ºä¸€ä¸ªå®¹å™¨é›†ç¾¤ï¼Œæ”¯æŒç½‘ç»œå­˜å‚¨è‡ªç„¶æ˜¯é‡ä¸­ä¹‹é‡äº†,Kubernetesæ”¯æŒä¸ºæ•°ä¼—å¤šçš„äº‘æä¾›å•†å’Œç½‘ç»œå­˜å‚¨æ–¹æ¡ˆã€‚ä¸åŒå…¬å¸é€‰æ‹©çš„æ–¹æ¡ˆä¹Ÿæ˜¯ä¸ç›¸åŒã€‚ ä¸‹èŠ‚æˆ‘ç”¨ NFS æ¥ä½“ä¼šå®ƒå­˜å‚¨çš„ä½¿ç”¨æ–¹æ³•ã€‚ NFSNFSçš„æ­å»º1. åœ¨NFSå­˜å‚¨çš„æœåŠ¡å™¨åˆ›å»ºå­˜å‚¨ç›®å½•:12# è¿™é‡Œå…ˆåˆ›å»ºä¸‰ä¸ªå…±äº«ç›®å½•ç¨åä¼šç”¨åˆ°.$ mkdir /{nfs_data_1,nfs_data_2,nfs_data_3} 2. å®‰è£…nfs:1$ yum -y install nfs-utils rpcbind 3. å†™å…¥é…ç½®123echo \"/nfs_data_1 *(rw,sync,no_subtree_check,no_root_squash)\" &gt; /etc/exportsecho \"/nfs_data_2 *(rw,sync,no_subtree_check,no_root_squash)\" &gt;&gt; /etc/exportsecho \"/nfs_data_3 *(rw,sync,no_subtree_check,no_root_squash)\" &gt;&gt; /etc/exports 4. é‡å¯nfsæœåŠ¡éªŒè¯12345678systemctl restart nfs-servershowmount -e 192.168.56.113 # NFS ServerExport list for 192.168.56.113:/nfs_data_3 */nfs_data_2 */nfs_data_1 *# nfså®‰è£…å¹¶ä¸”å…±äº«ç›®å½•å·²ç»åˆ›å»ºå®Œæ¯• NFSä½œä¸ºæ™®é€šå­˜å‚¨å·åœ¨Kubernetesä¸­ï¼Œå¯ä»¥é€šè¿‡nfsç±»å‹çš„å­˜å‚¨å·å°†ç°æœ‰çš„NFSï¼ˆç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼‰åˆ°çš„æŒ‚æ¥åˆ°Podä¸­ã€‚åœ¨ç§»é™¤Podæ—¶ï¼ŒNFSå­˜å‚¨å·ä¸­çš„å†…å®¹è¢«ä¸ä¼šè¢«åˆ é™¤ï¼Œåªæ˜¯å°†å­˜å‚¨å·å¸è½½è€Œå·²ã€‚è¿™æ„å‘³ç€åœ¨NFSå­˜å‚¨å·æ€»å¯ä»¥é¢„å…ˆå¡«å……æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨Podä¹‹é—´å…±äº«æ•°æ®ã€‚NFSå¯ä»¥è¢«åŒæ—¶æŒ‚æ¥åˆ°å¤šä¸ªPodä¸­ï¼Œå¹¶èƒ½åŒæ—¶è¿›è¡Œå†™å…¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨ä½¿ç”¨nfså­˜å‚¨å·ä¹‹å‰ï¼Œå¿…é¡»å·²æ­£ç¡®éƒ¨ç½²å’Œè¿è¡ŒNFSæœåŠ¡å™¨ï¼Œå¹¶å·²ç»è®¾ç½®äº†å…±äº«ç›®å½•ã€‚ åˆ›å»ºä¸€ä¸ªpodï¼Œè®©å…¶æŒ‚è½½ä¸Šé¢åˆ›å»ºçš„å…±äº«ç›®å½•12345678910111213141516171819202122232425cat &gt;&gt; nfs-busybox &lt;&lt; EOFapiVersion: v1kind: Podmetadata: name: nfs-busybox-podspec: containers: - name: nfs-busybox-pod image: busybox imagePullPolicy: IfNotPresent command: - \"/bin/sh\" args: - \"-c\" - \"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1\" volumeMounts: - name: nfs-busybox-storage mountPath: \"/mnt\" restartPolicy: \"Never\" volumes: - name: nfs-busybox-storage nfs: path: /nfs_data_1 # NFS å…±äº«ç›®å½• server: 192.168.56.113 # NFS ServerEOF å¯åŠ¨PODï¼Œä¸€ä¼šå„¿PODå°±æ˜¯completedçŠ¶æ€ï¼Œè¯´æ˜æ‰§è¡Œå®Œæ¯•ã€‚ 12345kubectl apply -f nfs-busybox.yamlpod/nfs-busybox-pod created$ kubectl get podsNAME READY STATUS RESTARTS AGEnfs-busybox-pod 0/1 Completed 0 7s æˆ‘ä»¬å»NFS Serverå…±äº«ç›®å½•æŸ¥çœ‹æœ‰æ²¡æœ‰SUCCESSæ–‡ä»¶ã€‚ 12ls /nfs_data_1/SUCCESS è¯´æ˜å½“NFSä½œä¸ºæ™®é€šå­˜å‚¨å·æ—¶æˆ‘ä»¬æŒ‚è½½åˆ°podå®¹å™¨ä¸­äº§ç”Ÿæ•°æ®å°†ä¼šä¿å­˜åˆ°è¿™ä¸ªå­˜å‚¨å·å½“ä¸­ï¼Œå¹¶ä¸”åˆ é™¤podä¸ä¼šå½±å“æ•°æ®ã€‚ å¦‚ä½•åŸºäºNFSæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ï¼ŸProvisioning: PVçš„é¢„åˆ¶åˆ›å»ºæœ‰ä¸¤ç§æ¨¡å¼ï¼šé™æ€å’ŒåŠ¨æ€ä¾›ç»™æ¨¡å¼ï¼Œä»–ä»¬çš„å«ä¹‰æ˜¯ï¼š é™æ€ä¾›ç»™æ¨¡å¼: éœ€è¦å…ˆæ‰‹åŠ¨åˆ›å»ºPV, ç„¶åé€šè¿‡ PVC ç”³è¯· PV å¹¶åœ¨ Pod ä¸­ä½¿ç”¨ï¼Œè¿™ç§æ–¹å¼å«åšé™æ€ä¾›ç»™ï¼ˆStatic Provisionï¼‰ã€‚åŠ¨æ€ä¾›ç»™æ¨¡å¼: åªéœ€è¦åˆ›å»ºPVCï¼Œç³»ç»Ÿæ ¹æ®PVCåˆ›å»ºPV, å¦‚æœæ²¡æœ‰æ»¡è¶³ PVC æ¡ä»¶çš„ PVï¼Œä¼šåŠ¨æ€åˆ›å»º PVã€‚ç›¸æ¯”é™æ€ä¾›ç»™ï¼ŒåŠ¨æ€ä¾›ç»™(Dynamical Provisionï¼‰æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ï¼šä¸éœ€è¦æå‰åˆ›å»º PVï¼Œå‡å°‘äº†ç®¡ç†å‘˜çš„å·¥ä½œé‡ï¼Œæ•ˆç‡é«˜. åŠ¨æ€ä¾›ç»™æ˜¯é€šè¿‡ StorageClass å®ç°çš„ï¼ŒStorageClass å®šä¹‰äº†å¦‚ä½•åˆ›å»º PVã€‚ ä¸‹é¢å°±åˆ†åˆ«å®è·µè¿™ä¸¤ç§æ¨¡å¼çš„åˆ›å»ºè·Ÿä½¿ç”¨: NFSä½œä¸ºé™æ€ä¾›ç»™æ¨¡å¼æŒä¹…åŒ–å­˜å‚¨å·1æ‰‹åŠ¨åˆ›å»ºPV---&gt;æ‰‹åŠ¨åˆ›å»ºPVC---&gt;PODæŒ‚è½½ä½¿ç”¨ 1. åˆ›å»ºPV12345678910111213141516171819cat &gt;&gt; nfs-test-pv.yaml &lt;&lt; EOFapiVersion: v1kind: PersistentVolumemetadata: name: nfs-test-pv namespace: default labels: app: nfs-test-pvspec: capacity: storage: 5Gi # æŒ‡å®šPVå®¹é‡ä¸º5G accessModes: - ReadWriteOnce # æŒ‡å®šè®¿é—®æ¨¡å¼ä¸º ReadWriteOnce persistentVolumeReclaimPolicy: Recycle # æŒ‡å®šå½“ PV çš„å›æ”¶ç­–ç•¥ä¸º Recycle storageClassName: nfs # å®š PV çš„ class ä¸º nfsã€‚ç›¸å½“äºä¸º PV è®¾ç½®äº†ä¸€ä¸ªåˆ†ç±»ï¼ŒPVC å¯ä»¥æŒ‡å®š class ç”³è¯·ç›¸åº” class çš„ PVã€‚ nfs: path: /nfs_data_2 # æŒ‡å®š PV åœ¨ NFS æœåŠ¡å™¨ä¸Šå¯¹åº”çš„ç›®å½• server: 192.168.56.113 # NFS Serveråœ°å€EOF STATUS ä¸º Availableï¼Œè¡¨ç¤º nfs-test-pv å°±ç»ªï¼Œå¯ä»¥è¢« PVC ç”³è¯·ã€‚æ¥ä¸‹æ¥åˆ›å»º PVC nfs-test-pv-claimï¼š 2. åˆ›å»ºPVC1234567891011121314cat &gt;&gt; nfs-test-pv-claim.yaml &lt;&lt; EOFapiVersion: v1kind: PersistentVolumeClaimmetadata: name: nfs-test-pv-claim namespace: defaultspec: accessModes: # å­˜å‚¨è®¿é—®æ¨¡å¼ï¼Œæ­¤èƒ½åŠ›ä¾èµ–å­˜å‚¨å‚å•†èƒ½åŠ› - ReadWriteOnce resources: requests: storage: 2Gi # è¯·æ±‚è·å¾—çš„pvcå­˜å‚¨å¤§å° storageClassName: nfs EOF ä» kubectl get pvc å’Œ kubectl get pv çš„è¾“å‡ºå¯ä»¥çœ‹åˆ° nfs-test-pv-claim å·²ç» Bound åˆ° nfs-test-pvï¼Œç”³è¯·æˆåŠŸã€‚æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨ Pod ä¸­ä½¿ç”¨å­˜å‚¨äº†ï¼š 3. åˆ›å»ºPod123456789101112131415161718192021cat &gt;&gt; nfs-test-pod.yaml &lt;&lt; EOFapiVersion: v1kind: Podmetadata: name: nfs-test-podspec: containers: - name: nfs-test-pod image: busybox args: - /bin/sh - -c - sleep 30000 volumeMounts: - mountPath: \"/nfs-data\" name: nfs-data volumes: - name: nfs-data persistentVolumeClaim: claimName: nfs-test-pv-claimEOF ä¸ä½¿ç”¨æ™®é€š Volume çš„æ ¼å¼ç±»ä¼¼ï¼Œåœ¨ volumes ä¸­é€šè¿‡ persistentVolumeClaim æŒ‡å®šä½¿ç”¨ nfs-test-pv-claim ç”³è¯·çš„ Volumeã€‚éªŒè¯ PV æ˜¯å¦å¯ç”¨ï¼š 1kubectl exec nfs-test-pod touch /nfs-data/SUCCESS ![create_result](kubernetes-storage/create_result.png) å¯è§ï¼Œåœ¨ Pod ä¸­åˆ›å»ºçš„æ–‡ä»¶ /nfs-data/SUCCESS ç¡®å®å·²ç»ä¿å­˜åˆ°äº† NFS æœåŠ¡å™¨ç›®å½• /nfs_data_2/ä¸­ã€‚å¦‚æœä¸å†éœ€è¦ä½¿ç”¨ PVï¼Œå¯ç”¨åˆ é™¤ PVC å›æ”¶ PV: 4. å›æ”¶PVCæŒä¹…åŒ–å·å£°æ˜çš„ä¿æŠ¤PVC ä¿æŠ¤çš„ç›®çš„æ˜¯ç¡®ä¿ç”± pod æ­£åœ¨ä½¿ç”¨çš„ PVC ä¸ä¼šä»ç³»ç»Ÿä¸­ç§»é™¤ï¼Œå› ä¸ºå¦‚æœè¢«ç§»é™¤çš„è¯å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚æ³¨æ„ï¼šå½“ pod çŠ¶æ€ä¸º Pending å¹¶ä¸” pod å·²ç»åˆ†é…ç»™èŠ‚ç‚¹æˆ– pod ä¸º Running çŠ¶æ€æ—¶ï¼ŒPVC å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚å½“å¯ç”¨PVCä¿æŠ¤åŠŸèƒ½æ—¶ï¼Œå¦‚æœç”¨æˆ·åˆ é™¤äº†ä¸€ä¸ª pod æ­£åœ¨ä½¿ç”¨çš„ PVCï¼Œåˆ™è¯¥ PVC ä¸ä¼šè¢«ç«‹å³åˆ é™¤ã€‚PVC çš„åˆ é™¤å°†è¢«æ¨è¿Ÿï¼Œç›´åˆ° PVC ä¸å†è¢«ä»»ä½• pod ä½¿ç”¨ã€‚æ‚¨å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ç›´æ¥åˆ é™¤ä¸Šé¢PODæ­£åœ¨ä½¿ç”¨çš„PVCæ—¶å‘½ä»¤ç›´æ¥hangä½äº†ï¼Œæ­¤æ—¶è™½ç„¶ä¸º Teminatiingï¼Œä½†PVC å—åˆ°ä¿æŠ¤ï¼ŒFinalizers åˆ—è¡¨ä¸­åŒ…å« kubernetes.io/pvc-protectionï¼š 1kubectl delete pvc nfs-test-pv-claim ç­‰å¾… pod çŠ¶æ€å˜ä¸º Terminatedï¼ˆåˆ é™¤ pod æˆ–è€…ç­‰åˆ°å®ƒç»“æŸï¼‰ï¼Œç„¶åæ£€æŸ¥ï¼Œç¡®è®¤ PVC è¢«ç§»é™¤ã€‚ åä¹‹ï¼Œå¦‚æœä¸€ä¸ªPVCæ²¡æœ‰è¢«podä½¿ç”¨åˆ™å¯ä»¥ç›´æ¥åˆ é™¤ã€‚ ç”¨æˆ·ç”¨å®Œ volume åï¼Œå¯ä»¥ä»å…è®¸å›æ”¶èµ„æºçš„ API ä¸­åˆ é™¤ PVC å¯¹è±¡ã€‚PersistentVolume çš„å›æ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤åœ¨å­˜å‚¨å·å£°æ˜é‡Šæ”¾ååº”å¦‚ä½•å¤„ç†è¯¥å·ã€‚ç›®å‰ï¼Œvolume çš„å¤„ç†ç­–ç•¥æœ‰: Retainï¼Œä¸æ¸…ç†, ä¿ç•™ Volumeï¼ˆéœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼‰ Recycleï¼Œåˆ é™¤æ•°æ®ï¼Œå³ rm -rf /thevolume/*ï¼ˆåªæœ‰ NFS å’Œ HostPath æ”¯æŒï¼‰ Deleteï¼Œåˆ é™¤å­˜å‚¨èµ„æºï¼Œæ¯”å¦‚åˆ é™¤ AWS EBS å·ï¼ˆåªæœ‰ AWS EBS, GCE PD, Azure Disk å’Œ Cinder æ”¯æŒï¼‰ OK ä»¥ä¸Šæ˜¯NFSåˆ›å»ºé™æ€æ¨¡å¼åˆ›å»ºPVC,ä»¥åŠPVCè·ŸPODç”Ÿå‘½å‘¨æœŸçš„ä¸€äº›å®è·µï¼Œä¸‹é¢å®è·µåŠ¨æ€æ¨¡å¼ NFSä½œä¸ºåŠ¨æ€æŒä¹…åŒ–å­˜å‚¨å·åˆ©ç”¨NFS client provisioneråŠ¨æ€æä¾›Kubernetesåç«¯å­˜å‚¨å· æƒ³è¦åŠ¨æ€ç”ŸæˆPVï¼Œéœ€è¦è¿è¡Œä¸€ä¸ªNFS-ProvisioneræœåŠ¡ï¼Œå°†å·²é…ç½®å¥½çš„NFSç³»ç»Ÿç›¸å…³å‚æ•°å½•å…¥ï¼Œå¹¶å‘ç”¨æˆ·æä¾›åˆ›å»ºPVçš„æœåŠ¡ã€‚å®˜æ–¹æ¨èä½¿ç”¨Deploymentè¿è¡Œä¸€ä¸ªreplicaæ¥å®ç°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨Daemonsetç­‰å…¶ä»–æ–¹å¼ï¼Œè¿™äº›éƒ½åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æä¾›äº†ã€‚ å‰ææ¡ä»¶æ˜¯æœ‰å·²ç»å®‰è£…å¥½çš„NFSæœåŠ¡å™¨ï¼Œå¹¶ä¸”NFSæœåŠ¡å™¨ä¸Kubernetesçš„SlaveèŠ‚ç‚¹éƒ½èƒ½ç½‘ç»œè¿é€šã€‚ æ‰€æœ‰ä¸‹æ–‡ç”¨åˆ°çš„æ–‡ä»¶æ¥è‡ªäºgit clone https://github.com/kubernetes-incubator/external-storage.git çš„nfs-clientç›®å½• nfs-client-provisioner æ˜¯ä¸€ä¸ªKubernetesçš„ç®€æ˜“NFSçš„å¤–éƒ¨provisionerï¼Œæœ¬èº«ä¸æä¾›NFSï¼Œéœ€è¦ç°æœ‰çš„NFSæœåŠ¡å™¨æä¾›å­˜å‚¨ PVä»¥ ${namespace}-${pvcName}-${pvName}çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰ PVå›æ”¶çš„æ—¶å€™ä»¥ archieved-${namespace}-${pvcName}-${pvName} çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰ 1. è·å–nfs-client-provisioneré…ç½®æ–‡ä»¶12git clone https://github.com/kubernetes-incubator/external-storage.git 2. å®‰è£…éƒ¨ç½²:1. ä¿®æ”¹deploymentæ–‡ä»¶å¹¶éƒ¨ç½² deploy/deployment.yamléœ€è¦ä¿®æ”¹çš„åœ°æ–¹åªæœ‰NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ192.168.56.113ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/nfs_data_3ï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½• 123456789101112131415161718192021222324252627282930313233343536373839404142cat deploy/deployment.yamlapiVersion: v1kind: ServiceAccountmetadata: name: nfs-client-provisioner---kind: DeploymentapiVersion: extensions/v1beta1metadata: name: nfs-client-provisionerspec: replicas: 1 strategy: type: Recreate template: metadata: labels: app: nfs-client-provisioner spec: serviceAccountName: nfs-client-provisioner containers: - name: nfs-client-provisioner image: quay.io/external_storage/nfs-client-provisioner:latest volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NAME value: fuseim.pri/ifs - name: NFS_SERVER value: 192.168.56.113 - name: NFS_PATH value: /nfs_data_3 volumes: - name: nfs-client-root nfs: server: 192.168.56.113 path: /nfs_data_3$ kubectl apply -f deploy/deployment.yaml # æ‰§è¡Œéƒ¨ç½²serviceaccount/nfs-client-provisioner createddeployment.extensions/nfs-client-provisioner created 2. ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½² deploy/class.yamlæ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´ã€‚ 1234567891011121314151617181920212223cat deploy/class.yamlapiVersion: storage.k8s.io/v1kind: StorageClassmetadata: name: managed-nfs-storageprovisioner: fuseim.pri/ifs # or choose another name, must match deployment's env PROVISIONER_NAME'parameters: archiveOnDelete: \"false\" # æ‰§è¡Œéƒ¨ç½² kubectl apply -f deploy/class.yamlstorageclass.storage.k8s.io/managed-nfs-storage created# æŸ¥çœ‹StorageClasskubectl get scNAME PROVISIONER AGEmanaged-nfs-storage fuseim.pri/ifs 16m# è®¾ç½®è¿™ä¸ªmanaged-nfs-storageåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯kubectl patch storageclass managed-nfs-storage -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'$ kubectl get scNAME PROVISIONER AGEmanaged-nfs-storage (default) fuseim.pri/ifs 19m 3. æˆæƒå¦‚æœæ‚¨çš„é›†ç¾¤å¯ç”¨äº†RBACï¼Œæˆ–è€…æ‚¨æ­£åœ¨è¿è¡ŒOpenShiftï¼Œåˆ™å¿…é¡»æˆæƒprovisionerã€‚ å¦‚æœä½ åœ¨éé»˜è®¤çš„â€œdefaultâ€åç§°ç©ºé—´/é¡¹ç›®ä¹‹å¤–éƒ¨ç½²ï¼Œå¯ä»¥ç¼–è¾‘deploy/rbac.yamlæˆ–ç¼–è¾‘`oadm policyâ€œæŒ‡ä»¤ã€‚ å¦‚æœå¯ç”¨äº†RBACéœ€è¦æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤æ¥æˆæƒã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960cat deploy/rbac.yamlkind: ClusterRoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: nfs-client-provisioner-runnerrules: - apiGroups: [\"\"] resources: [\"persistentvolumes\"] verbs: [\"get\", \"list\", \"watch\", \"create\", \"delete\"] - apiGroups: [\"\"] resources: [\"persistentvolumeclaims\"] verbs: [\"get\", \"list\", \"watch\", \"update\"] - apiGroups: [\"storage.k8s.io\"] resources: [\"storageclasses\"] verbs: [\"get\", \"list\", \"watch\"] - apiGroups: [\"\"] resources: [\"events\"] verbs: [\"create\", \"update\", \"patch\"]---kind: ClusterRoleBindingapiVersion: rbac.authorization.k8s.io/v1metadata: name: run-nfs-client-provisionersubjects: - kind: ServiceAccount name: nfs-client-provisioner namespace: defaultroleRef: kind: ClusterRole name: nfs-client-provisioner-runner apiGroup: rbac.authorization.k8s.io---kind: RoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: leader-locking-nfs-client-provisionerrules: - apiGroups: [\"\"] resources: [\"endpoints\"] verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\"]---kind: RoleBindingapiVersion: rbac.authorization.k8s.io/v1metadata: name: leader-locking-nfs-client-provisionersubjects: - kind: ServiceAccount name: nfs-client-provisioner # replace with namespace where provisioner is deployed namespace: defaultroleRef: kind: Role name: leader-locking-nfs-client-provisioner apiGroup: rbac.authorization.k8s.iokubectl create -f deploy/rbac.yamlclusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner createdclusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner createdrole.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner createdrolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created 4. æ‰§è¡Œéƒ¨ç½²:æµ‹è¯•åˆ›å»ºPVC123456789101112131415161718192021222324cat deploy/test-claim.yamlkind: PersistentVolumeClaimapiVersion: v1metadata: name: test-claim annotations: volume.beta.kubernetes.io/storage-class: \"managed-nfs-storage\"spec: accessModes: - ReadWriteMany resources: requests: storage: 1Mi$ kubectl create -f deploy/test-claim.yamlpersistentvolumeclaim/test-claim created$ kubectl get pv,pvcNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGEpersistentvolume/pvc-137f0450-0048-11e9-af7a-00505621dd5b 1Mi RWX Delete Bound default/test-claim managed-nfs-storage 9mNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEpersistentvolumeclaim/test-claim Bound pvc-137f0450-0048-11e9-af7a-00505621dd5b 1Mi RWX managed-nfs-storage 9m# ä»¥ä¸Šå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„pvcå·²ç»ç”³è¯·æˆåŠŸï¼Œç­‰å¾…PODæŒ‚è½½ä½¿ç”¨ æµ‹è¯•åˆ›å»ºPODPODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶ã€‚ 1234567891011121314151617181920212223242526272829303132cat deploy/test-pod.yamlkind: PodapiVersion: v1metadata: name: test-podspec: containers: - name: test-pod image: gcr.io/google_containers/busybox:1.24 command: - \"/bin/sh\" args: - \"-c\" - \"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1\" volumeMounts: - name: nfs-pvc mountPath: \"/mnt\" restartPolicy: \"Never\" volumes: - name: nfs-pvc persistentVolumeClaim: claimName: test-claim kubectl create -f deploy/test-pod.yamlpod/test-pod created# å¯åŠ¨PODï¼Œä¸€ä¼šå„¿PODå°±æ˜¯completedçŠ¶æ€ï¼Œè¯´æ˜æ‰§è¡Œå®Œæ¯•ã€‚kubectl get pod | grep test-podNAME READY STATUS RESTARTS AGEtest-pod 0/1 Completed 0 18s åœ¨NFSæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ä¸‹çš„å·å­ç›®å½•ä¸­æ£€æŸ¥åˆ›å»ºçš„NFS PVå·ä¸‹æ˜¯å¦æœ‰â€SUCCESSâ€ æ–‡ä»¶ã€‚ä»¥ä¸Šï¼Œè¯´æ˜æˆ‘ä»¬éƒ¨ç½²æ­£å¸¸ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡åŠ¨æ€åˆ†é…NFSçš„æŒä¹…å…±äº«å· å‚è€ƒhttps://k8smeetup.github.io/docs/concepts/storage/volumes/https://k8smeetup.github.io/docs/concepts/storage/persistent-volumes/#å›æ”¶-1https://k8smeetup.github.io/docs/tasks/administer-cluster/pvc-protection/#lichuqianghttps://jimmysong.io/kubernetes-handbook/practice/using-nfs-for-persistent-storage.html","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"kubernets","slug":"kubernets","permalink":"https://blog.sctux.cc/tags/kubernets/"},{"name":"æŒä¹…åŒ–å­˜å‚¨","slug":"æŒä¹…åŒ–å­˜å‚¨","permalink":"https://blog.sctux.cc/tags/%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/"},{"name":"Storage","slug":"Storage","permalink":"https://blog.sctux.cc/tags/Storage/"},{"name":"NFS PVé™æ€ä¾›ç»™","slug":"NFS-PVé™æ€ä¾›ç»™","permalink":"https://blog.sctux.cc/tags/NFS-PV%E9%9D%99%E6%80%81%E4%BE%9B%E7%BB%99/"},{"name":"NFS PVåŠ¨æ€ä¾›ç»™","slug":"NFS-PVåŠ¨æ€ä¾›ç»™","permalink":"https://blog.sctux.cc/tags/NFS-PV%E5%8A%A8%E6%80%81%E4%BE%9B%E7%BB%99/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"ç†è§£kubernetesä¸­çš„æœ‰çŠ¶æ€æœåŠ¡StatefulSet","slug":"kubernetes-statefulset","date":"2018-12-14T07:10:56.000Z","updated":"2025-09-01T01:59:08.980Z","comments":true,"path":"2018/12/14/kubernetes-statefulset/","permalink":"https://blog.sctux.cc/2018/12/14/kubernetes-statefulset/","excerpt":"æ¦‚è¿°æ¦‚å¿µStatefulSet æ˜¯ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜ï¼ˆå¯¹åº” Deployments å’Œ ReplicaSets æ˜¯ä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡ï¼‰ï¼Œå…¶åº”ç”¨åœºæ™¯åŒ…æ‹¬ ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå³ Pod é‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäº PVC æ¥å®ç° ç¨³å®šçš„ç½‘ç»œæ ‡å¿—ï¼Œå³ Pod é‡æ–°è°ƒåº¦åå…¶ PodName å’Œ HostName ä¸å˜ï¼ŒåŸºäº Headless Serviceï¼ˆå³æ²¡æœ‰ Cluster IP çš„ Serviceï¼‰æ¥å®ç° æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼Œå³ Pod æ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‰©å±•çš„æ—¶å€™è¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡ä¾åºè¿›è¡Œï¼ˆå³ä» 0 åˆ° N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ª Pod è¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„ Pod å¿…é¡»éƒ½æ˜¯ Running å’Œ Ready çŠ¶æ€ï¼‰ï¼ŒåŸºäº init containers æ¥å®ç° æœ‰åºæ”¶ç¼©ï¼Œæœ‰åºåˆ é™¤ï¼ˆå³ä» N-1 åˆ° 0ï¼‰ ä»ä¸Šé¢çš„åº”ç”¨åœºæ™¯å¯ä»¥å‘ç°ï¼ŒStatefulSet ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š ç”¨äºå®šä¹‰ç½‘ç»œæ ‡å¿—ï¼ˆDNS domainï¼‰çš„ Headless Service ç”¨äºåˆ›å»º PersistentVolumes çš„ volumeClaimTemplates å®šä¹‰å…·ä½“åº”ç”¨çš„ StatefulSet StatefulSet ä¸­æ¯ä¸ª Pod çš„ DNS æ ¼å¼ä¸º statefulSetName-{0..N-1}.serviceName.namespace.svc.cluster.localï¼Œå…¶ä¸­ serviceName ä¸º Headless Service çš„åå­— 0..N-1 ä¸º Pod æ‰€åœ¨çš„åºå·ï¼Œä» 0 å¼€å§‹åˆ° N-1 statefulSetName ä¸º StatefulSet çš„åå­— namespace ä¸ºæœåŠ¡æ‰€åœ¨çš„ namespaceï¼ŒHeadless Service å’Œ StatefulSet å¿…é¡»åœ¨ç›¸åŒçš„ namespace .cluster.local ä¸º Cluster Domain é™åˆ¶ ç»™å®š Pod çš„å­˜å‚¨å¿…é¡»ç”± PersistentVolume Provisioner æ ¹æ®è¯·æ±‚çš„ storage class è¿›è¡Œé…ç½®ï¼Œæˆ–ç”±ç®¡ç†å‘˜é¢„å…ˆé…ç½®ã€‚ åˆ é™¤æˆ– scale StatefulSet å°†ä¸ä¼šåˆ é™¤ä¸ StatefulSet ç›¸å…³è”çš„ volumeã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œè¿™é€šå¸¸æ¯”è‡ªåŠ¨æ¸…é™¤æ‰€æœ‰ç›¸å…³ StatefulSet èµ„æºæ›´æœ‰ä»·å€¼ã€‚ StatefulSets ç›®å‰è¦æ±‚ Headless Service è´Ÿè´£ Pod çš„ç½‘ç»œèº«ä»½ã€‚ æ‚¨æœ‰è´£ä»»åˆ›å»ºæ­¤æœåŠ¡ã€‚","text":"æ¦‚è¿°æ¦‚å¿µStatefulSet æ˜¯ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜ï¼ˆå¯¹åº” Deployments å’Œ ReplicaSets æ˜¯ä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡ï¼‰ï¼Œå…¶åº”ç”¨åœºæ™¯åŒ…æ‹¬ ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå³ Pod é‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäº PVC æ¥å®ç° ç¨³å®šçš„ç½‘ç»œæ ‡å¿—ï¼Œå³ Pod é‡æ–°è°ƒåº¦åå…¶ PodName å’Œ HostName ä¸å˜ï¼ŒåŸºäº Headless Serviceï¼ˆå³æ²¡æœ‰ Cluster IP çš„ Serviceï¼‰æ¥å®ç° æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼Œå³ Pod æ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‰©å±•çš„æ—¶å€™è¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡ä¾åºè¿›è¡Œï¼ˆå³ä» 0 åˆ° N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ª Pod è¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„ Pod å¿…é¡»éƒ½æ˜¯ Running å’Œ Ready çŠ¶æ€ï¼‰ï¼ŒåŸºäº init containers æ¥å®ç° æœ‰åºæ”¶ç¼©ï¼Œæœ‰åºåˆ é™¤ï¼ˆå³ä» N-1 åˆ° 0ï¼‰ ä»ä¸Šé¢çš„åº”ç”¨åœºæ™¯å¯ä»¥å‘ç°ï¼ŒStatefulSet ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š ç”¨äºå®šä¹‰ç½‘ç»œæ ‡å¿—ï¼ˆDNS domainï¼‰çš„ Headless Service ç”¨äºåˆ›å»º PersistentVolumes çš„ volumeClaimTemplates å®šä¹‰å…·ä½“åº”ç”¨çš„ StatefulSet StatefulSet ä¸­æ¯ä¸ª Pod çš„ DNS æ ¼å¼ä¸º statefulSetName-{0..N-1}.serviceName.namespace.svc.cluster.localï¼Œå…¶ä¸­ serviceName ä¸º Headless Service çš„åå­— 0..N-1 ä¸º Pod æ‰€åœ¨çš„åºå·ï¼Œä» 0 å¼€å§‹åˆ° N-1 statefulSetName ä¸º StatefulSet çš„åå­— namespace ä¸ºæœåŠ¡æ‰€åœ¨çš„ namespaceï¼ŒHeadless Service å’Œ StatefulSet å¿…é¡»åœ¨ç›¸åŒçš„ namespace .cluster.local ä¸º Cluster Domain é™åˆ¶ ç»™å®š Pod çš„å­˜å‚¨å¿…é¡»ç”± PersistentVolume Provisioner æ ¹æ®è¯·æ±‚çš„ storage class è¿›è¡Œé…ç½®ï¼Œæˆ–ç”±ç®¡ç†å‘˜é¢„å…ˆé…ç½®ã€‚ åˆ é™¤æˆ– scale StatefulSet å°†ä¸ä¼šåˆ é™¤ä¸ StatefulSet ç›¸å…³è”çš„ volumeã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œè¿™é€šå¸¸æ¯”è‡ªåŠ¨æ¸…é™¤æ‰€æœ‰ç›¸å…³ StatefulSet èµ„æºæ›´æœ‰ä»·å€¼ã€‚ StatefulSets ç›®å‰è¦æ±‚ Headless Service è´Ÿè´£ Pod çš„ç½‘ç»œèº«ä»½ã€‚ æ‚¨æœ‰è´£ä»»åˆ›å»ºæ­¤æœåŠ¡ã€‚ éƒ¨ç½²StatefulsetæœåŠ¡é¦–å…ˆæˆ‘ä»¬ä¸‹é¢ä½¿ç”¨çš„æ˜¯ç”¨å‰é¢åšæ–‡ä¸­ä½¿ç”¨åˆ°çš„NFSåšåŠ¨æ€ä¾›ç»™PVCä½œä¸ºæŒä¹…åŒ–å­˜å‚¨ã€‚é‚£ä¹ˆä»–çš„åˆ›å»ºæ­¥éª¤è¿™é‡Œä¸åœ¨èµ˜è¿°ï¼Œæˆ‘ä»¬åœ¨ç¼–æ’yamlæ–‡ä»¶ä¸­ç”³è¯·å³å¯ã€‚ è·å–åŠ¨æ€å·ä¿¡æ¯1234567891011$ kubectl describe storageclass managed-nfs-storageName: managed-nfs-storageIsDefaultClass: NoAnnotations: &lt;none&gt;Provisioner: fuseim.pri/ifsParameters: archiveOnDelete=falseAllowVolumeExpansion: &lt;unset&gt;MountOptions: &lt;none&gt;ReclaimPolicy: DeleteVolumeBindingMode: ImmediateEvents: &lt;none&gt; ç¼–å†™serviceä¸€ä¸ªåä¸º nginx çš„ headless serviceï¼Œç”¨äºæ§åˆ¶ç½‘ç»œåŸŸã€‚ 1234567891011121314151617181920$ cat &gt;&gt; statefulset_service.yaml &lt;&lt; EOFapiVersion: v1kind: Servicemetadata: name: nginx labels: app: nginxspec: ports: - port: 80 name: web clusterIP: None selector: app: nginxEOF# æ‰§è¡Œåˆ›å»º$ kubectl create -f statefulset_service.yamlservice/nginx created ç¼–å†™statefulset yaml ä¸€ä¸ªåä¸º web çš„ StatefulSetï¼Œå®ƒçš„ Spec ä¸­æŒ‡å®šåœ¨æœ‰ 2 ä¸ªè¿è¡Œ nginx å®¹å™¨çš„ Podã€‚ volumeClaimTemplates ä½¿ç”¨ PersistentVolume Provisioner æä¾›çš„ PersistentVolumes ä½œä¸ºç¨³å®šå­˜å‚¨ã€‚ volumeClaimTemplates: è¡¨ç¤ºä¸€ç±»PVCçš„æ¨¡æ¿ï¼Œç³»ç»Ÿä¼šæ ¹æ®Statefulseté…ç½®çš„replicasæ•°é‡ï¼Œåˆ›å»ºç›¸åº”æ•°é‡çš„PVCã€‚è¿™äº›PVCé™¤äº†åå­—ä¸ä¸€æ ·ä¹‹å¤–å…¶ä»–é…ç½®éƒ½æ˜¯ä¸€æ ·çš„ã€‚ ä¸‹é¢storageClassNameé…ç½®ä¸ºæˆ‘ä¹‹å‰é€šè¿‡NFSåˆ›å»ºçš„ã€‚ 12345678910111213141516171819202122232425262728293031323334$ cat &gt;&gt; statefulset.yaml &lt;&lt; EOFapiVersion: apps/v1beta1kind: StatefulSetmetadata: name: webspec: serviceName: \"nginx\" replicas: 2 template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx ports: - containerPort: 80 name: web volumeMounts: - name: www-disk mountPath: /usr/share/nginx/html volumeClaimTemplates: - metadata: name: www-disk annotations: volume.beta.kubernetes.io/storage-class: \"managed-nfs-storage\" spec: accessModes: [ \"ReadWriteOnce\" ] storageClassName: \"managed-nfs-storage\" resources: requests: storage: 1GiEOF éªŒè¯æœåŠ¡ä¼¸ç¼©æ€§åˆ›å»ºStatefulsetæœåŠ¡ï¼š123456789101112131415# æ‰§è¡Œåˆ›å»º$ kubectl create -f statefulset.yamlstatefulset.apps/web created$ kubectl get podNAME READY STATUS RESTARTS AGEpod/nfs-client-provisioner-6c6997c674-z7m9r 1/1 Running 0 18mpod/web-0 1/1 Running 0 13mpod/web-1 1/1 Running 0 12m$ kubectl get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEpersistentvolumeclaim/www-disk-web-0 Bound pvc-a440540e-01dd-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 13mpersistentvolumeclaim/www-disk-web-1 Bound pvc-af5c7006-01dd-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 12m æ‰©å®¹æœåŠ¡åˆ°3ä¸ªPodï¼Œæ˜¾ç¤ºä¼šåˆ›å»ºæ–°çš„äº‘ç›˜å·ï¼š123456789101112131415$ kubectl scale sts web --replicas=3statefulset.apps/web scaled$ kubectl get podNAME READY STATUS RESTARTS AGEnfs-client-provisioner-6c6997c674-z7m9r 1/1 Running 0 19mweb-0 1/1 Running 0 14mweb-1 1/1 Running 0 14mweb-2 1/1 Running 0 40s$ kubectl get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEwww-disk-web-0 Bound pvc-a440540e-01dd-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 14mwww-disk-web-1 Bound pvc-af5c7006-01dd-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 14mwww-disk-web-2 Bound pvc-97afce59-01df-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 38s ç¼©å®¹æœåŠ¡åˆ°1ä¸ªPodï¼Œæ˜¾ç¤ºpvc/pvå¹¶ä¸ä¼šä¸€åŒåˆ é™¤ï¼š1234567891011121314$ kubectl scale sts web --replicas=1statefulset.apps/web scaled$ kubectl get podNAME READY STATUS RESTARTS AGEnfs-client-provisioner-6c6997c674-z7m9r 1/1 Running 0 21mweb-0 1/1 Running 0 16m$ kubectl get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEwww-disk-web-0 Bound pvc-a440540e-01dd-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 16mwww-disk-web-1 Bound pvc-af5c7006-01dd-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 16mwww-disk-web-2 Bound pvc-97afce59-01df-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 2m å†æ¬¡æ‰©å®¹åˆ°3ä¸ªPodï¼Œæ–°çš„podä¼šå¤ç”¨åŸæ¥çš„PVC/PVï¼š123456789101112131415$ kubectl scale sts web --replicas=3statefulset.apps/web scaled$ kubectl get podNAME READY STATUS RESTARTS AGEpod/nfs-client-provisioner-6c6997c674-z7m9r 1/1 Running 1 46mpod/web-0 1/1 Running 0 3mpod/web-1 1/1 Running 0 1mpod/web-2 1/1 Running 0 18s$ kubectl get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEpersistentvolumeclaim/www-disk-web-0 Bound pvc-a440540e-01dd-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 41mpersistentvolumeclaim/www-disk-web-1 Bound pvc-af5c7006-01dd-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 40mpersistentvolumeclaim/www-disk-web-2 Bound pvc-97afce59-01df-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 27m åˆ é™¤ä¸€ä¸ªpod/web0å‰ï¼ŒPodå¼•ç”¨PVCï¼šwww-disk-web-012kubectl describe pod/web-0 | grep ClaimName ClaimName: www-disk-web-0 åˆ é™¤Podåï¼Œé‡æ–°åˆ›å»ºçš„Podåå­—ä¸åˆ é™¤çš„ä¸€è‡´ï¼Œä¸”ä½¿ç”¨åŒä¸€ä¸ªPVCï¼š123456789101112131415161718$ kubectl delete pod/web-0pod \"web-0\" deleted$ kubectl get podNAME READY STATUS RESTARTS AGEpod/nfs-client-provisioner-6c6997c674-z7m9r 1/1 Running 1 49mpod/web-0 1/1 Running 0 10spod/web-1 1/1 Running 0 4mpod/web-2 1/1 Running 0 3m$ kubectl describe pod/web-0 | grep ClaimName ClaimName: www-disk-web-0$ kubectl get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEpersistentvolumeclaim/www-disk-web-0 Bound pvc-a440540e-01dd-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 44mpersistentvolumeclaim/www-disk-web-1 Bound pvc-af5c7006-01dd-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 43mpersistentvolumeclaim/www-disk-web-2 Bound pvc-97afce59-01df-11e9-b006-00505621dd5b 1Gi RWO managed-nfs-storage 30m éªŒè¯æœåŠ¡é«˜å¯ç”¨æ€§å…±äº«æŒä¹…å·ä¸­æ–°å»ºæ–‡ä»¶12$ kubectl exec web-1 ls /usr/share/nginx/htmlstatefulset åˆ é™¤Podï¼ŒéªŒè¯æ•°æ®æŒä¹…æ€§ï¼š12345678$ kubectl delete pod web-1pod \"web-1\" deleted# å¾…æ–°çš„podåˆ›å»ºä¹‹åå†æ¬¡æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿˜åœ¨$ kubectl exec web-1 ls /usr/share/nginx/htmlstatefulset# ä»¥ä¸Šè¯´æ˜åˆ é™¤podå¯¹pvcæ²¡æœ‰ä»»ä½•çš„å½±å“ï¼Œæˆ‘ä»¬çš„æ•°æ®è¿˜æ˜¯ä¿å­˜ç€çš„ã€‚ æ•°æ®ä¿å­˜:ä¸Šé¢ä¹Ÿè¯´å•¦, åˆ é™¤æˆ– scale StatefulSet å°†ä¸ä¼šåˆ é™¤ä¸ StatefulSet ç›¸å…³è”çš„ volumeã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œè¿™é€šå¸¸æ¯”è‡ªåŠ¨æ¸…é™¤æ‰€æœ‰ç›¸å…³ StatefulSet èµ„æºæ›´æœ‰ä»·å€¼ã€‚ æ‰€ä»¥æˆ‘åˆ°NFS Serverä¸Šé¢checkä¸€ä¸‹: å¯è§ æˆ‘ä»¬åœ¨pod/web-1ä¸Šåˆ›å»ºçš„æ–‡ä»¶è¿˜æ˜¯ä¿å­˜ç€çš„ã€‚ é™„:è¯¥yamlä¸ºåä¸ºäº‘é‚£è¾¹çš„PVç”³è¯·ï¼Œä»¥åŠStatefulSetåº”ç”¨çš„åˆ›å»º 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566---# PVCå­˜å‚¨ç”³è¯·apiVersion: v1kind: PersistentVolumeClaimmetadata: name: pvc-evs-auto-example namespace: default annotations: volume.beta.kubernetes.io/storage-class: sata volume.beta.kubernetes.io/storage-provisioner: flexvolume-huawei.com/fuxivol labels: failure-domain.beta.kubernetes.io/region: cn-north-1 failure-domain.beta.kubernetes.io/zone: cn-north-1aspec: accessModes: - ReadWriteMany resources: requests: storage: 10Gi---# StatefulSetåº”ç”¨åˆ›å»ºapiVersion: apps/v1kind: StatefulSetmetadata: name: cce21days-app11-guomaoqiu namespace: defaultspec: podManagementPolicy: OrderedReady serviceName: cce21days-app11-guomaoqiu replicas: 3 revisionHistoryLimit: 10 selector: matchLabels: app: cce21days-app11-guomaoqiu failure-domain.beta.kubernetes.io/region: cn-north-1 failure-domain.beta.kubernetes.io/zone: cn-north-1a template: metadata: labels: app: cce21days-app11-guomaoqiu failure-domain.beta.kubernetes.io/region: cn-north-1 failure-domain.beta.kubernetes.io/zone: cn-north-1a spec: affinity: {} containers: - image: 100.125.0.198:20202/guomaoqiu/tank:1.0.1 imagePullPolicy: IfNotPresent name: container-0 resources: {} volumeMounts: - mountPath: /tmp name: pvc-evs-example dnsPolicy: ClusterFirst imagePullSecrets: - name: default-secret restartPolicy: Always schedulerName: default-scheduler securityContext: {} terminationGracePeriodSeconds: 30 volumes: - name: pvc-evs-example persistentVolumeClaim: claimName: pvc-evs-auto-example updateStrategy: type: RollingUpdate","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"StatefulSet","slug":"StatefulSet","permalink":"https://blog.sctux.cc/tags/StatefulSet/"},{"name":"æœ‰çŠ¶æ€","slug":"æœ‰çŠ¶æ€","permalink":"https://blog.sctux.cc/tags/%E6%9C%89%E7%8A%B6%E6%80%81/"},{"name":"æŒä¹…åŒ–å­˜å‚¨","slug":"æŒä¹…åŒ–å­˜å‚¨","permalink":"https://blog.sctux.cc/tags/%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"ç®¡ç†Kubernetesæ—¥å¿—","slug":"kubernetes-logs","date":"2018-12-13T12:47:40.000Z","updated":"2025-09-01T01:59:08.984Z","comments":true,"path":"2018/12/13/kubernetes-logs/","permalink":"https://blog.sctux.cc/2018/12/13/kubernetes-logs/","excerpt":"æ¦‚è¿°æ—¥å¿—æ˜¯æˆ‘ä»¬åœ¨è¿ç»´éƒ¨ç½²å½“ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªä¸œè¥¿ï¼Œå¯¹äºæˆ‘ä¸ªäººå·¥ä½œç»éªŒè€Œè¨€ï¼Œä¸€èˆ¬å‡ºç°é—®é¢˜ï¼Œç¬¬ä¸€æ­¥äº‹æƒ…å°±æ˜¯æŸ¥çœ‹æ—¥å¿—ï¼Œå…¶æ¬¡æ˜¯æœåŠ¡å™¨èµ„æºæŸ¥çœ‹è¿™æ ·å»å®šä½é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨kubernetsé›†ç¾¤å½“ä¸­å‘¢ï¼Œæˆ‘ä¸»è¦ç»™å…¶åˆ†äº†ä¸¤ç§ç±»å‹: kubernetesç»„ä»¶æ—¥å¿— è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿— kubernetesç»„ä»¶æ—¥å¿—æˆ‘ä»¬çŸ¥é“åœ¨kubernetesé›†ç¾¤æ˜¯æœ‰å¤šä¸ªç»„ä»¶ç»„æˆï¼ŒååŒä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªè¿è¡Œå®¹å™¨çš„ç¯å¢ƒã€‚å½“è¿è¡Œå½“ä¸­å‡ºç°é—®é¢˜ï¼Œä¹Ÿæ˜¯éœ€è¦æŸ¥çœ‹å¯¹åº”ç»„ä»¶çš„æ—¥å¿—ï¼Œè¿›è¡Œé—®é¢˜æ’æŸ¥ã€å¤„ç†ã€‚é‚£ä¹ˆå¸¸è§çš„æ—¥å¿—å¦‚ä¸‹ï¼š 12345/var/log/kube-apiserver.log/var/log/kube-proxy.log/var/log/kube-controller-manager.log/var/log/kube-scheduler.log/var/log/kubelet.log å½“ç„¶æ ¹æ®æ­å»ºé›†ç¾¤çš„æ–¹å¼ä¸åŒï¼Œæˆ‘ä»¬é…ç½®çš„æ—¥å¿—ç›®å½•ä¹Ÿä¸å°½ç›¸åŒï¼Œæ‰€ä»¥åªæ˜¯åˆ—ä¸¾ä¸€ä¸‹ï¼›å¦‚æœç»„ä»¶çš„å®‰è£…æ–¹å¼ç”±systemdæ¥ç®¡ç†çš„è¯ æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ’é”™ 123journalctl -u kubeletæˆ–systemctl status kubelet -l å¦‚æœä½¿ç”¨çš„æ˜¯kuernetesæ’ä»¶å¼æ–¹å¼éƒ¨ç½²çš„ç»„ä»¶åˆ™ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ 1kubectl logs -f &lt;ç»„ä»¶åç§°&gt;","text":"æ¦‚è¿°æ—¥å¿—æ˜¯æˆ‘ä»¬åœ¨è¿ç»´éƒ¨ç½²å½“ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªä¸œè¥¿ï¼Œå¯¹äºæˆ‘ä¸ªäººå·¥ä½œç»éªŒè€Œè¨€ï¼Œä¸€èˆ¬å‡ºç°é—®é¢˜ï¼Œç¬¬ä¸€æ­¥äº‹æƒ…å°±æ˜¯æŸ¥çœ‹æ—¥å¿—ï¼Œå…¶æ¬¡æ˜¯æœåŠ¡å™¨èµ„æºæŸ¥çœ‹è¿™æ ·å»å®šä½é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨kubernetsé›†ç¾¤å½“ä¸­å‘¢ï¼Œæˆ‘ä¸»è¦ç»™å…¶åˆ†äº†ä¸¤ç§ç±»å‹: kubernetesç»„ä»¶æ—¥å¿— è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿— kubernetesç»„ä»¶æ—¥å¿—æˆ‘ä»¬çŸ¥é“åœ¨kubernetesé›†ç¾¤æ˜¯æœ‰å¤šä¸ªç»„ä»¶ç»„æˆï¼ŒååŒä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªè¿è¡Œå®¹å™¨çš„ç¯å¢ƒã€‚å½“è¿è¡Œå½“ä¸­å‡ºç°é—®é¢˜ï¼Œä¹Ÿæ˜¯éœ€è¦æŸ¥çœ‹å¯¹åº”ç»„ä»¶çš„æ—¥å¿—ï¼Œè¿›è¡Œé—®é¢˜æ’æŸ¥ã€å¤„ç†ã€‚é‚£ä¹ˆå¸¸è§çš„æ—¥å¿—å¦‚ä¸‹ï¼š 12345/var/log/kube-apiserver.log/var/log/kube-proxy.log/var/log/kube-controller-manager.log/var/log/kube-scheduler.log/var/log/kubelet.log å½“ç„¶æ ¹æ®æ­å»ºé›†ç¾¤çš„æ–¹å¼ä¸åŒï¼Œæˆ‘ä»¬é…ç½®çš„æ—¥å¿—ç›®å½•ä¹Ÿä¸å°½ç›¸åŒï¼Œæ‰€ä»¥åªæ˜¯åˆ—ä¸¾ä¸€ä¸‹ï¼›å¦‚æœç»„ä»¶çš„å®‰è£…æ–¹å¼ç”±systemdæ¥ç®¡ç†çš„è¯ æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ’é”™ 123journalctl -u kubeletæˆ–systemctl status kubelet -l å¦‚æœä½¿ç”¨çš„æ˜¯kuernetesæ’ä»¶å¼æ–¹å¼éƒ¨ç½²çš„ç»„ä»¶åˆ™ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ 1kubectl logs -f &lt;ç»„ä»¶åç§°&gt; è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—è¿è¡Œäºkubernetesä¸Šçš„ï¼Œæ¯”å¦‚ä¸€ä¸ªnginxå®¹å™¨ï¼›æˆ‘ä»¬å¦‚ä½•æŸ¥çœ‹è¿™ä¸ªåº”ç”¨çš„æ—¥å¿—å‘¢ï¼Ÿ ä»å®¹å™¨æ ‡å‡†è¾“å‡ºæˆªè·ç”¨æ³•ç±»ä¼¼äºdocker 1kubectl logs -f {POD_NAME} -c {Container_NAME} è¿›å…¥å®¹å™¨è¿›è¡ŒæŸ¥çœ‹12kubectl exec -it {POD_NAME} -c {Container_NAME} /bin/shdocker exec -it {Container_NAME} /bin/sh å°†æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°ä¸»æœºç›®å½•æ¯”å¦‚æˆ‘è¦æŠŠnginxçš„æ—¥å¿—æŒ‚è½½åˆ°è¿è¡Œäºè¯¥PODçš„å®¿ä¸»æœºçš„æŸä¸ªç›®å½• 1234567891011121314151617181920212223242526272829303132333435363738# ç¼–å†™yamlæ–‡ä»¶# è¿™é‡Œæˆ‘ä»¬çŸ¥é“æ‰‹å†™ä¸€ä¸ªyamlæ˜¯å¾ˆçƒ¦çš„ï¼Œè€Œä¸”é‚£ä¹ˆå¤šå…³é”®è¯ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“è®°ä½ï¼Œ# é‚£ä¹ˆæ­¤æ—¶å°±éœ€è¦åœ¨ç°æœ‰ç¯å¢ƒä¸­æ‰¾ä¸€ä¸ªpodç„¶åæŠŠä»–çš„yamlå¯¼å‡ºå†åšä¿®æ”¹# å¦‚æœç¯å¢ƒä¸­è¿˜æ˜¯æ²¡æœ‰podï¼Œé‚£å°±ç›´æ¥runä¸€ä¸ª$ kubectl get pod nginx-67ccc95d8c-fd5nk -o yaml --export &gt; nginx.yaml# åˆ é™¤ä¸€äº›ä¸å¿…è¦çš„å­—æ®µ$ vim nginx.yaml apiVersion: v1kind: Podmetadata: name: nginx labels: run: nginxspec: containers: - image: nginx:latest imagePullPolicy: IfNotPresent name: nginx volumeMounts: - mountPath: /var/log/nginx # nginxåº”ç”¨é»˜è®¤æ—¥å¿—ç›®å½• name: nginx-log-volume volumes: - name: nginx-log-volume hostPath: path: /var/k8s/log # å®¿ä¸»æœºç›®å½• $ kubectl create -f nginx.yamlpod \"nginx\" created# æŸ¥çœ‹å®¿ä¸»æœºï¼Œè¿™æ ·å®¹å™¨çš„æ—¥å¿—ç›®å½•æˆ‘å°±æŒ‚åˆ°äº†å®¿ä¸»# è€Œä¸ç”¨åœ¨è¿›å…¥å®¹å™¨ä¸­æŸ¥çœ‹äº†$ ll /var/k8s/log/ total 0-rw-r----- 1 root root 0 Dec 18 15:17 access.log-rw-r----- 1 root root 0 Dec 18 15:17 error.log æ³¨æ„ç‚¹: å†™yamlçš„æ—¶å€™ä¸€å®šè¦å…»æˆå¯¼å‡ºç°æœ‰èµ„æºç±»å‹çš„yamlçš„ä¹ æƒ¯å†å»ä¿®æ”¹ï¼›è¿™æ ·èƒ½é¿å…æ‰‹åŠ¨ç¼–å†™æ—¶æ ¼å¼çš„ä¸€äº›é—®é¢˜ï¼Œå¦‚æœå…³é”®å­—è®°ä¸ä½é‚£å°±ä¸€å®šè¦ç”¨kubectl explainè·å–èµ„æºæ–‡æ¡£","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/tags/kubernetes/"},{"name":"log","slug":"log","permalink":"https://blog.sctux.cc/tags/log/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"ç†è§£kubernetesä¸­Podè®¿é—®æ–¹å¼","slug":"kubernetes_pod_access","date":"2018-12-12T10:39:11.000Z","updated":"2025-09-01T01:59:08.959Z","comments":true,"path":"2018/12/12/kubernetes_pod_access/","permalink":"https://blog.sctux.cc/2018/12/12/kubernetes_pod_access/","excerpt":"æ¦‚è¿°Podçš„IPæ˜¯åœ¨docker0ç½‘æ®µåŠ¨æ€åˆ†é…çš„ï¼Œå½“å‘ç”Ÿé‡å¯ï¼Œæ‰©å®¹ç­‰æ“ä½œæ—¶ï¼ŒIPåœ°å€ä¼šéšä¹‹å˜åŒ–ã€‚å½“æŸä¸ªPod(frontend)éœ€è¦å»è®¿é—®å…¶ä¾èµ–çš„å¦å¤–ä¸€ç»„Pod(backend)æ—¶ï¼Œå¦‚æœbackendçš„IPå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¦‚ä½•ä¿è¯frontedåˆ°backendçš„æ­£å¸¸é€šä¿¡å˜çš„éå¸¸é‡è¦ã€‚ç”±æ­¤ï¼Œå¼•å‡ºäº†Serviceçš„æ¦‚å¿µã€‚è¿™é‡Œdocker0æ˜¯ä¸€ä¸ªç½‘æ¡¥ï¼Œdocker daemonå¯åŠ¨containeræ—¶ä¼šæ ¹æ®docker0çš„ç½‘æ®µæ¥åˆ’ç²‰containerçš„IPåœ°å€Dockerç½‘ç»œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯¹Serviceçš„è®¿é—®å¯èƒ½ä¼šæœ‰ä¸¤ç§æ¥æºï¼šKubernetesé›†ç¾¤å†…éƒ¨çš„ç¨‹åºï¼ˆPodï¼‰å’ŒKubernetesé›†ç¾¤å¤–éƒ¨ï¼Œä¸ºäº†æ»¡è¶³ä¸Šè¿°çš„åœºæ™¯ï¼ŒKubernetes serviceæœ‰ä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š ClusterIP:æä¾›ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„è™šæ‹ŸIPä»¥ä¾›Podè®¿é—®ã€‚ NodePort:åœ¨æ¯ä¸ªNodeä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£ä»¥ä¾›å¤–éƒ¨è®¿é—®ã€‚ LoadBalancer:é€šè¿‡å¤–éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨æ¥è®¿é—®ã€‚ é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œé€šè¿‡ä¸‹é¢çš„ç¤ºä¾‹æ¥ç†è§£ã€‚(åˆ›å»ºæ–¹å¼å¯ä»¥æ˜¯é€šè¿‡yamlæ–‡ä»¶æˆ–è€…æ˜¯å‘½ä»¤è¡Œæ–¹å¼ï¼Œè¿™é‡Œä¸ºäº†ç†è§£æˆ‘å…ˆç”¨å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºï¼Œå¦‚æœä¸åˆé€‚çš„åœ°æ–¹æˆ‘ä»¬é€šè¿‡kubectl edit (RESOURCE/NAME | -f FILENAME) [options]è¿™ç§æ–¹å¼å…ˆä¿®æ”¹) å…¶æ¬¡ï¼Œè¿˜éœ€è¦ç†è§£NodePort,TargetPortä»¥åŠportä»–ä»¬çš„åŒºåˆ«:NodePortå¤–éƒ¨æœºå™¨å¯è®¿é—®çš„ç«¯å£ã€‚æ¯”å¦‚ä¸€ä¸ªWebåº”ç”¨éœ€è¦è¢«å…¶ä»–ç”¨æˆ·è®¿é—®ï¼Œé‚£ä¹ˆéœ€è¦é…ç½®type=NodePortï¼Œè€Œä¸”é…ç½®nodePort=30001ï¼Œé‚£ä¹ˆå…¶ä»–æœºå™¨å°±å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®scheme://node:30001è®¿é—®åˆ°è¯¥æœåŠ¡ï¼Œä¾‹å¦‚http://node:30001ã€‚ä¾‹å¦‚MySQLæ•°æ®åº“å¯èƒ½ä¸éœ€è¦è¢«å¤–ç•Œè®¿é—®ï¼Œåªéœ€è¢«å†…éƒ¨æœåŠ¡è®¿é—®ï¼Œé‚£ä¹ˆä¸å¿…è®¾ç½®NodePort TargetPortå®¹å™¨çš„ç«¯å£ï¼ˆæœ€æ ¹æœ¬çš„ç«¯å£å…¥å£ï¼‰ï¼Œä¸åˆ¶ä½œå®¹å™¨æ—¶æš´éœ²çš„ç«¯å£ä¸€è‡´ï¼ˆDockerFileä¸­EXPOSEï¼‰ï¼Œä¾‹å¦‚docker.ioå®˜æ–¹çš„nginxæš´éœ²çš„æ˜¯80ç«¯å£ã€‚docker.ioå®˜æ–¹çš„nginxå®¹å™¨çš„DockerFileå‚è€ƒhttps://github.com/nginxinc/docker-nginx 123456789101112apiVersion: v1kind: Servicemetadata: name: nginx-servicespec: type: NodePort # æœ‰é…ç½®NodePortï¼Œå¤–éƒ¨æµé‡å¯è®¿é—®k8sä¸­çš„æœåŠ¡ ports: - port: 30080 # æœåŠ¡è®¿é—®ç«¯å£ targetPort: 80 # å®¹å™¨ç«¯å£ nodePort: 30001 # NodePort selector: name: nginx-pod port kubernetesä¸­çš„æœåŠ¡ä¹‹é—´è®¿é—®çš„ç«¯å£ï¼Œå°½ç®¡mysqlå®¹å™¨æš´éœ²äº†3306ç«¯å£ï¼ˆå‚è€ƒhttps://github.com/docker-library/mysql/çš„DockerFileï¼‰ï¼Œä½†æ˜¯é›†ç¾¤å†…å…¶ä»–å®¹å™¨éœ€è¦é€šè¿‡33306ç«¯å£è®¿é—®è¯¥æœåŠ¡ï¼Œå¤–éƒ¨æœºå™¨ä¸èƒ½è®¿é—®mysqlæœåŠ¡ï¼Œå› ä¸ºä»–æ²¡æœ‰é…ç½®NodePortç±»å‹ 12345678910apiVersion: v1kind: Servicemetadata: name: mysql-servicespec: ports: - port: 33306 targetPort: 3306 selector: name: mysql-pod","text":"æ¦‚è¿°Podçš„IPæ˜¯åœ¨docker0ç½‘æ®µåŠ¨æ€åˆ†é…çš„ï¼Œå½“å‘ç”Ÿé‡å¯ï¼Œæ‰©å®¹ç­‰æ“ä½œæ—¶ï¼ŒIPåœ°å€ä¼šéšä¹‹å˜åŒ–ã€‚å½“æŸä¸ªPod(frontend)éœ€è¦å»è®¿é—®å…¶ä¾èµ–çš„å¦å¤–ä¸€ç»„Pod(backend)æ—¶ï¼Œå¦‚æœbackendçš„IPå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¦‚ä½•ä¿è¯frontedåˆ°backendçš„æ­£å¸¸é€šä¿¡å˜çš„éå¸¸é‡è¦ã€‚ç”±æ­¤ï¼Œå¼•å‡ºäº†Serviceçš„æ¦‚å¿µã€‚è¿™é‡Œdocker0æ˜¯ä¸€ä¸ªç½‘æ¡¥ï¼Œdocker daemonå¯åŠ¨containeræ—¶ä¼šæ ¹æ®docker0çš„ç½‘æ®µæ¥åˆ’ç²‰containerçš„IPåœ°å€Dockerç½‘ç»œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯¹Serviceçš„è®¿é—®å¯èƒ½ä¼šæœ‰ä¸¤ç§æ¥æºï¼šKubernetesé›†ç¾¤å†…éƒ¨çš„ç¨‹åºï¼ˆPodï¼‰å’ŒKubernetesé›†ç¾¤å¤–éƒ¨ï¼Œä¸ºäº†æ»¡è¶³ä¸Šè¿°çš„åœºæ™¯ï¼ŒKubernetes serviceæœ‰ä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š ClusterIP:æä¾›ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„è™šæ‹ŸIPä»¥ä¾›Podè®¿é—®ã€‚ NodePort:åœ¨æ¯ä¸ªNodeä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£ä»¥ä¾›å¤–éƒ¨è®¿é—®ã€‚ LoadBalancer:é€šè¿‡å¤–éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨æ¥è®¿é—®ã€‚ é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œé€šè¿‡ä¸‹é¢çš„ç¤ºä¾‹æ¥ç†è§£ã€‚(åˆ›å»ºæ–¹å¼å¯ä»¥æ˜¯é€šè¿‡yamlæ–‡ä»¶æˆ–è€…æ˜¯å‘½ä»¤è¡Œæ–¹å¼ï¼Œè¿™é‡Œä¸ºäº†ç†è§£æˆ‘å…ˆç”¨å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºï¼Œå¦‚æœä¸åˆé€‚çš„åœ°æ–¹æˆ‘ä»¬é€šè¿‡kubectl edit (RESOURCE/NAME | -f FILENAME) [options]è¿™ç§æ–¹å¼å…ˆä¿®æ”¹) å…¶æ¬¡ï¼Œè¿˜éœ€è¦ç†è§£NodePort,TargetPortä»¥åŠportä»–ä»¬çš„åŒºåˆ«:NodePortå¤–éƒ¨æœºå™¨å¯è®¿é—®çš„ç«¯å£ã€‚æ¯”å¦‚ä¸€ä¸ªWebåº”ç”¨éœ€è¦è¢«å…¶ä»–ç”¨æˆ·è®¿é—®ï¼Œé‚£ä¹ˆéœ€è¦é…ç½®type=NodePortï¼Œè€Œä¸”é…ç½®nodePort=30001ï¼Œé‚£ä¹ˆå…¶ä»–æœºå™¨å°±å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®scheme://node:30001è®¿é—®åˆ°è¯¥æœåŠ¡ï¼Œä¾‹å¦‚http://node:30001ã€‚ä¾‹å¦‚MySQLæ•°æ®åº“å¯èƒ½ä¸éœ€è¦è¢«å¤–ç•Œè®¿é—®ï¼Œåªéœ€è¢«å†…éƒ¨æœåŠ¡è®¿é—®ï¼Œé‚£ä¹ˆä¸å¿…è®¾ç½®NodePort TargetPortå®¹å™¨çš„ç«¯å£ï¼ˆæœ€æ ¹æœ¬çš„ç«¯å£å…¥å£ï¼‰ï¼Œä¸åˆ¶ä½œå®¹å™¨æ—¶æš´éœ²çš„ç«¯å£ä¸€è‡´ï¼ˆDockerFileä¸­EXPOSEï¼‰ï¼Œä¾‹å¦‚docker.ioå®˜æ–¹çš„nginxæš´éœ²çš„æ˜¯80ç«¯å£ã€‚docker.ioå®˜æ–¹çš„nginxå®¹å™¨çš„DockerFileå‚è€ƒhttps://github.com/nginxinc/docker-nginx 123456789101112apiVersion: v1kind: Servicemetadata: name: nginx-servicespec: type: NodePort # æœ‰é…ç½®NodePortï¼Œå¤–éƒ¨æµé‡å¯è®¿é—®k8sä¸­çš„æœåŠ¡ ports: - port: 30080 # æœåŠ¡è®¿é—®ç«¯å£ targetPort: 80 # å®¹å™¨ç«¯å£ nodePort: 30001 # NodePort selector: name: nginx-pod port kubernetesä¸­çš„æœåŠ¡ä¹‹é—´è®¿é—®çš„ç«¯å£ï¼Œå°½ç®¡mysqlå®¹å™¨æš´éœ²äº†3306ç«¯å£ï¼ˆå‚è€ƒhttps://github.com/docker-library/mysql/çš„DockerFileï¼‰ï¼Œä½†æ˜¯é›†ç¾¤å†…å…¶ä»–å®¹å™¨éœ€è¦é€šè¿‡33306ç«¯å£è®¿é—®è¯¥æœåŠ¡ï¼Œå¤–éƒ¨æœºå™¨ä¸èƒ½è®¿é—®mysqlæœåŠ¡ï¼Œå› ä¸ºä»–æ²¡æœ‰é…ç½®NodePortç±»å‹ 12345678910apiVersion: v1kind: Servicemetadata: name: mysql-servicespec: ports: - port: 33306 targetPort: 3306 selector: name: mysql-pod ä¸€ã€Create service (type: ClusterIP)æ­¤æ¨¡å¼ä¼šæä¾›ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„è™šæ‹ŸIPï¼ˆä¸Podä¸åœ¨åŒä¸€ç½‘æ®µ)ï¼Œä»¥ä¾›é›†ç¾¤å†…éƒ¨çš„podä¹‹é—´é€šä¿¡ä½¿ç”¨ã€‚ClusterIPä¹Ÿæ˜¯Kubernetes serviceçš„é»˜è®¤ç±»å‹ã€‚ ä¸ºäº†å®ç°å›¾ä¸Šçš„åŠŸèƒ½ä¸»è¦éœ€è¦ä»¥ä¸‹å‡ ä¸ªç»„ä»¶çš„ååŒå·¥ä½œ apiserver ç”¨æˆ·é€šè¿‡kubectlå‘½ä»¤å‘apiserverå‘é€åˆ›å»ºserviceçš„å‘½ä»¤ï¼Œapiserveræ¥æ”¶åˆ°è¯·æ±‚ä»¥åå°†æ•°æ®å­˜å‚¨åˆ°etcdä¸­ã€‚ kube-proxy kubernetesçš„æ¯ä¸ªèŠ‚ç‚¹ä¸­éƒ½æœ‰ä¸€ä¸ªå«åškube-proxyçš„è¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹è´Ÿè´£æ„ŸçŸ¥serviceï¼Œpodçš„å˜åŒ–ï¼Œå¹¶å°†å˜åŒ–çš„ä¿¡æ¯å†™å…¥æœ¬åœ°çš„iptablesä¸­ã€‚ iptables ä½¿ç”¨NATç­‰æŠ€æœ¯å°†virtualIPçš„æµé‡è½¬è‡³endpointä¸­ã€‚ ä¸‹é¢æˆ‘ä»¬å®é™…å‘å¸ƒä¸€ä¸ªServiceï¼Œèƒ½å¤Ÿæ›´æ¸…æ™°çš„äº†è§£åˆ°Serviceæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ 1. é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºservice,ç±»å‹ä¸ºclusterip12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455$ kubectl create service clusterip my-svc-cp --tcp=8080:80$ kubectl describe service/my-svc-cpName: my-svc-cpNamespace: defaultLabels: app=my-svc-cpAnnotations: &lt;none&gt;Selector: app=my-svc-cpType: ClusterIP # ç±»å‹IP: 10.247.52.210Port: 80-8080 8080/TCP # æ˜ å°„åˆ°é›†ç¾¤çš„ç«¯å£TargetPort: 80/TCP # ç›®æ ‡podæš´éœ²ç«¯å£Endpoints: &lt;none&gt; # æ­¤æ—¶è¿˜æ²¡æœ‰åç«¯å®¹å™¨Session Affinity: NoneEvents: &lt;none&gt;$ kubectl get svc -o widemy-svc-cp ClusterIP 10.247.52.210 &lt;none&gt; 80/TCP 6s app=my-svc-cp# ä»¥ä¸Šæˆ‘åˆ›å»ºäº†ä¸€ä¸ªsvc, é‚£ä¹ˆä»–æ˜¯ä¸ºpodæœåŠ¡çš„,# é‚£ä¹ˆ podè·Ÿserviceæ˜¯é€šè¿‡`selector label`æ¥åšå…³è”çš„, æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å¯¹è¿™ä¸ªsvcåšä¸‹è°ƒæ•´$ kubectl edit svc my-svc-cp# Please edit the object below. Lines beginning with a '#' will be ignored,# and an empty file will abort the edit. If an error occurs while saving this file will be# reopened with the relevant failures.#apiVersion: v1kind: Servicemetadata: creationTimestamp: 2018-12-12T17:41:54Z labels: app: my-svc-cp name: my-svc-cp namespace: default resourceVersion: \"32742\" selfLink: /api/v1/namespaces/default/services/my-svc-cp uid: 372f6f2c-fe35-11e8-b967-fa163e874e90spec: clusterIP: 10.247.52.210 ports: - name: 80-8080 port: 8080 protocol: TCP targetPort: 80 selector: app: my-svc-cp-pod # è¿™é‡Œæˆ‘ä¿®æ”¹äº†selector ï¼Œéœ€è¦ä¸pod nameä¸ä¹‹å¯¹åº”èµ·æ¥ sessionAffinity: None type: ClusterIPstatus: loadBalancer: {}# :wq ä¿å­˜é€€å‡º# kubectl describe service/my-svc-cp æŸ¥çœ‹ä¿®æ”¹æ˜¯å¦æˆåŠŸ 2.åˆ›å»ºpodæ³¨æ„selector label 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485$ vim my-svc-cp-pod.yamlapiVersion: v1kind: Podmetadata: name: my-svc-cp-pod labels: app: my-svc-cp-podspec: containers: - image: nginx:latest imagePullPolicy: Always name: nginx # æ³¨æ„è¿™é‡Œçš„äº²å’Œæ€§æ˜¯ä¸ºäº†å°†podè°ƒåº¦è‡³æœ‰å¤–ç½‘çš„nodeèŠ‚ç‚¹ä¾¿äºpullé•œåƒ affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - 192.168.253.183 restartPolicy: Always schedulerName: default-scheduler# æ‰§è¡Œ:$ kubectl create -f my-svc-cp-pod.yaml$ kubectl get pods,svc,endpoints,deployment -o wideNAME READY STATUS RESTARTS AGE IP NODEpo/my-svc-cp-pod 1/1 Running 0 36m 172.16.0.36 192.168.253.183NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORsvc/kubernetes ClusterIP 10.247.0.1 &lt;none&gt; 443/TCP 1h &lt;none&gt;svc/my-svc-cp ClusterIP 10.247.52.210 &lt;none&gt; 8080/TCP 3m app=my-svc-cp-podNAME ENDPOINTS AGEep/kubernetes 192.168.103.50:5444,192.168.174.46:5444,192.168.236.124:5444 1hep/my-svc-cp 172.16.0.36:80 3m# å†æ¬¡æŸ¥çœ‹serviceæ˜¯å¦å…³è”åˆ°äº†pod$ kubectl describe ep/my-svc-cpName: my-svc-cpNamespace: defaultLabels: app=my-svc-cpAnnotations: &lt;none&gt;Subsets: Addresses: 172.16.0.36 # å¯è§endpointsä¸­å·²ç»æœ‰äº†åç«¯çš„é‚£ä¸ªpod NotReadyAddresses: &lt;none&gt; Ports: Name Port Protocol ---- ---- -------- 80-8080 80 TCPEvents: &lt;none&gt;# é›†ç¾¤å†…éƒ¨é€šè¿‡Cluster IPè®¿é—®nginxæœåŠ¡# æŒ‡å®šäº†ç«¯å£æ˜ å°„åˆ°Cluster IP$ curl -I 10.247.52.210:8080HTTP/1.1 200 OKServer: nginx/1.15.5Date: Wed, 12 Dec 2018 17:48:56 GMTContent-Type: text/htmlContent-Length: 612Last-Modified: Tue, 02 Oct 2018 14:49:27 GMTConnection: keep-aliveETag: \"5bb38577-264\"Accept-Ranges: bytes# é›†ç¾¤å†…éƒ¨é€šè¿‡POD IPè®¿é—®nginxæœåŠ¡# å› ä¸ºpodæš´éœ²çš„æ˜¯80 é»˜è®¤ä¸ç”¨åŠ ç«¯å£$ curl -I 172.16.0.36HTTP/1.1 200 OKServer: nginx/1.15.5Date: Wed, 12 Dec 2018 17:47:52 GMTContent-Type: text/htmlContent-Length: 612Last-Modified: Tue, 02 Oct 2018 14:49:27 GMTConnection: keep-aliveETag: \"5bb38577-264\"Accept-Ranges: bytes# é€šè¿‡è¿™ç§æ–¹å¼ä¹Ÿåªæ˜¯é›†ç¾¤å†…éƒ¨èƒ½å¤Ÿè®¿é—®åˆ°ï¼Œå¦‚æœé›†ç¾¤å¤–éƒ¨è¦è®¿é—®æˆ‘ä»¬çš„podåˆè¯¥å¦‚ä½•åšå‘¢ï¼Ÿ# ä¸‹é¢ç»§ç»­ äºŒã€Create service (type: NodePort)1.é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºservice,ç±»å‹ä¸ºnodeportCluster service çš„ IP åœ°å€æ˜¯è™šæ‹Ÿçš„ï¼Œå› æ­¤ï¼Œåªèƒ½ä»nodeèŠ‚ç‚¹ä¸Šä½¿ç”¨è¯¥IP åœ°å€è®¿é—®åº”ç”¨ã€‚ä¸ºäº†ä»é›†ç¾¤å¤–è®¿é—®åº”ç”¨ï¼ŒK8S æä¾›äº†ä½¿ç”¨ node èŠ‚ç‚¹çš„IP åœ°å€è®¿é—®åº”ç”¨çš„æ–¹å¼ã€‚ åŸºæœ¬ä¸Šï¼ŒNodePort æœåŠ¡ä¸æ™®é€šçš„ â€œClusterIPâ€ æœåŠ¡ YAML å®šä¹‰æœ‰ä¸¤ç‚¹åŒºåˆ«ã€‚ é¦–å…ˆï¼Œtype æ˜¯ â€œNodePortâ€ã€‚è¿˜æœ‰ä¸€ä¸ªç§°ä¸º nodePort çš„é™„åŠ ç«¯å£ï¼ŒæŒ‡å®šåœ¨èŠ‚ç‚¹ä¸Šæ‰“å¼€å“ªä¸ªç«¯å£ã€‚ å¦‚æœä½ ä¸æŒ‡å®šè¿™ä¸ªç«¯å£ï¼Œå®ƒä¼šé€‰æ‹©ä¸€ä¸ªéšæœºç«¯å£ã€‚ ä¸‹å›¾ä¸­æ˜¯ 32591. è¯¥ç«¯å£å·çš„èŒƒå›´æ˜¯ kube-apiserver çš„å¯åŠ¨å‚æ•° â€“service-node-port-rangeæŒ‡å®šçš„ï¼Œåœ¨å½“å‰æµ‹è¯•ç¯å¢ƒä¸­å…¶å€¼æ˜¯ 30000-32767ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041$ kubectl create service nodeport my-svc-np --tcp=8080:80[root@linux-node1 ~]# kubectl describe service my-svc-npName: my-svc-npNamespace: defaultLabels: app=my-svc-npAnnotations: &lt;none&gt;Selector: app=my-svc-npType: NodePort # ç±»å‹IP: 10.103.115.169 # åˆ†é…çš„ClusterIPPort: 8080-80 8080/TCP # å®¹å™¨æ˜ å°„åˆ°nodeèŠ‚ç‚¹çš„ç«¯å£TargetPort: 80/TCP # å®¹å™¨å°†è¦æš´éœ²çš„ç«¯å£NodePort: 8080-80 32591/TCP # é™„åŠ ç«¯å£Endpoints: &lt;none&gt; # æ­¤æ—¶åç«¯æ²¡æœ‰podSession Affinity: NoneExternal Traffic Policy: ClusterEvents: &lt;none&gt;# æœ‰äº†svcæˆ‘ä»¬å°±éœ€è¦åˆ›å»ºä¸€ä¸ªæˆ–è€…ä¸€ç»„podæ¥è·Ÿè¿™ä¸ªsvcå»ºç«‹è¿æ¥# åƒå‰é¢ä¸€æ ·æˆ‘ä»¬éœ€è¦æ›´æ”¹è¿™ä¸ªsvcçš„é€‰æ‹©å™¨ï¼š$ kubectl edit svc my-svc-np............ externalTrafficPolicy: Cluster ports: - name: 8080-80 nodePort: 32591 port: 8080 protocol: TCP targetPort: 80 selector: app: my-svc-np-pod # ä¸å³å°†åˆ›å»ºçš„podå¯¹åº”ä¸Š sessionAffinity: None type: NodePortstatus: loadBalancer: {}............# :wqä¿å­˜é€€å‡º 2.åˆ›å»ºpodä¸ä¹‹å»ºç«‹å…³ç³»123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596# æˆ‘è¿™é‡Œé€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºä¸€ä¸ªdeploymentçš„3ä¸ªå‰¯æœ¬çš„nginx pod# 1. é¦–å…ˆé€šè¿‡å‘½ä»¤è¡Œç”Ÿæˆyamlæ–‡ä»¶$ kubectl run nginx-deployment --image=nginx --replicas=3 --dry-run -o yaml &gt; nginx-deployment.yaml# 2. è¿›è¡Œè°ƒæ•´$ cat &gt;&gt; nginx-deployment.yaml &lt;&lt; EOFapiVersion: apps/v1beta1kind: Deploymentmetadata: creationTimestamp: null labels: run: nginx-deployment name: nginx-deploymentspec: replicas: 3 selector: matchLabels: app: my-svc-np-pod # æ­¤å¤„ä¿®æ”¹ä¸ºsvc selectorç›¸åŒ strategy: {} template: metadata: creationTimestamp: null labels: app: my-svc-np-pod # æ­¤å¤„ä¿®æ”¹ä¸ºsvc selectorç›¸åŒ spec: containers: - image: nginx name: nginx-deployment resources: {}status: {}EOF# 3. æ‰§è¡Œ$ kubectl create -f nginx-deployment.yamldeployment.apps/nginx-deployment created# 4. æŸ¥çœ‹çŠ¶æ€:$ kubectl get pod -o wideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODEnginx-deployment-6794c779fb-8x92g 1/1 Running 0 4m 10.244.1.19 k8s-m2 &lt;none&gt;nginx-deployment-6794c779fb-rf8qj 1/1 Running 0 4m 10.244.0.19 k8s-m3 &lt;none&gt;nginx-deployment-6794c779fb-tdscx 1/1 Running 0 4m 10.244.2.35 k8s-m1 &lt;none&gt;$ kubectl describe svc my-svc-npName: my-svc-npNamespace: defaultLabels: app=my-svc-npAnnotations: &lt;none&gt;Selector: app=my-svc-np-podType: NodePortIP: 10.103.115.169Port: 8080-80 8080/TCPTargetPort: 80/TCPNodePort: 8080-80 32591/TCPEndpoints: 10.244.0.19:80,10.244.1.19:80,10.244.2.35:80 # å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ä¸‰ä¸ªendpointSession Affinity: NoneExternal Traffic Policy: ClusterEvents: &lt;none&gt;$ kubectl get svc my-svc-npNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEmy-svc-np NodePort 10.103.115.169 &lt;none&gt; 8080:32591/TCP 42m# 5.å¦‚ä½•è®¿é—®?# a.é›†ç¾¤å†…éƒ¨è®¿é—®pod ip$ curl -I 10.244.0.19HTTP/1.1 200 OKServer: nginx/1.15.7Date: Thu, 13 Dec 2018 08:43:25 GMTContent-Type: text/htmlContent-Length: 612Last-Modified: Tue, 27 Nov 2018 12:31:56 GMTConnection: keep-aliveETag: \"5bfd393c-264\"Accept-Ranges: bytes# b.é›†ç¾¤å†…éƒ¨clusterip+ç«¯å£$ curl -I 10.103.115.169:8080HTTP/1.1 200 OKServer: nginx/1.15.7Date: Thu, 13 Dec 2018 08:42:53 GMTContent-Type: text/htmlContent-Length: 612Last-Modified: Tue, 27 Nov 2018 12:31:56 GMTConnection: keep-aliveETag: \"5bfd393c-264\"Accept-Ranges: bytes# c.é›†ç¾¤å¤–éƒ¨è®¿é—®nodeip+é™„åŠ ç«¯å£curl -I 192.168.56.111:32591HTTP/1.1 200 OKServer: nginx/1.15.7Date: Thu, 13 Dec 2018 08:45:39 GMTContent-Type: text/htmlContent-Length: 612Last-Modified: Tue, 27 Nov 2018 12:31:56 GMTConnection: keep-aliveETag: \"5bfd393c-264\"Accept-Ranges: bytes ä»¥ä¸Šå°±æ˜¯nodeportç½‘ç»œç±»å‹çš„ç®€å•å®ç° ä¸‰ã€Create service (type: HeadlessClusterIP)æ‰€è°“çš„HeadlessClusterIP å°±æ˜¯æˆ‘ä»¬åœ¨åˆ›å»ºè¿™ç§ç½‘ç»œç±»å‹çš„æ—¶å€™å°† spec.clusterIP è®¾ç½®æˆ None,è¿™æ ·k8så°±ä¸ä¼šç»™serviceåˆ†é…clusterIpäº†ã€‚ä½†æŒ‡å®šäº†selectorï¼Œé‚£ä¹ˆendpoints controllerè¿˜æ˜¯ä¼šåˆ›å»ºEndpointsçš„ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„DNSè®°å½•ç›´æ¥æŒ‡å‘è¿™ä¸ªserviceæè¿°çš„åç«¯podã€‚å¦åˆ™ï¼Œä¸ä¼šåˆ›å»ºEndpointsè®°å½•ã€‚è¿™ç§ClusterIPï¼Œkube-proxy å¹¶ä¸å¤„ç†æ­¤ç±»æœåŠ¡ï¼Œå› ä¸ºæ²¡æœ‰load balancingæˆ– proxy ä»£ç†è®¾ç½®ï¼Œåœ¨è®¿é—®æœåŠ¡çš„æ—¶å€™å›è¿”å›åç«¯çš„å…¨éƒ¨çš„Pods IPåœ°å€ï¼Œä¸»è¦ç”¨äºå¼€å‘è€…è‡ªå·±æ ¹æ®podsè¿›è¡Œè´Ÿè½½å‡è¡¡å™¨çš„å¼€å‘(è®¾ç½®äº†selector)ã€‚ ä¸‹é¢é€šè¿‡å®è·µç†è§£ 1.é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºsvc,ç±»å‹ä¸ºheadlessCluserIP12345678910111213$ kubectl create svc clusterip my-svc-headless --clusterip=\"None\" --tcp=8080:80service/my-svc-headless created$ kubectl describe svc my-svc-headlessName: my-svc-headlessNamespace: defaultLabels: app=my-svc-headlessAnnotations: &lt;none&gt;Selector: app=my-svc-headlessType: ClusterIPIP: NoneSession Affinity: NoneEvents: &lt;none&gt; 2. åˆ›å»ºpodä¸ä¹‹å…³è”ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586$ cat nginx-deployment.yamlapiVersion: apps/v1beta1kind: Deploymentmetadata: creationTimestamp: null labels: run: nginx-deployment name: nginx-deploymentspec: replicas: 3 selector: matchLabels: app: my-svc-headless # å¯¹åº”åˆ°svc strategy: {} template: metadata: creationTimestamp: null labels: app: my-svc-headless # å¯¹åº”åˆ°svc spec: containers: - image: nginx name: nginx-deployment resources: {}status: {}$ kubectl create -f nginx-deployment.yamldeployment.apps/nginx-deployment created$ [root@k8s-m1 ~]# kubectl get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODEnginx-deployment-54bfc79477-b78c6 1/1 Running 0 40s 10.244.1.21 k8s-m2 &lt;none&gt;nginx-deployment-54bfc79477-dvp2t 1/1 Running 0 40s 10.244.0.22 k8s-m3 &lt;none&gt;nginx-deployment-54bfc79477-x6v7s 1/1 Running 0 40s 10.244.2.38 k8s-m1 &lt;none&gt;$ kubectl describe svc my-svc-headlessName: my-svc-headlessNamespace: defaultLabels: app=my-svc-headlessAnnotations: &lt;none&gt;Selector: app=my-svc-headlessType: ClusterIPIP: NonePort: 8080-80 8080/TCPTargetPort: 80/TCPEndpoints: 10.244.0.20:80,10.244.1.20:80,10.244.2.36:80Session Affinity: NoneEvents: &lt;none&gt;# ä»¥ä¸Šå¯ä»¥çœ‹å‡ºåç«¯çš„podåˆ—è¡¨å·²ç»åŠ åˆ°è¯¥svc# æˆ‘ä»¬çœ‹é€šè¿‡å†…éƒ¨åŸŸåæ˜¯å¦èƒ½å¤Ÿè§£æè®¿é—®åˆ°pod# 1.æˆ‘ä»¬å…ˆè·å–åˆ°dnsæœåŠ¡çš„IP#kubectl get svc -n kube-system | grep dnskube-dns ClusterIP 10.96.0.10 &lt;none&gt; 53/UDP,53/TCP 13d# 2.ç™»å½•åˆ°pod å†…éƒ¨è·å–dnsåŸŸ$ kubectl exec -it nginx-deployment-54bfc79477-b78c6 -- cat /etc/resolv.confnameserver 10.96.0.10search default.svc.cluster.local svc.cluster.local cluster.localoptions ndots:5# 3.æŒ‡å®šdnsæœåŠ¡å™¨å¹¶æŸ¥è¯¢è¯¥åŸŸåï¼š`nginx-deployment.default.svc.cluster.local`$ dig @10.96.0.10 my-svc-headless.default.svc.cluster.local; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-72.el7 &lt;&lt;&gt;&gt; @10.96.0.10 my-svc-headless.default.svc.cluster.local; (1 server found);; global options: +cmd;; Got answer:;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 41743;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 0;; QUESTION SECTION:;my-svc-headless.default.svc.cluster.local. IN A;; ANSWER SECTION:my-svc-headless.default.svc.cluster.local. 30 IN A 10.244.0.22my-svc-headless.default.svc.cluster.local. 30 IN A 10.244.1.21my-svc-headless.default.svc.cluster.local. 30 IN A 10.244.2.38;; Query time: 29 msec;; SERVER: 10.96.0.10#53(10.96.0.10);; WHEN: Thu Dec 13 04:37:13 EST 2018;; MSG SIZE rcvd: 107 ç”±ä¸Šå¯è§ dnsæœåŠ¡ä¸ºserviceå’Œpodç”Ÿæˆä¸åŒæ ¼å¼çš„DNSè®°å½•Service Aè®°å½•ï¼šç”Ÿæˆmy-svc.my-namespace.svc.cluster.localåŸŸåï¼Œè§£ææˆ IP åœ°å€ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š 1.æ™®é€š Serviceï¼šè§£ææˆ ClusterIP 2.Headless Serviceï¼šè§£æä¸ºæŒ‡å®š Podçš„IPåˆ—è¡¨(ä¸Šè¿°ç¤ºä¾‹å°±æ˜¯headless) SRVè®°å½•ï¼šä¸ºå‘½åçš„ç«¯å£ï¼ˆæ™®é€š Service æˆ– Headless Serviceï¼‰ç”Ÿæˆ_my-port-name._my-port-protocol.my-svc.my-namespace.svc.cluster.localçš„åŸŸå Pod Aè®°å½•ï¼šç”ŸæˆåŸŸå pod-ip.my-namespace.pod.cluster.local ä¸Šè¿°ç¤ºä¾‹ä¸ªäººç†è§£æ˜¯ è¿™ç§æ— å¤´ClusterIPç±»å‹ åœ¨å…¶é›†ç¾¤å†…éƒ¨ç›´æ¥å¯ä»¥é€šè¿‡è¯¥åŸŸåå»è®¿é—®podï¼Œå¹¶ä¸”è¯¥åŸŸåä¹Ÿèµ·åˆ°äº†é€šè¿‡dnsåšè´Ÿè½½çš„èƒ½åŠ›ã€‚ å…¶ä»–è®¿é—®æ³•æ–¹å¼å¯æŸ¥é˜…å®˜ç½‘å­¦ä¹ ,æ­¤ç¯‡åšæ–‡ä¸»è¦æ˜¯å†æ¬¡å­¦ä¹ å·©å›ºä¸€ä¸‹çŸ¥è¯†~è¯¸å¦‚ingressè¿™ç§è®¿é—®æ–¹å¼ä¹‹å‰ä¹Ÿåœ¨å­¦ä¹ å®è·µè¿‡ç¨‹ä¸­å·²ç»å®ç°è¿‡äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥æ’©æˆ‘","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/tags/kubernetes/"},{"name":"ClusterIP","slug":"ClusterIP","permalink":"https://blog.sctux.cc/tags/ClusterIP/"},{"name":"NodePort","slug":"NodePort","permalink":"https://blog.sctux.cc/tags/NodePort/"},{"name":"TargetPort","slug":"TargetPort","permalink":"https://blog.sctux.cc/tags/TargetPort/"},{"name":"Port","slug":"Port","permalink":"https://blog.sctux.cc/tags/Port/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"Kubernetesä¸­deploymentå‡çº§å›æ»š","slug":"kubernetes-deployment-rollingupdate","date":"2018-12-10T14:49:01.000Z","updated":"2025-09-01T01:59:08.885Z","comments":true,"path":"2018/12/10/kubernetes-deployment-rollingupdate/","permalink":"https://blog.sctux.cc/2018/12/10/kubernetes-deployment-rollingupdate/","excerpt":"åœ¨kubernetesä¸­ä½¿ç”¨deploymentç®¡ç†rsæ—¶ï¼Œå¯ä»¥åˆ©ç”¨deploymentæ»šåŠ¨å‡çº§çš„ç‰¹æ€§ï¼Œè¾¾åˆ°æœåŠ¡é›¶åœæ­¢å‡çº§çš„ç›®çš„ å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªdeploymen1kubectl run nginx --image=nginx å¤šå‰¯æœ¬deployment1kubectl run nginx --image=nginx --replicas=2 --record æ»šåŠ¨å‡çº§ ï¼ˆå¯ä»¥åŠ ä¸Šâ€“recordå‚æ•°å¯ä»¥è®°å½•å‘½ä»¤ï¼‰12345678kubectl set image deploy/nginx nginx=nginx:1.9.1# æ»šåŠ¨ç­–ç•¥:kubectl edit deployment nginx strategy: rollingUpdate: maxSurge: 1 # å‡çº§è¿‡ç¨‹ä¸­å¯ä»¥æ¯”é¢„è®¾çš„ pod çš„æ•°é‡å¤šå‡ºçš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼æ˜¯25% maxUnavailable: 1 # æœ€å¤šæœ‰å‡ ä¸ª pod å¤„äºæ— æ³•å·¥ä½œçš„çŠ¶æ€ï¼Œé»˜è®¤å€¼æ˜¯25% æ»šåŠ¨å‡çº§çŠ¶æ€æŸ¥çœ‹1kubectl rollout status deploy/nginx æŸ¥çœ‹å‡çº§å†å²","text":"åœ¨kubernetesä¸­ä½¿ç”¨deploymentç®¡ç†rsæ—¶ï¼Œå¯ä»¥åˆ©ç”¨deploymentæ»šåŠ¨å‡çº§çš„ç‰¹æ€§ï¼Œè¾¾åˆ°æœåŠ¡é›¶åœæ­¢å‡çº§çš„ç›®çš„ å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªdeploymen1kubectl run nginx --image=nginx å¤šå‰¯æœ¬deployment1kubectl run nginx --image=nginx --replicas=2 --record æ»šåŠ¨å‡çº§ ï¼ˆå¯ä»¥åŠ ä¸Šâ€“recordå‚æ•°å¯ä»¥è®°å½•å‘½ä»¤ï¼‰12345678kubectl set image deploy/nginx nginx=nginx:1.9.1# æ»šåŠ¨ç­–ç•¥:kubectl edit deployment nginx strategy: rollingUpdate: maxSurge: 1 # å‡çº§è¿‡ç¨‹ä¸­å¯ä»¥æ¯”é¢„è®¾çš„ pod çš„æ•°é‡å¤šå‡ºçš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼æ˜¯25% maxUnavailable: 1 # æœ€å¤šæœ‰å‡ ä¸ª pod å¤„äºæ— æ³•å·¥ä½œçš„çŠ¶æ€ï¼Œé»˜è®¤å€¼æ˜¯25% æ»šåŠ¨å‡çº§çŠ¶æ€æŸ¥çœ‹1kubectl rollout status deploy/nginx æŸ¥çœ‹å‡çº§å†å²123kubectl rollout history deploy/nginx# æŸ¥çœ‹å•ä¸ªrevision çš„è¯¦ç»†ä¿¡æ¯ï¼škubectl rollout history deploy/nginx --revision=2 èµ„æºè°ƒæ•´:123456789101112131415161718192021222324252627kubectl set resources deploy/nginx -c=nginx --limits=cpu=100m,memory=200m# æ­¤æ—¶åœ¨æŸ¥çœ‹å†å²çŠ¶æ€:$ kubectl rollout history deploy/nginxdeployments \"nginx\"REVISION CHANGE-CAUSE1 &lt;none&gt;2 &lt;none&gt;3 &lt;none&gt;# æŸ¥çœ‹revision 3 çš„å†…å®¹,å¯ä»¥çœ‹å‡ºåˆšæ‰è°ƒæ•´äº†podçš„èµ„æºè®°å½•äº†åˆ°äº†å‡çº§å†å²å½“ä¸­$ kubectl rollout history deploy/nginx --revision=3eployments \"nginx\" with revision #3Pod Template: Labels: pod-template-hash=440294079 run=nginx Containers: nginx: Image: nginx:1.9.1 Port: &lt;none&gt; Limits: cpu: 100m memory: 200m Environment: &lt;none&gt; Mounts: &lt;none&gt; Volumes: &lt;none&gt; å›æ»šæ“ä½œ:123# å›æ»šåˆ°ç¬¬äºŒä¸ªç‰ˆæœ¬å»$ kubectl rollout undo deploy nginx --to-revision=2deployment \"nginx\" åº”ç”¨å¼¹æ€§ä¼¸ç¼©:12$ kubectl scale deploy nginx --replicas=10deployment \"nginx\" scaled å¦‚æœé›†ç¾¤ä¸­å¯¹æ¥äº†heapsterï¼Œå’ŒHPAè”åŠ¨åï¼Œå¯ä»¥é€šè¿‡autoscaleè‡ªåŠ¨å¼¹æ€§ä¼¸ç¼© 1$ kubectl autoscale deployment nginx --min=10 --max=15 --cpu-percent=80 æš‚åœå’Œæ¢å¤Deploymentæ‚¨å¯ä»¥åœ¨å‘å‡ºä¸€æ¬¡æˆ–å¤šæ¬¡æ›´æ–°å‰æš‚åœä¸€ä¸ª Deploymentï¼Œç„¶åå†æ¢å¤å®ƒã€‚è¿™æ ·æ‚¨å°±èƒ½å¤šæ¬¡æš‚åœå’Œæ¢å¤ Deploymentï¼Œåœ¨æ­¤æœŸé—´è¿›è¡Œä¸€äº›æ›´æ–°ï¼Œä¿®å¤å·¥ä½œï¼Œè€Œä¸ä¼šå‘å‡ºä¸å¿…è¦çš„ rolloutã€‚ ä¾‹å¦‚ä½¿ç”¨åˆšåˆšåˆ›å»º Deploymentï¼š 1234$ kubectl get deploy nginxNAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGEnginx 3 3 3 3 27s ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æš‚åœ Deploymentï¼š 12$ kubectl rollout pause deployment/nginxdeployment \"nginx\" paused ç„¶åæ›´æ–° Deplymentä¸­çš„é•œåƒï¼š 123$ kubectl set image deploy/nginx nginx=nginx:1.9.1deployment \"nginx-deployment\" image updated æ‚¨å¯ä»¥è¿›è¡Œä»»æ„å¤šæ¬¡æ›´æ–°ï¼Œä¾‹å¦‚æ›´æ–°ä½¿ç”¨çš„èµ„æºï¼š 123$ kubectl set resources deployment nginx -c=nginx --limits=cpu=200m,memory=256Mideployment \"nginx\" resource requirements updated Deployment æš‚åœå‰çš„åˆå§‹çŠ¶æ€å°†ç»§ç»­å®ƒçš„åŠŸèƒ½ï¼Œè€Œä¸ä¼šå¯¹ Deployment çš„æ›´æ–°äº§ç”Ÿä»»ä½•å½±å“ï¼Œåªè¦ Deploymentæ˜¯æš‚åœçš„ã€‚é‚£ä¹ˆæ–°çš„æ›´æ–°æˆ–è€…æ”¹åŠ¨çš„ç»“æœå°†æ˜¯åœ¨æš‚åœæœŸé—´æ‰€æœ‰åšçš„æ“ä½œéƒ½æ˜¯é¡ºåºç”Ÿæ•ˆå–ç›¸åŒæ“ä½œçš„æœ€åä¸€æ­¥ï¼Œæ¯”å¦‚,æš‚åœåæˆ‘åšäº†ä»¥ä¸‹æ“ä½œ:1.æ›´æ–°äº†ç‰ˆæœ¬: 1.9.12.æ›´æ–°äº†èµ„æº: memory=222Mi3.åˆæ›´æ–°äº†ç‰ˆæœ¬: 1.9.34.åˆè°ƒæ•´äº†èµ„æº: memory=211Mi æœ€åï¼Œæ¢å¤è¿™ä¸ª Deploymentï¼Œè§‚å¯Ÿå®Œæˆæ›´æ–°çš„ ReplicaSet å·²ç»åˆ›å»ºå‡ºæ¥äº†ï¼š æ³¨æ„ï¼š åœ¨æ¢å¤ Deployment ä¹‹å‰æ‚¨æ— æ³•å›é€€ä¸€ä¸ªå·²ç»æš‚åœçš„ Deploymentã€‚","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}],"tags":[{"name":"deployment","slug":"deployment","permalink":"https://blog.sctux.cc/tags/deployment/"},{"name":"rolling","slug":"rolling","permalink":"https://blog.sctux.cc/tags/rolling/"},{"name":"update","slug":"update","permalink":"https://blog.sctux.cc/tags/update/"},{"name":"pausing","slug":"pausing","permalink":"https://blog.sctux.cc/tags/pausing/"},{"name":"resuming","slug":"resuming","permalink":"https://blog.sctux.cc/tags/resuming/"}],"keywords":[{"name":"kubernetes","slug":"kubernetes","permalink":"https://blog.sctux.cc/categories/kubernetes/"}]},{"title":"K8s Yamlç¼–å†™å°æŠ€å·§","slug":"k8s-yaml-bian-xie-xiao-ji-qiao","date":"2018-12-09T15:31:58.000Z","updated":"2025-09-01T01:59:08.973Z","comments":true,"path":"2018/12/09/k8s-yaml-bian-xie-xiao-ji-qiao/","permalink":"https://blog.sctux.cc/2018/12/09/k8s-yaml-bian-xie-xiao-ji-qiao/","excerpt":"","text":"å­¦ä¹ ä½¿ç”¨k8sçš„ç«¥é‹éƒ½çŸ¥é“æˆ‘ä»¬åœ¨éƒ¨ç½²podçš„æ—¶å€™æœ‰æ—¶å€™éœ€è¦æ‰‹åŠ¨å»ç¼–å†™ä¸€äº›yamlæ–‡ä»¶ï¼›æ¯”å¦‚æˆ‘éœ€è¦ç¼–å†™deployment,é‚£é™¤äº†åœ¨å…¶ä»–åœ°æ–¹ç²˜è´´æ‹·è´å¤–æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ 1.ç”¨runå‘½ä»¤ç”Ÿæˆï¼Œç„¶åä½œä¸ºæ¨¡æ¿è¿›è¡Œç¼–è¾‘ã€‚12345678910kubectl run --image=nginx my-deploy -o yaml --dry-run &gt; my-deploy.yaml ``` ### 2.ç”¨getå‘½ä»¤å¯¼å‡ºï¼Œç„¶åä½œä¸ºæ¨¡æ¿è¿›è¡Œç¼–è¾‘ã€‚``` # æ³¨æ„: --export æ˜¯ä¸ºäº†å»é™¤å½“å‰æ­£åœ¨è¿è¡Œçš„è¿™ä¸ªdeploymentç”Ÿæˆçš„ä¸€äº›çŠ¶æ€ï¼Œæˆ‘ä»¬ç”¨ä¸åˆ°å°±è¿‡æ»¤æ‰kubectl get deployment/nginx -o=yaml --export &gt; new.yaml``` ### 3.Podäº²å’Œæ€§ä¸‹é¢å­—æ®µçš„æ‹¼å†™å¿˜è®°äº† kubectl explain pod.spec.affinity.podAffinity ç¤ºä¾‹: --- æˆ‘æƒ³ç”Ÿæˆä¸€ä¸ªæœ‰ä¸‰ä¸ªå‰¯æœ¬çš„redis podçš„yamlï¼Œç„¶åæˆ‘æƒ³æŠŠè¿™ä¸‰ä¸ªpod é€šè¿‡nodeäº²å’Œæ€§è°ƒåº¦åˆ°åŒä¸€ä¸ªnodeèŠ‚ç‚¹ä¸Šé¢ï¼› ### 1\\. æˆ‘è¿™é‡Œç”¨kubectl runæ¥ç”Ÿæˆ: kubectl run redis --image=redis --replicas=3 --dry-run -o yaml &gt; redis_node_affinity.yaml ### 2\\. æ‰‹å†™äº²å’Œæ€§ç­–ç•¥ï¼š é¢ é—®é¢˜æ¥äº†äº²å’Œæ€§ç­–ç•¥çš„å­—æ®µæˆ‘è®°ä¸ä½å•Šï¼Œæ€ä¹ˆåŠï¼Ÿé‚£å°±éœ€è¦é€šè¿‡ `kubectl explain RESOURCE [options]`æ¥è·å–èµ„æºæ–‡æ¡£ æ€ä¹ˆç”¨? æ¯”å¦‚æˆ‘è¿™é‡Œæ˜¯è¦ä¸ºpodåšnodeçš„äº²å’Œæ€§ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯è¿™ä¸ªapiæ¥å£ä¸‹é¢çš„é…ç½®æ–‡æ¡£:æƒ³çœ‹podçš„èµ„æºæ–‡æ¡£: [root@k8s-m1 ~]# kubectl explain pod.spec.affinity KIND: Pod VERSION: v1 RESOURCE: affinity &lt;Object&gt; DESCRIPTION: If specified, the pod's scheduling constraints Affinity is a group of affinity scheduling rules. FIELDS: nodeAffinity &lt;Object&gt; Describes node affinity scheduling rules for the pod. podAffinity &lt;Object&gt; Describes pod affinity scheduling rules (e.g. co-locate this pod in the same node, zone, etc. as some other pod(s)). podAntiAffinity &lt;Object&gt; Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod in the same node, zone, etc. as some other pod(s)). [root@k8s-m1 ~]# ä¸Šé¢æˆ‘ä»¬é€šè¿‡ `pod.spec.affinity` å®šä½åˆ°äº†`nodeAffinity` æ–‡æ¡£, è¿™äº›å­—æ®µä¹Ÿæ˜¯yamlç§ä½¿ç”¨çš„å­—æ®µï¼Œéšåæˆ‘é€šè¿‡ä¸€å±‚ä¸€å±‚çš„å®šä½å°±å¤§ä½“ä¸ŠçŸ¥é“è¿™äº›å­—æ®µåœ¨yamlä¸­æ˜¯æ€ä¹ˆä½¿ç”¨çš„å•¦~ [root@k8s-m1 ~]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms.matchExpressions æœ€åå¿«é€Ÿç”Ÿæˆå¹¶ä¸”ç¼–è¾‘çš„deployment yamlå°±å†™å¥½äº†ã€‚ apiVersion: apps/v1beta1 kind: Deployment metadata: creationTimestamp: null labels: run: redis name: redis spec: replicas: 3 selector: matchLabels: run: redis strategy: {} template: metadata: creationTimestamp: null labels: run: redis spec: containers: - image: redis name: redis resources: {} # ä»¥ä¸‹å†…å®¹å°±æ˜¯æˆ‘é€šè¿‡explainå‚æ•°æ¥æŸ¥è¯¢åˆ°çš„æˆ‘æƒ³è¦çš„å­—æ®µå†™çš„ affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - k8s-m1 status: {} ![](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/12/15443718852925.jpg)ï¿¼ è¿˜æ˜¯éå¸¸å¿«é€Ÿé«˜æ•ˆçš„ã€‚","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/tags/k8s/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"K8sé›†ç¾¤ä¸­pauseå®¹å™¨æ˜¯å¹²å˜›çš„~","slug":"k8s-ji-qun-zhongpause-rong-qi-shi-gan-ma-de","date":"2018-12-07T08:01:08.000Z","updated":"2025-09-01T01:59:08.981Z","comments":true,"path":"2018/12/07/k8s-ji-qun-zhongpause-rong-qi-shi-gan-ma-de/","permalink":"https://blog.sctux.cc/2018/12/07/k8s-ji-qun-zhongpause-rong-qi-shi-gan-ma-de/","excerpt":"å½“æˆ‘ä»¬åœ¨æ£€æŸ¥k8sé›†ç¾¤çŠ¶æ€çš„æ—¶å€™ä¼šå‘ç°æœ‰å¾ˆå¤š pause å®¹å™¨è¿è¡ŒäºæœåŠ¡å™¨ä¸Šé¢ï¼Œç„¶åæ¯æ¬¡å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œéƒ½ä¼šä¼´éšä¸€ä¸ªpauseå®¹å™¨çš„å¯åŠ¨ã€‚é‚£å®ƒç©¶ç«Ÿæ˜¯å¹²å•¥å­çš„ï¼Ÿ Pauseå®¹å™¨ï¼Œåˆå«Infraå®¹å™¨ï¼Œä¸‹é¢é€šè¿‡å®éªŒæ¥ç†è§£å®ƒã€‚ æˆ‘ä»¬çŸ¥é“åœ¨æ­å»ºk8sé›†ç¾¤çš„æ—¶å€™ï¼Œkubeletçš„é…ç½®ä¸­æœ‰è¿™æ ·ä¸€ä¸ªå‚æ•°ï¼š [root@linux-node1 cfg]# more /usr/lib/systemd/system/kubelet.service Â·Â·Â·Â·Â·Â· Â·Â·Â·Â·Â·Â· --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1 \\ Â·Â·Â·Â·Â·Â· Â·Â·Â·Â·Â·Â· æˆ‘è¿™é‡Œæ˜¯ç›´æ¥å°†è¿™äº›é…ç½®å‚æ•°é€šè¿‡å¯åŠ¨è„šæœ¬æ¥è¡¥å……è¿›å»çš„ã€‚Pauseå®¹å™¨ï¼Œæ˜¯å¯ä»¥è‡ªå·±æ¥å®šä¹‰ï¼Œå®˜æ–¹ä½¿ç”¨çš„gcr.io/google_containers/pause-amd64:3.0å®¹å™¨çš„ä»£ç è§Githubï¼Œä½¿ç”¨Cè¯­è¨€ç¼–å†™ã€‚ Pauseå®¹å™¨çš„ä½œç”¨æˆ‘ä»¬æ£€æŸ¥nodèŠ‚ç‚¹çš„æ—¶å€™ä¼šå‘ç°æ¯ä¸ªnodeä¸Šéƒ½è¿è¡Œäº†å¾ˆå¤šçš„pauseå®¹å™¨ï¼Œä¾‹å¦‚å¦‚ä¸‹ã€‚ [root@linux-node1 cfg]# docker ps Â·Â·Â·Â·Â·Â· Â·Â·Â·Â·Â·Â· CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES a007c18b8dc0 568c4670fa80 \"nginx -g 'daemon ofâ€¦\" 42 hours ago Up 42 hours k8s_nginx_nginx-pod-7d9f9876cc-75sf7_default_a688bb46-f872-11e8-ae6b-000c29c6d12b_1 9866c08d1f4b 568c4670fa80 \"nginx -g 'daemon ofâ€¦\" 42 hours ago Up 42 hours k8s_nginx_nginx-pod-7d9f9876cc-wpv4h_default_a6a899c0-f872-11e8-ae6b-000c29c6d12b_1 aafef6727026 mirrorgooglecontainers/pause-amd64:3.0 \"/pause\" 42 hours ago Up 42 hours k8s_POD_flask-app-6f5b6cc447-kbxks_flask-app-extions-stage_374b8aa0-f873-11e8-ae6b-000c29c6d12b_1 c4f48f90b27f mirrorgooglecontainers/pause-amd64:3.0 \"/pause\" 42 hours ago Up 42 hours k8s_POD_flask-app-6f5b6cc447-f9wjn_flask-app-extions-stage_373be9db-f873-11e8-ae6b-000c29c6d12b_1 9f452e6961f6 mirrorgooglecontainers/pause-amd64:3.0 \"/pause\" 42 hours ago Up 42 hours k8s_POD_nginx-pod-7d9f9876cc-ccx94_default_a6a8c440-f872-11e8-ae6b-000c29c6d12b_1 7e68043469d1 mirrorgooglecontainers/pause-amd64:3.0 \"/pause\" 42 hours ago Up 42 hours k8s_POD_nginx-pod-7d9f9876cc-sskpk_default_a6ac43bd-f872-11e8-ae6b-000c29c6d12b_1 Â·Â·Â·Â·Â·Â· Â·Â·Â·Â·Â·Â· kubernetesä¸­çš„pauseå®¹å™¨ä¸»è¦ä¸ºæ¯ä¸ªä¸šåŠ¡å®¹å™¨æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š åœ¨podä¸­æ‹…ä»»Linuxå‘½åç©ºé—´å…±äº«çš„åŸºç¡€ï¼› å¯ç”¨pidå‘½åç©ºé—´ï¼Œå¼€å¯initè¿›ç¨‹ã€‚","text":"å½“æˆ‘ä»¬åœ¨æ£€æŸ¥k8sé›†ç¾¤çŠ¶æ€çš„æ—¶å€™ä¼šå‘ç°æœ‰å¾ˆå¤š pause å®¹å™¨è¿è¡ŒäºæœåŠ¡å™¨ä¸Šé¢ï¼Œç„¶åæ¯æ¬¡å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œéƒ½ä¼šä¼´éšä¸€ä¸ªpauseå®¹å™¨çš„å¯åŠ¨ã€‚é‚£å®ƒç©¶ç«Ÿæ˜¯å¹²å•¥å­çš„ï¼Ÿ Pauseå®¹å™¨ï¼Œåˆå«Infraå®¹å™¨ï¼Œä¸‹é¢é€šè¿‡å®éªŒæ¥ç†è§£å®ƒã€‚ æˆ‘ä»¬çŸ¥é“åœ¨æ­å»ºk8sé›†ç¾¤çš„æ—¶å€™ï¼Œkubeletçš„é…ç½®ä¸­æœ‰è¿™æ ·ä¸€ä¸ªå‚æ•°ï¼š [root@linux-node1 cfg]# more /usr/lib/systemd/system/kubelet.service Â·Â·Â·Â·Â·Â· Â·Â·Â·Â·Â·Â· --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1 \\ Â·Â·Â·Â·Â·Â· Â·Â·Â·Â·Â·Â· æˆ‘è¿™é‡Œæ˜¯ç›´æ¥å°†è¿™äº›é…ç½®å‚æ•°é€šè¿‡å¯åŠ¨è„šæœ¬æ¥è¡¥å……è¿›å»çš„ã€‚Pauseå®¹å™¨ï¼Œæ˜¯å¯ä»¥è‡ªå·±æ¥å®šä¹‰ï¼Œå®˜æ–¹ä½¿ç”¨çš„gcr.io/google_containers/pause-amd64:3.0å®¹å™¨çš„ä»£ç è§Githubï¼Œä½¿ç”¨Cè¯­è¨€ç¼–å†™ã€‚ Pauseå®¹å™¨çš„ä½œç”¨æˆ‘ä»¬æ£€æŸ¥nodèŠ‚ç‚¹çš„æ—¶å€™ä¼šå‘ç°æ¯ä¸ªnodeä¸Šéƒ½è¿è¡Œäº†å¾ˆå¤šçš„pauseå®¹å™¨ï¼Œä¾‹å¦‚å¦‚ä¸‹ã€‚ [root@linux-node1 cfg]# docker ps Â·Â·Â·Â·Â·Â· Â·Â·Â·Â·Â·Â· CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES a007c18b8dc0 568c4670fa80 \"nginx -g 'daemon ofâ€¦\" 42 hours ago Up 42 hours k8s_nginx_nginx-pod-7d9f9876cc-75sf7_default_a688bb46-f872-11e8-ae6b-000c29c6d12b_1 9866c08d1f4b 568c4670fa80 \"nginx -g 'daemon ofâ€¦\" 42 hours ago Up 42 hours k8s_nginx_nginx-pod-7d9f9876cc-wpv4h_default_a6a899c0-f872-11e8-ae6b-000c29c6d12b_1 aafef6727026 mirrorgooglecontainers/pause-amd64:3.0 \"/pause\" 42 hours ago Up 42 hours k8s_POD_flask-app-6f5b6cc447-kbxks_flask-app-extions-stage_374b8aa0-f873-11e8-ae6b-000c29c6d12b_1 c4f48f90b27f mirrorgooglecontainers/pause-amd64:3.0 \"/pause\" 42 hours ago Up 42 hours k8s_POD_flask-app-6f5b6cc447-f9wjn_flask-app-extions-stage_373be9db-f873-11e8-ae6b-000c29c6d12b_1 9f452e6961f6 mirrorgooglecontainers/pause-amd64:3.0 \"/pause\" 42 hours ago Up 42 hours k8s_POD_nginx-pod-7d9f9876cc-ccx94_default_a6a8c440-f872-11e8-ae6b-000c29c6d12b_1 7e68043469d1 mirrorgooglecontainers/pause-amd64:3.0 \"/pause\" 42 hours ago Up 42 hours k8s_POD_nginx-pod-7d9f9876cc-sskpk_default_a6ac43bd-f872-11e8-ae6b-000c29c6d12b_1 Â·Â·Â·Â·Â·Â· Â·Â·Â·Â·Â·Â· kubernetesä¸­çš„pauseå®¹å™¨ä¸»è¦ä¸ºæ¯ä¸ªä¸šåŠ¡å®¹å™¨æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š åœ¨podä¸­æ‹…ä»»Linuxå‘½åç©ºé—´å…±äº«çš„åŸºç¡€ï¼› å¯ç”¨pidå‘½åç©ºé—´ï¼Œå¼€å¯initè¿›ç¨‹ã€‚ åœ¨The Almighty Pause Containerè¿™ç¯‡æ–‡ç« ä¸­åšå‡ºäº†è¯¦ç»†çš„è¯´æ˜ï¼Œpauseå®¹å™¨çš„ä½œç”¨å¯ä»¥ä»è¿™ä¸ªä¾‹å­ä¸­çœ‹å‡ºï¼Œé¦–å…ˆè§ä¸‹å›¾ï¼šï¿¼ 1.æˆ‘ä»¬é¦–å…ˆåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªpauseå®¹å™¨ã€‚[root@k8s-node1 ~]# docker run -d --name pause -p 8880:80 registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1 38d2aa8366d5aa6fe4c57aa0d879de4b5259c67c83d17428dd4d9f8937205c02 [root@k8s-node1 ~]# docker ps | grep pause 38d2aa8366d5 registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1 \"/pause\" 14 seconds ago Up 13 seconds 0.0.0.0:8880-&gt;80/tcp pause 2.ç„¶åå†è¿è¡Œä¸€ä¸ªnginxå®¹å™¨ï¼Œnginxå°†ä¸ºlocalhost:2368åˆ›å»ºä¸€ä¸ªä»£ç†ã€‚[root@k8s-node1 ~]# cat &lt;&lt;EOF &gt;&gt; nginx.conf error_log stderr; events { worker_connections 1024; } http { access_log /dev/stdout combined; server { listen 80 default_server; server_name example.com www.example.com; location / { proxy_pass http://127.0.0.1:2368; } } } EOF [root@k8s-node1 ~]# docker run -d --name nginx -v `pwd`/nginx.conf:/etc/nginx/nginx.conf --net=container:pause --ipc=container:pause --pid=container:pause nginx fa078473c01e040db795004ad16db525dea8a113893d3052cc6ab1c5e117ba10 3.ç„¶åå†ä¸ºghoståˆ›å»ºä¸€ä¸ªåº”ç”¨å®¹å™¨ï¼Œè¿™æ˜¯ä¸€æ¬¾åšå®¢è½¯ä»¶ã€‚[root@linux-node2 ~]# docker run -d --name ghost --net=container:pause --ipc=container:pause --pid=container:pause ghost # æŸ¥çœ‹ç»“æœï¼š [root@k8s-node1 ~]# docker ps | grep -E \"pause|nginx|ghost\" 9b796efd95a5 ghost \"docker-entrypoint...\" 47 seconds ago Up 46 seconds ghost fa078473c01e nginx \"nginx -g 'daemon ...\" About a minute ago Up About a minute nginx 38d2aa8366d5 registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1 \"/pause\" 3 minutes ago Up 3 minutes 0.0.0.0:8880-&gt;80/tcp pause [root@k8s-node1 ~]# # ç°åœ¨è®¿é—®http://119.3.198.128:8880/å°±å¯ä»¥çœ‹åˆ°ghoståšå®¢çš„ç•Œé¢äº†å— # è¿™é‡Œæˆ‘ç›´æ¥curl ç„¶åæµè§ˆå™¨è®¿é—®ä¹Ÿæ˜¯æ­£å¸¸çš„ [root@k8s-node1 ~]# curl -I http://119.3.198.128:8880/ HTTP/1.1 200 OK Server: nginx/1.15.5 Date: Fri, 07 Dec 2018 08:35:49 GMT Content-Type: text/html; charset=utf-8 Content-Length: 17381 Connection: keep-alive X-Powered-By: Express Cache-Control: public, max-age=0 ETag: W/\"43e5-ELHSnbaoapp3YOyz+PU502oJo5E\" Vary: Accept-Encoding [root@k8s-node1 ~]# è§£æ: pause å®¹å™¨å°†å†…éƒ¨çš„80ç«¯å£æ˜ å°„åˆ°äº†å®¿ä¸»æœºçš„8880ç«¯å£; pauseå®¹å™¨åœ¨å®¿ä¸»æœºä¸Šè®¾ç½®å¥½äº†ç½‘ç»œnamespaceåï¼Œnginxå®¹å™¨åŠ å…¥åˆ°è¯¥ç½‘ç»œnamespaceä¸­; nginxå®¹å™¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®šäº†â€“net=container:pause; ghostå®¹å™¨å¯åŠ¨çš„æ—¶å€™åŒæ ·åŠ å…¥åˆ°äº†è¯¥ç½‘ç»œnamespaceä¸­; è¿™æ ·ä¸‰ä¸ªå®¹å™¨å°±å…±äº«äº†ç½‘ç»œï¼Œäº’ç›¸ä¹‹é—´å°±å¯ä»¥ä½¿ç”¨localhostç›´æ¥é€šä¿¡ï¼Œ â€“ipc=contianer:pause â€“pid=container:pauseå°±æ˜¯ä¸‰ä¸ªå®¹å™¨å¤„äºåŒä¸€ä¸ªnamespaceä¸­ï¼Œinitè¿›ç¨‹ä¸ºpause; æˆ‘ä»¬åˆ°ghostå®¹å™¨ä¸­æŸ¥çœ‹ä¸€ä¸‹: [root@k8s-node1 ~]# docker exec -it ghost /bin/bash root@38d2aa8366d5:/var/lib/ghost# ps aux USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 1 0.0 0.0 1012 4 ? Ss 08:27 0:00 /pause root 5 0.0 0.0 32472 3168 ? Ss 08:29 0:00 nginx: master process nginx -g daemon off; systemd+ 9 0.0 0.0 32932 1812 ? S 08:29 0:00 nginx: worker process node 10 0.5 2.1 1262748 84688 ? Ssl 08:30 0:03 node current/index.js root 83 0.2 0.0 20240 1912 pts/0 Ss 08:41 0:00 /bin/bash root 87 0.0 0.0 17496 1148 pts/0 R+ 08:41 0:00 ps aux root@38d2aa8366d5:/var/lib/ghost# åœ¨ghostå®¹å™¨ä¸­åŒæ—¶å¯ä»¥çœ‹åˆ°pauseå’Œnginxå®¹å™¨çš„è¿›ç¨‹ï¼Œå¹¶ä¸”pauseå®¹å™¨çš„PIDæ˜¯1ã€‚è€Œåœ¨kubernetesä¸­å®¹å™¨çš„PID=1çš„è¿›ç¨‹å³ä¸ºå®¹å™¨æœ¬èº«çš„ä¸šåŠ¡è¿›ç¨‹ã€‚ å…¶ä»–æ¦‚å¿µï¼š PIDå‘½åç©ºé—´ï¼šPodä¸­çš„ä¸åŒåº”ç”¨ç¨‹åºå¯ä»¥çœ‹åˆ°å…¶ä»–åº”ç”¨ç¨‹åºçš„è¿›ç¨‹IDï¼› ç½‘ç»œå‘½åç©ºé—´ï¼šPodä¸­çš„å¤šä¸ªå®¹å™¨èƒ½å¤Ÿè®¿é—®åŒä¸€ä¸ªIPå’Œç«¯å£èŒƒå›´ï¼› IPCå‘½åç©ºé—´ï¼šPodä¸­çš„å¤šä¸ªå®¹å™¨èƒ½å¤Ÿä½¿ç”¨SystemV IPCæˆ–POSIXæ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œé€šä¿¡ï¼› UTSå‘½åç©ºé—´ï¼šPodä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªä¸»æœºåï¼›Volumesï¼ˆå…±äº«å­˜å‚¨å·ï¼‰ï¼š Podä¸­çš„å„ä¸ªå®¹å™¨å¯ä»¥è®¿é—®åœ¨Podçº§åˆ«å®šä¹‰çš„Volumesï¼›","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/tags/k8s/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"ç†è§£Kubernetesçš„äº²å’Œæ€§è°ƒåº¦","slug":"li-jiekubernetes-de-qin-he-xing-diao-du","date":"2018-12-04T15:53:16.000Z","updated":"2025-09-01T01:59:08.920Z","comments":true,"path":"2018/12/04/li-jiekubernetes-de-qin-he-xing-diao-du/","permalink":"https://blog.sctux.cc/2018/12/04/li-jiekubernetes-de-qin-he-xing-diao-du/","excerpt":"NodeNameã€nodeSelectorã€nodeAffinityã€podAffinityã€Taintsä»¥åŠTolerationsç”¨æ³• 1. NodeNamePod.spec.nodeNameç”¨äºå¼ºåˆ¶çº¦æŸå°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Šï¼Œè¿™é‡Œè¯´æ˜¯â€œè°ƒåº¦â€ï¼Œä½†å…¶å®æŒ‡å®šäº†nodeNameçš„Podä¼šç›´æ¥è·³è¿‡Schedulerçš„è°ƒåº¦é€»è¾‘ï¼Œç›´æ¥å†™å…¥PodListåˆ—è¡¨ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯å¼ºåˆ¶åŒ¹é…ã€‚ä¾‹å­ï¼šæˆ‘çš„é¢„æœŸæ˜¯å°†è¯¥podè¿è¡ŒäºèŠ‚ç‚¹åç§°ä¸º 192.168.56.11 è¿™ä¸ªèŠ‚ç‚¹ï¼š 1.1 ä¾‹å¦‚(test-nodename.yaml)apiVersion: v1 kind: Pod metadata: labels: app: with-nodename-busybox-pod name: with-nodename spec: nodeName: 192.168.56.11 #é€šè¿‡è¿™é‡ŒæŒ‡å®š containers: - command: - sleep - \"3600\" image: busybox imagePullPolicy: IfNotPresent name: test-busybox 1.2 æŸ¥çœ‹åˆ›å»ºäº‹ä»¶ã€ä¸é¢„æœŸç›¸ç¬¦:Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 3m default-scheduler Successfully assigned with-pod-affinity to 192.168.56.11 Normal SuccessfulMountVolume 3m kubelet, 192.168.56.11 MountVolume.SetUp succeeded for volume \"default-token-5htws\" Normal Pulling 3m kubelet, 192.168.56.11 pulling image \"nginx\" Normal Pulled 1m kubelet, 192.168.56.11 Successfully pulled image \"nginx\" Normal Created 1m kubelet, 192.168.56.11 Created container Normal Started 1m kubelet, 192.168.56.11 Started container 2. NodeSelectorPod.spec.nodeSelectoræ˜¯é€šè¿‡kubernetesçš„label-selectoræœºåˆ¶è¿›è¡ŒèŠ‚ç‚¹é€‰æ‹©ï¼Œç”±schedulerè°ƒåº¦ç­–ç•¥MatchNodeSelectorè¿›è¡ŒlabelåŒ¹é…ï¼Œè°ƒåº¦podåˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯å¼ºåˆ¶çº¦æŸã€‚ä½¿ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨çš„æ­¥éª¤ä¸ºï¼š 2.1 Nodeæ·»åŠ labelæ ‡è®°,æ ‡è®°è§„åˆ™ï¼š","text":"NodeNameã€nodeSelectorã€nodeAffinityã€podAffinityã€Taintsä»¥åŠTolerationsç”¨æ³• 1. NodeNamePod.spec.nodeNameç”¨äºå¼ºåˆ¶çº¦æŸå°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Šï¼Œè¿™é‡Œè¯´æ˜¯â€œè°ƒåº¦â€ï¼Œä½†å…¶å®æŒ‡å®šäº†nodeNameçš„Podä¼šç›´æ¥è·³è¿‡Schedulerçš„è°ƒåº¦é€»è¾‘ï¼Œç›´æ¥å†™å…¥PodListåˆ—è¡¨ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯å¼ºåˆ¶åŒ¹é…ã€‚ä¾‹å­ï¼šæˆ‘çš„é¢„æœŸæ˜¯å°†è¯¥podè¿è¡ŒäºèŠ‚ç‚¹åç§°ä¸º 192.168.56.11 è¿™ä¸ªèŠ‚ç‚¹ï¼š 1.1 ä¾‹å¦‚(test-nodename.yaml)apiVersion: v1 kind: Pod metadata: labels: app: with-nodename-busybox-pod name: with-nodename spec: nodeName: 192.168.56.11 #é€šè¿‡è¿™é‡ŒæŒ‡å®š containers: - command: - sleep - \"3600\" image: busybox imagePullPolicy: IfNotPresent name: test-busybox 1.2 æŸ¥çœ‹åˆ›å»ºäº‹ä»¶ã€ä¸é¢„æœŸç›¸ç¬¦:Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 3m default-scheduler Successfully assigned with-pod-affinity to 192.168.56.11 Normal SuccessfulMountVolume 3m kubelet, 192.168.56.11 MountVolume.SetUp succeeded for volume \"default-token-5htws\" Normal Pulling 3m kubelet, 192.168.56.11 pulling image \"nginx\" Normal Pulled 1m kubelet, 192.168.56.11 Successfully pulled image \"nginx\" Normal Created 1m kubelet, 192.168.56.11 Created container Normal Started 1m kubelet, 192.168.56.11 Started container 2. NodeSelectorPod.spec.nodeSelectoræ˜¯é€šè¿‡kubernetesçš„label-selectoræœºåˆ¶è¿›è¡ŒèŠ‚ç‚¹é€‰æ‹©ï¼Œç”±schedulerè°ƒåº¦ç­–ç•¥MatchNodeSelectorè¿›è¡ŒlabelåŒ¹é…ï¼Œè°ƒåº¦podåˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯å¼ºåˆ¶çº¦æŸã€‚ä½¿ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨çš„æ­¥éª¤ä¸ºï¼š 2.1 Nodeæ·»åŠ labelæ ‡è®°,æ ‡è®°è§„åˆ™ï¼škubectl label nodes &lt;node-name&gt; &lt;label-key&gt;=&lt;label-value&gt; kubectl label nodes 192.168.56.14 server_type=game_server 2.2 ç¡®è®¤æ ‡è®°[root@linux-node1 ~]# kubectl get nodes 192.168.56.14 --show-labels NAME STATUS ROLES AGE VERSION LABELS 192.168.56.14 Ready node 82d v1.10.1 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=192.168.56.14,node-role.kubernetes.io/node=true,server_type=game_server 2.3 ä¾‹å¦‚(test-nodeselector.yaml)apiVersion: v1 kind: Pod metadata: labels: app: with-nodeselector-busybox-pod name: with-node-selector spec: containers: - command: - sleep - \"3600\" image: busybox imagePullPolicy: IfNotPresent name: test-busybox # é€šè¿‡èŠ‚ç‚¹æ ‡ç­¾è¿›è¡Œé¢„è®¾è¯¥podå°†ä¼šè¿è¡Œäºæœ‰æ­¤æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šé¢ï¼Œ # å¦‚æœå¤šä¸ªèŠ‚ç‚¹æ‹¥æœ‰æ­¤æ ‡ç­¾ï¼Œè°ƒåº¦å™¨å°†ä¼šæ‹©ä¼˜è¿›è¡Œè°ƒåº¦ nodeSelector: server_type: game_server 2.4 æŸ¥çœ‹åˆ›å»ºäº‹ä»¶:Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 16s default-scheduler Successfully assigned with-node-selector to 192.168.56.14 Normal SuccessfulMountVolume 16s kubelet, 192.168.56.14 MountVolume.SetUp succeeded for volume \"default-token-5htws\" Normal Pulling 11s kubelet, 192.168.56.14 pulling image \"busybox\" é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥æ„Ÿå—åˆ°nodeSelectorçš„æ–¹å¼æ¯”è¾ƒç›´è§‚ï¼Œä½†æ˜¯è¿˜å¤Ÿçµæ´»ï¼Œæ§åˆ¶ç²’åº¦åå¤§ï¼Œä¸‹é¢æˆ‘ä»¬å†çœ‹å¦å¤–ä¸€ç§æ›´åŠ çµæ´»çš„æ–¹å¼ï¼šnodeAffinityã€‚ 3. NodeAffinitynodeAffinityå°±æ˜¯èŠ‚ç‚¹äº²å’Œæ€§ï¼Œç›¸å¯¹åº”çš„æ˜¯Anti-Affinityï¼Œå°±æ˜¯åäº²å’Œæ€§ï¼Œè¿™ç§æ–¹æ³•æ¯”ä¸Šé¢çš„nodeSelectoræ›´åŠ çµæ´»ï¼Œå®ƒå¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„é€»è¾‘ç»„åˆäº†ï¼Œä¸åªæ˜¯ç®€å•çš„ç›¸ç­‰åŒ¹é…ã€‚è°ƒåº¦å¯ä»¥åˆ†æˆè½¯ç­–ç•¥å’Œç¡¬ç­–ç•¥ä¸¤ç§æ–¹å¼ï¼Œè½¯ç­–ç•¥å°±æ˜¯å¦‚æœä½ æ²¡æœ‰æ»¡è¶³è°ƒåº¦è¦æ±‚çš„èŠ‚ç‚¹çš„è¯ï¼ŒPOD å°±ä¼šå¿½ç•¥è¿™æ¡è§„åˆ™ï¼Œç»§ç»­å®Œæˆè°ƒåº¦è¿‡ç¨‹ã€‚ nodeAffinityå°±æœ‰ä¸¤ä¸Šé¢ä¸¤ç§ç­–ç•¥ï¼š # è½¯ç­–ç•¥:(æ»¡è¶³æ¡ä»¶æœ€å¥½äº†ï¼Œæ²¡æœ‰çš„è¯ä¹Ÿæ— æ‰€è°“äº†çš„ç­–ç•¥) preferredDuringSchedulingIgnoredDuringExecution # ç¡¬ç­–ç•¥:(ä½ å¿…é¡»æ»¡è¶³æˆ‘çš„è¦æ±‚ï¼Œä¸ç„¶æˆ‘å°±ä¸å¹²) requiredDuringSchedulingIgnoredDuringExecution 3.1 ä¾‹å¦‚(test-node-affinity.yaml)apiVersion: v1 kind: Pod metadata: name: with-node-affinity labels: app: node-affinity-pod spec: containers: - name: with-node-affinity image: nginx imagePullPolicy: IfNotPresent affinity: nodeAffinity: # ç¡¬æ€§ç­–ç•¥ requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: NotIn values: - 192.168.56.11 - 192.168.56.12 # è½¯æ€§ç­–ç•¥ preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 preference: matchExpressions: - key: server_type operator: In values: - game_server ä¸Šé¢çš„Podæˆ‘ä»¬è¿›è¡Œä¸€ä¸‹è§£è¯»:1ã€è¯¥pod é€šè¿‡ç¡¬æ€§ç­–ç•¥çº¦æŸåå°†ç¦æ­¢è°ƒåº¦åˆ°èŠ‚ç‚¹11ï¼Œ12ä¸Šé¢å»2ã€æ’é™¤èŠ‚ç‚¹11ï¼Œ12åï¼Œé€‰æ‹©å…¶ä»–èŠ‚ç‚¹å«æœ‰labelä¸ºserver_type:game_serverçš„èŠ‚ç‚¹è¿è¡Œ3ã€å¦‚æœå…¶ä»–èŠ‚ç‚¹ä¹Ÿæ²¡æœ‰å«æœ‰label server_type:game_server, é‚£ä¹ˆå°†ä¼šè°ƒåº¦åˆ°ä»»æ„èŠ‚ç‚¹è¿è¡ŒåŒæ ·çš„æˆ‘ä»¬å¯ä»¥ä½¿ç”¨descirbeå‘½ä»¤æŸ¥çœ‹å…·ä½“çš„è°ƒåº¦æƒ…å†µæ˜¯å¦æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚è¿™é‡Œçš„åŒ¹é…é€»è¾‘æ˜¯ label çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ï¼Œç°åœ¨Kubernetesæä¾›çš„æ“ä½œç¬¦æœ‰ä¸‹é¢çš„å‡ ç§ï¼š Inï¼šlabel çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ NotInï¼šlabel çš„å€¼ä¸åœ¨æŸä¸ªåˆ—è¡¨ä¸­ Gtï¼šlabel çš„å€¼å¤§äºæŸä¸ªå€¼ Ltï¼šlabel çš„å€¼å°äºæŸä¸ªå€¼ Existsï¼šæŸä¸ª label å­˜åœ¨ DoesNotExistï¼šæŸä¸ª label ä¸å­˜åœ¨ å¦‚æœnodeSelectorTermsä¸‹é¢æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œæ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥äº†ï¼›å¦‚æœmatchExpressionsæœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œåˆ™å¿…é¡»åŒæ—¶æ»¡è¶³è¿™äº›æ¡ä»¶æ‰èƒ½æ­£å¸¸è°ƒåº¦ PODã€‚ 4. PodAffinityä¸Šé¢ä¸‰ç§æ–¹å¼éƒ½æ˜¯è®©PODå»é€‰æ‹©èŠ‚ç‚¹çš„ï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½å¤Ÿæ ¹æ® POD ä¹‹é—´çš„å…³ç³»è¿›è¡Œè°ƒåº¦ï¼ŒKubernetesåœ¨1.4ç‰ˆæœ¬å¼•å…¥çš„podAffinityæ¦‚å¿µå°±å¯ä»¥å®ç°æˆ‘ä»¬è¿™ä¸ªéœ€æ±‚ã€‚ å’ŒnodeAffinityç±»ä¼¼ï¼ŒpodAffinityä¹Ÿæœ‰requiredDuringSchedulingIgnoredDuringExecution(ç¡¬æ€§ç­–ç•¥)å’Œ preferredDuringSchedulingIgnoredDuringExecution(è½¯æ€§ç­–ç•¥)ä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å¦‚æœè¦ä½¿ç”¨äº’æ–¥æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨podAntiAffinityå­—æ®µã€‚ å¦‚ä¸‹ä¾‹å­ï¼Œæˆ‘ä»¬å¸Œæœ›ã€with-pod-affinityã€‘å’Œã€with-nodename-busybox-podã€‘èƒ½å¤Ÿå°±è¿‘éƒ¨ç½²ï¼Œè€Œä¸å¸Œæœ›å’Œã€node-affinity-podã€‘éƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸‹é¢ï¼š 4.1 ä¾‹å¦‚(test-pod-affinity.yaml)apiVersion: v1 kind: Pod metadata: name: with-pod-affinity labels: app: pod-affinity-pod spec: containers: - name: with-pod-affinity image: nginx affinity: podAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: app operator: In values: - with-nodename-busybox-pod topologyKey: kubernetes.io/hostname podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 podAffinityTerm: labelSelector: matchExpressions: - key: app operator: In values: - node-affinity-pod topologyKey: kubernetes.io/hostname ä¸Šé¢çš„podæˆ‘ä»¬è§£è¯»ä¸€ä¸‹:1ã€POD éœ€è¦è°ƒåº¦åˆ°æŸä¸ªæŒ‡å®šçš„ä¸»æœºä¸Šï¼Œè‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†è¿™æ ·çš„ PODï¼šè¿™ä¸ª POD æœ‰ä¸€ä¸ªapp=busybox-podçš„ labelã€‚2ã€podAntiAffinityåˆ™æ˜¯å¸Œæœ›æœ€å¥½ä¸è¦è°ƒåº¦åˆ°è¿™æ ·çš„èŠ‚ç‚¹ï¼šè¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†æŸä¸ª PODï¼Œè€Œè¿™ä¸ª POD æœ‰app=node-affinity-podçš„ labelã€‚3ã€æ ¹æ®å‰é¢ä¸¤ä¸ª POD çš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥é¢„è§ä¸Šé¢è¿™ä¸ª POD åº”è¯¥ä¼šè¢«è°ƒåº¦åˆ°192.168.56.11çš„èŠ‚ç‚¹ä¸Šï¼Œå› ä¸ºå‰é¢å®è·µçš„æ—¶å€™ã€with-nodename-busybox-podã€‘è¢«è°ƒåº¦åˆ°äº†192.168.56.11èŠ‚ç‚¹ï¼Œè€Œã€node-affinity-podã€‘è¢«è°ƒåº¦åˆ°äº†192.168.56.11ä»¥ä¸ºçš„èŠ‚ç‚¹ï¼Œæ­£å¥½æ»¡è¶³ä¸Šé¢çš„éœ€æ±‚ã€‚é€šè¿‡describeæŸ¥çœ‹ï¼š Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 53m default-scheduler Successfully assigned with-pod-affinity to 192.168.56.11 Normal SuccessfulMountVolume 52m kubelet, 192.168.56.11 MountVolume.SetUp succeeded for volume \"default-token-5htws\" Normal Pulling 52m kubelet, 192.168.56.11 pulling image \"nginx\" Normal Pulled 51m kubelet, 192.168.56.11 Successfully pulled image \"nginx\" Normal Created 51m kubelet, 192.168.56.11 Created container Normal Started 51m kubelet, 192.168.56.11 Started container åœ¨labelSelectorå’Œ topologyKeyçš„åŒçº§ï¼Œè¿˜å¯ä»¥å®šä¹‰ namespaces åˆ—è¡¨ï¼Œè¡¨ç¤ºåŒ¹é…å“ªäº› namespace é‡Œé¢çš„ podï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šåŒ¹é…å®šä¹‰çš„ pod æ‰€åœ¨çš„ namespaceï¼›å¦‚æœå®šä¹‰äº†è¿™ä¸ªå­—æ®µï¼Œä½†æ˜¯å®ƒçš„å€¼ä¸ºç©ºï¼Œåˆ™åŒ¹é…æ‰€æœ‰çš„ namespacesã€‚ soï¼Œä»¥ä¸Šæˆ‘ä»¬åˆ›å»ºçš„å››ä¸ªä¾‹å­ç»“æœä¸ºä¸‹: [root@linux-node1 affinity_study]# kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE with-node-affinity 1/1 Running 2 10h 10.2.70.16 192.168.56.14 with-node-selector 1/1 Running 0 8m 10.2.70.15 192.168.56.14 with-nodename 1/1 Running 1 11h 10.2.88.9 192.168.56.11 with-pod-affinity 1/1 Running 0 10h 10.2.88.10 192.168.56.11 5. æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰å¯¹äºnodeAffinityæ— è®ºæ˜¯ç¡¬ç­–ç•¥è¿˜æ˜¯è½¯ç­–ç•¥æ–¹å¼ï¼Œéƒ½æ˜¯è°ƒåº¦ POD åˆ°é¢„æœŸèŠ‚ç‚¹ä¸Šï¼Œè€ŒTaintsæ°å¥½ä¸ä¹‹ç›¸åï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º Taints ï¼Œé™¤é POD ä¹Ÿè¢«æ ‡è¯†ä¸ºå¯ä»¥å®¹å¿æ±¡ç‚¹èŠ‚ç‚¹ï¼Œå¦åˆ™è¯¥ Taints èŠ‚ç‚¹ä¸ä¼šè¢«è°ƒåº¦podã€‚ æ¯”å¦‚ç”¨æˆ·å¸Œæœ›æŠŠ Master èŠ‚ç‚¹ä¿ç•™ç»™ Kubernetes ç³»ç»Ÿç»„ä»¶ä½¿ç”¨ï¼Œæˆ–è€…æŠŠä¸€ç»„å…·æœ‰ç‰¹æ®Šèµ„æºé¢„ç•™ç»™æŸäº› PODï¼Œåˆ™æ±¡ç‚¹å°±å¾ˆæœ‰ç”¨äº†ï¼ŒPOD ä¸ä¼šå†è¢«è°ƒåº¦åˆ° taint æ ‡è®°è¿‡çš„èŠ‚ç‚¹ã€‚taint æ ‡è®°èŠ‚ç‚¹ä¸¾ä¾‹å¦‚ä¸‹ï¼š 5.1 è®¾ç½®æ±¡ç‚¹ kubectl taint node [node] key=value[effect] å…¶ä¸­[effect] å¯å–å€¼ï¼š [ NoSchedule | PreferNoSchedule | NoExecute ] NoSchedule ï¼šä¸€å®šä¸èƒ½è¢«è°ƒåº¦ã€‚POD ä¸ä¼šè¢«è°ƒåº¦åˆ°æ ‡è®°ä¸º taints èŠ‚ç‚¹ã€‚ PreferNoScheduleï¼šå°½é‡ä¸è¦è°ƒåº¦ã€‚NoSchedule çš„è½¯ç­–ç•¥ç‰ˆæœ¬ã€‚ NoExecuteï¼šä¸ä»…ä¸ä¼šè°ƒåº¦ï¼Œè¿˜ä¼šé©±é€Nodeä¸Šå·²æœ‰çš„Podã€‚ ç¤ºä¾‹ï¼škubectl taint node 192.168.56.11 key1=value1:NoSchedule 5.2 å»é™¤æ±¡ç‚¹#æ¯”å¦‚è®¾ç½®æ±¡ç‚¹ï¼š kubectl taint nodes 192.168.56.11 key1=value1:NoSchedule kubectl taint nodes 192.168.56.11 key2=value2:NoExecute kubectl taint nodes 192.168.56.11 key3=value3:PreferNoSchedule #å»é™¤æŒ‡å®škeyåŠå…¶effectï¼š kubectl taint nodes 192.168.56.11 key:[effect]- #(è¿™é‡Œçš„keyä¸ç”¨æŒ‡å®švalue) #å»é™¤æŒ‡å®škeyæ‰€æœ‰çš„effect: kubectl taint nodes 192.168.56.11 key- #ç¤ºä¾‹ï¼š kubectl taint node 192.168.56.11 key1:NoSchedule- kubectl taint node 192.168.56.11 key2:NoExecute- kubectl taint node 192.168.56.11 key3:PreferNoSchedule- kubectl taint node 192.168.56.11 key3- (å»é™¤æŒ‡å®škeyçš„æ‰€æœ‰effct) 5.3 å®è·µ# 5.3.1 ç»™èŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹é¦–å…ˆæˆ‘çš„ç¯å¢ƒä¸­è¿˜æ²¡æœ‰è®¾ç½®æ±¡ç‚¹ï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ä¾‹å­(nginx-deployment.yaml): apiVersion: apps/v1 kind: Deployment metadata: name: nginx-pod labels: app: nginx-pod spec: replicas: 10 # è¿™é‡Œä¸ºäº†å®è·µæ•ˆæœç‰¹æ„è®¾å®šäº†10ä¸ªå‰¯æœ¬ selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 # éƒ¨ç½²ç»“æœ: [root@linux-node1 ~]# kubectl get pods -o wide | grep nginx nginx-pod-7d9f9876cc-95fj2 1/1 Running 0 1m 10.2.70.26 192.168.56.14 nginx-pod-7d9f9876cc-jclvf 1/1 Running 0 1m 10.2.44.28 192.168.56.13 nginx-pod-7d9f9876cc-k2m6x 1/1 Running 0 1m 10.2.44.31 192.168.56.13 nginx-pod-7d9f9876cc-l74hf 1/1 Running 0 1m 10.2.88.15 192.168.56.11 nginx-pod-7d9f9876cc-n8g6c 1/1 Running 0 1m 10.2.44.29 192.168.56.13 nginx-pod-7d9f9876cc-p2cft 1/1 Running 0 1m 10.2.88.14 192.168.56.11 nginx-pod-7d9f9876cc-p7hvt 1/1 Running 0 1m 10.2.69.25 192.168.56.12 nginx-pod-7d9f9876cc-rjj97 1/1 Running 0 1m 10.2.70.27 192.168.56.14 nginx-pod-7d9f9876cc-t2wlw 1/1 Running 0 1m 10.2.69.26 192.168.56.12 nginx-pod-7d9f9876cc-whkx9 1/1 Running 0 1m 10.2.44.30 192.168.56.13 ä»¥ä¸Šä¾‹å­å¯ä»¥çœ‹å‡ºåœ¨æˆ‘çš„ç¯å¢ƒä¸­å·²ç»åˆ†é…åˆ°äº†æ¯ä¸ªèŠ‚ç‚¹åŒ…æ‹¬æˆ‘ä»¬æ¥ä¸‹æ¥å‡†å¤‡è®¾ç½®æ±¡ç‚¹çš„èŠ‚ç‚¹192.168.56.11ã€‚ ä¸‹é¢æˆ‘æŠŠmasterèŠ‚ç‚¹192.168.56.11 è®¾ç½®æ±¡ç‚¹(è¿™é‡Œæˆ‘ç”¨çš„effectæ˜¯NoSchedule) [root@linux-node1 affinity_study]# kubectl taint nodes 192.168.56.11 server_type=k8s_system:NoSchedule node \"192.168.56.11\" tainted # ç„¶åéƒ¨ç½²ä¸‹é¢è¿™ä¸ªè®¾ç½®ä¾‹å­: apiVersion: apps/v1 kind: Deployment metadata: name: nginx-pod-taints labels: app: nginx-pod-taints spec: replicas: 10 # è¿™é‡Œä¸ºäº†å®è·µæ•ˆæœç‰¹æ„è®¾å®šäº†10ä¸ªå‰¯æœ¬ selector: matchLabels: app: nginx-taints template: metadata: labels: app: nginx-taints spec: containers: - name: nginx-taints image: nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 # éƒ¨ç½²ç»“æœ: [root@linux-node1 ~]# kubectl get pods -o wide | grep nginx-pod-taints nginx-pod-taints-57757d7677-5h6nj 1/1 Running 0 2m 10.2.69.31 192.168.56.12 nginx-pod-taints-57757d7677-dkd8h 1/1 Running 0 2m 10.2.70.34 192.168.56.14 nginx-pod-taints-57757d7677-f2vdn 1/1 Running 0 2m 10.2.44.38 192.168.56.13 nginx-pod-taints-57757d7677-fnx2n 1/1 Running 0 2m 10.2.44.36 192.168.56.13 nginx-pod-taints-57757d7677-gsc5g 1/1 Running 0 2m 10.2.70.32 192.168.56.14 nginx-pod-taints-57757d7677-kjl89 1/1 Running 0 2m 10.2.44.35 192.168.56.13 nginx-pod-taints-57757d7677-mqx27 1/1 Running 0 2m 10.2.70.33 192.168.56.14 nginx-pod-taints-57757d7677-skdd4 1/1 Running 0 2m 10.2.69.32 192.168.56.12 nginx-pod-taints-57757d7677-spwfh 1/1 Running 0 2m 10.2.69.30 192.168.56.12 nginx-pod-taints-57757d7677-tpcm8 1/1 Running 0 2m 10.2.44.37 192.168.56.13 ä»¥ä¸Šä¾‹å­å¯ä»¥çœ‹å‡ºæˆ‘ä»¬å°†masterèŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹ä¹‹åè°ƒåº¦å™¨å¹¶æ²¡æœ‰æŠŠpodè°ƒåº¦åˆ°masterèŠ‚ç‚¹ä¸Šã€‚è¿™é‡Œæˆ‘é€‰æ‹©çš„effectæ˜¯NoScheduleï¼Œä¹Ÿå°±æ˜¯ä¸€å®šä¸è¦è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚ # 5.3.2 ç»™éƒ¨ç½²é…ç½®è®¾ç½®å®¹å¿æ€§é¦–å…ˆ æˆ‘ä»¬ä¸Šé¢è®¾ç½®äº†æ±¡ç‚¹å³: taints: - effect: NoSchedule key: server_type value: k8s_system ç„¶åæˆ‘ä»¬éƒ¨ç½²ä»¥ä¸‹ä¾‹å­(test-tolertations.yaml) apiVersion: apps/v1 kind: Deployment metadata: name: nginx-pod-taints-tolerations labels: app: nginx-pod-taints-tolerations spec: replicas: 10 # è¿™é‡Œä¸ºäº†å®è·µæ•ˆæœç‰¹æ„è®¾å®šäº†10ä¸ªå‰¯æœ¬ selector: matchLabels: app: nginx-taints-tolerations template: metadata: labels: app: nginx-taints-tolerations spec: # è®¾ç½®å®¹å¿æ€§ tolerations: - key: \"server_type\" operator: \"Equal\" value: \"k8s_system\" effect: \"NoSchedule\" containers: - name: nginx-taints-tolerations image: nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 # éƒ¨ç½²ç»“æœ: [root@linux-node1 affinity_study]# kubectl get pods -o wide | grep nginx-pod-taints-tolerations nginx-pod-taints-tolerations-5b4988bd4-2pk46 1/1 Running 0 29m 10.2.69.33 192.168.56.12 nginx-pod-taints-tolerations-5b4988bd4-854xx 1/1 Running 0 29m 10.2.70.35 192.168.56.14 nginx-pod-taints-tolerations-5b4988bd4-88xrt 1/1 Running 0 29m 10.2.69.34 192.168.56.12 nginx-pod-taints-tolerations-5b4988bd4-8czpg 1/1 Running 0 29m 10.2.88.17 192.168.56.11 nginx-pod-taints-tolerations-5b4988bd4-czdss 1/1 Running 0 21m 10.2.44.41 192.168.56.13 nginx-pod-taints-tolerations-5b4988bd4-dj6mw 1/1 Running 0 29m 10.2.88.16 192.168.56.11 nginx-pod-taints-tolerations-5b4988bd4-g4ltd 1/1 Running 0 29m 10.2.44.39 192.168.56.13 nginx-pod-taints-tolerations-5b4988bd4-npthj 1/1 Running 0 29m 10.2.44.40 192.168.56.13 nginx-pod-taints-tolerations-5b4988bd4-ptlqg 1/1 Running 0 29m 10.2.88.18 192.168.56.11 nginx-pod-taints-tolerations-5b4988bd4-t9gs6 1/1 Running 0 29m 10.2.69.35 192.168.56.12 ä»¥ä¸Šå®è·µæˆ‘ä»¬è§£è¯»ä¸€ä¸‹:1. åœ¨èŠ‚ç‚¹master 192.168.56.11ä¸Šé¢è®¾ç½®äº†æ±¡ç‚¹ï¼›ä½†æœŸæœ›è¯¥èŠ‚ç‚¹èƒ½å®¹å¿è°ƒåº¦;2. äºæ˜¯é€šè¿‡è®¾ç½®tolerationsæ¥å®ç°ï¼Œå…¶ä¸­Podè¦å®¹å¿çš„æœ‰æ±¡ç‚¹çš„Nodeçš„keyæ˜¯server_type Equal k8s_system,æ•ˆæœæ˜¯NoSchedule.3. é€šè¿‡è®¾ç½®å®¹å¿æœºåˆ¶ç»“æœä¸é¢„æœŸç›¸ç¬¦ã€‚ å¯¹äºtolerationså±æ€§çš„å†™æ³•ï¼š å…¶ä¸­çš„keyã€valueã€effect ä¸Nodeçš„Taintè®¾ç½®éœ€ä¿æŒä¸€è‡´ï¼Œ è¿˜æœ‰ä»¥ä¸‹å‡ ç‚¹è¯´æ˜ï¼š 1ã€å¦‚æœoperatorçš„å€¼æ˜¯Existsï¼Œåˆ™valueå±æ€§å¯çœç•¥ã€‚ 2ã€å¦‚æœoperatorçš„å€¼æ˜¯Equalï¼Œåˆ™è¡¨ç¤ºå…¶keyä¸valueä¹‹é—´çš„å…³ç³»æ˜¯equal(ç­‰äº)ã€‚ 3ã€å¦‚æœä¸æŒ‡å®šoperatorå±æ€§ï¼Œåˆ™é»˜è®¤å€¼ä¸ºEqualã€‚ å¦å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªç‰¹æ®Šå€¼ï¼š 1ã€ç©ºçš„key å¦‚æœå†é…åˆExists å°±èƒ½åŒ¹é…æ‰€æœ‰çš„keyä¸value ï¼Œä¹Ÿæ˜¯æ˜¯èƒ½å®¹å¿æ‰€æœ‰nodeçš„æ‰€æœ‰Taintsã€‚ 2ã€ç©ºçš„effect åŒ¹é…æ‰€æœ‰çš„effectã€‚ # 5.3.3 å…¶ä»–ä¸€ä¸ªnodeä¸Šå¯ä»¥æœ‰å¤šä¸ªæ±¡ç‚¹ï¼š [root@linux-node1 affinity_study]# kubectl describe node/192.168.56.11 ........ ........ Taints: server_type=k8s_system:NoSchedule test=wahaha:PreferNoSchedule ........ ........ å¦‚æœæŒ‰ç…§æˆ‘ä¸Šé¢çš„ä¾‹å­æ¥çš„è¯ç»“æœå°†ä¸ä¼šæœ‰ä»»ä½•podè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œå› ä¸ºä¸Šè¿°æˆ‘åªå®¹å¿äº†ä¸€ä¸ªæ±¡ç‚¹ï¼›æ‰€ä»¥å¯ä»¥æ–°åŠ ä¸€ä¸ªæ±¡ç‚¹å®¹å¿: [root@linux-node1 affinity_study]# more test-tolertations.yaml ........ ........ tolerations: - key: \"server_type\" operator: \"Equal\" value: \"k8s_system\" effect: \"NoSchedule\" - key: \"test\" operator: \"Equal\" value: \"wahaha\" effect: \"PreferNoSchedule\" ........ ........ é‡æ–°éƒ¨ç½²åç»“æœä¹Ÿå¯ä»¥é¢„è§ åªè¦ä¸¤ä¸ªå®¹å¿æ»¡è¶³å°±å¯ä»¥è°ƒåº¦è¿‡å»å•¦~ è®¾ç½®å®¹å¿çš„æ•ˆæœï¼š å¦‚æœåœ¨è®¾ç½®nodeçš„Taints(æ±¡ç‚¹)ä¹‹å‰ï¼Œå°±å·²ç»è¿è¡Œäº†ä¸€äº›Podï¼Œé‚£ä¹ˆè¿™äº›Podæ˜¯å¦è¿˜èƒ½ç»§ç»­åœ¨æ­¤Nodeä¸Šè¿è¡Œï¼Ÿ è¿™å°±è¦çœ‹è®¾ç½®Taintsæ±¡ç‚¹æ—¶çš„effect(æ•ˆæœ)äº†ã€‚ å¦‚æœeffectçš„å€¼æ˜¯NoScheduleæˆ–PreferNoScheduleï¼Œé‚£ä¹ˆå·²è¿è¡Œçš„Podä»ç„¶å¯ä»¥è¿è¡Œï¼Œåªæ˜¯æ–°Pod(å¦‚æœæ²¡æœ‰å®¹å¿)ä¸ä¼šå†å¾€ä¸Šè°ƒåº¦ã€‚ å¦‚æœ pod ä¸èƒ½å¿å—effect å€¼ä¸º NoExecute çš„ taintï¼Œé‚£ä¹ˆ pod å°†é©¬ä¸Šè¢«é©±é€ å¦‚æœ pod èƒ½å¤Ÿå¿å—effect å€¼ä¸º NoExecute çš„ taintï¼Œä½†æ˜¯åœ¨ toleration å®šä¹‰ä¸­æ²¡æœ‰æŒ‡å®š tolerationSecondsï¼Œåˆ™ pod è¿˜ä¼šä¸€ç›´åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ å¦‚æœ pod èƒ½å¤Ÿå¿å—effect å€¼ä¸º NoExecute çš„ taintï¼Œè€Œä¸”æŒ‡å®šäº† tolerationSecondsï¼Œåˆ™ pod è¿˜èƒ½åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šç»§ç»­è¿è¡Œè¿™ä¸ªæŒ‡å®šçš„æ—¶é—´é•¿åº¦ã€‚ è™½ç„¶æ˜¯ç«‹åˆ»è¢«é©±é€ï¼Œä½†æ˜¯K8Sä¸ºäº†å½°æ˜¾äººæ€§åŒ–ï¼Œåˆç»™å…·æœ‰NoExecuteæ•ˆæœçš„æ±¡ç‚¹ï¼Œ åœ¨å®¹å¿å±æ€§ä¸­æœ‰ä¸€ä¸ªå¯é€‰çš„tolerationSecondså­—æ®µï¼Œç”¨æ¥è®¾ç½®è¿™äº›Podè¿˜å¯ä»¥åœ¨è¿™ä¸ªNodeä¹‹ä¸Šè¿è¡Œå¤šä¹…ï¼Œç»™å®ƒä»¬ä¸€ç‚¹å®½é™çš„æ—¶é—´ï¼Œåˆ°æ—¶é—´æ‰é©±é€ã€‚ ä¸åŒçš„éƒ¨ç½²å¯åŠ¨æ–¹å¼ï¼š å¦‚æœæ˜¯ä»¥Podæ¥å¯åŠ¨çš„ï¼Œé‚£ä¹ˆPodè¢«é©±é€åï¼Œ å°†ä¸ä¼šå†è¢«è¿è¡Œï¼Œå°±ç­‰äºæŠŠå®ƒåˆ é™¤äº†ã€‚ å¦‚æœæ˜¯deployment/rcï¼Œé‚£ä¹ˆåˆ é™¤çš„podä¼šå†å…¶å®ƒèŠ‚ç‚¹è¿è¡Œã€‚ å¦‚æœæ˜¯DaemonSetåœ¨æ­¤Nodeä¸Šå¯åŠ¨çš„Podï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šå†è¢«è¿è¡Œï¼Œç›´åˆ°Nodeä¸Šçš„NoExecuteæ±¡è¢«å»é™¤æˆ–è€…Podå®¹å¿ã€‚ #è®¾ç½®Podçš„å®½é™æ—¶é—´spec: tolerations: #è®¾ç½®å®¹å¿æ€§ key: â€œtestâ€operator: â€œEqualâ€ #å¦‚æœæ“ä½œç¬¦ä¸ºExistsï¼Œé‚£ä¹ˆvalueå±æ€§å¯çœç•¥value: â€œ16â€effect: â€œwahahaâ€tolerationSeconds: 180 å¦‚æœè¿è¡Œæ­¤Podçš„Nodeï¼Œè¢«è®¾ç½®äº†å…·æœ‰NoExecuteæ•ˆæœçš„Taint(æ±¡ç‚¹)ï¼Œè¿™ä¸ªPodå°†åœ¨å­˜æ´»180såæ‰è¢«é©±é€ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®tolerationSecondså­—æ®µï¼Œå°†æ°¸ä¹…è¿è¡Œã€‚ é€šè¿‡å¯¹Taintså’ŒTolerationsçš„äº†è§£ï¼Œå¯ä»¥çŸ¥é“ï¼Œé€šè¿‡å®ƒä»¬å¯ä»¥è®©æŸäº›ç‰¹å®šåº”ç”¨ï¼Œç‹¬å ä¸€ä¸ªNodeï¼Œç»™ç‰¹å®šçš„Nodeè®¾ç½®ä¸€ä¸ªTaintï¼Œåªè®©æŸäº›ç‰¹å®šçš„åº”ç”¨æ¥å®¹å¿è¿™äº›æ±¡ç‚¹ï¼Œå®¹å¿åå°±æœ‰å¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°æ­¤ç‰¹å®šNodeï¼Œä½†æ˜¯ä¹Ÿä¸ä¸€å®šä¼šè°ƒåº¦ç»™æ­¤ç‰¹å®šNodeï¼Œè®¾ç½®å®¹å¿å¹¶ä¸é˜»æ­¢è°ƒåº¦å™¨è°ƒåº¦ç»™å…¶å®ƒNodeï¼Œé‚£ä¹ˆå¦‚ä½•è®©ç‰¹å®šåº”ç”¨çš„Nodeï¼Œåªèƒ½è¢«è°ƒåº¦åˆ°æ­¤ç‰¹å®šçš„Nodeå‘¢ï¼Œè¿™å°±è¦ç»“åˆNodeAffinityèŠ‚ç‚¹äº²å’Œæ€§ï¼Œç»™Nodeæ‰“ä¸ªæ ‡ç­¾ï¼Œç„¶ååœ¨Podå±æ€§é‡Œè®¾ç½®NodeAffinityåˆ°Nodeã€‚å¦‚æ­¤å°±èƒ½è¾¾åˆ°è¦æ±‚äº†ã€‚","categories":[{"name":"Docker","slug":"Docker","permalink":"https://blog.sctux.cc/categories/Docker/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/tags/k8s/"}],"keywords":[{"name":"Docker","slug":"Docker","permalink":"https://blog.sctux.cc/categories/Docker/"}]},{"title":"kubernetesè°ƒåº¦ä¹‹NodeSelector","slug":"kubernetes-diao-du-zhinodeselector-trashed","date":"2018-12-03T10:34:48.000Z","updated":"2025-09-01T01:59:08.921Z","comments":true,"path":"2018/12/03/kubernetes-diao-du-zhinodeselector-trashed/","permalink":"https://blog.sctux.cc/2018/12/03/kubernetes-diao-du-zhinodeselector-trashed/","excerpt":"1 NodeNamePod.spec.nodeNameç”¨äºå¼ºåˆ¶çº¦æŸå°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Šï¼Œè¿™é‡Œè¯´æ˜¯â€œè°ƒåº¦â€ï¼Œä½†å…¶å®æŒ‡å®šäº†nodeNameçš„Podä¼šç›´æ¥è·³è¿‡Schedulerçš„è°ƒåº¦é€»è¾‘ï¼Œç›´æ¥å†™å…¥PodListåˆ—è¡¨ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯å¼ºåˆ¶åŒ¹é…ã€‚ä¾‹å­ï¼š apiVersion: apps/v1 kind: Deployment metadata: name: nginx-test labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: nodeName: 192.168.56.13 # æŒ‡å®špodè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ containers: - name: nginx image: nginx:latest imagePullPolicy: IfNotPresent # é•œåƒæ‹‰å–ç­–ç•¥ ports: - containerPort: 80 2 NodeSelectorPod.spec.nodeSelectoræ˜¯é€šè¿‡kubernetesçš„label-selectoræœºåˆ¶è¿›è¡ŒèŠ‚ç‚¹é€‰æ‹©ï¼Œç”±schedulerè°ƒåº¦ç­–ç•¥MatchNodeSelectorè¿›è¡ŒlabelåŒ¹é…ï¼Œè°ƒåº¦podåˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯å¼ºåˆ¶çº¦æŸã€‚å¯ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨çš„æ­¥éª¤ä¸ºï¼š Nodeæ·»åŠ labelæ ‡è®° æ ‡è®°è§„åˆ™ï¼škubectl label nodes &lt;node-name&gt; &lt;label-key&gt;=&lt;label-value&gt; kubectl label nodes 192.168.56.13 server_type=game_server ç¡®è®¤æ ‡è®°[root@linux-node1 ~]# kubectl get nodes 192.168.56.14 --show-labels NAME STATUS ROLES AGE VERSION LABELS 192.168.56.14 Ready &lt;none&gt; 81d v1.10.1 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=192.168.56.14,server_type=game_server Podå®šä¹‰ä¸­æ·»åŠ nodeSelector apiVersion: apps/v1 kind: Deployment metadata: name: nginx-test labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 nodeSelector: server_type: game_server #æŒ‡å®šè°ƒåº¦èŠ‚ç‚¹ä¸ºå¸¦æœ‰labelæ ‡è®°ä¸ºserver_type=game_server","text":"1 NodeNamePod.spec.nodeNameç”¨äºå¼ºåˆ¶çº¦æŸå°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Šï¼Œè¿™é‡Œè¯´æ˜¯â€œè°ƒåº¦â€ï¼Œä½†å…¶å®æŒ‡å®šäº†nodeNameçš„Podä¼šç›´æ¥è·³è¿‡Schedulerçš„è°ƒåº¦é€»è¾‘ï¼Œç›´æ¥å†™å…¥PodListåˆ—è¡¨ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯å¼ºåˆ¶åŒ¹é…ã€‚ä¾‹å­ï¼š apiVersion: apps/v1 kind: Deployment metadata: name: nginx-test labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: nodeName: 192.168.56.13 # æŒ‡å®špodè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ containers: - name: nginx image: nginx:latest imagePullPolicy: IfNotPresent # é•œåƒæ‹‰å–ç­–ç•¥ ports: - containerPort: 80 2 NodeSelectorPod.spec.nodeSelectoræ˜¯é€šè¿‡kubernetesçš„label-selectoræœºåˆ¶è¿›è¡ŒèŠ‚ç‚¹é€‰æ‹©ï¼Œç”±schedulerè°ƒåº¦ç­–ç•¥MatchNodeSelectorè¿›è¡ŒlabelåŒ¹é…ï¼Œè°ƒåº¦podåˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯å¼ºåˆ¶çº¦æŸã€‚å¯ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨çš„æ­¥éª¤ä¸ºï¼š Nodeæ·»åŠ labelæ ‡è®° æ ‡è®°è§„åˆ™ï¼škubectl label nodes &lt;node-name&gt; &lt;label-key&gt;=&lt;label-value&gt; kubectl label nodes 192.168.56.13 server_type=game_server ç¡®è®¤æ ‡è®°[root@linux-node1 ~]# kubectl get nodes 192.168.56.14 --show-labels NAME STATUS ROLES AGE VERSION LABELS 192.168.56.14 Ready &lt;none&gt; 81d v1.10.1 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=192.168.56.14,server_type=game_server Podå®šä¹‰ä¸­æ·»åŠ nodeSelector apiVersion: apps/v1 kind: Deployment metadata: name: nginx-test labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 nodeSelector: server_type: game_server #æŒ‡å®šè°ƒåº¦èŠ‚ç‚¹ä¸ºå¸¦æœ‰labelæ ‡è®°ä¸ºserver_type=game_server","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"Prometheus å®è·µ","slug":"prometheus-e5-ae-9e-e8-b7-b5","date":"2018-11-16T10:12:27.000Z","updated":"2025-09-01T01:59:08.959Z","comments":true,"path":"2018/11/16/prometheus-e5-ae-9e-e8-b7-b5/","permalink":"https://blog.sctux.cc/2018/11/16/prometheus-e5-ae-9e-e8-b7-b5/","excerpt":"PrometheusServerç«¯å®‰è£… prometheus / alertmanager / node_expoter ä¸€ã€å®‰è£…prometheus server0.è·å–è½¯ä»¶åŒ…(ç•¥)ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶12tar -xf ./packages/alertmanager-0.15.3.linux-amd64.tar.gzmv alertmanager-0.15.3.linux-amd64/alertmanager /usr/local/sbin/ 1.åˆ›å»ºè¿è¡Œç”¨æˆ·1adduser -M -s /sbin/nologin prometheus 2.åˆ›å»ºç”¨æˆ·æ‰€æœ‰è€…ç›®å½•12345678910111213# åˆ›å»ºprometheus serverè¿è¡Œçš„ç›®å½•ä¸»è¦å­˜æ”¾é…ç½®æ–‡ä»¶mdkir /usr/local/share/prometheus/prometheus_server -pchown -R prometheus:prometheus /usr/local/share/prometheus# åˆ›å»ºprometheus serveræ•°æ®å­˜å‚¨ç›®å½•mkdir /var/lib/prometheus/datachown -R prometheus:prometheus /var/lib/prometheus/data# åˆ›å»ºprometheus alertmanagerè¿è¡Œçš„ç›®å½•ä¸»è¦å­˜æ”¾é…ç½®æ–‡ä»¶mdkir /usr/local/share/prometheus/prometheus_alertmanager# åˆ›å»ºprometheus alertmanageræ•°æ®å­˜å‚¨ç›®å½•mkdir /var/lib/alertmanager/data -pchown -R prometheus:prometheus /var/lib/alertmanager/data 3.åˆ›å»ºprometheus server systemdæ–‡ä»¶","text":"PrometheusServerç«¯å®‰è£… prometheus / alertmanager / node_expoter ä¸€ã€å®‰è£…prometheus server0.è·å–è½¯ä»¶åŒ…(ç•¥)ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶12tar -xf ./packages/alertmanager-0.15.3.linux-amd64.tar.gzmv alertmanager-0.15.3.linux-amd64/alertmanager /usr/local/sbin/ 1.åˆ›å»ºè¿è¡Œç”¨æˆ·1adduser -M -s /sbin/nologin prometheus 2.åˆ›å»ºç”¨æˆ·æ‰€æœ‰è€…ç›®å½•12345678910111213# åˆ›å»ºprometheus serverè¿è¡Œçš„ç›®å½•ä¸»è¦å­˜æ”¾é…ç½®æ–‡ä»¶mdkir /usr/local/share/prometheus/prometheus_server -pchown -R prometheus:prometheus /usr/local/share/prometheus# åˆ›å»ºprometheus serveræ•°æ®å­˜å‚¨ç›®å½•mkdir /var/lib/prometheus/datachown -R prometheus:prometheus /var/lib/prometheus/data# åˆ›å»ºprometheus alertmanagerè¿è¡Œçš„ç›®å½•ä¸»è¦å­˜æ”¾é…ç½®æ–‡ä»¶mdkir /usr/local/share/prometheus/prometheus_alertmanager# åˆ›å»ºprometheus alertmanageræ•°æ®å­˜å‚¨ç›®å½•mkdir /var/lib/alertmanager/data -pchown -R prometheus:prometheus /var/lib/alertmanager/data 3.åˆ›å»ºprometheus server systemdæ–‡ä»¶12345678910cp ./conf/systemd_conf/prometheus.service /etc/systemd/system/# æœåŠ¡æ“ä½œsystemctl daemon-reloadsystemctl start prometheussystemctl enable prometheussystemctl status prometheus# ä¿è¯ç«¯å£ä»¥åŠè¿›ç¨‹ps aux | grep prometheus | grep -v grep &amp;&amp; ss -tunl | grep 9090 | grep -v grep 4.è®¿é—®:1http://xxxxxxx:9090 äºŒã€å®‰è£…prometheus AlertManager0.è·å–è½¯ä»¶åŒ…(ç•¥)ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶12tar -xf ./packages/prometheus-2.4.2.linux-amd64.tar.gzmv prometheus-2.4.2.linux-amd64/prometheus /usr/local/sbin/ 1.åˆ›å»ºprometheus alertmanager systemdæ–‡ä»¶123456789cp ./conf/systemd_conf/alertmanager.service /etc/systemd/system/# æœåŠ¡æ“ä½œsystemctl daemon-reloadsystemctl start alertmanagersystemctl enable alertmanagersystemctl status alertmanager# ä¿è¯ç«¯å£ä»¥åŠè¿›ç¨‹ps aux | grep alertmanager | grep -v grep &amp;&amp; ss -tunl | grep 9093 | grep -v grep 2.å°†alertmanagerè·Ÿprometheus serverç»“åˆä¿®æ”¹prometheus serveré…ç½®: 123456vim /usr/local/share/prometheus/prometheus_server/prometheus.yml# Alertmanager configurationalerting: alertmanagers: - static_configs: - targets: ['localhost:9093'] 3.è®¿é—®:1http://xxxxxxx:9093 ä¸‰ã€å®‰è£…Node Exporteræ”¶é›†ä¸»æœºä¿¡æ¯æ•°æ®æ”¶é›†çš„ä»»åŠ¡ç”±ä¸åŒçš„ exporter æ¥å®Œæˆï¼Œå¦‚æœè¦æ”¶é›† linux ä¸»æœºçš„ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ node exporterã€‚ç„¶åç”± Prometheus Server ä» node exporter ä¸Šæ‹‰å–ä¿¡æ¯ã€‚ 0.è·å–è½¯ä»¶åŒ…(ç•¥)ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶12tar -xf ./packages/node_exporter-0.17.0-rc.0.linux-amd64.tar.gzmv node_exporter-0.17.0-rc.0.linux-amd64/node_exporter /usr/local/sbin/ 1.æŠŠ node exporter ä¹Ÿé…ç½®æˆé€šè¿‡ systemd ç®¡ç†, åˆ›å»ºæ–‡ä»¶ /etc/systemd/system/node-exporter.service1234567891011cp ./conf/systemd_conf/node_exporter.service /etc/systemd/system/node-exporter.service#æœåŠ¡æ“ä½œsystemctl daemon-reloadsystemctl enable node-exportersystemctl start node-exportersystemctl status node-exporter# ä¿è¯ç«¯å£ä»¥åŠè¿›ç¨‹ps aux | grep node_exporter | grep -v grep &amp;&amp; ss -tunl | grep 9100 | grep -v grep Prometheus Server å¯ä»¥ä»ä¸åŒçš„ exporter ä¸Šæ‹‰å–æ•°æ®ï¼Œå¯¹äºä¸Šé¢çš„ node exporter æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Prometheus çš„static_configs æ¥æ‹‰å– node exporter çš„æ•°æ®ã€‚conf/prometheus_server_conf/prometheus/prometheus.ymlä¸­å·²ç»å®šä¹‰å¥½äº† 123- job_name: 'node' static_configs: - targets: ['66.112.211.12:9100'] é‡å¯å„æœåŠ¡ï¼›é‡å¯å prometheus æœåŠ¡ä¼šæ¯éš” 15s ä» node exporter ä¸Šæ‹‰å–ä¸€æ¬¡æ•°æ®ã€‚Prometheus Server æä¾›äº†ç®€æ˜“çš„ WebUI å¯ä»¥è¿›æ•°æ®æŸ¥è¯¢å¹¶å±•ç¤ºï¼Œå®ƒé»˜è®¤ç›‘å¬çš„ç«¯å£ä¸º 9090ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡ç®€å•çš„æŸ¥è¯¢æ¥éªŒè¯æœ¬æ–‡å®‰è£…é…ç½®çš„ç³»ç»Ÿã€‚ å…³äºå„é¡¹æŒ‡æ ‡çš„è§„åˆ™è¿˜éœ€è¦é€šè¿‡ç¼–å†™ruleæ¡ç›®æ¥å®ç°ï¼›è¿™é‡Œç®€å•å®ç°äº†wechatè·Ÿemailçš„æŠ¥è­¦é…ç½®ï¼Œå…·ä½“å¯çœ‹è§„åˆ™é…ç½®æ–‡ä»¶conf/prometheus_server_conf/prometheus/rules/hoststas-alert.rulesä»¥åŠæŠ¥è­¦è§¦å‘é…ç½®æ–‡ä»¶alertmanager_conf/alertmanager.ymlï¼›","categories":[{"name":"monitor","slug":"monitor","permalink":"https://blog.sctux.cc/categories/monitor/"}],"tags":[{"name":"monitor","slug":"monitor","permalink":"https://blog.sctux.cc/tags/monitor/"}],"keywords":[{"name":"monitor","slug":"monitor","permalink":"https://blog.sctux.cc/categories/monitor/"}]},{"title":"Flask RestApi åç«¯å¼€å‘é¡¹ç›®è¯´æ˜","slug":"flask-restapi-hou-duan-kai-fa-xiang-mu-shuo-ming","date":"2018-10-17T09:54:56.000Z","updated":"2025-09-01T01:59:08.875Z","comments":true,"path":"2018/10/17/flask-restapi-hou-duan-kai-fa-xiang-mu-shuo-ming/","permalink":"https://blog.sctux.cc/2018/10/17/flask-restapi-hou-duan-kai-fa-xiang-mu-shuo-ming/","excerpt":"æœ€è¿‘ä¸€ç›´åœ¨åšçš„ä¸€ä¸ªé¡¹ç›®å°±æ˜¯æ‰“ç®—å°†ä¹‹å‰çš„MVCé£æ ¼çš„åå°,é‡æ„ä¸ºå‰åç«¯åˆ†ç¦»å¼,ç”±äºä¸ªäººå¯¹äºFlaskæ¡†æ¶ç†Ÿæ‚‰ç¨‹åº¦æ¯”èµ·Djangoæ¥æ›´ç†Ÿæ‚‰ä¸€äº›ï¼Œæ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©ä»–ä½œä¸ºå¼€å‘æ¡†æ¶æ¥è¿›è¡Œåç«¯çš„å¼€å‘ï¼Œç›®å‰å‘¢æ‰“ç®—çš„æ˜¯æŠŠåŸºç¡€çš„å¹³å°åŠŸèƒ½åšå‡ºæ¥ä½œä¸ºä¸€ä¸ªæ¨¡æ¿ï¼Œç„¶åé€šè¿‡è¿™ä¸ªæ¨¡æ¿å†å»ç»“åˆä¸šåŠ¡æ–¹é¢çš„å¼€å‘ã€‚å‰ç«¯æ–¹é¢æš‚æ—¶æœªå¼€å§‹ï¼Œç›®å‰åç«¯å¼€å‘è¿›åº¦: åŠŸèƒ½ å®Œæˆåº¦ methods api å¤‡æ³¨ ç”¨æˆ·æ³¨å†Œ ğŸš€%100 POST","text":"æœ€è¿‘ä¸€ç›´åœ¨åšçš„ä¸€ä¸ªé¡¹ç›®å°±æ˜¯æ‰“ç®—å°†ä¹‹å‰çš„MVCé£æ ¼çš„åå°,é‡æ„ä¸ºå‰åç«¯åˆ†ç¦»å¼,ç”±äºä¸ªäººå¯¹äºFlaskæ¡†æ¶ç†Ÿæ‚‰ç¨‹åº¦æ¯”èµ·Djangoæ¥æ›´ç†Ÿæ‚‰ä¸€äº›ï¼Œæ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©ä»–ä½œä¸ºå¼€å‘æ¡†æ¶æ¥è¿›è¡Œåç«¯çš„å¼€å‘ï¼Œç›®å‰å‘¢æ‰“ç®—çš„æ˜¯æŠŠåŸºç¡€çš„å¹³å°åŠŸèƒ½åšå‡ºæ¥ä½œä¸ºä¸€ä¸ªæ¨¡æ¿ï¼Œç„¶åé€šè¿‡è¿™ä¸ªæ¨¡æ¿å†å»ç»“åˆä¸šåŠ¡æ–¹é¢çš„å¼€å‘ã€‚å‰ç«¯æ–¹é¢æš‚æ—¶æœªå¼€å§‹ï¼Œç›®å‰åç«¯å¼€å‘è¿›åº¦: åŠŸèƒ½ å®Œæˆåº¦ methods api å¤‡æ³¨ ç”¨æˆ·æ³¨å†Œ ğŸš€%100 POST /auth/register null ç”¨æˆ·ç™»å½• ğŸš€%100 POST /auth/login null ç”¨æˆ·ç™»å‡º ğŸš€%100 POST /auth/logout null é‚®ä»¶ç¡®è®¤ ğŸš€%100 POST /auth/confirm/{confirm_token} null Tokenåˆ·æ–° ğŸš€%100 GET /auth/refresh_token null ç”¨æˆ·è·å– ğŸš€%100 GET /user/ null ç”¨æˆ·åˆ é™¤ ğŸš€%100 POST /user/{email} null ç”¨æˆ·ç¦ç”¨/å¯ç”¨ ğŸš€%0 POST null ä»»åŠ¡æ·»åŠ  ğŸš€%0 POST null ä»»åŠ¡è·å– ğŸš€%0 GET null ä»»åŠ¡åˆ é™¤ ğŸš€%0 POST null ä»»åŠ¡ä¿®æ”¹ ğŸš€%0 PUT null APIæ·»åŠ  ğŸš€%0 POST ç¬¬ä¸‰æ–¹(ex:saltapi,zabbixapi) APIè·å– ğŸš€%0 GET ç¬¬ä¸‰æ–¹(ex:saltapi,zabbixapi) APIåˆ é™¤ ğŸš€%0 POST ç¬¬ä¸‰æ–¹(ex:saltapi,zabbixapi) APIä¿®æ”¹ ğŸš€%0 PUT ç¬¬ä¸‰æ–¹(ex:saltapi,zabbixapi) è®¾è®¡æ€è·¯:1.ç”¨æˆ·æƒé™ç®¡ç†é€šè¿‡è§’è‰²ç®¡ç†ï¼Œåˆ†ä¸ºuser,admin,saä¸‰ç§è§’è‰²2.é‡‡ç”¨äº†jwt tokenè®¤è¯æœºåˆ¶ï¼Œè®¿é—®èµ„æºå¿…é¡»æºå¸¦access_tokenä»¥éªŒè¯å…¶è®¿é—®èµ„æºçš„æƒé™â€¦â€¦","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"All","slug":"All","permalink":"https://blog.sctux.cc/tags/All/"}],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"é€šè¿‡Consul-Templateå®ç°åŠ¨æ€é…ç½®æœåŠ¡","slug":"tong-guoconsultemplate-shi-xian-dong-tai-pei-zhi-f","date":"2018-08-06T08:18:58.000Z","updated":"2025-09-01T01:59:08.932Z","comments":true,"path":"2018/08/06/tong-guoconsultemplate-shi-xian-dong-tai-pei-zhi-f/","permalink":"https://blog.sctux.cc/2018/08/06/tong-guoconsultemplate-shi-xian-dong-tai-pei-zhi-f/","excerpt":"èƒŒæ™¯:å…¬å¸çš„æµ‹è¯•ã€é¢„å‘å¸ƒç¯å¢ƒçš„é…ç½®ä¿®æ”¹åœ¨å‰æœŸéƒ½æ˜¯é€šè¿‡æ‰‹å·¥ç™»å½•åˆ°æœåŠ¡å™¨ä¸Šå»vimé…ç½®æ–‡ä»¶çš„ï¼Œè¿™æ ·ä¸€æ¥å°±ä¼šäº§ç”Ÿä¸€å®šçš„å®‰å…¨æˆ–è€…è¯¯æ“ä½œä»¥åŠé¢‘ç¹çš„æ“ä½œçœŸçš„æ˜¯æœ‰äº›æ¶å¿ƒçš„ï¼›å»å¹´åœ¨æ­¤åŸºç¡€ä¸Šä¹Ÿä¸ºè¿è¥/æµ‹è¯•ä½¿ç”¨Flask å†™äº†ä¸€ä¸ªå¹³å°è®©ä»–ä»¬è‡ªå·±ç”¨ï¼›ä½†æ˜¯ç”±äºä¸€äº›ä¸å®šå› ç´ ï¼Œä¸èƒ½å¤Ÿæ»¡è¶³è¿™æ–¹é¢çš„éœ€æ±‚ï¼›ä½†æ˜¯æœ¬äººè¿˜æ˜¯åšæŒä»¥è‡ªåŠ¨åŒ–çš„ç†å¿µæ¥æ“ä½œï¼›æ‰€ä»¥å­¦ä¹ äº†è§£äº†ä¸€ä¸‹è‡ªåŠ¨é…ç½®çš„ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚Consulï¼Œå½“ç„¶ä»–çš„åŸç†åŠŸèƒ½ç½‘ä¸Šæœ‰å¾ˆå¤šï¼›ä¹Ÿæ²¡æœ‰å¿…è¦åœ¨è¿™é‡Œå†ä¸€æ¬¡è¯´äº†ï¼›ä¸»è¦è®°å½•ä¸€ä¸‹å¯¹äºè¿™ä¸ªéœ€æ±‚çš„ä¸€ä¸ªæƒ³æ³•åˆ°å®ç°çš„è¿‡ç¨‹ã€‚â€å¦ˆå¦ˆå†ä¹Ÿä¸æ‹…å¿ƒæˆ‘vimé”™é…ç½®å•¦~~~ğŸ˜â€ è¿™æ˜¯å‰æœŸä¸ºè¿è¥äººå‘˜ä½¿ç”¨Flaskå¼€å‘çš„ä¸€ä¸ªå¹³å°,ä¸»è¦æ—¥å¸¸æ¶‰åŠåˆ°çš„æ“ä½œ(æµ‹è¯•/é¢„å‘å¸ƒç¯å¢ƒ)ï¿¼ ä¸‹é¢æ˜¯é’ˆå¯¹ä»¥ä¸Šä¸€äº›æ“ä½œè§„åˆ’çš„ä¸€ä¸ªæ‹“æ‰‘å›¾:ï¿¼ è¿™é‡Œæˆ‘ä¸»è¦ä½¿ç”¨åˆ°äº†consulçš„k/vå­˜å‚¨ä»¥åŠconsul-templateåŠ¨æ€çš„é…ç½®ç³»ç»Ÿ æ“ä½œäººå‘˜é€šè¿‡Opsplatformæ“ä½œåï¼Œé€šè¿‡è°ƒç”¨consul-http-apiå°†æœ€æ–°çš„key/value putåˆ°consul-datacenter; å®¢æˆ·ç«¯æœåŠ¡å™¨æ·»åŠ å¯¹åº”çš„æ¨¡æ¿æ–‡ä»¶ï¼Œé€šè¿‡consul-templateå‘½ä»¤å¯åŠ¨ç›‘æ§æ¨¡æ¿æ–‡ä»¶ å½“æœ‰æ–°çš„key/value putåˆ°consul-datacenteræ—¶ï¼Œconsul-templateæ ¹æ®æ¨¡æ¿æ–‡ä»¶æ›¿æ¢æ‰é‡Œé¢çš„kv åœ¨å¯åŠ¨ç›‘æ§æ¨¡æ¿æ–‡ä»¶æ—¶ä¹Ÿå¯ä»¥å¢åŠ åç»­çš„æ“ä½œï¼Œä¾‹å¦‚: ï¿¼ å®¢æˆ·ç«¯è¿æ¥åˆ°consul-http-apiï¼ŒæŒ‡å®šæ¨¡æ¿æ–‡ä»¶ä»¥åŠè¾“å‡ºæ–‡ä»¶ï¼Œç„¶åæŒ‡å®šæ¨¡æ¿æ–‡ä»¶æ›¿æ¢æˆåŠŸåæ‰§è¡Œå…¶ä»–å‘½ä»¤ä¾‹å¦‚ä¸Šå›¾ä¸­çš„dateå‘½ä»¤â€¦ æ•´ä¸ªè¿‡ç¨‹æ— éœ€äººå‘˜æ“ä½œã€‚ å½“ç„¶è¿™é‡Œåªæ˜¯ç”¨åˆ°äº†consulçš„å†°å±±ä¸€è§’ï¼Œä¹Ÿæ˜¯ä½œä¸ºä¸€ä¸ªæ–¹å‘å»å®ç°å„ç§éœ€æ±‚~ é€šè¿‡reqeustsæ¥æ“ä½œkey/valueï¿¼","text":"èƒŒæ™¯:å…¬å¸çš„æµ‹è¯•ã€é¢„å‘å¸ƒç¯å¢ƒçš„é…ç½®ä¿®æ”¹åœ¨å‰æœŸéƒ½æ˜¯é€šè¿‡æ‰‹å·¥ç™»å½•åˆ°æœåŠ¡å™¨ä¸Šå»vimé…ç½®æ–‡ä»¶çš„ï¼Œè¿™æ ·ä¸€æ¥å°±ä¼šäº§ç”Ÿä¸€å®šçš„å®‰å…¨æˆ–è€…è¯¯æ“ä½œä»¥åŠé¢‘ç¹çš„æ“ä½œçœŸçš„æ˜¯æœ‰äº›æ¶å¿ƒçš„ï¼›å»å¹´åœ¨æ­¤åŸºç¡€ä¸Šä¹Ÿä¸ºè¿è¥/æµ‹è¯•ä½¿ç”¨Flask å†™äº†ä¸€ä¸ªå¹³å°è®©ä»–ä»¬è‡ªå·±ç”¨ï¼›ä½†æ˜¯ç”±äºä¸€äº›ä¸å®šå› ç´ ï¼Œä¸èƒ½å¤Ÿæ»¡è¶³è¿™æ–¹é¢çš„éœ€æ±‚ï¼›ä½†æ˜¯æœ¬äººè¿˜æ˜¯åšæŒä»¥è‡ªåŠ¨åŒ–çš„ç†å¿µæ¥æ“ä½œï¼›æ‰€ä»¥å­¦ä¹ äº†è§£äº†ä¸€ä¸‹è‡ªåŠ¨é…ç½®çš„ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚Consulï¼Œå½“ç„¶ä»–çš„åŸç†åŠŸèƒ½ç½‘ä¸Šæœ‰å¾ˆå¤šï¼›ä¹Ÿæ²¡æœ‰å¿…è¦åœ¨è¿™é‡Œå†ä¸€æ¬¡è¯´äº†ï¼›ä¸»è¦è®°å½•ä¸€ä¸‹å¯¹äºè¿™ä¸ªéœ€æ±‚çš„ä¸€ä¸ªæƒ³æ³•åˆ°å®ç°çš„è¿‡ç¨‹ã€‚â€å¦ˆå¦ˆå†ä¹Ÿä¸æ‹…å¿ƒæˆ‘vimé”™é…ç½®å•¦~~~ğŸ˜â€ è¿™æ˜¯å‰æœŸä¸ºè¿è¥äººå‘˜ä½¿ç”¨Flaskå¼€å‘çš„ä¸€ä¸ªå¹³å°,ä¸»è¦æ—¥å¸¸æ¶‰åŠåˆ°çš„æ“ä½œ(æµ‹è¯•/é¢„å‘å¸ƒç¯å¢ƒ)ï¿¼ ä¸‹é¢æ˜¯é’ˆå¯¹ä»¥ä¸Šä¸€äº›æ“ä½œè§„åˆ’çš„ä¸€ä¸ªæ‹“æ‰‘å›¾:ï¿¼ è¿™é‡Œæˆ‘ä¸»è¦ä½¿ç”¨åˆ°äº†consulçš„k/vå­˜å‚¨ä»¥åŠconsul-templateåŠ¨æ€çš„é…ç½®ç³»ç»Ÿ æ“ä½œäººå‘˜é€šè¿‡Opsplatformæ“ä½œåï¼Œé€šè¿‡è°ƒç”¨consul-http-apiå°†æœ€æ–°çš„key/value putåˆ°consul-datacenter; å®¢æˆ·ç«¯æœåŠ¡å™¨æ·»åŠ å¯¹åº”çš„æ¨¡æ¿æ–‡ä»¶ï¼Œé€šè¿‡consul-templateå‘½ä»¤å¯åŠ¨ç›‘æ§æ¨¡æ¿æ–‡ä»¶ å½“æœ‰æ–°çš„key/value putåˆ°consul-datacenteræ—¶ï¼Œconsul-templateæ ¹æ®æ¨¡æ¿æ–‡ä»¶æ›¿æ¢æ‰é‡Œé¢çš„kv åœ¨å¯åŠ¨ç›‘æ§æ¨¡æ¿æ–‡ä»¶æ—¶ä¹Ÿå¯ä»¥å¢åŠ åç»­çš„æ“ä½œï¼Œä¾‹å¦‚: ï¿¼ å®¢æˆ·ç«¯è¿æ¥åˆ°consul-http-apiï¼ŒæŒ‡å®šæ¨¡æ¿æ–‡ä»¶ä»¥åŠè¾“å‡ºæ–‡ä»¶ï¼Œç„¶åæŒ‡å®šæ¨¡æ¿æ–‡ä»¶æ›¿æ¢æˆåŠŸåæ‰§è¡Œå…¶ä»–å‘½ä»¤ä¾‹å¦‚ä¸Šå›¾ä¸­çš„dateå‘½ä»¤â€¦ æ•´ä¸ªè¿‡ç¨‹æ— éœ€äººå‘˜æ“ä½œã€‚ å½“ç„¶è¿™é‡Œåªæ˜¯ç”¨åˆ°äº†consulçš„å†°å±±ä¸€è§’ï¼Œä¹Ÿæ˜¯ä½œä¸ºä¸€ä¸ªæ–¹å‘å»å®ç°å„ç§éœ€æ±‚~ é€šè¿‡reqeustsæ¥æ“ä½œkey/valueï¿¼","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"consul","slug":"consul","permalink":"https://blog.sctux.cc/tags/consul/"}],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"Kubernetes Sessionäº²å’Œæ€§è®¾ç½®","slug":"kubernetes-session-bao-chi-deng-she-zhi","date":"2018-07-15T04:12:31.000Z","updated":"2025-09-01T01:59:08.880Z","comments":true,"path":"2018/07/15/kubernetes-session-bao-chi-deng-she-zhi/","permalink":"https://blog.sctux.cc/2018/07/15/kubernetes-session-bao-chi-deng-she-zhi/","excerpt":"å½“æˆ‘ä»¬åœ¨éƒ¨ç½²äº†å¤šä¸ªpodï¼Œä»¥åŠä¸€ä¸ªServiceåï¼Œå°±å¯ä»¥åœ¨é›†ç¾¤å†…éƒ¨é€šè¿‡ServiceIPè®¿é—®podæä¾›çš„æœåŠ¡äº†ï¼›ï¿¼ï¿¼ å½“ä¸è®¾ç½®sessionä¿æŒæ—¶ï¼Œserviceå‘åå°podè½¬å‘è§„åˆ™æ˜¯è½®è¯¢:ï¿¼ï¿¼ï¿¼ä»¥ä¸Šæˆ‘é€šè¿‡ç‚¹å‡»é¡µé¢è¯·æ±‚ï¼Œå¯ä»¥å°±çœ‹å‡ºserviceå°†æˆ‘çš„è¯·æ±‚åˆ†å‘åˆ°äº†åé¢çš„ä¸‰ä¸ªpod; k8sä¼šæ ¹æ®è®¿é—®çš„ipæ¥æŠŠè¯·æ±‚è½¬å‘ç»™ä»–ä»¥å‰è®¿é—®è¿‡çš„podï¼Œè¿™æ ·sessionå°±ä¿æŒä½äº†ã€‚æŸ¥çœ‹åˆ›å»ºserviceæ—¶çš„yamlæ–‡ä»¶å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯ è¯¥é¡¹æ˜¯ä¸ºNoneçš„ï¿¼","text":"å½“æˆ‘ä»¬åœ¨éƒ¨ç½²äº†å¤šä¸ªpodï¼Œä»¥åŠä¸€ä¸ªServiceåï¼Œå°±å¯ä»¥åœ¨é›†ç¾¤å†…éƒ¨é€šè¿‡ServiceIPè®¿é—®podæä¾›çš„æœåŠ¡äº†ï¼›ï¿¼ï¿¼ å½“ä¸è®¾ç½®sessionä¿æŒæ—¶ï¼Œserviceå‘åå°podè½¬å‘è§„åˆ™æ˜¯è½®è¯¢:ï¿¼ï¿¼ï¿¼ä»¥ä¸Šæˆ‘é€šè¿‡ç‚¹å‡»é¡µé¢è¯·æ±‚ï¼Œå¯ä»¥å°±çœ‹å‡ºserviceå°†æˆ‘çš„è¯·æ±‚åˆ†å‘åˆ°äº†åé¢çš„ä¸‰ä¸ªpod; k8sä¼šæ ¹æ®è®¿é—®çš„ipæ¥æŠŠè¯·æ±‚è½¬å‘ç»™ä»–ä»¥å‰è®¿é—®è¿‡çš„podï¼Œè¿™æ ·sessionå°±ä¿æŒä½äº†ã€‚æŸ¥çœ‹åˆ›å»ºserviceæ—¶çš„yamlæ–‡ä»¶å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯ è¯¥é¡¹æ˜¯ä¸ºNoneçš„ï¿¼","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/tags/k8s/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"å¦‚ä½•å°†podä¸­çš„containeræ—¶åŒºæ›´æ”¹ä¸ºåŒä¸€æ—¶åŒºçš„åŸå¸‚æˆ–UTCæ—¶åŒºåç§»","slug":"ru-he-jiangpod-zhong-decontainer-shi-qu-geng-gai-w","date":"2018-07-14T07:55:49.000Z","updated":"2025-09-01T01:59:08.872Z","comments":true,"path":"2018/07/14/ru-he-jiangpod-zhong-decontainer-shi-qu-geng-gai-w/","permalink":"https://blog.sctux.cc/2018/07/14/ru-he-jiangpod-zhong-decontainer-shi-qu-geng-gai-w/","excerpt":"é—®é¢˜:åœ¨åˆ›å»ºpod containeråå‘ç°é‡Œé¢çš„æ—¶åŒºæ˜¯UTC,å¯¹äºå›½å†…ä¹ æƒ¯è¿˜æ˜¯CSTæ—¶åŒºæ¯”è¾ƒæ˜“è¯»ï¼›é‚£å¦‚ä½•è§£å†³è¿™ç§é—®é¢˜å˜›ï¼Ÿæš‚æ—¶æƒ³åˆ°çš„ä¸¤ç§åŠæ³•: [root@linux-node1 ~]# kubectl exec flask-app-nginx-66b56f556c-zb84s date -n flask-app-extions-stage Mon Jul 14 07:32:52 UTC 2018 [root@linux-node1 ~]# date Mon Jul 14 15:32:52 CST 2018 ç›´æ¥ä¿®æ”¹é•œåƒçš„æ—¶é—´è®¾ç½®ï¼Œå¥½å¤„æ˜¯åº”ç”¨éƒ¨ç½²æ—¶æ— éœ€ç‰¹æ®Šè®¾ç½®ï¼Œä½†æ˜¯éœ€è¦æ‰‹åŠ¨ä»æ–°æ„å»ºDockeré•œåƒ éƒ¨ç½²åº”ç”¨æ—¶ï¼Œå•ç‹¬è¯»å–ä¸»æœºçš„â€/etc/localtimeâ€,æ— éœ€ä¿®æ”¹é•œåƒï¼Œä½†æ˜¯æ¯ä¸ªåº”ç”¨éƒ½è¦å•ç‹¬è®¾ç½®ã€‚ è§£å†³:ä¸ºäº†å¿«é€Ÿï¼Œç®€å•çš„è§£å†³æ­¤é—®é¢˜ï¼Œå…ˆä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼›yamlæ–‡ä»¶ä¸­æ˜ å°„ä¸»æœºçš„â€/etc/localtimeâ€æ–‡ä»¶, æ·»åŠ yamlé…ç½®: ...... ...... spec: containers: - name: nginx image: nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 volumeMounts: - name: nginx-conf mountPath: \"/etc/nginx/nginx.conf\" subPath: nginx.conf - name: host-time mountPath: /etc/localtime volumes: - name: nginx-conf configMap: name: nginx-conf - name: host-time hostPath: path: /usr/share/zoneinfo/Asia/Shanghai ...... ...... [root@linux-node1 flask_app_nginx]# kubectl apply -f flask_app_nginx_deploy.yaml [root@linux-node1 flask_app_nginx]# kubectl exec flask-app-nginx-f4d9759b4-xq4rk date -n flask-app-extions-stage Mon Jul 14 15:50:29 CST 2018 [root@linux-node1 flask_app_nginx]# date Mon Jul 14 15:50:29 CST 2018 # ä»¥ä¸Šï¼Œå°±å®Œæˆäº†pod containerçš„æ—¶åŒºä¿®æ”¹é—®é¢˜... å…¶å®è¿˜æœ‰ä¸€ç§æ–¹æ³•å°±æ˜¯å°† /usr/share/zoneinfo/Asia/Shanghai è¿™ä¸ªæ–‡ä»¶åšæˆä¹‹å‰æˆ‘æŒ‚è½½nginxé…ç½®æ–‡ä»¶é‚£æ ·é€šè¿‡ConfigMapçš„å½¢å¼æŒ‚è½½.","text":"é—®é¢˜:åœ¨åˆ›å»ºpod containeråå‘ç°é‡Œé¢çš„æ—¶åŒºæ˜¯UTC,å¯¹äºå›½å†…ä¹ æƒ¯è¿˜æ˜¯CSTæ—¶åŒºæ¯”è¾ƒæ˜“è¯»ï¼›é‚£å¦‚ä½•è§£å†³è¿™ç§é—®é¢˜å˜›ï¼Ÿæš‚æ—¶æƒ³åˆ°çš„ä¸¤ç§åŠæ³•: [root@linux-node1 ~]# kubectl exec flask-app-nginx-66b56f556c-zb84s date -n flask-app-extions-stage Mon Jul 14 07:32:52 UTC 2018 [root@linux-node1 ~]# date Mon Jul 14 15:32:52 CST 2018 ç›´æ¥ä¿®æ”¹é•œåƒçš„æ—¶é—´è®¾ç½®ï¼Œå¥½å¤„æ˜¯åº”ç”¨éƒ¨ç½²æ—¶æ— éœ€ç‰¹æ®Šè®¾ç½®ï¼Œä½†æ˜¯éœ€è¦æ‰‹åŠ¨ä»æ–°æ„å»ºDockeré•œåƒ éƒ¨ç½²åº”ç”¨æ—¶ï¼Œå•ç‹¬è¯»å–ä¸»æœºçš„â€/etc/localtimeâ€,æ— éœ€ä¿®æ”¹é•œåƒï¼Œä½†æ˜¯æ¯ä¸ªåº”ç”¨éƒ½è¦å•ç‹¬è®¾ç½®ã€‚ è§£å†³:ä¸ºäº†å¿«é€Ÿï¼Œç®€å•çš„è§£å†³æ­¤é—®é¢˜ï¼Œå…ˆä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼›yamlæ–‡ä»¶ä¸­æ˜ å°„ä¸»æœºçš„â€/etc/localtimeâ€æ–‡ä»¶, æ·»åŠ yamlé…ç½®: ...... ...... spec: containers: - name: nginx image: nginx:latest imagePullPolicy: IfNotPresent ports: - containerPort: 80 volumeMounts: - name: nginx-conf mountPath: \"/etc/nginx/nginx.conf\" subPath: nginx.conf - name: host-time mountPath: /etc/localtime volumes: - name: nginx-conf configMap: name: nginx-conf - name: host-time hostPath: path: /usr/share/zoneinfo/Asia/Shanghai ...... ...... [root@linux-node1 flask_app_nginx]# kubectl apply -f flask_app_nginx_deploy.yaml [root@linux-node1 flask_app_nginx]# kubectl exec flask-app-nginx-f4d9759b4-xq4rk date -n flask-app-extions-stage Mon Jul 14 15:50:29 CST 2018 [root@linux-node1 flask_app_nginx]# date Mon Jul 14 15:50:29 CST 2018 # ä»¥ä¸Šï¼Œå°±å®Œæˆäº†pod containerçš„æ—¶åŒºä¿®æ”¹é—®é¢˜... å…¶å®è¿˜æœ‰ä¸€ç§æ–¹æ³•å°±æ˜¯å°† /usr/share/zoneinfo/Asia/Shanghai è¿™ä¸ªæ–‡ä»¶åšæˆä¹‹å‰æˆ‘æŒ‚è½½nginxé…ç½®æ–‡ä»¶é‚£æ ·é€šè¿‡ConfigMapçš„å½¢å¼æŒ‚è½½.","categories":[{"name":"è™šæ‹ŸåŒ–&amp;äº‘è®¡ç®—&amp;å¤§æ•°æ®","slug":"è™šæ‹ŸåŒ–-amp-äº‘è®¡ç®—-amp-å¤§æ•°æ®","permalink":"https://blog.sctux.cc/categories/%E8%99%9A%E6%8B%9F%E5%8C%96-amp-%E4%BA%91%E8%AE%A1%E7%AE%97-amp-%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/tags/k8s/"}],"keywords":[{"name":"è™šæ‹ŸåŒ–&amp;äº‘è®¡ç®—&amp;å¤§æ•°æ®","slug":"è™šæ‹ŸåŒ–-amp-äº‘è®¡ç®—-amp-å¤§æ•°æ®","permalink":"https://blog.sctux.cc/categories/%E8%99%9A%E6%8B%9F%E5%8C%96-amp-%E4%BA%91%E8%AE%A1%E7%AE%97-amp-%E5%A4%A7%E6%95%B0%E6%8D%AE/"}]},{"title":"How to Change Ingress-Nginx Nginx's Configurationï¼Ÿ","slug":"how-to-change-ingressnginx-nginxs-configuration","date":"2018-07-03T05:51:33.000Z","updated":"2025-09-01T01:59:08.921Z","comments":true,"path":"2018/07/03/how-to-change-ingressnginx-nginxs-configuration/","permalink":"https://blog.sctux.cc/2018/07/03/how-to-change-ingressnginx-nginxs-configuration/","excerpt":"åºä»Šå¤©è®¿é—®äº†ä¸€ä¸‹ä¹‹å‰æ­å»ºçš„é‚£å¥—k8såº”ç”¨ï¼Œå½“æˆ‘å®¢æˆ·ç«¯é€šè¿‡åŸŸåè®¿é—®(ingress-nginxé€šè¿‡åŸŸåè½¬å‘è¯·æ±‚åˆ°åç«¯)æ—¶ï¼Œå‡ºç°äº†504çš„æƒ…å†µï¼›ç¬¬ä¸€æƒ³åˆ°çš„å°±æ˜¯å½“åç«¯ä¸€ç›´æ²¡è¿”å›æ—¶ï¼›proxyè¶…æ—¶äº†ï¼› 192.168.56.1 - [192.168.56.1] - - [03/Jul/2018:09:16:54 +0000] \"GET / HTTP/1.1\" 504 586 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36\" 412 10.002 [flask-app-extions-stage-flask-app-nginx-80] 10.2.17.5:80 0 10.003 504 497fe6db73abcd3ed749fdc646870432 # å“åº”10.003ç§’å°±æŠ¥504ğŸ˜¢ ï¿¼é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œ,ingress-nginxä»£ç†ç”¨æˆ·è¯·æ±‚åˆ°flask-app-nginx SVCï¿¼ è€Œä¸”åç«¯åœ¨é›†ç¾¤å†…éƒ¨ç›´æ¥è®¿é—®åº”ç”¨çš„ClusterIPæ˜¯æ²¡æœ‰é—®é¢˜ï¼›ï¿¼ é‚£è§£å†³åŠæ³•å°±æ˜¯ä¿®æ”¹ingress-nginx çš„nginxé…ç½®ï¼›å‰é¢å®éªŒä¸­æˆ‘ä½¿ç”¨äº†configmapæ¥æŒ‚nginxé…ç½®ï¼Œingerss-nginxçš„é…ç½®ä¹Ÿæ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåªæ˜¯è¯´å®ç°çš„æ–¹å¼ä¸ä¸€æ ·ï¼›ä»–æ˜¯åœ¨åˆ›å»ºäº†ingressä¹‹åæ ¹æ®è§„åˆ™ç”Ÿæˆçš„nginxé…ç½®ï¼›è¿›å…¥podå®¹å™¨ä¸­å‘ç°é»˜è®¤çš„nginxé…ç½®å‚æ•°ä¸º: proxy_connect_timeout 5s; proxy_send_timeout 60s; proxy_read_timeout 60s; è¿™ä¸ªæ—¶é—´è¿˜æ˜¯è›®çŸ­çš„ï¼Œæ‰€ä»¥æˆ‘éœ€è¦ä¿®æ”¹å®ƒï¼Œé‚£å’‹ä¸ªä¿®æ”¹å˜›ï¼Ÿä¸å¯èƒ½vi nginx.conf ç„¶åä¿å­˜ï¼Œå†ä»æ–°reload podï¼Ÿ è¿™æ ·èƒ½è§£å†³ï¼Œä½†æ˜¯ä¸åˆç†ï¼Œäºæ˜¯å®˜ç½‘æä¾›ç»™äº†è¿™ç§æ–¹å¼:https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/ä¹Ÿå°±æ˜¯åœ¨å®˜æ–¹æä¾›çš„configmap.yamlä¸­ æ·»åŠ è¦†ç›–åŸæœ‰é»˜è®¤å€¼ [root@linux-node1 ingress-nginx]# more configmap.yaml kind: ConfigMap apiVersion: v1 metadata: name: nginx-configuration namespace: ingress-nginx labels: app: ingress-nginx data: proxy-connect-timeout: \"30\" proxy-read-timeout: \"120\" proxy-send-timeout: \"120\" ç„¶åapplyä¸€ä¸‹","text":"åºä»Šå¤©è®¿é—®äº†ä¸€ä¸‹ä¹‹å‰æ­å»ºçš„é‚£å¥—k8såº”ç”¨ï¼Œå½“æˆ‘å®¢æˆ·ç«¯é€šè¿‡åŸŸåè®¿é—®(ingress-nginxé€šè¿‡åŸŸåè½¬å‘è¯·æ±‚åˆ°åç«¯)æ—¶ï¼Œå‡ºç°äº†504çš„æƒ…å†µï¼›ç¬¬ä¸€æƒ³åˆ°çš„å°±æ˜¯å½“åç«¯ä¸€ç›´æ²¡è¿”å›æ—¶ï¼›proxyè¶…æ—¶äº†ï¼› 192.168.56.1 - [192.168.56.1] - - [03/Jul/2018:09:16:54 +0000] \"GET / HTTP/1.1\" 504 586 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36\" 412 10.002 [flask-app-extions-stage-flask-app-nginx-80] 10.2.17.5:80 0 10.003 504 497fe6db73abcd3ed749fdc646870432 # å“åº”10.003ç§’å°±æŠ¥504ğŸ˜¢ ï¿¼é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œ,ingress-nginxä»£ç†ç”¨æˆ·è¯·æ±‚åˆ°flask-app-nginx SVCï¿¼ è€Œä¸”åç«¯åœ¨é›†ç¾¤å†…éƒ¨ç›´æ¥è®¿é—®åº”ç”¨çš„ClusterIPæ˜¯æ²¡æœ‰é—®é¢˜ï¼›ï¿¼ é‚£è§£å†³åŠæ³•å°±æ˜¯ä¿®æ”¹ingress-nginx çš„nginxé…ç½®ï¼›å‰é¢å®éªŒä¸­æˆ‘ä½¿ç”¨äº†configmapæ¥æŒ‚nginxé…ç½®ï¼Œingerss-nginxçš„é…ç½®ä¹Ÿæ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåªæ˜¯è¯´å®ç°çš„æ–¹å¼ä¸ä¸€æ ·ï¼›ä»–æ˜¯åœ¨åˆ›å»ºäº†ingressä¹‹åæ ¹æ®è§„åˆ™ç”Ÿæˆçš„nginxé…ç½®ï¼›è¿›å…¥podå®¹å™¨ä¸­å‘ç°é»˜è®¤çš„nginxé…ç½®å‚æ•°ä¸º: proxy_connect_timeout 5s; proxy_send_timeout 60s; proxy_read_timeout 60s; è¿™ä¸ªæ—¶é—´è¿˜æ˜¯è›®çŸ­çš„ï¼Œæ‰€ä»¥æˆ‘éœ€è¦ä¿®æ”¹å®ƒï¼Œé‚£å’‹ä¸ªä¿®æ”¹å˜›ï¼Ÿä¸å¯èƒ½vi nginx.conf ç„¶åä¿å­˜ï¼Œå†ä»æ–°reload podï¼Ÿ è¿™æ ·èƒ½è§£å†³ï¼Œä½†æ˜¯ä¸åˆç†ï¼Œäºæ˜¯å®˜ç½‘æä¾›ç»™äº†è¿™ç§æ–¹å¼:https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/ä¹Ÿå°±æ˜¯åœ¨å®˜æ–¹æä¾›çš„configmap.yamlä¸­ æ·»åŠ è¦†ç›–åŸæœ‰é»˜è®¤å€¼ [root@linux-node1 ingress-nginx]# more configmap.yaml kind: ConfigMap apiVersion: v1 metadata: name: nginx-configuration namespace: ingress-nginx labels: app: ingress-nginx data: proxy-connect-timeout: \"30\" proxy-read-timeout: \"120\" proxy-send-timeout: \"120\" ç„¶åapplyä¸€ä¸‹ kubectl apply -f configmap.yaml åœ¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤çš„æ—¶å€™podä¼šå»é‡æ–°åŠ è½½é…ç½®configmapçš„ä¿¡æ¯é€šè¿‡podçš„æ—¥å¿—å¯ä»¥çœ‹åˆ°: [root@linux-node1 ~]# kubectl logs -f pod/nginx-ingress-controller-t9jh9 -n ingress-nginx I0703 10:21:24.014062 5 event.go:218] Event(v1.ObjectReference{Kind:\"ConfigMap\", Namespace:\"ingress-nginx\", Name:\"nginx-configuration\", UID:\"df01bd6b-79f4-11e8-95a2-000c29c6d12b\", APIVersion:\"v1\", ResourceVersion:\"1013650\", FieldPath:\"\"}): type: 'Normal' reason: 'UPDATE' ConfigMap ingress-nginx/nginx-configuration I0703 10:21:24.015721 5 controller.go:169] Configuration changes detected, backend reload required. I0703 10:21:24.539971 5 controller.go:179] Backend successfully reloaded. å†ä¸€æ¬¡è¿›å…¥å®¹å™¨æŸ¥çœ‹nginxçš„é…ç½®å‚æ•°æ˜¯å¦æ”¹å˜: proxy_connect_timeout 30s; proxy_send_timeout 120s; proxy_read_timeout 120s; å¯ä»¥çœ‹åˆ°åŸæ¥é»˜è®¤çš„é…ç½®å‚æ•°å€¼å·²ç»ä¿®æ”¹æˆåŠŸï¼›å®¢æˆ·ç«¯å†æ¬¡è®¿é—®å°±ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜äº†ï¼šï¿¼","categories":[{"name":"Docker","slug":"Docker","permalink":"https://blog.sctux.cc/categories/Docker/"},{"name":"è™šæ‹ŸåŒ–&amp;äº‘è®¡ç®—&amp;å¤§æ•°æ®","slug":"Docker/è™šæ‹ŸåŒ–-amp-äº‘è®¡ç®—-amp-å¤§æ•°æ®","permalink":"https://blog.sctux.cc/categories/Docker/%E8%99%9A%E6%8B%9F%E5%8C%96-amp-%E4%BA%91%E8%AE%A1%E7%AE%97-amp-%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"Docker","slug":"Docker","permalink":"https://blog.sctux.cc/categories/Docker/"},{"name":"è™šæ‹ŸåŒ–&amp;äº‘è®¡ç®—&amp;å¤§æ•°æ®","slug":"Docker/è™šæ‹ŸåŒ–-amp-äº‘è®¡ç®—-amp-å¤§æ•°æ®","permalink":"https://blog.sctux.cc/categories/Docker/%E8%99%9A%E6%8B%9F%E5%8C%96-amp-%E4%BA%91%E8%AE%A1%E7%AE%97-amp-%E5%A4%A7%E6%95%B0%E6%8D%AE/"}]},{"title":"åŠå›è«æƒœé‡‘ç¼•è¡£ï¼ŒåŠå›æƒœå–å°‘å¹´æ—¶ã€‚","slug":"e5-8a-9d-e5-90-9b-e8-8e-ab-e6-83-9c-e9-87-91-e7-bc-95-e8-a1-a3-ef-bc-8c-e5-8a-9d-e5-90-9b-e6-83-9c-e5-8f-96-e5-b0-91-e5-b9-b4-e6-97-b6-e3-80-82-trashed","date":"2018-07-02T12:32:00.000Z","updated":"2025-09-01T01:59:08.869Z","comments":true,"path":"2018/07/02/e5-8a-9d-e5-90-9b-e8-8e-ab-e6-83-9c-e9-87-91-e7-bc-95-e8-a1-a3-ef-bc-8c-e5-8a-9d-e5-90-9b-e6-83-9c-e5-8f-96-e5-b0-91-e5-b9-b4-e6-97-b6-e3-80-82-trashed/","permalink":"https://blog.sctux.cc/2018/07/02/e5-8a-9d-e5-90-9b-e8-8e-ab-e6-83-9c-e9-87-91-e7-bc-95-e8-a1-a3-ef-bc-8c-e5-8a-9d-e5-90-9b-e6-83-9c-e5-8f-96-e5-b0-91-e5-b9-b4-e6-97-b6-e3-80-82-trashed/","excerpt":"äººç”ŸçŸ­çŸ­å‡ åå¹´ã€å·¥ä½œã€å­¦ä¹ (ä¸“ä¸šæŠ€èƒ½çŸ¥è¯†)ä¹Ÿè®¸å°±å äº†æˆ‘ä»¬ç”Ÿå‘½ä¸­çš„å¤§éƒ¨åˆ†çš„æ—¶é—´ã€ä¹Ÿæ˜¯æˆ‘ä»¬ç”Ÿå­˜ä¸‹æ¥çš„åŸºç¡€ã€‚ä½†æ˜¯èƒ½ä¸èƒ½åœ¨è¿™åŸºç¡€ä¹‹ä¸Šæ‰¾ç‚¹ç¼éš™å­¦ä¹ ã€å°è¯•ä¸€äº›ä¸ä¸€æ ·çš„ä¸œè¥¿å‘¢ï¼Œè¿™ä¸ªè¿˜æ˜¯çœ‹ä¸ªäººå§~~~æˆ‘ä¸ªäººå€’æ˜¯ç°åœ¨é™¤äº†å·¥ä½œã€å­¦ä¹ è¿˜æ˜¯éœ€è¦åŸ¹å…»ä¸€ç‚¹å…¶ä»–çš„å…´è¶£çˆ±å¥½ï¼Œä»å„ä¸ªæ–¹é¢ä¸æ–­ä¸°å¯Œã€å®Œå–„è‡ªå·±ã€‚ å›æƒ³èµ·å¹´å¹¼æ—¶çˆ¶äº²ç”¨æœ€ä¸¥å‰çš„æ–¹å¼é€¼ç€æˆ‘ç»ƒå­—ï¼Œå½“æ—¶æ ¹æœ¬ä¸æ‡‚ä¸ºä»€ä¹ˆéè¦é€¼ç€æˆ‘ç»ƒä¹ ï¼Œç°åœ¨å›æƒ³èµ·æ¥æˆ‘åªèƒ½æ‰“å¿ƒåº•çš„æ„Ÿæ¿€çˆ¶äº²è®©æˆ‘æœ‰äº†è¿™ä¸ªä¹ æƒ¯æˆ–è€…è¯´æ˜¯åŸ¹å…»äº†æˆ‘è¿™ä¸ªå…´è¶£çˆ±å¥½ã€‚ä»¥è‡³äºèƒ½å†™å‡ºè¿˜ç®—æ‹¿å¾—å‡ºæ‰‹çš„å­—ä½“ã€‚ åŠå›è«æƒœé‡‘ç¼•è¡£ï¼ŒåŠå›æƒœå–å°‘å¹´æ—¶ã€‚ èŠ±å¼€å ªæŠ˜ç›´é¡»æŠ˜ï¼Œè«å¾…èŠ±å¼€ç©ºæŠ˜æã€‚","text":"äººç”ŸçŸ­çŸ­å‡ åå¹´ã€å·¥ä½œã€å­¦ä¹ (ä¸“ä¸šæŠ€èƒ½çŸ¥è¯†)ä¹Ÿè®¸å°±å äº†æˆ‘ä»¬ç”Ÿå‘½ä¸­çš„å¤§éƒ¨åˆ†çš„æ—¶é—´ã€ä¹Ÿæ˜¯æˆ‘ä»¬ç”Ÿå­˜ä¸‹æ¥çš„åŸºç¡€ã€‚ä½†æ˜¯èƒ½ä¸èƒ½åœ¨è¿™åŸºç¡€ä¹‹ä¸Šæ‰¾ç‚¹ç¼éš™å­¦ä¹ ã€å°è¯•ä¸€äº›ä¸ä¸€æ ·çš„ä¸œè¥¿å‘¢ï¼Œè¿™ä¸ªè¿˜æ˜¯çœ‹ä¸ªäººå§~~~æˆ‘ä¸ªäººå€’æ˜¯ç°åœ¨é™¤äº†å·¥ä½œã€å­¦ä¹ è¿˜æ˜¯éœ€è¦åŸ¹å…»ä¸€ç‚¹å…¶ä»–çš„å…´è¶£çˆ±å¥½ï¼Œä»å„ä¸ªæ–¹é¢ä¸æ–­ä¸°å¯Œã€å®Œå–„è‡ªå·±ã€‚ å›æƒ³èµ·å¹´å¹¼æ—¶çˆ¶äº²ç”¨æœ€ä¸¥å‰çš„æ–¹å¼é€¼ç€æˆ‘ç»ƒå­—ï¼Œå½“æ—¶æ ¹æœ¬ä¸æ‡‚ä¸ºä»€ä¹ˆéè¦é€¼ç€æˆ‘ç»ƒä¹ ï¼Œç°åœ¨å›æƒ³èµ·æ¥æˆ‘åªèƒ½æ‰“å¿ƒåº•çš„æ„Ÿæ¿€çˆ¶äº²è®©æˆ‘æœ‰äº†è¿™ä¸ªä¹ æƒ¯æˆ–è€…è¯´æ˜¯åŸ¹å…»äº†æˆ‘è¿™ä¸ªå…´è¶£çˆ±å¥½ã€‚ä»¥è‡³äºèƒ½å†™å‡ºè¿˜ç®—æ‹¿å¾—å‡ºæ‰‹çš„å­—ä½“ã€‚ åŠå›è«æƒœé‡‘ç¼•è¡£ï¼ŒåŠå›æƒœå–å°‘å¹´æ—¶ã€‚ èŠ±å¼€å ªæŠ˜ç›´é¡»æŠ˜ï¼Œè«å¾…èŠ±å¼€ç©ºæŠ˜æã€‚","categories":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}],"tags":[],"keywords":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}]},{"title":"10-K8sé›†ç¾¤æ­å»º---æ–°å¢NodeèŠ‚ç‚¹","slug":"10k8s-ji-qun-da-jianxin-zengnode-jie-dian","date":"2018-06-29T07:29:10.000Z","updated":"2025-09-01T01:59:08.984Z","comments":true,"path":"2018/06/29/10k8s-ji-qun-da-jianxin-zengnode-jie-dian/","permalink":"https://blog.sctux.cc/2018/06/29/10k8s-ji-qun-da-jianxin-zengnode-jie-dian/","excerpt":"ä»€ä¹ˆï¼Ÿèµ„æºä¸å¤Ÿç”¨äº†ï¼Ÿ æ€¼æœåŠ¡å™¨é…ç½®å•Š(å‘ä¸Šæ‰©å±•)ï¼Œæ€¼æœºå™¨å•Š(æ¨ªå‘æ‰©å±•)ï¼ (æ³¨: è¯¥èŠ‚ç‚¹æ·»åŠ æ˜¯åŸºäºä¹‹å‰k8sé›†ç¾¤æ­å»ºçš„ç¯å¢ƒè¿›è¡Œ) 1.ç³»ç»Ÿåˆå§‹åŒ–:a. ä¸»æœºåé…ç½® node4: echo \"linux-node4.example.com\" &gt; /etc/hostname b. è®¾ç½®/etc/hostsä¿è¯ä¸»æœºåèƒ½å¤Ÿè§£æ node4: echo \"192.168.56.14 linux-node4 linux-node4.example.com\" &gt;&gt; /etc/hosts c. å…³é—­SELinuxåŠé˜²ç«å¢™ node4: systemctl disable firewalld; systemctl stop firewalld sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config d. ç¯å¢ƒå˜é‡é…ç½®(åç»­k8sç›¸å…³å‘½ä»¤éƒ½ä¼šæ”¾åˆ°/opt/kubernetes/binç›®å½•ä¸‹)","text":"ä»€ä¹ˆï¼Ÿèµ„æºä¸å¤Ÿç”¨äº†ï¼Ÿ æ€¼æœåŠ¡å™¨é…ç½®å•Š(å‘ä¸Šæ‰©å±•)ï¼Œæ€¼æœºå™¨å•Š(æ¨ªå‘æ‰©å±•)ï¼ (æ³¨: è¯¥èŠ‚ç‚¹æ·»åŠ æ˜¯åŸºäºä¹‹å‰k8sé›†ç¾¤æ­å»ºçš„ç¯å¢ƒè¿›è¡Œ) 1.ç³»ç»Ÿåˆå§‹åŒ–:a. ä¸»æœºåé…ç½® node4: echo \"linux-node4.example.com\" &gt; /etc/hostname b. è®¾ç½®/etc/hostsä¿è¯ä¸»æœºåèƒ½å¤Ÿè§£æ node4: echo \"192.168.56.14 linux-node4 linux-node4.example.com\" &gt;&gt; /etc/hosts c. å…³é—­SELinuxåŠé˜²ç«å¢™ node4: systemctl disable firewalld; systemctl stop firewalld sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config d. ç¯å¢ƒå˜é‡é…ç½®(åç»­k8sç›¸å…³å‘½ä»¤éƒ½ä¼šæ”¾åˆ°/opt/kubernetes/binç›®å½•ä¸‹) echo \"PATH=$PATH:$HOME/bin:/opt/kubernetes/bin\" &gt;&gt; ~/.bash_profile source ~/.bash_profile 4.å®‰è£…Dockeraï¼šä½¿ç”¨å›½å†…Dockeræº [root@linux-node4 ~]# cd /etc/yum.repos.d/ [root@linux-node4 yum.repos.d]# wget \\ https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo bï¼šDockerå®‰è£…ï¼š [root@linux-node4 ~]# yum install -y docker-ce cï¼šå¯åŠ¨åå°è¿›ç¨‹ï¼š [root@linux-node4 ~]# systemctl enable docker [root@linux-node4 ~]# systemctl start docker 5.å‡†å¤‡éƒ¨ç½²ç›®å½•[root@linux-node4 ~]# mkdir -p /opt/kubernetes/{cfg,bin,ssl,log} # ç›®å½•ç»“æ„, æ‰€æœ‰æ–‡ä»¶å‡å­˜æ”¾åœ¨/opt/kubernetesç›®å½•ä¸‹ï¼š [root@linux-node4 ~]# tree -L 1 /opt/kubernetes/ /opt/kubernetes/ â”œâ”€â”€ bin #äºŒè¿›åˆ¶æ–‡ä»¶ â”œâ”€â”€ cfg #é…ç½®æ–‡ä»¶ â”œâ”€â”€ log #æ—¥å¿—æ–‡ä»¶ â””â”€â”€ ssl #è¯ä¹¦æ–‡ä»¶ 6.åšå¥½masterèŠ‚ç‚¹è·Ÿå…¶ä»–nodeèŠ‚ç‚¹çš„sshäº’ä¿¡,ä¾¿äºæ­å»º[root@linux-node1 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.56.14 7.æ‹·è´é…ç½®(from master)1.æ‹·è´CFSSL[root@linux-node1 ~]# scp /opt/kubernetes/bin/cfssl* 192.168.56.14:/opt/kubernetes/bin 2.åˆ†å‘è¯ä¹¦[root@linux-node1 ssl]# scp ca.csr ca.pem ca-key.pem ca-config.json 192.168.56.14:/opt/kubernetes/ssl 3.æ‹·è´kubernetes è¯ä¹¦å’Œç§é’¥[root@linux-node1 ssl]# scp /opt/kubernetes/ssl/kubernetes*.pem 192.168.56.14:/opt/kubernetes/ssl/ 4.æ‹·è´kubeletï¼Œkube-proxyè½¯ä»¶åŒ…[root@linux-node1 ~]# cd /usr/local/src/kubernetes/server/bin/ [root@linux-node1 bin]# scp kubelet kube-proxy 192.168.56.14:/opt/kubernetes/bin/ 5.æ‹·è´è§’è‰²ç»‘å®šæ–‡ä»¶[root@linux-node1 ~]# scp /opt/kubernetes/cfg/bootstrap.kubeconfig 192.168.56.14:/opt/kubernetes/cfg 6.æ‹·è´CNIæ”¯æŒé…ç½®[root@linux-node1 ~]# ssh linux-node4 \"mkdir /etc/cni/net.d -p\" [root@linux-node1 ~]# scp /etc/cni/net.d/10-default.conf linux-node4:/etc/cni/net.d/ 7.åˆ›å»ºkubeletæ‰€éœ€ç›®å½•[root@linux-node1 ~]# ssh linux-node4 \"mkdir /var/lib/kubelet\" 8.æ‹·è´Flannelç½‘ç»œè¯ä¹¦[root@linux-node1 ~]# scp /opt/kubernetes/ssl/flanneld*.pem 192.168.56.14:/opt/kubernetes/ssl/ 9.å¤åˆ¶flannerç›¸å…³è½¯ä»¶åŒ…[root@linux-node1 ~]# ssh linux-node4 \"mkdir /opt/kubernetes/bin/cni\" [root@linux-node1 ~]# scp /opt/kubernetes/bin/cni/* 192.168.56.14:/opt/kubernetes/bin/cni/ [root@linux-node1 ~]# scp /usr/lib/systemd/system/flannel.service 192.168.56.14:/usr/lib/systemd/system/ [root@linux-node1 ~]# scp /opt/kubernetes/cfg/flannel 192.168.56.14:/opt/kubernetes/cfg/ [root@linux-node1 ~]# cd /usr/local/src [root@linux-node1 src]# scp flanneld mk-docker-opts.sh 192.168.56.14:/opt/kubernetes/bin/ [root@linux-node1 src]# cd /usr/local/src/kubernetes/cluster/centos/node/bin/ [root@linux-node1 bin]# scp remove-docker0.sh 192.168.56.14:/opt/kubernetes/bin/ # docker æœåŠ¡è„šæœ¬ [root@linux-node1 bin]# scp /usr/lib/systemd/system/docker.service 192.168.56.14:/usr/lib/systemd/system/ 10.æ‹·è´kubeletç³»ç»ŸæœåŠ¡é…ç½®[root@linux-node1 ~]# scp /usr/lib/systemd/system/kubelet.service 192.168.56.14:/usr/lib/systemd/system/ [root@linux-node1 ~]# ssh linux-node4 \"systemctl daemon-reload\" [root@linux-node1 ~]# ssh linux-node4 \"systemctl enable kubelet\" [root@linux-node1 ~]# ssh linux-node4 \"systemctl start kubelet\" [root@linux-node1 ~]# ssh linux-node4 \"systemctl status kubelet\" # ç„¶ååœ¨node1èŠ‚ç‚¹æŸ¥çœ‹TLSè¯ä¹¦è¯·æ±‚ï¼Œé€šè¿‡ä»¥ä¸‹å°±è¡Œäº†ï¼Œå¦‚æœç»“æœä¸ºç©ºï¼Œå°±éœ€è¦æŸ¥çœ‹kubeletçš„æ—¥å¿—å•¦ï¼Œåæ­£æˆ‘åœ¨è¿™é‡Œå°±è·³è¿›äº†ä¸€å›è‡ªå·±æŒ–çš„å‘o(â•¥ï¹â•¥)o [root@linux-node1 ~]# kubectl get csr [root@linux-node1 ~]# kubectl get csr|grep 'Pending' | awk 'NR&gt;0{print $1}'| xargs kubectl certificate [root@linux-node1 ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION 192.168.56.11 Ready master 1d v1.10.1 192.168.56.12 Ready node 31d v1.10.1 192.168.56.13 Ready node 31d v1.10.1 192.168.56.14 Ready node 1d v1.10.1 # ä»¥ä¸Šï¼Œæ–°çš„è®¡ç®—èŠ‚ç‚¹192.168.56.14å·²ç»æˆåŠŸæ·»åŠ  11.é…ç½®kube-proxyä½¿ç”¨LVS[root@linux-node4 ~]# yum install -y ipvsadm ipset conntrack 12.åˆ†å‘kube-proxyè¯ä¹¦[root@linux-node1 ssl]# scp kube-proxy*.pem 192.168.56.14:/opt/kubernetes/ssl/ 13.åˆ†å‘kubeconfigé…ç½®æ–‡ä»¶[root@linux-node1 ssl]# scp ../cfg/kube-proxy.kubeconfig 192.168.56.14:/opt/kubernetes/cfg/ 14.å®‰è£…nfs(å› ä¸ºnodeèŠ‚ç‚¹ä½œä¸ºå®¢æˆ·ç«¯ä¹Ÿéœ€è¦å®‰è£…nfså®¢æˆ·ç«¯å·¥å…·)[root@linux-node1 ssl]# ssh linux-node4 \"yum -y install nfs-utils rpcbind\" 15.åˆ›å»ºå·¥ä½œç›®å½•[root@linux-node1 ~]# ssh linux-node4 \"mkdir /var/lib/kube-proxy\" 16.æ‹·è´æœåŠ¡é…ç½®æ–‡ä»¶[root@linux-node1 ~]# cp /usr/lib/systemd/system/kube-proxy.service 192.168.56.14:/usr/lib/systemd/system/kube-proxy.service # æ³¨æ„éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶çš„IP [root@linux-node1 ~]# ssh linux-node4 \"systemctl daemon-reload\" [root@linux-node1 ~]# ssh linux-node4 \"systemctl enable kube-proxy\" [root@linux-node1 ~]# ssh linux-node4 \"systemctl start kube-proxy\" [root@linux-node1 ~]# ssh linux-node4 \"systemctl status kube-proxy\" éªŒè¯æˆ‘ä»¬å…ˆæ¥Scaling flask-app podåˆ°20ä¸ª, ç„¶åçœ‹Kubenertes Scheduleræ˜¯å¦èƒ½æŠŠè¯·æ±‚è°ƒåº¦åˆ°æ–°çš„èŠ‚ç‚¹ä¸Šé¢ [root@linux-node1 ~]# kubectl scale --replicas=20 deployment.extensions/flask-app -n flask-app-extions-stage deployment.extensions \"flask-app\" scaled ä¸Šå›¾å¯ä»¥çœ‹åˆ° Scalingçš„podå·²ç»ç”±Kubenertes Schedulerè°ƒåº¦åˆ°å„ä¸ªnodeè¿è¡Œï¼Œå¹¶ä¸”çŠ¶æ€å·²ç»æ˜¯Running ä»¥ä¸Šï¼Œå¯ä»¥çœ‹åˆ°æˆ‘æ–°æ·»åŠ çš„èŠ‚ç‚¹å·²ç»æˆåŠŸåŠ åˆ°äº†é›†ç¾¤å½“ä¸­ï¼Œè€Œä¸”è¿è¡Œç»“æœä¹Ÿæ˜¯æˆ‘é¢„æœŸçš„ï¼›å”¯ä¸€ä¸è¶³çš„åœ°æ–¹æ˜¯è¿™ä¸ªæ­¥éª¤å¦‚æœåæœŸåœ¨å·¥ä½œä¸­ç”¨åˆ°çš„è¯æ˜¯ä¸å¤ªæ–¹ä¾¿ç»´æŠ¤çš„,ä½†æ˜¯æ‰‹åŠ¨è¿™æ ·ä¼šçŸ¥é“ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦ç”¨åˆ°å“ªäº›ä¸œè¥¿ï¼Œéœ€è¦æ€ä¹ˆé…ç½®ï¼Œä¹Ÿç®—æ˜¯å¯¹k8sçš„è¿è¡Œæœºåˆ¶æœ‰æ›´æ·±ç‚¹çš„è®¤çŸ¥ã€‚åç»­æœ‰æ—¶é—´è¿˜æ˜¯æä¸€ä¸‹ç”¨SaltStackæ¥éƒ¨ç½²å§~ğŸºğŸºğŸº","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"Python App on Kubernets Cluster","slug":"flask_kubenertes","date":"2018-06-27T02:25:20.000Z","updated":"2025-09-01T01:59:08.873Z","comments":true,"path":"2018/06/27/flask_kubenertes/","permalink":"https://blog.sctux.cc/2018/06/27/flask_kubenertes/","excerpt":"åºæ­¤æ¬¡éƒ¨ç½²æ˜¯åœ¨å‰é¢åšæ–‡ä¸­æ­å»ºçš„K8Sé›†ç¾¤åŸºç¡€ä¹‹ä¸Šè¿›è¡Œçš„ï¼Œæ¶‰åŠä½¿ç”¨åˆ°çš„å®¹å™¨å·²ç»æ¨åˆ°Dockerhubä»£ç ã€æ–‡ä»¶ï¼šhttps://github.com/guomaoqiu/flask_kubernetes é…ç½®æ¸…å• é€»è¾‘æµç¨‹å›¾ åˆå§‹é…ç½®1.åˆ›å»ºä¸€ä¸ªnamespace ä¾›æ­¤æ¬¡éƒ¨ç½²ä½¿ç”¨1234567[root@linux-node1 ~]# kubectl create namespace flask-app-extions-stage[root@linux-node1 ~]# kubectl get nsNAME STATUS AGEdefault Active 29dflask-app-extions-stage Active 1mkube-public Active 29dkube-system Active 29d 1. åˆ›å»ºç”¨NFSå­˜å‚¨ç›®å½•","text":"åºæ­¤æ¬¡éƒ¨ç½²æ˜¯åœ¨å‰é¢åšæ–‡ä¸­æ­å»ºçš„K8Sé›†ç¾¤åŸºç¡€ä¹‹ä¸Šè¿›è¡Œçš„ï¼Œæ¶‰åŠä½¿ç”¨åˆ°çš„å®¹å™¨å·²ç»æ¨åˆ°Dockerhubä»£ç ã€æ–‡ä»¶ï¼šhttps://github.com/guomaoqiu/flask_kubernetes é…ç½®æ¸…å• é€»è¾‘æµç¨‹å›¾ åˆå§‹é…ç½®1.åˆ›å»ºä¸€ä¸ªnamespace ä¾›æ­¤æ¬¡éƒ¨ç½²ä½¿ç”¨1234567[root@linux-node1 ~]# kubectl create namespace flask-app-extions-stage[root@linux-node1 ~]# kubectl get nsNAME STATUS AGEdefault Active 29dflask-app-extions-stage Active 1mkube-public Active 29dkube-system Active 29d 1. åˆ›å»ºç”¨NFSå­˜å‚¨ç›®å½•1234# ç”¨äºflask-appä»£ç å­˜æ”¾ç›®å½•ï¼Œå½“podå¯åŠ¨æ—¶é€šè¿‡NFSçš„æ–¹å¼æŒ‚è½½è¿›å»[root@linux-node1 ~]# mkdir /data/flask-app-data# ç”¨äºflaskçš„mysqlæ•°æ®å­˜æ”¾ç›®å½•ï¼Œå½“podå¯åŠ¨æ—¶é€šè¿‡NFSæŒ‚è½½è¿›å»[root@linux-node1 ~]# mkdir /data/flask-app-db 2. å®‰è£…NFS Server(ç•¥)3. å†™å…¥é…ç½®12[root@linux-node1 ~]# echo \"/data/flask-app-db *(rw,sync,no_subtree_check,no_root_squash)\" &gt; /etc/exports[root@linux-node1 ~]# echo \"/data/flask-app-data *(rw,sync,no_subtree_check,no_root_squash)\" &gt;&gt; /etc/exports 4.é‡å¯éªŒè¯1234567[root@linux-node1 ~]# systemctl restart nfs-server[root@linux-node1 ~]# exportfs# mysql data/data/flask-app-db# flask app code/data/flask-app-data 5.åˆ›å»ºflask-appä½¿ç”¨çš„pvåŠpvc1234[root@linux-node1 ~]# kubectl create -f flask_kubernetes/flask-app/flask_app_data_pv.yamlpersistentvolume \"flask-app-data-pv\" created[root@linux-node1 ~]# kubectl create -f flask_kubernetes/flask-app/flask_app_data_pvc.yamlpersistentvolumeclaim \"flask-app-data-pv-claim\" created 6.åˆ›å»ºflask-app-dbä½¿ç”¨çš„pvåŠpvc12345678910111213[root@linux-node1 ~]# kubectl create -f flask_kubernetes/flask_app_db/flask_app_db_pv.yamlpersistentvolume \"flask-app-db-pv\" created[root@linux-node1 ~]# kubectl create -f flask_kubernetes/flask_app_db/flask_app_db_pvc.yamlpersistentvolumeclaim \"flask-app-db-pv-claim\" created[root@linux-node1 ~]# kubectl get pv -n flask-app-extions-stageNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGEflask-app-data-pv 5Gi RWO Recycle Bound flask-app-extions-stage/flask-app-data-pv-claim 5mflask-app-db-pv 5Gi RWO Recycle Bound flask-app-extions-stage/flask-app-db-pv-claim 26s[root@linux-node1 ~]# kubectl get pvc -n flask-app-extions-stageNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEflask-app-data-pv-claim Bound flask-app-data-pv 5Gi RWO 4mflask-app-db-pv-claim Bound flask-app-db-pv 5Gi RWO 28s[root@linux-node1 ~]# éƒ¨ç½² flask-app-dbè¿è¡Œflaskäº¤äº’æ•°æ®çš„æ•°æ®åº“ä½¿ç”¨çš„æ˜¯mysqlï¼Œä¸Šé¢æˆ‘å·²ç»åˆ›å»ºäº†ç”¨äºåŸºäºNFSå­˜å‚¨mysqlæ•°æ®çš„æŒä¹…å­˜å‚¨ç›®å½• /data/flask-app-db 1. åˆ›å»ºé…ç½® MySQL å¯†ç çš„ Secret12345[root@linux-node1 ~]# kubectl create secret generic mysql-pass --from-literal=password=YOUR_PASSWORD[root@linux-node1 ~]# kubectl get secret -n flask-app-extions-stageNAME TYPE DATA AGEdefault-token-fr2sg kubernetes.io/service-account-token 3 47mmysql-pass Opaque 1 14s 2. éƒ¨ç½² MySQLï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253[root@linux-node1 ~]# kubectl create -f flask_kubernetes/flask_app_db/flask_app_db_deploy.yamldeployment.apps \"flask-app-db\" created[root@linux-node1 ~]# kubectl create -f flask_kubernetes/flask_app_db/flask_app_db_service.yamlservice \"flask-app-db\" created# æŸ¥çœ‹çŠ¶æ€NAME READY STATUS RESTARTS AGE IP NODEpod/flask-app-db-6f55458666-h2dk7 1/1 Running 1 22h 10.2.15.108 192.168.56.12NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORservice/flask-app-db NodePort 10.1.68.29 &lt;none&gt; 3306:30006/TCP 22h app=flask-app-dbNAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTORdeployment.extensions/flask-app-db 1 1 1 1 22h mysql mysql:5.6 app=flask-app-db,tier=mysql# ä»¥ä¸Šå¯ä»¥çŸ¥é“è¯¥podè¿è¡Œåœ¨èŠ‚ç‚¹192.168.56.12ä¸Šé¢ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯NodePortæ–¹å¼ï¼Œç„¶åæ˜ å°„äº†ä¸€ä¸ª30006ç«¯å£å‡ºæ¥åˆ°èŠ‚ç‚¹ä¸Šé¢# å¯ä»¥å°è¯•ç™»é™†æµ‹è¯•[root@linux-node1 flask_app_db]# mysql -uroot -pdevopsdemo -h192.168.56.12 -P 30006Welcome to the MariaDB monitor. Commands end with ; or \\g.Your MySQL connection id is 1Server version: 5.6.40 MySQL Community Server (GPL)Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.MySQL [(none)]&gt; show databases;+--------------------+| Database |+--------------------+| information_schema || mysql || performance_schema |+--------------------+3 rows in set (0.02 sec)MySQL [(none)]&gt;# é¡ºä¾¿æˆ‘ä»¬åœ¨è¿™é‡Œæ‰‹åŠ¨åˆ›å»ºä¸€ä¸‹flask-appéœ€è¦ç”¨åˆ°çš„æ•°æ®åº“ devopsdemo, å› ä¸ºåœ¨flask-appåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­éœ€è¦å»åˆå§‹åŒ–æ•°æ®åº“å¹¶åˆ›å»ºæ•°æ®è¡¨ã€‚MySQL [(none)]&gt; CREATE DATABASE devopsdemo;Query OK, 1 row affected (0.01 sec)#æ•°æ®åº“ç›®å½•,å¯ä»¥çœ‹åˆ°mysqlæ•°æ®å·²ç»é€šè¿‡nfsçš„æ–¹å¼å­˜å‚¨åˆ°äº†æˆ‘ä»¬nfs serveræ‰€åœ¨ä¸»æœºæ˜ å°„å‡ºå»çš„ç›®å½•[root@linux-node1 ~]# tree /data/flask-app-db/ -L 1/data/flask-app-db/â”œâ”€â”€ auto.cnfâ”œâ”€â”€ devopsdemoâ”œâ”€â”€ ibdata1â”œâ”€â”€ ib_logfile0â”œâ”€â”€ ib_logfile1â”œâ”€â”€ mysqlâ””â”€â”€ performance_schema3 directories, 4 files éƒ¨ç½²flask-app1.å°†flaskç¨‹åºä»£ç æ”¾åˆ°/data/flask-app-data/123456789101112131415[root@linux-node1 ~]# cp -rf flask_app_code/* /data/flask-app-data/[root@linux-node1 ~]# tree /data/flask-app-data/ -L 1/data/flask-app-data/â”œâ”€â”€ appâ”œâ”€â”€ config.pyâ”œâ”€â”€ flask_uwsgi.iniâ”œâ”€â”€ LICENSEâ”œâ”€â”€ manage.pyâ”œâ”€â”€ README.mdâ”œâ”€â”€ requirements.txtâ”œâ”€â”€ screenshotsâ”œâ”€â”€ supervisord.confâ””â”€â”€ tests3 directories, 9 files 2. ä¿®æ”¹flaskç¨‹åºè¿æ¥æ•°æ®åº“çš„é…ç½®ä¿¡æ¯123456789[root@linux-node1 ~]# vim /data/flask-app-data/config.py............ db_host = 'flask-app-db' # åœ¨podå¯åŠ¨è¿‡ç¨‹ä¸­ä¼šå»åŠ è½½k8sçš„ç¯å¢ƒå˜é‡ï¼›è¿™ä¸ªflask-app-db å°±æ˜¯mysqlçš„svc db_user = 'root' # é»˜è®¤ä¸ºroot db_pass = \"devopsdemo\" # æ•°æ®åº“å¯†ç  db_name = 'devopsdemo' # æ•°æ®åº“åç§°............ 3. éƒ¨ç½²flask-app12345678910111213141516171819202122232425[root@linux-node1 ~]# kubectl create -f flask_kubernetes/flask_app/flask_app_deployment.yamldeployment.apps \"flask-app\" created[root@linux-node1 ~]# kubectl create -f flask_kubernetes/flask_app/flask_app_service.yamlservice \"flask-app\" created# æŸ¥çœ‹çŠ¶æ€:[root@linux-node1 ~]# kubectl get pod,svc,deployment,rc -o wide -n flask-app-extions-stageNAME READY STATUS RESTARTS AGE IP NODEpod/flask-app-65646687ff-4gg7g 1/1 Running 0 17h 10.2.42.125 192.168.56.13pod/flask-app-65646687ff-7d5g6 1/1 Running 0 17h 10.2.42.124 192.168.56.13pod/flask-app-65646687ff-xkq6k 1/1 Running 0 17h 10.2.42.123 192.168.56.13pod/flask-app-db-6f55458666-h2dk7 1/1 Running 1 22h 10.2.15.108 192.168.56.12NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORservice/flask-app ClusterIP 10.1.173.169 &lt;none&gt; 3032/TCP 22h app=flask-appservice/flask-app-db NodePort 10.1.68.29 &lt;none&gt; 3306:30006/TCP 22h app=flask-app-dbNAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTORdeployment.extensions/flask-app 3 3 3 3 22h flask-app guomaoqiu/python27baseenv:v2 app=flask-app,tier=frontenddeployment.extensions/flask-app-db 1 1 1 1 22h mysql mysql:5.6 app=flask-app-db,tier=mysql# ä»¥ä¸Šå¯çŸ¥ æˆ‘çš„flask-appè¿è¡Œäº†ä¸‰ä¸ªå‰¯æœ¬ï¼›# å¹¶ä¸”é‡‡ç”¨çš„æ˜¯ClusterIP Type,3032æ˜¯flask+supervisor+uwsgi ä¹‹å uwsgsi æš´éœ²å‡ºæ¥çš„äºŒç«¯å£# æ­¤æ—¶æˆ‘ä»¬è®¿é—®æ˜¯æ²¡æœ‰ç”¨çš„ï¼›å› ä¸ºuwgsiéœ€è¦ç»“åˆç”¨åˆ°Nginxæ¥è®¿é—®ï¼›äºæ˜¯æˆ‘ä¸‹é¢å°†ä¼šéƒ¨ç½²nginx ---&gt; uwgsi(flask-app) éƒ¨ç½²flask-app-nginxå› ä¸ºè¿™ä¸ªnginxçš„é…ç½®æˆ‘è¿™é‡Œéœ€è¦ä¿®æ”¹åšä¸€äº›å®šåˆ¶æ–¹é¢çš„é…ç½®ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªå°†å•ä¸ªé…ç½®æ–‡ä»¶æŒ‚è½½åˆ°podé‡Œé¢çš„éœ€æ±‚ï¼›äºæ˜¯è¿™é‡Œä½¿ç”¨åˆ°äº†k8sçš„ConfigMapåŠŸèƒ½ 1. æ‰¾åˆ°éœ€è¦æŒ‚è½½è¿›podçš„nginxé…ç½®æ–‡ä»¶:123456[root@linux-node1 ~]# kubectl create configmap nginx-conf --from-file=/root/flask_kubernetes/flask_app_nginx/nginx.conf -n flask-app-extions-stage[root@linux-node1 ~]# kubectl get configmap -n flask-app-extions-stageNAME DATA AGEnginx-conf 1 11s# é€šè¿‡describeå°±å¯ä»¥çœ‹åˆ°è¿™ä¸ªconfçš„è¯¦ç»†å†…å®¹ï¼Œå…¶å®å°±åœ¨æˆ‘ä»¬nginx.confé…ç½®æ–‡ä»¶çš„åŸºç¡€ä¸ŠåŠ ä¸Šäº†k8sä¸€äº›ç‰¹æœ‰çš„å±æ€§å€¼[root@linux-node1 ~]# kubectl describe configmap/nginx-conf -n flask-app-extions-stage 2.éƒ¨ç½²flask-app-nginx123456789101112131415161718192021222324252627282930313233343536[root@linux-node1 flask_app_nginx]# kubectl create -f flask_app_nginx_deploy.yamldeployment.apps \"flask-app-nginx\" created[root@linux-node1 flask_app_nginx]# kubectl create -f flask_app_nginx_service.yamlservice \"flask-app-nginx\" created# æŸ¥çœ‹çŠ¶æ€ï¼š[root@linux-node1 ~]# kubectl get pod,svc,deployment,rc -o wide -n flask-app-extions-stageNAME READY STATUS RESTARTS AGE IP NODEpod/flask-app-65646687ff-4gg7g 1/1 Running 0 17h 10.2.42.125 192.168.56.13pod/flask-app-65646687ff-7d5g6 1/1 Running 0 17h 10.2.42.124 192.168.56.13pod/flask-app-65646687ff-xkq6k 1/1 Running 0 17h 10.2.42.123 192.168.56.13pod/flask-app-db-6f55458666-h2dk7 1/1 Running 1 22h 10.2.15.108 192.168.56.12pod/flask-app-nginx-657fd4c57c-p6qdx 1/1 Running 12 18h 10.2.42.119 192.168.56.13pod/flask-app-nginx-657fd4c57c-v4qsp 1/1 Running 12 18h 10.2.42.117 192.168.56.13pod/flask-app-nginx-657fd4c57c-xtpmm 1/1 Running 12 18h 10.2.42.118 192.168.56.13NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORservice/flask-app ClusterIP 10.1.173.169 &lt;none&gt; 3032/TCP 22h app=flask-appservice/flask-app-db NodePort 10.1.68.29 &lt;none&gt; 3306:30006/TCP 22h app=flask-app-dbservice/flask-app-nginx ClusterIP 10.1.193.82 &lt;none&gt; 80/TCP 21h app=flask-app-nginxNAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTORdeployment.extensions/flask-app 3 3 3 3 22h flask-app guomaoqiu/python27baseenv:v2 app=flask-app,tier=frontenddeployment.extensions/flask-app-db 1 1 1 1 22h mysql mysql:5.6 app=flask-app-db,tier=mysqldeployment.extensions/flask-app-nginx 3 3 3 3 21h nginx nginx:latest app=flask-app-nginx# ä»¥ä¸Š è¿è¡Œäº†ä¸‰ä¸ªflak-app-nginx ,é‡‡ç”¨çš„æ˜¯ClusterIP Type# è®¿é—®éªŒè¯,ç›´æ¥è®¿é—®çš„æ˜¯flask-app-nginx çš„VIP(ClusterIP)[root@linux-node1 ~]# curl -I 10.1.193.82/auth/loginHTTP/1.1 200 OKServer: nginx/1.15.0Date: Wed, 27 Jun 2018 04:35:12 GMTContent-Type: text/html; charset=utf-8Content-Length: 4026Connection: keep-aliveSet-Cookie: session=eyJjc3JmX3Rva2VuIjp7IiBiIjoiT0RrNVpXUmpZV014T1daalkyUmlOamRsWXpBNVpqUTVZMk0wTkRnMU9ERm1NVFUzTURrME5BPT0ifX0.DhSlgA.Biu7EYC7qfj4x8--HlR8VUZFUgk; HttpOnly; Path=/ ä»¥ä¸Šè¯´æ˜æˆ‘ä»¬èƒ½å¤ŸæˆåŠŸçš„è®¿é—®åˆ°æˆ‘ä»¬çš„flask-appæœåŠ¡å•¦,åœ¨ç”¨linux ç»ˆç«¯ä¸‹çš„w3m http://10.1.193.82/auth/login è®¿é—®ä¸€ä¸‹å‘¢ï¼Œè¯´æ˜ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼›é‚£åç«¯uwgsi or flask-app or flask-nginxçš„è®¿é—®æ—¥å¿—æ­¤æ—¶æ¯‹åº¸ç½®ç–‘æ˜¯å·²ç»æœ‰äº†çš„ã€‚ é‚£é—®é¢˜æ¥äº†ï¼›æ­¤æ—¶æˆ‘åªæ˜¯åœ¨é›†ç¾¤å†…éƒ¨èƒ½å¤Ÿè®¿é—®ï¼Œé‚£å¦‚ä½•åœ¨å¤–é¢è®¿é—®å‘¢ï¼Ÿé‚£å°±ä¸»è¦å°†flask_nginx_service.yamlä¸­çš„Typeè¯¥ä¸ºnodePort,ç„¶åä»æ–°éƒ¨ç½²ä¸€ä¸‹flask_app_nginx_services 12345678910111213141516171819202122232425262728293031[root@linux-node1 ~]# more /root/flask_kubernetes/flask_app_nginx/flask_app_nginx_service.yamlkind: ServiceapiVersion: v1metadata: name: flask-app-nginx namespace: flask-app-extions-stagespec: type: NodePort selector: app: flask-app-nginx ports: - protocol: TCP port: 80 targetPort: 80 nodePort: 30001 selector: app: flask-app-nginx[root@linux-node1 ~]# kubectl describe svc/flask-app-nginx -n flask-app-extions-stageName: flask-app-nginxNamespace: flask-app-extions-stageLabels: &lt;none&gt;Annotations: &lt;none&gt;Selector: app=flask-app-nginxType: ClusterIPIP: 10.1.193.82Port: &lt;unset&gt; 80/TCPTargetPort: 80/TCPEndpoints: 10.2.42.117:80,10.2.42.118:80,10.2.42.119:80Session Affinity: NoneEvents: &lt;none&gt; æ­¤æ—¶å¦‚æœæ˜¯å¤–ç½‘è®¿é—®å°±åº”è¯¥æ˜¯NodeIP+nodePortå•¦ï¼š ä½†æ˜¯è¿™ç§æ–¹å¼å¹¶ä¸æ˜¯å¾ˆç†æƒ³ï¼›æœ¬æ¥å°±æ˜¯è¦è®©ä»–ç›´æ¥è®¿é—®80 portçš„ï¼Œäºæ˜¯é‡‡ç”¨å¦å¤–ä¸€ç§æš´éœ²ç«¯å£çš„æ–¹å¼â€”â€”Ingress ï¼ˆè¿™é‡Œæˆ‘è¿˜æ˜¯æŠŠflask-app-nginxçš„serviceæ”¹å›äº†ClusterIP) éƒ¨ç½² Ingress-NginxIngress ä½¿ç”¨å¼€æºçš„åå‘ä»£ç†è´Ÿè½½å‡è¡¡å™¨æ¥å®ç°å¯¹å¤–æš´æ¼æœåŠ¡ï¼Œæ¯”å¦‚ Nginxã€Apacheã€Haproxyç­‰ã€‚Nginx Ingress ä¸€èˆ¬æœ‰ä¸‰ä¸ªç»„ä»¶ç»„æˆï¼š Nginx åå‘ä»£ç†è´Ÿè½½å‡è¡¡å™¨ Ingress Controller å¯ä»¥ç†è§£ä¸ºæ§åˆ¶å™¨ï¼Œå®ƒé€šè¿‡ä¸æ–­çš„è·Ÿ Kubernetes API äº¤äº’ï¼Œå®æ—¶è·å–åç«¯ Serviceã€Pod ç­‰çš„å˜åŒ–ï¼Œæ¯”å¦‚æ–°å¢ã€åˆ é™¤ç­‰ï¼Œç„¶åç»“åˆ Ingress å®šä¹‰çš„è§„åˆ™ç”Ÿæˆé…ç½®ï¼Œç„¶ååŠ¨æ€æ›´æ–°ä¸Šè¾¹çš„ Nginx è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶åˆ·æ–°ä½¿é…ç½®ç”Ÿæ•ˆï¼Œæ¥è¾¾åˆ°æœåŠ¡è‡ªåŠ¨å‘ç°çš„ä½œç”¨ã€‚ Ingress åˆ™æ˜¯å®šä¹‰è§„åˆ™ï¼Œé€šè¿‡å®ƒå®šä¹‰æŸä¸ªåŸŸåçš„è¯·æ±‚è¿‡æ¥ä¹‹åè½¬å‘åˆ°é›†ç¾¤ä¸­æŒ‡å®šçš„ Serviceã€‚å®ƒå¯ä»¥é€šè¿‡ Yaml æ–‡ä»¶å®šä¹‰ï¼Œå¯ä»¥ç»™ä¸€ä¸ªæˆ–å¤šä¸ª Service å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ª Ingress è§„åˆ™ã€‚ 1.è·å–å®˜æ–¹æä¾›çš„yaml12345678910111213[root@linux-node1 ~]# cd flask_8s &amp;&amp; git clone https://github.com/kubernetes/ingress-nginx.git[root@linux-node1 ~]# tree flask_8s/ingress-nginx/flask_8s/ingress-nginx/â”œâ”€â”€ configmap.yaml :æä¾›configmapå¯ä»¥åœ¨çº¿æ›´è¡Œnginxçš„é…ç½®â”œâ”€â”€ default-backend.yaml :æä¾›ä¸€ä¸ªç¼ºçœçš„åå°é”™è¯¯é¡µé¢ 404â”œâ”€â”€ mandatory.yaml :è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†è¿™ä¸ªç›®å½•ä¸‹é¢æ‰€æœ‰yamlçš„å†…å®¹ï¼Œå¯ä»¥ä¸ç”¨â”œâ”€â”€ namespace.yaml :åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ ingress-nginxâ”œâ”€â”€ rbac.yaml :åˆ›å»ºå¯¹åº”çš„role rolebinding ç”¨äºrbacâ”œâ”€â”€ tcp-services-configmap.yaml :ä¿®æ”¹L4è´Ÿè½½å‡è¡¡é…ç½®çš„configmapâ”œâ”€â”€ udp-services-configmap.yaml :ä¿®æ”¹L4è´Ÿè½½å‡è¡¡é…ç½®çš„configmapâ””â”€â”€ with-rbac.yaml :æœ‰åº”ç”¨rbacçš„nginx-ingress-controllerç»„ä»¶ 0 directories, 8 files 2.ä¿®æ”¹å®˜æ–¹çš„é…ç½® kind: DaemonSetï¼šå®˜æ–¹åŸå§‹æ–‡ä»¶ä½¿ç”¨çš„æ˜¯deploymentï¼Œreplicate ä¸º 1ï¼Œè¿™æ ·å°†ä¼šåœ¨æŸä¸€å°èŠ‚ç‚¹ä¸Šå¯åŠ¨å¯¹åº”çš„nginx-ingress-controller podã€‚å¤–éƒ¨æµé‡è®¿é—®è‡³è¯¥èŠ‚ç‚¹ï¼Œç”±è¯¥èŠ‚ç‚¹è´Ÿè½½åˆ†æ‹…è‡³å†…éƒ¨çš„serviceã€‚æµ‹è¯•ç¯å¢ƒè€ƒè™‘é˜²æ­¢å•ç‚¹æ•…éšœï¼Œæ”¹ä¸ºDaemonSetç„¶ååˆ æ‰replicate ï¼Œé…åˆäº²å’Œæ€§éƒ¨ç½²åœ¨åˆ¶å®šèŠ‚ç‚¹ä¸Šå¯åŠ¨nginx-ingress-controller podï¼Œç¡®ä¿æœ‰å¤šä¸ªèŠ‚ç‚¹å¯åŠ¨nginx-ingress-controller podï¼Œåç»­å°†è¿™äº›èŠ‚ç‚¹åŠ å…¥åˆ°å¤–éƒ¨ç¡¬ä»¶è´Ÿè½½å‡è¡¡ç»„å®ç°é«˜å¯ç”¨æ€§ã€‚ hostNetwork: trueï¼šæ·»åŠ è¯¥å­—æ®µï¼Œæš´éœ²nginx-ingress-controller podçš„æœåŠ¡ç«¯å£ï¼ˆ80ï¼‰ nodeSelector: å¢åŠ äº²å’Œæ€§éƒ¨ç½²ï¼Œæœ‰custom/ingress-controller-ready æ ‡ç­¾çš„èŠ‚ç‚¹æ‰ä¼šéƒ¨ç½²è¯¥DaemonSet 3.ä¸ºéœ€è¦éƒ¨ç½²nginx-ingress-controllerçš„èŠ‚ç‚¹è®¾ç½®lable12345678[root@linux-node1 ~]# kubectl label nodes 192.168.56.12 custom/ingress-controller-ready=true[root@linux-node1 ~]# kubectl label nodes 192.168.56.13 custom/ingress-controller-ready=true[root@linux-node1 ~]# kubectl get nodes --show-labelsNAME STATUS ROLES AGE VERSION LABELS192.168.56.12 Ready &lt;none&gt; 28d v1.10.1 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,custom/ingress-controller-ready=true,kubernetes.io/hostname=192.168.56.12192.168.56.13 Ready &lt;none&gt; 27d v1.10.1 beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,custom/ingress-controller-ready=true,kubernetes.io/hostname=192.168.56.13# ä»¥ä¸Šï¼Œå› ä¸ºæˆ‘è¿™é‡Œå°±ä¸¤ä¸ªè®¡ç®—èŠ‚ç‚¹ï¼›æ‰€ä»¥éƒ½æ‰“ä¸Šcustom/ingress-controller-ready=trueè¿™ä¸ªæ ‡ç­¾ 4.æ‰§è¡Œåˆ›å»ºyamlæ–‡ä»¶:1234567[root@linux-node1 ~]# kubectl create -f namespace.yaml[root@linux-node1 ~]# kubectl create -f default-backend.yaml[root@linux-node1 ~]# kubectl create -f configmap.yaml[root@linux-node1 ~]# kubectl create -f tcp-services-configmap.yaml[root@linux-node1 ~]# kubectl create -f udp-services-configmap.yaml[root@linux-node1 ~]# kubectl create -f rbac.yaml[root@linux-node1 ~]# kubectl create -f with-rbac.yaml 5.æŸ¥çœ‹åˆ›å»ºçŠ¶æ€ï¼šåˆ›å»ºè¿‡ç¨‹ä¼šå»æ‹‰é•œåƒæ¯”è¾ƒæ…¢ï¼Œå¯èƒ½ä¼šä¸æˆåŠŸï¼Œå‰é¢è¯´è¿‡é‚£éƒ½æ˜¯å› ä¸º`%#@%ï¿¥#@Â·çš„åŸå› ï¼Œæ‰€ä»¥è¿˜æ˜¯è®°å¾—ç»™dockerä¸€æŠŠæ¢¯å­ã€‚ 1234567891011121314[root@linux-node1 ~]# kubectl get pod,svc,deployment,rc -o wide -n ingress-nginxNAME READY STATUS RESTARTS AGE IP NODEpod/default-http-backend-5c6d95c48-dwl56 1/1 Running 0 16h 10.2.42.130 192.168.56.13pod/nginx-ingress-controller-55trv 1/1 Running 0 15h 192.168.56.12 192.168.56.12pod/nginx-ingress-controller-58nf4 1/1 Running 0 15h 192.168.56.13 192.168.56.13NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTORservice/default-http-backend ClusterIP 10.1.89.141 &lt;none&gt; 80/TCP 16h app=default-http-backendNAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTORdeployment.extensions/default-http-backend 1 1 1 1 16h default-http-backend gcr.io/google_containers/defaultbackend:1.4 app=default-http-backend# ä»¥ä¸Šå¯ä»¥çœ‹åˆ°nginx-ingress-controllerå·²ç»æˆåŠŸè¿è¡Œåœ¨äº†è¿™ä¸¤ä¸ªæ‰“äº†æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šé¢ æ­¤æ—¶åªæ˜¯æŠŠingressç»™æ­å»ºå¥½ï¼Œå¦‚æœè¦ç”¨å¾—æ ¹æ®å®é™…æƒ…å†µå†™è½¬å‘è§„åˆ™äº†ï¼Œå½“å‰æˆ‘ä»¬çš„ç›®çš„æ˜¯é€šè¿‡å®ƒå®šä¹‰æŸä¸ªåŸŸåçš„è¯·æ±‚è¿‡æ¥ä¹‹åè½¬å‘åˆ°é›†ç¾¤ä¸­æŒ‡å®šçš„ Serviceï¼Œå³æ­¤æ¬¡éƒ¨ç½²çš„ flask-app-nginx 6.åˆ›å»ºè§„åˆ™ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142[root@linux-node1 ingress-nginx]# cat &gt; test.ingress.yaml &lt; EOFapiVersion: extensions/v1beta1kind: Ingressmetadata: name: test-ingress namespace: flask-app-extions-stagespec: rules: - host: test.flaskapp.ingress http: paths: - path: / backend: serviceName: flask-app-nginx servicePort: 80EOF# host: å¯¹åº”çš„åŸŸå # path: urlä¸Šä¸‹æ–‡ # backend:åå‘è½¬å‘ åˆ°å¯¹åº”çš„ serviceName: servicePort:[root@linux-node1 ingress-nginx]# kubectl apply -f test-ingress.yaml[root@linux-node1 ingress-nginx]# kubectl get ingress -n flask-app-extions-stageNAME HOSTS ADDRESS PORTS AGEtest-ingress test.flaskapp.ingress 80 15h[root@linux-node1 ingress-nginx]# kubectl describe ingress/test-ingress -n flask-app-extions-stageName: test-ingressNamespace: flask-app-extions-stageAddress:Default backend: default-http-backend:80 (&lt;none&gt;)Rules: Host Path Backends ---- ---- -------- test.flaskapp.ingress / flask-app-nginx:80 (&lt;none&gt;)Annotations:Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal CREATE 15h nginx-ingress-controller Ingress flask-app-extions-stage/test-ingress Normal CREATE 15h nginx-ingress-controller Ingress flask-app-extions-stage/test-ingress Normal CREATE 15h nginx-ingress-controller Ingress flask-app-extions-stage/test-ingress Normal CREATE 15h nginx-ingress-controller Ingress flask-app-extions-stage/test-ingress 7.æµ‹è¯•ï¼šæ—¢ç„¶æ˜¯é€šè¿‡åŸŸåè®¿é—®ï¼Œé‚£è¿™é‡Œæˆ‘å°±åœ¨node1ä¸Šé¢ç›´æ¥ä¿®æ”¹hostsçš„æ–¹å¼ç„¶åè®¿é—® 12345678910111213141516171819202122232425262728293031323334353637383940414243[root@linux-node1 ~]# echo \"192.168.56.12 test.flaskapp.ingress\" &gt;&gt; /etc/hosts[root@linux-node1 ~]# echo \"192.168.56.13 test.flaskapp.ingress\" &gt;&gt; /etc/hosts[root@linux-node1 ingress-nginx]# curl -I test.flaskapp.ingress/auth/loginHTTP/1.1 200 OKServer: nginx/1.13.12Date: Thu, 28 Jun 2018 02:59:16 GMTContent-Type: text/html; charset=utf-8Content-Length: 4030Connection: keep-aliveVary: Accept-EncodingSet-Cookie: session=eyJjc3JmX3Rva2VuIjp7IiBiIjoiTXpGbFlUWmlOelV4WXpabVlqTXlNVFJpWTJVMk1HWTVObVV5TURRd09HSTNPVFV4WXprd01RPT0ifX0.DhXghA.3HHbX3fvShem9KlkINr8jDGwcSc; HttpOnly; Path=/# æˆ–è€…æŒ‡å®šæ¨¡æ‹Ÿçš„åŸŸå:[root@linux-node1 ingress-nginx]# curl -vI http://192.168.56.12/auth/login -H 'host: test.flaskapp.ingress'* About to connect() to 192.168.56.12 port 80 (#0)* Trying 192.168.56.12...* Connected to 192.168.56.12 (192.168.56.12) port 80 (#0)&gt; HEAD /auth/login HTTP/1.1&gt; User-Agent: curl/7.29.0&gt; Accept: */*&gt; host: test.flaskapp.ingress&gt;&lt; HTTP/1.1 200 OKHTTP/1.1 200 OK&lt; Server: nginx/1.13.12Server: nginx/1.13.12&lt; Date: Thu, 28 Jun 2018 03:00:21 GMTDate: Thu, 28 Jun 2018 03:00:21 GMT&lt; Content-Type: text/html; charset=utf-8Content-Type: text/html; charset=utf-8&lt; Content-Length: 4030Content-Length: 4030&lt; Connection: keep-aliveConnection: keep-alive&lt; Vary: Accept-EncodingVary: Accept-Encoding&lt; Set-Cookie: session=eyJjc3JmX3Rva2VuIjp7IiBiIjoiT1RNMVpUWTBZV1V6TkdWaU5EazBZMkl5TmpZMFl6VTNPVFF3TVdaa09UVXpNall3T1RRNE1RPT0ifX0.DhXgxQ.BnjwR-swXvmD-kUGhtlvhpHuUIY; HttpOnly; Path=/Set-Cookie: session=eyJjc3JmX3Rva2VuIjp7IiBiIjoiT1RNMVpUWTBZV1V6TkdWaU5EazBZMkl5TmpZMFl6VTNPVFF3TVdaa09UVXpNall3T1RRNE1RPT0ifX0.DhXgxQ.BnjwR-swXvmD-kUGhtlvhpHuUIY; HttpOnly; Path=/&lt;* Connection #0 to host 192.168.56.12 left intact åœ¨å¤–éƒ¨å¦‚æœè¦è®¿é—®ä¹Ÿéœ€è¦ç»‘å®šåŸŸååˆ°nodeèŠ‚ç‚¹ï¼Œç„¶åè®¿é—® okè‡³æ­¤è¯¥é¡¹ç›®å°±éƒ¨ç½²å¾—å·®ä¸å¤šäº†ï¼Œä¸Šé¢flask-appç™»å½•ï¼Œæ³¨å†Œæ­£å¸¸ï¼é‚£podå¦‚ä½•åšåˆ°ä¼¸ç¼©å‘¢ï¼›æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°±è¡Œäº† 1234567891011# ç›®å‰æˆ‘çš„flask-appæ˜¯è¿è¡Œäº†3ä¸ªï¼Œæ€¼20ä¸ªflask-appåº”ç”¨[root@linux-node1 ~]# kubectl get deploy/flask-app -n flask-app-extions-stageNAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGEflask-app 3 3 3 3 23h[root@linux-node1 ~]# kubectl scale --replicas=20 deployment.extensions/flask-app -n flask-app-extions-stagedeployment.extensions \"flask-app\" scaled[root@linux-node1 ~]# kubectl get deploy/flask-app -n flask-app-extions-stageNAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGEflask-app 20 20 20 20 23h# æ‰€ä»¥å‰¯æœ¬æ•°å°±æ˜¯é deplomentä¸­çš„ replicas æˆ–è€… å‘½ä»¤è¡Œçš„scale --replicasæ¥æ§åˆ¶ éƒ¨ç½²æ€»ç»“ï¼šå‘:åœ¨ä¸Šé¢æˆ‘éƒ¨ç½²å¥½ingress-nginxåï¼Œé€šè¿‡è®¿é—®å“ªä¸€æ­¥æŠ¥é”™äº†ï¼›äºæ˜¯å»æŸ¥äº† pod/nginx-ingress-controller-58nf4 çš„æ—¥å¿—ï¼Œé”™è¯¯æ—¥å¿—åˆ·å±å•Š å®˜æ–¹æ–‡æ¡£ä¸å®Œæ•´å•Šï¼Œå°‘äº†åˆ›å»ºingress-servicesçš„å†…å®¹ï¼›è§£å†³åŠæ³•ï¼š 123456789101112131415161718192021[root@linux-node1 ingress-nginx]# cat &gt; ingress-nginx-services.yaml &lt; EOFapiVersion: v1kind: Servicemetadata: name: ingress-nginx namespace: ingress-nginxspec: type: NodePort ports: - name: http port: 80 targetPort: 80 protocol: TCP - name: https port: 443 targetPort: 443 protocol: TCP selector: app: ingress-nginxEOF[root@linux-node1 ingress-nginx]# kubectl create -f ingress-nginx-services.yaml éƒ¨ç½²é‡åˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹ï¼š K8S deploymentçš„yamlæ–‡ä»¶ç¼–å†™ï¼› K8S æŒä¹…åŒ–å­˜å‚¨NFSæ–¹å¼ï¼›é…ç½®ç®¡ç†ConfigMap; K8S é›†ç¾¤ä¸­å„ç§ç«¯å£/IPç±»å‹çš„å·¥ä½œæ¨¡å¼ä»¥åŠæœåŠ¡æš´éœ²æ–¹å¼ï¼› by the way: å¯èƒ½çœ‹åˆ°æˆ‘åˆ›å»ºçš„podç­‰èµ„æºçš„AGEå·²ç»æ˜¯è¿‡å»åå‡ ä¸ªå°æ—¶ï¼Œè¿™ä¸ªæ²¡å…³ç³»çš„ï¼›å‰é¢åˆ›å»ºäº†ä¹‹åç¬”è®°å°±åœé¡¿äº†ä¸€ä¸‹ã€‚åç»­æ‰ç»§ç»­å†™çš„ğŸºğŸºğŸº","categories":[{"name":"kubernets","slug":"kubernets","permalink":"https://blog.sctux.cc/categories/kubernets/"}],"tags":[{"name":"kubernets","slug":"kubernets","permalink":"https://blog.sctux.cc/tags/kubernets/"}],"keywords":[{"name":"kubernets","slug":"kubernets","permalink":"https://blog.sctux.cc/categories/kubernets/"}]},{"title":"Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker éƒ¨ç½²","slug":"nginx-uwsgi-flask-supervisord-redis-mysql-docker-e9-83-a8-e7-bd-b2-2","date":"2018-06-18T09:37:35.000Z","updated":"2025-09-01T01:59:08.863Z","comments":true,"path":"2018/06/18/nginx-uwsgi-flask-supervisord-redis-mysql-docker-e9-83-a8-e7-bd-b2-2/","permalink":"https://blog.sctux.cc/2018/06/18/nginx-uwsgi-flask-supervisord-redis-mysql-docker-e9-83-a8-e7-bd-b2-2/","excerpt":"ä¹‹å‰ä½¿ç”¨Flaskå¼€å‘äº†ä¸¤ä¸‰ä¸ªå…¬å¸æˆ–ä¸ªäººä½¿ç”¨çš„å¹³å°ï¼›åœ¨æ­å»ºè¿‡ç¨‹å½“ä¸­å¦‚æœæ¢äº†ç¯å¢ƒçš„è¯æ¯”è¾ƒéº»çƒ¦ï¼›è¿™æ¬¡å°è¯•æ”¾åˆ°dockeré‡Œé¢å»è·‘ï¼›ä¸‹é¢æ˜¯æ­å»ºçš„ä¸€ä¸ªè¿‡ç¨‹ä»¥åŠå¯¹äºå­¦ä¹ çš„ä¸€ä¸ªè®°å½•ï¼Œæ­¤æ¬¡webæ¡†æ¶è¿˜æ˜¯ä½¿ç”¨çš„ä¹‹å‰ç”¨Flaskå†™çš„ä¸€ä¸ªåŸºç¡€åå°ã€‚ éƒ¨ç½²æ¶æ„:. â”œâ”€â”€ README.md â”œâ”€â”€ docker-compose.yaml # ä½¿ç”¨docker-composeæ¥ç¼–æ’éƒ¨ç½² â”œâ”€â”€ flask_app # ç”¨äºè·‘Flaskåº”ç”¨çš„å®¹å™¨ â”‚&nbsp;&nbsp; â”œâ”€â”€ Dockerfile â”‚&nbsp;&nbsp; â””â”€â”€ wait_for_db_complete.sh â”œâ”€â”€ flask_app_code # åç«¯é¡¹ç›®åº”ç”¨ä»£ç ç›® â”‚&nbsp;&nbsp; â”œâ”€â”€ LICENSE â”‚&nbsp;&nbsp; â”œâ”€â”€ README.md â”‚&nbsp;&nbsp; â”œâ”€â”€ app â”‚&nbsp;&nbsp; â”œâ”€â”€ config.py â”‚&nbsp;&nbsp; â”œâ”€â”€ manage.py â”‚&nbsp;&nbsp; â”œâ”€â”€ requirements.txt â”‚&nbsp;&nbsp; â”œâ”€â”€ screenshots â”‚&nbsp;&nbsp; â””â”€â”€ tests â”œâ”€â”€ nginx # Nginxç”¨äºå‰ç«¯æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„å®¹å™¨ â”‚&nbsp;&nbsp; â””â”€â”€ nginx.conf â”œâ”€â”€ python27_baseenv # åŸºç¡€Pythonç¯å¢ƒé•œåƒ â”‚&nbsp;&nbsp; â”œâ”€â”€ Dockerfile â”‚&nbsp;&nbsp; â””â”€â”€ README.md â”œâ”€â”€ supervisor # ç”¨äºç®¡ç†uwsgiæœåŠ¡è¿›ç¨‹ â”‚&nbsp;&nbsp; â””â”€â”€ supervisord.conf â””â”€â”€ uwsgi # é€šè¿‡uWsgiæ¥ä¸ºNginx-Flaskç‰µçº¿æ­æ¡¥ â””â”€â”€ flask_uwsgi.ini è®¿é—®æµç¨‹: Nginx WebæœåŠ¡å™¨å±‚ä½œä¸ºå‰ç«¯æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼› uWSGIå±‚ä½œä¸ºWebæœåŠ¡å™¨å±‚ä¸Webæ¡†æ¶å±‚Flaskçš„ä¸€æ¡çº½å¸¦ï¼Œå°†WebæœåŠ¡å™¨å±‚ä¸Webæ¡†æ¶è¿æ¥èµ·æ¥ åç«¯Webæ¡†æ¶ä¸æ•°æ®å±‚MySQLæˆ–Redisäº¤äº’ ç®€å•ç†è§£èµ·æ¥å°±æ˜¯é…±ç´«çš„: Nginxï¼šHeyï¼ŒWSGIï¼Œæˆ‘åˆšæ”¶åˆ°äº†ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘éœ€è¦ä½ ä½œäº›å‡†å¤‡ï¼Œç„¶åç”±Flaskæ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚ WSGIï¼šOKï¼ŒNginxã€‚æˆ‘ä¼šè®¾ç½®å¥½ç¯å¢ƒå˜é‡ï¼Œç„¶åå°†è¿™ä¸ªè¯·æ±‚ä¼ é€’ç»™Flaskå¤„ç†ã€‚ Flaskï¼šThanks WSGIï¼ç»™æˆ‘ä¸€äº›æ—¶é—´ï¼Œæˆ‘å°†ä¼šæŠŠè¯·æ±‚çš„å“åº”è¿”å›ç»™ä½ ã€‚ WSGIï¼šAlrightï¼Œé‚£æˆ‘ç­‰ä½ ã€‚ Flaskï¼šOkayï¼Œæˆ‘å®Œæˆäº†ï¼Œè¿™é‡Œæ˜¯è¯·æ±‚çš„å“åº”ç»“æœï¼Œè¯·æ±‚æŠŠç»“æœä¼ é€’ç»™Nginxã€‚ WSGIï¼šGood jobï¼ Nginxï¼Œè¿™é‡Œæ˜¯å“åº”ç»“æœï¼Œå·²ç»æŒ‰ç…§è¦æ±‚ç»™ä½ ä¼ é€’å›æ¥äº†ã€‚ Nginxï¼šCoolï¼Œæˆ‘æ”¶åˆ°äº†ï¼Œæˆ‘æŠŠå“åº”ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¤§å®¶åˆä½œæ„‰å¿«~ æ­å»ºæ€è·¯: Nginx å•ç‹¬ä¸€ä¸ªå®¹å™¨ uWSGI+Flask å•ç‹¬ä¸€ä¸ªå®¹å™¨ï¼Œå…¶ä¸­uWSGIè¿›ç¨‹ç”±Supervisoræ¥ç®¡ç† MySQL å•ç‹¬ä¸€ä¸ªå®¹å™¨ï¼Œæ•°æ®ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœº Redis å•ç‹¬ä¸€ä¸ªå®¹å™¨","text":"ä¹‹å‰ä½¿ç”¨Flaskå¼€å‘äº†ä¸¤ä¸‰ä¸ªå…¬å¸æˆ–ä¸ªäººä½¿ç”¨çš„å¹³å°ï¼›åœ¨æ­å»ºè¿‡ç¨‹å½“ä¸­å¦‚æœæ¢äº†ç¯å¢ƒçš„è¯æ¯”è¾ƒéº»çƒ¦ï¼›è¿™æ¬¡å°è¯•æ”¾åˆ°dockeré‡Œé¢å»è·‘ï¼›ä¸‹é¢æ˜¯æ­å»ºçš„ä¸€ä¸ªè¿‡ç¨‹ä»¥åŠå¯¹äºå­¦ä¹ çš„ä¸€ä¸ªè®°å½•ï¼Œæ­¤æ¬¡webæ¡†æ¶è¿˜æ˜¯ä½¿ç”¨çš„ä¹‹å‰ç”¨Flaskå†™çš„ä¸€ä¸ªåŸºç¡€åå°ã€‚ éƒ¨ç½²æ¶æ„:. â”œâ”€â”€ README.md â”œâ”€â”€ docker-compose.yaml # ä½¿ç”¨docker-composeæ¥ç¼–æ’éƒ¨ç½² â”œâ”€â”€ flask_app # ç”¨äºè·‘Flaskåº”ç”¨çš„å®¹å™¨ â”‚&nbsp;&nbsp; â”œâ”€â”€ Dockerfile â”‚&nbsp;&nbsp; â””â”€â”€ wait_for_db_complete.sh â”œâ”€â”€ flask_app_code # åç«¯é¡¹ç›®åº”ç”¨ä»£ç ç›® â”‚&nbsp;&nbsp; â”œâ”€â”€ LICENSE â”‚&nbsp;&nbsp; â”œâ”€â”€ README.md â”‚&nbsp;&nbsp; â”œâ”€â”€ app â”‚&nbsp;&nbsp; â”œâ”€â”€ config.py â”‚&nbsp;&nbsp; â”œâ”€â”€ manage.py â”‚&nbsp;&nbsp; â”œâ”€â”€ requirements.txt â”‚&nbsp;&nbsp; â”œâ”€â”€ screenshots â”‚&nbsp;&nbsp; â””â”€â”€ tests â”œâ”€â”€ nginx # Nginxç”¨äºå‰ç«¯æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„å®¹å™¨ â”‚&nbsp;&nbsp; â””â”€â”€ nginx.conf â”œâ”€â”€ python27_baseenv # åŸºç¡€Pythonç¯å¢ƒé•œåƒ â”‚&nbsp;&nbsp; â”œâ”€â”€ Dockerfile â”‚&nbsp;&nbsp; â””â”€â”€ README.md â”œâ”€â”€ supervisor # ç”¨äºç®¡ç†uwsgiæœåŠ¡è¿›ç¨‹ â”‚&nbsp;&nbsp; â””â”€â”€ supervisord.conf â””â”€â”€ uwsgi # é€šè¿‡uWsgiæ¥ä¸ºNginx-Flaskç‰µçº¿æ­æ¡¥ â””â”€â”€ flask_uwsgi.ini è®¿é—®æµç¨‹: Nginx WebæœåŠ¡å™¨å±‚ä½œä¸ºå‰ç«¯æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼› uWSGIå±‚ä½œä¸ºWebæœåŠ¡å™¨å±‚ä¸Webæ¡†æ¶å±‚Flaskçš„ä¸€æ¡çº½å¸¦ï¼Œå°†WebæœåŠ¡å™¨å±‚ä¸Webæ¡†æ¶è¿æ¥èµ·æ¥ åç«¯Webæ¡†æ¶ä¸æ•°æ®å±‚MySQLæˆ–Redisäº¤äº’ ç®€å•ç†è§£èµ·æ¥å°±æ˜¯é…±ç´«çš„: Nginxï¼šHeyï¼ŒWSGIï¼Œæˆ‘åˆšæ”¶åˆ°äº†ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘éœ€è¦ä½ ä½œäº›å‡†å¤‡ï¼Œç„¶åç”±Flaskæ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚ WSGIï¼šOKï¼ŒNginxã€‚æˆ‘ä¼šè®¾ç½®å¥½ç¯å¢ƒå˜é‡ï¼Œç„¶åå°†è¿™ä¸ªè¯·æ±‚ä¼ é€’ç»™Flaskå¤„ç†ã€‚ Flaskï¼šThanks WSGIï¼ç»™æˆ‘ä¸€äº›æ—¶é—´ï¼Œæˆ‘å°†ä¼šæŠŠè¯·æ±‚çš„å“åº”è¿”å›ç»™ä½ ã€‚ WSGIï¼šAlrightï¼Œé‚£æˆ‘ç­‰ä½ ã€‚ Flaskï¼šOkayï¼Œæˆ‘å®Œæˆäº†ï¼Œè¿™é‡Œæ˜¯è¯·æ±‚çš„å“åº”ç»“æœï¼Œè¯·æ±‚æŠŠç»“æœä¼ é€’ç»™Nginxã€‚ WSGIï¼šGood jobï¼ Nginxï¼Œè¿™é‡Œæ˜¯å“åº”ç»“æœï¼Œå·²ç»æŒ‰ç…§è¦æ±‚ç»™ä½ ä¼ é€’å›æ¥äº†ã€‚ Nginxï¼šCoolï¼Œæˆ‘æ”¶åˆ°äº†ï¼Œæˆ‘æŠŠå“åº”ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¤§å®¶åˆä½œæ„‰å¿«~ æ­å»ºæ€è·¯: Nginx å•ç‹¬ä¸€ä¸ªå®¹å™¨ uWSGI+Flask å•ç‹¬ä¸€ä¸ªå®¹å™¨ï¼Œå…¶ä¸­uWSGIè¿›ç¨‹ç”±Supervisoræ¥ç®¡ç† MySQL å•ç‹¬ä¸€ä¸ªå®¹å™¨ï¼Œæ•°æ®ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœº Redis å•ç‹¬ä¸€ä¸ªå®¹å™¨ å„ä¸ªå®¹å™¨ä¹‹é—´çš„å…³è”é€šè¿‡docker-composeç¼–æ’æ¥å®ç° éƒ¨ç½²æ­¥éª¤ï¼šä¸»è¦è¿˜æ˜¯é€šè¿‡ç¼–å†™Dockerfileæ¥å®šåˆ¶ç‰¹å®šçš„è¿è¡Œç¯å¢ƒé•œåƒ 0.å®‰è£…dockerç¯å¢ƒcd /etc/yum.repos.d/ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo yum install -y docker-ce docker-compose systemctl start docker 1.æ„å»ºpythonåŸºç¡€è¿è¡Œç¯å¢ƒé•œåƒï¼ŒåŸºäºalpineé•œåƒcd Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker docker build -f python27_baseenv/Dockerfile . -t python27_baseenv 2.æ„å»ºFlaskåº”ç”¨æ¡†æ¶è¿è¡Œæ‰€éœ€ä¾èµ–åŒ…é•œåƒcd Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker docker build -f flask_app/Dockerfile . -t flask_app 4.Nginxé•œåƒä½¿ç”¨é»˜è®¤ï¼Œé…ç½®æ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼Œè¿™é‡Œé€šè¿‡æŒ‚è½½æ–¹å¼5.Redisé•œåƒä½¿ç”¨é»˜è®¤çš„6.æ‰§è¡Œdocker-composecd Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker docker-compose up è¿è¡ŒçŠ¶æ€ ç™»å½• ç”¨æˆ·æ³¨å†Œ Flaskåº”ç”¨çš„è®¿é—®ã€ç™»å½•ã€æ³¨å†Œè¿‡ç¨‹æ—¥å¿—Nginx uWSGI éƒ¨ç½²æ€»ç»“:éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼Œæ„Ÿè§‰åœ¨å®¿ä¸»æœºä¸­éƒ¨ç½²è¿˜æ˜¯æ²¡å¤šå¤§çš„åŒºåˆ«ï¼Œå·®åˆ«å¯èƒ½æ˜¯åœ¨æ•ˆç‡ä¸Šé¢ã€‚å®¿ä¸»æœºä¸­ä¸èƒ½å½±å“ç³»ç»Ÿè‡ªå¸¦çš„ä¸€äº›ä¸œè¥¿ï¼Œæ¯”å¦‚pythonçš„ç‰ˆæœ¬ï¼Œè¿™æ—¶å€™å¯èƒ½å°±éœ€è¦ç”¨åˆ°virtualenv, å¦‚æœæœåŠ¡å™¨è¿ç§»äº†é‚£æ•´ä¸ªç¯å¢ƒå°±éœ€è¦é‡æ–°æ­å»ºï¼Œè¿˜æ˜¯ä¸å¤ªæ–¹ä¾¿ã€‚ æ­¤æ¬¡éƒ¨ç½²å‘¢ä¸»è¦ç›®çš„è¿˜æ˜¯ä»¥è¿™ä¸ªä¸ºä¸€ä¸ªå®è·µç›®æ ‡å»å­¦ä¹ dockerçš„composeæ–‡ä»¶ç¼–å†™ï¼Œå†æŠŠå„ä¸ªå·¥å…·ç»“åˆåœ¨ä¸€èµ·è·‘åœ¨dockerä¸­å®ç°ä¹‹å‰åœ¨å®¿ä¸»æœºä¸­çš„ä¸œè¥¿ï¼›å…¶å®æŠŠæ•´ä¸ªæµç¨‹æ¢³ç†æ¸…æ¥šåç¼–å†™yamlæ–‡ä»¶ä¹Ÿå¾ˆå¿«çš„ã€‚åç»­å°è¯•æ”¾åˆ°k8sé›†ç¾¤ä¸­è·‘ğŸºğŸºğŸº åœ¨æˆ‘çš„VPSä¸Šé¢è·‘èµ·æ¥äº†â€¦ http://blog.sctux.com:8090","categories":[{"name":"Docker","slug":"Docker","permalink":"https://blog.sctux.cc/categories/Docker/"},{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"Docker/è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/Docker/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"Docker","slug":"Docker","permalink":"https://blog.sctux.cc/tags/Docker/"}],"keywords":[{"name":"Docker","slug":"Docker","permalink":"https://blog.sctux.cc/categories/Docker/"},{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"Docker/è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/Docker/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"09-K8sé›†ç¾¤æ­å»º---ç›‘æ§å±•ç¤ºç•Œé¢å®‰è£…","slug":"09k8s-ji-qun-da-jianjian-kong-zhan-shi-jie-mian-an","date":"2018-06-08T08:20:52.000Z","updated":"2025-09-01T01:59:08.937Z","comments":true,"path":"2018/06/08/09k8s-ji-qun-da-jianjian-kong-zhan-shi-jie-mian-an/","permalink":"https://blog.sctux.cc/2018/06/08/09k8s-ji-qun-da-jianjian-kong-zhan-shi-jie-mian-an/","excerpt":"1. ç®€ä»‹Heapsteræä¾›äº†æ•´ä¸ªé›†ç¾¤çš„èµ„æºç›‘æ§ï¼Œå¹¶æ”¯æŒæŒä¹…åŒ–æ•°æ®å­˜å‚¨åˆ°InfluxDBã€Google Cloud Monitoringæˆ–è€…å…¶ä»–çš„å­˜å‚¨åç«¯ã€‚Heapsterä»kubeletæä¾›çš„APIé‡‡é›†èŠ‚ç‚¹å’Œå®¹å™¨çš„èµ„æºå ç”¨ã€‚å¦å¤–ï¼ŒHeapsterçš„ /metrics APIæä¾›äº†Prometheusæ ¼å¼çš„æ•°æ®ã€‚InfluxDBæ˜¯ä¸€ä¸ªå¼€æºåˆ†å¸ƒå¼æ—¶åºã€äº‹ä»¶å’ŒæŒ‡æ ‡æ•°æ®åº“ï¼›è€ŒGrafanaåˆ™æ˜¯InfluxDBçš„ dashboardï¼Œæä¾›äº†å¼ºå¤§çš„å›¾è¡¨å±•ç¤ºåŠŸèƒ½ã€‚å®ƒä»¬å¸¸è¢«ç»„åˆä½¿ç”¨å±•ç¤ºå›¾è¡¨åŒ–çš„ç›‘æ§æ•°æ®ï¼Œä¹Ÿå¯ä»¥å°†Zabbixä½œä¸ºæ•°æ®æºï¼Œè¿›è¡Œzabbixçš„ç›‘æ§æ•°æ®å±•ç¤ºã€‚Heapsterã€InfluxDBå’ŒGrafanaå‡ä»¥Podçš„å½¢å¼å¯åŠ¨å’Œè¿è¡Œï¼Œå…¶ä¸­Heapsteréœ€è¦ä¸Kubernetes Masterè¿›è¡Œå®‰å…¨è¿æ¥ã€‚ 2. å®‰è£…é…ç½®Heapsterã€InfluxDBå’ŒGrafanaåˆ°Heapsterè·å–å®‰è£…åŒ…: [root@linux-node1 tmp]# wget https://github.com/kubernetes/heapster/archive/v1.5.3.tar.gz [root@linux-node1 tmp]# tar -xf v1.5.3.tar.gz &amp;&amp; cd heapster-1.5.3/deploy/kube-config/influxdb/ [root@linux-node1 kube-config]# ll influxdb/ total 12 -rw-rw-r-- 1 root root 2290 May 1 05:13 grafana.yaml -rw-rw-r-- 1 root root 1114 May 1 05:13 heapster.yaml -rw-rw-r-- 1 root root 974 May 1 05:13 influxdb.yaml [root@linux-node1 kube-config]# ll rbac/ total 4 -rw-rw-r-- 1 root root 264 May 1 05:13 heapster-rbac.yaml [root@linux-node1 kube-config]# # ä»¥ä¸Šæ˜¯æ‰€éœ€è¦ç”¨åˆ°çš„æ–‡ä»¶ 3. é…ç½®Docker Socks5ä»£ç†(ä¸ºä¸‹è½½æ‰€éœ€é•œåƒåšå‡†å¤‡)ç”±äºæŸå›½çš„ &amp;@#ï¿¥%&amp;ï¿¥&amp;&amp;*R#ï¿¥â€¦â€¦ ä½ æ‡‚çš„. å¯¼è‡´ä¸€äº›é•œåƒæ— æ³•pull æˆ‘è¿™è¾¹åˆ©ç”¨è‡ªå·±æ­å»ºçš„æ¢¯å­æ¥è¿›è¡Œä»£ç† [root@linux-node1 kube-config]# grep \"gcr.io\" influxdb/heapster.yaml image: gcr.io/google_containers/heapster-amd64:v1.5.3 [root@linux-node1 kube-config]# # ä¿®æ”¹dockeræœåŠ¡æ–‡ä»¶é…ç½®, åœ¨[Service]éƒ¨åˆ†æ·»åŠ ä½ è‡ªå·±çš„ssæœåŠ¡å™¨åœ°å€ [root@linux-node1 kube-config]# vim /usr/lib/systemd/system/docker.service ...... ...... [Service] Environment=\"ALL_PROXY=socks5://192.168.56.1:1080\" ...... ...... å°†å…¶å¤åˆ¶åˆ°å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶é‡è½½ã€é‡å¯DockeræœåŠ¡, ç›´æ¥pullä¸€ä¸‹éªŒè¯å³å¯ [root@linux-node1 kube-config]# docker pull gcr.io/google_containers/heapster-amd64:v1.5.3","text":"1. ç®€ä»‹Heapsteræä¾›äº†æ•´ä¸ªé›†ç¾¤çš„èµ„æºç›‘æ§ï¼Œå¹¶æ”¯æŒæŒä¹…åŒ–æ•°æ®å­˜å‚¨åˆ°InfluxDBã€Google Cloud Monitoringæˆ–è€…å…¶ä»–çš„å­˜å‚¨åç«¯ã€‚Heapsterä»kubeletæä¾›çš„APIé‡‡é›†èŠ‚ç‚¹å’Œå®¹å™¨çš„èµ„æºå ç”¨ã€‚å¦å¤–ï¼ŒHeapsterçš„ /metrics APIæä¾›äº†Prometheusæ ¼å¼çš„æ•°æ®ã€‚InfluxDBæ˜¯ä¸€ä¸ªå¼€æºåˆ†å¸ƒå¼æ—¶åºã€äº‹ä»¶å’ŒæŒ‡æ ‡æ•°æ®åº“ï¼›è€ŒGrafanaåˆ™æ˜¯InfluxDBçš„ dashboardï¼Œæä¾›äº†å¼ºå¤§çš„å›¾è¡¨å±•ç¤ºåŠŸèƒ½ã€‚å®ƒä»¬å¸¸è¢«ç»„åˆä½¿ç”¨å±•ç¤ºå›¾è¡¨åŒ–çš„ç›‘æ§æ•°æ®ï¼Œä¹Ÿå¯ä»¥å°†Zabbixä½œä¸ºæ•°æ®æºï¼Œè¿›è¡Œzabbixçš„ç›‘æ§æ•°æ®å±•ç¤ºã€‚Heapsterã€InfluxDBå’ŒGrafanaå‡ä»¥Podçš„å½¢å¼å¯åŠ¨å’Œè¿è¡Œï¼Œå…¶ä¸­Heapsteréœ€è¦ä¸Kubernetes Masterè¿›è¡Œå®‰å…¨è¿æ¥ã€‚ 2. å®‰è£…é…ç½®Heapsterã€InfluxDBå’ŒGrafanaåˆ°Heapsterè·å–å®‰è£…åŒ…: [root@linux-node1 tmp]# wget https://github.com/kubernetes/heapster/archive/v1.5.3.tar.gz [root@linux-node1 tmp]# tar -xf v1.5.3.tar.gz &amp;&amp; cd heapster-1.5.3/deploy/kube-config/influxdb/ [root@linux-node1 kube-config]# ll influxdb/ total 12 -rw-rw-r-- 1 root root 2290 May 1 05:13 grafana.yaml -rw-rw-r-- 1 root root 1114 May 1 05:13 heapster.yaml -rw-rw-r-- 1 root root 974 May 1 05:13 influxdb.yaml [root@linux-node1 kube-config]# ll rbac/ total 4 -rw-rw-r-- 1 root root 264 May 1 05:13 heapster-rbac.yaml [root@linux-node1 kube-config]# # ä»¥ä¸Šæ˜¯æ‰€éœ€è¦ç”¨åˆ°çš„æ–‡ä»¶ 3. é…ç½®Docker Socks5ä»£ç†(ä¸ºä¸‹è½½æ‰€éœ€é•œåƒåšå‡†å¤‡)ç”±äºæŸå›½çš„ &amp;@#ï¿¥%&amp;ï¿¥&amp;&amp;*R#ï¿¥â€¦â€¦ ä½ æ‡‚çš„. å¯¼è‡´ä¸€äº›é•œåƒæ— æ³•pull æˆ‘è¿™è¾¹åˆ©ç”¨è‡ªå·±æ­å»ºçš„æ¢¯å­æ¥è¿›è¡Œä»£ç† [root@linux-node1 kube-config]# grep \"gcr.io\" influxdb/heapster.yaml image: gcr.io/google_containers/heapster-amd64:v1.5.3 [root@linux-node1 kube-config]# # ä¿®æ”¹dockeræœåŠ¡æ–‡ä»¶é…ç½®, åœ¨[Service]éƒ¨åˆ†æ·»åŠ ä½ è‡ªå·±çš„ssæœåŠ¡å™¨åœ°å€ [root@linux-node1 kube-config]# vim /usr/lib/systemd/system/docker.service ...... ...... [Service] Environment=\"ALL_PROXY=socks5://192.168.56.1:1080\" ...... ...... å°†å…¶å¤åˆ¶åˆ°å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶é‡è½½ã€é‡å¯DockeræœåŠ¡, ç›´æ¥pullä¸€ä¸‹éªŒè¯å³å¯ [root@linux-node1 kube-config]# docker pull gcr.io/google_containers/heapster-amd64:v1.5.3 4. å…³é”®ç‚¹è¯´æ˜:[root@linux-node1 kube-config]# more influxdb/heapster.yaml ...... ...... - /heapster - --source=kubernetes:https://kubernetes.default - --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086 ...... ...... sourceï¼šé…ç½®é‡‡é›†æºï¼Œä¸ºMaster URLåœ°å€ï¼šâ€“source=kubernetes:https://kubernetes.default sinkï¼šé…ç½®åç«¯å­˜å‚¨ç³»ç»Ÿï¼Œä½¿ç”¨InfluxDBç³»ç»Ÿï¼šâ€“sink=influxdb:http://monitoring-influxdb:8086 è¿™é‡Œä¿æŒé»˜è®¤å³å¯ ã€æ³¨æ„ã€‘ï¼šURLä¸­çš„ä¸»æœºååœ°å€ä½¿ç”¨çš„æ˜¯InfluxDBçš„Serviceåå­—ï¼Œè¿™éœ€è¦DNSæœåŠ¡æ­£å¸¸å·¥ä½œï¼Œå¦‚æœæ²¡æœ‰é…ç½®DNSæœåŠ¡ï¼Œåˆ™ä¹Ÿå¯ä»¥ä½¿ç”¨Serviceçš„ClusterIPåœ°å€ã€‚å¦å¤–ï¼ŒInfluxDBæœåŠ¡çš„åç§°æ²¡æœ‰åŠ ä¸Šå‘½åç©ºé—´ï¼Œæ˜¯å› ä¸ºHeapsteræœåŠ¡ä¸InfluxDBæœåŠ¡å±äºç›¸åŒçš„å‘½åç©ºé—´kube-systemã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šå‘½åç©ºé—´çš„å…¨æœåŠ¡åï¼Œä¾‹å¦‚ï¼šhttp://monitoring-influxdb.kube-system:8086 ä¿®æ”¹ grafana.yamlæ–‡ä»¶[root@linux-node1 kube-config]# vim influxdb/grafana.yaml ...... ...... apiVersion: v1 kind: Service metadata: labels: # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons) # If you are NOT using this as an addon, you should comment out this line. kubernetes.io/cluster-service: 'true' kubernetes.io/name: monitoring-grafana name: monitoring-grafana namespace: kube-system spec: # In a production setup, we recommend accessing Grafana through an external Loadbalancer # or through a public IP. # type: LoadBalancer # You could also use NodePort to expose the service at a randomly-generated port type: NodePort # å»æ‰æ³¨é‡Šå³å¯ ports: - port: 80 targetPort: 3000 selector: k8s-app: grafana ...... ...... å®šä¹‰ç«¯å£ç±»å‹ä¸º NodePortï¼Œå°†Grafanaæš´éœ²åœ¨å®¿ä¸»æœºNodeçš„ç«¯å£ä¸Šï¼Œä»¥ä¾¿åç»­æµè§ˆå™¨è®¿é—® grafana çš„ admin UI ç•Œé¢ 5. æ‰§è¡Œ[root@linux-node1 kube-config]# kubectl create -f influxdb/ &amp;&amp; kubectl create -f rbac/ deployment.extensions \"monitoring-grafana\" created service \"monitoring-grafana\" created serviceaccount \"heapster\" created deployment.extensions \"heapster\" created service \"heapster\" created deployment.extensions \"monitoring-influxdb\" created service \"monitoring-influxdb\" created clusterrolebinding.rbac.authorization.k8s.io \"heapster\" created æ£€æŸ¥æ‰§è¡Œç»“æœ1. æ£€æŸ¥Deployment[root@linux-node1 kube-config]# kubectl get deployments -n kube-system -o wide | grep -E 'heapster|monitoring' heapster 1 1 1 1 11s heapster gcr.io/google_containers/heapster-amd64:v1.5.3 k8s-app=heapster,task=monitoring monitoring-grafana 1 1 1 1 11s grafana gcr.io/google_containers/heapster-grafana-amd64:v4.4.3 k8s-app=grafana,task=monitoring monitoring-influxdb 1 1 1 1 11s influxdb gcr.io/google_containers/heapster-influxdb-amd64:v1.3.3 k8s-app=influxdb,task=monitoring 2. æ£€æŸ¥POD[root@linux-node1 kube-config]# kubectl get pods -n kube-system -o wide | grep -E 'heapster|monitoring' heapster-589b7db6c9-pwrks 1/1 Running 0 32s 10.2.97.77 192.168.56.13 monitoring-grafana-d8c8d486c-l9dhx 1/1 Running 0 33s 10.2.97.76 192.168.56.13 monitoring-influxdb-54bd58b4c9-q489p 1/1 Running 0 33s 10.2.70.76 192.168.56.12 3. æ£€æŸ¥Service[root@linux-node1 kube-config]# kubectl get service -n kube-system -o wide | grep -E 'heapster|monitoring' heapster ClusterIP 10.1.102.233 &lt;none&gt; 80/TCP 50s k8s-app=heapster monitoring-grafana NodePort 10.1.18.167 &lt;none&gt; 80:21240/TCP 50s k8s-app=grafana monitoring-influxdb ClusterIP 10.1.244.92 &lt;none&gt; 8086/TCP 50s k8s-app=influxdb 4. æ£€æŸ¥ kubernets dashboard ç•Œé¢ï¼Œçœ‹æ˜¯æ˜¾ç¤ºå„ Nodesã€Pods çš„ CPUã€å†…å­˜ã€è´Ÿè½½ç­‰åˆ©ç”¨ç‡æ›²çº¿å›¾ 5. Grafanaçš„è®¿é—®:ä¸Šé¢æˆ‘ä»¬ä¸æ˜¯ä¿®æ”¹äº†å®˜æ–¹æä¾›çš„é‚£ä¸ªgrafana.yamlä¸­çš„é‚£ä¸ªNodePortå˜›ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¿é—®å°±æ˜¯http://NodeIP:NodePort","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"08-K8sé›†ç¾¤æ­å»º---CoreDNSåˆ›å»º&DashBoard","slug":"08k8s-ji-qun-da-jiancoredns-chuang-jiandashboard","date":"2018-06-03T08:45:37.000Z","updated":"2025-09-01T01:59:08.979Z","comments":true,"path":"2018/06/03/08k8s-ji-qun-da-jiancoredns-chuang-jiandashboard/","permalink":"https://blog.sctux.cc/2018/06/03/08k8s-ji-qun-da-jiancoredns-chuang-jiandashboard/","excerpt":"ç”±äºk8sé›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°éƒ½æ˜¯é€šè¿‡DNSæ¥å‘ç°å¹¶å®ç°çš„ï¼Œæ‰€ä»¥éœ€è¦ä¾èµ–DNSæœåŠ¡ 1.åˆ›å»ºcoredns.yamlæ–‡ä»¶:[root@linux-node1 ~]# cat &gt; coredns.yaml &lt;&lt; EOF apiVersion: v1 kind: ServiceAccount metadata: name: coredns namespace: kube-system labels: kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: labels: kubernetes.io/bootstrapping: rbac-defaults addonmanager.kubernetes.io/mode: Reconcile name: system:coredns rules: - apiGroups: - \"\" resources: - endpoints - services - pods - namespaces verbs: - list - watch --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \"true\" labels: kubernetes.io/bootstrapping: rbac-defaults addonmanager.kubernetes.io/mode: EnsureExists name: system:coredns roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:coredns subjects: - kind: ServiceAccount name: coredns namespace: kube-system --- apiVersion: v1 kind: ConfigMap metadata: name: coredns namespace: kube-system labels: addonmanager.kubernetes.io/mode: EnsureExists data: Corefile: | .:53 { errors health kubernetes cluster.local. in-addr.arpa ip6.arpa { pods insecure upstream fallthrough in-addr.arpa ip6.arpa } prometheus :9153 proxy . /etc/resolv.conf cache 30 } --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: coredns namespace: kube-system labels: k8s-app: coredns kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile kubernetes.io/name: \"CoreDNS\" spec: replicas: 2 strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 selector: matchLabels: k8s-app: coredns template: metadata: labels: k8s-app: coredns spec: serviceAccountName: coredns tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule - key: \"CriticalAddonsOnly\" operator: \"Exists\" containers: - name: coredns image: coredns/coredns:1.0.6 imagePullPolicy: IfNotPresent resources: limits: memory: 170Mi requests: cpu: 100m memory: 70Mi args: [ \"-conf\", \"/etc/coredns/Corefile\" ] volumeMounts: - name: config-volume mountPath: /etc/coredns ports: - containerPort: 53 name: dns protocol: UDP - containerPort: 53 name: dns-tcp protocol: TCP livenessProbe: httpGet: path: /health port: 8080 scheme: HTTP initialDelaySeconds: 60 timeoutSeconds: 5 successThreshold: 1 failureThreshold: 5 dnsPolicy: Default volumes: - name: config-volume configMap: name: coredns items: - key: Corefile path: Corefile --- apiVersion: v1 kind: Service metadata: name: coredns namespace: kube-system labels: k8s-app: coredns kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile kubernetes.io/name: \"CoreDNS\" spec: selector: k8s-app: coredns clusterIP: 10.1.0.2 #!!!!!!!å…³é”®ç‚¹!!!!!!! ports: - name: dns port: 53 protocol: UDP - name: dns-tcp port: 53 protocol: TCP EOF # æ³¨æ„ cluster ip éœ€è¦è·Ÿservice ipæ˜¯åœ¨ä¸€ä¸ªç½‘æ®µ 2.è¿è¡Œåˆ›å»º:[root@linux-node1 ~]# kubectl create -f coredns.yaml deployment.extensions \"coredns\" created Error from server (AlreadyExists): error when creating \"coredns.yaml\": serviceaccounts \"coredns\" already exists Error from server (AlreadyExists): error when creating \"coredns.yaml\": clusterroles.rbac.authorization.k8s.io \"system:coredns\" already exists Error from server (AlreadyExists): error when creating \"coredns.yaml\": clusterrolebindings.rbac.authorization.k8s.io \"system:coredns\" already exists Error from server (AlreadyExists): error when creating \"coredns.yaml\": configmaps \"coredns\" already exists Error from server (Invalid): error when creating \"coredns.yaml\": Service \"coredns\" is invalid: spec.clusterIP: Invalid value: \"10.1.0.2\": provided IP is already allocated # å¿½ç•¥ä»¥ä¸Šé”™è¯¯ï¼Œç”±äºæˆ‘å·²ç»å®‰è£…è¿‡äº†ã€‚ 3.æŸ¥çœ‹åˆ›å»ºç»“æœ:# æ³¨æ„: ä¸k8sç›¸å…³çš„ç»„ä»¶æˆ–è€…æœåŠ¡éƒ½æ˜¯åœ¨kube-systemè¿™ä¸ªå‘½åç©ºé—´ æ‰€ä»¥è¿™é‡Œ -n æŒ‡å®šäº†å‘½åç©ºé—´ä¸ºkube-system [root@linux-node1 ~]# kubectl get deployment -n kube-system NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE coredns 2 2 2 2 12m # æŸ¥çœ‹service [root@linux-node1 ~]# kubectl get service -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE coredns ClusterIP 10.1.0.2 &lt;none&gt; 53/UDP,53/TCP 32m # é€šè¿‡LVSæŸ¥çœ‹è¿™ä¸ªclusterçš„ä¿¡æ¯ [root@linux-node2 ~]# ipvsadm -Ln | grep -v \":80\" IP Virtual Server version 1.2.1 (size=4096) Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 10.1.0.1:443 rr persistent 10800 -&gt; 192.168.56.11:6443 Masq 1 2 0 TCP 10.1.0.2:53 rr -&gt; 10.2.70.216:53 Masq 1 0 0 -&gt; 10.2.97.209:53 Masq 1 0 0 UDP 10.1.0.2:53 rr -&gt; 10.2.70.216:53 Masq 1 0 0 -&gt; 10.2.97.209:53 Masq 1 0 0 # å¯ä»¥çœ‹åˆ°é€šè¿‡LVSè½¬å‘äº†ä¸¤ä¸ªPod, æŸ¥çœ‹pod: [root@linux-node1 ~]# kubectl get pod -n kube-system -o wide NAME READY STATUS RESTARTS AGE IP NODE coredns-77c989547b-55kjb 1/1 Running 0 19m 10.2.97.209 192.168.56.13 coredns-77c989547b-qvfw4 1/1 Running 0 19m 10.2.70.216 192.168.56.12 4. éªŒè¯åˆ›å»ºç»“æœ:å¯åŠ¨ä¸€ä¸ªå®¹å™¨ # å¯ä»¥çœ‹å‡ºæ¥å·²ç»è·å–åˆ°äº†dnsæœåŠ¡çš„VIPåœ°å€ [root@linux-node1 ~]# kubectl exec -it nginx-deployment-75d56bb955-b4z4k /bin/sh # cat /etc/resolv.conf nameserver 10.1.0.2 search default.svc.cluster.localping . svc.cluster.local. cluster.local. example.com options ndots:5","text":"ç”±äºk8sé›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°éƒ½æ˜¯é€šè¿‡DNSæ¥å‘ç°å¹¶å®ç°çš„ï¼Œæ‰€ä»¥éœ€è¦ä¾èµ–DNSæœåŠ¡ 1.åˆ›å»ºcoredns.yamlæ–‡ä»¶:[root@linux-node1 ~]# cat &gt; coredns.yaml &lt;&lt; EOF apiVersion: v1 kind: ServiceAccount metadata: name: coredns namespace: kube-system labels: kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: labels: kubernetes.io/bootstrapping: rbac-defaults addonmanager.kubernetes.io/mode: Reconcile name: system:coredns rules: - apiGroups: - \"\" resources: - endpoints - services - pods - namespaces verbs: - list - watch --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \"true\" labels: kubernetes.io/bootstrapping: rbac-defaults addonmanager.kubernetes.io/mode: EnsureExists name: system:coredns roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:coredns subjects: - kind: ServiceAccount name: coredns namespace: kube-system --- apiVersion: v1 kind: ConfigMap metadata: name: coredns namespace: kube-system labels: addonmanager.kubernetes.io/mode: EnsureExists data: Corefile: | .:53 { errors health kubernetes cluster.local. in-addr.arpa ip6.arpa { pods insecure upstream fallthrough in-addr.arpa ip6.arpa } prometheus :9153 proxy . /etc/resolv.conf cache 30 } --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: coredns namespace: kube-system labels: k8s-app: coredns kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile kubernetes.io/name: \"CoreDNS\" spec: replicas: 2 strategy: type: RollingUpdate rollingUpdate: maxUnavailable: 1 selector: matchLabels: k8s-app: coredns template: metadata: labels: k8s-app: coredns spec: serviceAccountName: coredns tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule - key: \"CriticalAddonsOnly\" operator: \"Exists\" containers: - name: coredns image: coredns/coredns:1.0.6 imagePullPolicy: IfNotPresent resources: limits: memory: 170Mi requests: cpu: 100m memory: 70Mi args: [ \"-conf\", \"/etc/coredns/Corefile\" ] volumeMounts: - name: config-volume mountPath: /etc/coredns ports: - containerPort: 53 name: dns protocol: UDP - containerPort: 53 name: dns-tcp protocol: TCP livenessProbe: httpGet: path: /health port: 8080 scheme: HTTP initialDelaySeconds: 60 timeoutSeconds: 5 successThreshold: 1 failureThreshold: 5 dnsPolicy: Default volumes: - name: config-volume configMap: name: coredns items: - key: Corefile path: Corefile --- apiVersion: v1 kind: Service metadata: name: coredns namespace: kube-system labels: k8s-app: coredns kubernetes.io/cluster-service: \"true\" addonmanager.kubernetes.io/mode: Reconcile kubernetes.io/name: \"CoreDNS\" spec: selector: k8s-app: coredns clusterIP: 10.1.0.2 #!!!!!!!å…³é”®ç‚¹!!!!!!! ports: - name: dns port: 53 protocol: UDP - name: dns-tcp port: 53 protocol: TCP EOF # æ³¨æ„ cluster ip éœ€è¦è·Ÿservice ipæ˜¯åœ¨ä¸€ä¸ªç½‘æ®µ 2.è¿è¡Œåˆ›å»º:[root@linux-node1 ~]# kubectl create -f coredns.yaml deployment.extensions \"coredns\" created Error from server (AlreadyExists): error when creating \"coredns.yaml\": serviceaccounts \"coredns\" already exists Error from server (AlreadyExists): error when creating \"coredns.yaml\": clusterroles.rbac.authorization.k8s.io \"system:coredns\" already exists Error from server (AlreadyExists): error when creating \"coredns.yaml\": clusterrolebindings.rbac.authorization.k8s.io \"system:coredns\" already exists Error from server (AlreadyExists): error when creating \"coredns.yaml\": configmaps \"coredns\" already exists Error from server (Invalid): error when creating \"coredns.yaml\": Service \"coredns\" is invalid: spec.clusterIP: Invalid value: \"10.1.0.2\": provided IP is already allocated # å¿½ç•¥ä»¥ä¸Šé”™è¯¯ï¼Œç”±äºæˆ‘å·²ç»å®‰è£…è¿‡äº†ã€‚ 3.æŸ¥çœ‹åˆ›å»ºç»“æœ:# æ³¨æ„: ä¸k8sç›¸å…³çš„ç»„ä»¶æˆ–è€…æœåŠ¡éƒ½æ˜¯åœ¨kube-systemè¿™ä¸ªå‘½åç©ºé—´ æ‰€ä»¥è¿™é‡Œ -n æŒ‡å®šäº†å‘½åç©ºé—´ä¸ºkube-system [root@linux-node1 ~]# kubectl get deployment -n kube-system NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE coredns 2 2 2 2 12m # æŸ¥çœ‹service [root@linux-node1 ~]# kubectl get service -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE coredns ClusterIP 10.1.0.2 &lt;none&gt; 53/UDP,53/TCP 32m # é€šè¿‡LVSæŸ¥çœ‹è¿™ä¸ªclusterçš„ä¿¡æ¯ [root@linux-node2 ~]# ipvsadm -Ln | grep -v \":80\" IP Virtual Server version 1.2.1 (size=4096) Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 10.1.0.1:443 rr persistent 10800 -&gt; 192.168.56.11:6443 Masq 1 2 0 TCP 10.1.0.2:53 rr -&gt; 10.2.70.216:53 Masq 1 0 0 -&gt; 10.2.97.209:53 Masq 1 0 0 UDP 10.1.0.2:53 rr -&gt; 10.2.70.216:53 Masq 1 0 0 -&gt; 10.2.97.209:53 Masq 1 0 0 # å¯ä»¥çœ‹åˆ°é€šè¿‡LVSè½¬å‘äº†ä¸¤ä¸ªPod, æŸ¥çœ‹pod: [root@linux-node1 ~]# kubectl get pod -n kube-system -o wide NAME READY STATUS RESTARTS AGE IP NODE coredns-77c989547b-55kjb 1/1 Running 0 19m 10.2.97.209 192.168.56.13 coredns-77c989547b-qvfw4 1/1 Running 0 19m 10.2.70.216 192.168.56.12 4. éªŒè¯åˆ›å»ºç»“æœ:å¯åŠ¨ä¸€ä¸ªå®¹å™¨ # å¯ä»¥çœ‹å‡ºæ¥å·²ç»è·å–åˆ°äº†dnsæœåŠ¡çš„VIPåœ°å€ [root@linux-node1 ~]# kubectl exec -it nginx-deployment-75d56bb955-b4z4k /bin/sh # cat /etc/resolv.conf nameserver 10.1.0.2 search default.svc.cluster.localping . svc.cluster.local. cluster.local. example.com options ndots:5 æ¢³ç†ä¸»è¦å†…å®¹ï¼š åœ¨k8sé›†ç¾¤ä¸­ï¼ŒæœåŠ¡æ˜¯è¿è¡Œåœ¨Podä¸­çš„ï¼ŒPodçš„å‘ç°å’Œå‰¯æœ¬é—´è´Ÿè½½å‡è¡¡æ˜¯æˆ‘ä»¬é¢ä¸´çš„é—®é¢˜ã€‚ é€šè¿‡Serviceå¯ä»¥è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œä½†è®¿é—®Serviceä¹Ÿéœ€è¦å¯¹åº”çš„IPï¼Œå› æ­¤åˆå¼•å…¥äº†Serviceå‘ç°çš„é—®é¢˜ã€‚ å¾—ç›Šäºcorednsæ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŸŸåæ¥è®¿é—®é›†ç¾¤å†…çš„Serviceï¼Œè§£å†³äº†Serviceå‘ç°çš„é—®é¢˜ã€‚ ä¸ºäº†è®©Podä¸­çš„å®¹å™¨å¯ä»¥ä½¿ç”¨corednsæ¥è§£æåŸŸåï¼Œk8sä¼šä¿®æ”¹å®¹å™¨çš„/etc/resolv.confé…ç½®ã€‚ æœ‰äº†ä»¥ä¸Šæœºåˆ¶çš„ä¿è¯ï¼Œå°±å¯ä»¥åœ¨Podä¸­é€šè¿‡Serviceåç§°å’Œnamespaceéå¸¸æ–¹ä¾¿åœ°è®¿é—®å¯¹åº”çš„æœåŠ¡äº†ã€‚ DashBoardéƒ¨ç½²dashboard[root@linux-node1 ~]# kubectl create -f dashboard/ # æŸ¥çœ‹é›†ç¾¤è¯¦æƒ… [root@linux-node1 ~]# kubectl cluster-info Kubernetes master is running at https://192.168.56.11:6443 CoreDNS is running at https://192.168.56.11:6443/api/v1/namespaces/kube-system/services/coredns:dns/proxy kubernetes-dashboard is running at https://192.168.56.11:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'. [root@linux-node1 src]# kubectl get services kubernetes-dashboard -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes-dashboard NodePort 10.1.27.148 &lt;none&gt; 443:28966/TCP 3d ç™»å½•:ï¿¼ è·å–ç™»å½•ä»¤ç‰Œ: [root@linux-node1 src]# kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}') # å¤åˆ¶ tokençš„å†…å®¹éƒ¨åˆ† è¾“å…¥ ç™»å½• ï¿¼","categories":[{"name":"è™šæ‹ŸåŒ–&amp;äº‘è®¡ç®—&amp;å¤§æ•°æ®","slug":"è™šæ‹ŸåŒ–-amp-äº‘è®¡ç®—-amp-å¤§æ•°æ®","permalink":"https://blog.sctux.cc/categories/%E8%99%9A%E6%8B%9F%E5%8C%96-amp-%E4%BA%91%E8%AE%A1%E7%AE%97-amp-%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"è™šæ‹ŸåŒ–&amp;äº‘è®¡ç®—&amp;å¤§æ•°æ®","slug":"è™šæ‹ŸåŒ–-amp-äº‘è®¡ç®—-amp-å¤§æ•°æ®","permalink":"https://blog.sctux.cc/categories/%E8%99%9A%E6%8B%9F%E5%8C%96-amp-%E4%BA%91%E8%AE%A1%E7%AE%97-amp-%E5%A4%A7%E6%95%B0%E6%8D%AE/"}]},{"title":"07-K8sé›†ç¾¤æ­å»º---åˆ›å»ºK8såº”ç”¨","slug":"07k8s-ji-qun-da-jianchuang-jiank8s-ying-yong","date":"2018-06-03T02:28:32.000Z","updated":"2025-09-01T01:59:08.876Z","comments":true,"path":"2018/06/03/07k8s-ji-qun-da-jianchuang-jiank8s-ying-yong/","permalink":"https://blog.sctux.cc/2018/06/03/07k8s-ji-qun-da-jianchuang-jiank8s-ying-yong/","excerpt":"1.åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„deployment[root@linux-node1 ~]# kubectl run net-test --image=alpine --replicas=3 sleep 360000 2.æŸ¥çœ‹åˆ›å»ºæƒ…å†µ[root@linux-node1 ~]# kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE net-test-5767cb94df-6crmr 1/1 Running 0 17s 10.2.97.176 192.168.56.13 net-test-5767cb94df-9mpmb 1/1 Running 0 17s 10.2.70.187 192.168.56.12 net-test-5767cb94df-x8l44 1/1 Running 0 17s 10.2.97.175 192.168.56.13 # ä½¿ç”¨kubectlåˆ›å»ºäº†ä¸€ä¸ªåä¸ºnet-test çš„deployment, é•œåƒæ˜¯alpine å‰¯æœ¬æ•°ä¸º3ï¼Œ [root@linux-node1 ~]# kubectl get deployments NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE net-test 3 3 3 3 7m 3.æµ‹è¯•è”é€šæ€§ping 10.2.97.176 é€šè¿‡yamlæ–‡ä»¶éƒ¨ç½²åº”ç”¨1.ç¼–å†™ä¸€ä¸ªnginx-deployment.yamlæ–‡ä»¶:[root@linux-node1 ~]# cat &gt; nginx-deployment.yaml &lt;&lt; EOF apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.10.3 ports: - containerPort: 80 EOF 2.æ‰§è¡Œåˆ›å»º:","text":"1.åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„deployment[root@linux-node1 ~]# kubectl run net-test --image=alpine --replicas=3 sleep 360000 2.æŸ¥çœ‹åˆ›å»ºæƒ…å†µ[root@linux-node1 ~]# kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE net-test-5767cb94df-6crmr 1/1 Running 0 17s 10.2.97.176 192.168.56.13 net-test-5767cb94df-9mpmb 1/1 Running 0 17s 10.2.70.187 192.168.56.12 net-test-5767cb94df-x8l44 1/1 Running 0 17s 10.2.97.175 192.168.56.13 # ä½¿ç”¨kubectlåˆ›å»ºäº†ä¸€ä¸ªåä¸ºnet-test çš„deployment, é•œåƒæ˜¯alpine å‰¯æœ¬æ•°ä¸º3ï¼Œ [root@linux-node1 ~]# kubectl get deployments NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE net-test 3 3 3 3 7m 3.æµ‹è¯•è”é€šæ€§ping 10.2.97.176 é€šè¿‡yamlæ–‡ä»¶éƒ¨ç½²åº”ç”¨1.ç¼–å†™ä¸€ä¸ªnginx-deployment.yamlæ–‡ä»¶:[root@linux-node1 ~]# cat &gt; nginx-deployment.yaml &lt;&lt; EOF apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.10.3 ports: - containerPort: 80 EOF 2.æ‰§è¡Œåˆ›å»º:[root@linux-node1 ~]# kubectl create -f nginx-deployment.yaml deployment.apps \"nginx-deployment\" created # æŸ¥çœ‹deployment [root@linux-node1 ~]# kubectl get deployment/nginx-deployment NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE nginx-deployment 10 10 10 10 1m # æŸ¥çœ‹deployment è¯¦æƒ… [root@linux-node1 ~]# kubectl describe deployment/nginx-deployment Name: nginx-deployment Namespace: default CreationTimestamp: Thu, 31 May 2018 20:20:17 +0800 Labels: app=nginx Annotations: deployment.kubernetes.io/revision=1 Selector: app=nginx Replicas: 10 desired | 10 updated | 10 total | 10 available | 0 unavailable StrategyType: RollingUpdate MinReadySeconds: 0 RollingUpdateStrategy: 25% max unavailable, 25% max surge Pod Template: Labels: app=nginx Containers: nginx: Image: nginx:1.10.3 Port: 80/TCP Host Port: 0/TCP Environment: &lt;none&gt; Mounts: &lt;none&gt; Volumes: &lt;none&gt; Conditions: Type Status Reason ---- ------ ------ Progressing True NewReplicaSetAvailable Available True MinimumReplicasAvailable OldReplicaSets: &lt;none&gt; NewReplicaSet: nginx-deployment-75d56bb955 (10/10 replicas created) Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 5m deployment-controller Scaled up replica set nginx-deployment-75d56bb955 to 3 Normal ScalingReplicaSet 1m (x2 over 3m) deployment-controller Scaled down replica set nginx-deployment-75d56bb955 to 3 Normal ScalingReplicaSet 57s (x3 over 5m) deployment-controller Scaled up replica set nginx-deployment-75d56bb955 to 10 # æŸ¥çœ‹pod ,å¯ä»¥çœ‹å‡ºæŒ‰ç…§æˆ‘ä»¬çš„æè¿°æ–‡ä»¶é‡Œé¢çš„å‰¯æœ¬æ•°å·²ç»æœ‰10ä¸ªPODé€šè¿‡Scheduleåˆ°äº†ä¸åŒçš„nodeèŠ‚ç‚¹ä¸Šé¢ [root@linux-node1 ~]# kubectl get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE net-test-5767cb94df-6crmr 1/1 Running 0 40m 10.2.97.178 192.168.56.13 net-test-5767cb94df-9mpmb 1/1 Running 0 40m 10.2.70.187 192.168.56.12 net-test-5767cb94df-x8l44 1/1 Running 0 40m 10.2.97.177 192.168.56.13 nginx-deployment-75d56bb955-255w2 1/1 Running 0 3m 10.2.70.196 192.168.56.12 nginx-deployment-75d56bb955-5ckvs 1/1 Running 0 8m 10.2.70.188 192.168.56.12 nginx-deployment-75d56bb955-7dq87 1/1 Running 0 3m 10.2.70.198 192.168.56.12 nginx-deployment-75d56bb955-8vl7p 1/1 Running 0 3m 10.2.97.191 192.168.56.13 nginx-deployment-75d56bb955-9f9ms 1/1 Running 0 3m 10.2.97.189 192.168.56.13 nginx-deployment-75d56bb955-9g9bk 1/1 Running 0 3m 10.2.97.188 192.168.56.13 nginx-deployment-75d56bb955-9kz2r 1/1 Running 0 3m 10.2.70.197 192.168.56.12 nginx-deployment-75d56bb955-s78gs 1/1 Running 0 8m 10.2.70.189 192.168.56.12 nginx-deployment-75d56bb955-v8n5v 1/1 Running 0 3m 10.2.97.190 192.168.56.13 nginx-deployment-75d56bb955-zfb4m 1/1 Running 0 8m 10.2.97.179 192.168.56.13 # æŸ¥çœ‹æŸä¸ªpodè¯¦æƒ… [root@linux-node1 ~]# kubectl describe pod/nginx-deployment-75d56bb955-255w2 Name: nginx-deployment-75d56bb955-255w2 Namespace: default Node: 192.168.56.12/192.168.56.12 Start Time: Thu, 31 May 2018 20:24:31 +0800 Labels: app=nginx pod-template-hash=3181266511 Annotations: &lt;none&gt; Status: Running IP: 10.2.70.196 Controlled By: ReplicaSet/nginx-deployment-75d56bb955 Containers: nginx: Container ID: docker://48ad80730efd6d744ac6d31b34778eb8e75b0f4c6698e1c1fc8f6046a6a77b2b Image: nginx:1.10.3 Image ID: docker-pullable://nginx@sha256:6202beb06ea61f44179e02ca965e8e13b961d12640101fca213efbfd145d7575 Port: 80/TCP Host Port: 0/TCP State: Running Started: Thu, 31 May 2018 20:24:33 +0800 Ready: True Restart Count: 0 Environment: &lt;none&gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from default-token-5htws (ro) Conditions: Type Status Initialized True Ready True PodScheduled True Volumes: default-token-5htws: Type: Secret (a volume populated by a Secret) SecretName: default-token-5htws Optional: false QoS Class: BestEffort Node-Selectors: &lt;none&gt; Tolerations: &lt;none&gt; Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal SuccessfulMountVolume 3m kubelet, 192.168.56.12 MountVolume.SetUp succeeded for volume \"default-token-5htws\" Normal Pulled 3m kubelet, 192.168.56.12 Container image \"nginx:1.10.3\" already present on machine Normal Created 3m kubelet, 192.168.56.12 Created container Normal Started 3m kubelet, 192.168.56.12 Started container Normal Scheduled 2m default-scheduler Successfully assigned nginx-deployment-75d56bb955-255w2 to 192.168.56.12 # è®¿é—®Nginx pod [root@linux-node1 ~]# curl -I http://10.2.70.196 HTTP/1.1 200 OK Server: nginx/1.10.3 Date: Thu, 31 May 2018 12:30:45 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 31 Jan 2017 15:01:11 GMT Connection: keep-alive ETag: \"5890a6b7-264\" Accept-Ranges: byte # æ›´æ–°deployment [root@linux-node1 ~]# kubectl set image deployment/nginx-deployment nginx=nginx:1.12.2 --record deployment.apps \"nginx-deployment\" image updated # å¯ä»¥çœ‹åˆ°æ›´æ–°å·²ç»æˆåŠŸ(æ»šåŠ¨æ›´æ–°) [root@linux-node1 ~]# kubectl get deployment/nginx-deployment -o wide NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR nginx-deployment 10 10 10 10 17m nginx nginx:1.12.2 app=nginx [root@linux-node1 ~]# curl -I 10.2.97.192 HTTP/1.1 200 OK Server: nginx/1.12.2 # ç‰ˆæœ¬å·²ç»æ›´æ–°æˆåŠŸ Date: Thu, 31 May 2018 12:35:54 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 11 Jul 2017 13:29:18 GMT Connection: keep-alive ETag: \"5964d2ae-264\" Accept-Ranges: bytes # æŸ¥çœ‹deploymentæ›´æ–°å†å² [root@linux-node1 ~]# kubectl rollout history deployment/nginx-deployment deployments \"nginx-deployment\" REVISION CHANGE-CAUSE 1 &lt;none&gt; # ç”¨äºåœ¨ä¹‹å‰åœ¨åˆ›å»ºåˆ›å»ºnginx deploymentçš„æ—¶å€™ æœªåŠ å‚æ•° --record æ‰€ä»¥è¿™ä¸ªä¿¡æ¯ä¸ºnone 2 kubectl set image deployment/nginx-deployment nginx=nginx:1.12.2 --record=true # æŸ¥çœ‹ç‰ˆæœ¬è¯¦æƒ…(--revison=VERSION_NUM) [root@linux-node1 ~]# kubectl rollout history deployment/nginx-deployment --revision=1 deployments \"nginx-deployment\" with revision #1 Pod Template: Labels: app=nginx pod-template-hash=3181266511 Containers: nginx: Image: nginx:1.10.3 Port: 80/TCP Host Port: 0/TCP Environment: &lt;none&gt; Mounts: &lt;none&gt; Volumes: &lt;none&gt; # ç‰ˆæœ¬å›æ»šè‡³ä¸Šä¸€ä¸ªç‰ˆæœ¬: [root@linux-node1 ~]# kubectl rollout undo deployment/nginx-deployment deployment.apps \"nginx-deployment\" [root@linux-node1 ~]# kubectl get deployment/nginx-deployment -o wide NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR nginx-deployment 10 10 10 10 26m nginx nginx:1.10.3 app=nginx # æ‰©å®¹podæ•°é‡ [root@linux-node1 ~]# kubectl scale --replicas=20 deployment nginx-deployment deployment.extensions \"nginx-deployment\" scaled [root@linux-node1 ~]# kubectl get deployment/nginx-deployment -o wide NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR nginx-deployment 20 20 20 20 28m nginx nginx:1.10.3 app=nginx é‚£é—®é¢˜æ¥äº†: æ¯æ¬¡æ”¶åˆ°è·å–podIPå¤ªæ‰¯äº†ï¼Œæ€»ä¸èƒ½æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨æ”¹ç¨‹åºæˆ–è€…é…ç½®æ‰èƒ½è®¿é—®æœåŠ¡å§ï¼Œè¦æ€ä¹ˆæå‰çŸ¥é“podIPå‘¢ï¼Ÿ Podåœ¨è¿è¡Œä¸­å¯èƒ½ä¼šé‡å»ºï¼ŒIPå˜äº†æ€ä¹ˆè§£ï¼Ÿ å¦‚ä½•åœ¨å¤šä¸ªPodä¸­å®ç°è´Ÿè½½å‡è¡¡å˜ï¼Ÿ è¿™äº›é—®é¢˜ä½¿ç”¨k8s Serviceå°±å¯ä»¥è§£å†³ã€‚ Serviceå¯ä»¥å°†pod IPå°è£…èµ·æ¥ï¼Œå³ä½¿Podå‘ç”Ÿé‡å»ºï¼Œä¾ç„¶å¯ä»¥é€šè¿‡Serviceæ¥è®¿é—®Podæä¾›çš„æœåŠ¡ã€‚æ­¤å¤–ï¼ŒServiceè¿˜è§£å†³äº†è´Ÿè½½å‡è¡¡çš„é—®é¢˜ï¼Œå¤§å®¶å¯ä»¥å¤šè®¿é—®å‡ æ¬¡Serviceï¼Œç„¶åé€šè¿‡kubectl logs æ¥æŸ¥çœ‹Nginx Podçš„è®¿é—®æ—¥å¿—æ¥ç¡®è®¤ åˆ›å»ºä¸€ä¸ªå¯¹äºnginx deploymentçš„ä¸€ä¸ªservice1.ç¼–å†™nginx-service.yamlæ–‡ä»¶[root@linux-node1 ~]# cat &gt; nginx-service.yaml &lt;&lt; EOF kind: Service apiVersion: v1 metadata: name: nginx-service spec: selector: app: nginx ports: - protocol: TCP port: 80 targetPort: 80 EOF 2.æ‰§è¡Œåˆ›å»ºæ“ä½œ:[root@linux-node1 ~]# kubectl create -f nginx-service.yaml service \"nginx-service\" created [root@linux-node1 ~]# kubectl get service -o wide NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR kubernetes ClusterIP 10.1.0.1 &lt;none&gt; 443/TCP 3d &lt;none&gt; nginx-service ClusterIP 10.1.146.223 &lt;none&gt; 80/TCP 30s app=nginx # è®¿é—®VIP [root@linux-node1 ~]# curl -I http://10.1.146.223 HTTP/1.1 200 OK Server: nginx/1.10.3 Date: Thu, 31 May 2018 12:54:54 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 31 Jan 2017 15:01:11 GMT Connection: keep-alive ETag: \"5890a6b7-264\" Accept-Ranges: bytes # åœ¨èŠ‚ç‚¹2ä¸ŠæŸ¥çœ‹LVSï¼Œé€šè¿‡k8så°è£…LVSæ¥å®ç°äº†è´Ÿè½½å‡è¡¡ [root@linux-node2 ~]# ipvsadm -Ln IP Virtual Server version 1.2.1 (size=4096) Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 10.1.0.1:443 rr persistent 10800 -&gt; 192.168.56.11:6443 Masq 1 1 0 TCP 10.1.146.223:80 rr -&gt; 10.2.70.204:80 Masq 1 0 0 -&gt; 10.2.70.205:80 Masq 1 0 1 -&gt; 10.2.70.206:80 Masq 1 0 0 -&gt; 10.2.70.207:80 Masq 1 0 0 -&gt; 10.2.70.208:80 Masq 1 0 0 -&gt; 10.2.70.209:80 Masq 1 0 0 -&gt; 10.2.70.210:80 Masq 1 0 0 -&gt; 10.2.70.211:80 Masq 1 0 0 -&gt; 10.2.70.212:80 Masq 1 0 0 -&gt; 10.2.70.213:80 Masq 1 0 0 -&gt; 10.2.97.197:80 Masq 1 0 0 -&gt; 10.2.97.198:80 Masq 1 0 0 -&gt; 10.2.97.199:80 Masq 1 0 1 -&gt; 10.2.97.200:80 Masq 1 0 0 -&gt; 10.2.97.201:80 Masq 1 0 0 -&gt; 10.2.97.202:80 Masq 1 0 1 -&gt; 10.2.97.203:80 Masq 1 0 1 -&gt; 10.2.97.204:80 Masq 1 0 0 -&gt; 10.2.97.205:80 Masq 1 0 0","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"06-K8sé›†ç¾¤æ­å»º---Flannelç½‘ç»œéƒ¨ç½²","slug":"06k8s-ji-qun-da-jianflannel-wang-luo-bu-shu","date":"2018-06-02T00:51:42.000Z","updated":"2025-09-01T01:59:08.879Z","comments":true,"path":"2018/06/02/06k8s-ji-qun-da-jianflannel-wang-luo-bu-shu/","permalink":"https://blog.sctux.cc/2018/06/02/06k8s-ji-qun-da-jianflannel-wang-luo-bu-shu/","excerpt":"1.ä¸ºFlannelç”Ÿæˆè¯ä¹¦[root@linux-node1 ~]# vim flanneld-csr.json { \"CN\": \"flanneld\", \"hosts\": [], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } 2.ç”Ÿæˆè¯ä¹¦[root@linux-node1 ~]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \\ -ca-key=/opt/kubernetes/ssl/ca-key.pem \\ -config=/opt/kubernetes/ssl/ca-config.json \\ -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld 3.åˆ†å‘è¯ä¹¦[root@linux-node1 ~]# cp flanneld*.pem /opt/kubernetes/ssl/ [root@linux-node1 ~]# scp flanneld*.pem 192.168.56.12:/opt/kubernetes/ssl/ [root@linux-node1 ~]# scp flanneld*.pem 192.168.56.13:/opt/kubernetes/ssl/ 4.ä¸‹è½½Flannelè½¯ä»¶åŒ…[root@linux-node1 ~]# cd /usr/local/src # wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz [root@linux-node1 src]# tar zxf flannel-v0.10.0-linux-amd64.tar.gz [root@linux-node1 src]# cp flanneld mk-docker-opts.sh /opt/kubernetes/bin/ å¤åˆ¶åˆ°linux-node2èŠ‚ç‚¹ [root@linux-node1 src]# scp flanneld mk-docker-opts.sh 192.168.56.12:/opt/kubernetes/bin/ [root@linux-node1 src]# scp flanneld mk-docker-opts.sh 192.168.56.13:/opt/kubernetes/bin/ å¤åˆ¶å¯¹åº”è„šæœ¬åˆ°/opt/kubernetes/binç›®å½•ä¸‹ã€‚ [root@linux-node1 ~]# cd /usr/local/src/kubernetes/cluster/centos/node/bin/ [root@linux-node1 bin]# cp remove-docker0.sh /opt/kubernetes/bin/ [root@linux-node1 bin]# scp remove-docker0.sh 192.168.56.12:/opt/kubernetes/bin/ [root@linux-node1 bin]# scp remove-docker0.sh 192.168.56.13:/opt/kubernetes/bin/ 5.é…ç½®Flannel[root@linux-node1 ~]# vim /opt/kubernetes/cfg/flannel FLANNEL_ETCD=\"-etcd-endpoints=https://192.168.56.11:2379,https://192.168.56.12:2379,https://192.168.56.13:2379\" FLANNEL_ETCD_KEY=\"-etcd-prefix=/kubernetes/network\" FLANNEL_ETCD_CAFILE=\"--etcd-cafile=/opt/kubernetes/ssl/ca.pem\" FLANNEL_ETCD_CERTFILE=\"--etcd-certfile=/opt/kubernetes/ssl/flanneld.pem\" FLANNEL_ETCD_KEYFILE=\"--etcd-keyfile=/opt/kubernetes/ssl/flanneld-key.pem\" å¤åˆ¶é…ç½®åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Š [root@linux-node1 ~]# scp /opt/kubernetes/cfg/flannel 192.168.56.12:/opt/kubernetes/cfg/ [root@linux-node1 ~]# scp /opt/kubernetes/cfg/flannel 192.168.56.13:/opt/kubernetes/cfg/","text":"1.ä¸ºFlannelç”Ÿæˆè¯ä¹¦[root@linux-node1 ~]# vim flanneld-csr.json { \"CN\": \"flanneld\", \"hosts\": [], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } 2.ç”Ÿæˆè¯ä¹¦[root@linux-node1 ~]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \\ -ca-key=/opt/kubernetes/ssl/ca-key.pem \\ -config=/opt/kubernetes/ssl/ca-config.json \\ -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld 3.åˆ†å‘è¯ä¹¦[root@linux-node1 ~]# cp flanneld*.pem /opt/kubernetes/ssl/ [root@linux-node1 ~]# scp flanneld*.pem 192.168.56.12:/opt/kubernetes/ssl/ [root@linux-node1 ~]# scp flanneld*.pem 192.168.56.13:/opt/kubernetes/ssl/ 4.ä¸‹è½½Flannelè½¯ä»¶åŒ…[root@linux-node1 ~]# cd /usr/local/src # wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz [root@linux-node1 src]# tar zxf flannel-v0.10.0-linux-amd64.tar.gz [root@linux-node1 src]# cp flanneld mk-docker-opts.sh /opt/kubernetes/bin/ å¤åˆ¶åˆ°linux-node2èŠ‚ç‚¹ [root@linux-node1 src]# scp flanneld mk-docker-opts.sh 192.168.56.12:/opt/kubernetes/bin/ [root@linux-node1 src]# scp flanneld mk-docker-opts.sh 192.168.56.13:/opt/kubernetes/bin/ å¤åˆ¶å¯¹åº”è„šæœ¬åˆ°/opt/kubernetes/binç›®å½•ä¸‹ã€‚ [root@linux-node1 ~]# cd /usr/local/src/kubernetes/cluster/centos/node/bin/ [root@linux-node1 bin]# cp remove-docker0.sh /opt/kubernetes/bin/ [root@linux-node1 bin]# scp remove-docker0.sh 192.168.56.12:/opt/kubernetes/bin/ [root@linux-node1 bin]# scp remove-docker0.sh 192.168.56.13:/opt/kubernetes/bin/ 5.é…ç½®Flannel[root@linux-node1 ~]# vim /opt/kubernetes/cfg/flannel FLANNEL_ETCD=\"-etcd-endpoints=https://192.168.56.11:2379,https://192.168.56.12:2379,https://192.168.56.13:2379\" FLANNEL_ETCD_KEY=\"-etcd-prefix=/kubernetes/network\" FLANNEL_ETCD_CAFILE=\"--etcd-cafile=/opt/kubernetes/ssl/ca.pem\" FLANNEL_ETCD_CERTFILE=\"--etcd-certfile=/opt/kubernetes/ssl/flanneld.pem\" FLANNEL_ETCD_KEYFILE=\"--etcd-keyfile=/opt/kubernetes/ssl/flanneld-key.pem\" å¤åˆ¶é…ç½®åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Š [root@linux-node1 ~]# scp /opt/kubernetes/cfg/flannel 192.168.56.12:/opt/kubernetes/cfg/ [root@linux-node1 ~]# scp /opt/kubernetes/cfg/flannel 192.168.56.13:/opt/kubernetes/cfg/ 6.è®¾ç½®Flannelç³»ç»ŸæœåŠ¡[root@linux-node1 ~]# vim /usr/lib/systemd/system/flannel.service [Unit] Description=Flanneld overlay address etcd agent After=network.target Before=docker.service [Service] EnvironmentFile=-/opt/kubernetes/cfg/flannel ExecStartPre=/opt/kubernetes/bin/remove-docker0.sh ExecStart=/opt/kubernetes/bin/flanneld --ip-masq ${FLANNEL_ETCD} ${FLANNEL_ETCD_KEY} ${FLANNEL_ETCD_CAFILE} ${FLANNEL_ETCD_CERTFILE} ${FLANNEL_ETCD_KEYFILE} ExecStartPost=/opt/kubernetes/bin/mk-docker-opts.sh -d /run/flannel/docker Type=notify [Install] WantedBy=multi-user.target RequiredBy=docker.service å¤åˆ¶ç³»ç»ŸæœåŠ¡è„šæœ¬åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Š # scp /usr/lib/systemd/system/flannel.service 192.168.56.12:/usr/lib/systemd/system/ # scp /usr/lib/systemd/system/flannel.service 192.168.56.13:/usr/lib/systemd/system/ Flannel CNIé›†æˆ1.ä¸‹è½½CNIæ’ä»¶https://github.com/containernetworking/plugins/releases wget https://github.com/containernetworking/plugins/releases/download/v0.7.1/cni-plugins-amd64-v0.7.1.tgz [root@linux-node1 ~]# mkdir /opt/kubernetes/bin/cni [root@linux-node1 src]# tar zxf cni-plugins-amd64-v0.7.1.tgz -C /opt/kubernetes/bin/cni # scp -r /opt/kubernetes/bin/cni/* 192.168.56.12:/opt/kubernetes/bin/cni/ # scp -r /opt/kubernetes/bin/cni/* 192.168.56.13:/opt/kubernetes/bin/cni/ 2.åˆ›å»ºEtcdçš„key/opt/kubernetes/bin/etcdctl --ca-file /opt/kubernetes/ssl/ca.pem --cert-file /opt/kubernetes/ssl/flanneld.pem --key-file /opt/kubernetes/ssl/flanneld-key.pem \\ --no-sync -C https://192.168.56.11:2379,https://192.168.56.12:2379,https://192.168.56.13:2379 \\ mk /kubernetes/network/config '{ \"Network\": \"10.2.0.0/16\", \"Backend\": { \"Type\": \"vxlan\", \"VNI\": 1 }}' &gt;/dev/null 2&gt;&amp;1 3.å¯åŠ¨flannel[root@linux-node1 ~]# systemctl daemon-reload [root@linux-node1 ~]# systemctl enable flannel [root@linux-node1 ~]# chmod +x /opt/kubernetes/bin/* [root@linux-node1 ~]# systemctl start flannel 4.æŸ¥çœ‹æœåŠ¡çŠ¶æ€[root@linux-node1 ~]# systemctl status flannel é…ç½®Dockerä½¿ç”¨Flannel[root@linux-node1 ~]# vim /usr/lib/systemd/system/docker.service [Unit] #åœ¨Unitä¸‹é¢ä¿®æ”¹Afterå’Œå¢åŠ Requires After=network-online.target firewalld.service flannel.service Wants=network-online.target Requires=flannel.service [Service] #å¢åŠ EnvironmentFile=-/run/flannel/docker Type=not EnvironmentFile=-/run/flannel/docker ExecStart=/usr/bin/dockerd $DOCKER_OPTS 1.å°†é…ç½®å¤åˆ¶åˆ°å¦å¤–çš„èŠ‚ç‚¹[root@linux-node1 ~]# scp /usr/lib/systemd/system/docker.service 192.168.56.12:/usr/lib/systemd/system/ [root@linux-node1 ~]# scp /usr/lib/systemd/system/docker.service 192.168.56.13:/usr/lib/systemd/system/ 2.é‡å¯Docker[root@linux-node1 ~]# systemctl daemon-reload [root@linux-node1 ~]# systemctl restart docker # æ­¤æ—¶å°±å¯ä»¥çœ‹åˆ°docker0ç½‘å¡çš„IP è·Ÿflaneelæ˜¯ä¸€ä¸ªç½‘æ®µçš„äº†ï¼š [root@linux-node2 ~]# ip a | egrep \"flannel|docker0\" 6: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN inet 10.2.70.0/32 scope global flannel.1 7: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1400 qdisc noqueue state DOWN inet 10.2.70.1/24 brd 10.2.70.255 scope global docker0","categories":[{"name":"è™šæ‹ŸåŒ–&amp;äº‘è®¡ç®—&amp;å¤§æ•°æ®","slug":"è™šæ‹ŸåŒ–-amp-äº‘è®¡ç®—-amp-å¤§æ•°æ®","permalink":"https://blog.sctux.cc/categories/%E8%99%9A%E6%8B%9F%E5%8C%96-amp-%E4%BA%91%E8%AE%A1%E7%AE%97-amp-%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"è™šæ‹ŸåŒ–&amp;äº‘è®¡ç®—&amp;å¤§æ•°æ®","slug":"è™šæ‹ŸåŒ–-amp-äº‘è®¡ç®—-amp-å¤§æ•°æ®","permalink":"https://blog.sctux.cc/categories/%E8%99%9A%E6%8B%9F%E5%8C%96-amp-%E4%BA%91%E8%AE%A1%E7%AE%97-amp-%E5%A4%A7%E6%95%B0%E6%8D%AE/"}]},{"title":"05-K8sé›†ç¾¤æ­å»º---NodeèŠ‚ç‚¹éƒ¨ç½²","slug":"05k8s-ji-qun-da-jiannode-jie-dian-bu-shu","date":"2018-06-01T22:47:38.000Z","updated":"2025-09-01T01:59:08.922Z","comments":true,"path":"2018/06/02/05k8s-ji-qun-da-jiannode-jie-dian-bu-shu/","permalink":"https://blog.sctux.cc/2018/06/02/05k8s-ji-qun-da-jiannode-jie-dian-bu-shu/","excerpt":"éƒ¨ç½²kubelet1.è½¯ä»¶åŒ…å‡†å¤‡[root@linux-node1 ~]# cd /usr/local/src/kubernetes/server/bin/ [root@linux-node1 bin]# cp kubelet kube-proxy /opt/kubernetes/bin/ [root@linux-node1 bin]# scp kubelet kube-proxy 192.168.56.12:/opt/kubernetes/bin/ [root@linux-node1 bin]# scp kubelet kube-proxy 192.168.56.13:/opt/kubernetes/bin/ 2.åˆ›å»ºè§’è‰²ç»‘å®škubelet å¯åŠ¨æ—¶å‘ kube-apiserver å‘é€ TLS bootstrapping è¯·æ±‚ï¼Œéœ€è¦å…ˆå°† bootstrap token æ–‡ä»¶ä¸­çš„ kubelet-bootstrap ç”¨æˆ·èµ‹äºˆ system:node-bootstrapper cluster è§’è‰²(role)ï¼Œ ç„¶å kubelet æ‰èƒ½æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚(certificate signing requests): [root@linux-node1 ~]# cd /usr/local/src/ssl [root@linux-node1 ~]# kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap clusterrolebinding \"kubelet-bootstrap\" created --user=kubelet-bootstrap æ˜¯åœ¨ /opt/kubernetes/ssl/bootstrap-token.csv æ–‡ä»¶ä¸­æŒ‡å®šçš„ç”¨æˆ·åï¼ŒåŒæ—¶ä¹Ÿå†™å…¥äº†bootstrap.kubeconfig æ–‡ä»¶ï¼› 3.åˆ›å»º kubelet bootstrapping kubeconfig æ–‡ä»¶ è®¾ç½®é›†ç¾¤å‚æ•°[root@linux-node1 ~]# kubectl config set-cluster kubernetes \\ --certificate-authority=/opt/kubernetes/ssl/ca.pem \\ --embed-certs=true \\ --server=https://192.168.56.11:6443 \\ --kubeconfig=bootstrap.kubeconfig Cluster \"kubernetes\" set. # è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•° [root@linux-node1 ~]# kubectl config set-credentials kubelet-bootstrap \\ --token=ad6d5bb607a186796d8861557df0d17f \\ --kubeconfig=bootstrap.kubeconfig User \"kubelet-bootstrap\" set. # è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•° [root@linux-node1 ~]# kubectl config set-context default \\ --cluster=kubernetes \\ --user=kubelet-bootstrap \\ --kubeconfig=bootstrap.kubeconfig Context \"default\" created. #é€‰æ‹©é»˜è®¤ä¸Šä¸‹æ–‡ [root@linux-node1 ~]# kubectl config use-context default --kubeconfig=bootstrap.kubeconfig Switched to context \"default\". [root@linux-node1 kubernetes]# cp bootstrap.kubeconfig /opt/kubernetes/cfg [root@linux-node1 kubernetes]# scp bootstrap.kubeconfig 192.168.56.12:/opt/kubernetes/cfg [root@linux-node1 kubernetes]# scp bootstrap.kubeconfig 192.168.56.13:/opt/kubernetes/cfg 4.é…ç½®CNIæ”¯æŒ","text":"éƒ¨ç½²kubelet1.è½¯ä»¶åŒ…å‡†å¤‡[root@linux-node1 ~]# cd /usr/local/src/kubernetes/server/bin/ [root@linux-node1 bin]# cp kubelet kube-proxy /opt/kubernetes/bin/ [root@linux-node1 bin]# scp kubelet kube-proxy 192.168.56.12:/opt/kubernetes/bin/ [root@linux-node1 bin]# scp kubelet kube-proxy 192.168.56.13:/opt/kubernetes/bin/ 2.åˆ›å»ºè§’è‰²ç»‘å®škubelet å¯åŠ¨æ—¶å‘ kube-apiserver å‘é€ TLS bootstrapping è¯·æ±‚ï¼Œéœ€è¦å…ˆå°† bootstrap token æ–‡ä»¶ä¸­çš„ kubelet-bootstrap ç”¨æˆ·èµ‹äºˆ system:node-bootstrapper cluster è§’è‰²(role)ï¼Œ ç„¶å kubelet æ‰èƒ½æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚(certificate signing requests): [root@linux-node1 ~]# cd /usr/local/src/ssl [root@linux-node1 ~]# kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap clusterrolebinding \"kubelet-bootstrap\" created --user=kubelet-bootstrap æ˜¯åœ¨ /opt/kubernetes/ssl/bootstrap-token.csv æ–‡ä»¶ä¸­æŒ‡å®šçš„ç”¨æˆ·åï¼ŒåŒæ—¶ä¹Ÿå†™å…¥äº†bootstrap.kubeconfig æ–‡ä»¶ï¼› 3.åˆ›å»º kubelet bootstrapping kubeconfig æ–‡ä»¶ è®¾ç½®é›†ç¾¤å‚æ•°[root@linux-node1 ~]# kubectl config set-cluster kubernetes \\ --certificate-authority=/opt/kubernetes/ssl/ca.pem \\ --embed-certs=true \\ --server=https://192.168.56.11:6443 \\ --kubeconfig=bootstrap.kubeconfig Cluster \"kubernetes\" set. # è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•° [root@linux-node1 ~]# kubectl config set-credentials kubelet-bootstrap \\ --token=ad6d5bb607a186796d8861557df0d17f \\ --kubeconfig=bootstrap.kubeconfig User \"kubelet-bootstrap\" set. # è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•° [root@linux-node1 ~]# kubectl config set-context default \\ --cluster=kubernetes \\ --user=kubelet-bootstrap \\ --kubeconfig=bootstrap.kubeconfig Context \"default\" created. #é€‰æ‹©é»˜è®¤ä¸Šä¸‹æ–‡ [root@linux-node1 ~]# kubectl config use-context default --kubeconfig=bootstrap.kubeconfig Switched to context \"default\". [root@linux-node1 kubernetes]# cp bootstrap.kubeconfig /opt/kubernetes/cfg [root@linux-node1 kubernetes]# scp bootstrap.kubeconfig 192.168.56.12:/opt/kubernetes/cfg [root@linux-node1 kubernetes]# scp bootstrap.kubeconfig 192.168.56.13:/opt/kubernetes/cfg 4.é…ç½®CNIæ”¯æŒ[root@linux-node2 ~]# mkdir -p /etc/cni/net.d [root@linux-node2 ~]# vim /etc/cni/net.d/10-default.conf { \"name\": \"flannel\", \"type\": \"flannel\", \"delegate\": { \"bridge\": \"docker0\", \"isDefaultGateway\": true, \"mtu\": 1400 } } 5.åˆ›å»ºkubeletæ‰€éœ€ç›®å½•[root@linux-node2 ~]# mkdir /var/lib/kubelet 6.åˆ›å»ºkubeletç³»ç»ŸæœåŠ¡[root@k8s-node2 ~]# cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF [Unit] Description=Kubernetes Kubelet Documentation=https://github.com/GoogleCloudPlatform/kubernetes After=docker.service Requires=docker.service [Service] WorkingDirectory=/var/lib/kubelet ExecStart=/opt/kubernetes/bin/kubelet \\ --address=192.168.56.12 \\ --hostname-override=192.168.56.12 \\ --pod-infra-container-image=mirrorgooglecontainers/pause-amd64:3.0 \\ --experimental-bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\ --kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\ --cert-dir=/opt/kubernetes/ssl \\ --network-plugin=cni \\ --cni-conf-dir=/etc/cni/net.d \\ --cni-bin-dir=/opt/kubernetes/bin/cni \\ --cluster-dns=10.1.0.2 \\ --cluster-domain=cluster.local. \\ --hairpin-mode hairpin-veth \\ --allow-privileged=true \\ --fail-swap-on=false \\ --logtostderr=true \\ --v=2 \\ --logtostderr=false \\ --log-dir=/opt/kubernetes/log Restart=on-failure RestartSec=5 [Install] WantedBy=multi-user.target EOF 7.å¯åŠ¨å¹¶æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š[root@linux-node2 ~]# systemctl daemon-reload [root@linux-node2 ~]# systemctl enable kubelet [root@linux-node2 ~]# systemctl start kubelet [root@linux-node2 kubernetes]# systemctl status kubelet 8.æŸ¥çœ‹csrè¯·æ±‚ æ³¨æ„æ˜¯åœ¨linux-node1ä¸Šæ‰§è¡Œã€‚[root@linux-node1 ~]# kubectl get csr NAME AGE REQUESTOR CONDITION node-csr-0_w5F1FM_la_SeGiu3Y5xELRpYUjjT2icIFk9gO9KOU 1m kubelet-bootstrap Pending 9.æ‰¹å‡†kubelet çš„ TLS è¯ä¹¦è¯·æ±‚[root@linux-node1 ~]# kubectl get csr|grep 'Pending' | awk 'NR&gt;0{print $1}'| xargs kubectl certificate approve #æ‰§è¡Œå®Œæ¯•åï¼ŒæŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€å·²ç»æ˜¯Readyçš„çŠ¶æ€äº† [root@linux-node1 ssl]# kubectl get nodes NAME STATUS ROLES AGE VERSION 192.168.56.12 Ready &lt;none&gt; 2m v1.10.1 éƒ¨ç½²Kubernetes Proxy1.é…ç½®kube-proxyä½¿ç”¨LVS[root@linux-node2 ~]# yum install -y ipvsadm ipset conntrack 2.åˆ›å»º kube-proxy è¯ä¹¦è¯·æ±‚[root@linux-node1 ~]# cd /usr/local/src/ssl/ [root@linux-node1 ~]# cat &gt; kube-proxy-csr.json &lt;&lt; EOF { \"CN\": \"system:kube-proxy\", \"hosts\": [], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } EOF 3.ç”Ÿæˆè¯ä¹¦[root@linux-node1~]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \\ -ca-key=/opt/kubernetes/ssl/ca-key.pem \\ -config=/opt/kubernetes/ssl/ca-config.json \\ -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy 4.åˆ†å‘è¯ä¹¦åˆ°æ‰€æœ‰NodeèŠ‚ç‚¹[root@linux-node1 ssl]# cp kube-proxy*.pem /opt/kubernetes/ssl/ [root@linux-node1 ssl]# scp kube-proxy*.pem 192.168.56.12:/opt/kubernetes/ssl/ [root@linux-node1 ssl]# scp kube-proxy*.pem 192.168.56.12:/opt/kubernetes/ssl/ 5.åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶# è®¾ç½®é›†ç¾¤å‚æ•° [root@linux-node1 ssl]# kubectl config set-cluster kubernetes \\ --certificate-authority=/opt/kubernetes/ssl/ca.pem \\ --embed-certs=true \\ --server=https://192.168.56.11:6443 \\ --kubeconfig=kube-proxy.kubeconfig Cluster \"kubernetes\" set. # è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•° [root@linux-node1 ssl]# kubectl config set-credentials kube-proxy \\ --client-certificate=/opt/kubernetes/ssl/kube-proxy.pem \\ --client-key=/opt/kubernetes/ssl/kube-proxy-key.pem \\ --embed-certs=true \\ --kubeconfig=kube-proxy.kubeconfig User \"kube-proxy\" set. # è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•° [root@linux-node1 ssl]# kubectl config set-context default \\ --cluster=kubernetes \\ --user=kube-proxy \\ --kubeconfig=kube-proxy.kubeconfig Context \"default\" created. # è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡ [root@linux-node1 ssl]# kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig Switched to context \"default\". 6.åˆ†å‘kubeconfigé…ç½®æ–‡ä»¶[root@linux-node1 ssl]# cp kube-proxy.kubeconfig /opt/kubernetes/cfg/ [root@linux-node1 ssl]# scp kube-proxy.kubeconfig 192.168.56.12:/opt/kubernetes/cfg/ [root@linux-node1 ssl]# scp kube-proxy.kubeconfig 192.168.56.13:/opt/kubernetes/cfg/ 7.åˆ›å»ºkube-proxyç³»ç»ŸæœåŠ¡[root@linux-node2 bin]# mkdir /var/lib/kube-proxy [root@k8s-node2 ~]# vim /usr/lib/systemd/system/kube-proxy.service [Unit] Description=Kubernetes Kube-Proxy Server Documentation=https://github.com/GoogleCloudPlatform/kubernetes After=network.target [Service] WorkingDirectory=/var/lib/kube-proxy ExecStart=/opt/kubernetes/bin/kube-proxy \\ --bind-address=192.168.56.12 \\ --hostname-override=192.168.56.12 \\ --kubeconfig=/opt/kubernetes/cfg/kube-proxy.kubeconfig \\ --masquerade-all \\ --feature-gates=SupportIPVSProxyMode=true \\ --proxy-mode=ipvs \\ --ipvs-min-sync-period=5s \\ --ipvs-sync-period=5s \\ --ipvs-scheduler=rr \\ --logtostderr=true \\ --v=2 \\ --logtostderr=false \\ --log-dir=/opt/kubernetes/log Restart=on-failure RestartSec=5 LimitNOFILE=65536 [Install] WantedBy=multi-user.target 8.å¯åŠ¨Kubernetes Proxyå¹¶æŸ¥çœ‹çŠ¶æ€:systemctl status kube-proxy [root@linux-node2 ~]# systemctl daemon-reload [root@linux-node2 ~]# systemctl enable kube-proxy [root@linux-node2 ~]# systemctl start kube-proxy [root@linux-node2 ~]# systemctl status kube-proxy #æ£€æŸ¥LVSçŠ¶æ€ [root@linux-node2 ~]# ipvsadm -L -n IP Virtual Server version 1.2.1 (size=4096) Prot LocalAddress:Port Scheduler Flags -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 10.1.0.1:443 rr persistent 10800 -&gt; 192.168.56.11:6443 Masq 1 0 0 9.éªŒè¯nodeèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸éƒ¨ç½²(node3æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤å¯åŠ¨æœåŠ¡å³å¯1ï¼Œ7ï¼Œ8)[root@linux-node1 ssl]# kubectl get nodes NAME STATUS ROLES AGE VERSION 192.168.56.12 Ready &lt;none&gt; 12m v1.10.1 192.168.56.13 Ready &lt;none&gt; 2d v1.10.1","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"04-K8sé›†ç¾¤æ­å»º---MasterèŠ‚ç‚¹éƒ¨ç½²","slug":"04k8s-ji-qun-da-jianmaster-jie-dian-bu-shu","date":"2018-06-01T20:59:27.000Z","updated":"2025-09-01T01:59:08.967Z","comments":true,"path":"2018/06/02/04k8s-ji-qun-da-jianmaster-jie-dian-bu-shu/","permalink":"https://blog.sctux.cc/2018/06/02/04k8s-ji-qun-da-jianmaster-jie-dian-bu-shu/","excerpt":"masterèŠ‚ç‚¹æ¶‰åŠæœåŠ¡ç»„ä»¶ApiServer , Scheduler , ControllerManager, kubectl 1.è½¯ä»¶åŒ…å‡†å¤‡:[root@linux-node1 ~]# cd /usr/local/src/kubernetes [root@linux-node1 kubernetes]# cp server/bin/kube-apiserver /opt/kubernetes/bin/ [root@linux-node1 kubernetes]# cp server/bin/kube-controller-manager /opt/kubernetes/bin/ [root@linux-node1 kubernetes]# cp server/bin/kube-scheduler /opt/kubernetes/bin/ 2.åˆ›å»ºç”ŸæˆCSRçš„ JSON é…ç½®æ–‡ä»¶:[root@linux-node1 src]# cat &gt; kubernetes-csr.json &lt;&lt; EOF { \"CN\": \"kubernetes\", \"hosts\": [ \"127.0.0.1\", \"192.168.56.11\", \"10.1.0.1\", \"kubernetes\", \"kubernetes.default\", \"kubernetes.default.svc\", \"kubernetes.default.svc.cluster\", \"kubernetes.default.svc.cluster.local\" ], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } EOF 3.ç”Ÿæˆ kubernetes è¯ä¹¦å’Œç§é’¥:[root@linux-node1 src]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \\ -ca-key=/opt/kubernetes/ssl/ca-key.pem \\ -config=/opt/kubernetes/ssl/ca-config.json \\ -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes [root@linux-node1 src]# cp kubernetes*.pem /opt/kubernetes/ssl/ [root@linux-node1 ~]# scp kubernetes*.pem 192.168.56.12:/opt/kubernetes/ssl/ [root@linux-node1 ~]# scp kubernetes*.pem 192.168.56.13:/opt/kubernetes/ssl/ 4.åˆ›å»º kube-apiserver ä½¿ç”¨çš„å®¢æˆ·ç«¯ token æ–‡ä»¶[root@linux-node1 ~]# head -c 16 /dev/urandom | od -An -t x | tr -d ' ' ad6d5bb607a186796d8861557df0d17f [root@linux-node1 ~]# vim /opt/kubernetes/ssl/ bootstrap-token.csv ad6d5bb607a186796d8861557df0d17f,kubelet-bootstrap,10001,\"system:kubelet-bootstrap\" 5.åˆ›å»ºåŸºç¡€ç”¨æˆ·å/å¯†ç è®¤è¯é…ç½®","text":"masterèŠ‚ç‚¹æ¶‰åŠæœåŠ¡ç»„ä»¶ApiServer , Scheduler , ControllerManager, kubectl 1.è½¯ä»¶åŒ…å‡†å¤‡:[root@linux-node1 ~]# cd /usr/local/src/kubernetes [root@linux-node1 kubernetes]# cp server/bin/kube-apiserver /opt/kubernetes/bin/ [root@linux-node1 kubernetes]# cp server/bin/kube-controller-manager /opt/kubernetes/bin/ [root@linux-node1 kubernetes]# cp server/bin/kube-scheduler /opt/kubernetes/bin/ 2.åˆ›å»ºç”ŸæˆCSRçš„ JSON é…ç½®æ–‡ä»¶:[root@linux-node1 src]# cat &gt; kubernetes-csr.json &lt;&lt; EOF { \"CN\": \"kubernetes\", \"hosts\": [ \"127.0.0.1\", \"192.168.56.11\", \"10.1.0.1\", \"kubernetes\", \"kubernetes.default\", \"kubernetes.default.svc\", \"kubernetes.default.svc.cluster\", \"kubernetes.default.svc.cluster.local\" ], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } EOF 3.ç”Ÿæˆ kubernetes è¯ä¹¦å’Œç§é’¥:[root@linux-node1 src]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \\ -ca-key=/opt/kubernetes/ssl/ca-key.pem \\ -config=/opt/kubernetes/ssl/ca-config.json \\ -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes [root@linux-node1 src]# cp kubernetes*.pem /opt/kubernetes/ssl/ [root@linux-node1 ~]# scp kubernetes*.pem 192.168.56.12:/opt/kubernetes/ssl/ [root@linux-node1 ~]# scp kubernetes*.pem 192.168.56.13:/opt/kubernetes/ssl/ 4.åˆ›å»º kube-apiserver ä½¿ç”¨çš„å®¢æˆ·ç«¯ token æ–‡ä»¶[root@linux-node1 ~]# head -c 16 /dev/urandom | od -An -t x | tr -d ' ' ad6d5bb607a186796d8861557df0d17f [root@linux-node1 ~]# vim /opt/kubernetes/ssl/ bootstrap-token.csv ad6d5bb607a186796d8861557df0d17f,kubelet-bootstrap,10001,\"system:kubelet-bootstrap\" 5.åˆ›å»ºåŸºç¡€ç”¨æˆ·å/å¯†ç è®¤è¯é…ç½®[root@linux-node1 ~]# vim /opt/kubernetes/ssl/basic-auth.csv admin,admin,1 readonly,readonly,2 6.éƒ¨ç½²K8S ApiServeræœåŠ¡a.å°†ApiServeré…ç½®ä¸ºç³»ç»ŸæœåŠ¡[root@linux-node1 ~]# vim /usr/lib/systemd/system/kube-apiserver.service [Unit] Description=Kubernetes API Server Documentation=https://github.com/GoogleCloudPlatform/kubernetes After=network.target [Service] ExecStart=/opt/kubernetes/bin/kube-apiserver \\ --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction \\ --bind-address=192.168.56.11 \\ --insecure-bind-address=127.0.0.1 \\ --authorization-mode=Node,RBAC \\ --runtime-config=rbac.authorization.k8s.io/v1 \\ --kubelet-https=true \\ --anonymous-auth=false \\ --basic-auth-file=/opt/kubernetes/ssl/basic-auth.csv \\ --enable-bootstrap-token-auth \\ --token-auth-file=/opt/kubernetes/ssl/bootstrap-token.csv \\ --service-cluster-ip-range=10.1.0.0/16 \\ --service-node-port-range=20000-40000 \\ --tls-cert-file=/opt/kubernetes/ssl/kubernetes.pem \\ --tls-private-key-file=/opt/kubernetes/ssl/kubernetes-key.pem \\ --client-ca-file=/opt/kubernetes/ssl/ca.pem \\ --service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\ --etcd-cafile=/opt/kubernetes/ssl/ca.pem \\ --etcd-certfile=/opt/kubernetes/ssl/kubernetes.pem \\ --etcd-keyfile=/opt/kubernetes/ssl/kubernetes-key.pem \\ --etcd-servers=https://192.168.56.11:2379,https://192.168.56.12:2379,https://192.168.56.13:2379 \\ --enable-swagger-ui=true \\ --allow-privileged=true \\ --audit-log-maxage=30 \\ --audit-log-maxbackup=3 \\ --audit-log-maxsize=100 \\ --audit-log-path=/opt/kubernetes/log/api-audit.log \\ --event-ttl=1h \\ --v=2 \\ --logtostderr=false \\ --log-dir=/opt/kubernetes/log Restart=on-failure RestartSec=5 Type=notify LimitNOFILE=65536 [Install] WantedBy=multi-user.target b.å¯åŠ¨API ServeræœåŠ¡[root@linux-node1 ~]# systemctl daemon-reload [root@linux-node1 ~]# systemctl enable kube-apiserver [root@linux-node1 ~]# systemctl start kube-apiserver #æŸ¥çœ‹API ServeræœåŠ¡çŠ¶æ€ [root@linux-node1 ~]# systemctl status kube-apiserver 7.éƒ¨ç½²K8S ControllerManageræœåŠ¡a.å°†ControllerManageré…ç½®ä¸ºç³»ç»ŸæœåŠ¡[root@linux-node1 ~]# vim /usr/lib/systemd/system/kube-controller-manager.service [Unit] Description=Kubernetes Controller Manager Documentation=https://github.com/GoogleCloudPlatform/kubernetes [Service] ExecStart=/opt/kubernetes/bin/kube-controller-manager \\ --address=127.0.0.1 \\ --master=http://127.0.0.1:8080 \\ --allocate-node-cidrs=true \\ --service-cluster-ip-range=10.1.0.0/16 \\ --cluster-cidr=10.2.0.0/16 \\ --cluster-name=kubernetes \\ --cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\ --cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem \\ --service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\ --root-ca-file=/opt/kubernetes/ssl/ca.pem \\ --leader-elect=true \\ --v=2 \\ --logtostderr=false \\ --log-dir=/opt/kubernetes/log Restart=on-failure RestartSec=5 [Install] WantedBy=multi-user.target b.å¯åŠ¨ControllerManageræœåŠ¡[root@linux-node1 ~]# systemctl daemon-reload [root@linux-node1 scripts]# systemctl enable kube-controller-manager [root@linux-node1 scripts]# systemctl start kube-controller-manager # æŸ¥çœ‹ControllerManageræœåŠ¡çŠ¶æ€ [root@linux-node1 scripts]# systemctl status kube-controller-manager éƒ¨ç½²K8S ScheduleræœåŠ¡a.å°†Scheduleré…ç½®ä¸ºç³»ç»ŸæœåŠ¡[root@linux-node1 ~]# vim /usr/lib/systemd/system/kube-scheduler.service [Unit] Description=Kubernetes Scheduler Documentation=https://github.com/GoogleCloudPlatform/kubernetes [Service] ExecStart=/opt/kubernetes/bin/kube-scheduler \\ --address=127.0.0.1 \\ --master=http://127.0.0.1:8080 \\ --leader-elect=true \\ --v=2 \\ --logtostderr=false \\ --log-dir=/opt/kubernetes/log Restart=on-failure RestartSec=5 [Install] WantedBy=multi-user.target b.å¯åŠ¨ScheduleræœåŠ¡[root@linux-node1 ~]# systemctl daemon-reload [root@linux-node1 scripts]# systemctl enable kube-scheduler [root@linux-node1 scripts]# systemctl start kube-scheduler # æŸ¥çœ‹ScheduleræœåŠ¡çŠ¶æ€ [root@linux-node1 scripts]# systemctl status kube-scheduler éƒ¨ç½²kubectl å‘½ä»¤è¡Œå·¥å…·1.å‡†å¤‡äºŒè¿›åˆ¶å‘½ä»¤åŒ…[root@linux-node1 ~]# cd /usr/local/src/kubernetes/client/bin [root@linux-node1 bin]# cp kubectl /opt/kubernetes/bin/ 2.åˆ›å»º admin è¯ä¹¦ç­¾åè¯·æ±‚fds[root@linux-node1 ~]# cd /usr/local/src/ssl/ [root@linux-node1 ssl]# vim admin-csr.json { \"CN\": \"admin\", \"hosts\": [], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"system:masters\", \"OU\": \"System\" } ] } 3.ç”Ÿæˆ admin è¯ä¹¦å’Œç§é’¥ï¼š[root@linux-node1 ssl]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \\ -ca-key=/opt/kubernetes/ssl/ca-key.pem \\ -config=/opt/kubernetes/ssl/ca-config.json \\ -profile=kubernetes admin-csr.json | cfssljson -bare admin [root@linux-node1 ssl]# ls -l admin* -rw-r--r-- 1 root root 1009 Mar 5 12:29 admin.csr -rw-r--r-- 1 root root 229 Mar 5 12:28 admin-csr.json -rw------- 1 root root 1675 Mar 5 12:29 admin-key.pem -rw-r--r-- 1 root root 1399 Mar 5 12:29 admin.pem [root@linux-node1 src]# mv admin*.pem /opt/kubernetes/ssl/ 4.è®¾ç½®é›†ç¾¤å‚æ•°[root@linux-node1 src]# kubectl config set-cluster kubernetes \\ --certificate-authority=/opt/kubernetes/ssl/ca.pem \\ --embed-certs=true \\ --server=https://192.168.56.11:6443 Cluster \"kubernetes\" set. 5.è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°[root@linux-node1 src]# kubectl config set-credentials admin \\ --client-certificate=/opt/kubernetes/ssl/admin.pem \\ --embed-certs=true \\ --client-key=/opt/kubernetes/ssl/admin-key.pem User \"admin\" set. 6.è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°[root@linux-node1 src]# kubectl config set-context kubernetes \\ --cluster=kubernetes \\ --user=admin Context \"kubernetes\" created. 7.è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡[root@linux-node1 src]# kubectl config use-context kubernetes Switched to context \"kubernetes\". 8.ä½¿ç”¨kubectlå·¥å…·[root@linux-node1 ~]# kubectl get cs NAME STATUS MESSAGE ERROR controller-manager Healthy ok scheduler Healthy ok etcd-1 Healthy {\"health\":\"true\"} etcd-2 Healthy {\"health\":\"true\"} etcd-0 Healthy {\"health\":\"true\"} è‡³æ­¤ k8sMasterç«¯ä»¥åŠetcdé›†ç¾¤å·²ç»æ­å»ºå®Œæ¯•","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"03-K8sé›†ç¾¤æ­å»º---éƒ¨ç½²ETCDé›†ç¾¤","slug":"03k8s-ji-qun-da-jian-sanbu-shuetcd-ji-qun","date":"2018-06-01T18:39:59.000Z","updated":"2025-09-01T01:59:08.957Z","comments":true,"path":"2018/06/02/03k8s-ji-qun-da-jian-sanbu-shuetcd-ji-qun/","permalink":"https://blog.sctux.cc/2018/06/02/03k8s-ji-qun-da-jian-sanbu-shuetcd-ji-qun/","excerpt":"0.è§£å‹å®‰è£…åˆ†å‘etcdäºŒè¿›åˆ¶åŒ…:[root@linux-node1 src]# tar zxf etcd-v3.2.18-linux-amd64.tar.gz [root@linux-node1 src]# cd etcd-v3.2.18-linux-amd64 [root@linux-node1 etcd-v3.2.18-linux-amd64]# chmod +x etcdctl [root@linux-node1 etcd-v3.2.18-linux-amd64]# cp etcd etcdctl /opt/kubernetes/bin/ [root@linux-node1 etcd-v3.2.18-linux-amd64]# scp etcd etcdctl 192.168.56.12:/opt/kubernetes/bin/ [root@linux-node1 etcd-v3.2.18-linux-amd64]# scp etcd etcdctl 192.168.56.13:/opt/kubernetes/bin/ 1.åˆ›å»º etcd è¯ä¹¦ç­¾åè¯·æ±‚ï¼š[root@linux-node1 ~]# cat &gt; etcd-csr.json &lt;&lt; EOF { \"CN\": \"etcd\", \"hosts\": [ \"127.0.0.1\", \"192.168.56.11\", \"192.168.56.12\", \"192.168.56.13\" ], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } EOF 2.ç”Ÿæˆ etcd è¯ä¹¦å’Œç§é’¥ï¼š[root@linux-node1 ~]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \\ -ca-key=/opt/kubernetes/ssl/ca-key.pem \\ -config=/opt/kubernetes/ssl/ca-config.json \\ -profile=kubernetes etcd-csr.json | cfssljson -bare etcd # ä¼šç”Ÿæˆä»¥ä¸‹è¯ä¹¦æ–‡ä»¶ [root@linux-node1 ssl]# ll etc* -rw-r--r-- 1 root root 1062 May 28 15:39 etcd.csr -rw-r--r-- 1 root root 287 May 28 15:38 etcd-csr.json -rw------- 1 root root 1679 May 28 15:39 etcd-key.pem -rw-r--r-- 1 root root 1436 May 28 15:39 etcd.pem 3.å°†è¯ä¹¦ç§»åŠ¨åˆ°/opt/kubernetes/sslç›®å½•ä¸‹:[root@linux-node1 ~]# cp etcd*.pem /opt/kubernetes/ssl [root@linux-node1 ~]# scp etcd*.pem 192.168.56.12:/opt/kubernetes/ssl [root@linux-node1 ~]# scp etcd*.pem 192.168.56.13:/opt/kubernetes/ssl [root@linux-node1 ~]# rm -f etcd.csr etcd-csr.json 4.å¢åŠ etcdé…ç½®æ–‡ä»¶:!!!!! æ³¨æ„è¿™é‡Œéœ€è¦ä¿®æ”¹ç›¸å…³å¯¹åº”æœåŠ¡å™¨çš„IPåœ°å€ !!!!! [root@linux-node1 ~]# vim /opt/kubernetes/cfg/etcd.conf #[member] ETCD_NAME=\"etcd-node1\" # ä¿®æ”¹èŠ‚ç‚¹å¯¹åº”åç§° ETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\" #ETCD_SNAPSHOT_COUNTER=\"10000\" #ETCD_HEARTBEAT_INTERVAL=\"100\" #ETCD_ELECTION_TIMEOUT=\"1000\" ETCD_LISTEN_PEER_URLS=\"https://192.168.56.11:2380\" # ä¿®æ”¹å¯¹åº”æœåŠ¡å™¨IP ETCD_LISTEN_CLIENT_URLS=\"https://192.168.56.11:2379,https://127.0.0.1:2379\" #ETCD_MAX_SNAPSHOTS=\"5\" #ETCD_MAX_WALS=\"5\" #ETCD_CORS=\"\" #[cluster] ETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://192.168.56.11:2380\" # ä¿®æ”¹å¯¹åº”æœåŠ¡å™¨IP # if you use different ETCD_NAME (e.g. test), # set ETCD_INITIAL_CLUSTER value for this name, i.e. \"test=http://...\" ETCD_INITIAL_CLUSTER=\"etcd-node1=https://192.168.56.11:2380,etcd-node2=https://192.168.56.12:2380,etcd-node3=https://192.168.56.13:2380\" ETCD_INITIAL_CLUSTER_STATE=\"new\" ETCD_INITIAL_CLUSTER_TOKEN=\"k8s-etcd-cluster\" ETCD_ADVERTISE_CLIENT_URLS=\"https://192.168.56.11:2379\" # ä¿®æ”¹å¯¹åº”æœåŠ¡å™¨IP #[security] CLIENT_CERT_AUTH=\"true\" ETCD_CA_FILE=\"/opt/kubernetes/ssl/ca.pem\" ETCD_CERT_FILE=\"/opt/kubernetes/ssl/etcd.pem\" ETCD_KEY_FILE=\"/opt/kubernetes/ssl/etcd-key.pem\" PEER_CLIENT_CERT_AUTH=\"true\" ETCD_PEER_CA_FILE=\"/opt/kubernetes/ssl/ca.pem\" ETCD_PEER_CERT_FILE=\"/opt/kubernetes/ssl/etcd.pem\" ETCD_PEER_KEY_FILE=\"/opt/kubernetes/ssl/etcd-key.pem\"","text":"0.è§£å‹å®‰è£…åˆ†å‘etcdäºŒè¿›åˆ¶åŒ…:[root@linux-node1 src]# tar zxf etcd-v3.2.18-linux-amd64.tar.gz [root@linux-node1 src]# cd etcd-v3.2.18-linux-amd64 [root@linux-node1 etcd-v3.2.18-linux-amd64]# chmod +x etcdctl [root@linux-node1 etcd-v3.2.18-linux-amd64]# cp etcd etcdctl /opt/kubernetes/bin/ [root@linux-node1 etcd-v3.2.18-linux-amd64]# scp etcd etcdctl 192.168.56.12:/opt/kubernetes/bin/ [root@linux-node1 etcd-v3.2.18-linux-amd64]# scp etcd etcdctl 192.168.56.13:/opt/kubernetes/bin/ 1.åˆ›å»º etcd è¯ä¹¦ç­¾åè¯·æ±‚ï¼š[root@linux-node1 ~]# cat &gt; etcd-csr.json &lt;&lt; EOF { \"CN\": \"etcd\", \"hosts\": [ \"127.0.0.1\", \"192.168.56.11\", \"192.168.56.12\", \"192.168.56.13\" ], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } EOF 2.ç”Ÿæˆ etcd è¯ä¹¦å’Œç§é’¥ï¼š[root@linux-node1 ~]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \\ -ca-key=/opt/kubernetes/ssl/ca-key.pem \\ -config=/opt/kubernetes/ssl/ca-config.json \\ -profile=kubernetes etcd-csr.json | cfssljson -bare etcd # ä¼šç”Ÿæˆä»¥ä¸‹è¯ä¹¦æ–‡ä»¶ [root@linux-node1 ssl]# ll etc* -rw-r--r-- 1 root root 1062 May 28 15:39 etcd.csr -rw-r--r-- 1 root root 287 May 28 15:38 etcd-csr.json -rw------- 1 root root 1679 May 28 15:39 etcd-key.pem -rw-r--r-- 1 root root 1436 May 28 15:39 etcd.pem 3.å°†è¯ä¹¦ç§»åŠ¨åˆ°/opt/kubernetes/sslç›®å½•ä¸‹:[root@linux-node1 ~]# cp etcd*.pem /opt/kubernetes/ssl [root@linux-node1 ~]# scp etcd*.pem 192.168.56.12:/opt/kubernetes/ssl [root@linux-node1 ~]# scp etcd*.pem 192.168.56.13:/opt/kubernetes/ssl [root@linux-node1 ~]# rm -f etcd.csr etcd-csr.json 4.å¢åŠ etcdé…ç½®æ–‡ä»¶:!!!!! æ³¨æ„è¿™é‡Œéœ€è¦ä¿®æ”¹ç›¸å…³å¯¹åº”æœåŠ¡å™¨çš„IPåœ°å€ !!!!! [root@linux-node1 ~]# vim /opt/kubernetes/cfg/etcd.conf #[member] ETCD_NAME=\"etcd-node1\" # ä¿®æ”¹èŠ‚ç‚¹å¯¹åº”åç§° ETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\" #ETCD_SNAPSHOT_COUNTER=\"10000\" #ETCD_HEARTBEAT_INTERVAL=\"100\" #ETCD_ELECTION_TIMEOUT=\"1000\" ETCD_LISTEN_PEER_URLS=\"https://192.168.56.11:2380\" # ä¿®æ”¹å¯¹åº”æœåŠ¡å™¨IP ETCD_LISTEN_CLIENT_URLS=\"https://192.168.56.11:2379,https://127.0.0.1:2379\" #ETCD_MAX_SNAPSHOTS=\"5\" #ETCD_MAX_WALS=\"5\" #ETCD_CORS=\"\" #[cluster] ETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://192.168.56.11:2380\" # ä¿®æ”¹å¯¹åº”æœåŠ¡å™¨IP # if you use different ETCD_NAME (e.g. test), # set ETCD_INITIAL_CLUSTER value for this name, i.e. \"test=http://...\" ETCD_INITIAL_CLUSTER=\"etcd-node1=https://192.168.56.11:2380,etcd-node2=https://192.168.56.12:2380,etcd-node3=https://192.168.56.13:2380\" ETCD_INITIAL_CLUSTER_STATE=\"new\" ETCD_INITIAL_CLUSTER_TOKEN=\"k8s-etcd-cluster\" ETCD_ADVERTISE_CLIENT_URLS=\"https://192.168.56.11:2379\" # ä¿®æ”¹å¯¹åº”æœåŠ¡å™¨IP #[security] CLIENT_CERT_AUTH=\"true\" ETCD_CA_FILE=\"/opt/kubernetes/ssl/ca.pem\" ETCD_CERT_FILE=\"/opt/kubernetes/ssl/etcd.pem\" ETCD_KEY_FILE=\"/opt/kubernetes/ssl/etcd-key.pem\" PEER_CLIENT_CERT_AUTH=\"true\" ETCD_PEER_CA_FILE=\"/opt/kubernetes/ssl/ca.pem\" ETCD_PEER_CERT_FILE=\"/opt/kubernetes/ssl/etcd.pem\" ETCD_PEER_KEY_FILE=\"/opt/kubernetes/ssl/etcd-key.pem\" 5.å¢åŠ etcdç³»ç»ŸæœåŠ¡[root@linux-node1 ~]# cat &gt; /etc/systemd/system/etcd.service &lt;&lt; EOF [Unit] Description=Etcd Server After=network.target [Service] Type=simple WorkingDirectory=/var/lib/etcd EnvironmentFile=-/opt/kubernetes/cfg/etcd.conf # set GOMAXPROCS to number of processors ExecStart=/bin/bash -c \"GOMAXPROCS=$(nproc) /opt/kubernetes/bin/etcd\" Type=notify [Install] WantedBy=multi-user.target EOF 6.é‡æ–°åŠ è½½ç³»ç»ŸæœåŠ¡[root@linux-node1 ~]# systemctl daemon-reload [root@linux-node1 ~]# systemctl enable etcd [root@linux-node1 ~]# scp /opt/kubernetes/cfg/etcd.conf 192.168.56.12:/opt/kubernetes/cfg/ [root@linux-node1 ~]# scp /etc/systemd/system/etcd.service 192.168.56.12:/etc/systemd/system/ [root@linux-node1 ~]# scp /opt/kubernetes/cfg/etcd.conf 192.168.56.13:/opt/kubernetes/cfg/ [root@linux-node1 ~]# scp /etc/systemd/system/etcd.service 192.168.56.13:/etc/systemd/system/ #åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šåˆ›å»ºetcdå­˜å‚¨ç›®å½•å¹¶å¯åŠ¨etcd(æ³¨æ„è¿™é‡Œéœ€è¦ä¸‰å°å°½é‡åŒæ—¶å¯åŠ¨) [root@linux-node1 ~]# mkdir /var/lib/etcd [root@linux-node1 ~]# systemctl start etcd [root@linux-node1 ~]# systemctl status etcd # å…¶ä»–èŠ‚ç‚¹é‡å¤ä»¥ä¸Šæ“ä½œï¼Œç›´åˆ°æ‰€æœ‰æœºå™¨çš„ etcd æœåŠ¡éƒ½å·²å¯åŠ¨ã€‚ 7.éªŒè¯ETCDé›†ç¾¤[root@linux-node1 ssl]# etcdctl --endpoints=https://192.168.56.11:2379 \\ &gt; --ca-file=/opt/kubernetes/ssl/ca.pem \\ &gt; --cert-file=/opt/kubernetes/ssl/etcd.pem \\ &gt; --key-file=/opt/kubernetes/ssl/etcd-key.pem cluster-health member 6566e06d7343e1bb is healthy: got healthy result from https://192.168.56.11:2379 member 435fb0a8da627a4c is healthy: got healthy result from https://192.168.56.12:2379 member ce7b884e428b6c8c is healthy: got healthy result from https://192.168.56.13:2379 cluster is healthy # é›†ç¾¤å¯ç”¨","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"02-K8sé›†ç¾¤æ­å»º---CAè¯ä¹¦ç”Ÿæˆ","slug":"02k8s-ji-qun-da-jianca-zheng-shu-sheng-cheng","date":"2018-06-01T14:15:34.000Z","updated":"2025-09-01T01:59:08.984Z","comments":true,"path":"2018/06/01/02k8s-ji-qun-da-jianca-zheng-shu-sheng-cheng/","permalink":"https://blog.sctux.cc/2018/06/01/02k8s-ji-qun-da-jianca-zheng-shu-sheng-cheng/","excerpt":"kubernetes ç³»ç»Ÿçš„å„ç»„ä»¶éœ€è¦ä½¿ç”¨ TLS è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†ï¼Œä½¿ç”¨ CloudFlare çš„ PKI å·¥å…·é›† cfssl æ¥ç”Ÿæˆ Certificate Authority (CA) å’Œå…¶å®ƒè¯ä¹¦ï¼› ä½¿ç”¨è¯ä¹¦çš„ç»„ä»¶å¦‚ä¸‹ï¼š etcdï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼› kube-apiserverï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼› kubeletï¼šä½¿ç”¨ ca.pemï¼› kube-proxyï¼šä½¿ç”¨ ca.pemã€kube-proxy-key.pemã€kube-proxy.pemï¼› kubectlï¼šä½¿ç”¨ ca.pemã€admin-key.pemã€admin.pemï¼› kube-controllerã€kube-scheduler å½“å‰éœ€è¦å’Œ kube-apiserver éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šä¸”ä½¿ç”¨éå®‰å…¨ç«¯å£é€šä¿¡ï¼Œæ•…ä¸éœ€è¦è¯ä¹¦ã€‚ (åé¢çš„æ“ä½œæˆ‘ä»¬åšåˆ°å“ªä¸€æ­¥å†å»åšå¯¹åº”ç»„å»ºçš„è¯ä¹¦ï¼Œä»¥å…å‡ºç°å·®é”™ 1. å®‰è£… CFSSL(äºŒè¿›åˆ¶æ–¹å¼)[root@linux-node1 ~]# cd /usr/local/src [root@linux-node1 src]# mv cfssl-certinfo_linux-amd64 /opt/kubernetes/bin/cfssl-certinfo [root@linux-node1 src]# mv cfssljson_linux-amd64 /opt/kubernetes/bin/cfssljson [root@linux-node1 src]# mv cfssl_linux-amd64 /opt/kubernetes/bin/cfssl [root@linux-node1 src]# chmod +x /opt/kubernetes/bin/cf* å¤åˆ¶cfsslå‘½ä»¤æ–‡ä»¶åˆ°node2å’Œnode3èŠ‚ç‚¹ã€‚å¦‚æœå®é™…ä¸­å¤šä¸ªèŠ‚ç‚¹ï¼Œå°±éƒ½éœ€è¦åŒæ­¥å¤åˆ¶ã€‚ [root@linux-node1 ~]# scp /opt/kubernetes/bin/cfssl* 192.168.56.12: /opt/kubernetes/bin [root@linux-node1 ~]# scp /opt/kubernetes/bin/cfssl* 192.168.56.13: /opt/kubernetes/bin 2.åˆå§‹åŒ–cfssl[root@linux-node1 src]# mkdir ssl &amp;&amp; cd ssl [root@linux-node1 ssl]# cfssl print-defaults config &gt; config.json [root@linux-node1 ssl]# cfssl print-defaults csr &gt; csr.json 3.åˆ›å»ºç”¨æ¥ç”Ÿæˆ CA æ–‡ä»¶çš„ JSON é…ç½®æ–‡ä»¶[root@linux-node1 ssl]# cat &gt; ca-config.json &lt;&lt;EOF { \"signing\": { \"default\": { \"expiry\": \"8760h\" }, \"profiles\": { \"kubernetes\": { \"usages\": [ \"signing\", \"key encipherment\", \"server auth\", \"client auth\" ], \"expiry\": \"8760h\" } } } } EOF åˆ›å»ºç”¨æ¥ç”Ÿæˆ CA è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰çš„ JSON é…ç½®æ–‡ä»¶","text":"kubernetes ç³»ç»Ÿçš„å„ç»„ä»¶éœ€è¦ä½¿ç”¨ TLS è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†ï¼Œä½¿ç”¨ CloudFlare çš„ PKI å·¥å…·é›† cfssl æ¥ç”Ÿæˆ Certificate Authority (CA) å’Œå…¶å®ƒè¯ä¹¦ï¼› ä½¿ç”¨è¯ä¹¦çš„ç»„ä»¶å¦‚ä¸‹ï¼š etcdï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼› kube-apiserverï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼› kubeletï¼šä½¿ç”¨ ca.pemï¼› kube-proxyï¼šä½¿ç”¨ ca.pemã€kube-proxy-key.pemã€kube-proxy.pemï¼› kubectlï¼šä½¿ç”¨ ca.pemã€admin-key.pemã€admin.pemï¼› kube-controllerã€kube-scheduler å½“å‰éœ€è¦å’Œ kube-apiserver éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šä¸”ä½¿ç”¨éå®‰å…¨ç«¯å£é€šä¿¡ï¼Œæ•…ä¸éœ€è¦è¯ä¹¦ã€‚ (åé¢çš„æ“ä½œæˆ‘ä»¬åšåˆ°å“ªä¸€æ­¥å†å»åšå¯¹åº”ç»„å»ºçš„è¯ä¹¦ï¼Œä»¥å…å‡ºç°å·®é”™ 1. å®‰è£… CFSSL(äºŒè¿›åˆ¶æ–¹å¼)[root@linux-node1 ~]# cd /usr/local/src [root@linux-node1 src]# mv cfssl-certinfo_linux-amd64 /opt/kubernetes/bin/cfssl-certinfo [root@linux-node1 src]# mv cfssljson_linux-amd64 /opt/kubernetes/bin/cfssljson [root@linux-node1 src]# mv cfssl_linux-amd64 /opt/kubernetes/bin/cfssl [root@linux-node1 src]# chmod +x /opt/kubernetes/bin/cf* å¤åˆ¶cfsslå‘½ä»¤æ–‡ä»¶åˆ°node2å’Œnode3èŠ‚ç‚¹ã€‚å¦‚æœå®é™…ä¸­å¤šä¸ªèŠ‚ç‚¹ï¼Œå°±éƒ½éœ€è¦åŒæ­¥å¤åˆ¶ã€‚ [root@linux-node1 ~]# scp /opt/kubernetes/bin/cfssl* 192.168.56.12: /opt/kubernetes/bin [root@linux-node1 ~]# scp /opt/kubernetes/bin/cfssl* 192.168.56.13: /opt/kubernetes/bin 2.åˆå§‹åŒ–cfssl[root@linux-node1 src]# mkdir ssl &amp;&amp; cd ssl [root@linux-node1 ssl]# cfssl print-defaults config &gt; config.json [root@linux-node1 ssl]# cfssl print-defaults csr &gt; csr.json 3.åˆ›å»ºç”¨æ¥ç”Ÿæˆ CA æ–‡ä»¶çš„ JSON é…ç½®æ–‡ä»¶[root@linux-node1 ssl]# cat &gt; ca-config.json &lt;&lt;EOF { \"signing\": { \"default\": { \"expiry\": \"8760h\" }, \"profiles\": { \"kubernetes\": { \"usages\": [ \"signing\", \"key encipherment\", \"server auth\", \"client auth\" ], \"expiry\": \"8760h\" } } } } EOF åˆ›å»ºç”¨æ¥ç”Ÿæˆ CA è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰çš„ JSON é…ç½®æ–‡ä»¶[root@linux-node1 ssl]# cat &gt; ca-csr.json &lt;&lt;EOF { \"CN\": \"kubernetes\", \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } EOF 5.ç”ŸæˆCAè¯ä¹¦ï¼ˆca.pemï¼‰å’Œå¯†é’¥ï¼ˆca-key.pemï¼‰[root@linux-node1 ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca [root@linux-node1 ssl]# ls -l ca* -rw-r--r-- 1 root root 290 May 28 15:25 ca-config.json -rw-r--r-- 1 root root 1001 May 28 15:30 ca.csr -rw-r--r-- 1 root root 208 May 28 15:30 ca-csr.json -rw------- 1 root root 1675 May 28 15:30 ca-key.pem -rw-r--r-- 1 root root 1359 May 28 15:30 ca.pem 6.åˆ†å‘è¯ä¹¦[root@ linux-node1 ssl]# cp ca.csr ca.pem ca-key.pem ca-config.json /opt/kubernetes/ssl scpè¯ä¹¦åˆ°node2å’Œnode3èŠ‚ç‚¹ [root@ linux-node1 ssl]# scp ca.csr ca.pem ca-key.pem ca-config.json 192.168.56.12:/opt/kubernetes/ssl [root@ linux-node1 ssl]# scp ca.csr ca.pem ca-key.pem ca-config.json 192.168.56.13:/opt/kubernetes/ssl","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"01-K8sé›†ç¾¤æ­å»º---ç³»ç»Ÿåˆå§‹åŒ–é…ç½®","slug":"01k8s-ji-qun-da-jian-yixi-tong-chu-shi-hua-pei-zhi","date":"2018-05-30T12:14:43.000Z","updated":"2025-09-01T01:59:08.932Z","comments":true,"path":"2018/05/30/01k8s-ji-qun-da-jian-yixi-tong-chu-shi-hua-pei-zhi/","permalink":"https://blog.sctux.cc/2018/05/30/01k8s-ji-qun-da-jian-yixi-tong-chu-shi-hua-pei-zhi/","excerpt":"1.æ¶æ„è¯´æ˜:ï¿¼ 2.ç‰ˆæœ¬ä¿¡æ¯: ç³»ç»Ÿç‰ˆæœ¬CentOS7.x Kubernets: v1.10 Etcd: v3.3.1 Docker: 18.03.1-ce Flannel: v1.10 CNI-Plugins: v0.7.0 å»ºè®®éƒ¨ç½²èŠ‚ç‚¹ï¼šæœ€å°‘ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œè¯·é…ç½®å¥½ä¸»æœºåè§£æï¼ˆå¿…å¤‡ï¼‰ 3.ç³»ç»Ÿåˆå§‹åŒ–(ä¸‰å°æœåŠ¡å™¨åˆ†åˆ«æ‰§è¡Œå³å¯ï¼Œä»¥node1ä¸ºä¾‹):a. ä¸»æœºåé…ç½® node1: echo \"linux-node1.example.com\" &gt; /etc/hostname b. è®¾ç½®/etc/hostsä¿è¯ä¸»æœºåèƒ½å¤Ÿè§£æ node1: echo \"192.168.56.11 linux-node1 linux-node1.example.com\" &gt;&gt; /etc/hosts c. å…³é—­SELinuxåŠé˜²ç«å¢™","text":"1.æ¶æ„è¯´æ˜:ï¿¼ 2.ç‰ˆæœ¬ä¿¡æ¯: ç³»ç»Ÿç‰ˆæœ¬CentOS7.x Kubernets: v1.10 Etcd: v3.3.1 Docker: 18.03.1-ce Flannel: v1.10 CNI-Plugins: v0.7.0 å»ºè®®éƒ¨ç½²èŠ‚ç‚¹ï¼šæœ€å°‘ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œè¯·é…ç½®å¥½ä¸»æœºåè§£æï¼ˆå¿…å¤‡ï¼‰ 3.ç³»ç»Ÿåˆå§‹åŒ–(ä¸‰å°æœåŠ¡å™¨åˆ†åˆ«æ‰§è¡Œå³å¯ï¼Œä»¥node1ä¸ºä¾‹):a. ä¸»æœºåé…ç½® node1: echo \"linux-node1.example.com\" &gt; /etc/hostname b. è®¾ç½®/etc/hostsä¿è¯ä¸»æœºåèƒ½å¤Ÿè§£æ node1: echo \"192.168.56.11 linux-node1 linux-node1.example.com\" &gt;&gt; /etc/hosts c. å…³é—­SELinuxåŠé˜²ç«å¢™ node1: systemctl disable firewalld; systemctl stop firewalld sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config d. ç¯å¢ƒå˜é‡é…ç½®(åç»­k8sç›¸å…³å‘½ä»¤éƒ½ä¼šæ”¾åˆ°/opt/kubernetes/binç›®å½•ä¸‹) PATH=$PATH:$HOME/bin:/opt/kubernetes/bin source ~/.bash_profile 4.å®‰è£…Dockeraï¼šä½¿ç”¨å›½å†…Dockeræº [root@linux-node1 ~]# cd /etc/yum.repos.d/ [root@linux-node1 yum.repos.d]# wget \\ https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo bï¼šDockerå®‰è£…ï¼š [root@linux-node1 ~]# yum install -y docker-ce cï¼šå¯åŠ¨åå°è¿›ç¨‹ï¼š [root@linux-node1 ~]# systemctl start docker 5.å‡†å¤‡éƒ¨ç½²ç›®å½•[root@linux-node1 ~]# mkdir -p /opt/kubernetes/{cfg,bin,ssl,log} # ç›®å½•ç»“æ„, æ‰€æœ‰æ–‡ä»¶å‡å­˜æ”¾åœ¨/opt/kubernetesç›®å½•ä¸‹ï¼š [root@linux-node1 ~]# tree -L 1 /opt/kubernetes/ /opt/kubernetes/ â”œâ”€â”€ bin #äºŒè¿›åˆ¶æ–‡ä»¶ â”œâ”€â”€ cfg #é…ç½®æ–‡ä»¶ â”œâ”€â”€ log #æ—¥å¿—æ–‡ä»¶ â””â”€â”€ ssl #è¯ä¹¦æ–‡ä»¶ 6.å‡†å¤‡è½¯ä»¶åŒ…ç™¾åº¦ç½‘ç›˜ä¸‹è½½åœ°å€ï¼šhttps://pan.baidu.com/s/1bQo7PEfKJAAhk4KzQgLrMQ å¯†ç :gm3k 7.è§£å‹è½¯ä»¶åŒ…[root@linux-node1 ~]# cd /tmp/ &amp;&amp; unzip k8s-v1.10.1-manual.zip &amp;&amp; mv k8s-v1.10.1-manual/k8s-v1.10.1/* /usr/local/src/ [root@linux-node1 ~]# cd /usr/local/src [root@linux-node1 ~]# tar zxf kubernetes.tar.gz [root@linux-node1 ~]# tar zxf kubernetes-server-linux-amd64.tar.gz [root@linux-node1 ~]# tar zxf kubernetes-client-linux-amd64.tar.gz [root@linux-node1 ~]# tar zxf kubernetes-node-linux-amd64.tar.gz 8.åšå¥½masterèŠ‚ç‚¹è·Ÿå…¶ä»–nodeèŠ‚ç‚¹çš„sshäº’ä¿¡,ä¾¿äºæ­å»º[root@linux-node1 ~]# ssh-key -t rsa \"\" ...... ...... ...... [root@linux-node1 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.56.11 [root@linux-node1 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.56.12","categories":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}],"tags":[{"name":"k8sé›†ç¾¤æ­å»º","slug":"k8sé›†ç¾¤æ­å»º","permalink":"https://blog.sctux.cc/tags/k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"}],"keywords":[{"name":"k8s","slug":"k8s","permalink":"https://blog.sctux.cc/categories/k8s/"}]},{"title":"å¦‚ä½•å®ç°Mysqlæ•°æ®åº“å·®å¼‚åŒ–å¯¹æ¯”","slug":"ru-he-shi-xianmysql-shu-ju-ku-cha-yi-hua-dui-bi","date":"2018-03-18T10:15:49.000Z","updated":"2025-09-01T01:59:08.862Z","comments":true,"path":"2018/03/18/ru-he-shi-xianmysql-shu-ju-ku-cha-yi-hua-dui-bi/","permalink":"https://blog.sctux.cc/2018/03/18/ru-he-shi-xianmysql-shu-ju-ku-cha-yi-hua-dui-bi/","excerpt":"åœ¨å›¢é˜Ÿå¼€å‘ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šå­˜åœ¨æµ‹è¯•ã€é¢„å‘å¸ƒã€æ­£å¼ç¯å¢ƒæˆ–å¤šç‰ˆæœ¬è¿›è¡Œå¼€å‘ï¼›ä»£ç çš„ç®¡ç†ä¸€èˆ¬ä¹Ÿæœ‰git/svnç­‰ç­‰å·¥å…·ï¼› ä½†æ˜¯åœ¨mysqlçš„ç®¡ç†å°±æœ‰äº›éº»çƒ¦äº†ï¼Œå¯¹äºä¸€äº›æ­£è§„åŒ–çš„å¤§å‚å›¢é˜Ÿï¼Œå¯¹æ•°æ®åº“çš„æ¯ä¸€æ¬¡è¡¨ç»“æ„éƒ½æœ‰è¯¦ç»†çš„è®°å½•ï¼Œè¿™æ ·åœ¨æ‰§è¡Œå˜æ›´/å‡çº§çš„æ—¶å€™åªéœ€è¦æ‰§è¡Œç›´æ¥æ‰§è¡Œå˜æ›´è¿‡çš„SQLå³å¯ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¹Ÿä¼šå‡ºç°è®°å½•ä¸å®Œæ•´æˆ–è€…é—æ¼é€ æˆæµ‹è¯•/é¢„å‘å¸ƒ/æ­£å¼ç¯å¢ƒçš„ä¸ä¸€è‡´ã€‚ è¿™æ—¶å€™å°±éœ€è¦äººå·¥å»æŸ¥æ‰¾ä¸¤ä¸ªæ•°æ®åº“æ•°æ®è¡¨ä¸­çš„ä¸åŒï¼›çœ‹å“ªé‡Œå°‘ä»€ä¹ˆï¼Œå“ªé‡Œå¤šäº†ä»€ä¹ˆï¼Œä½†æ˜¯å¦‚æœäººå·¥å»æ¯æ¬¡desc/selectæ˜¯å¾ˆè´¹æ—¶è´¹åŠ›çš„äº‹æƒ…ï¼›é‚£ä¹ˆè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°mysqlçš„ç›¸å…³å·¥å…·ï¼›ä¾‹å¦‚mysqldiff ä¾‹å¦‚:è¿™é‡Œæœ‰ä¸ªdb1è·Ÿdb2 æ•°æ®åº“ï¼Œå„è‡ªé‡Œé¢æœ‰ä¸¤å¼ è¡¨student_1,student2,è¿™é‡Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢çš„ç»“æ„ç”¨è‚‰çœ¼æ˜¯å¯ä»¥çœ‹å‡ºæ¥çš„ï¼› MariaDB [(none)]&gt; use db1; Database changed MariaDB [db1]&gt; show tables; +---------------+ | Tables_in_db1 | +---------------+ | student_1 | +---------------+ 1 row in set (0.00 sec) MariaDB [db1]&gt; desc student_1; +-------------+-------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------------+-------------+------+-----+---------+-------+ | studentNo | char(10) | NO | PRI | NULL | | | studentName | varchar(20) | NO | | NULL | | | sex | char(2) | YES | | NULL | | | birthday | date | YES | | NULL | | | native | varchar(20) | YES | | NULL | | | nation | varchar(20) | YES | | NULL | | | classNo | char(6) | YES | | NULL | | +-------------+-------------+------+-----+---------+-------+ 7 rows in set (0.01 sec) MariaDB [db1]&gt; use db2; Database changed MariaDB [db2]&gt; desc student_2; +-------------+-------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------------+-------------+------+-----+---------+-------+ | studentNo | char(10) | NO | PRI | NULL | | | studentName | varchar(20) | NO | | NULL | | | sex | char(2) | YES | | NULL | | | birthday | date | YES | | NULL | | | native | varchar(40) | YES | | NULL | | | nation | varchar(20) | YES | | NULL | | +-------------+-------------+------+-----+---------+-------+ 6 rows in set (0.00 sec) MariaDB [db2]&gt; å¦‚æœä½¿ç”¨mysqldiffå·¥å…·è¾“å‡ºå°†ä¼šæ˜¯è¿™æ ·çš„:mysqldiff --server1=root:123.com@127.0.0.1:3306 --server2=root:123.com@127.0.0.1:3306 db1.student_1:db2.student_2; # WARNING: Using a password on the command line interface can be insecure. # server1 on 127.0.0.1: ... connected. # server2 on 127.0.0.1: ... connected. # Comparing db1.student_1 to db2.student_2 [FAIL] # Object definitions differ. (--changes-for=server1) # --- db1.student_1 +++ db2.student_2 @@ -1,10 +1,9 @@ -CREATE TABLE `student_1` ( +CREATE TABLE `student_2` ( `studentNo` char(10) NOT NULL, `studentName` varchar(20) NOT NULL, `sex` char(2) DEFAULT NULL, `birthday` date DEFAULT NULL, - `native` varchar(20) DEFAULT NULL, + `native` varchar(40) DEFAULT NULL, `nation` varchar(20) DEFAULT NULL, - `classNo` char(6) DEFAULT NULL, UNIQUE KEY `studentNo` (`studentNo`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 # Compare failed. One or more differences found. ä»ä»¥ä¸Šè¾“å‡ºå¯ä»¥çœ‹å‡ºæ¥, db2çš„student_2ç›¸å¯¹äºdb1çš„student_1ç»“æ„1.å­—æ®µnativeçš„vacharç±»å‹é™åˆ¶ä¸åŒï¼›è¡¨student_2æ˜¯40,è¡¨student_1æ˜¯40ï¼›2.è¡¨student_2ç¼ºå°‘å­—æ®µclassNo è¿™æ ·ä¸€æ¥å°±èƒ½å¾ˆå¿«é€Ÿçš„è¾“å‡ºä¸¤ä¸ªåº“ä¸­è¡¨ç»“æ„çš„å·®å¼‚ï¼›ç„¶åçœ‹ä»¥é‚£ä¸ªåº“ä¸ºæ ‡æ†è¿›è¡ŒAlertæ“ä½œå°±è¡Œäº†ä¸‹é¢æ˜¯æˆ‘æ”¹æ­£åå†æ¬¡æ‰§è¡Œmysqldiffå·¥å…·å‘½ä»¤çš„ç»“æœè¾“å‡º:","text":"åœ¨å›¢é˜Ÿå¼€å‘ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šå­˜åœ¨æµ‹è¯•ã€é¢„å‘å¸ƒã€æ­£å¼ç¯å¢ƒæˆ–å¤šç‰ˆæœ¬è¿›è¡Œå¼€å‘ï¼›ä»£ç çš„ç®¡ç†ä¸€èˆ¬ä¹Ÿæœ‰git/svnç­‰ç­‰å·¥å…·ï¼› ä½†æ˜¯åœ¨mysqlçš„ç®¡ç†å°±æœ‰äº›éº»çƒ¦äº†ï¼Œå¯¹äºä¸€äº›æ­£è§„åŒ–çš„å¤§å‚å›¢é˜Ÿï¼Œå¯¹æ•°æ®åº“çš„æ¯ä¸€æ¬¡è¡¨ç»“æ„éƒ½æœ‰è¯¦ç»†çš„è®°å½•ï¼Œè¿™æ ·åœ¨æ‰§è¡Œå˜æ›´/å‡çº§çš„æ—¶å€™åªéœ€è¦æ‰§è¡Œç›´æ¥æ‰§è¡Œå˜æ›´è¿‡çš„SQLå³å¯ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¹Ÿä¼šå‡ºç°è®°å½•ä¸å®Œæ•´æˆ–è€…é—æ¼é€ æˆæµ‹è¯•/é¢„å‘å¸ƒ/æ­£å¼ç¯å¢ƒçš„ä¸ä¸€è‡´ã€‚ è¿™æ—¶å€™å°±éœ€è¦äººå·¥å»æŸ¥æ‰¾ä¸¤ä¸ªæ•°æ®åº“æ•°æ®è¡¨ä¸­çš„ä¸åŒï¼›çœ‹å“ªé‡Œå°‘ä»€ä¹ˆï¼Œå“ªé‡Œå¤šäº†ä»€ä¹ˆï¼Œä½†æ˜¯å¦‚æœäººå·¥å»æ¯æ¬¡desc/selectæ˜¯å¾ˆè´¹æ—¶è´¹åŠ›çš„äº‹æƒ…ï¼›é‚£ä¹ˆè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°mysqlçš„ç›¸å…³å·¥å…·ï¼›ä¾‹å¦‚mysqldiff ä¾‹å¦‚:è¿™é‡Œæœ‰ä¸ªdb1è·Ÿdb2 æ•°æ®åº“ï¼Œå„è‡ªé‡Œé¢æœ‰ä¸¤å¼ è¡¨student_1,student2,è¿™é‡Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢çš„ç»“æ„ç”¨è‚‰çœ¼æ˜¯å¯ä»¥çœ‹å‡ºæ¥çš„ï¼› MariaDB [(none)]&gt; use db1; Database changed MariaDB [db1]&gt; show tables; +---------------+ | Tables_in_db1 | +---------------+ | student_1 | +---------------+ 1 row in set (0.00 sec) MariaDB [db1]&gt; desc student_1; +-------------+-------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------------+-------------+------+-----+---------+-------+ | studentNo | char(10) | NO | PRI | NULL | | | studentName | varchar(20) | NO | | NULL | | | sex | char(2) | YES | | NULL | | | birthday | date | YES | | NULL | | | native | varchar(20) | YES | | NULL | | | nation | varchar(20) | YES | | NULL | | | classNo | char(6) | YES | | NULL | | +-------------+-------------+------+-----+---------+-------+ 7 rows in set (0.01 sec) MariaDB [db1]&gt; use db2; Database changed MariaDB [db2]&gt; desc student_2; +-------------+-------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------------+-------------+------+-----+---------+-------+ | studentNo | char(10) | NO | PRI | NULL | | | studentName | varchar(20) | NO | | NULL | | | sex | char(2) | YES | | NULL | | | birthday | date | YES | | NULL | | | native | varchar(40) | YES | | NULL | | | nation | varchar(20) | YES | | NULL | | +-------------+-------------+------+-----+---------+-------+ 6 rows in set (0.00 sec) MariaDB [db2]&gt; å¦‚æœä½¿ç”¨mysqldiffå·¥å…·è¾“å‡ºå°†ä¼šæ˜¯è¿™æ ·çš„:mysqldiff --server1=root:123.com@127.0.0.1:3306 --server2=root:123.com@127.0.0.1:3306 db1.student_1:db2.student_2; # WARNING: Using a password on the command line interface can be insecure. # server1 on 127.0.0.1: ... connected. # server2 on 127.0.0.1: ... connected. # Comparing db1.student_1 to db2.student_2 [FAIL] # Object definitions differ. (--changes-for=server1) # --- db1.student_1 +++ db2.student_2 @@ -1,10 +1,9 @@ -CREATE TABLE `student_1` ( +CREATE TABLE `student_2` ( `studentNo` char(10) NOT NULL, `studentName` varchar(20) NOT NULL, `sex` char(2) DEFAULT NULL, `birthday` date DEFAULT NULL, - `native` varchar(20) DEFAULT NULL, + `native` varchar(40) DEFAULT NULL, `nation` varchar(20) DEFAULT NULL, - `classNo` char(6) DEFAULT NULL, UNIQUE KEY `studentNo` (`studentNo`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 # Compare failed. One or more differences found. ä»ä»¥ä¸Šè¾“å‡ºå¯ä»¥çœ‹å‡ºæ¥, db2çš„student_2ç›¸å¯¹äºdb1çš„student_1ç»“æ„1.å­—æ®µnativeçš„vacharç±»å‹é™åˆ¶ä¸åŒï¼›è¡¨student_2æ˜¯40,è¡¨student_1æ˜¯40ï¼›2.è¡¨student_2ç¼ºå°‘å­—æ®µclassNo è¿™æ ·ä¸€æ¥å°±èƒ½å¾ˆå¿«é€Ÿçš„è¾“å‡ºä¸¤ä¸ªåº“ä¸­è¡¨ç»“æ„çš„å·®å¼‚ï¼›ç„¶åçœ‹ä»¥é‚£ä¸ªåº“ä¸ºæ ‡æ†è¿›è¡ŒAlertæ“ä½œå°±è¡Œäº†ä¸‹é¢æ˜¯æˆ‘æ”¹æ­£åå†æ¬¡æ‰§è¡Œmysqldiffå·¥å…·å‘½ä»¤çš„ç»“æœè¾“å‡º: mysqldiff --server1=root:123.com@127.0.0.1:3306 --server2=root:123.com@127.0.0.1:3306 db1.student_1:db2.student_2; # WARNING: Using a password on the command line interface can be insecure. # server1 on 127.0.0.1: ... connected. # server2 on 127.0.0.1: ... connected. # Comparing db1.student_1 to db2.student_2 [PASS] # WARNING: The tables structure is the same, but the columns order is different. Use --change-for to take the order into account. # Success. All objects are the same. æ„æ€å°±æ˜¯è¯´æ£€æµ‹é€šè¿‡ï¼Œçœ‹èµ·æ¥æ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ä¸€æ ·çš„ã€‚ So, ç®€å•ä½¿ç”¨æ–¹æ³•å°±æ˜¯é…±ç´«çš„äº†ï¼›å…¶å®è¿˜æœ‰æ›´å¤šçš„é€‰é¡¹å°±è¡Œæ“ä½œçš„ï¼›ä½†æ˜¯ç›®å‰æš‚æ—¶æ²¡æœ‰ç”¨åˆ°ï¼›éœ€è¦çš„è¯æ‰¾manå°±å¥½äº†ã€‚","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"},{"name":"æ•°æ®åº“","slug":"å¿…å¤‡çŸ¥è¯†/æ•°æ®åº“","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/%E6%95%B0%E6%8D%AE%E5%BA%93/"}],"tags":[{"name":"ç³»ç»Ÿè¿ç»´","slug":"ç³»ç»Ÿè¿ç»´","permalink":"https://blog.sctux.cc/tags/%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4/"}],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"},{"name":"æ•°æ®åº“","slug":"å¿…å¤‡çŸ¥è¯†/æ•°æ®åº“","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/%E6%95%B0%E6%8D%AE%E5%BA%93/"}]},{"title":"å¦‚ä½•åˆ©ç”¨Git Webhook è¿›è¡Œéƒ¨ç½²","slug":"ru-he-li-yonggit-webhook-jin-xing-bu-shu","date":"2018-03-08T12:11:45.000Z","updated":"2025-09-02T08:18:14.293Z","comments":true,"path":"2018/03/08/ru-he-li-yonggit-webhook-jin-xing-bu-shu/","permalink":"https://blog.sctux.cc/2018/03/08/ru-he-li-yonggit-webhook-jin-xing-bu-shu/","excerpt":"ä½œä¸ºä¸€åâ€ä¼ªç å†œâ€è¿ç»´å·¥ç¨‹å¸ˆ,åœ¨æ¥è§¦äº†å¼€å‘æ–¹é¢çš„çŸ¥è¯†åï¼›ä¹Ÿåœ¨å†™é¡¹ç›®æ—¶ä¸€ç›´ä½¿ç”¨git,å¯æ˜¯å¼€å‘ã€è°ƒè¯•ã€éƒ¨ç½²éƒ½æ˜¯åœ¨æœ¬åœ°è¿›è¡Œçš„ï¼›åœ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨æ—¶ä¹Ÿæ˜¯é€šè¿‡æ‰‹å·¥å»è·å–ä»“åº“çš„ä»£ç ï¼›1.å¼€å‘å®Œä»£ç æäº¤åˆ°è¿œç¨‹ä»“åº“;2.ç™»å½•è¿œç¨‹æœåŠ¡å™¨,å¹¶åˆ‡åˆ°ä»£ç ç›®å½•è¿›è¡Œgit pull;3.é‡å¯supervisoråº”ç”¨(æˆ‘è¿™è¾¹å¼€å‘çš„python webåº”ç”¨æ˜¯supervisorè¿›è¡Œç®¡ç†); å½“ç„¶å¦‚æœåªæ˜¯ä¸€æ¬¡æ€§éƒ¨ç½²ä¸Šå»å°±ä¸å†ä¿®æ”¹çš„è¯å¹¶æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯è¦æ˜¯é¡¹ç›®æŒç»­æ€§ä¿®æ”¹è¿­ä»£çš„è¯ï¼Œå°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œå°±åœ¨ä¸æ–­çš„é‡å¤ç€ä¸Šé¢çš„æ­¥éª¤ã€‚ä½œä¸ºä¸€ä¸ªâ€ä¼ªç å†œâ€ï¼Œæ€ä¹ˆå…è®¸ä¸æ–­çš„é‡å¤åŒæ ·çš„å·¥ä½œï¼Œäºæ˜¯git webhooksé—ªäº®ç™»åœºï¼›å¤§å®¶å¯¹äºé’©å­å¹¶ä¸é™Œç”Ÿï¼ŒåŒæ ·çš„ç‰ˆæœ¬æ§åˆ¶SVNä¹Ÿæœ‰é’©å­è¿™ä¸ªåŠŸèƒ½ï¼›åªæ˜¯ä¸ªäººæ›´åŠ çš„å€¾å‘äºä½¿ç”¨git; ç„¶ågitä¹Ÿå‚¬ç”Ÿå‡ºæ¥äº†å¾ˆå¤šï¼›æ¯”å¦‚ä½¿ç”¨æœ€å¹¿æ³›çš„æ˜¯GitHubï¼Œå†å…¶æ¬¡å°±æ˜¯Gitlab,æœ€åå°±æ˜¯æˆ‘è¿™è¾¹æ˜¯ç”¨çš„Gogs;ä»–ä»¬éƒ½æœ‰åŒæ ·çš„åŠŸèƒ½ï¼›åªæ˜¯è¯´çœ‹éœ€æ±‚è·Ÿä¹ æƒ¯; gogsæœ‰ä¸ªdockerç‰ˆæœ¬ï¼›èƒ½åœ¨2åˆ†é’Ÿä¹‹å†…å°±å¯ä»¥è·‘èµ·æ¥éå¸¸è½»å·§æ–¹ä¾¿ï¼›æ„Ÿå…´è¶£çš„è¯·ç‚¹å‡»è¿™é‡ŒGogs git webhookè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²å¦‚ä½•å®ç° Git webhookè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²ï¼Œå…¶å®åŸç†å¾ˆç®€å•ï¼Œå¦‚å›¾æ‰€ç¤º:ï¿¼ 1.æœ¬åœ°ä»£ç å¼€å‘å®Œæ¯•æäº¤åˆ°è¿œç¨‹ä»“åº“;ï¿¼ 2.é€šè¿‡ POST è¯·æ±‚å°†è®¢é˜…äº‹ä»¶ä¿¡æ¯å‘é€è‡³å‘æŒ‡å®š URL åœ°å€;ï¿¼ ï¿¼ 3.æŒ‡å®šçš„urlæ˜¯ä½¿ç”¨Flaskå†™çš„ä¸€ä¸ªåº”ç”¨,è§¦å‘è¿™ä¸ªURLå°±ä¼šè¿›è¡Œè¿œç¨‹ä»“åº“çš„ä»£ç clone/pullï¿¼4.æ‹‰å–ä»£ç å®Œæ¯•å,é‡å¯æœåŠ¡ Flask webåº”ç”¨ä»£ç :# -*- coding:utf-8 -*- # ä¾èµ–åŒ…: pip install flask gitpython from flask import Flask, request, jsonify,abort import git, os # è¿œç¨‹æœåŠ¡å™¨ä»£ç åœ°å€ code_dir = \"./code\" # è¿œç¨‹ä»“åº“åœ°å€ git_url = \"git@192.168.1.105:guomaoqiu/devopscode.git\" #ç™½åå• allow_ip=[\"192.168.1.105\"] app = Flask(__name__) #é‡å¯æœåŠ¡ restart_services = os.system(\"supervisorctl -c /etc/supervisord.conf restart devops &amp;&amp; supervisorctl -c /etc/supervisord.conf restart celery\") @app.route('/pullcode', methods=['POST']) def pullcode(): # åªå…è®¸æŒ‡å®šæœåŠ¡å™¨å‘Flaskåº”ç”¨å‘èµ·POSTè¯·æ±‚ï¼Œå¦åˆ™ç›´æ¥è¿”å›403 if request.headers.get('X-Forwarded-For', request.remote_addr) not in allow_ip: return abort(403) if request.method == 'POST': if os.path.isdir(code_dir): local_repo = git.Repo(code_dir) try: print local_repo.git.pull() # é‡æ–°åŠ è½½ä»£ç ã€é‡å¯æœåŠ¡ restart_services return jsonify({\"result\":True,\"message\":\"pull success\"}) except Exception,e: return jsonify({\"result\":False,\"message\": \"pull faild\".format(e)}) else: try: print git.Repo.clone_from(url=git_url, to_path=code_dir) # é‡æ–°åŠ è½½ä»£ç ã€é‡å¯æœåŠ¡ restart_services return jsonify({\"result\":True,\"message\":\"clone success\"}) except Exception, e: return jsonify({\"result\":False,\"message\": \"clone faild\".format(e)}) if __name__ == '__main__': app.run(host='192.168.1.29', port=5003)","text":"ä½œä¸ºä¸€åâ€ä¼ªç å†œâ€è¿ç»´å·¥ç¨‹å¸ˆ,åœ¨æ¥è§¦äº†å¼€å‘æ–¹é¢çš„çŸ¥è¯†åï¼›ä¹Ÿåœ¨å†™é¡¹ç›®æ—¶ä¸€ç›´ä½¿ç”¨git,å¯æ˜¯å¼€å‘ã€è°ƒè¯•ã€éƒ¨ç½²éƒ½æ˜¯åœ¨æœ¬åœ°è¿›è¡Œçš„ï¼›åœ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨æ—¶ä¹Ÿæ˜¯é€šè¿‡æ‰‹å·¥å»è·å–ä»“åº“çš„ä»£ç ï¼›1.å¼€å‘å®Œä»£ç æäº¤åˆ°è¿œç¨‹ä»“åº“;2.ç™»å½•è¿œç¨‹æœåŠ¡å™¨,å¹¶åˆ‡åˆ°ä»£ç ç›®å½•è¿›è¡Œgit pull;3.é‡å¯supervisoråº”ç”¨(æˆ‘è¿™è¾¹å¼€å‘çš„python webåº”ç”¨æ˜¯supervisorè¿›è¡Œç®¡ç†); å½“ç„¶å¦‚æœåªæ˜¯ä¸€æ¬¡æ€§éƒ¨ç½²ä¸Šå»å°±ä¸å†ä¿®æ”¹çš„è¯å¹¶æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯è¦æ˜¯é¡¹ç›®æŒç»­æ€§ä¿®æ”¹è¿­ä»£çš„è¯ï¼Œå°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œå°±åœ¨ä¸æ–­çš„é‡å¤ç€ä¸Šé¢çš„æ­¥éª¤ã€‚ä½œä¸ºä¸€ä¸ªâ€ä¼ªç å†œâ€ï¼Œæ€ä¹ˆå…è®¸ä¸æ–­çš„é‡å¤åŒæ ·çš„å·¥ä½œï¼Œäºæ˜¯git webhooksé—ªäº®ç™»åœºï¼›å¤§å®¶å¯¹äºé’©å­å¹¶ä¸é™Œç”Ÿï¼ŒåŒæ ·çš„ç‰ˆæœ¬æ§åˆ¶SVNä¹Ÿæœ‰é’©å­è¿™ä¸ªåŠŸèƒ½ï¼›åªæ˜¯ä¸ªäººæ›´åŠ çš„å€¾å‘äºä½¿ç”¨git; ç„¶ågitä¹Ÿå‚¬ç”Ÿå‡ºæ¥äº†å¾ˆå¤šï¼›æ¯”å¦‚ä½¿ç”¨æœ€å¹¿æ³›çš„æ˜¯GitHubï¼Œå†å…¶æ¬¡å°±æ˜¯Gitlab,æœ€åå°±æ˜¯æˆ‘è¿™è¾¹æ˜¯ç”¨çš„Gogs;ä»–ä»¬éƒ½æœ‰åŒæ ·çš„åŠŸèƒ½ï¼›åªæ˜¯è¯´çœ‹éœ€æ±‚è·Ÿä¹ æƒ¯; gogsæœ‰ä¸ªdockerç‰ˆæœ¬ï¼›èƒ½åœ¨2åˆ†é’Ÿä¹‹å†…å°±å¯ä»¥è·‘èµ·æ¥éå¸¸è½»å·§æ–¹ä¾¿ï¼›æ„Ÿå…´è¶£çš„è¯·ç‚¹å‡»è¿™é‡ŒGogs git webhookè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²å¦‚ä½•å®ç° Git webhookè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²ï¼Œå…¶å®åŸç†å¾ˆç®€å•ï¼Œå¦‚å›¾æ‰€ç¤º:ï¿¼ 1.æœ¬åœ°ä»£ç å¼€å‘å®Œæ¯•æäº¤åˆ°è¿œç¨‹ä»“åº“;ï¿¼ 2.é€šè¿‡ POST è¯·æ±‚å°†è®¢é˜…äº‹ä»¶ä¿¡æ¯å‘é€è‡³å‘æŒ‡å®š URL åœ°å€;ï¿¼ ï¿¼ 3.æŒ‡å®šçš„urlæ˜¯ä½¿ç”¨Flaskå†™çš„ä¸€ä¸ªåº”ç”¨,è§¦å‘è¿™ä¸ªURLå°±ä¼šè¿›è¡Œè¿œç¨‹ä»“åº“çš„ä»£ç clone/pullï¿¼4.æ‹‰å–ä»£ç å®Œæ¯•å,é‡å¯æœåŠ¡ Flask webåº”ç”¨ä»£ç :# -*- coding:utf-8 -*- # ä¾èµ–åŒ…: pip install flask gitpython from flask import Flask, request, jsonify,abort import git, os # è¿œç¨‹æœåŠ¡å™¨ä»£ç åœ°å€ code_dir = \"./code\" # è¿œç¨‹ä»“åº“åœ°å€ git_url = \"git@192.168.1.105:guomaoqiu/devopscode.git\" #ç™½åå• allow_ip=[\"192.168.1.105\"] app = Flask(__name__) #é‡å¯æœåŠ¡ restart_services = os.system(\"supervisorctl -c /etc/supervisord.conf restart devops &amp;&amp; supervisorctl -c /etc/supervisord.conf restart celery\") @app.route('/pullcode', methods=['POST']) def pullcode(): # åªå…è®¸æŒ‡å®šæœåŠ¡å™¨å‘Flaskåº”ç”¨å‘èµ·POSTè¯·æ±‚ï¼Œå¦åˆ™ç›´æ¥è¿”å›403 if request.headers.get('X-Forwarded-For', request.remote_addr) not in allow_ip: return abort(403) if request.method == 'POST': if os.path.isdir(code_dir): local_repo = git.Repo(code_dir) try: print local_repo.git.pull() # é‡æ–°åŠ è½½ä»£ç ã€é‡å¯æœåŠ¡ restart_services return jsonify({\"result\":True,\"message\":\"pull success\"}) except Exception,e: return jsonify({\"result\":False,\"message\": \"pull faild\".format(e)}) else: try: print git.Repo.clone_from(url=git_url, to_path=code_dir) # é‡æ–°åŠ è½½ä»£ç ã€é‡å¯æœåŠ¡ restart_services return jsonify({\"result\":True,\"message\":\"clone success\"}) except Exception, e: return jsonify({\"result\":False,\"message\": \"clone faild\".format(e)}) if __name__ == '__main__': app.run(host='192.168.1.29', port=5003) å¦‚æœå…¶ä»–åœ°å€å‘èµ·POSTè¯·æ±‚é‚£ä¹ˆå°±ç›´æ¥è¿”å›403,è¿™æ ·å°±é¿å…äº†å…¶ä»–äººä¹±æ¥çš„æƒ…å†µ:ï¿¼ æ€»ç»“èµ·æ¥ä¹Ÿå°±æ˜¯:æœ¬åœ°ä»“åº“æ¨é€ä»£ç åˆ°è¿œç¨‹ä»“åº“åï¼Œä¸€æ—¦æœ¬åœ°ä»“åº“å˜æ›´æäº¤å°±ä¼šè§¦å‘webhookå‘é€postè¯·æ±‚ï¼Œé©±åŠ¨è‡ªåŠ¨éƒ¨ç½²ã€é‡å¯æœåŠ¡ç­‰ã€‚è¿™æ ·ä¸€æ¥åªéœ€è¦æœ¬åœ°å¼€å‘å¥½ä»£ç æäº¤åç›´æ¥è®¿é—®æœåŠ¡å™¨å°±å¯ä»¥éªŒè¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºäº†;","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"å¦‚ä½•ä½¿ç”¨Celery(èŠ¹èœ)å¼‚æ­¥ç¥å™¨æ‰§è¡Œåå°ä»»åŠ¡","slug":"ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin","date":"2017-11-24T01:13:10.000Z","updated":"2025-09-01T01:59:08.930Z","comments":true,"path":"2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/","permalink":"https://blog.sctux.cc/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/","excerpt":"å…³äºå¼‚æ­¥çš„çŸ¥è¯†ç½‘ä¸Šå¾ˆå¤šï¼Œè¿™é‡Œå°±ç›´æ¥ä¸Šä»£ç ï¼Œç›®å‰ç»“åˆFlaskè¿™ä¸ªPythonæ¡†æ¶å®ç°åå°ä»»åŠ¡çš„æ‰§è¡Œæ“ä½œï¼› 1.éœ€è¦äº†è§£çš„çŸ¥è¯†ç‚¹: äº†è§£ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹æˆ–è€…å‘å¸ƒè®¢é˜…æ¨¡å¼æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ— äº†è§£å¼‚æ­¥ã€åŒæ­¥ä¹‹é—´çš„å·®åˆ« 2.å®ç°è¿‡ç¨‹(1)ç›®å½•ç»“æ„â”œâ”€â”€ LICENSE â”œâ”€â”€ README.md â”œâ”€â”€ app // Flask APPåº”ç”¨ â”‚&nbsp;&nbsp; â”œâ”€â”€ __init__.py â”‚&nbsp;&nbsp; â”œâ”€â”€ auth â”‚&nbsp;&nbsp; â”œâ”€â”€ email.py â”‚&nbsp;&nbsp; â”œâ”€â”€ main â”‚&nbsp;&nbsp; â”œâ”€â”€ models.py â”‚&nbsp;&nbsp; â”œâ”€â”€ salt â”‚&nbsp;&nbsp; â”œâ”€â”€ static â”‚&nbsp;&nbsp; â””â”€â”€ templates â”œâ”€â”€ config.py // é€šç”¨é…ç½® â”œâ”€â”€ config.pyc â”œâ”€â”€ manager.py â”œâ”€â”€ migrations â”‚&nbsp;&nbsp; â”œâ”€â”€ README â”‚&nbsp;&nbsp; â”œâ”€â”€ alembic.ini â”‚&nbsp;&nbsp; â”œâ”€â”€ env.py â”‚&nbsp;&nbsp; â””â”€â”€ versions â””â”€â”€ requirements.txt (2)æŒ‡å®šbroker/backend(æ­¤å¤„ä½¿ç”¨redis)vim app/__init__.py // éƒ¨åˆ†ä»£ç  from celery import Celery app = Flask(__name__) broker = 'redis://127.0.0.1:6379' backend = 'redis://127.0.0.1:6379/0' celery = Celery(app.name, broker=broker, backend=backend) // éƒ¨åˆ†ä»£ç  ä»¥ä¸Šå¼•å…¥äº†Celery,æŒ‡å®šäº†Celeryçš„ç”Ÿäº§æ¶ˆè´¹ç«¯éƒ½ä¸ºæˆ‘ä»¬çš„redis","text":"å…³äºå¼‚æ­¥çš„çŸ¥è¯†ç½‘ä¸Šå¾ˆå¤šï¼Œè¿™é‡Œå°±ç›´æ¥ä¸Šä»£ç ï¼Œç›®å‰ç»“åˆFlaskè¿™ä¸ªPythonæ¡†æ¶å®ç°åå°ä»»åŠ¡çš„æ‰§è¡Œæ“ä½œï¼› 1.éœ€è¦äº†è§£çš„çŸ¥è¯†ç‚¹: äº†è§£ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹æˆ–è€…å‘å¸ƒè®¢é˜…æ¨¡å¼æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ— äº†è§£å¼‚æ­¥ã€åŒæ­¥ä¹‹é—´çš„å·®åˆ« 2.å®ç°è¿‡ç¨‹(1)ç›®å½•ç»“æ„â”œâ”€â”€ LICENSE â”œâ”€â”€ README.md â”œâ”€â”€ app // Flask APPåº”ç”¨ â”‚&nbsp;&nbsp; â”œâ”€â”€ __init__.py â”‚&nbsp;&nbsp; â”œâ”€â”€ auth â”‚&nbsp;&nbsp; â”œâ”€â”€ email.py â”‚&nbsp;&nbsp; â”œâ”€â”€ main â”‚&nbsp;&nbsp; â”œâ”€â”€ models.py â”‚&nbsp;&nbsp; â”œâ”€â”€ salt â”‚&nbsp;&nbsp; â”œâ”€â”€ static â”‚&nbsp;&nbsp; â””â”€â”€ templates â”œâ”€â”€ config.py // é€šç”¨é…ç½® â”œâ”€â”€ config.pyc â”œâ”€â”€ manager.py â”œâ”€â”€ migrations â”‚&nbsp;&nbsp; â”œâ”€â”€ README â”‚&nbsp;&nbsp; â”œâ”€â”€ alembic.ini â”‚&nbsp;&nbsp; â”œâ”€â”€ env.py â”‚&nbsp;&nbsp; â””â”€â”€ versions â””â”€â”€ requirements.txt (2)æŒ‡å®šbroker/backend(æ­¤å¤„ä½¿ç”¨redis)vim app/__init__.py // éƒ¨åˆ†ä»£ç  from celery import Celery app = Flask(__name__) broker = 'redis://127.0.0.1:6379' backend = 'redis://127.0.0.1:6379/0' celery = Celery(app.name, broker=broker, backend=backend) // éƒ¨åˆ†ä»£ç  ä»¥ä¸Šå¼•å…¥äº†Celery,æŒ‡å®šäº†Celeryçš„ç”Ÿäº§æ¶ˆè´¹ç«¯éƒ½ä¸ºæˆ‘ä»¬çš„redis (3)è¿™é‡Œæˆ‘å°†ä»»åŠ¡å†™åˆ°äº†è§†å›¾å‡½æ•°ä¸­vim app/main/views.py (1 åˆ›å»ºä¸€ä¸ªä»»åŠ¡å‡½æ•°, å¹¶ä¸”å°†è¿™ä¸ªä»»åŠ¡ç»‘å®šä¸Šäº†celeryçš„æ ‡è®° éƒ¨åˆ†ä»£ç @celery.task(bind=True)def update_cbt_resource(self):â€˜â€™â€™@summary: åˆ›å»ºä¸€ä¸ªéœ€è¦åå°å»æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæˆ‘è¿™é‡Œåªæ˜¯ä¸¾ä¸ªæ —å­â€˜â€™â€™result=commands.getoutput(â€œsleep 20 &amp;&amp; echo â€˜okâ€™â€)return result (2 åˆ›å»ºä¸€ä¸ªæ‰§è¡Œä»»åŠ¡è¯·æ±‚å‡½æ•° éƒ¨åˆ†ä»£ç @main.route(â€˜/execute_task/â€˜, methods=[â€˜GETâ€™, â€˜POSTâ€™])def execute_task(update_env):â€œâ€â€@summary: è¯·æ±‚å‡½æ•°å…¥å£â€œâ€â€# è¿™é‡Œç”¨æœ€ç¬¨çš„åŠæ³•æ‰§è¡Œäº†åœ¨æˆ‘ä»¬webä¸­ç‚¹å‡»æ‰§è¡Œä»»åŠ¡ä¹‹å‰å»æ£€æŸ¥celeryè¿™ä¸ªæœåŠ¡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ä¼šæç¤ºç”¨æˆ·result = commands.getoutput(â€œps -ef | grep celery | grep -v grepâ€)if not result: return jsonify({â€œresultâ€:False,â€messageâ€:uâ€™æœªå‘ç°Celeryè¿›ç¨‹ï¼Œè¯·æ£€æŸ¥è¯¥æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨â€™}) # å°†å‰é¢å†™çš„ä»»åŠ¡å‡½æ•°ç›´æ¥è°ƒç”¨apply_asyncå±æ€§task = update_cbt_resource.apply_async() # è¿™é‡Œå°±å¯ä»¥è·å–åˆ°è¿™ä¸ªä»»åŠ¡ä¸€å¼€å§‹æ‰§è¡Œå°±è¿”å›çš„ä¸€äº›å±æ€§ # æ¯”å¦‚ä»»åŠ¡ID, ä»»åŠ¡çŠ¶æ€data = { â€œtask_idâ€: task.id, â€œtask_statusâ€: task.status}# å°†ä»¥ä¸Šçš„ä¿¡æ¯ä½œä¸ºè¿™è¯·æ±‚å‡½æ•°çš„è¿”å›result = {â€œresultâ€:True,â€dataâ€:data,â€messageâ€:uâ€™æ‰§è¡Œå¼€å§‹â€™}return jsonify(result) (3 åˆ›å»ºä¸€ä¸ªä»»åŠ¡çŠ¶æ€æŸ¥è¯¢çš„å‡½æ•° ä¸€èˆ¬ä»»åŠ¡è§¦å‘ä¹‹åæˆ‘ä»¬æƒ³è¦çŸ¥é“è¿™ä¸ªä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œæ˜¯å¤„äºå“ªä¸ªé˜¶æ®µçš„ï¼Œå„ä¸ªçŠ¶æ€å·²ç»åœ¨å®˜ç½‘è¯¦ç»†è¯´æ˜äº†ï¼›æœ‰å…´è¶£çš„ç›´æ¥çœ‹å®˜ç½‘ 1234567891011121314151617181920212223242526272829### éƒ¨åˆ†çš„ä»£ç @main.route('/task_result', methods=['GET'])@login_requireddef task_result(): ''' @summary: ä»»åŠ¡çš„çŠ¶æ€æ˜¯é€šè¿‡task_idæ¥è·å–,åœ¨è§¦å‘äº†ä»»åŠ¡ä¹‹å,é€šè¿‡å‰ç«¯jsè½®è¯¢è¯·æ±‚è¿™ä¸ªå‡½æ•°ï¼Œå°±å¯ä»¥å¾—åˆ°è¯¥ä»»åŠ¡çš„å½“å‰æ‰§è¡ŒçŠ¶æ€ ''' # ç‚¹å‡»æ‰§è¡ŒæŒ‰é’®å‰ç«¯ä¼šä¼ ä¸€ä¸ªtask_idåˆ°åç«¯,è¿™é‡Œä½¿ç”¨formçš„æ–¹å¼è·å–åˆ°task_id task_id = json.loads(request.form.get('data'))['task_id'] # AsyncResultï¼Œå®ƒçš„ä½œç”¨æ˜¯è¢«ç”¨æ¥æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æˆ–è·å–ä»»åŠ¡ç»“æœï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œå®ƒä¼šè¿”å›å¼‚å¸¸ä¿¡æ¯æˆ–è€…è°ƒç”¨æ ˆã€‚ the_task = update_cbt_resource.AsyncResult(task_id) print(\"ä»»åŠ¡ï¼š{0} å½“å‰çš„ state ä¸ºï¼š{1}\".format(task_id, the_task.state)) # æ‰§the_task.state if the_task.state == 'PROGRESS': print the_task.info.get('i', 0) result = {'state': 'progress',\"result_data\":the_task.result} elif the_task.state == 'SUCCESS': result = {'state': \"success\", \"result_data\":the_task.result} elif the_task.state == 'PENDING': result = {'state': 'waitting',\"result_data\":the_task.result} elif the_task.state == 'REVOKED': result = { 'state': 'revoke', \"result_data\":the_task.result} print the_task.result else: result = {'state': the_task.state,'progress':0,\"result_data\":the_task.result} return jsonify(result) (4 å°è¯•åœ¨å‰ç«¯é¡µé¢ç‚¹å‡»æ‰§è¡Œä»»åŠ¡ï¿¼Oops! è¿™å°±æ˜¯ä¸Šé¢è¿›è¡Œceleryè¿›ç¨‹åˆ¤æ–­ä¹‹åå¾—åˆ°çš„æç¤ºä¿¡æ¯ï¼Œé‚£ä¸‹é¢å°±æŠŠceleryå¯åŠ¨èµ·æ¥å§~~~ (5 å¯åŠ¨CeleyæœåŠ¡ celery worker -A manager.celery -l debug æˆ‘è¿™é‡Œæ˜¯æœ¬åœ°ä½¿ç”¨çš„virtualenvç¯å¢ƒ~~~ ï¿¼ok, ç°åœ¨å¯åŠ¨äº†celeryæœåŠ¡ä¹‹åæˆ‘ä»¬åœ¨å‰å°æ‰§è¡Œä¸€ä¸‹:ï¿¼é€šè¿‡ç‚¹å‡»æ‰§è¡Œåæˆ‘ä»¬çœ‹æ—¥å¿—ï¼šï¿¼ ä»»åŠ¡æ‰§è¡Œå®Œæ¯•äº†ï¼›ï¿¼ å†çœ‹çœ‹Flaskçš„æ—¥å¿—,è¿™å°±æ˜¯é€šè¿‡jsè½®è¯¢è¯·æ±‚è¿™ä¸ªtask_resulå‡½æ•°çš„ç»“æœï¿¼å†æ¥çœ‹çœ‹redisä¸­çš„å†…å®¹,è¿™å°±å°†ç»“æœä¿å­˜åˆ°äº†backendä¸­ï¿¼ (4)å¦‚ä½•æ’¤é”€ä¸€ä¸ªä»»åŠ¡å‘¢?è¿˜æ˜¯é€šè¿‡task_idæ¥å®ç°ã€‚è§†å›¾å‡½æ•°ä¸­ç¼–å†™ä¸€ä¸ªä»»åŠ¡çš„å‡½æ•° ### éƒ¨åˆ†ä»£ç  @main.route('/cancel_task/', methods=['GET', 'POST']) @login_required def cancel_task(): # é€šè¿‡å‰ç«¯çš„å–æ¶ˆæŒ‰é’®æ¥è·å–åˆ°è¿™ä¸ªä»»åŠ¡çš„id task_id = json.loads(request.form.get('data'))['task_id'] try: celery.control.revoke(task_id, terminate=True, signal='SIGKILL') return Response(json.dumps({'result':True,\"message\": \"å–æ¶ˆä»»åŠ¡å®Œæˆ\" })) except Exception,e: return Response(json.dumps({'result': True, \"message\": u'å–æ¶ˆä»»åŠ¡å¤±è´¥.{0}'.format(e)})) æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹:ï¿¼ï¿¼ï¿¼ ï¿¼éœ€è¦æ³¨æ„çš„æ˜¯,åœ¨ä¸Šé¢è§†å›¾å‡½æ•°ä¸­çš„è¿™æ®µä»£ç å…¶å®æœ‰ä¹Ÿå¯ä»¥æ’¤é”€ task = update_cbt_resource.apply_async() task.revoke() ä½†æ˜¯è¿™ç§æ–¹å¼åªæ˜¯æ’¤é”€ï¼Œå¦‚æœä»»åŠ¡å·²ç»åœ¨æ‰§è¡Œæ’¤é”€åˆ™æ— æ•ˆ;æ‰€ä»¥æˆ‘è¿™é‡Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•æ¥æ’¤é”€ # é€šè¿‡task_idæ’¤é”€ celery.control.revoke(task_id) # æ’¤é”€æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé»˜è®¤ä½¿ç”¨TERMä¿¡å· celery.control.revoke(task_id, terminate=True) # æ’¤é”€æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé»˜è®¤ä½¿ç”¨KILLä¿¡å· celery.control.revoke(task_id, terminate=True, signal='SIGKILL') #åœ¨å®˜ç½‘æ–‡æ¡£ä¸­ä¹Ÿå¯ä»¥å°†å¤šä¸ªtask_idç»„æˆåˆ—è¡¨å½¢å¼ç„¶ååŒæ—¶æ’¤é”€å¤šä¸ªä»»åŠ¡ celery.control.revoke([task_id1,task_id2,task_id3,task_id4.......]) okï¼Œä»¥ä¸Šå°±æ˜¯Celery çš„åŸºæœ¬ä½¿ç”¨ã€‚","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"Celery","slug":"Celery","permalink":"https://blog.sctux.cc/tags/Celery/"},{"name":"Python","slug":"Python","permalink":"https://blog.sctux.cc/tags/Python/"}],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"Redisé›†ç¾¤è¯¦ç»†æ­å»ºæŒ‡å—","slug":"redis-ji-qun-xiang-xi-da-jian-zhi-nan","date":"2017-06-04T06:17:26.000Z","updated":"2025-09-01T01:59:08.955Z","comments":true,"path":"2017/06/04/redis-ji-qun-xiang-xi-da-jian-zhi-nan/","permalink":"https://blog.sctux.cc/2017/06/04/redis-ji-qun-xiang-xi-da-jian-zhi-nan/","excerpt":"Redis é›†ç¾¤ç®€ä»‹Redis æ˜¯ä¸€ä¸ªå¼€æºçš„ key-value å­˜å‚¨ç³»ç»Ÿï¼Œç”±äºå‡ºä¼—çš„æ€§èƒ½ï¼Œå¤§éƒ¨åˆ†äº’è”ç½‘ä¼ä¸šéƒ½ç”¨æ¥åšæœåŠ¡å™¨ç«¯ç¼“å­˜ã€‚Redis åœ¨3.0ç‰ˆæœ¬å‰åªæ”¯æŒå•å®ä¾‹æ¨¡å¼ï¼Œè™½ç„¶æ”¯æŒä¸»ä»æ¨¡å¼ã€å“¨å…µæ¨¡å¼éƒ¨ç½²æ¥è§£å†³å•ç‚¹æ•…éšœï¼Œä½†æ˜¯ç°åœ¨äº’è”ç½‘ä¼ä¸šåŠ¨è¾„å¤§å‡ ç™¾Gçš„æ•°æ®ï¼Œå¯å®Œå…¨æ˜¯æ²¡æ³•æ»¡è¶³ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæ‰€ä»¥ï¼ŒRedis åœ¨ 3.0 ç‰ˆæœ¬ä»¥åå°±æ¨å‡ºäº†é›†ç¾¤æ¨¡å¼ã€‚ Redis ä»3.0.0æ­£å¼ç‰ˆå¼€å§‹å®˜æ–¹æ”¯æŒé›†ç¾¤, Redis é›†ç¾¤é‡‡ç”¨äº†P2Pçš„æ¨¡å¼ï¼Œå®Œå…¨å»ä¸­å¿ƒåŒ–ã€‚Redis æŠŠæ‰€æœ‰çš„ Key åˆ†æˆäº† 16384 ä¸ª slotï¼Œæ¯ä¸ª Redis å®ä¾‹è´Ÿè´£å…¶ä¸­ä¸€éƒ¨åˆ† slot ã€‚é›†ç¾¤ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆèŠ‚ç‚¹ã€ç«¯å£ã€slotç­‰ï¼‰ï¼Œéƒ½é€šè¿‡èŠ‚ç‚¹ä¹‹é—´å®šæœŸçš„æ•°æ®äº¤æ¢è€Œæ›´æ–°ã€‚ Redis å®¢æˆ·ç«¯å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ª Redis å®ä¾‹å‘å‡ºè¯·æ±‚ï¼Œå¦‚æœæ‰€éœ€æ•°æ®ä¸åœ¨è¯¥å®ä¾‹ä¸­ï¼Œé€šè¿‡é‡å®šå‘å‘½ä»¤å¼•å¯¼å®¢æˆ·ç«¯è®¿é—®æ‰€éœ€çš„å®ä¾‹ã€‚ éšéšä¾¿ä¾¿æ­å»ºä¸€ä¸ªé›†ç¾¤å®‰è£…éƒ¨ç½²ä»»ä½•ä¸€ä¸ªåº”ç”¨å…¶å®éƒ½å¾ˆç®€å•ï¼Œåªè¦å®‰è£…æ­¥éª¤ä¸€æ­¥ä¸€æ­¥æ¥å°±è¡Œäº†ã€‚ä¸‹é¢è¯´ä¸€ä¸‹ Redis é›†ç¾¤æ­å»ºè§„åˆ’ï¼Œç”±äºé›†ç¾¤è‡³å°‘éœ€è¦6ä¸ªèŠ‚ç‚¹ï¼ˆ3ä¸»3ä»æ¨¡å¼ï¼‰ï¼Œæ‰€ä»¥ï¼Œæ²¡æœ‰è¿™ä¹ˆå¤šæœºå™¨ç»™æˆ‘ç©ï¼Œç°åœ¨è®¡åˆ’æ˜¯åœ¨ä¸€å°æœºå™¨ä¸Šæ¨¡æ‹Ÿä¸€ä¸ªé›†ç¾¤ï¼Œå½“ç„¶ï¼Œè¿™å’Œç”Ÿäº§ç¯å¢ƒçš„é›†ç¾¤æ­å»ºæ²¡æœ¬è´¨åŒºåˆ«ã€‚ 1.è·å–è½¯ä»¶åŒ…cd /tmp/ &amp;&amp; wget http://download.redis.io/releases/redis-4.0.11.tar.gz mkdir /usr/local/redis &amp;&amp; tar -xr /tmp/redis-4.0.11.tar.gz -C /usr/local/redis cd /usr/local/redis ./configure make -j 4 make install 2.è§„åˆ’åˆ›å»ºæ–‡ä»¶ç›®å½•æˆ‘ä»¬è®¡åˆ’é›†ç¾¤ä¸­ Redis èŠ‚ç‚¹çš„ç«¯å£å·ä¸º 9001-9006 ï¼Œç«¯å£å·å³é›†ç¾¤ä¸‹å„å®ä¾‹æ–‡ä»¶å¤¹ã€‚æ•°æ®å­˜æ”¾åœ¨ ç«¯å£å·/data æ–‡ä»¶å¤¹ä¸­ã€‚","text":"Redis é›†ç¾¤ç®€ä»‹Redis æ˜¯ä¸€ä¸ªå¼€æºçš„ key-value å­˜å‚¨ç³»ç»Ÿï¼Œç”±äºå‡ºä¼—çš„æ€§èƒ½ï¼Œå¤§éƒ¨åˆ†äº’è”ç½‘ä¼ä¸šéƒ½ç”¨æ¥åšæœåŠ¡å™¨ç«¯ç¼“å­˜ã€‚Redis åœ¨3.0ç‰ˆæœ¬å‰åªæ”¯æŒå•å®ä¾‹æ¨¡å¼ï¼Œè™½ç„¶æ”¯æŒä¸»ä»æ¨¡å¼ã€å“¨å…µæ¨¡å¼éƒ¨ç½²æ¥è§£å†³å•ç‚¹æ•…éšœï¼Œä½†æ˜¯ç°åœ¨äº’è”ç½‘ä¼ä¸šåŠ¨è¾„å¤§å‡ ç™¾Gçš„æ•°æ®ï¼Œå¯å®Œå…¨æ˜¯æ²¡æ³•æ»¡è¶³ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæ‰€ä»¥ï¼ŒRedis åœ¨ 3.0 ç‰ˆæœ¬ä»¥åå°±æ¨å‡ºäº†é›†ç¾¤æ¨¡å¼ã€‚ Redis ä»3.0.0æ­£å¼ç‰ˆå¼€å§‹å®˜æ–¹æ”¯æŒé›†ç¾¤, Redis é›†ç¾¤é‡‡ç”¨äº†P2Pçš„æ¨¡å¼ï¼Œå®Œå…¨å»ä¸­å¿ƒåŒ–ã€‚Redis æŠŠæ‰€æœ‰çš„ Key åˆ†æˆäº† 16384 ä¸ª slotï¼Œæ¯ä¸ª Redis å®ä¾‹è´Ÿè´£å…¶ä¸­ä¸€éƒ¨åˆ† slot ã€‚é›†ç¾¤ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆèŠ‚ç‚¹ã€ç«¯å£ã€slotç­‰ï¼‰ï¼Œéƒ½é€šè¿‡èŠ‚ç‚¹ä¹‹é—´å®šæœŸçš„æ•°æ®äº¤æ¢è€Œæ›´æ–°ã€‚ Redis å®¢æˆ·ç«¯å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ª Redis å®ä¾‹å‘å‡ºè¯·æ±‚ï¼Œå¦‚æœæ‰€éœ€æ•°æ®ä¸åœ¨è¯¥å®ä¾‹ä¸­ï¼Œé€šè¿‡é‡å®šå‘å‘½ä»¤å¼•å¯¼å®¢æˆ·ç«¯è®¿é—®æ‰€éœ€çš„å®ä¾‹ã€‚ éšéšä¾¿ä¾¿æ­å»ºä¸€ä¸ªé›†ç¾¤å®‰è£…éƒ¨ç½²ä»»ä½•ä¸€ä¸ªåº”ç”¨å…¶å®éƒ½å¾ˆç®€å•ï¼Œåªè¦å®‰è£…æ­¥éª¤ä¸€æ­¥ä¸€æ­¥æ¥å°±è¡Œäº†ã€‚ä¸‹é¢è¯´ä¸€ä¸‹ Redis é›†ç¾¤æ­å»ºè§„åˆ’ï¼Œç”±äºé›†ç¾¤è‡³å°‘éœ€è¦6ä¸ªèŠ‚ç‚¹ï¼ˆ3ä¸»3ä»æ¨¡å¼ï¼‰ï¼Œæ‰€ä»¥ï¼Œæ²¡æœ‰è¿™ä¹ˆå¤šæœºå™¨ç»™æˆ‘ç©ï¼Œç°åœ¨è®¡åˆ’æ˜¯åœ¨ä¸€å°æœºå™¨ä¸Šæ¨¡æ‹Ÿä¸€ä¸ªé›†ç¾¤ï¼Œå½“ç„¶ï¼Œè¿™å’Œç”Ÿäº§ç¯å¢ƒçš„é›†ç¾¤æ­å»ºæ²¡æœ¬è´¨åŒºåˆ«ã€‚ 1.è·å–è½¯ä»¶åŒ…cd /tmp/ &amp;&amp; wget http://download.redis.io/releases/redis-4.0.11.tar.gz mkdir /usr/local/redis &amp;&amp; tar -xr /tmp/redis-4.0.11.tar.gz -C /usr/local/redis cd /usr/local/redis ./configure make -j 4 make install 2.è§„åˆ’åˆ›å»ºæ–‡ä»¶ç›®å½•æˆ‘ä»¬è®¡åˆ’é›†ç¾¤ä¸­ Redis èŠ‚ç‚¹çš„ç«¯å£å·ä¸º 9001-9006 ï¼Œç«¯å£å·å³é›†ç¾¤ä¸‹å„å®ä¾‹æ–‡ä»¶å¤¹ã€‚æ•°æ®å­˜æ”¾åœ¨ ç«¯å£å·/data æ–‡ä»¶å¤¹ä¸­ã€‚ mkdir /usr/local/redis-cluster/ cd /usr/local/redis-cluster/ for i in {1..6};do mkdir 900${i}/data done 3. å¤åˆ¶æ‰§è¡Œè„šæœ¬åœ¨ /usr/local/redis-cluster ä¸‹åˆ›å»º bin æ–‡ä»¶å¤¹ï¼Œç”¨æ¥å­˜æ”¾é›†ç¾¤è¿è¡Œè„šæœ¬ï¼Œå¹¶æŠŠå®‰è£…å¥½çš„ Redis çš„ src è·¯å¾„ä¸‹çš„è¿è¡Œè„šæœ¬æ‹·è´è¿‡æ¥ã€‚çœ‹å‘½ä»¤ï¼š mkdir /usr/local/redis-cluster/bin cd /usr/local/redis/src # ä¸‹è½½åè§£å‹ç¼–è¯‘åçš„srcç›®å½• cp mkreleasehdr.sh redis-benchmark redis-check-aof redis-check-dump redis-cli redis-server redis-trib.rb /usr/local/redis-cluster/bin 4.å¤åˆ¶ä¸€ä¸ªæ–° Redis å®ä¾‹æˆ‘ä»¬ç°åœ¨ä»å·²å®‰è£…å¥½çš„ Redis ä¸­å¤åˆ¶ä¸€ä¸ªæ–°çš„å®ä¾‹åˆ° 9001 æ–‡ä»¶å¤¹ï¼Œå¹¶ä¿®æ”¹ redis.conf é…ç½®ã€‚ cp /usr/local/redis/* /usr/local/redis-cluster/9001 port 9001ï¼ˆæ¯ä¸ªèŠ‚ç‚¹çš„ç«¯å£å·ï¼‰ daemonize yes bind 192.168.56.127ï¼ˆç»‘å®šå½“å‰æœºå™¨ IPï¼‰ dir /usr/local/redis-cluster/9001/data/ï¼ˆæ•°æ®æ–‡ä»¶å­˜æ”¾ä½ç½®ï¼‰ pidfile /var/run/redis_9001.pidï¼ˆpid 9001å’Œportè¦å¯¹åº”ï¼‰ cluster-enabled yesï¼ˆå¯åŠ¨é›†ç¾¤æ¨¡å¼ï¼‰ cluster-config-file nodes9001.confï¼ˆ9001å’Œportè¦å¯¹åº”ï¼‰ cluster-node-timeout 15000 appendonly yes 5.å†å¤åˆ¶å‡ºäº”ä¸ªæ–° Redis å®ä¾‹æˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸€ä¸ªèŠ‚ç‚¹äº†ï¼Œå…¶å®æ¥ä¸‹æ¥å°±æ˜¯æœºæ¢°åŒ–çš„å†å®Œæˆå¦å¤–äº”ä¸ªèŠ‚ç‚¹ï¼Œå…¶å®å¯ä»¥è¿™ä¹ˆåšï¼šæŠŠ 9001 å®ä¾‹ å¤åˆ¶åˆ°å¦å¤–äº”ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œå”¯ä¸€è¦ä¿®æ”¹çš„å°±æ˜¯ redis.conf ä¸­çš„æ‰€æœ‰å’Œç«¯å£çš„ç›¸å…³çš„ä¿¡æ¯å³å¯ï¼Œå…¶å®å°±é‚£ä¹ˆå››ä¸ªä½ç½®ã€‚å¼€å§‹æ“ä½œï¼Œçœ‹å‘½ä»¤ï¼š \\cp -rf /usr/local/redis-cluster/9001/* /usr/local/redis-cluster/9002 \\cp -rf /usr/local/redis-cluster/9001/* /usr/local/redis-cluster/9003 \\cp -rf /usr/local/redis-cluster/9001/* /usr/local/redis-cluster/9004 \\cp -rf /usr/local/redis-cluster/9001/* /usr/local/redis-cluster/9005 \\cp -rf /usr/local/redis-cluster/9001/* /usr/local/redis-cluster/9006 è¿™é‡Œæˆ‘ä»¬æŠŠé…ç½®å¤åˆ¶è¿‡å»ä¹‹åéœ€è¦ä¿®æ”¹å¯¹åº”æ–‡ä»¶å¤¹ä¸­çš„redis.conf ç”¨sedæˆ–è€…vimå…¨å±€æ›¿æ¢å³å¯ï¼Œä¸»è¦æ˜¯ç«¯å£ ä¸‹é¢ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å¯åŠ¨å®ƒä»¬ for i in {1..6};do /usr/local/bin/redis-server /usr/local/redis-cluster/900${i}/redis.conf done [root@localhost redis-cluster]# ps aux | grep redis | grep -v grep root 3995 0.5 0.6 151404 11864 ? Ssl 10:51 0:10 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9001 [cluster] root 4000 0.4 0.6 151404 11856 ? Ssl 10:51 0:09 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9002 [cluster] root 4005 0.4 0.6 151404 11856 ? Ssl 10:51 0:09 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9003 [cluster] root 4010 0.1 0.6 151404 11872 ? Ssl 10:51 0:02 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9004 [cluster] root 4015 0.0 0.6 151404 11876 ? Ssl 10:51 0:01 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9005 [cluster] root 4020 0.0 0.6 151404 11872 ? Ssl 10:51 0:01 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9006 [cluster] root 4509 0.8 0.6 149356 11880 ? Ssl 10:55 0:14 /usr/local/redis-cluster/bin/redis-server [root@localhost redis-cluster]# ä»¥ä¸Š å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„6ä¸ªå®ä¾‹å·²ç»å¯åŠ¨äº†æµ‹è¯•ä¸€ä¸‹ï¼Ÿ éšä¾¿æ‰¾ä¸ªèŠ‚ç‚¹æµ‹è¯•ä¸€ä¸‹: /usr/local/redis-cluster/bin/redis-cli -h 192.168.56.127 -p 9001 192.168.56.127:9001&gt; set name guomaoqiu (error) CLUSTERDOWN Hash slot not served 192.168.56.127:9001&gt; è¿æ¥æˆåŠŸäº†ï¼Œä½†å¥½åƒæŠ¥é”™äº† è¿™æ˜¯å› ä¸ºè™½ç„¶æˆ‘ä»¬é…ç½®å¹¶å¯åŠ¨äº† Redis é›†ç¾¤æœåŠ¡ï¼Œä½†æ˜¯ä»–ä»¬æš‚æ—¶è¿˜å¹¶ä¸åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œäº’ç›¸ç›´æ¥å‘ç°ä¸äº†ï¼Œè€Œä¸”è¿˜æ²¡æœ‰å¯å­˜å‚¨çš„ä½ç½®ï¼Œå°±æ˜¯æ‰€è°“çš„slotï¼ˆæ§½ï¼‰ã€‚ 6.å®‰è£…é›†ç¾¤æ‰€éœ€è½¯ä»¶ç”±äº Redis é›†ç¾¤éœ€è¦ä½¿ç”¨ ruby å‘½ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®‰è£… ruby å’Œç›¸å…³æ¥å£ã€‚ å®‰è£…rediséœ€è¦rubyç‰ˆæœ¬æœ€ä½æ˜¯2.2.2ï¼Œè€Œcentos yumåº“ä¸­rubyç‰ˆæœ¬æ”¯æŒåˆ°2.0.0ã€‚æ‰€ä»¥ï¼Œæ— æ³•æ»¡è¶³éœ€æ±‚ã€‚ è§£å†³æ–¹æ¡ˆï¼š 1.å®‰è£…curl sudo yum install curl 2.å®‰è£…RVM curl -L get.rvm.io | bash -s stable source /usr/local/rvm/scripts/rvm 3.æŸ¥çœ‹rvmåº“ä¸­å·²çŸ¥çš„rubyç‰ˆæœ¬ rvm list known 4.å®‰è£…ä¸€ä¸ªrubyç‰ˆæœ¬ rvm install 2.3.3 5.è®¾ç½®é»˜è®¤ç‰ˆæœ¬ rvm use 2.3.3 6.å¸è½½ä¸€ä¸ªå·²çŸ¥ç‰ˆæœ¬ rvm remove 2.0.0 7.æŸ¥çœ‹rubyç‰ˆæœ¬ ruby â€“version 8.å†å®‰è£…rediså°±å¯ä»¥äº† gem install redis 7. åˆ©ç”¨å®˜æ–¹æä¾›çš„å‘½ä»¤åˆ›å»ºé›†ç¾¤/usr/local/redis-cluster/bin/redis-trib.rb create --replicas 1 192.168.56.127:9001 192.168.56.127:9002 192.168.56.127:9003 192.168.56.127:9004 192.168.56.127:9005 192.168.56.127:9006 ç®€å•è§£é‡Šä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ï¼šè°ƒç”¨ ruby å‘½ä»¤æ¥è¿›è¡Œåˆ›å»ºé›†ç¾¤ï¼Œâ€“replicas 1 è¡¨ç¤ºä¸»ä»å¤åˆ¶æ¯”ä¾‹ä¸º 1:1ï¼Œå³ä¸€ä¸ªä¸»èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªä»èŠ‚ç‚¹ï¼›ç„¶åï¼Œé»˜è®¤ç»™æˆ‘ä»¬åˆ†é…å¥½äº†æ¯ä¸ªä¸»èŠ‚ç‚¹å’Œå¯¹åº”ä»èŠ‚ç‚¹æœåŠ¡ï¼Œä»¥åŠ solt çš„å¤§å°ï¼Œå› ä¸ºåœ¨ Redis é›†ç¾¤ä¸­æœ‰ä¸”ä»…æœ‰ 16383 ä¸ª solt ï¼Œé»˜è®¤æƒ…å†µä¼šç»™æˆ‘ä»¬å¹³å‡åˆ†é…ï¼Œå½“ç„¶ä½ å¯ä»¥æŒ‡å®šï¼Œåç»­çš„å¢å‡èŠ‚ç‚¹ä¹Ÿå¯ä»¥é‡æ–°åˆ†é…ã€‚ [root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb create --replicas 1 192.168.56.127:9001 192.168.56.127:9002 192.168.56.127:9003 192.168.56.127:9004 192.168.56.127:9005 192.168.56.127:9006 &gt;&gt;&gt; Creating cluster &gt;&gt;&gt; Performing hash slots allocation on 6 nodes... Using 3 masters: # ä¸‰ä¸ªä¸»èŠ‚ç‚¹ 192.168.56.127:9001 192.168.56.127:9002 192.168.56.127:9003 # ä¸‰ä¸ªä¸»èŠ‚ç‚¹å¯¹åº”ä¸‰ä¸ªä»èŠ‚ç‚¹ Adding replica 192.168.56.127:9005 to 192.168.56.127:9001 Adding replica 192.168.56.127:9006 to 192.168.56.127:9002 Adding replica 192.168.56.127:9004 to 192.168.56.127:9003 &gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity [WARNING] Some slaves are in the same host as their master M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001 slots:0-5460 (5461 slots) master M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002 slots:5461-10922 (5462 slots) master M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003 slots:10923-16383 (5461 slots) master S: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004 replicates 474fd53f7199ad70cce7f18bd68f5445b559509a S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005 replicates e070e76789352d2492cfc9800850e943e0c4b72d S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006 replicates 0fcbaa301451baf87284546513003568e47b5daa Can I set the above configuration? (type 'yes' to accept): yes &gt;&gt;&gt; Nodes configuration updated &gt;&gt;&gt; Assign a different config epoch to each node &gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster Waiting for the cluster to join... &gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001) M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001 slots:0-5460 (5461 slots) master 1 additional replica(s) M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002 slots:5461-10922 (5462 slots) master 1 additional replica(s) M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003 slots:10923-16383 (5461 slots) master 1 additional replica(s) S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006 slots: (0 slots) slave replicates 0fcbaa301451baf87284546513003568e47b5daa S: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004 slots: (0 slots) slave replicates 474fd53f7199ad70cce7f18bd68f5445b559509a S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005 slots: (0 slots) slave replicates e070e76789352d2492cfc9800850e943e0c4b72d [OK] All nodes agree about slots configuration. &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered. ä»¥ä¸Šæ‰§è¡Œç»“æœä»£è¡¨é›†ç¾¤æ­å»ºæˆåŠŸå•¦ï¼ï¼ï¼ éªŒè¯ï¼š /usr/local/redis-cluster/bin/redis-cli -c -h 192.168.56.127 -p 9001 192.168.56.127:9001&gt; cluster info cluster_state:ok cluster_slots_assigned:16384 cluster_slots_ok:16384 cluster_slots_pfail:0 cluster_slots_fail:0 cluster_known_nodes:6 cluster_size:3 cluster_current_epoch:6 cluster_my_epoch:1 cluster_stats_messages_ping_sent:167 cluster_stats_messages_pong_sent:172 cluster_stats_messages_sent:339 cluster_stats_messages_ping_received:167 cluster_stats_messages_pong_received:167 cluster_stats_messages_meet_received:5 cluster_stats_messages_received:339 192.168.56.127:9001&gt; cluster nodes 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002@19002 master - 0 1536205294229 2 connected 5461-10922 e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003@19003 master - 0 1536205293000 3 connected 10923-16383 bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006@19006 slave 0fcbaa301451baf87284546513003568e47b5daa 0 1536205295234 6 connected 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001@19001 myself,master - 0 1536205294000 1 connected 0-5460 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004@19004 slave 474fd53f7199ad70cce7f18bd68f5445b559509a 0 1536205293217 4 connected 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005@19005 slave e070e76789352d2492cfc9800850e943e0c4b72d 0 1536205292212 5 connected 192.168.56.127:9001&gt; set name guomaoqiu -&gt; Redirected to slot [5798] located at 192.168.56.127:9002 OK 192.168.56.127:9002&gt; get name \"guomaoqiu\" 192.168.56.127:9002&gt; é€šè¿‡å‘½ä»¤ï¼Œå¯ä»¥è¯¦ç»†çš„çœ‹å‡ºé›†ç¾¤ä¿¡æ¯å’Œå„ä¸ªèŠ‚ç‚¹çŠ¶æ€ï¼Œä¸»ä»ä¿¡æ¯ä»¥åŠè¿æ¥æ•°ã€æ§½ä¿¡æ¯ç­‰ã€‚è¿™ä¹ˆçœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»çœŸçš„æŠŠ Redis é›†ç¾¤æ­å»ºéƒ¨ç½²æˆåŠŸå•¦ï¼ å¦‚ä½•æ–°å¢èŠ‚ç‚¹ï¼Ÿæ–°å¢èŠ‚ç‚¹æ— éå°±æ˜¯å¤åˆ¶é…ç½®ï¼Œä¿®æ”¹é…ç½®ï¼Œç„¶åå¯åŠ¨ï¼›æˆ‘è¿™é‡Œè¿˜æ˜¯åˆ›å»ºäº†ä¸€å¯¹ä¸€ä¸»ä¸€ä»çš„é…ç½®ï¼Œç«¯å£åˆ†åˆ«å¯¹åº”çš„æ˜¯9007ã€9008 1.å¯åŠ¨ä¸¤ä¸ªå®ä¾‹(å‡è®¾æˆ‘è¿™é‡Œå·²ç»å¤åˆ¶é…ç½®ï¼Œä¿®æ”¹å®Œé…ç½®äº†)for i in {7..8};do /usr/local/redis-cluster/bin/redis-server /usr/local/redis-cluster/900${i}/redis.conf done 6002:C 06 Sep 11:50:53.048 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo 6002:C 06 Sep 11:50:53.048 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=6002, just started 6002:C 06 Sep 11:50:53.048 # Configuration loaded 6004:C 06 Sep 11:50:53.060 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo 6004:C 06 Sep 11:50:53.060 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=6004, just started 6004:C 06 Sep 11:50:53.060 # Configuration loaded ps aux | grep redis | grep -v grep redis 1180 0.0 0.3 142900 5828 ? Ssl 11:28 0:01 /usr/bin/redis-server 0.0.0.0:6379 root 4257 0.0 0.6 149356 11880 ? Ssl 11:32 0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9001 [cluster] root 4262 0.0 0.6 149356 11880 ? Ssl 11:32 0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9002 [cluster] root 4267 0.0 0.6 149356 11876 ? Ssl 11:32 0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9003 [cluster] root 4272 0.0 0.6 149356 11908 ? Ssl 11:32 0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9004 [cluster] root 4277 0.0 0.6 149356 11920 ? Ssl 11:32 0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9005 [cluster] root 4282 0.0 0.6 149356 11912 ? Ssl 11:32 0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9006 [cluster] root 6003 0.1 0.5 147308 9616 ? Ssl 11:50 0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9007 [cluster] root 6008 0.0 0.5 147308 9616 ? Ssl 11:50 0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9008 [cluster] ä»¥ä¸Š å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯åŠ¨äº†åé¢ä¸¤ä¸ªå®ä¾‹ï¼Œå¹¶ä¸”è¿›ç¨‹ä¸­æ ‡æ³¨äº†æ˜¯ä»¥é›†ç¾¤æ–¹å¼å¯åŠ¨, ä½†æ˜¯æ­¤æ—¶è¿˜å¹¶æ²¡æœ‰å°†å®ä¾‹åŠ å…¥åˆ°é›†ç¾¤å½“ä¸­ã€‚ 2.æ·»åŠ å®ä¾‹åˆ°é›†ç¾¤[root@locahost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb add-node 192.168.56.127:9007 192.168.56.127:9001 &gt;&gt;&gt; Adding node 192.168.56.127:9007 to cluster 192.168.56.127:9001 &gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001) M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001 slots:0-5460 (5461 slots) master 1 additional replica(s) M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002 slots:5461-10922 (5462 slots) master 1 additional replica(s) M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003 slots:10923-16383 (5461 slots) master 1 additional replica(s) S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006 slots: (0 slots) slave replicates 0fcbaa301451baf87284546513003568e47b5daa S: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004 slots: (0 slots) slave replicates 474fd53f7199ad70cce7f18bd68f5445b559509a S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005 slots: (0 slots) slave replicates e070e76789352d2492cfc9800850e943e0c4b72d [OK] All nodes agree about slots configuration. &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered. &gt;&gt;&gt; Send CLUSTER MEET to node 192.168.56.127:9007 to make it join the cluster. [OK] New node added correctly. [root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-cli -c -h 192.168.56.127 -p 9001 cluster nodes 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002@19002 master - 0 1536215194000 2 connected 5461-10922 e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003@19003 master - 0 1536215194000 3 connected 10923-16383 bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006@19006 slave 0fcbaa301451baf87284546513003568e47b5daa 0 1536215193000 6 connected 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001@19001 myself,master - 0 1536215192000 1 connected 0-5460 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004@19004 slave 474fd53f7199ad70cce7f18bd68f5445b559509a 0 1536215195858 4 connected 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007@19007 master - 0 1536215195000 0 connected 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005@19005 slave e070e76789352d2492cfc9800850e943e0c4b72d 0 1536215194855 5 connected ä»¥ä¸Šå¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡ add-node å‚æ•°æ·»åŠ äº† 9007è¿™ä¸ªå®ä¾‹ï¼›å‘½ä»¤æœ€åä¸€ä¸ªå‚æ•°æ˜¯å·²ç»æˆä¸ºé›†ç¾¤çš„é›†ç¾¤æˆå‘˜host:portè€Œä¸”å®ä¾‹9007è·å¾—äº†ä¸€ä¸ªé›†ç¾¤ID:1714784542b3afc9e2a8b2c93fff49d095e7d72b 5. å¢åŠ å®ä¾‹çš„ä»èŠ‚ç‚¹åˆ°é›†ç¾¤ä»¥ä¸Šæˆ‘ä»¬å°†å®ä¾‹9007ä½œä¸ºmasterå¢åŠ åˆ°äº†é›†ç¾¤ä¸­ï¼Œä½†æ˜¯æŒ‰ç…§å‰é¢çš„è§„åˆ’ï¼Œæ¯ä¸ªmasterå¯¹åº”ä¸€ä¸ªslaveæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å®ä¾‹9008åŠ å…¥é›†ç¾¤å¹¶å°†å…¶ç§°ä¸º9007çš„slave,å‘½ä»¤å¦‚ä¸‹ [root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb add-node --slave --master-id 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9008 192.168.56.127:9001 &gt;&gt;&gt; Adding node 192.168.56.127:9008 to cluster 192.168.56.127:9001 &gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001) M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001 slots:0-5460 (5461 slots) master 1 additional replica(s) M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002 slots:5461-10922 (5462 slots) master 1 additional replica(s) M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003 slots:10923-16383 (5461 slots) master 1 additional replica(s) S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006 slots: (0 slots) slave replicates 0fcbaa301451baf87284546513003568e47b5daa S: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004 slots: (0 slots) slave replicates 474fd53f7199ad70cce7f18bd68f5445b559509a M: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007 slots: (0 slots) master 0 additional replica(s) S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005 slots: (0 slots) slave replicates e070e76789352d2492cfc9800850e943e0c4b72d [OK] All nodes agree about slots configuration. &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered. &gt;&gt;&gt; Send CLUSTER MEET to node 192.168.56.127:9008 to make it join the cluster. Waiting for the cluster to join. &gt;&gt;&gt; Configure node as replica of 192.168.56.127:9007. [OK] New node added correctly. [root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb check 192.168.56.127:9001 &gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001) M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001 slots:0-5460 (5461 slots) master 1 additional replica(s) M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002 slots:5461-10922 (5462 slots) master 1 additional replica(s) M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003 slots:10923-16383 (5461 slots) master 1 additional replica(s) S: 5ed978b695e6a222e67d13c68e55f6c4e74b7ba6 192.168.56.127:9008 slots: (0 slots) slave replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72b S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006 slots: (0 slots) slave replicates 0fcbaa301451baf87284546513003568e47b5daa S: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004 slots: (0 slots) slave replicates 474fd53f7199ad70cce7f18bd68f5445b559509a M: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007 slots: (0 slots) master 1 additional replica(s) S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005 slots: (0 slots) slave replicates e070e76789352d2492cfc9800850e943e0c4b72d [OK] All nodes agree about slots configuration. &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered. ä»¥ä¸Šæˆ‘ä»¬å°†ä¸¤ä¸ªèŠ‚ç‚¹åŠ å…¥åˆ°äº†é›†ç¾¤ä¸­ï¼Œä½†æ˜¯ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°æˆ‘ä»¬çš„å®ä¾‹9007æ‰€æ‹¥æœ‰çš„slotæ•°é‡ä¸º0ï¼Œé‚£æ­¤æ—¶å°±éœ€è¦å°†é‡æ–°è°ƒæ•´å“ˆå¸Œæ§½å•¦~å†æ¬¡ä¹‹å‰æˆ‘ä»¬ä¸‰ä¸ªmaster å¹³å‡å°†16384 åˆ†æˆäº†ä¸‰ç­‰åˆ†ï¼Œé‚£æˆ‘ä»¬æ–°å¢åŠ äº†ä¸€ä¸ªmaster ï¼Œä¸ºäº†å¹³è¡¡æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºè¿™ä¸ªæ–°çš„masteréœ€è¦å¤šå°‘å“ˆå¸Œæ§½ï¼Œå³ 16384/4 = 4096 æˆ‘ä»¬éœ€è¦ç§»åŠ¨4096ä¸ªæ§½ç‚¹åˆ°9007ä¸Šã€‚ [root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb reshard 192.168.56.127:9001 &gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001) M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001 slots:0-5460 (5461 slots) master 1 additional replica(s) S: 5ed978b695e6a222e67d13c68e55f6c4e74b7ba6 192.168.56.127:9008 slots: (0 slots) slave replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72b M: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007 slots:5461-5798 (0 slots) master 1 additional replica(s) S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005 slots: (0 slots) slave replicates e070e76789352d2492cfc9800850e943e0c4b72d M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002 slots:5799-10922 (5462 slots) master 1 additional replica(s) M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003 slots:10923-16383 (5461 slots) master 1 additional replica(s) S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006 slots: (0 slots) slave replicates 0fcbaa301451baf87284546513003568e47b5daa S: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004 slots: (0 slots) slave replicates 474fd53f7199ad70cce7f18bd68f5445b559509a [OK] All nodes agree about slots configuration. &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered. # è¿™é‡Œéœ€è¦è¾“å…¥æˆ‘ä»¬æ‰€éœ€è¦çš„å“ˆå¸Œæ§½ How many slots do you want to move (from 1 to 16384)? 4097 # è¿™é‡Œéœ€è¦è¾“å…¥æˆ‘ä»¬å®ä¾‹9007çš„ID What is the receiving node ID? 1714784542b3afc9e2a8b2c93fff49d095e7d72b Please enter all the source node IDs. Type 'all' to use all the nodes as source nodes for the hash slots. Type 'done' once you entered all the source nodes IDs. Source node #1:all #è¾“å…¥all è¡¨ç¤ºä»æ‰€æœ‰çš„ä¸»èŠ‚ç‚¹ä¸­éšæœºè½¬ç§»ï¼Œå‡‘å¤Ÿ1000ä¸ªå“ˆå¸Œæ§½ #ç„¶åå†è¾“å…¥yesï¼Œredisé›†ç¾¤å°±å¼€å§‹åˆ†é…å“ˆå¸Œæ§½äº†ã€‚ ä»¥ä¸Š:redis-trib ä¼šå‘ä½ è¯¢é—®é‡æ–°åˆ†ç‰‡çš„æºèŠ‚ç‚¹ï¼ˆsource nodeï¼‰ï¼Œå³ï¼Œè¦ä»ç‰¹ç‚¹çš„å“ªä¸ªèŠ‚ç‚¹ä¸­å–å‡º 4096 ä¸ªå“ˆå¸Œæ§½ï¼Œè¿˜æ˜¯ä»å…¨éƒ¨èŠ‚ç‚¹æå–4096ä¸ªå“ˆå¸Œæ§½ï¼Œ å¹¶å°†è¿™äº›æ§½ç§»åŠ¨åˆ°9007èŠ‚ç‚¹ä¸Šé¢ã€‚ å¦‚æœæˆ‘ä»¬ä¸æ‰“ç®—ä»ç‰¹å®šçš„èŠ‚ç‚¹ä¸Šå–å‡ºæŒ‡å®šæ•°é‡çš„å“ˆå¸Œæ§½ï¼Œé‚£ä¹ˆå¯ä»¥å‘redis-tribè¾“å…¥ allï¼Œè¿™æ ·çš„è¯ï¼Œ é›†ç¾¤ä¸­çš„æ‰€æœ‰ä¸»èŠ‚ç‚¹éƒ½ä¼šæˆä¸ºæºèŠ‚ç‚¹ï¼Œredis-tribä»å„ä¸ªæºèŠ‚ç‚¹ä¸­å„å–å‡ºä¸€éƒ¨åˆ†å“ˆå¸Œæ§½ï¼Œå‡‘å¤Ÿ4096ä¸ªï¼Œç„¶åç§»åŠ¨åˆ°9007èŠ‚ç‚¹ä¸Šï¼š éªŒè¯ï¼š [root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb check 192.168.56.127:9001 &gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001) M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001 slots:1280-5460 (4096 slots) master 1 additional replica(s) S: 5ed978b695e6a222e67d13c68e55f6c4e74b7ba6 192.168.56.127:9008 slots: (0 slots) slave replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72b M: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007 slots:0-1279,5461-6998,10923-12201 (4096 slots) master 1 additional replica(s) S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005 slots: (0 slots) slave replicates e070e76789352d2492cfc9800850e943e0c4b72d M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002 slots:6999-10922 (4096 slots) master 1 additional replica(s) M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003 slots:12202-16383 (4096 slots) master 1 additional replica(s) S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006 slots: (0 slots) slave replicates 0fcbaa301451baf87284546513003568e47b5daa S: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004 slots: (0 slots) slave replicates 474fd53f7199ad70cce7f18bd68f5445b559509a [OK] All nodes agree about slots configuration. &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered. ä»¥ä¸Šæˆ‘ä»¬çš„é›†ç¾¤æ­å»ºä»¥åŠæ–°å¢èŠ‚ç‚¹å°±å®Œæˆäº†ï¼› 6. ä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹:å’ŒèŠ‚ç‚¹æ·»åŠ ä¸€æ ·ï¼Œç§»é™¤èŠ‚ç‚¹ä¹Ÿæœ‰ç§»é™¤ä¸»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹ 1ã€ç§»é™¤ä¸»èŠ‚ç‚¹ç§»é™¤èŠ‚ç‚¹ä½¿ç”¨redis-tribçš„del-nodeå‘½ä»¤ /usr/local/redis-cluster/bin/redis-trib.rb del-node 192.168.56.127:9001 ${node-id} 192.168.56.127:9001å…¶ä¸­ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹ï¼Œnode-idä¸ºè¦åˆ é™¤çš„ä¸»èŠ‚ç‚¹,è¿™é‡Œå’Œæ·»åŠ èŠ‚ç‚¹ä¸åŒ,ç§»é™¤èŠ‚ç‚¹node-idæ˜¯å¿…éœ€çš„ï¼Œæµ‹è¯•åˆ é™¤9003ä¸»èŠ‚ç‚¹ [root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb del-node 192.168.56.127:9001 e070e76789352d2492cfc9800850e943e0c4b72d &gt;&gt;&gt; Removing node e070e76789352d2492cfc9800850e943e0c4b72d from cluster 192.168.56.127:9001 [ERR] Node 192.168.56.127:9003 is not empty! Reshard data away and try again. redis clusteræç¤º9003å·²ç»æœ‰æ•°æ®äº†ï¼Œä¸èƒ½å¤Ÿè¢«åˆ é™¤ï¼Œéœ€è¦å°†ä»–çš„æ•°æ®è½¬ç§»å‡ºå»ï¼Œä¹Ÿå°±æ˜¯å’Œæ–°å¢ä¸»èŠ‚ç‚¹ä¸€æ ·éœ€é‡æ–°åˆ†ç‰‡ã€‚ /usr/local/redis-cluster/bin/redis-trib.rb reshard 192.168.56.127:9001 æ‰§è¡Œä»¥åä¼šæç¤ºæˆ‘ä»¬ç§»é™¤çš„å¤§å°ï¼Œå› ä¸º9003å ç”¨äº†4096ä¸ªæ§½ç‚¹ &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered. How many slots do you want to move (from 1 to 16384)? è¾“å…¥4096æç¤ºç§»åŠ¨çš„node idï¼Œå¡«å†™9007çš„node idã€‚ &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered. How many slots do you want to move (from 1 to 16384)? 4182 What is the receiving node ID? 1714784542b3afc9e2a8b2c93fff49d095e7d72b éœ€è¦ç§»åŠ¨åˆ°å…¨éƒ¨ä¸»èŠ‚ç‚¹ä¸Šè¿˜æ˜¯å•ä¸ªä¸»èŠ‚ç‚¹ Please enter all the source node IDs. Type 'all' to use all the nodes as source nodes for the hash slots. Type 'done' once you entered all the source nodes IDs. Source node #1: å°†4096ä¸ªæ§½ç‚¹ç§»åŠ¨åˆ°9007ä¸Šï¼Œå¡«å†™9003çš„node id ï¼še070e76789352d2492cfc9800850e943e0c4b72d Source node #1:e070e76789352d2492cfc9800850e943e0c4b72d Source node #2:done ç¡®è®¤ä¹‹åä¼šä¸€ä¸ªä¸€ä¸ªå°†9003çš„å¡æ§½ç§»åˆ°åˆ°9007ä¸Šã€‚ [root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb check 192.168.56.127:9001 &gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001) M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001 slots:1280-5460 (4096 slots) master 1 additional replica(s) S: 5ed978b695e6a222e67d13c68e55f6c4e74b7ba6 192.168.56.127:9008 slots: (0 slots) slave replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72b M: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007 slots:0-1279,5461-6998,10923-16383 (8192 slots) master 2 additional replica(s) S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005 slots: (0 slots) slave replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72b M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002 slots:6999-10922 (4096 slots) master 1 additional replica(s) M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003 slots: (0 slots) master 0 additional replica(s) S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006 slots: (0 slots) slave replicates 0fcbaa301451baf87284546513003568e47b5daa S: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004 slots: (0 slots) slave replicates 474fd53f7199ad70cce7f18bd68f5445b559509a [OK] All nodes agree about slots configuration. &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered. ä»¥ä¸Šæˆ‘ä»¬å°†å®ä¾‹9003çš„å“ˆå¸Œæ§½å…¨éƒ¨è½¬ç§»åˆ°äº†9007ï¼Œå·²ç»ä¸º0 ,æ­¤æ—¶å†æ¥åˆ é™¤æˆ‘ä»¬çš„èŠ‚ç‚¹å°±è¡Œäº†~ [root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb del-node 192.168.56.127:9001 e070e76789352d2492cfc9800850e943e0c4b72d &gt;&gt;&gt; Removing node e070e76789352d2492cfc9800850e943e0c4b72d from cluster 192.168.56.127:9001 &gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster... &gt;&gt;&gt; SHUTDOWN the node. # çœ‹ä¸‹é¢ç»“æœ æ‰§è¡Œå®Œdel-node 9003èŠ‚ç‚¹å°±å·²ç»ä»é›†ç¾¤ä¸­å‰”é™¤å•¦~ğŸ˜ &gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001) M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001 slots:1280-5460 (4096 slots) master 1 additional replica(s) S: 5ed978b695e6a222e67d13c68e55f6c4e74b7ba6 192.168.56.127:9008 slots: (0 slots) slave replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72b M: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007 slots:0-1279,5461-6998,10923-16383 (8192 slots) master 2 additional replica(s) S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005 slots: (0 slots) slave replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72b M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002 slots:6999-10922 (4096 slots) master 1 additional replica(s) S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006 slots: (0 slots) slave replicates 0fcbaa301451baf87284546513003568e47b5daa S: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004 slots: (0 slots) slave replicates 474fd53f7199ad70cce7f18bd68f5445b559509a [OK] All nodes agree about slots configuration. &gt;&gt;&gt; Check for open slots... &gt;&gt;&gt; Check slots coverage... [OK] All 16384 slots covered. æœ€åå½“ç„¶æˆ‘ä»¬é›†ç¾¤æ­å»ºå·²ç»å®Œæˆï¼Œé‚£é›†ç¾¤çš„ä½œç”¨æ˜¯ä¸ºäº†è§£å†³åˆ†ç‰‡çš„é—®é¢˜ï¼Œå¦‚æœéœ€è¦æ­å»ºé«˜å¯ç”¨é›†ç¾¤ï¼›ä¹Ÿå°±æ˜¯ä¸»çš„å¤±è´¥åä»çš„èƒ½å¤Ÿåˆ‡æ¢è§’è‰²,æ‰€ä»¥å¯ä»¥ä½¿ç”¨å“¨å…µæœºåˆ¶æ¥è§£å†³HA.sentinelå’Œclusterä¸»è¦åŒºåˆ«ï¼Œsentinelç”¨æ¥è§£å†³HAï¼ˆé«˜å¯ç”¨ï¼‰é—®é¢˜ï¼Œè€Œclusterä¸»è¦è§£å†³shardingï¼ˆåˆ†ç‰‡ï¼‰é—®é¢˜ã€‚ä¸¤ä¸ªç»å¸¸ç»“åˆä½¿ç”¨æ­å»ºé«˜å¯ç”¨é›†ç¾¤ã€‚ å…³äºå“ˆå¸Œæ§½çš„æ¦‚å¿µï¼šRedis é›†ç¾¤ä¸­å†…ç½®äº† 16384 ä¸ªå“ˆå¸Œæ§½ï¼Œå½“éœ€è¦åœ¨ Redis é›†ç¾¤ä¸­æ”¾ç½®ä¸€ä¸ª key-valueæ—¶ï¼Œredis å…ˆå¯¹ key ä½¿ç”¨ crc16 ç®—æ³•ç®—å‡ºä¸€ä¸ªç»“æœï¼Œç„¶åæŠŠç»“æœå¯¹ 16384 æ±‚ä½™æ•°ï¼Œè¿™æ ·æ¯ä¸ª key éƒ½ä¼šå¯¹åº”ä¸€ä¸ªç¼–å·åœ¨ 0-16383 ä¹‹é—´çš„å“ˆå¸Œæ§½ï¼Œredis ä¼šæ ¹æ®èŠ‚ç‚¹æ•°é‡å¤§è‡´å‡ç­‰çš„å°†å“ˆå¸Œæ§½æ˜ å°„åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚ Redis é›†ç¾¤æ²¡æœ‰ä½¿ç”¨ä¸€è‡´æ€§hash, è€Œæ˜¯å¼•å…¥äº†å“ˆå¸Œæ§½çš„æ¦‚å¿µã€‚ Redis é›†ç¾¤æœ‰16384ä¸ªå“ˆå¸Œæ§½,æ¯ä¸ªkeyé€šè¿‡CRC16æ ¡éªŒåå¯¹16384å–æ¨¡æ¥å†³å®šæ”¾ç½®å“ªä¸ªæ§½.é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†hashæ§½ã€‚è¿™ç§ç»“æ„å¾ˆå®¹æ˜“æ·»åŠ æˆ–è€…åˆ é™¤èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ— è®ºæ˜¯æ·»åŠ åˆ é™¤æˆ–è€…ä¿®æ”¹æŸä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½ä¸ä¼šé€ æˆé›†ç¾¤ä¸å¯ç”¨çš„çŠ¶æ€ã€‚ ä½¿ç”¨å“ˆå¸Œæ§½çš„å¥½å¤„å°±åœ¨äºå¯ä»¥æ–¹ä¾¿çš„æ·»åŠ æˆ–ç§»é™¤èŠ‚ç‚¹ã€‚ å½“éœ€è¦å¢åŠ èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦æŠŠå…¶ä»–èŠ‚ç‚¹çš„æŸäº›å“ˆå¸Œæ§½æŒªåˆ°æ–°èŠ‚ç‚¹å°±å¯ä»¥äº†ï¼› å½“éœ€è¦ç§»é™¤èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦æŠŠç§»é™¤èŠ‚ç‚¹ä¸Šçš„å“ˆå¸Œæ§½æŒªåˆ°å…¶ä»–èŠ‚ç‚¹å°±è¡Œäº†ï¼› åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬ä»¥åæ–°å¢æˆ–ç§»é™¤èŠ‚ç‚¹çš„æ—¶å€™ä¸ç”¨å…ˆåœæ‰æ‰€æœ‰çš„ redis æœåŠ¡ã€‚ â€œç”¨äº†å“ˆå¸Œæ§½çš„æ¦‚å¿µï¼Œè€Œæ²¡æœ‰ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œä¸éƒ½æ˜¯å“ˆå¸Œä¹ˆï¼Ÿè¿™æ ·åšçš„åŸå› æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿâ€Redis Clusteræ˜¯è‡ªå·±åšçš„crc16çš„ç®€å•hashç®—æ³•ï¼Œæ²¡æœ‰ç”¨ä¸€è‡´æ€§hashã€‚Redisçš„ä½œè€…è®¤ä¸ºå®ƒçš„crc16(key) mod 16384çš„æ•ˆæœå·²ç»ä¸é”™äº†ï¼Œè™½ç„¶æ²¡æœ‰ä¸€è‡´æ€§hashçµæ´»ï¼Œä½†å®ç°å¾ˆç®€å•ï¼ŒèŠ‚ç‚¹å¢åˆ æ—¶å¤„ç†èµ·æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚ â€œä¸ºäº†åŠ¨æ€å¢åˆ èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¸è‡³äºä¸¢å¤±æ•°æ®ä¹ˆï¼Ÿâ€èŠ‚ç‚¹å¢åˆ æ—¶ä¸ä¸¢å¤±æ•°æ®å’Œhashç®—æ³•æ²¡ä»€ä¹ˆå…³ç³»ï¼Œä¸ä¸¢å¤±æ•°æ®è¦æ±‚çš„æ˜¯ä¸€ä»½æ•°æ®æœ‰å¤šä¸ªå‰¯æœ¬ã€‚ â€œè¿˜æœ‰é›†ç¾¤æ€»å…±æœ‰2çš„14æ¬¡æ–¹ï¼Œ16384ä¸ªå“ˆå¸Œæ§½ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªå“ˆå¸Œæ§½ä¸­å­˜çš„key å’Œ valueæ˜¯ä»€ä¹ˆï¼Ÿâ€å½“ä½ å¾€Redis Clusterä¸­åŠ å…¥ä¸€ä¸ªKeyæ—¶ï¼Œä¼šæ ¹æ®crc16(key) mod 16384è®¡ç®—è¿™ä¸ªkeyåº”è¯¥åˆ†å¸ƒåˆ°å“ªä¸ªhash slotä¸­ï¼Œä¸€ä¸ªhash slotä¸­ä¼šæœ‰å¾ˆå¤škeyå’Œvalueã€‚ä½ å¯ä»¥ç†è§£æˆè¡¨çš„åˆ†åŒºï¼Œä½¿ç”¨å•èŠ‚ç‚¹æ—¶çš„redisæ—¶åªæœ‰ä¸€ä¸ªè¡¨ï¼Œæ‰€æœ‰çš„keyéƒ½æ”¾åœ¨è¿™ä¸ªè¡¨é‡Œï¼›æ”¹ç”¨Redis Clusterä»¥åä¼šè‡ªåŠ¨ä¸ºä½ ç”Ÿæˆ16384ä¸ªåˆ†åŒºè¡¨ï¼Œä½ insertæ•°æ®æ—¶ä¼šæ ¹æ®ä¸Šé¢çš„ç®€å•ç®—æ³•æ¥å†³å®šä½ çš„keyåº”è¯¥å­˜åœ¨å“ªä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºé‡Œæœ‰å¾ˆå¤škeyã€‚","categories":[{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","permalink":"https://blog.sctux.cc/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"}],"tags":[{"name":"redis-cluster","slug":"redis-cluster","permalink":"https://blog.sctux.cc/tags/redis-cluster/"}],"keywords":[{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","permalink":"https://blog.sctux.cc/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"}]},{"title":"è“é²¸å¹³å°å®è·µåŠåº”ç”¨...","slug":"lan-jing-ping-tai-shi-jian-ji-ying-yong-2","date":"2017-05-30T23:15:49.000Z","updated":"2025-09-01T01:59:08.871Z","comments":true,"path":"2017/05/31/lan-jing-ping-tai-shi-jian-ji-ying-yong-2/","permalink":"https://blog.sctux.cc/2017/05/31/lan-jing-ping-tai-shi-jian-ji-ying-yong-2/","excerpt":"å‰è¨€:åœ¨ä»Šå¹´ä¸‰æœˆä»½è“é²¸æ¨å‡ºäº†ä¸€å¥—å…è´¹çš„è“é²¸DevOpsæŠ€èƒ½åŸ¹è®­ï¼Œå€ŸåŠ©è“é²¸å¹³å°è‡´åŠ›äºè®©æ¯ä¸ªè¿ç»´å±Œä¸éƒ½å…·å¤‡ä¸€å®šçš„å¼€å‘èƒ½åŠ›ï¼›æœ‰å¹¸åœ¨æ­¤æ¬¡åŸ¹è®­è¯¾ç¨‹åšæŒäº†ä¸‹æ¥ï¼Œä¹Ÿæ”¶è·äº†å…³äºè…¾è®¯è“é²¸è¿ç»´çš„ä¸€äº›ç†å¿µã€æ€ç»´ï¼›åŒæ—¶è‡ªå·±çš„å·¥ä½œæ–¹å¼ã€å­¦ä¹ æ–¹å¼ä¹Ÿæœ‰äº†ä¸€å®šçš„æå‡ã€æ”¹å˜ï¼›å†æ­¤æ„Ÿè°¢å„ä½å¯¼å¸ˆçš„å­œå­œä¸å€¦çš„æ•™æˆâ€”â€“æˆäººä»¥é±¼ä¸å¦‚æˆäººä»¥æ¸”ã€‚ ä¸€ã€å¦‚ä½•å­¦ä¹ å®ƒï¼Ÿ LinuxåŸºç¡€(å¿…å¤‡)ï¼› éœ€è¦æœ‰ä¸€å®šçš„PythonåŸºç¡€çŸ¥è¯†ï¼› å‰ç«¯æ–¹é¢ä¹Ÿéœ€è¦å¤šå†™ï¼› å­¦ä¹ èƒ½åŠ› + å­¦ä¹ æ–¹æ³•ï¼› äºŒã€å­¦ä¹ é€”å¾„ï¼šé“¾æ¥: è“é²¸DevOpsæŠ€èƒ½åŸ¹è®­ ä¸‰ã€æˆ‘çš„å­¦ä¹ è®°å½•:","text":"å‰è¨€:åœ¨ä»Šå¹´ä¸‰æœˆä»½è“é²¸æ¨å‡ºäº†ä¸€å¥—å…è´¹çš„è“é²¸DevOpsæŠ€èƒ½åŸ¹è®­ï¼Œå€ŸåŠ©è“é²¸å¹³å°è‡´åŠ›äºè®©æ¯ä¸ªè¿ç»´å±Œä¸éƒ½å…·å¤‡ä¸€å®šçš„å¼€å‘èƒ½åŠ›ï¼›æœ‰å¹¸åœ¨æ­¤æ¬¡åŸ¹è®­è¯¾ç¨‹åšæŒäº†ä¸‹æ¥ï¼Œä¹Ÿæ”¶è·äº†å…³äºè…¾è®¯è“é²¸è¿ç»´çš„ä¸€äº›ç†å¿µã€æ€ç»´ï¼›åŒæ—¶è‡ªå·±çš„å·¥ä½œæ–¹å¼ã€å­¦ä¹ æ–¹å¼ä¹Ÿæœ‰äº†ä¸€å®šçš„æå‡ã€æ”¹å˜ï¼›å†æ­¤æ„Ÿè°¢å„ä½å¯¼å¸ˆçš„å­œå­œä¸å€¦çš„æ•™æˆâ€”â€“æˆäººä»¥é±¼ä¸å¦‚æˆäººä»¥æ¸”ã€‚ ä¸€ã€å¦‚ä½•å­¦ä¹ å®ƒï¼Ÿ LinuxåŸºç¡€(å¿…å¤‡)ï¼› éœ€è¦æœ‰ä¸€å®šçš„PythonåŸºç¡€çŸ¥è¯†ï¼› å‰ç«¯æ–¹é¢ä¹Ÿéœ€è¦å¤šå†™ï¼› å­¦ä¹ èƒ½åŠ› + å­¦ä¹ æ–¹æ³•ï¼› äºŒã€å­¦ä¹ é€”å¾„ï¼šé“¾æ¥: è“é²¸DevOpsæŠ€èƒ½åŸ¹è®­ ä¸‰ã€æˆ‘çš„å­¦ä¹ è®°å½•:é“¾æ¥: ä½œä¸šè®°å½• å››ã€ç›®å‰å­¦ä¹ æˆæœ: è“é²¸paaså¹³å°é¡µé¢æˆªå›¾: è“é²¸å¼€å‘è€…ä¸­å¿ƒ: ï¿¼ è‡ªä¸»å¼€å‘Appæƒé™æ§åˆ¶å¹³å°: ï¿¼ è‡ªä¸»å¼€å‘è¿ç»´ç®¡æ§å¹³å°: ï¿¼ äº”ã€å°ç»“:ä¸Šé¢çš„ä¸¤ä¸ªåº”ç”¨å·²ç»åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒ;å…¶ä»–å„ä¸ªéƒ¨é—¨çš„å¹³å°å¼€å‘ing;ç°åœ¨å°ä¼™ä¼´å„¿ä»¬å¦‚æœå»å­¦ä¹ çš„è¯ï¼›åº”è¯¥éå¸¸çš„é¡ºåˆ©ï¼Œæ¯•ç«Ÿå‘å·®ä¸å¤šéƒ½è¢«å¡«å®Œäº†ã€‚ä¸æƒ³è¯´å¤ªå¤šï¼›æ­¤ç¯‡åšæ–‡è®°å½•ä¸€ä¸‹è¿™ä¸‰ä¸ªæœˆä»¥æ¥çš„ä¸€äº›æ”¶è·å§;ï¿¼ ä½ çš„å¯¹æ‰‹åœ¨çœ‹ä¹¦ï¼Œä½ çš„ä»‡äººåœ¨ç£¨åˆ€ï¼Œä½ çš„é—ºå¯†åœ¨å‡è‚¥ï¼Œéš”å£è€ç‹åœ¨ç»ƒè…°ï¼Œæˆ‘ä»¬å¿…é¡»ä¸æ–­å­¦ä¹ ï¼Œæ‰èƒ½è®©è‡ªå·±å˜å¾—æ›´å¼ºã€‚","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"ç³»ç»Ÿè¿ç»´","slug":"ç³»ç»Ÿè¿ç»´","permalink":"https://blog.sctux.cc/tags/%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4/"}],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"How to Use Mojo/webqq Send QQ Message","slug":"how-to-use-mojowebqq-send-qq-message","date":"2017-04-06T07:13:02.000Z","updated":"2025-09-01T01:59:08.959Z","comments":true,"path":"2017/04/06/how-to-use-mojowebqq-send-qq-message/","permalink":"https://blog.sctux.cc/2017/04/06/how-to-use-mojowebqq-send-qq-message/","excerpt":"1. get docker imagesdocker pull sjdy521/mojo-webqq 2. run itdocker run -d -p 9999:5000 -v /tmp/:/tmp/ sjdy521/mojo-webqq 3. check logsdocker logs -f CONTAINER_ID [17/04/07 15:57:13] [info] å½“å‰æ­£åœ¨ä½¿ç”¨ Mojo-Webqq v2.0.8 [17/04/07 15:57:13] [warn] å½“å‰ç‰ˆæœ¬ä¸1.x.xç‰ˆæœ¬ä¸å…¼å®¹ï¼Œæ”¹åŠ¨è¯¦æƒ…å‚è§æ›´æ–°æ—¥å¿— [17/04/07 15:57:13] [info] æ‰§è¡Œæ’ä»¶[ Mojo::Webqq::Plugin::UploadQRcode ] [17/04/07 15:57:13] [info] æ‰§è¡Œæ’ä»¶[ Mojo::Webqq::Plugin::ShowMsg ] [17/04/07 15:57:13] [info] æ‰§è¡Œæ’ä»¶[ Mojo::Webqq::Plugin::Openqq ] [17/04/07 15:57:13] [info] Listening at \"http://0.0.0.0:5000\" Server available at http://0.0.0.0:5000 [17/04/07 15:57:13] [info] åˆå§‹åŒ– smartqq å®¢æˆ·ç«¯å‚æ•°... [17/04/07 15:57:13] [info] æ­£åœ¨è·å–ç™»å½•äºŒç»´ç ... [17/04/07 15:57:13] [info] äºŒç»´ç å·²ä¸‹è½½åˆ°æœ¬åœ°[ /tmp/mojo_webqq_qrcode_default.png ] [17/04/07 15:57:15] [info] äºŒç»´ç å·²ä¸Šä¼ äº‘å­˜å‚¨[ https://ooo.0o0.ooo/2017/04/07/58e7465b89582.png ] [17/04/07 15:57:15] [info] ç­‰å¾…æ‰‹æœºQQæ‰«æäºŒç»´ç ... [17/04/07 15:58:01] [info] æ‰‹æœºQQæ‰«ç æˆåŠŸï¼Œè¯·åœ¨æ‰‹æœºä¸Šç‚¹å‡»[å…è®¸ç™»å½•smartQQ]æŒ‰é’®... [17/04/07 15:59:11] [info] æ£€æŸ¥å®‰å…¨ä»£ç ... [17/04/07 15:59:11] [info] è·å–æ•°æ®éªŒè¯å‚æ•°... [17/04/07 15:59:11] [info] å°è¯•è¿›è¡Œç™»å½•(2)... [17/04/07 15:59:12] [info] å¸å·(xxxxxxxxxxxxx)ç™»å½•æˆåŠŸ 4. scan qrcode/tmp/mojo_webqq_qrcode_default.png 5. sendmessage:curl \"http://YOUR_SERVER_IP:9999/openqq/send_friend_message?uid=friends_qq_num&amp;content=hello\" curl \"http://YOUR_SERVER_IP:9999/openqq/send_group_message?uid=group_qq_number&amp;content=hehe\"","text":"1. get docker imagesdocker pull sjdy521/mojo-webqq 2. run itdocker run -d -p 9999:5000 -v /tmp/:/tmp/ sjdy521/mojo-webqq 3. check logsdocker logs -f CONTAINER_ID [17/04/07 15:57:13] [info] å½“å‰æ­£åœ¨ä½¿ç”¨ Mojo-Webqq v2.0.8 [17/04/07 15:57:13] [warn] å½“å‰ç‰ˆæœ¬ä¸1.x.xç‰ˆæœ¬ä¸å…¼å®¹ï¼Œæ”¹åŠ¨è¯¦æƒ…å‚è§æ›´æ–°æ—¥å¿— [17/04/07 15:57:13] [info] æ‰§è¡Œæ’ä»¶[ Mojo::Webqq::Plugin::UploadQRcode ] [17/04/07 15:57:13] [info] æ‰§è¡Œæ’ä»¶[ Mojo::Webqq::Plugin::ShowMsg ] [17/04/07 15:57:13] [info] æ‰§è¡Œæ’ä»¶[ Mojo::Webqq::Plugin::Openqq ] [17/04/07 15:57:13] [info] Listening at \"http://0.0.0.0:5000\" Server available at http://0.0.0.0:5000 [17/04/07 15:57:13] [info] åˆå§‹åŒ– smartqq å®¢æˆ·ç«¯å‚æ•°... [17/04/07 15:57:13] [info] æ­£åœ¨è·å–ç™»å½•äºŒç»´ç ... [17/04/07 15:57:13] [info] äºŒç»´ç å·²ä¸‹è½½åˆ°æœ¬åœ°[ /tmp/mojo_webqq_qrcode_default.png ] [17/04/07 15:57:15] [info] äºŒç»´ç å·²ä¸Šä¼ äº‘å­˜å‚¨[ https://ooo.0o0.ooo/2017/04/07/58e7465b89582.png ] [17/04/07 15:57:15] [info] ç­‰å¾…æ‰‹æœºQQæ‰«æäºŒç»´ç ... [17/04/07 15:58:01] [info] æ‰‹æœºQQæ‰«ç æˆåŠŸï¼Œè¯·åœ¨æ‰‹æœºä¸Šç‚¹å‡»[å…è®¸ç™»å½•smartQQ]æŒ‰é’®... [17/04/07 15:59:11] [info] æ£€æŸ¥å®‰å…¨ä»£ç ... [17/04/07 15:59:11] [info] è·å–æ•°æ®éªŒè¯å‚æ•°... [17/04/07 15:59:11] [info] å°è¯•è¿›è¡Œç™»å½•(2)... [17/04/07 15:59:12] [info] å¸å·(xxxxxxxxxxxxx)ç™»å½•æˆåŠŸ 4. scan qrcode/tmp/mojo_webqq_qrcode_default.png 5. sendmessage:curl \"http://YOUR_SERVER_IP:9999/openqq/send_friend_message?uid=friends_qq_num&amp;content=hello\" curl \"http://YOUR_SERVER_IP:9999/openqq/send_group_message?uid=group_qq_number&amp;content=hehe\" 6. other system use:def send_message(number, content): url = \"http://YOUR_SERVER_IP:9999/openqq/send_friend_message\" data = { \"uid\": number, \"content\": content, } requests.get(url=url,data=data) if __name__ == \"__main__\": send_message('2399447849','hello')","categories":[{"name":"Monitor","slug":"Monitor","permalink":"https://blog.sctux.cc/categories/Monitor/"}],"tags":[],"keywords":[{"name":"Monitor","slug":"Monitor","permalink":"https://blog.sctux.cc/categories/Monitor/"}]},{"title":"How to Install Gateone(WebSSH)","slug":"how-to-install-gateonewebssh","date":"2017-02-21T15:23:54.000Z","updated":"2025-09-01T01:59:08.959Z","comments":true,"path":"2017/02/21/how-to-install-gateonewebssh/","permalink":"https://blog.sctux.cc/2017/02/21/how-to-install-gateonewebssh/","excerpt":"1.Install dependent package(CentOS7)yum install python-pip 2.Get install source codegit clone https://github.com/liftoff/GateOne.git cd GateOne/ python setup.py install 3. Start this service will Generate the configuration file(/etc/gateone/*)/etc/gateone # GateOne's default install dir service gateone start 4. You will see some messages flash by, wait untill you see something like:GateOne will by default run on 443(https), and will allow access only from the hostname that it autodetects, so make sure that whaterver URL you normally access, this server through is listed in GateOneâ€™s orgin list:Listening on https://*:443/ vim /etc/gateone/conf.d/10server.conf 5.Now run:/etc/init.d/gateone start or service gateone start","text":"1.Install dependent package(CentOS7)yum install python-pip 2.Get install source codegit clone https://github.com/liftoff/GateOne.git cd GateOne/ python setup.py install 3. Start this service will Generate the configuration file(/etc/gateone/*)/etc/gateone # GateOne's default install dir service gateone start 4. You will see some messages flash by, wait untill you see something like:GateOne will by default run on 443(https), and will allow access only from the hostname that it autodetects, so make sure that whaterver URL you normally access, this server through is listed in GateOneâ€™s orgin list:Listening on https://*:443/ vim /etc/gateone/conf.d/10server.conf 5.Now run:/etc/init.d/gateone start or service gateone start 6.Access Webssh:https://YOUR_SERVER_IP like this:ï¿¼ Sure ,the GateOne has Docker Version, you can:docker pull gateone docker run -d --name=gateone -p 443:8000 liftoff/gateone or git clone https://github.com/liftoff/GateOne.git cd GateOne/docker docker build -t gateone .","categories":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}],"tags":[{"name":"ç³»ç»Ÿè¿ç»´","slug":"ç³»ç»Ÿè¿ç»´","permalink":"https://blog.sctux.cc/tags/%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4/"}],"keywords":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}]},{"title":"\"Devops\" Demo(å¦‚æœæ–‡ä¸­å›¾ç‰‡æ˜¾ç¤ºä¸å®Œæ•´ï¼Œè¯·å¤šæ¬¡åˆ·æ–°)","slug":"devops-demo","date":"2016-12-15T23:45:49.000Z","updated":"2025-09-01T01:59:08.981Z","comments":true,"path":"2016/12/16/devops-demo/","permalink":"https://blog.sctux.cc/2016/12/16/devops-demo/","excerpt":"ä»Šå¹´æ–­æ–­ç»­ç»­åœ¨å·¥ä½œä¹‹ä½™å­¦ä¹ äº†ä¸€ä¸‹ Python Webæ¡†æ¶,ä¸‹é¢ç®€è¦è¯´ä¸‹å­¦çš„ä¸œè¥¿ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š Flask(åŒ…æ‹¬å„ä¸ªå­ç³»ç»Ÿç»„ä»¶) + Bootstrapä¸»è¦æ˜¯ç¬¬ä¸€ä¸ªæ¥è§¦çš„å°±æ˜¯Flaskè¿™ä¸ªæ¡†æ¶,æœŸåˆç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯å¼€å‘èµ·æ¥éå¸¸çš„å¿«æ·ã€æ–¹ä¾¿,å„ä¸ªå­ç³»ç»Ÿä¹Ÿæœ‰å•ç‹¬çš„å­¦ä¹ èµ„æ–™,æ‰€ä»¥ä»ä¸€å¼€å§‹æˆ‘ä¹Ÿå°±ä¸€ç›´æ–­æ–­ç»­ç»­çš„åœ¨æŠ˜è…¾ï¼›Bootstrap DiaoBaoäº†. SaltStack API(netapi/rest_cherrypy)è¿™ä¸ªå°±ä¸ç”¨è¯´äº†å§ï¼Œè¿ç»´äººéƒ½çŸ¥é“ï¼›åœ¨æŒæ¡äº†SaltStackåœ¨å‘½ä»¤è¡Œçš„ç”¨æ³•ä¹‹åå°±éœ€è¦å»å­¦ä¹ ã€æ¢ç´¢æ›´å¤šæ›´ä¾¿åˆ©çš„æ–¹æ³•æ¥å®ç°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼› Zabbix APIç›‘æ§åˆ©å™¨ zabbix, æ›´ä¸ç”¨è¯´äº†ã€‚ç”±äºå·¥ä½œä¸Šçš„æ‰€éœ€,å¢å‡æœåŠ¡å™¨æ˜¯å¸¸æœ‰çš„äº‹,é‚£æ€ä¹ˆå¿«é€Ÿçš„å»æ·»åŠ /åˆ é™¤ä¸»æœºå‘¢,å½“ç„¶å°±è¦è®©æ¥å£å¸®å¿™å»å¤„ç†å•¦ï¼› ä¸‹é¢æ˜¯demoçš„é›å½¢ï¼šç™»å½•ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Flaskè‡ªå¸¦çš„Flask-Loginç»„ä»¶ï¼ŒéªŒè¯ç ç”¨çš„æ˜¯Googleçš„ReCAPTCHA,å½“ç„¶è¿™ä¸ªåœ¨Flaskè¡¨å•ä¸­å·²ç»é›†æˆäº†ï¼› ï¿¼ SaltStack å‘½ä»¤æ‰§è¡Œ,è°ƒç”¨çš„æ˜¯SaltApi,è¿™é‡Œéœ€è¦æ‰‹åŠ¨å¡«å†™ä¸»æœºå,æ˜¯ä¸ªéœ€è¦ä¼˜åŒ–çš„åœ°æ–¹.ï¿¼ï¿¼ å½“ç„¶æœ‰äº†è¿™ä¸ªæ‰§è¡Œå‘½ä»¤,å“¥å­å°±è¦åšåäº‹äº†,è¿™æ€ä¹ˆè¡Œ!é‚£å°±æŠŠä¸€äº›å±é™©çš„å‘½ä»¤æ·»åŠ åˆ°block_listå½“ä¸­,é¿å…è¯¯æ“ä½œ.ï¿¼ (âŠ™oâŠ™)â€¦ è¿™ä¸ªåšçš„ä¸æ˜¯å¤ªç¾è§‚ï¼›æ•°æ®æ˜¯ä»æ•°æ®åº“æŸ¥è¯¢å‡ºæ¥çš„;è€Œè¿™äº›æœåŠ¡å™¨çš„â€é™æ€â€æ•°æ®éƒ½æ˜¯é€šè¿‡SaltStackçš„grainsè·å–åˆ°çš„,çœ‹åˆ°æ—è¾¹é‚£ä¸ªColletæŒ‰é’®äº†ä¹ˆ;é‚£ä¸ªçš„åŠŸèƒ½å°±æ˜¯ä¸€é”®è·å–å„ä¸ªminionçš„grainsç„¶åå¯¼å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œæ¯å½“æœ‰æ–°çš„minionåŠ å…¥æ—¶åªè¦åœ¨æ­¤ç‚¹å‡»Collet Saltå°±ä¼šé©¬ä¸åœè¹„çš„åˆ°æ–°minionç«¯æ‹‰å–ç›¸å…³ä¿¡æ¯,ç„¶åå†™å…¥æ•°æ®åº“, åˆ é™¤æŒ‰é’®çš„ä½œç”¨æ˜¯ä»æ•°æ®åº“å½“ä¸­åˆ é™¤æ­¤æ¡è®°å½•.ï¿¼","text":"ä»Šå¹´æ–­æ–­ç»­ç»­åœ¨å·¥ä½œä¹‹ä½™å­¦ä¹ äº†ä¸€ä¸‹ Python Webæ¡†æ¶,ä¸‹é¢ç®€è¦è¯´ä¸‹å­¦çš„ä¸œè¥¿ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š Flask(åŒ…æ‹¬å„ä¸ªå­ç³»ç»Ÿç»„ä»¶) + Bootstrapä¸»è¦æ˜¯ç¬¬ä¸€ä¸ªæ¥è§¦çš„å°±æ˜¯Flaskè¿™ä¸ªæ¡†æ¶,æœŸåˆç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯å¼€å‘èµ·æ¥éå¸¸çš„å¿«æ·ã€æ–¹ä¾¿,å„ä¸ªå­ç³»ç»Ÿä¹Ÿæœ‰å•ç‹¬çš„å­¦ä¹ èµ„æ–™,æ‰€ä»¥ä»ä¸€å¼€å§‹æˆ‘ä¹Ÿå°±ä¸€ç›´æ–­æ–­ç»­ç»­çš„åœ¨æŠ˜è…¾ï¼›Bootstrap DiaoBaoäº†. SaltStack API(netapi/rest_cherrypy)è¿™ä¸ªå°±ä¸ç”¨è¯´äº†å§ï¼Œè¿ç»´äººéƒ½çŸ¥é“ï¼›åœ¨æŒæ¡äº†SaltStackåœ¨å‘½ä»¤è¡Œçš„ç”¨æ³•ä¹‹åå°±éœ€è¦å»å­¦ä¹ ã€æ¢ç´¢æ›´å¤šæ›´ä¾¿åˆ©çš„æ–¹æ³•æ¥å®ç°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼› Zabbix APIç›‘æ§åˆ©å™¨ zabbix, æ›´ä¸ç”¨è¯´äº†ã€‚ç”±äºå·¥ä½œä¸Šçš„æ‰€éœ€,å¢å‡æœåŠ¡å™¨æ˜¯å¸¸æœ‰çš„äº‹,é‚£æ€ä¹ˆå¿«é€Ÿçš„å»æ·»åŠ /åˆ é™¤ä¸»æœºå‘¢,å½“ç„¶å°±è¦è®©æ¥å£å¸®å¿™å»å¤„ç†å•¦ï¼› ä¸‹é¢æ˜¯demoçš„é›å½¢ï¼šç™»å½•ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Flaskè‡ªå¸¦çš„Flask-Loginç»„ä»¶ï¼ŒéªŒè¯ç ç”¨çš„æ˜¯Googleçš„ReCAPTCHA,å½“ç„¶è¿™ä¸ªåœ¨Flaskè¡¨å•ä¸­å·²ç»é›†æˆäº†ï¼› ï¿¼ SaltStack å‘½ä»¤æ‰§è¡Œ,è°ƒç”¨çš„æ˜¯SaltApi,è¿™é‡Œéœ€è¦æ‰‹åŠ¨å¡«å†™ä¸»æœºå,æ˜¯ä¸ªéœ€è¦ä¼˜åŒ–çš„åœ°æ–¹.ï¿¼ï¿¼ å½“ç„¶æœ‰äº†è¿™ä¸ªæ‰§è¡Œå‘½ä»¤,å“¥å­å°±è¦åšåäº‹äº†,è¿™æ€ä¹ˆè¡Œ!é‚£å°±æŠŠä¸€äº›å±é™©çš„å‘½ä»¤æ·»åŠ åˆ°block_listå½“ä¸­,é¿å…è¯¯æ“ä½œ.ï¿¼ (âŠ™oâŠ™)â€¦ è¿™ä¸ªåšçš„ä¸æ˜¯å¤ªç¾è§‚ï¼›æ•°æ®æ˜¯ä»æ•°æ®åº“æŸ¥è¯¢å‡ºæ¥çš„;è€Œè¿™äº›æœåŠ¡å™¨çš„â€é™æ€â€æ•°æ®éƒ½æ˜¯é€šè¿‡SaltStackçš„grainsè·å–åˆ°çš„,çœ‹åˆ°æ—è¾¹é‚£ä¸ªColletæŒ‰é’®äº†ä¹ˆ;é‚£ä¸ªçš„åŠŸèƒ½å°±æ˜¯ä¸€é”®è·å–å„ä¸ªminionçš„grainsç„¶åå¯¼å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œæ¯å½“æœ‰æ–°çš„minionåŠ å…¥æ—¶åªè¦åœ¨æ­¤ç‚¹å‡»Collet Saltå°±ä¼šé©¬ä¸åœè¹„çš„åˆ°æ–°minionç«¯æ‹‰å–ç›¸å…³ä¿¡æ¯,ç„¶åå†™å…¥æ•°æ®åº“, åˆ é™¤æŒ‰é’®çš„ä½œç”¨æ˜¯ä»æ•°æ®åº“å½“ä¸­åˆ é™¤æ­¤æ¡è®°å½•.ï¿¼ç‚¹å‡»ä¸Šå›¾çš„è¯¦ç»†å°±å¯ä»¥çœ‹åˆ°å…³äºè¿™å°ä¸»æœºçš„è¯¦ç»†çŠ¶æ€äº†,Statusè¿™ä¸ªæ˜¯å®æ—¶æŠ“å–çš„å½“å‰è¿™å°ä¸»æœºçš„å½“å‰çŠ¶æ€,è€Œä¸‹é¢çš„ä¸¤å¼ ç›‘æ§å›¾å½¢åˆ™æ˜¯è°ƒç”¨äº†Grafana.æœ¬æƒ³è‡ªå·±ç”»å›¾çš„,ä½†æ˜¯æ²¡å¤ªå¤šçš„æ—¶é—´å»ç ”ç©¶å‰ç«¯æ–¹é¢çš„ä¸œè¥¿,å†µä¸”å›¾å½¢åŒ–çš„ä¸œè¥¿ä¹Ÿè›®å¤šäº†,å°±æ¯”å¦‚zabbixé‡Œé¢çš„ç›‘æ§å›¾ä¸ç¾è§‚çš„è¯åŠ ä¸Šgrafanaæ¸²æŸ“ï¼›å†æ¬¡å°±æ˜¯ELKé‡Œé¢çš„å›¾å½¢,æœ¬æƒ³å»è°ƒç”¨ELK APIçš„,å‘ç°ç»“åˆåˆ°è¿™é‡Œä¹Ÿæ²¡å•¥åµç”¨,è¦çœ‹å›¾ç›´æ¥è®¿é—®Kibanaå°±è¡Œäº†ï¼›ï¿¼ ä¸‹é¢ä¸¤å¼ æ˜¯å…³äºZabbixAPIçš„æ“ä½œ,æ·»åŠ æœåŠ¡å™¨æ˜¯é€šè¿‡ä¸Šä¼ ä¸€ä¸ªå›ºå®šæ ¼å¼çš„.xlsæ ¼å¼æ–‡ä»¶,ç„¶åå°å»è§£ææ–‡ä»¶å†…å®¹,è°ƒç”¨APIè¿›è¡Œä¸»æœºçš„æ·»åŠ ,åˆ é™¤ä¸»æœºä¹ŸåŒæ ·è°ƒç”¨APIæ“ä½œå®ç°.ï¿¼ï¿¼ å·®ä¸å¤šå®ç°çš„å°±æ˜¯ä¸Šé¢è¿™äº›,å…¶ä»–åŠŸèƒ½è¿˜åœ¨ç»§ç»­å­¦ä¹ ã€ç ”ç©¶ä¸­â€¦æœ›å„è·¯å¤§ç¥å‹¿å–·,å¸Œæœ›èƒ½å¾—åˆ°å„ä½å¤§ç¥çš„å»ºè®®,è°¢è°¢ã€‚ï¿¼","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"Dockerä¹‹gitlab-Ce","slug":"docker-zhigitlabce","date":"2016-08-05T03:40:58.000Z","updated":"2025-09-01T01:59:08.983Z","comments":true,"path":"2016/08/05/docker-zhigitlabce/","permalink":"https://blog.sctux.cc/2016/08/05/docker-zhigitlabce/","excerpt":"1ã€docker pull gitlab-ce 2ã€mkdir -p /data/gitlab/{config,data,logs} 3ã€docker run --detach \\ -p 443:443 -p 80:80 -p 2222:22 \\ --name gitlab-ce \\ --restart=always \\ --volume /data/gitlab/config:/etc/gitlab \\ --volume /data/gitlab/logs:/var/log/gitlab \\ --volume /data/gitlab/data:/var/opt/gitlab \\ docker.io/gitlab/gitlab-ce æˆ–è€…çœç•¥ç¬¬ä¸€ä¸ªæ­¥éª¤ç›´æ¥åˆ›å»ºç›®å½•ï¼Œç„¶årunèµ·æ¥ï¼›docker run --detach -p 4433:443 -p 880:80 -p 2222:22 --name gitlab-ce --restart=always --volume /data/gitlab/config:/etc/gitlab --volume /data/gitlab/logs:/var/log/gitlab --volume /data/gitlab/data:/var/opt/gitlab docker.io/gitlab/gitlab-ce GitLab ä¿®æ”¹ä¸»æœºåä¸æ›´æ¢ IP é…ç½®vim /data/gitlab/config/gitlab.rb13 liens:æ·»åŠ ï¼š[å°†external_url = 'http://git.example.com'ä¿®æ”¹ä¸ºâ€™http://dockerå®¿ä¸»æœºIP/\\]267 lines:gitlab_rails[â€˜gitlab_shell_ssh_portâ€™] = 2222 #ä¿®æ”¹ä½¿ç”¨sshåè®®æ—¶çš„ç«¯å£2222","text":"1ã€docker pull gitlab-ce 2ã€mkdir -p /data/gitlab/{config,data,logs} 3ã€docker run --detach \\ -p 443:443 -p 80:80 -p 2222:22 \\ --name gitlab-ce \\ --restart=always \\ --volume /data/gitlab/config:/etc/gitlab \\ --volume /data/gitlab/logs:/var/log/gitlab \\ --volume /data/gitlab/data:/var/opt/gitlab \\ docker.io/gitlab/gitlab-ce æˆ–è€…çœç•¥ç¬¬ä¸€ä¸ªæ­¥éª¤ç›´æ¥åˆ›å»ºç›®å½•ï¼Œç„¶årunèµ·æ¥ï¼›docker run --detach -p 4433:443 -p 880:80 -p 2222:22 --name gitlab-ce --restart=always --volume /data/gitlab/config:/etc/gitlab --volume /data/gitlab/logs:/var/log/gitlab --volume /data/gitlab/data:/var/opt/gitlab docker.io/gitlab/gitlab-ce GitLab ä¿®æ”¹ä¸»æœºåä¸æ›´æ¢ IP é…ç½®vim /data/gitlab/config/gitlab.rb13 liens:æ·»åŠ ï¼š[å°†external_url = 'http://git.example.com'ä¿®æ”¹ä¸ºâ€™http://dockerå®¿ä¸»æœºIP/\\]267 lines:gitlab_rails[â€˜gitlab_shell_ssh_portâ€™] = 2222 #ä¿®æ”¹ä½¿ç”¨sshåè®®æ—¶çš„ç«¯å£2222 é‡è¯»é…ç½®:è¿›å…¥å®¹å™¨ï¼Œç„¶åæ‰§è¡Œgitlab-ctl reconfigure è®¿é—®ï¼šç”±äºsshä½¿ç”¨äº†é22æ ‡å‡†æ®µç«¯å£ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä½¿ç”¨è¿™æ ·è¿æ¥gitlabå³å¯.git clone ssh://git@192.168.1.89:2222/guomaoqiu/test.git","categories":[{"name":"Monitor","slug":"Monitor","permalink":"https://blog.sctux.cc/categories/Monitor/"}],"tags":[],"keywords":[{"name":"Monitor","slug":"Monitor","permalink":"https://blog.sctux.cc/categories/Monitor/"}]},{"title":"Flask+bootstrapå†™ç™»å½•é¡µé¢","slug":"flaskbootstrap-e5-86-99-e7-99-bb-e5-bd-95-e9-a1-b5-e9-9d-a2","date":"2016-07-14T14:57:56.000Z","updated":"2025-09-01T01:59:08.876Z","comments":true,"path":"2016/07/14/flaskbootstrap-e5-86-99-e7-99-bb-e5-bd-95-e9-a1-b5-e9-9d-a2/","permalink":"https://blog.sctux.cc/2016/07/14/flaskbootstrap-e5-86-99-e7-99-bb-e5-bd-95-e9-a1-b5-e9-9d-a2/","excerpt":"æœ€è¿‘æœ‰äº›éœ€æ±‚ã€æƒ³æ³•ï¼Œæ¯•ç«Ÿdevopsçš„é£è¿˜æ˜¯å¾ˆå¼ºçƒˆçš„å•Šï¼Œæ‰€ä»¥å°±è·Ÿé£å­¦å­¦devæ–¹é¢çš„ä¸œè¥¿ï¼› flaskæ˜¯ä¸€ä¸ªå¾ˆå°å·§å¾ˆæ–¹ä¾¿çš„webframeï¼Œå¬æœ‹å‹è¯´èµ·djangoéå¸¸çš„é‡ï¼Œäºæ˜¯æˆ‘å°±åœ¨è¿˜æœ‰ç‚¹pythonåŸºç¡€çš„èƒ½åŠ›ä¸‹é€‰æ‹©flaskå­¦å­¦ï¼›å‡†å¤‡ç”¨è¿™ä¸ªæ¡†æ¶å¼€å‘æ–°çš„å¹³å°ï¼Œé¦–å…ˆå°±è¦æœ‰ç”¨æˆ·ç™»å½•é¡µé¢ï¼Œç”¨flaskå¯ä»¥è¿™æ ·å®ç°ï¼š ä»£ç ç»“æ„ï¼š flaskyâ”œâ”€â”€ run.pyâ”œâ”€â”€ staticâ”‚&nbsp;&nbsp; â”œâ”€â”€ av1.jpgâ”‚&nbsp;&nbsp; â”œâ”€â”€ av2.jpgâ”‚&nbsp;&nbsp; â”œâ”€â”€ av3.jpgâ”‚&nbsp;&nbsp; â”œâ”€â”€ bootstrap.min.cssâ”‚&nbsp;&nbsp; â”œâ”€â”€ bootstrap.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ bootstrap-responsive.min.cssâ”‚&nbsp;&nbsp; â”œâ”€â”€ excanvas.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ fullcalendar.cssâ”‚&nbsp;&nbsp; â”œâ”€â”€ fullcalendar.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ glyphicons-halflings.pngâ”‚&nbsp;&nbsp; â”œâ”€â”€ GNU-Linux-Logo-Penguin-SVG.pngâ”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.flot.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.flot.resize.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.peity.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.ui.custom.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ logo.pngâ”‚&nbsp;&nbsp; â”œâ”€â”€ Tux.jpgâ”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.dashboard.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.grey.cssâ”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.login.cssâ”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.login.jsâ”‚&nbsp;&nbsp; â””â”€â”€ unicorn.main.cssâ””â”€â”€ templates â”œâ”€â”€ base.html â”œâ”€â”€ check.html â”œâ”€â”€ index.html â”œâ”€â”€ login.html â””â”€â”€ upload.html &nbsp; å‰ç«¯å°±ç”¨bootstrapå±•ç¤ºï¼Œlogin.html 12345678910111213141516171819202122232425262728293031323334353637383940{% extends \\\"base.html\\\" %}{% block title %} Dachen FTP {% endblock %}&lt;/style&gt;&lt;/head&gt;{% block body %} &lt;body&gt; &lt;div id=\"logo\"&gt; &lt;img src=\"{ {url_for('static',filename='GNU-Linux-Logo-Penguin-SVG.png')}}\" alt=\"\"&gt; &lt;/div&gt; &lt;div id=\"loginbox\"&gt; &lt;form id=\"loginform\" class=\"form-vertical\" action=\"\" method=\"post\"&gt; &lt;p&gt;Sing in to blog.sctux.com&lt;/p&gt; &lt;!--&lt;div class=\"control-group\"&gt; --&gt; &lt;div class=\"form-group\"&gt; &lt;div class=\"controls\"&gt; &lt;div class=\"input-prepend\"&gt; &lt;input name=\"username\" value=\"{ {request.form.username}}\" placeholder=\"Username\"&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;!\\-\\- &lt;div class=\"control-group\"&gt; --&gt; &lt;div class=\"form-group\"&gt; &lt;div class=\"controls\"&gt; &lt;div class=\"input-prepend\"&gt; &lt;input name=\"pass\" placeholder=\"Password \"&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=\"form-group\"&gt; &lt;div class=\"col-md-90 col-md-offset-12\"&gt; &lt;button type=\"submit\" class=\"btn btn-primary\"&gt;Sign in&lt;/button&gt; &lt;/div&gt; {% if error %} &lt;p&gt;&lt;font color=\"red\"&gt;{ { error }}&lt;/font&gt;&lt;/p&gt; {% endif %} &lt;/div&gt; &lt;/form&gt; {% endblock %}&lt;/body&gt; &nbsp; run.pyå†…å®¹ï¼š 12345678910111213141516171819202122232425262728293031323334\\# coding:utf-8from flask.ext.wtf import Formfrom flask import render\\_template, redirect, url\\_forapp = Flask(\\_\\_name\\_\\_)@app.route('/login',methods=\\['POST','GET'\\])def login(): error=False if request.method == 'POST': if request.form\\['username'\\] != 'user1' or request.form\\['pass'\\] != 'user1@1qaz': error=\"username or password error !\" else: return redirect(url_for('index')) return render_template('login.html',error=error)@app.route('/index')def index(): return render_template('index.html',result=result)@app.route('/upload',methods=\\['GET','POST'\\])def upload(): return render_template('upload.html')@app.route('/check',methods=\\['POST','GET'\\])def check(): return render_template('check.html')@app.route('/logout')def logout(): return redirect(url_for('login'))if \\_\\_name\\_\\_==\"\\_\\_main\\_\\_\": app.run(debug=True,host='xxxxxxxxx',port=4000) å¯åŠ¨ python run.py è®¿é—® http://xxxxxxxxx:4000/ ç™»å½•ä¸»é¡µçš„æ•ˆæœï¼š å¥½å•¦ï¼Œä¸€ä¸ªç®€å•çš„ç™»å½•é¡µé¢å°±å†™å¥½å•¦ï¼›flask å€¼å¾—ä½ æ‹¥æœ‰!","text":"æœ€è¿‘æœ‰äº›éœ€æ±‚ã€æƒ³æ³•ï¼Œæ¯•ç«Ÿdevopsçš„é£è¿˜æ˜¯å¾ˆå¼ºçƒˆçš„å•Šï¼Œæ‰€ä»¥å°±è·Ÿé£å­¦å­¦devæ–¹é¢çš„ä¸œè¥¿ï¼› flaskæ˜¯ä¸€ä¸ªå¾ˆå°å·§å¾ˆæ–¹ä¾¿çš„webframeï¼Œå¬æœ‹å‹è¯´èµ·djangoéå¸¸çš„é‡ï¼Œäºæ˜¯æˆ‘å°±åœ¨è¿˜æœ‰ç‚¹pythonåŸºç¡€çš„èƒ½åŠ›ä¸‹é€‰æ‹©flaskå­¦å­¦ï¼›å‡†å¤‡ç”¨è¿™ä¸ªæ¡†æ¶å¼€å‘æ–°çš„å¹³å°ï¼Œé¦–å…ˆå°±è¦æœ‰ç”¨æˆ·ç™»å½•é¡µé¢ï¼Œç”¨flaskå¯ä»¥è¿™æ ·å®ç°ï¼š ä»£ç ç»“æ„ï¼š flaskyâ”œâ”€â”€ run.pyâ”œâ”€â”€ staticâ”‚&nbsp;&nbsp; â”œâ”€â”€ av1.jpgâ”‚&nbsp;&nbsp; â”œâ”€â”€ av2.jpgâ”‚&nbsp;&nbsp; â”œâ”€â”€ av3.jpgâ”‚&nbsp;&nbsp; â”œâ”€â”€ bootstrap.min.cssâ”‚&nbsp;&nbsp; â”œâ”€â”€ bootstrap.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ bootstrap-responsive.min.cssâ”‚&nbsp;&nbsp; â”œâ”€â”€ excanvas.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ fullcalendar.cssâ”‚&nbsp;&nbsp; â”œâ”€â”€ fullcalendar.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ glyphicons-halflings.pngâ”‚&nbsp;&nbsp; â”œâ”€â”€ GNU-Linux-Logo-Penguin-SVG.pngâ”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.flot.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.flot.resize.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.peity.min.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.ui.custom.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ logo.pngâ”‚&nbsp;&nbsp; â”œâ”€â”€ Tux.jpgâ”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.dashboard.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.grey.cssâ”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.jsâ”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.login.cssâ”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.login.jsâ”‚&nbsp;&nbsp; â””â”€â”€ unicorn.main.cssâ””â”€â”€ templates â”œâ”€â”€ base.html â”œâ”€â”€ check.html â”œâ”€â”€ index.html â”œâ”€â”€ login.html â””â”€â”€ upload.html &nbsp; å‰ç«¯å°±ç”¨bootstrapå±•ç¤ºï¼Œlogin.html 12345678910111213141516171819202122232425262728293031323334353637383940{% extends \\\"base.html\\\" %}{% block title %} Dachen FTP {% endblock %}&lt;/style&gt;&lt;/head&gt;{% block body %} &lt;body&gt; &lt;div id=\"logo\"&gt; &lt;img src=\"{ {url_for('static',filename='GNU-Linux-Logo-Penguin-SVG.png')}}\" alt=\"\"&gt; &lt;/div&gt; &lt;div id=\"loginbox\"&gt; &lt;form id=\"loginform\" class=\"form-vertical\" action=\"\" method=\"post\"&gt; &lt;p&gt;Sing in to blog.sctux.com&lt;/p&gt; &lt;!--&lt;div class=\"control-group\"&gt; --&gt; &lt;div class=\"form-group\"&gt; &lt;div class=\"controls\"&gt; &lt;div class=\"input-prepend\"&gt; &lt;input name=\"username\" value=\"{ {request.form.username}}\" placeholder=\"Username\"&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;!\\-\\- &lt;div class=\"control-group\"&gt; --&gt; &lt;div class=\"form-group\"&gt; &lt;div class=\"controls\"&gt; &lt;div class=\"input-prepend\"&gt; &lt;input name=\"pass\" placeholder=\"Password \"&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=\"form-group\"&gt; &lt;div class=\"col-md-90 col-md-offset-12\"&gt; &lt;button type=\"submit\" class=\"btn btn-primary\"&gt;Sign in&lt;/button&gt; &lt;/div&gt; {% if error %} &lt;p&gt;&lt;font color=\"red\"&gt;{ { error }}&lt;/font&gt;&lt;/p&gt; {% endif %} &lt;/div&gt; &lt;/form&gt; {% endblock %}&lt;/body&gt; &nbsp; run.pyå†…å®¹ï¼š 12345678910111213141516171819202122232425262728293031323334\\# coding:utf-8from flask.ext.wtf import Formfrom flask import render\\_template, redirect, url\\_forapp = Flask(\\_\\_name\\_\\_)@app.route('/login',methods=\\['POST','GET'\\])def login(): error=False if request.method == 'POST': if request.form\\['username'\\] != 'user1' or request.form\\['pass'\\] != 'user1@1qaz': error=\"username or password error !\" else: return redirect(url_for('index')) return render_template('login.html',error=error)@app.route('/index')def index(): return render_template('index.html',result=result)@app.route('/upload',methods=\\['GET','POST'\\])def upload(): return render_template('upload.html')@app.route('/check',methods=\\['POST','GET'\\])def check(): return render_template('check.html')@app.route('/logout')def logout(): return redirect(url_for('login'))if \\_\\_name\\_\\_==\"\\_\\_main\\_\\_\": app.run(debug=True,host='xxxxxxxxx',port=4000) å¯åŠ¨ python run.py è®¿é—® http://xxxxxxxxx:4000/ ç™»å½•ä¸»é¡µçš„æ•ˆæœï¼š å¥½å•¦ï¼Œä¸€ä¸ªç®€å•çš„ç™»å½•é¡µé¢å°±å†™å¥½å•¦ï¼›flask å€¼å¾—ä½ æ‹¥æœ‰!","categories":[{"name":"Python","slug":"Python","permalink":"https://blog.sctux.cc/categories/Python/"},{"name":"è„šæœ¬ç¼–ç¨‹","slug":"Python/è„šæœ¬ç¼–ç¨‹","permalink":"https://blog.sctux.cc/categories/Python/%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/"}],"tags":[{"name":"bootstrap","slug":"bootstrap","permalink":"https://blog.sctux.cc/tags/bootstrap/"},{"name":"flask","slug":"flask","permalink":"https://blog.sctux.cc/tags/flask/"}],"keywords":[{"name":"Python","slug":"Python","permalink":"https://blog.sctux.cc/categories/Python/"},{"name":"è„šæœ¬ç¼–ç¨‹","slug":"Python/è„šæœ¬ç¼–ç¨‹","permalink":"https://blog.sctux.cc/categories/Python/%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/"}]},{"title":"Jqå‘½ä»¤-åœ¨å‘½ä»¤è¡Œç›´æ¥è§£æJsonæ–‡æ¡£","slug":"jq-ming-ling-zai-ming-ling-xing-zhi-jie-jie-xijson","date":"2016-06-20T05:01:33.000Z","updated":"2025-09-01T01:59:08.884Z","comments":true,"path":"2016/06/20/jq-ming-ling-zai-ming-ling-xing-zhi-jie-jie-xijson/","permalink":"https://blog.sctux.cc/2016/06/20/jq-ming-ling-zai-ming-ling-xing-zhi-jie-jie-xijson/","excerpt":"å®‰è£…yum install -y libtool &amp;&amp; \\ wget https://github.com/stedolan/jq/releases/download/jq-1.5/jq-1.5.tar.gz &amp;&amp; \\ tar -xf jq-1.5.tar.gz -C /usr/local &amp;&amp; \\ cd /usr/local/jq-1.5 &amp;&amp; \\ ./configure --disable-maintainer-mode &amp;&amp; \\ make LDFLAGS=-all-static &amp;&amp; \\ make install &amp;&amp; \\ cp /usr/local/jq-1.5/jq /sbin/ \\ echo \"ç¨‹åºå·²å®‰è£…: `which jq`\" ä¸¾ä¸ªæ —å­ï¼Œå¦‚ï¼šæˆ‘è¿™é‡Œæœ‰ä¸ªAPIè¯·æ±‚ï¼Œåœ¨ç»ˆç«¯ä¸­å¾—åˆ°çš„ç»“æœæ˜¯ä¸€ä¸²jsonå­—ç¬¦ä¸²ï¼Œä½†æ˜¯çœ‹èµ·æ¥ä¸æ˜¯é‚£ä¹ˆè§„æ•´ï¼Œä¸€ä¸‹å­è¿˜å¾ˆéš¾åˆ¤æ–­æ˜¯ä»€ä¹ˆæ ¼å¼ï¼›[root@localhost ~]# curl -s http://SERVER_IP/health/monitor/service {\"data\":{\"serCode\":\"0\",\"serDesc\":\"æœåŠ¡æ­£å¸¸\"},\"resultCode\":1} äºæ˜¯é€šè¿‡jqè¿™ä¸ªå‘½ä»¤æˆ‘ä»¬æ ¼å¼åŒ–ä¸€ä¸‹ï¼Œç»ˆç«¯é‡Œé¢çœ‹åˆ°çš„ç»“æœå°±æ˜¯ä¸‹é¢è¿™æ ·çš„å•¦[root@salt-api ~]# curl -s http://SERVER_IP/health/monitor/service | jq { \"data\": { \"serCode\": \"0\", \"serDesc\": \"æœåŠ¡æ­£å¸¸\" }, \"resultCode\": 1 }","text":"å®‰è£…yum install -y libtool &amp;&amp; \\ wget https://github.com/stedolan/jq/releases/download/jq-1.5/jq-1.5.tar.gz &amp;&amp; \\ tar -xf jq-1.5.tar.gz -C /usr/local &amp;&amp; \\ cd /usr/local/jq-1.5 &amp;&amp; \\ ./configure --disable-maintainer-mode &amp;&amp; \\ make LDFLAGS=-all-static &amp;&amp; \\ make install &amp;&amp; \\ cp /usr/local/jq-1.5/jq /sbin/ \\ echo \"ç¨‹åºå·²å®‰è£…: `which jq`\" ä¸¾ä¸ªæ —å­ï¼Œå¦‚ï¼šæˆ‘è¿™é‡Œæœ‰ä¸ªAPIè¯·æ±‚ï¼Œåœ¨ç»ˆç«¯ä¸­å¾—åˆ°çš„ç»“æœæ˜¯ä¸€ä¸²jsonå­—ç¬¦ä¸²ï¼Œä½†æ˜¯çœ‹èµ·æ¥ä¸æ˜¯é‚£ä¹ˆè§„æ•´ï¼Œä¸€ä¸‹å­è¿˜å¾ˆéš¾åˆ¤æ–­æ˜¯ä»€ä¹ˆæ ¼å¼ï¼›[root@localhost ~]# curl -s http://SERVER_IP/health/monitor/service {\"data\":{\"serCode\":\"0\",\"serDesc\":\"æœåŠ¡æ­£å¸¸\"},\"resultCode\":1} äºæ˜¯é€šè¿‡jqè¿™ä¸ªå‘½ä»¤æˆ‘ä»¬æ ¼å¼åŒ–ä¸€ä¸‹ï¼Œç»ˆç«¯é‡Œé¢çœ‹åˆ°çš„ç»“æœå°±æ˜¯ä¸‹é¢è¿™æ ·çš„å•¦[root@salt-api ~]# curl -s http://SERVER_IP/health/monitor/service | jq { \"data\": { \"serCode\": \"0\", \"serDesc\": \"æœåŠ¡æ­£å¸¸\" }, \"resultCode\": 1 }","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"jq","slug":"jq","permalink":"https://blog.sctux.cc/tags/jq/"}],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}]},{"title":"Flask-Login AttributeError: 'Bool' Object Has No Attribute '__Call__'","slug":"flasklogin-yong-hu-pan-duan-shi-hou-bao-cuo","date":"2016-06-06T11:09:25.000Z","updated":"2025-09-01T01:59:08.983Z","comments":true,"path":"2016/06/06/flasklogin-yong-hu-pan-duan-shi-hou-bao-cuo/","permalink":"https://blog.sctux.cc/2016/06/06/flasklogin-yong-hu-pan-duan-shi-hou-bao-cuo/","excerpt":"ä»Šå¤©åœ¨ä½¿ç”¨flask-loginæ·»åŠ ç”¨æˆ·è®¤è¯çš„æ—¶å€™æœåŠ¡å™¨å‡ºç°äº†æŠ¥é”™ è€Œæˆ‘çš„ base.htmlæ˜¯è¿™æ ·å†™çš„ï¼š ï¿¼å»çœ‹å®˜æ–¹æ–‡æ¡£å§ï¼Œé€‰æ‹©å¯¹åº”ç‰ˆæœ¬çš„æ–‡æ¡£(æˆ‘è¿™é‡Œæ˜¯0.3.1): ï¿¼å†çœ‹çœ‹å…¶å‰é¢çš„ç‰ˆæœ¬æ˜¯ä¸æ˜¯è¿™æ ·å®šä¹‰çš„ï¼š ï¿¼ çœ‹å§ ç‰ˆæœ¬é—®é¢˜é€ æˆã€‚","text":"ä»Šå¤©åœ¨ä½¿ç”¨flask-loginæ·»åŠ ç”¨æˆ·è®¤è¯çš„æ—¶å€™æœåŠ¡å™¨å‡ºç°äº†æŠ¥é”™ è€Œæˆ‘çš„ base.htmlæ˜¯è¿™æ ·å†™çš„ï¼š ï¿¼å»çœ‹å®˜æ–¹æ–‡æ¡£å§ï¼Œé€‰æ‹©å¯¹åº”ç‰ˆæœ¬çš„æ–‡æ¡£(æˆ‘è¿™é‡Œæ˜¯0.3.1): ï¿¼å†çœ‹çœ‹å…¶å‰é¢çš„ç‰ˆæœ¬æ˜¯ä¸æ˜¯è¿™æ ·å®šä¹‰çš„ï¼š ï¿¼ çœ‹å§ ç‰ˆæœ¬é—®é¢˜é€ æˆã€‚","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"åƒé‡Œé©¬å¸¸æœ‰ï¼Œè€Œä¼¯ä¹ä¸å¸¸æœ‰","slug":"qianlima","date":"2016-05-08T12:42:29.000Z","updated":"2025-09-01T01:59:08.871Z","comments":true,"path":"2016/05/08/qianlima/","permalink":"https://blog.sctux.cc/2016/05/08/qianlima/","excerpt":"ä¸–æœ‰ä¼¯ä¹ï¼Œç„¶åæœ‰åƒé‡Œé©¬ã€‚åƒé‡Œé©¬å¸¸æœ‰ï¼Œè€Œä¼¯ä¹ä¸å¸¸æœ‰ï¼›æ•…è™½æœ‰åé©¬ï¼Œç¥—è¾±äºå¥´éš¶äººä¹‹æ‰‹ï¼Œéªˆæ­»äºæ§½æ¥ä¹‹é—´ï¼Œä¸ä»¥åƒé‡Œç§°ä¹Ÿã€‚ é©¬ä¹‹åƒé‡Œè€…ï¼Œä¸€é£Ÿæˆ–å°½ç²Ÿä¸€çŸ³ã€‚é£Ÿé©¬è€…ä¸çŸ¥å…¶èƒ½åƒé‡Œè€Œé£Ÿä¹Ÿï¼›æ˜¯é©¬ä¹Ÿï¼Œè™½æœ‰åƒé‡Œä¹‹èƒ½ï¼Œé£Ÿä¸é¥±ï¼ŒåŠ›ä¸è¶³ï¼Œæ‰ç¾ä¸å¤–è§ï¼Œä¸”æ¬²ä¸å¸¸é©¬ç­‰ä¸å¯å¾—ï¼Œå®‰æ±‚å…¶èƒ½åƒé‡Œä¹Ÿï¼Ÿ ç­–ä¹‹ä¸ä»¥å…¶é“ï¼Œé£Ÿä¹‹ä¸èƒ½å°½å…¶æï¼Œé¸£ä¹‹è€Œä¸èƒ½é€šå…¶æ„ï¼Œæ‰§ç­–è€Œä¸´ä¹‹æ›°ï¼šâ€œå¤©ä¸‹æ— é©¬ï¼â€å‘œå‘¼ï¼å…¶çœŸæ— é©¬é‚ªï¼Ÿå…¶çœŸä¸çŸ¥é©¬ä¹Ÿï¼","text":"ä¸–æœ‰ä¼¯ä¹ï¼Œç„¶åæœ‰åƒé‡Œé©¬ã€‚åƒé‡Œé©¬å¸¸æœ‰ï¼Œè€Œä¼¯ä¹ä¸å¸¸æœ‰ï¼›æ•…è™½æœ‰åé©¬ï¼Œç¥—è¾±äºå¥´éš¶äººä¹‹æ‰‹ï¼Œéªˆæ­»äºæ§½æ¥ä¹‹é—´ï¼Œä¸ä»¥åƒé‡Œç§°ä¹Ÿã€‚ é©¬ä¹‹åƒé‡Œè€…ï¼Œä¸€é£Ÿæˆ–å°½ç²Ÿä¸€çŸ³ã€‚é£Ÿé©¬è€…ä¸çŸ¥å…¶èƒ½åƒé‡Œè€Œé£Ÿä¹Ÿï¼›æ˜¯é©¬ä¹Ÿï¼Œè™½æœ‰åƒé‡Œä¹‹èƒ½ï¼Œé£Ÿä¸é¥±ï¼ŒåŠ›ä¸è¶³ï¼Œæ‰ç¾ä¸å¤–è§ï¼Œä¸”æ¬²ä¸å¸¸é©¬ç­‰ä¸å¯å¾—ï¼Œå®‰æ±‚å…¶èƒ½åƒé‡Œä¹Ÿï¼Ÿ ç­–ä¹‹ä¸ä»¥å…¶é“ï¼Œé£Ÿä¹‹ä¸èƒ½å°½å…¶æï¼Œé¸£ä¹‹è€Œä¸èƒ½é€šå…¶æ„ï¼Œæ‰§ç­–è€Œä¸´ä¹‹æ›°ï¼šâ€œå¤©ä¸‹æ— é©¬ï¼â€å‘œå‘¼ï¼å…¶çœŸæ— é©¬é‚ªï¼Ÿå…¶çœŸä¸çŸ¥é©¬ä¹Ÿï¼","categories":[{"name":"å¿ƒæƒ…éšç¬”","slug":"å¿ƒæƒ…éšç¬”","permalink":"https://blog.sctux.cc/categories/%E5%BF%83%E6%83%85%E9%9A%8F%E7%AC%94/"}],"tags":[],"keywords":[{"name":"å¿ƒæƒ…éšç¬”","slug":"å¿ƒæƒ…éšç¬”","permalink":"https://blog.sctux.cc/categories/%E5%BF%83%E6%83%85%E9%9A%8F%E7%AC%94/"}]},{"title":"MongoDBåŸºæœ¬æ“ä½œ","slug":"mongodb-ji-ben-cao-zuo","date":"2016-05-02T06:25:53.000Z","updated":"2025-09-01T01:59:08.870Z","comments":true,"path":"2016/05/02/mongodb-ji-ben-cao-zuo/","permalink":"https://blog.sctux.cc/2016/05/02/mongodb-ji-ben-cao-zuo/","excerpt":"1.åˆ é™¤ç”¨æˆ·mongo&gt;use db1 mongo&gt;show users; mongo&gt;db.dropUser(\"User_name\") 2.å¤‡ä»½mongodump -h 127.0.0.1:27017 -d health_init -u=health_init -p=health_init -o /tmp/ 3.æ¢å¤mongorestore -d health_test --drop -u=dachenadm -p=dachen@ad /tmp/health_ini 4.æˆæƒï¼š#åˆ›å»ºä¸€ä¸ªè§’è‰²ï¼š use amdin;db.createRole({role:'sysadmin',roles:[],privileges:[{resource:{anyResource:true},actions:['anyAction']}]}) #æˆæƒä¸€ä¸ªç”¨æˆ· use health;db.createUser( { user: \"health\", pwd: \"healthnx\", roles: [{ role: \"sysadmin\", db: \"admin\" }] } 5. mongoè¿œç¨‹æ‰§è¡Œéœ€è¦è®¤è¯çš„æœåŠ¡å™¨çš„jsæ–‡ä»¶/usr/bin/mongo -h 10.251.225.205:27017/health -u health -p healthnx update.js","text":"1.åˆ é™¤ç”¨æˆ·mongo&gt;use db1 mongo&gt;show users; mongo&gt;db.dropUser(\"User_name\") 2.å¤‡ä»½mongodump -h 127.0.0.1:27017 -d health_init -u=health_init -p=health_init -o /tmp/ 3.æ¢å¤mongorestore -d health_test --drop -u=dachenadm -p=dachen@ad /tmp/health_ini 4.æˆæƒï¼š#åˆ›å»ºä¸€ä¸ªè§’è‰²ï¼š use amdin;db.createRole({role:'sysadmin',roles:[],privileges:[{resource:{anyResource:true},actions:['anyAction']}]}) #æˆæƒä¸€ä¸ªç”¨æˆ· use health;db.createUser( { user: \"health\", pwd: \"healthnx\", roles: [{ role: \"sysadmin\", db: \"admin\" }] } 5. mongoè¿œç¨‹æ‰§è¡Œéœ€è¦è®¤è¯çš„æœåŠ¡å™¨çš„jsæ–‡ä»¶/usr/bin/mongo -h 10.251.225.205:27017/health -u health -p healthnx update.js 6.æŸ¥çœ‹collectionå†…å®¹ï¼šdb.d_role.find() 7.æ›´æ–°æ“ä½œMongodbæ•°æ®æ›´æ–°å‘½ä»¤Mongodbæ›´æ–°æœ‰ä¸¤ä¸ªå‘½ä»¤ï¼šupdateã€saveã€‚updateå‘½ä»¤æ ¼å¼:db.collection.update(criteria,objNew,upsert,multi) å‚æ•°è¯´æ˜ï¼šcriteriaï¼šæŸ¥è¯¢æ¡ä»¶objNewï¼šupdateå¯¹è±¡å’Œä¸€äº›æ›´æ–°æ“ä½œç¬¦upsertï¼šå¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ï¼Œæ˜¯å¦æ’å…¥objNewè¿™ä¸ªæ–°çš„æ–‡æ¡£ï¼Œtrueä¸ºæ’å…¥ï¼Œé»˜è®¤ä¸ºfalseï¼Œä¸æ’å…¥ã€‚multiï¼šé»˜è®¤æ˜¯falseï¼Œåªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ã€‚å¦‚æœä¸ºtrueï¼ŒæŠŠæŒ‰æ¡ä»¶æŸ¥è¯¢så‡ºæ¥çš„è®°å½•å…¨éƒ¨æ›´æ–°ã€‚8.mongodbçš„æ–‡æ¡£å¯¼å…¥å¯¼å‡ºï¼š1. mongoimport -h 127.0.0.1:27017 -u USENAME -p PASSWORD -c COLLECTIONS b_hospitaldept.json 2. mongoexport -h 127.0.0.1:27017 -d DB -u USENAME -p PASSWORD -c COLLECTIONS -o checkin_b_hospitaldept.json 9.å¯¹collectionsæ“ä½œ1. use demodb &nbsp;//ä½¿ç”¨demodbï¼Œä»¥ä¸‹å‡è®¾æ“ä½œçš„collectionæ˜¯foo 2. db.foo.remove({\"id\":\"bar\"}) &nbsp;//åˆ é™¤ä¸€æ¡æ•°æ® 3. db.foo.remove() //åˆ é™¤fooä¸­çš„æ‰€æœ‰è®°å½•ï¼Œä½†æ˜¯fooè¿˜å­˜åœ¨ï¼Œshow collectionè¿˜å¯ä»¥çœ‹åˆ°foo 4. db.foo.drop() &nbsp;//åˆ é™¤fooè¿™ä¸ªcollectionï¼Œï¼ˆshow collectionå·²ç»çœ‹ä¸åˆ°fooäº†ï¼‰ä½†æ˜¯æŸ¥çœ‹æ•°æ®æ–‡ä»¶å‘ç°å¤§å°ä¸å˜ï¼ŒMongodbä¸ä¼šè‡ªåŠ¨é‡Šæ”¾æ–‡ä»¶ç©ºé—´ 5. db.repairDatabase() &nbsp;//æ‰§è¡Œè¿™ä¸ªå‘½ä»¤åï¼ŒMongodbä¼šæŠŠä¸éœ€è¦çš„ç©ºé—´é‡Šæ”¾å‡ºæ¥","categories":[{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","permalink":"https://blog.sctux.cc/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"}],"tags":[],"keywords":[{"name":"æ•°æ®åº“","slug":"æ•°æ®åº“","permalink":"https://blog.sctux.cc/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"}]},{"title":"Jenkinsé…ç½®ä»¤ç‰Œè¿œç¨‹è§¦å‘é¡¹ç›®æ„å»º","slug":"jenkins-e9-85-8d-e7-bd-ae-e4-bb-a4-e7-89-8c-e8-bf-9c-e7-a8-8b-e8-a7-a6-e5-8f-91-e9-a1-b9-e7-9b-ae-e6-9e-84-e5-bb-ba","date":"2016-04-18T15:10:01.000Z","updated":"2025-09-01T01:59:08.981Z","comments":true,"path":"2016/04/18/jenkins-e9-85-8d-e7-bd-ae-e4-bb-a4-e7-89-8c-e8-bf-9c-e7-a8-8b-e8-a7-a6-e5-8f-91-e9-a1-b9-e7-9b-ae-e6-9e-84-e5-bb-ba/","permalink":"https://blog.sctux.cc/2016/04/18/jenkins-e9-85-8d-e7-bd-ae-e4-bb-a4-e7-89-8c-e8-bf-9c-e7-a8-8b-e8-a7-a6-e5-8f-91-e9-a1-b9-e7-9b-ae-e6-9e-84-e5-bb-ba/","excerpt":"æˆ‘ä»¬åœ¨æ‰§è¡ŒJenkinsçš„é¡¹ç›®æ„å»ºçš„æ—¶å€™ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡webç®¡ç†ç•Œé¢ä¸­çš„â€æ„å»ºâ€æ¥æ‰§è¡Œé¡¹ç›®æ„å»ºæ“ä½œï¼Œä½†æ˜¯é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡é¡¹ç›®é…ç½®ä¸­çš„â€æ„å»ºè§¦å‘å™¨â€æ¥è§¦å‘æ„å»ºæ“ä½œï¼Œå…¶ä¸­â€æ„å»ºè§¦å‘å™¨â€æœ‰ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡é…ç½®ä»¤ç‰Œè¿œç¨‹è§¦å‘é¡¹ç›®æ„å»ºï¼›è¦å¯ç”¨Token(ä»¤ç‰Œ)è¿œç¨‹è§¦å‘é¡¹ç›®æ„å»ºé¦–å…ˆè¦ä¿è¯JenkinsæœåŠ¡å®‰è£…äº†build-token-root&nbsp;æ’ä»¶ï¼Œå¹¶ä¸”é…ç½®äº†Jenkinsçš„èº«ä»½éªŒè¯(ä¸æ˜¯å¿…é¡»)ã€‚ è¯¥å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ’ä»¶å‘¢ï¼Ÿ æ‰“å¼€ä¸€ä¸ªJenkins Project â€“&gt; é…ç½® ç„¶ååœ¨æˆ‘ä»¬è‡ªå·±çš„å·¥ä½œæœºä¸Šç¼–å†™ä¸€æ¡è¿œç¨‹æ‰§è¡Œçš„å‘½ä»¤å³å¯ï¼Œå…¶å®å°±æ˜¯ä¸€æ¡POSTè¯·æ±‚ï¼Œå¦‚ï¼š åœ¨æˆ‘ä»¬å·¥ä½œæœºä¸Šç›´æ¥æ‰§è¡Œè¯¥curlè¯·æ±‚å°±å¯ä»¥æ‰§è¡Œé¡¹ç›®çš„æ„å»ºå•¦ï¼Œè€Œä¸å†éœ€è¦ç‚¹å‡»é¡µé¢ä¸­çš„â€æ„å»ºâ€ï¼Œç”¨è¿™ç§æ–¹å¼ä¸»è¦è¿˜æ˜¯ä¹ æƒ¯å§ï¼Œæ•²å‘½ä»¤çš„æ„Ÿè§‰è¿˜æ˜¯æŒºå¥½çš„ï¼›ä¸€èˆ¬ä¸ºäº†æ–¹ä¾¿æˆ‘éƒ½æ˜¯å†™åˆ°ä¸€ä¸ªè„šæœ¬é‡Œé¢å»æ‰§è¡Œï¼Œå¦‚æœæœ‰å¤šä¸ªé¡¹ç›®ä¹Ÿå¯ä»¥é€šè¿‡ä¼ å‚å•Šï¼Œå¤šä¸ªå‚æ•°(é¡¹ç›®)ä¸€èµ·æ‰§è¡Œæ„å»ºï¼›çœ‹è‡ªå·±çš„å·¥ä½œç¯å¢ƒè€Œå®šå§ï¼Œåœ¨è§£å†³é—®é¢˜çš„æƒ…å†µä¸‹ï¼ŒåŠ å¿«ä¸ªäººå·¥ä½œæ•ˆç‡çš„æƒ…å†µä¸‹è¿˜æ˜¯æ€ä¹ˆç®€å•æ€ä¹ˆæ¥å§ã€‚ä¸‹å›¾å°±æ˜¯æˆ‘æ‰§è¡Œäº†è¿™æ¡å‘½ä»¤çš„ç»“æœï¼Œè·Ÿæˆ‘ä»¬æ‰‹åŠ¨åœ¨webç•Œé¢ç‚¹å‡»â€æ„å»ºâ€æ˜¯ä¸€æ ·çš„æ•ˆæœã€‚","text":"æˆ‘ä»¬åœ¨æ‰§è¡ŒJenkinsçš„é¡¹ç›®æ„å»ºçš„æ—¶å€™ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡webç®¡ç†ç•Œé¢ä¸­çš„â€æ„å»ºâ€æ¥æ‰§è¡Œé¡¹ç›®æ„å»ºæ“ä½œï¼Œä½†æ˜¯é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡é¡¹ç›®é…ç½®ä¸­çš„â€æ„å»ºè§¦å‘å™¨â€æ¥è§¦å‘æ„å»ºæ“ä½œï¼Œå…¶ä¸­â€æ„å»ºè§¦å‘å™¨â€æœ‰ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡é…ç½®ä»¤ç‰Œè¿œç¨‹è§¦å‘é¡¹ç›®æ„å»ºï¼›è¦å¯ç”¨Token(ä»¤ç‰Œ)è¿œç¨‹è§¦å‘é¡¹ç›®æ„å»ºé¦–å…ˆè¦ä¿è¯JenkinsæœåŠ¡å®‰è£…äº†build-token-root&nbsp;æ’ä»¶ï¼Œå¹¶ä¸”é…ç½®äº†Jenkinsçš„èº«ä»½éªŒè¯(ä¸æ˜¯å¿…é¡»)ã€‚ è¯¥å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ’ä»¶å‘¢ï¼Ÿ æ‰“å¼€ä¸€ä¸ªJenkins Project â€“&gt; é…ç½® ç„¶ååœ¨æˆ‘ä»¬è‡ªå·±çš„å·¥ä½œæœºä¸Šç¼–å†™ä¸€æ¡è¿œç¨‹æ‰§è¡Œçš„å‘½ä»¤å³å¯ï¼Œå…¶å®å°±æ˜¯ä¸€æ¡POSTè¯·æ±‚ï¼Œå¦‚ï¼š åœ¨æˆ‘ä»¬å·¥ä½œæœºä¸Šç›´æ¥æ‰§è¡Œè¯¥curlè¯·æ±‚å°±å¯ä»¥æ‰§è¡Œé¡¹ç›®çš„æ„å»ºå•¦ï¼Œè€Œä¸å†éœ€è¦ç‚¹å‡»é¡µé¢ä¸­çš„â€æ„å»ºâ€ï¼Œç”¨è¿™ç§æ–¹å¼ä¸»è¦è¿˜æ˜¯ä¹ æƒ¯å§ï¼Œæ•²å‘½ä»¤çš„æ„Ÿè§‰è¿˜æ˜¯æŒºå¥½çš„ï¼›ä¸€èˆ¬ä¸ºäº†æ–¹ä¾¿æˆ‘éƒ½æ˜¯å†™åˆ°ä¸€ä¸ªè„šæœ¬é‡Œé¢å»æ‰§è¡Œï¼Œå¦‚æœæœ‰å¤šä¸ªé¡¹ç›®ä¹Ÿå¯ä»¥é€šè¿‡ä¼ å‚å•Šï¼Œå¤šä¸ªå‚æ•°(é¡¹ç›®)ä¸€èµ·æ‰§è¡Œæ„å»ºï¼›çœ‹è‡ªå·±çš„å·¥ä½œç¯å¢ƒè€Œå®šå§ï¼Œåœ¨è§£å†³é—®é¢˜çš„æƒ…å†µä¸‹ï¼ŒåŠ å¿«ä¸ªäººå·¥ä½œæ•ˆç‡çš„æƒ…å†µä¸‹è¿˜æ˜¯æ€ä¹ˆç®€å•æ€ä¹ˆæ¥å§ã€‚ä¸‹å›¾å°±æ˜¯æˆ‘æ‰§è¡Œäº†è¿™æ¡å‘½ä»¤çš„ç»“æœï¼Œè·Ÿæˆ‘ä»¬æ‰‹åŠ¨åœ¨webç•Œé¢ç‚¹å‡»â€æ„å»ºâ€æ˜¯ä¸€æ ·çš„æ•ˆæœã€‚","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"Jenkins","slug":"Jenkins","permalink":"https://blog.sctux.cc/tags/Jenkins/"}],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"Lvmçš„åˆ›å»º","slug":"lvm-chuang-jian","date":"2016-03-28T17:57:13.000Z","updated":"2025-09-01T01:59:08.861Z","comments":true,"path":"2016/03/29/lvm-chuang-jian/","permalink":"https://blog.sctux.cc/2016/03/29/lvm-chuang-jian/","excerpt":"1. æŸ¥çœ‹ç£ç›˜ï¼š[root@localhost ~]# fdisk -l ...... ç£ç›˜ /dev/sdbï¼š21.5 GB, 21474836480 å­—èŠ‚ï¼Œ41943040 ä¸ªæ‰‡åŒº Units = æ‰‡åŒº of 1 * 512 = 512 bytes æ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚ I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚ ç£ç›˜ /dev/sdcï¼š21.5 GB, 21474836480 å­—èŠ‚ï¼Œ41943040 ä¸ªæ‰‡åŒº Units = æ‰‡åŒº of 1 * 512 = 512 bytes æ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚ I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚ ...... 2. å¯¹ä¸¤å—ç£ç›˜è¿›è¡Œlvmæ ¼å¼åˆ†åŒºfdisk /dev/sdb/ --&gt; n --&gt; p --&gt; åˆ†åŒºå·(é»˜è®¤) --&gt; èµ·å§‹æ‰‡åŒº(é»˜è®¤) --&gt; lastæ‰‡åŒº(é»˜è®¤) # ä¿®æ”¹åˆ†åŒºæ ¼å¼ t --&gt; 8e Linux LVM(åˆ†åŒºæ ¼å¼ä¸ºlvm) --&gt; w (ä¿å­˜) # é€€å‡ºåå¯¹ç£ç›˜/dev/sdc æ‰§è¡Œç›¸åŒæ“ä½œå³å¯ 3. åˆ›å»ºç‰©ç†å·(PV)[root@localhost ~]# pvcreate /dev/sdb1 Physical volume \"/dev/sdb1\" successfully created [root@localhost ~]# pvcreate /dev/sdc1 Physical volume \"/dev/sdc1\" successfully created [root@localhost ~]# # pvdisplay æ˜¾ç¤ºè¯¦ç»†PVä¿¡æ¯ \"/dev/sdb1\" is a new physical volume of \"20.00 GiB\" --- NEW Physical volume --- PV Name /dev/sdb1 VG Name PV Size 20.00 GiB Allocatable NO PE Size 0 Total PE 0 Free PE 0 Allocated PE 0 PV UUID LcLg0U-gofo-MapY-eilj-OpkQ-TYMO-nSDfh3 \"/dev/sdc1\" is a new physical volume of \"20.00 GiB\" --- NEW Physical volume --- PV Name /dev/sdc1 VG Name PV Size 20.00 GiB Allocatable NO PE Size 0 Total PE 0 Free PE 0 Allocated PE 0 PV UUID r9Dp6u-S1hL-EmXb-6M7c-yefR-Bzts-B0Rdtd 4. å°†PVåŠ å…¥åˆ°å·ç»„ä¸­(VG)[root@localhost ~]# vgcreate vg-group /dev/sdb1 /dev/sdc1 Volume group \"vg-group\" successfully created 5. åˆ›å»ºä¸€ä¸ª10Gå¤§å°çš„lvm[root@localhost ~]# vgs VG #PV #LV #SN Attr VSize VFree centos 1 2 0 wz--n- 19.51g 0 vg-group 2 0 0 wz--n- 39.99g 39.99g [root@localhost ~]# lvcreate -L 10G -n data vg-group Logical volume \"data\" created [root@localhost ~]# lvs LV VG Attr LSize Pool Origin Data% Move Log Cpy%Sync Convert root centos -wi-ao---- 17.51g swap centos -wi-ao---- 2.00g data vg-group -wi-a----- 10.00g","text":"1. æŸ¥çœ‹ç£ç›˜ï¼š[root@localhost ~]# fdisk -l ...... ç£ç›˜ /dev/sdbï¼š21.5 GB, 21474836480 å­—èŠ‚ï¼Œ41943040 ä¸ªæ‰‡åŒº Units = æ‰‡åŒº of 1 * 512 = 512 bytes æ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚ I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚ ç£ç›˜ /dev/sdcï¼š21.5 GB, 21474836480 å­—èŠ‚ï¼Œ41943040 ä¸ªæ‰‡åŒº Units = æ‰‡åŒº of 1 * 512 = 512 bytes æ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚ I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚ ...... 2. å¯¹ä¸¤å—ç£ç›˜è¿›è¡Œlvmæ ¼å¼åˆ†åŒºfdisk /dev/sdb/ --&gt; n --&gt; p --&gt; åˆ†åŒºå·(é»˜è®¤) --&gt; èµ·å§‹æ‰‡åŒº(é»˜è®¤) --&gt; lastæ‰‡åŒº(é»˜è®¤) # ä¿®æ”¹åˆ†åŒºæ ¼å¼ t --&gt; 8e Linux LVM(åˆ†åŒºæ ¼å¼ä¸ºlvm) --&gt; w (ä¿å­˜) # é€€å‡ºåå¯¹ç£ç›˜/dev/sdc æ‰§è¡Œç›¸åŒæ“ä½œå³å¯ 3. åˆ›å»ºç‰©ç†å·(PV)[root@localhost ~]# pvcreate /dev/sdb1 Physical volume \"/dev/sdb1\" successfully created [root@localhost ~]# pvcreate /dev/sdc1 Physical volume \"/dev/sdc1\" successfully created [root@localhost ~]# # pvdisplay æ˜¾ç¤ºè¯¦ç»†PVä¿¡æ¯ \"/dev/sdb1\" is a new physical volume of \"20.00 GiB\" --- NEW Physical volume --- PV Name /dev/sdb1 VG Name PV Size 20.00 GiB Allocatable NO PE Size 0 Total PE 0 Free PE 0 Allocated PE 0 PV UUID LcLg0U-gofo-MapY-eilj-OpkQ-TYMO-nSDfh3 \"/dev/sdc1\" is a new physical volume of \"20.00 GiB\" --- NEW Physical volume --- PV Name /dev/sdc1 VG Name PV Size 20.00 GiB Allocatable NO PE Size 0 Total PE 0 Free PE 0 Allocated PE 0 PV UUID r9Dp6u-S1hL-EmXb-6M7c-yefR-Bzts-B0Rdtd 4. å°†PVåŠ å…¥åˆ°å·ç»„ä¸­(VG)[root@localhost ~]# vgcreate vg-group /dev/sdb1 /dev/sdc1 Volume group \"vg-group\" successfully created 5. åˆ›å»ºä¸€ä¸ª10Gå¤§å°çš„lvm[root@localhost ~]# vgs VG #PV #LV #SN Attr VSize VFree centos 1 2 0 wz--n- 19.51g 0 vg-group 2 0 0 wz--n- 39.99g 39.99g [root@localhost ~]# lvcreate -L 10G -n data vg-group Logical volume \"data\" created [root@localhost ~]# lvs LV VG Attr LSize Pool Origin Data% Move Log Cpy%Sync Convert root centos -wi-ao---- 17.51g swap centos -wi-ao---- 2.00g data vg-group -wi-a----- 10.00g 6. æ ¼å¼åŒ–è¿™ä¸ªlvmæˆxfsæ–‡ä»¶ç³»ç»Ÿ[root@localhost ~]# mkfs.xfs /dev/vg-group/data # æ³¨æ„è¿™ä¸ªè·¯å¾„æ˜¯/dev/å·ç»„å/lvmå meta-data=/dev/vg-group/data isize=256 agcount=4, agsize=655360 blks = sectsz=512 attr=2, projid32bit=1 = crc=0 data = bsize=4096 blocks=2621440, imaxpct=25 = sunit=0 swidth=0 blks naming =version 2 bsize=4096 ascii-ci=0 ftype=0 log =internal log bsize=4096 blocks=2560, version=2 = sectsz=512 sunit=0 blks, lazy-count=1 realtime =none extsz=4096 blocks=0, rtextents=0 [root@localhost ~]# lvs LV VG Attr LSize Pool Origin Data% Move Log Cpy%Sync Convert root centos -wi-ao---- 17.51g swap centos -wi-ao---- 2.00g data vg-group -wi-a----- 10.00g [root@localhost ~]# 7. é€»è¾‘å·æ‰©å®¹ä½¿ç”¨ lvextend å‘½ä»¤è¿›è¡Œé€»è¾‘å·æ‰©å®¹ã€‚æˆ‘æŠŠæ‰€æœ‰å‰©ä½™ç©ºé—´éƒ½åˆ†é…ç»™äº†data [root@localhost ~]# lvextend -l +100%FREE /dev/vg-group/data Extending logical volume data to 39.99 GiB Logical volume data successfully resized [root@localhost ~]# lvs LV VG Attr LSize Pool Origin Data% Move Log Cpy%Sync Convert root centos -wi-ao---- 17.51g swap centos -wi-ao---- 2.00g data vg-group -wi-a----- 39.99g [root@localhost ~]# mkdir /data [root@localhost ~]# mount /dev/vg-group/data /data/ [root@localhost ~]# df -hT | grep \"data\" # å¯ä»¥çœ‹åˆ°è¿™æ—¶å€™çš„data åªæœ‰10Gï¼Œå¯æ˜¯æˆ‘ä»¬çš„lvmå·²ç»æœ‰40G /dev/mapper/vg--group-data xfs 10G 33M 10G 1% /data 8. ä½¿ç”¨xfs_growfså‘½ä»¤åœ¨çº¿è°ƒæ•´xfsæ ¼å¼æ–‡ä»¶ç³»ç»Ÿå¤§å°[root@localhost ~]# xfs_growfs /dev/vg-group/data meta-data=/dev/mapper/vg--group-data isize=256 agcount=4, agsize=655360 blks = sectsz=512 attr=2, projid32bit=1 = crc=0 data = bsize=4096 blocks=2621440, imaxpct=25 = sunit=0 swidth=0 blks naming =version 2 bsize=4096 ascii-ci=0 ftype=0 log =internal bsize=4096 blocks=2560, version=2 = sectsz=512 sunit=0 blks, lazy-count=1 realtime =none extsz=4096 blocks=0, rtextents=0 data blocks changed from 2621440 to 10483712 [root@localhost ~]# df -hT | grep \"data\" /dev/mapper/vg--group-data xfs 40G 33M 40G 1% /data 9 .åŠ å…¥ç°æœ‰çš„å·ç»„ä¸­ï¼š(1)# æŸ¥çœ‹ç°æœ‰å·ç»„ [root@localhost ~]# vgs VG #PV #LV #SN Attr VSize VFree centos 1 2 0 wz--n- 19.51g 0 vg-group 2 1 0 wz--n- 39.99g 0 (2)#æŸ¥çœ‹æ–°åŠ ç£ç›˜,è¿˜æ˜¯å…ˆåˆ†åŒºï¼Œç„¶åæ›´æ”¹lvmæ ¼å¼(ç•¥) [root@localhost ~]# fdisk -l | grep sdd ç£ç›˜ /dev/sddï¼š21.5 GB, 21474836480 å­—èŠ‚ï¼Œ41943040 ä¸ªæ‰‡åŒº /dev/sdd1 2048 41943039 20970496 8e Linux LVM (3)#ä½¿ç”¨ vgextend å‘½ä»¤æŠŠ/dev/sdd1åŠ å…¥åˆ°centos [root@localhost ~]# vgextend centos /dev/sdd1 Volume group \"centos\" successfully extended [root@localhost ~]# vgs VG #PV #LV #SN Attr VSize VFree centos 2 2 0 wz--n- 39.50g 20.00g vg-group 2 1 0 wz--n- 39.99g 0 (4)ä½¿ç”¨ lvextend å‘½ä»¤è¿›è¡Œé€»è¾‘å·rootæ‰©å®¹ã€‚æˆ‘æŠŠæ‰€æœ‰å‰©ä½™ç©ºé—´éƒ½åˆ†é…ç»™äº†root [root@localhost ~]# lvextend -l +100%FREE /dev/centos/root Extending logical volume root to 37.50 GiB Logical volume root successfully resized [root@localhost ~]# xfs_growfs /dev/centos/root meta-data=/dev/mapper/centos-root isize=256 agcount=4, agsize=1147392 blks = sectsz=512 attr=2, projid32bit=1 = crc=0 data = bsize=4096 blocks=4589568, imaxpct=25 = sunit=0 swidth=0 blks naming =version 2 bsize=4096 ascii-ci=0 ftype=0 log =internal bsize=4096 blocks=2560, version=2 = sectsz=512 sunit=0 blks, lazy-count=1 realtime =none extsz=4096 blocks=0, rtextents=0 data blocks changed from 4589568 to 9831424 [root@localhost ~]# # æ­¤æ—¶æˆ‘ä»¬çš„æ ¹åˆ†åŒºå°±å¾—åˆ°äº†æ‰©å®¹å•¦ï¼› [root@localhost ~]# df -hT | grep \"root\" /dev/mapper/centos-root xfs 38G 929M 37G 3% / æ³¨æ„ï¼špvs -- vgs -- lvs","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"lvm","slug":"lvm","permalink":"https://blog.sctux.cc/tags/lvm/"}],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}]},{"title":"MySQLæŠ¥é”™ERROR 1030 (HY000): è§£å†³è¿‡ç¨‹","slug":"mysql-e6-8a-a5-e9-94-99error-1030-hy000-e8-a7-a3-e5-86-b3-e8-bf-87-e7-a8-8b","date":"2016-03-19T10:45:58.000Z","updated":"2025-09-01T01:59:08.941Z","comments":true,"path":"2016/03/19/mysql-e6-8a-a5-e9-94-99error-1030-hy000-e8-a7-a3-e5-86-b3-e8-bf-87-e7-a8-8b/","permalink":"https://blog.sctux.cc/2016/03/19/mysql-e6-8a-a5-e9-94-99error-1030-hy000-e8-a7-a3-e5-86-b3-e8-bf-87-e7-a8-8b/","excerpt":"é—®é¢˜ï¼š ä»Šå¤©å¼€å‘åŒäº‹åœ¨æ‰§è¡Œjenkinsè‡ªåŠ¨åŒ–æ„å»ºæ—¶ï¼Œç”±äºæ‰§è¡Œä¸€ä¸ªmysqlæ›´æ–°çš„æ“ä½œå¯¼è‡´æ„å»ºå¤±è´¥ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š è¿™ä¸ªæ–‡ä»¶ä¸»è¦æ˜¯å¼€å‘ç”¨äºæ‰§è¡Œæ„å»ºéƒ¨ç½²çš„æ—¶å€™æ›´æ–°æ•°æ®åº“çš„sqlæ–‡ä»¶ï¼Œé‡Œé¢æœ‰å¤§é‡çš„æ’å…¥è¯­å¥ï¼› ç™»å½•åˆ°æµ‹è¯•æœåŠ¡å™¨å°†jenkinsä¸­çš„è¯­å¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œäº†ä¸€éè¿˜æ˜¯æŠ¥åŒæ ·çš„é”™è¯¯ çœ‹åˆ°è¿™ä¸ªæŠ¥é”™è²Œä¼¼ä¸å­˜å‚¨å¼•æ“æœ‰å…³ç³»ï¼Œäºæ˜¯ç™»å½•åˆ°mysqlä¸­æ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œ è§£å†³æ€è·¯ 1.çœ‹äº†ä¸‹å…·ä½“é”™è¯¯ä»£ç  åœ¨tmpä¸‹æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Ÿä½†æ˜¯è¿™ä¸ªæ–‡ä»¶æ—¶ä¸´æ—¶ç”Ÿæˆçš„ï¼Œæœ¬æ¥å°±åº”è¯¥æ²¡æœ‰å•Šï¼ é‚£å°±æ˜¯åˆ›å»ºçš„æ—¶å€™å‡ºé”™äº†?! 2.æŸ¥çœ‹äº†ä¸€ä¸‹ç£ç›˜ç©ºé—´ï¼Œæˆ‘æ»´ä¸ªä¹–ä¹–ï¼ŒåŸæ¥ç¬¬ä¸€å—ç£ç›˜æ»¡äº† å¥½å§ï¼Œæ¸…ç†äº†ä¸€äº›æ–‡ä»¶ å†æ¬¡æ‰§è¡Œæ„å»ºï¼Œé¡ºåˆ©å®Œæˆï¼","text":"é—®é¢˜ï¼š ä»Šå¤©å¼€å‘åŒäº‹åœ¨æ‰§è¡Œjenkinsè‡ªåŠ¨åŒ–æ„å»ºæ—¶ï¼Œç”±äºæ‰§è¡Œä¸€ä¸ªmysqlæ›´æ–°çš„æ“ä½œå¯¼è‡´æ„å»ºå¤±è´¥ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š è¿™ä¸ªæ–‡ä»¶ä¸»è¦æ˜¯å¼€å‘ç”¨äºæ‰§è¡Œæ„å»ºéƒ¨ç½²çš„æ—¶å€™æ›´æ–°æ•°æ®åº“çš„sqlæ–‡ä»¶ï¼Œé‡Œé¢æœ‰å¤§é‡çš„æ’å…¥è¯­å¥ï¼› ç™»å½•åˆ°æµ‹è¯•æœåŠ¡å™¨å°†jenkinsä¸­çš„è¯­å¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œäº†ä¸€éè¿˜æ˜¯æŠ¥åŒæ ·çš„é”™è¯¯ çœ‹åˆ°è¿™ä¸ªæŠ¥é”™è²Œä¼¼ä¸å­˜å‚¨å¼•æ“æœ‰å…³ç³»ï¼Œäºæ˜¯ç™»å½•åˆ°mysqlä¸­æ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œ è§£å†³æ€è·¯ 1.çœ‹äº†ä¸‹å…·ä½“é”™è¯¯ä»£ç  åœ¨tmpä¸‹æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Ÿä½†æ˜¯è¿™ä¸ªæ–‡ä»¶æ—¶ä¸´æ—¶ç”Ÿæˆçš„ï¼Œæœ¬æ¥å°±åº”è¯¥æ²¡æœ‰å•Šï¼ é‚£å°±æ˜¯åˆ›å»ºçš„æ—¶å€™å‡ºé”™äº†?! 2.æŸ¥çœ‹äº†ä¸€ä¸‹ç£ç›˜ç©ºé—´ï¼Œæˆ‘æ»´ä¸ªä¹–ä¹–ï¼ŒåŸæ¥ç¬¬ä¸€å—ç£ç›˜æ»¡äº† å¥½å§ï¼Œæ¸…ç†äº†ä¸€äº›æ–‡ä»¶ å†æ¬¡æ‰§è¡Œæ„å»ºï¼Œé¡ºåˆ©å®Œæˆï¼","categories":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}],"tags":[{"name":"mysql error","slug":"mysql-error","permalink":"https://blog.sctux.cc/tags/mysql-error/"}],"keywords":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}]},{"title":"æˆ‘çš„51CTOåšå®¢æ–‡ç« é“¾æ¥æ±‡æ€»","slug":"e6-88-91-e7-9a-8451cto-e5-8d-9a-e5-ae-a2-e6-96-87-e7-ab-a0-e9-93-be-e6-8e-a5-e6-b1-87-e6-80-bb","date":"2016-01-07T13:13:29.000Z","updated":"2025-09-01T01:59:08.870Z","comments":false,"path":"2016/01/07/e6-88-91-e7-9a-8451cto-e5-8d-9a-e5-ae-a2-e6-96-87-e7-ab-a0-e9-93-be-e6-8e-a5-e6-b1-87-e6-80-bb/","permalink":"https://blog.sctux.cc/2016/01/07/e6-88-91-e7-9a-8451cto-e5-8d-9a-e5-ae-a2-e6-96-87-e7-ab-a0-e9-93-be-e6-8e-a5-e6-b1-87-e6-80-bb/","excerpt":"å°†ä¹‹å‰åœ¨51CTOçš„æ‰€æœ‰åšå®¢æ•´ç†äº†ä¸€ç•ª, ç‚¹å‡»æ–‡ç« åç§°å°±å¯ä»¥è·³åˆ°51ctoè¯»é˜…å•¦^o^ é›†ç¾¤/é«˜å¯ç”¨/è´Ÿè½½å‡è¡¡LVS_NATå®ç°è¿‡ç¨‹â€¦ LVS_DRå®ç°è¿‡ç¨‹â€¦ KeepalivedåŸºç¡€çŸ¥è¯† Linux HAé›†ç¾¤ä¹‹DRBDè¯¦è§£ åŸºäºkeepalivedçš„Haproxyé«˜å¯ç”¨é…ç½® åˆ†å¸ƒå¼åˆ†å¸ƒå¼ç¼“å­˜varnishç®€ä»‹ åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸMogileFSç®€ä»‹ æ•°æ®åº“MysqlçŸ¥è¯†æ€»ç»“ï¼ˆä¸€ï¼‰ MysqlçŸ¥è¯†æ€»ç»“ï¼ˆäºŒï¼‰ MysqlçŸ¥è¯†æ€»ç»“ï¼ˆä¸‰ï¼‰ MariaDB/Mysqlä¹‹ä¸»ä»æ¶æ„çš„å¤åˆ¶åŸç†åŠä¸»ä»/åŒä¸»é…ç½®è¯¦è§£(ä¸€) MariaDB/Mysqlä¹‹ä¸»ä»æ¶æ„çš„å¤åˆ¶åŸç†åŠä¸»ä»/åŒä¸»é…ç½®è¯¦è§£(äºŒ) MariaDBä¹‹å¤‡ä»½æ¢å¤å‡†åˆ™ï¼ˆä¸‰ï¼‰ MariaDBä¹‹åŸºäºmysqldumpä¸lvm-snapshotå¤‡ä»½æ¢å¤Databases or Tablesï¼ˆä¸€ï¼‰ MariaDBä¹‹åŸºäºPercona Xtrabackupå¤‡ä»½å¤§æ•°æ®åº“ã€å®Œæ•´å¤‡ä»½ä¸å¢é‡å¤‡ä»½ã€‘ï¼ˆäºŒï¼‰ Linux å‰–æLinuxç³»ç»Ÿ-å°å€’è…¾ä¹‹Linux DIYå®šåˆ¶è£å‰ª(é™„å¸¦ç®€å•ç½‘ç»œåŠŸèƒ½)o_o(ä¸€) Linuxç³»ç»Ÿ-å°å€’è…¾ä¹‹Linux DIYå®šåˆ¶è£å‰ª(New kernel+Busybox)o_oï¼ˆäºŒï¼‰ Linuxç³»ç»Ÿ-å°å€’è…¾ä¹‹Linux DIYå®šåˆ¶è£å‰ª(å®šåˆ¶Linux+SSH/Nginx)o_oï¼ˆä¸‰ï¼‰ æ–‡ä»¶åŒæ­¥","text":"å°†ä¹‹å‰åœ¨51CTOçš„æ‰€æœ‰åšå®¢æ•´ç†äº†ä¸€ç•ª, ç‚¹å‡»æ–‡ç« åç§°å°±å¯ä»¥è·³åˆ°51ctoè¯»é˜…å•¦^o^ é›†ç¾¤/é«˜å¯ç”¨/è´Ÿè½½å‡è¡¡LVS_NATå®ç°è¿‡ç¨‹â€¦ LVS_DRå®ç°è¿‡ç¨‹â€¦ KeepalivedåŸºç¡€çŸ¥è¯† Linux HAé›†ç¾¤ä¹‹DRBDè¯¦è§£ åŸºäºkeepalivedçš„Haproxyé«˜å¯ç”¨é…ç½® åˆ†å¸ƒå¼åˆ†å¸ƒå¼ç¼“å­˜varnishç®€ä»‹ åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸMogileFSç®€ä»‹ æ•°æ®åº“MysqlçŸ¥è¯†æ€»ç»“ï¼ˆä¸€ï¼‰ MysqlçŸ¥è¯†æ€»ç»“ï¼ˆäºŒï¼‰ MysqlçŸ¥è¯†æ€»ç»“ï¼ˆä¸‰ï¼‰ MariaDB/Mysqlä¹‹ä¸»ä»æ¶æ„çš„å¤åˆ¶åŸç†åŠä¸»ä»/åŒä¸»é…ç½®è¯¦è§£(ä¸€) MariaDB/Mysqlä¹‹ä¸»ä»æ¶æ„çš„å¤åˆ¶åŸç†åŠä¸»ä»/åŒä¸»é…ç½®è¯¦è§£(äºŒ) MariaDBä¹‹å¤‡ä»½æ¢å¤å‡†åˆ™ï¼ˆä¸‰ï¼‰ MariaDBä¹‹åŸºäºmysqldumpä¸lvm-snapshotå¤‡ä»½æ¢å¤Databases or Tablesï¼ˆä¸€ï¼‰ MariaDBä¹‹åŸºäºPercona Xtrabackupå¤‡ä»½å¤§æ•°æ®åº“ã€å®Œæ•´å¤‡ä»½ä¸å¢é‡å¤‡ä»½ã€‘ï¼ˆäºŒï¼‰ Linux å‰–æLinuxç³»ç»Ÿ-å°å€’è…¾ä¹‹Linux DIYå®šåˆ¶è£å‰ª(é™„å¸¦ç®€å•ç½‘ç»œåŠŸèƒ½)o_o(ä¸€) Linuxç³»ç»Ÿ-å°å€’è…¾ä¹‹Linux DIYå®šåˆ¶è£å‰ª(New kernel+Busybox)o_oï¼ˆäºŒï¼‰ Linuxç³»ç»Ÿ-å°å€’è…¾ä¹‹Linux DIYå®šåˆ¶è£å‰ª(å®šåˆ¶Linux+SSH/Nginx)o_oï¼ˆä¸‰ï¼‰ æ–‡ä»¶åŒæ­¥LinuxToolsâ€”Rsyncâ€”åŸç†åŠå…¶åº”ç”¨(ä¸€) LinuxToolsâ€”Rsyncâ€”åŸç†åŠå…¶åº”ç”¨(äºŒ) å®‰å…¨ç®¡ç†Linuxå®‰å…¨ç®¡ç†-Iptables-NATæŠ€æœ¯åº”ç”¨ Linuxå®‰å…¨ç®¡ç†-IptablesåŸç†åŠå…¶åº”ç”¨ Linux ServiceLinuxç½‘ç»œæœåŠ¡-Web Serviceä¹‹ã€HTTPåè®®ç®€ä»‹ã€‘(ä¸€) Linuxç½‘ç»œæœåŠ¡-Web Serviceä¹‹ã€Apache-Preforkã€Workerå’ŒEventä¸‰ç§å·¥ä½œæ¨¡å¼åˆ†æã€‘(äºŒ) Linuxç½‘ç»œæœåŠ¡-Web Serviceä¹‹ã€apacheçš„åŠŸèƒ½ã€å®‰è£…ã€é…ç½®æ–‡ä»¶ä»‹ç»ä»¥åŠå®éªŒå®ä¾‹ã€‘(ä¸‰) Linuxç½‘ç»œæœåŠ¡-LAMPä¹‹åŸºäºNFS+Fastcgiçš„LAMPæ­å»º Linuxç½‘ç»œæœåŠ¡-LAMPä¹‹PhpåŸºäºApacheçš„æ¨¡å—å®ç° Linuxç½‘ç»œæœåŠ¡ä¹‹DNSæœåŠ¡å™¨ä»‹ç»åŠé…ç½®å®ä¾‹è¯¦è§£ ç³»ç»Ÿç®¡ç†Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹åŠ å¯†ã€è§£å¯†ã€OpensslåŸºæœ¬åº”ç”¨åŠCAå®ç°è¿‡ç¨‹ Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹åŠç³»ç»Ÿåˆå§‹åŒ–å­¦ä¹ æ€»ç»“ Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹è½¯ä»¶åŒ…ç®¡ç†ã€é™„httpæºç å®‰è£…å®ä¾‹ã€‘ Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹findå‘½ä»¤å­¦ä¹ æ€»ç»“ Shellç¼–ç¨‹å…¥é—¨è¿›é˜¶ä¹‹Grepå‘½ä»¤åŠæ­£åˆ™è¡¨è¾¾å¼çŸ¥è¯†æ¢³ç† Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹ç”¨æˆ·ã€æƒé™ç®¡ç† Shellç¼–ç¨‹å…¥é—¨è¿›é˜¶ä¹‹bashé…ç½®æ–‡ä»¶ä»‹ç» Shellç¼–ç¨‹å…¥é—¨è¿›é˜¶ä¹‹Bash Shellç‰¹æ€§ Linuxå‘½ä»¤çš„æ ¼å¼ã€å¸¸ç”¨å‘½ä»¤æ±‡æ€»ä»¥åŠä¸€äº›ç³»ç»ŸåŸºæœ¬æ¦‚å¿µ Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹å¦‚ä½•åœ¨ç»ˆç«¯ä¸Šè·å–Linuxå‘½ä»¤å¸®åŠ©. Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹ç»ˆç«¯,ä¼ªç»ˆç«¯æ¦‚å¿µè¯¦è§£ä¹‹tty,ptyç­‰ Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹Linux ç›®å½•é…ç½®æ ‡å‡†ï¼šFHSï¼šFileSystem Hierarchy Standard æ‚è°ˆå‡å¦‚Linuxç‰ˆæœ¬éƒ½å¦‚å¥³äºº","categories":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}],"tags":[],"keywords":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}]},{"title":"Zabbixå¾®ä¿¡æŠ¥è­¦","slug":"zabbix-e5-be-ae-e4-bf-a1-e6-8a-a5-e8-ad-a6","date":"2015-11-21T07:25:35.000Z","updated":"2025-09-01T01:59:08.921Z","comments":true,"path":"2015/11/21/zabbix-e5-be-ae-e4-bf-a1-e6-8a-a5-e8-ad-a6/","permalink":"https://blog.sctux.cc/2015/11/21/zabbix-e5-be-ae-e4-bf-a1-e6-8a-a5-e8-ad-a6/","excerpt":"ä¸€ã€æ³¨å†Œå¾®ä¿¡å…¬ä¼—å·é¦–å…ˆç”³è¯·å¾®ä¿¡å…¬ä¼—å¹³å°https://mp.weixin.qq.com/ä¸€ä¸ªäººæœ€å¤šç”³è¯·5ä¸ªå…¬ä¼—å·ï¼Œç”³è¯·å®Œä¹‹åå°±å¯ä»¥æ ¹æ®è…¾è®¯çš„æç¤ºä½¿ç”¨å¾®ä¿¡å…¬ä¼—å·äº†ï¼Œç„¶åç”¨ä½ è‡ªå·±çš„å¾®ä¿¡æ‰«æå…³æ³¨å¾®ä¿¡å·ã€‚ é€šè¿‡æ‰«æè¿‡åå°±å¯ä»¥çœ‹åˆ°å·²ç»æœ‰ä¸€ä¸ªç”¨æˆ·å…³æ³¨å•¦ï¼›äºæ˜¯æˆ‘ä»¬è¿™é‡Œéœ€è¦æŸ¥çœ‹ç”¨æˆ·çš„ID ç‚¹å‡» â€œç”¨æˆ·ç®¡ç†â€ï¼Œç„¶åç‚¹å‡»ä¸€ä¸‹ç”¨æˆ·çš„å¤´åƒï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨çš„åœ°å€æ å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªè¿™ä¸ªï¼Œå…¶ä¸­çº¢è‰²éƒ¨åˆ†å°±æ˜¯ç”¨æˆ·çš„å¾®ä¿¡IDå•¦ï¼Œå…ˆè®°ä¸‹è¿™ä¸ªID https://mp.weixin.qq.com/cgi-bin/singlesendpage?t=message/send&amp;action=index&amp;tofakeid=250995555&amp;token=94167798&amp;lang=zh_CN &nbsp; äºŒã€ä¸‹è½½å¹¶é…ç½®å¾®ä¿¡å…¬ä¼—å¹³å°ç§æœ‰æ¥å£1.è·å–ä»£ç  git clone https://github.com/lealife/WeiXin-Private-API 2.ä¿®æ”¹zabbixé…ç½®æ–‡ä»¶ [root@Control-machine ~]# cp -r WeiXin-Private-API /usr/lib/zabbix/alertscripts/[root@Control-machine ~]# cd /usr/lib/zabbix/alertscripts/[root@Control-machine alertscripts]# chown zabbix:zabbix WeiXin-Private-API[root@Control-machine alertscripts]# #ä¿®æ”¹test.phpæ–‡ä»¶[root@Control-machine alertscripts]# vim WeiXin-Private-API/test.php&lt;?phprequire â€œconfig.phpâ€;require â€œinclude/WeiXin.phpâ€;$weiXin = new WeiXin($G_CONFIG[â€˜weiXinâ€™]);$testFakeId = â€œ$argv[1]â€œ;$msg=â€$argv[3]â€œ; print_r($weiXin-&gt;send($testFakeId, â€œ$msgâ€)); 3.ä¿®æ”¹config.phpæ–‡ä»¶ [root@Control-machine alertscripts]# vim WeiXin-Private-API/config.php&lt;?php// å…¨å±€é…ç½®$G_ROOT = dirname(__FILE__);$G_CONFIG[â€œweiXinâ€] = array( â€˜accountâ€™ =&gt; â€˜ä½ çš„å¾®ä¿¡å…¬ä¼—ç™»å½•å·ç â€™, â€˜passwordâ€™ =&gt; â€˜ä½ çš„å¾®ä¿¡å…¬ä¼—ç™»å½•å¯†ç â€™, â€˜cookiePathâ€™ =&gt; $G_ROOT. â€˜/cache/cookieâ€™, // cookieç¼“å­˜æ–‡ä»¶è·¯å¾„ â€˜webTokenPathâ€™ =&gt; $G_ROOT. â€˜/cache/webTokenâ€™, // webTokenç¼“å­˜æ–‡ä»¶è·¯å¾„);","text":"ä¸€ã€æ³¨å†Œå¾®ä¿¡å…¬ä¼—å·é¦–å…ˆç”³è¯·å¾®ä¿¡å…¬ä¼—å¹³å°https://mp.weixin.qq.com/ä¸€ä¸ªäººæœ€å¤šç”³è¯·5ä¸ªå…¬ä¼—å·ï¼Œç”³è¯·å®Œä¹‹åå°±å¯ä»¥æ ¹æ®è…¾è®¯çš„æç¤ºä½¿ç”¨å¾®ä¿¡å…¬ä¼—å·äº†ï¼Œç„¶åç”¨ä½ è‡ªå·±çš„å¾®ä¿¡æ‰«æå…³æ³¨å¾®ä¿¡å·ã€‚ é€šè¿‡æ‰«æè¿‡åå°±å¯ä»¥çœ‹åˆ°å·²ç»æœ‰ä¸€ä¸ªç”¨æˆ·å…³æ³¨å•¦ï¼›äºæ˜¯æˆ‘ä»¬è¿™é‡Œéœ€è¦æŸ¥çœ‹ç”¨æˆ·çš„ID ç‚¹å‡» â€œç”¨æˆ·ç®¡ç†â€ï¼Œç„¶åç‚¹å‡»ä¸€ä¸‹ç”¨æˆ·çš„å¤´åƒï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨çš„åœ°å€æ å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªè¿™ä¸ªï¼Œå…¶ä¸­çº¢è‰²éƒ¨åˆ†å°±æ˜¯ç”¨æˆ·çš„å¾®ä¿¡IDå•¦ï¼Œå…ˆè®°ä¸‹è¿™ä¸ªID https://mp.weixin.qq.com/cgi-bin/singlesendpage?t=message/send&amp;action=index&amp;tofakeid=250995555&amp;token=94167798&amp;lang=zh_CN &nbsp; äºŒã€ä¸‹è½½å¹¶é…ç½®å¾®ä¿¡å…¬ä¼—å¹³å°ç§æœ‰æ¥å£1.è·å–ä»£ç  git clone https://github.com/lealife/WeiXin-Private-API 2.ä¿®æ”¹zabbixé…ç½®æ–‡ä»¶ [root@Control-machine ~]# cp -r WeiXin-Private-API /usr/lib/zabbix/alertscripts/[root@Control-machine ~]# cd /usr/lib/zabbix/alertscripts/[root@Control-machine alertscripts]# chown zabbix:zabbix WeiXin-Private-API[root@Control-machine alertscripts]# #ä¿®æ”¹test.phpæ–‡ä»¶[root@Control-machine alertscripts]# vim WeiXin-Private-API/test.php&lt;?phprequire â€œconfig.phpâ€;require â€œinclude/WeiXin.phpâ€;$weiXin = new WeiXin($G_CONFIG[â€˜weiXinâ€™]);$testFakeId = â€œ$argv[1]â€œ;$msg=â€$argv[3]â€œ; print_r($weiXin-&gt;send($testFakeId, â€œ$msgâ€)); 3.ä¿®æ”¹config.phpæ–‡ä»¶ [root@Control-machine alertscripts]# vim WeiXin-Private-API/config.php&lt;?php// å…¨å±€é…ç½®$G_ROOT = dirname(__FILE__);$G_CONFIG[â€œweiXinâ€] = array( â€˜accountâ€™ =&gt; â€˜ä½ çš„å¾®ä¿¡å…¬ä¼—ç™»å½•å·ç â€™, â€˜passwordâ€™ =&gt; â€˜ä½ çš„å¾®ä¿¡å…¬ä¼—ç™»å½•å¯†ç â€™, â€˜cookiePathâ€™ =&gt; $G_ROOT. â€˜/cache/cookieâ€™, // cookieç¼“å­˜æ–‡ä»¶è·¯å¾„ â€˜webTokenPathâ€™ =&gt; $G_ROOT. â€˜/cache/webTokenâ€™, // webTokenç¼“å­˜æ–‡ä»¶è·¯å¾„); 4.ä¿®æ”¹test.phpæ–‡ä»¶ [root@Control-machine alertscripts]# vim WeiXin-Private-API/test.php&lt;?phprequire â€œconfig.phpâ€;require â€œinclude/WeiXin.phpâ€;$weiXin = new WeiXin($G_CONFIG[â€˜weiXinâ€™]);$testFakeId = â€œ$argv[1]â€œ;$msg=â€$argv[3]â€œ; print_r($weiXin-&gt;send($testFakeId, â€œ$msgâ€)); æ³¨æ„è¿™é‡Œ$msg=â€$argv[3]â€œè¡¨ç¤ºzabbixä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå› ä¸ºåœ¨zabbixæŠ¥è­¦æ—¶ä¼šä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼š ä¸€æ˜¯å¾®ä¿¡å¥½å‹IDï¼ŒäºŒæ˜¯æŠ¥è­¦ä¿¡æ¯çš„ä¸»é¢˜ï¼Œä¸‰æ˜¯æŠ¥è­¦ä¿¡æ¯çš„å…·ä½“å†…å®¹ï¼Œè¿™é‡Œè·³è¿‡äº†æŠ¥è­¦ä¿¡æ¯ä¸»é¢˜ï¼Œç›´æ¥å‘é€æŠ¥è­¦ä¿¡æ¯å†…å®¹ 5.åˆ›å»ºå¾®ä¿¡æŠ¥è­¦è„šæœ¬ [root@Control-machine alertscripts]# vim weixin/usr/bin/php /usr/lib/zabbix/alertscripts/WeiXin-Private-API/test.php â€œ$1â€ â€œ$2â€ â€œ$3â€[root@Control-machine alertscripts]# chown zabbix:zabbix weixin[root@Control-machine alertscripts]# chmod +x weixin 6.æµ‹è¯•æŠ¥è­¦ [root@Control-machine alertscripts]# /usr/bin/php /usr/lib/zabbix/alertscripts/WeiXin-Private-API/test.php 250995555 â€œâ€ â€œTestâ€PHP Notice: Undefined index: HTTP_USER_AGENT in /usr/lib/zabbix/alertscripts/WeiXin-Private-API/include/LeaWeiXinClient.php on line 33PHP Notice: curl_setopt(): CURLOPT_SSL_VERIFYHOST no longer accepts the value 1, value 2 will be used instead in /usr/lib/zabbix/alertscripts/WeiXin-Private-API/include/LeaWeiXinClient.php on line 32PHP Notice: Undefined index: HTTP_USER_AGENT in /usr/lib/zabbix/alertscripts/WeiXin-Private-API/include/LeaWeiXinClient.php on line 33stdClass Object( [base_resp] =&gt; stdClass Object ( [ret] =&gt; 0 [err_msg] =&gt; ok #è¯´æ˜å·²ç»å‘é€å‡ºå»å•¦ ) )[root@Control-machine alertscripts]# #ä»¥ä¸ŠPHPçš„æç¤ºä¿¡æ¯å¯ä»¥å¿½ç•¥ æŸ¥çœ‹ç»“æœ ä¸‰ã€é…ç½®zabbix1.æ·»åŠ æŠ¥è­¦åª’ä»‹ 2.æ·»åŠ ç”¨æˆ·æŠ¥è­¦åª’ä»‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯administrator 3.æ·»åŠ æŠ¥è­¦åŠ¨ä½œ ä¿¡æ¯å¦‚ä¸‹ ä¿®æ”¹æ“ä½œæ¡ä»¶ï¼Œä¿æŒé»˜è®¤çš„ä¹Ÿå¯ä»¥ï¼› ä¿å­˜è®¾ç½® å››ã€æµ‹è¯•æˆ‘è¿™é‡Œå°†ç›‘æ§mysqlä¸»ä»çš„è„šæœ¬æ‰‹åŠ¨æ”¹ä¸€ä¸‹ï¼Œè®©å…¶zabbixæ£€æµ‹åˆ°å¹¶æŠ¥è­¦ æ‰‹æœºå¾®ä¿¡æŸ¥çœ‹æŠ¥è­¦ä¿¡æ¯ ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå…¬ä¼—å·å‘æˆ‘çš„å¾®ä¿¡å‘é€æ¶ˆæ¯è¶…è¿‡48ä¸ªå°æ—¶æˆ‘æ²¡æœ‰å›å¤ï¼Œé‚£ä¹ˆå…¬ä¼—å·å°†ä¸ä¼šä¸»åŠ¨å‘é€æ¶ˆæ¯ã€‚ç„¶åæˆ‘ä»¬åœ¨å¾®ä¿¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨æ”¶åˆ°æŠ¥è­¦é€šçŸ¥ååœ¨48ä¸ªå°æ—¶ä¹‹å†…å¯ä»¥ç®€å•çš„å›å¤ä¸€ä¸ªå­—ç¬¦ï¼Œæˆ–è€…ä¸€æ®µè¯å³å¯ å‚è€ƒæ–‡ç« é“¾æ¥ï¼š http://blog.chinaunix.net/uid-30236771-id-5037842.html","categories":[{"name":"Monitor","slug":"Monitor","permalink":"https://blog.sctux.cc/categories/Monitor/"},{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"Monitor/è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/Monitor/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[],"keywords":[{"name":"Monitor","slug":"Monitor","permalink":"https://blog.sctux.cc/categories/Monitor/"},{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"Monitor/è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/Monitor/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"Saltstackåˆ©ç”¨Returnersç¨‹åºä¿å­˜æ‰§è¡Œç»“æœåˆ°mysql","slug":"saltstack-e5-88-a9-e7-94-a8returners-e7-a8-8b-e5-ba-8f-e4-bf-9d-e5-ad-98-e6-89-a7-e8-a1-8c-e7-bb-93-e6-9e-9c-e5-88-b0mysql","date":"2015-11-19T13:03:02.000Z","updated":"2025-09-01T01:59:08.954Z","comments":true,"path":"2015/11/19/saltstack-e5-88-a9-e7-94-a8returners-e7-a8-8b-e5-ba-8f-e4-bf-9d-e5-ad-98-e6-89-a7-e8-a1-8c-e7-bb-93-e6-9e-9c-e5-88-b0mysql/","permalink":"https://blog.sctux.cc/2015/11/19/saltstack-e5-88-a9-e7-94-a8returners-e7-a8-8b-e5-ba-8f-e4-bf-9d-e5-ad-98-e6-89-a7-e8-a1-8c-e7-bb-93-e6-9e-9c-e5-88-b0mysql/","excerpt":"åœ¨æˆ‘ä»¬æ‰§è¡Œsaltstackçš„æ—¶å€™ï¼Œminionç«¯ä¼šè¿”å›ä¸€å¤§å †çš„æ‰§è¡Œç»“æœæ˜¾ç¤ºåœ¨masterç«¯ï¼Œé‚£å¦‚ä½•å°†æ¯ä¸€æ¬¡slatæ‰§è¡Œçš„ç»“æœè¿™äº›ç»“æœä¿å­˜èµ·æ¥ä¾¿äºæ—¥åæŸ¥è¯¢ï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†saltstackçš„è¿”å›ç¨‹åºReturnersï¼Œå¯ä»¥ä¿å­˜åœ¨Redisï¼ŒMongodbï¼ŒMySQLç­‰è¿™äº›ç¨‹åºå½“ä¸­ï¼› æ³¨æ„è¿™çš„è¿”å›å¹¶ä¸æ˜¯å°†æ‰§è¡Œç»“æœè¿”å›ç»™masterï¼Œmasterå†å†™å…¥åˆ°MySQLæˆ–è€…Redisä¸­ï¼Œè€Œæ˜¯salt-minionç«¯ç›´æ¥å‘MySQLæˆ–è€…Redisä¸­å†™ï¼Œ ä¸‹é¢æ˜¯æ“ä½œæ­¥éª¤ï¼š 1.å®‰è£…è½¯ä»¶åŒ… masterç«¯ï¼šyum install -y MySQL-python mysql mysql-serverminionç«¯ï¼šyum install -y MySQL-python 2.å»ºç«‹æ•°æ®åº“ï¼Œåˆ›å»ºsaltæ‰€éœ€è¦çš„æ•°æ®åº“åŠè¡¨ç»“æ„ CREATE DATABASE `salt` DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci; USE `salt`; ---- Table structure for table `jids`DROP TABLE IF EXISTS `jids`;CREATE TABLE `jids` ( `jid` varchar(255) NOT NULL, `load` mediumtext NOT NULL, UNIQUE KEY `jid` (`jid`)) ENGINE=InnoDB DEFAULT CHARSET=utf8; ---- Table structure for table `salt_returns`DROP TABLE IF EXISTS `salt_returns`;CREATE TABLE `salt_returns` ( `fun` varchar(50) NOT NULL, `jid` varchar(255) NOT NULL, `return` mediumtext NOT NULL, `id` varchar(255) NOT NULL, `success` varchar(10) NOT NULL, `full_ret` mediumtext NOT NULL, `alter_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP, KEY `id` (`id`), KEY `jid` (`jid`), KEY `fun` (`fun`)) ENGINE=InnoDB DEFAULT CHARSET=utf8; ---- Table structure for table `salt_events`","text":"åœ¨æˆ‘ä»¬æ‰§è¡Œsaltstackçš„æ—¶å€™ï¼Œminionç«¯ä¼šè¿”å›ä¸€å¤§å †çš„æ‰§è¡Œç»“æœæ˜¾ç¤ºåœ¨masterç«¯ï¼Œé‚£å¦‚ä½•å°†æ¯ä¸€æ¬¡slatæ‰§è¡Œçš„ç»“æœè¿™äº›ç»“æœä¿å­˜èµ·æ¥ä¾¿äºæ—¥åæŸ¥è¯¢ï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†saltstackçš„è¿”å›ç¨‹åºReturnersï¼Œå¯ä»¥ä¿å­˜åœ¨Redisï¼ŒMongodbï¼ŒMySQLç­‰è¿™äº›ç¨‹åºå½“ä¸­ï¼› æ³¨æ„è¿™çš„è¿”å›å¹¶ä¸æ˜¯å°†æ‰§è¡Œç»“æœè¿”å›ç»™masterï¼Œmasterå†å†™å…¥åˆ°MySQLæˆ–è€…Redisä¸­ï¼Œè€Œæ˜¯salt-minionç«¯ç›´æ¥å‘MySQLæˆ–è€…Redisä¸­å†™ï¼Œ ä¸‹é¢æ˜¯æ“ä½œæ­¥éª¤ï¼š 1.å®‰è£…è½¯ä»¶åŒ… masterç«¯ï¼šyum install -y MySQL-python mysql mysql-serverminionç«¯ï¼šyum install -y MySQL-python 2.å»ºç«‹æ•°æ®åº“ï¼Œåˆ›å»ºsaltæ‰€éœ€è¦çš„æ•°æ®åº“åŠè¡¨ç»“æ„ CREATE DATABASE `salt` DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci; USE `salt`; ---- Table structure for table `jids`DROP TABLE IF EXISTS `jids`;CREATE TABLE `jids` ( `jid` varchar(255) NOT NULL, `load` mediumtext NOT NULL, UNIQUE KEY `jid` (`jid`)) ENGINE=InnoDB DEFAULT CHARSET=utf8; ---- Table structure for table `salt_returns`DROP TABLE IF EXISTS `salt_returns`;CREATE TABLE `salt_returns` ( `fun` varchar(50) NOT NULL, `jid` varchar(255) NOT NULL, `return` mediumtext NOT NULL, `id` varchar(255) NOT NULL, `success` varchar(10) NOT NULL, `full_ret` mediumtext NOT NULL, `alter_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP, KEY `id` (`id`), KEY `jid` (`jid`), KEY `fun` (`fun`)) ENGINE=InnoDB DEFAULT CHARSET=utf8; ---- Table structure for table `salt_events`DROP TABLE IF EXISTS `salt_events`;CREATE TABLE `salt_events` (`id` BIGINT NOT NULL AUTO_INCREMENT,`tag` varchar(255) NOT NULL,`data` varchar(1024) NOT NULL,`alter_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,PRIMARY KEY (`id`),KEY `tag` (`tag`)) ENGINE=InnoDB DEFAULT CHARSET=utf8; #æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦åˆ›å»ºæˆåŠŸï¼šmysql&gt; use saltDatabase changedmysql&gt; show tables;+â€”â€”â€”â€”â€”-+| Tables_in_salt |+â€”â€”â€”â€”â€”-+| jids || salt_events || salt_returns |+â€”â€”â€”â€”â€”-+3 rows in set (0.00 sec) 3.æˆæƒæ•°æ®åº“ï¼Œä¿®æ”¹masteré…ç½® mysql &gt; grant all on salt.* to salt@â€™192.168.2.0/255.255.255.0â€™ identified by â€˜saltâ€™;mysql &gt; flush privileges; åœ¨masterç«¯æˆ–è€…æ¯ä¸ªminionç«¯éƒ½å†™å¦‚ä»¥ä¸‹é…ç½®å†…å®¹ã€‚å½“ç„¶å¦‚æœå†™åœ¨masterç«¯æ˜¯æ¯”è¾ƒç®€å•çš„åšæ³•ï¼Œå› ä¸ºåªéœ€è¦å†™ä¸€æ¬¡å°±è¡Œå•¦ã€‚æˆ‘è¿™é‡Œå†™åœ¨äº†masterç«¯ã€‚ [root@saltstack-node1 ~]# vim /etc/salt/masterreturn: mysqlmysql.host: â€˜192.168.2.21â€™#mysql æ•°æ®åº“æœåŠ¡å™¨åœ°å€mysql.user: â€˜saltâ€™mysql.pass: â€˜saltâ€™mysql.db: â€˜saltâ€™mysql.port: 3306 4.æ‰§è¡Œè¯­å¥æµ‹è¯•ï¼š","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"ELK+Kafka ä¼ä¸šæ—¥å¿—æ”¶é›†å¹³å°(äºŒ)","slug":"elkkafka-e4-bc-81-e4-b8-9a-e6-97-a5-e5-bf-97-e6-94-b6-e9-9b-86-e5-b9-b3-e5-8f-b0-e4-ba-8c","date":"2015-11-14T08:49:57.000Z","updated":"2025-09-01T01:59:08.879Z","comments":true,"path":"2015/11/14/elkkafka-e4-bc-81-e4-b8-9a-e6-97-a5-e5-bf-97-e6-94-b6-e9-9b-86-e5-b9-b3-e5-8f-b0-e4-ba-8c/","permalink":"https://blog.sctux.cc/2015/11/14/elkkafka-e4-bc-81-e4-b8-9a-e6-97-a5-e5-bf-97-e6-94-b6-e9-9b-86-e5-b9-b3-e5-8f-b0-e4-ba-8c/","excerpt":"ä¸Šç¯‡åšæ–‡ä¸»è¦æ€»ç»“äº†ä¸€ä¸‹elkã€åŸºäºkafkaçš„zookeeperé›†ç¾¤æ­å»ºï¼Œä»¥åŠç³»ç»Ÿæ—¥å¿—é€šè¿‡zookeeperé›†ç¾¤è¾¾åˆ°æˆ‘ä»¬é›†ç¾¤çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç€ä¸‹é¢è¿™ä¸ªæœªå®Œæˆçš„å‡ ä¸ªä¸»é¢˜ 4.Kibanaéƒ¨ç½²; 5.Nginxè´Ÿè½½å‡è¡¡Kibanaè¯·æ±‚; 6.æ¡ˆä¾‹ï¼šnginxæ—¥å¿—æ”¶é›†ä»¥åŠMySQLæ…¢æ—¥å¿—æ”¶é›†; 7.KibanaæŠ¥è¡¨åŸºæœ¬ä½¿ç”¨; &nbsp; Kibanaçš„éƒ¨ç½²;Kibanaçš„ä½œç”¨ï¼Œæƒ³å¿…å¤§å®¶éƒ½çŸ¥é“äº†å°±æ˜¯ä¸€ä¸ªå±•ç¤ºå·¥å…·ï¼ŒæŠ¥è¡¨å†…å®¹éå¸¸çš„ä¸°å¯Œï¼› ä¸‹é¢æˆ‘ä»¬åœ¨ä¸¤å°esä¸Šé¢æ­å»ºä¸¤å¥—kibana 1.è·å–kibanaè½¯ä»¶åŒ… [root@es1 ~]# wget https://download.elastic.co/kibana/kibana/kibana-4.1.2-linux-x64.tar.gz[root@es1 ~]# tar -xf kibana-4.2.0-linux-x64.tar.gz -C /usr/local/ 2.ä¿®æ”¹é…ç½®æ–‡ä»¶ [root@es1 ~]# cd /usr/local/[root@es1 local]# ln -sv kibana-4.1.2-linux-x64 kibana`kibanaâ€™ -&gt; `kibana-4.2.0-linux-x64â€™[root@es1 local]# cd kibana [root@es1 kibana]# vim config/kibana.ymlserver.port: 5601 #é»˜è®¤ç«¯å£å¯ä»¥ä¿®æ”¹çš„server.host: â€œ0.0.0.0â€ #kibanaç›‘å¬çš„ipelasticsearch.url: â€œhttp://localhost:9200â€œ #ç”±äºesåœ¨æœ¬åœ°ä¸»æœºä¸Šé¢ï¼Œæ‰€ä»¥è¿™ä¸ªé€‰é¡¹æ‰“å¼€æ³¨é‡Šå³å¯ 3.æä¾›kibanaæœåŠ¡ç®¡ç†è„šæœ¬ï¼Œæˆ‘è¿™é‡Œå†™äº†ä¸ªç›¸å¯¹ç®€å•çš„è„šæœ¬ [root@es1 config]# cat /etc/init.d/kibana#!/bin/bash#chkconfig: 2345 55 24#description: kibana service manager KIBBIN=â€™/usr/local/kibana/bin/kibanaâ€™LOCK=â€™/usr/local/kibana/locksâ€™","text":"ä¸Šç¯‡åšæ–‡ä¸»è¦æ€»ç»“äº†ä¸€ä¸‹elkã€åŸºäºkafkaçš„zookeeperé›†ç¾¤æ­å»ºï¼Œä»¥åŠç³»ç»Ÿæ—¥å¿—é€šè¿‡zookeeperé›†ç¾¤è¾¾åˆ°æˆ‘ä»¬é›†ç¾¤çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç€ä¸‹é¢è¿™ä¸ªæœªå®Œæˆçš„å‡ ä¸ªä¸»é¢˜ 4.Kibanaéƒ¨ç½²; 5.Nginxè´Ÿè½½å‡è¡¡Kibanaè¯·æ±‚; 6.æ¡ˆä¾‹ï¼šnginxæ—¥å¿—æ”¶é›†ä»¥åŠMySQLæ…¢æ—¥å¿—æ”¶é›†; 7.KibanaæŠ¥è¡¨åŸºæœ¬ä½¿ç”¨; &nbsp; Kibanaçš„éƒ¨ç½²;Kibanaçš„ä½œç”¨ï¼Œæƒ³å¿…å¤§å®¶éƒ½çŸ¥é“äº†å°±æ˜¯ä¸€ä¸ªå±•ç¤ºå·¥å…·ï¼ŒæŠ¥è¡¨å†…å®¹éå¸¸çš„ä¸°å¯Œï¼› ä¸‹é¢æˆ‘ä»¬åœ¨ä¸¤å°esä¸Šé¢æ­å»ºä¸¤å¥—kibana 1.è·å–kibanaè½¯ä»¶åŒ… [root@es1 ~]# wget https://download.elastic.co/kibana/kibana/kibana-4.1.2-linux-x64.tar.gz[root@es1 ~]# tar -xf kibana-4.2.0-linux-x64.tar.gz -C /usr/local/ 2.ä¿®æ”¹é…ç½®æ–‡ä»¶ [root@es1 ~]# cd /usr/local/[root@es1 local]# ln -sv kibana-4.1.2-linux-x64 kibana`kibanaâ€™ -&gt; `kibana-4.2.0-linux-x64â€™[root@es1 local]# cd kibana [root@es1 kibana]# vim config/kibana.ymlserver.port: 5601 #é»˜è®¤ç«¯å£å¯ä»¥ä¿®æ”¹çš„server.host: â€œ0.0.0.0â€ #kibanaç›‘å¬çš„ipelasticsearch.url: â€œhttp://localhost:9200â€œ #ç”±äºesåœ¨æœ¬åœ°ä¸»æœºä¸Šé¢ï¼Œæ‰€ä»¥è¿™ä¸ªé€‰é¡¹æ‰“å¼€æ³¨é‡Šå³å¯ 3.æä¾›kibanaæœåŠ¡ç®¡ç†è„šæœ¬ï¼Œæˆ‘è¿™é‡Œå†™äº†ä¸ªç›¸å¯¹ç®€å•çš„è„šæœ¬ [root@es1 config]# cat /etc/init.d/kibana#!/bin/bash#chkconfig: 2345 55 24#description: kibana service manager KIBBIN=â€™/usr/local/kibana/bin/kibanaâ€™LOCK=â€™/usr/local/kibana/locksâ€™ START() { if [ -f $LOCK ];then echo -e â€œkibana is already \\033[32mrunning\\033[0m, do nothing.â€ else echo -e â€œStart kibana service.\\033[32mdone\\033[mâ€ cd /usr/local/kibana/bin nohup ./kibana &amp; &gt;/dev/null touch $LOCK fi} STOP() { if [ ! -f $LOCK ];then echo -e â€œkibana is already stop, do nothing.â€ else echo -e â€œStop kibana serivce \\033[32mdone\\033[mâ€ rm -rf $LOCK ps -ef | grep kibana | grep -v â€œgrepâ€ | awk â€˜{print $2}â€™ | xargs kill -s 9 &gt;/dev/null fi} STATUS() { Port=$(netstat -tunl | grep â€œ:5602â€) if [ â€œ$Portâ€ != â€œâ€ ] &amp;&amp; [ -f $LOCK ];then echo -e â€œkibana is: \\033[32mrunning\\033[0mâ€¦â€ else echo -e â€œkibana is: \\033[31mstopped\\033[0mâ€¦â€ fi} case â€œ$1â€ in start) START ;; stop) STOP ;; status) STATUS ;; restart) STOP sleep 2 START ;; *) echo â€œUsage: /etc/init.d/kibana (|start|stop|status|restart)â€ ;;esac 4.å¯åŠ¨kibanaæœåŠ¡ [root@es1 config]# chkconfig â€“add kibana[root@es1 config]# service kibana startStart kibana service.done[root@es1 config]# 5.æœåŠ¡æ£€æŸ¥ [root@es1 config]# ss -tunl | grep â€œ5601â€tcp LISTEN 0 511 *:5601 :[root@es1 config]# okï¼Œæ­¤æ—¶æˆ‘ç›´æ¥è®¿é—®es1è¿™å°ä¸»æœºçš„5601ç«¯å£ okï¼Œèƒ½æˆåŠŸçš„è®¿é—®5601ç«¯å£ï¼Œé‚£æˆ‘æŠŠes1è¿™å°çš„é…ç½®æ”¾åˆ°es2ä¸Šé¢å»ç„¶åå¯åŠ¨ï¼Œæ•ˆæœè·Ÿè®¿é—®es1ä¸€æ · Nginxè´Ÿè½½å‡è¡¡kibanaçš„è¯·æ±‚1.åœ¨nginx-proxyä¸Šé¢yumå®‰è£…nginx yum install -y nignx 2.ç¼–å†™é…ç½®æ–‡ä»¶es.conf [root@saltstack-node1 conf.d]# pwd/etc/nginx/conf.d[root@saltstack-node1 conf.d]# cat es.confupstream es { server 192.168.2.18:5601 max_fails=3 fail_timeout=30s; server 192.168.2.19:5601 max_fails=3 fail_timeout=30s;} server { listen 80; server_name localhost; location / { proxy_pass http://es/; index index.html index.htm; #auth auth_basic \"ELK Private\"; auth\\_basic\\_user_file /etc/nginx/.htpasswd; } } 3.åˆ›å»ºè®¤è¯ [root@saltstack-node1 conf.d]# htpasswd -cm /etc/nginx/.htpasswd elkNew password:Re-type new password:Adding password for user elk-user[root@saltstack-node1 conf.d]# /etc/init.d/nginx restartStopping nginx: [ OK ]Starting nginx: [ OK ][root@saltstack-node1 conf.d]# 4.ç›´æ¥è¾“å…¥è®¤è¯ç”¨æˆ·åŠå¯†ç å°±å¯è®¿é—®å•¦http://192.168.2.21/ NginxåŠMySQLæ…¢æ—¥å¿—æ”¶é›†é¦–å…ˆæˆ‘ä»¬åœ¨webserver1ä¸Šé¢éƒ½åˆ†åˆ«å®‰è£…äº†nginx åŠmysql. 1.ä¸ºäº†æ–¹ä¾¿nginxæ—¥å¿—çš„ç»Ÿè®¡æœç´¢ï¼Œè¿™é‡Œè®¾ç½®nginxè®¿é—®æ—¥å¿—æ ¼å¼ä¸ºjson (1)ä¿®æ”¹nginxä¸»é…ç½®æ–‡ä»¶ è¯´æ˜ï¼šå¦‚æœæƒ³å®ç°æ—¥å¿—çš„æŠ¥è¡¨å±•ç¤ºï¼Œæœ€å¥½å°†ä¸šåŠ¡æ—¥å¿—ç›´æ¥ä»¥jsonæ ¼å¼è¾“å‡ºï¼Œè¿™æ ·å¯ä»¥æå¤§å‡è½»cpuè´Ÿè½½ï¼Œä¹Ÿçœå¾—è¿ç»´éœ€è¦å†™è´Ÿè½½çš„filterè¿‡æ»¤æ­£åˆ™ã€‚ [root@webserver1 nginx]# vim nginx.conflog_format json â€˜{â€œ@timestampâ€:â€$time_iso8601â€,â€™ â€˜â€œ@versionâ€:â€1â€,â€™ â€˜â€œclientâ€:â€$remote_addrâ€,â€™ â€˜â€œurlâ€:â€$uriâ€,â€™ â€˜â€œstatusâ€:â€$statusâ€,â€™ â€˜â€œdomainâ€:â€$hostâ€,â€™ â€˜â€œhostâ€:â€$server_addrâ€,â€™ â€˜â€œsizeâ€:$body_bytes_sent,â€™ â€˜â€œresponsetimeâ€:$request_time,â€™ â€˜â€œrefererâ€: â€œ$http_refererâ€,â€™ â€˜â€œuaâ€: â€œ$http_user_agentâ€â€˜ â€˜}â€™; access_log /var/log/access_json.log json; (2)æ”¶é›†nginxæ—¥å¿—å’ŒMySQLæ—¥å¿—åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼›è¿™ä¸ªæ–‡ä»¶æˆ‘ä»¬æ˜¯å®šä¹‰åœ¨å®¢æˆ·ç«¯ï¼Œå³ç”Ÿäº§æœåŠ¡å™¨ä¸Šé¢çš„Logstashæ–‡ä»¶å“¦. æ³¨æ„ï¼šè¿™é‡Œåˆšæ­å»ºå®Œæ¯•ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•°æ®ï¼Œä¸ºäº†å±•ç¤ºæ•ˆæœï¼Œæˆ‘è¿™é‡Œå¯¼å…¥äº†çº¿ä¸Šçš„nginxå’ŒMySQLæ…¢æ—¥å¿— input { file { #ä»nginxæ—¥å¿—è¯»å…¥ type =&gt; â€œnginx-accessâ€ path =&gt; â€œ/var/log/nginx/access.logâ€ start_position =&gt; â€œbeginningâ€ codec =&gt; â€œjsonâ€ #è¿™é‡ŒæŒ‡å®š codecæ ¼å¼ä¸ºjson } file { #ä»MySQLæ…¢æ—¥å¿—è¯»å…¥ type =&gt; â€œslow-mysqlâ€ path =&gt; â€œ/var/log/mysql/slow-mysql.logâ€ start_position =&gt; â€œbeginningâ€ codec =&gt; multiline { #è¿™é‡Œç”¨åˆ°äº†logstashçš„æ’ä»¶åŠŸèƒ½ï¼Œå°†æœ¬æ¥å±äºä¸€è¡Œçš„å¤šè¡Œæ—¥å¿—æ¡ç›®æ•´åˆåœ¨ä¸€èµ·ï¼Œè®©ä»–å±äºä¸€æ¡ pattern =&gt; â€œ^# User@Hostâ€ #ç”¨åˆ°äº†æ­£åˆ™å»åŒ¹é… negate =&gt; true what =&gt; â€œpreviousâ€ } }} output {# stdout { codec=&gt; rubydebug } if [type] == â€œnginx-accessâ€ { #é€šè¿‡åˆ¤æ–­inputä¸­å®šä¹‰çš„typeï¼Œæ¥è®©å®ƒåœ¨kafkaé›†ç¾¤ä¸­ç”Ÿæˆçš„ä¸»é¢˜åç§° kafka { #è¾“å‡ºåˆ°kafkaé›†ç¾¤ bootstrap_servers =&gt; â€œ192.168.2.22:9092,192.168.2.23:9092,192.168.2.24:9092â€ #ç”Ÿäº§è€…ä»¬ topic_id =&gt; â€œnginx-accessâ€ #ä¸»é¢˜åç§° compression_type =&gt; â€œsnappyâ€ #å‹ç¼©ç±»å‹ } } if [type] == â€œslow-mysqlâ€ { kafka { bootstrap_servers =&gt; â€œ192.168.2.22:9092,192.168.2.23:9092,192.168.2.24:9092â€ topic_id =&gt; â€œslow-mysqlâ€ compression_type =&gt; â€œsnappyâ€ } }} (3)Logstash ä»kafkaé›†ç¾¤ä¸­è¯»å–æ—¥å¿—å­˜å‚¨åˆ°esä¸­ï¼Œè¿™é‡Œçš„å®šä¹‰logstashæ–‡ä»¶æ˜¯åœ¨ä¸‰å°kafkaæœåŠ¡å™¨ä¸Šé¢çš„å“¦ï¼Œå¹¶ä¸”è¦ä¿æŒä¸€è‡´ï¼Œä½ å¯ä»¥åœ¨ä¸€å°ä¸Šé¢ä¿®æ”¹æµ‹è¯•å¥½ä¹‹åï¼Œæ‹·è´è‡³å¦å¤–ä¸¤å°å³å¯ã€‚ input { kafka { zk_connect =&gt; â€œ192.168.2.22:2181,192.168.2.23:2181,192.168.2.24:2181â€ type =&gt; â€œnginx-accessâ€ topic_id =&gt; â€œnginx-accessâ€ codec =&gt; plain reset_beginning =&gt; false consumer_threads =&gt; 5 decorate_events =&gt; true } kafka { zk_connect =&gt; â€œ192.168.2.22:2181,192.168.2.23:2181,192.168.2.24:2181â€ type =&gt; â€œslow-mysqlâ€ topic_id =&gt; â€œslow-mysqlâ€ codec =&gt; plain reset_beginning =&gt; false consumer_threads =&gt; 5 decorate_events =&gt; true }} output {# stdout { codec=&gt; rubydebug } if [type] == â€œnginx-accessâ€ { elasticsearch { hosts =&gt; [â€œ192.168.2.18:9200â€,â€192.168.2.19:9200â€] index =&gt; â€œnginx-access-%{+YYYY-MM}â€ } } if [type] == â€œslow-mysqlâ€ { elasticsearch { hosts =&gt; [â€œ192.168.2.18:9200â€,â€192.168.2.19:9200â€] index =&gt; â€œslow-mysql-%{+YYYY-MM}â€ } }} é€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œnginxæ—¥å¿—ä»¥åŠMySQLæ…¢æ—¥å¿—å·²ç»æˆåŠŸæŠµè¾¾esé›†ç¾¤ ç„¶åæˆ‘ä»¬åœ¨kibanaä¸Šé¢åˆ›å»ºç´¢å¼•å°±å¯ä»¥å•¦ (4)åˆ›å»ºnginx-access æ—¥å¿—ç´¢å¼• æ­¤æ—¶å°±å¯ä»¥çœ‹åˆ°ç´¢å¼•å•¦ (5)åˆ›å»ºMySQLæ…¢æ—¥å¿—ç´¢å¼• p MySQLçš„ç´¢å¼•ä¹Ÿå‡ºæ¥å•¦ KibanaæŠ¥è¡¨å±•ç¤º kibanaæŠ¥è¡¨åŠŸèƒ½éå¸¸çš„å¼ºå¤§ï¼Œä¹Ÿå°±æ˜¯å¯è§†åŒ–ï¼›å¯ä»¥åˆ¶ä½œå‡ºä¸‹é¢ä¸åŒç±»å‹çš„å›¾å½¢ ä¸‹é¢å°±æ˜¯æˆ‘ç®€å•çš„ä¸€äº›å›¾å½¢å±•ç¤º ç”±äºç¯‡å¹…é—®é¢˜ï¼Œå¯ä»¥çœ‹å®˜æ–¹ä»‹ç»ã€‚ å‚è€ƒï¼š https://github.com/liquanzhou/ops_doc/tree/master/Service/kafka http://www.lujinhong.com/kafka%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97.html http://www.it165.net/admin/html/201405/3192.html http://blog.csdn.net/lizhitao/article/details/39499283 https://taoistwar.gitbooks.io/spark-operationand-maintenance-management/content/spark_relate_software/zookeeper_install.html","categories":[{"name":"Monitor","slug":"Monitor","permalink":"https://blog.sctux.cc/categories/Monitor/"},{"name":"Other","slug":"Monitor/Other","permalink":"https://blog.sctux.cc/categories/Monitor/Other/"},{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"Monitor/Other/è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/Monitor/Other/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://blog.sctux.cc/tags/ELK/"},{"name":"kafka","slug":"kafka","permalink":"https://blog.sctux.cc/tags/kafka/"},{"name":"zookeeper","slug":"zookeeper","permalink":"https://blog.sctux.cc/tags/zookeeper/"}],"keywords":[{"name":"Monitor","slug":"Monitor","permalink":"https://blog.sctux.cc/categories/Monitor/"},{"name":"Other","slug":"Monitor/Other","permalink":"https://blog.sctux.cc/categories/Monitor/Other/"},{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"Monitor/Other/è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/Monitor/Other/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"ELK+Kafka ä¼ä¸šæ—¥å¿—æ”¶é›†å¹³å°(ä¸€)","slug":"elkkafka-e4-bc-81-e4-b8-9a-e6-97-a5-e5-bf-97-e6-94-b6-e9-9b-86-e5-b9-b3-e5-8f-b0-e4-b8-80","date":"2015-11-14T08:48:45.000Z","updated":"2025-09-01T01:59:08.877Z","comments":true,"path":"2015/11/14/elkkafka-e4-bc-81-e4-b8-9a-e6-97-a5-e5-bf-97-e6-94-b6-e9-9b-86-e5-b9-b3-e5-8f-b0-e4-b8-80/","permalink":"https://blog.sctux.cc/2015/11/14/elkkafka-e4-bc-81-e4-b8-9a-e6-97-a5-e5-bf-97-e6-94-b6-e9-9b-86-e5-b9-b3-e5-8f-b0-e4-b8-80/","excerpt":"èƒŒæ™¯ï¼šæœ€è¿‘çº¿ä¸Šä¸Šäº†ELKï¼Œä½†æ˜¯åªç”¨äº†ä¸€å°Redisåœ¨ä¸­é—´ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»¥å‡è½»å‰ç«¯esé›†ç¾¤çš„å‹åŠ›ï¼ŒRedisçš„é›†ç¾¤è§£å†³æ–¹æ¡ˆæš‚æ—¶æ²¡æœ‰æ¥è§¦è¿‡ï¼Œå¹¶ä¸”Redisä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—å¹¶ä¸æ˜¯å®ƒçš„å¼ºé¡¹ï¼›æ‰€ä»¥æœ€è¿‘å°†Redisæ¢æˆäº†ä¸“ä¸šçš„æ¶ˆæ¯ä¿¡æ¯å‘å¸ƒè®¢é˜…ç³»ç»ŸKafka, Kafkaçš„æ›´å¤šä»‹ç»å¤§å®¶å¯ä»¥çœ‹è¿™é‡Œï¼šä¼ é€é—¨&nbsp; ,å…³äºELKçš„çŸ¥è¯†ç½‘ä¸Šæœ‰å¾ˆå¤šçš„å“¦ï¼Œ&nbsp;æ­¤ç¯‡åšå®¢ä¸»è¦æ˜¯æ€»ç»“ä¸€ä¸‹ç›®å‰çº¿ä¸Šè¿™ä¸ªå¹³å°çš„å®æ–½æ­¥éª¤ï¼ŒELKæ˜¯æ€ä¹ˆè·ŸKafkaç»“åˆèµ·æ¥çš„ã€‚å¥½å§ï¼ŒåŠ¨æ‰‹ï¼ ELKæ¶æ„æ‹“æ‰‘ï¼šç„¶è€Œæˆ‘è¿™é‡Œçš„æ•´ä¸ªæ—¥å¿—æ”¶é›†å¹³å°å°±æ˜¯è¿™æ ·çš„æ‹“æ‰‘ï¼š 1ï¼Œä½¿ç”¨ä¸€å°Nginxä»£ç†è®¿é—®kibanaçš„è¯·æ±‚; 2ï¼Œä¸¤å°esç»„æˆesé›†ç¾¤ï¼Œå¹¶ä¸”åœ¨ä¸¤å°esä¸Šé¢éƒ½å®‰è£…kibana;ï¼ˆä»¥ä¸‹å¯¹elasticsearchç®€ç§°esï¼‰ 3ï¼Œä¸­é—´ä¸‰å°æœåŠ¡å™¨å°±æ˜¯æˆ‘çš„kafka(zookeeper)é›†ç¾¤å•¦; ä¸Šé¢å†™çš„æ¶ˆè´¹è€…/ç”Ÿäº§è€…è¿™æ˜¯kafka(zookeeper)ä¸­çš„æ¦‚å¿µ; 4ï¼Œæœ€åé¢çš„å°±æ˜¯ä¸€å¤§å †çš„ç”Ÿäº§æœåŠ¡å™¨å•¦ï¼Œä¸Šé¢ä½¿ç”¨çš„æ˜¯logstashï¼Œå½“ç„¶é™¤äº†logstashä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–çš„å·¥å…·æ¥æ”¶é›†ä½ çš„åº”ç”¨ç¨‹åºçš„æ—¥å¿—ï¼Œä¾‹å¦‚ï¼šFlumeï¼ŒScribeï¼ŒRsyslogï¼ŒScriptsâ€¦â€¦ è§’è‰²ï¼š è½¯ä»¶é€‰ç”¨ï¼š elasticsearch-1.7.3.tar.gz #è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œå‰å‡ å¤©ä½¿ç”¨äº†æœ€æ–°çš„elasticsearch2.0ï¼Œjava-1.8.0æŠ¥é”™ï¼Œç›®å‰æœªæ‰¾åˆ°åŸå› ï¼Œæ•…è¿™é‡Œä½¿ç”¨1.7.3ç‰ˆæœ¬Logstash-2.0.0.tar.gzkibana-4.1.2-linux-x64.tar.gzä»¥ä¸Šè½¯ä»¶éƒ½å¯ä»¥ä»å®˜ç½‘ä¸‹è½½:https://www.elastic.co/downloads java-1.8.0ï¼Œnginxé‡‡ç”¨yumå®‰è£… éƒ¨ç½²æ­¥éª¤ï¼š 1.ESé›†ç¾¤å®‰è£…é…ç½®; 2.Logstashå®¢æˆ·ç«¯é…ç½®(ç›´æ¥å†™å…¥æ•°æ®åˆ°ESé›†ç¾¤ï¼Œå†™å…¥ç³»ç»Ÿmessagesæ—¥å¿—); 3.Kafka(zookeeper)é›†ç¾¤é…ç½®;(Logstashå†™å…¥æ•°æ®åˆ°Kafkaæ¶ˆæ¯ç³»ç»Ÿ); 4.Kibanaéƒ¨ç½²; 5.Nginxè´Ÿè½½å‡è¡¡Kibanaè¯·æ±‚; 6.æ¡ˆä¾‹ï¼šnginxæ—¥å¿—æ”¶é›†ä»¥åŠMySQLæ…¢æ—¥å¿—æ”¶é›†; 7.KibanaæŠ¥è¡¨åŸºæœ¬ä½¿ç”¨; ESé›†ç¾¤å®‰è£…é…ç½®;es1.example.com: 1.å®‰è£…java-1.8.0ä»¥åŠä¾èµ–åŒ… yum install -y epel-releaseyum install -y java-1.8.0 git wget lrzsz","text":"èƒŒæ™¯ï¼šæœ€è¿‘çº¿ä¸Šä¸Šäº†ELKï¼Œä½†æ˜¯åªç”¨äº†ä¸€å°Redisåœ¨ä¸­é—´ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»¥å‡è½»å‰ç«¯esé›†ç¾¤çš„å‹åŠ›ï¼ŒRedisçš„é›†ç¾¤è§£å†³æ–¹æ¡ˆæš‚æ—¶æ²¡æœ‰æ¥è§¦è¿‡ï¼Œå¹¶ä¸”Redisä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—å¹¶ä¸æ˜¯å®ƒçš„å¼ºé¡¹ï¼›æ‰€ä»¥æœ€è¿‘å°†Redisæ¢æˆäº†ä¸“ä¸šçš„æ¶ˆæ¯ä¿¡æ¯å‘å¸ƒè®¢é˜…ç³»ç»ŸKafka, Kafkaçš„æ›´å¤šä»‹ç»å¤§å®¶å¯ä»¥çœ‹è¿™é‡Œï¼šä¼ é€é—¨&nbsp; ,å…³äºELKçš„çŸ¥è¯†ç½‘ä¸Šæœ‰å¾ˆå¤šçš„å“¦ï¼Œ&nbsp;æ­¤ç¯‡åšå®¢ä¸»è¦æ˜¯æ€»ç»“ä¸€ä¸‹ç›®å‰çº¿ä¸Šè¿™ä¸ªå¹³å°çš„å®æ–½æ­¥éª¤ï¼ŒELKæ˜¯æ€ä¹ˆè·ŸKafkaç»“åˆèµ·æ¥çš„ã€‚å¥½å§ï¼ŒåŠ¨æ‰‹ï¼ ELKæ¶æ„æ‹“æ‰‘ï¼šç„¶è€Œæˆ‘è¿™é‡Œçš„æ•´ä¸ªæ—¥å¿—æ”¶é›†å¹³å°å°±æ˜¯è¿™æ ·çš„æ‹“æ‰‘ï¼š 1ï¼Œä½¿ç”¨ä¸€å°Nginxä»£ç†è®¿é—®kibanaçš„è¯·æ±‚; 2ï¼Œä¸¤å°esç»„æˆesé›†ç¾¤ï¼Œå¹¶ä¸”åœ¨ä¸¤å°esä¸Šé¢éƒ½å®‰è£…kibana;ï¼ˆä»¥ä¸‹å¯¹elasticsearchç®€ç§°esï¼‰ 3ï¼Œä¸­é—´ä¸‰å°æœåŠ¡å™¨å°±æ˜¯æˆ‘çš„kafka(zookeeper)é›†ç¾¤å•¦; ä¸Šé¢å†™çš„æ¶ˆè´¹è€…/ç”Ÿäº§è€…è¿™æ˜¯kafka(zookeeper)ä¸­çš„æ¦‚å¿µ; 4ï¼Œæœ€åé¢çš„å°±æ˜¯ä¸€å¤§å †çš„ç”Ÿäº§æœåŠ¡å™¨å•¦ï¼Œä¸Šé¢ä½¿ç”¨çš„æ˜¯logstashï¼Œå½“ç„¶é™¤äº†logstashä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–çš„å·¥å…·æ¥æ”¶é›†ä½ çš„åº”ç”¨ç¨‹åºçš„æ—¥å¿—ï¼Œä¾‹å¦‚ï¼šFlumeï¼ŒScribeï¼ŒRsyslogï¼ŒScriptsâ€¦â€¦ è§’è‰²ï¼š è½¯ä»¶é€‰ç”¨ï¼š elasticsearch-1.7.3.tar.gz #è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œå‰å‡ å¤©ä½¿ç”¨äº†æœ€æ–°çš„elasticsearch2.0ï¼Œjava-1.8.0æŠ¥é”™ï¼Œç›®å‰æœªæ‰¾åˆ°åŸå› ï¼Œæ•…è¿™é‡Œä½¿ç”¨1.7.3ç‰ˆæœ¬Logstash-2.0.0.tar.gzkibana-4.1.2-linux-x64.tar.gzä»¥ä¸Šè½¯ä»¶éƒ½å¯ä»¥ä»å®˜ç½‘ä¸‹è½½:https://www.elastic.co/downloads java-1.8.0ï¼Œnginxé‡‡ç”¨yumå®‰è£… éƒ¨ç½²æ­¥éª¤ï¼š 1.ESé›†ç¾¤å®‰è£…é…ç½®; 2.Logstashå®¢æˆ·ç«¯é…ç½®(ç›´æ¥å†™å…¥æ•°æ®åˆ°ESé›†ç¾¤ï¼Œå†™å…¥ç³»ç»Ÿmessagesæ—¥å¿—); 3.Kafka(zookeeper)é›†ç¾¤é…ç½®;(Logstashå†™å…¥æ•°æ®åˆ°Kafkaæ¶ˆæ¯ç³»ç»Ÿ); 4.Kibanaéƒ¨ç½²; 5.Nginxè´Ÿè½½å‡è¡¡Kibanaè¯·æ±‚; 6.æ¡ˆä¾‹ï¼šnginxæ—¥å¿—æ”¶é›†ä»¥åŠMySQLæ…¢æ—¥å¿—æ”¶é›†; 7.KibanaæŠ¥è¡¨åŸºæœ¬ä½¿ç”¨; ESé›†ç¾¤å®‰è£…é…ç½®;es1.example.com: 1.å®‰è£…java-1.8.0ä»¥åŠä¾èµ–åŒ… yum install -y epel-releaseyum install -y java-1.8.0 git wget lrzsz 2.è·å–esè½¯ä»¶åŒ… wget https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-1.7.3.tar.gztar -xf elasticsearch-1.7.3.tar.gz -C /usr/localln -sv /usr/local/elasticsearch-1.7.3 /usr/local/elasticsearch 3.ä¿®æ”¹é…ç½®æ–‡ä»¶ [root@es1 ~]# vim /usr/local/elasticsearch/config/elasticsearch.yml32 cluster.name: es-cluster #ç»„æ’­çš„åç§°åœ°å€40 node.name: â€œes-node1 â€œ #èŠ‚ç‚¹åç§°ï¼Œä¸èƒ½å’Œå…¶ä»–èŠ‚ç‚¹é‡å¤47 node.master: true #èŠ‚ç‚¹èƒ½å¦è¢«é€‰ä¸¾ä¸ºmaster51 node.data: true #èŠ‚ç‚¹æ˜¯å¦å­˜å‚¨æ•°æ®107 index.number_of_shards: 5 #ç´¢å¼•åˆ†ç‰‡çš„ä¸ªæ•°111 index.number_of_replicas: 1 #åˆ†ç‰‡çš„å‰¯æœ¬ä¸ªæ•°145 path.conf: /usr/local/elasticsearch/config/ #é…ç½®æ–‡ä»¶çš„è·¯å¾„149 path.data: /data/es/data #æ•°æ®ç›®å½•è·¯å¾„159 path.work: /data/es/worker #å·¥ä½œç›®å½•è·¯å¾„163 path.logs: /usr/local/elasticsearch/logs/ #æ—¥å¿—æ–‡ä»¶è·¯å¾„167 path.plugins: /data/es/plugins #æ’ä»¶è·¯å¾„184 bootstrap.mlockall: true #å†…å­˜ä¸å‘swapäº¤æ¢232 http.enabled: true #å¯ç”¨http 4.åˆ›å»ºç›¸å…³ç›®å½• mkdir /data/es/{data,worker,plugins} -p 5.è·å–esæœåŠ¡ç®¡ç†è„šæœ¬ â€‹[root@es1 ~]# git clone https://github.com/elastic/elasticsearch-servicewrapper.git[root@es1 ~]# mv elasticsearch-servicewrapper/service /usr/local/elasticsearch/bin/[root@es1 ~]# /usr/local/elasticsearch/bin/service/elasticsearch installDetected RHEL or Fedora:Installing the Elasticsearch daemon..[root@es1 ~]##è¿™æ—¶å°±ä¼šåœ¨/etc/init.d/ç›®å½•ä¸‹å®‰è£…ä¸Šesçš„ç®¡ç†è„šæœ¬å•¦ #ä¿®æ”¹å…¶é…ç½®:[root@es1 ~]#set.default.ES_HOME=/usr/local/elasticsearch #å®‰è£…è·¯å¾„set.default.ES_HEAP_SIZE=1024 #jvmå†…å­˜å¤§å°ï¼Œæ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´å³å¯ 6.å¯åŠ¨es ï¼Œå¹¶æ£€æŸ¥å…¶æœåŠ¡æ˜¯å¦æ­£å¸¸ [root@es1 ~]# netstat -nlpt | grep -E â€œ9200|â€9300tcp 0 0 0.0.0.0:9200 0.0.0.0:* LISTEN 1684/javatcp 0 0 0.0.0.0:9300 0.0.0.0:* LISTEN 1684/java è®¿é—®http://192.168.2.18:9200/ å¦‚æœå‡ºç°ä»¥ä¸‹æç¤ºä¿¡æ¯è¯´æ˜å®‰è£…é…ç½®å®Œæˆå•¦ï¼Œ 7.es1èŠ‚ç‚¹å¥½å•¦ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠç›®å½•å¤åˆ¶åˆ°es2 [root@es1 local]# scp -r elasticsearch-1.7.3 192.168.12.19:/usr/local/ [root@es2 local]# ln -sv elasticsearch-1.7.3 elasticsearch[root@es2 local]# elasticsearch/bin/service/elasticsearch install #es2åªéœ€è¦ä¿®æ”¹node.nameå³å¯ï¼Œå…¶ä»–éƒ½ä¸es1ç›¸åŒé…ç½® 8.å®‰è£…esçš„ç®¡ç†æ’ä»¶ eså®˜æ–¹æä¾›ä¸€ä¸ªç”¨äºç®¡ç†esçš„æ’ä»¶ï¼Œå¯æ¸…æ™°ç›´è§‚çœ‹åˆ°esé›†ç¾¤çš„çŠ¶æ€ï¼Œä»¥åŠå¯¹é›†ç¾¤çš„æ“ä½œç®¡ç†ï¼Œå®‰è£…æ–¹æ³•å¦‚ä¸‹ï¼š [root@es1 local]# /usr/local/elasticsearch/bin/plugin -i mobz/elasticsearch-head å®‰è£…å¥½ä¹‹åï¼Œè®¿é—®æ–¹å¼ä¸ºï¼š http://192.168.2.18:9200/_plugin/headï¼Œç”±äºé›†ç¾¤ä¸­ç°åœ¨æš‚æ—¶æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥æ˜¾ç¤ºä¸ºç©º, &nbsp; &nbsp; &nbsp; æ­¤æ—¶ï¼Œesé›†ç¾¤çš„éƒ¨ç½²å®Œæˆã€‚ Logstashå®¢æˆ·ç«¯å®‰è£…é…ç½®;åœ¨webserve1ä¸Šé¢å®‰è£…Logstassh 1.downloads &nbsp;è½¯ä»¶åŒ… ï¼Œè¿™é‡Œæ³¨æ„ï¼ŒLogstashæ˜¯éœ€è¦ä¾èµ–javaç¯å¢ƒçš„ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯éœ€è¦yum install -y java-1.8.0. [root@webserver1 ~]# wget https://download.elastic.co/logstash/logstash/logstash-2.0.0.tar.gz[root@webserver1 ~]# tar -xf logstash-2.0.0.tar.gz -C /usr/local[root@webserver1 ~]# cd /usr/local/[root@webserver1 local]# ln -sv logstash-2.0.0 logstash[root@webserver1 local]# mkdir logs etc 2.æä¾›logstashç®¡ç†è„šæœ¬ï¼Œå…¶ä¸­é‡Œé¢çš„é…ç½®è·¯å¾„å¯æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ #!/bin/bash#chkconfig: 2345 55 24#description: logstash service manager#auto: Maoqiu GuoFILE=â€™/usr/local/logstash/etc/*.confâ€™ #logstashé…ç½®æ–‡ä»¶LOGBIN=â€™/usr/local/logstash/bin/logstash agent â€“verbose â€“configâ€™ #æŒ‡å®šlogstashé…ç½®æ–‡ä»¶çš„å‘½ä»¤LOCK=â€™/usr/local/logstash/locksâ€™ #ç”¨é”æ–‡ä»¶é…åˆæœåŠ¡å¯åŠ¨ä¸å…³é—­LOGLOG=â€™â€“log /usr/local/logstash/logs/stdou.logâ€™ #æ—¥å¿— START() { if [ -f $LOCK ];then echo -e â€œLogstash is already \\033[32mrunning\\033[0m, do nothing.â€ else echo -e â€œStart logstash service.\\033[32mdone\\033[mâ€ nohup ${LOGBIN} ${FILE} ${LOGLOG} &amp; touch $LOCK fi} STOP() { if [ ! -f $LOCK ];then echo -e â€œLogstash is already stop, do nothing.â€ else echo -e â€œStop logstash serivce \\033[32mdone\\033[mâ€ rm -rf $LOCK ps -ef | grep logstash | grep -v â€œgrepâ€ | awk â€˜{print $2}â€™ | xargs kill -s 9 &gt;/dev/null fi} STATUS() { ps aux | grep logstash | grep -v â€œgrepâ€ &gt;/dev/null if [ -f $LOCK ] &amp;&amp; [ $? -eq 0 ]; then echo -e â€œLogstash is: \\033[32mrunning\\033[0mâ€¦â€ else echo -e â€œLogstash is: \\033[31mstopped\\033[0mâ€¦â€ fi} TEST(){ ${LOGBIN} ${FILE} â€“configtest} case â€œ$1â€ in start) START ;; stop) STOP ;; status) STATUS ;; restart) STOP sleep 2 START ;; test) TEST ;; *) echo â€œUsage: /etc/init.d/logstash (test|start|stop|status|restart)â€ ;;esac 3.Logstash å‘esé›†ç¾¤å†™æ•°æ® (1)ç¼–å†™ä¸€ä¸ªlogstashé…ç½®æ–‡ä»¶ [root@webserver1 etc]# cat logstash.confinput { #æ•°æ®çš„è¾“å…¥ä»æ ‡å‡†è¾“å…¥ stdin {}} output { #æ•°æ®çš„è¾“å‡ºæˆ‘ä»¬æŒ‡å‘äº†esé›†ç¾¤ elasticsearch { hosts =&gt; [â€œ192.168.2.18:9200â€,â€192.168.2.19:9200â€] ï¼ƒesä¸»æœºçš„ipåŠç«¯å£ }}[root@webserver1 etc]# (2)æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™ [root@webserver1 etc]# /usr/local/logstash/bin/logstash -f logstash.conf â€“configtest â€“verboseConfiguration OK[root@webserver1 etc]# (3)æ—¢ç„¶é…ç½®okæˆ‘ä»¬æ‰‹åŠ¨å¯åŠ¨å®ƒï¼Œç„¶åå†™ç‚¹ä¸œè¥¿çœ‹èƒ½å¦å†™åˆ°es ok.ä¸Šå›¾å·²ç»çœ‹åˆ°logstashå·²ç»å¯ä»¥æ­£å¸¸çš„å·¥ä½œå•¦. ï¼”.ä¸‹é¢æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•æ”¶é›†ç³»ç»Ÿæ—¥å¿— å°†ä¹‹å‰çš„é…ç½®æ–‡ä»¶ä¿®æ”¹å¦‚ä¸‹æ‰€ç¤ºå†…å®¹ï¼Œç„¶åå¯åŠ¨logstashæœåŠ¡å°±å¯ä»¥åœ¨webé¡µé¢ä¸­çœ‹åˆ°messagesçš„æ—¥å¿—å†™å…¥esï¼Œå¹¶ä¸”åˆ›å»ºäº†ä¸€æ¡ç´¢å¼• [root@webserver1 etc]# cat logstash.confinput { #è¿™é‡Œçš„è¾“å…¥ä½¿ç”¨çš„æ–‡ä»¶ï¼Œå³æ—¥å¿—æ–‡ä»¶messsages file { path =&gt; â€œ/var/log/messagesâ€ ï¼ƒè¿™æ˜¯æ—¥å¿—æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ start_position =&gt; â€œbeginningâ€ ï¼ƒè¿™ä¸ªè¡¨ç¤ºä»messagesçš„ç¬¬ä¸€è¡Œè¯»å–ï¼Œå³æ–‡ä»¶å¼€å§‹å¤„ }} output { ï¼ƒè¾“å‡ºåˆ°es elasticsearch { hosts =&gt; [â€œ192.168.2.18:9200â€,â€192.168.2.19:9200â€] index =&gt; â€œsystem-messages-%{+YYYY-MM}â€ ï¼ƒè¿™é‡Œå°†æŒ‰ç…§è¿™ä¸ªç´¢å¼•æ ¼å¼æ¥åˆ›å»ºç´¢å¼• }}[root@webserver1 etc]# å¯åŠ¨logstashåï¼Œæˆ‘ä»¬æ¥çœ‹headè¿™ä¸ªæ’ä»¶çš„webé¡µé¢ okï¼Œç³»ç»Ÿæ—¥å¿—æˆ‘ä»¬å·²ç»æˆåŠŸçš„æ”¶é›†ï¼Œå¹¶ä¸”å·²ç»å†™å…¥åˆ°esé›†ç¾¤ä¸­ï¼Œé‚£ä¸Šé¢çš„æ¼”ç¤ºæ˜¯logstashç›´æ¥å°†æ—¥å¿—å†™å…¥åˆ°esé›†ç¾¤ä¸­çš„ï¼Œè¿™ç§åœºåˆæˆ‘è§‰å¾—å¦‚æœé‡ä¸æ˜¯å¾ˆå¤§çš„è¯ç›´æ¥åƒä¸Šé¢å·²å°†å°†è¾“å‡ºoutputå®šä¹‰åˆ°esé›†ç¾¤å³å¯ï¼Œå¦‚æœé‡å¤§çš„è¯éœ€è¦åŠ ä¸Šæ¶ˆæ¯é˜Ÿåˆ—æ¥ç¼“è§£esé›†ç¾¤çš„å‹åŠ›ã€‚å‰é¢å·²ç»æåˆ°äº†æˆ‘è¿™è¾¹ä¹‹å‰ä½¿ç”¨çš„æ˜¯å•å°redisä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†æ˜¯redisä¸èƒ½ä½œä¸ºlistç±»å‹çš„é›†ç¾¤ï¼Œä¹Ÿå°±æ˜¯rediså•ç‚¹çš„é—®é¢˜æ²¡æ³•è§£å†³ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘é€‰ç”¨äº†kafka ;ä¸‹é¢å°±åœ¨ä¸‰å°serverä¸Šé¢å®‰è£…kafkaé›†ç¾¤ Kafkaé›†ç¾¤å®‰è£…é…ç½®;åœ¨æ­å»ºkafkaé›†ç¾¤æ—¶ï¼Œéœ€è¦æå‰å®‰è£…zookeeperé›†ç¾¤ï¼Œå½“ç„¶kafkaå·²ç»è‡ªå¸¦zookeeperç¨‹åºåªéœ€è¦è§£å‹å¹¶ä¸”å®‰è£…é…ç½®å°±è¡Œäº† kafka1ä¸Šé¢çš„é…ç½®ï¼š 1.è·å–è½¯ä»¶åŒ….å®˜ç½‘ï¼šhttp://kafka.apache.org [root@kafka1 ~]# wget http://mirror.rise.ph/apache/kafka/0.8.2.1/kafka_2.11-0.8.2.1.tgz[root@kafka1 ~]# tar -xf kafka_2.11-0.8.2.1.tgz -C /usr/local/[root@kafka1 ~]# cd /usr/local/[root@kafka1 local]# ln -sv kafka_2.11-0.8.2.1 kafka 2.é…ç½®zookeeperé›†ç¾¤ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ [root@kafka1 ~]# vim /usr/local/kafka/config/zookeeper.propertiedataDir=/data/zookeeperclientPort=2181tickTime=2000initLimit=20syncLimit=10server.2=192.168.2.22:2888:3888server.3=192.168.2.23:2888:3888server.4=192.168.2.24:2888:3888 ï¼ƒè¯´æ˜ï¼štickTime: è¿™ä¸ªæ—¶é—´æ˜¯ä½œä¸º Zookeeper æœåŠ¡å™¨ä¹‹é—´æˆ–å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´ç»´æŒå¿ƒè·³çš„æ—¶é—´é—´éš”ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ª tickTime æ—¶é—´å°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³ã€‚2888ç«¯å£ï¼šè¡¨ç¤ºçš„æ˜¯è¿™ä¸ªæœåŠ¡å™¨ä¸é›†ç¾¤ä¸­çš„ Leader æœåŠ¡å™¨äº¤æ¢ä¿¡æ¯çš„ç«¯å£ï¼›3888ç«¯å£ï¼šè¡¨ç¤ºçš„æ˜¯ä¸‡ä¸€é›†ç¾¤ä¸­çš„ Leader æœåŠ¡å™¨æŒ‚äº†ï¼Œéœ€è¦ä¸€ä¸ªç«¯å£æ¥é‡æ–°è¿›è¡Œé€‰ä¸¾ï¼Œé€‰å‡ºä¸€ä¸ªæ–°çš„ Leaderï¼Œè€Œè¿™ä¸ªç«¯å£å°±æ˜¯ç”¨æ¥æ‰§è¡Œé€‰ä¸¾æ—¶æœåŠ¡å™¨ç›¸äº’é€šä¿¡çš„ç«¯å£ã€‚ 3.åˆ›å»ºzookeeperæ‰€éœ€è¦çš„ç›®å½• [root@kafka1 ~]# mkdir /data/zookeeper 4.åœ¨/data/zookeeperç›®å½•ä¸‹åˆ›å»ºmyidæ–‡ä»¶ï¼Œé‡Œé¢çš„å†…å®¹ä¸ºæ•°å­—ï¼Œç”¨äºæ ‡è¯†ä¸»æœºï¼Œå¦‚æœè¿™ä¸ªæ–‡ä»¶æ²¡æœ‰çš„è¯ï¼Œzookeeperæ˜¯æ²¡æ³•å¯åŠ¨çš„å“¦ [root@kafka1 ~]# echo 2 &gt; /data/zookeeper/myid ä»¥ä¸Šå°±æ˜¯zookeeperé›†ç¾¤çš„é…ç½®ï¼Œä¸‹é¢ç­‰æˆ‘é…ç½®å¥½kafkaä¹‹åç›´æ¥å¤åˆ¶åˆ°å…¶ä»–ä¸¤ä¸ªèŠ‚ç‚¹å³å¯ 5.kafkaé…ç½® [root@kafka1 ~]# vim /usr/local/kafka/config/server.propertiesbroker.id=2 ï¼ƒ å”¯ä¸€ï¼Œå¡«æ•°å­—ï¼Œæœ¬æ–‡ä¸­åˆ†åˆ«ä¸º2/3/4prot=9092 ï¼ƒ è¿™ä¸ªbrokerç›‘å¬çš„ç«¯å£ host.name=192.168.2.22 ï¼ƒ å”¯ä¸€ï¼Œå¡«æœåŠ¡å™¨IPlog.dir=/data/kafka-logs # è¯¥ç›®å½•å¯ä»¥ä¸ç”¨æå‰åˆ›å»ºï¼Œåœ¨å¯åŠ¨æ—¶è‡ªå·±ä¼šåˆ›å»ºzookeeper.connect=192.168.2.22:2181,192.168.2.23:2181,192.168.2.24:2181 ï¼ƒè¿™ä¸ªå°±æ˜¯zookeeperçš„ipåŠç«¯å£num.partitions=16 # éœ€è¦é…ç½®è¾ƒå¤§ åˆ†ç‰‡å½±å“è¯»å†™é€Ÿåº¦log.dirs=/data/kafka-logs # æ•°æ®ç›®å½•ä¹Ÿè¦å•ç‹¬é…ç½®ç£ç›˜è¾ƒå¤§çš„åœ°æ–¹log.retention.hours=168 # æ—¶é—´æŒ‰éœ€æ±‚ä¿ç•™è¿‡æœŸæ—¶é—´ é¿å…ç£ç›˜æ»¡ 6.å°†kafka(zookeeper)çš„ç¨‹åºç›®å½•å…¨éƒ¨æ‹·è´è‡³å…¶ä»–ä¸¤ä¸ªèŠ‚ç‚¹ [root@kafka1 ~]# scp -r /usr/local/kafka 192.168.2.23:/usr/local/[root@kafka1 ~]# scp -r /usr/local/kafka 192.168.2.24:/usr/local/ 7.ä¿®æ”¹ä¸¤ä¸ªå€Ÿç‚¹çš„é…ç½®ï¼Œæ³¨æ„è¿™é‡Œé™¤äº†ä»¥ä¸‹ä¸¤ç‚¹ä¸åŒå¤–ï¼Œéƒ½æ˜¯ç›¸åŒçš„é…ç½® ï¼ˆ1ï¼‰zookeeperçš„é…ç½®mkdir /data/zookeeperecho â€œxâ€ &gt; /data/zookeeper/myidï¼ˆ2ï¼‰kafkaçš„é…ç½®broker.id=2host.name=192.168.2.22 8.ä¿®æ”¹å®Œæ¯•é…ç½®ä¹‹åæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨äº†ï¼Œè¿™é‡Œå…ˆè¦å¯åŠ¨zookeeperé›†ç¾¤ï¼Œæ‰èƒ½å¯åŠ¨kafka æˆ‘ä»¬æŒ‰ç…§é¡ºåºæ¥ï¼Œkafka1 â€“&gt; kafka2 â€“&gt;kafka3 [root@kafka1 ~]# /usr/local/kafka/bin/zookeeper-server-start.sh /usr/local/kafka/config/zookeeper.properties &amp; #zookeeperå¯åŠ¨å‘½ä»¤[root@kafka1 ~]# /usr/local/kafka/bin/zookeeper-server-stop.sh #zookeeperåœæ­¢çš„å‘½ä»¤ æ³¨æ„ï¼Œå¦‚æœzookeeperæœ‰é—®é¢˜ nohupçš„æ—¥å¿—æ–‡ä»¶ä¼šéå¸¸å¤§ï¼ŒæŠŠç£ç›˜å æ»¡ï¼Œè¿™ä¸ªzookeeperæœåŠ¡å¯ä»¥é€šè¿‡è‡ªå·±äº›æœåŠ¡è„šæœ¬æ¥ç®¡ç†æœåŠ¡çš„å¯åŠ¨ä¸å…³é—­ã€‚ åé¢ä¸¤å°æ‰§è¡Œç›¸åŒæ“ä½œï¼Œåœ¨å¯åŠ¨è¿‡ç¨‹å½“ä¸­ä¼šå‡ºç°ä»¥ä¸‹æŠ¥é”™ä¿¡æ¯ [2015-11-13 19:18:04,225] WARN Cannot open channel to 3 at election address /192.168.2.23:3888 (org.apache.zookeeper.server.quorum.QuorumCnxManager)java.net.ConnectException: Connection refused at java.net.PlainSocketImpl.socketConnect(Native Method) at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350) at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206) at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188) at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392) at java.net.Socket.connect(Socket.java:589) at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368) at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:402) at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:840) at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:762)[2015-11-13 19:18:04,232] WARN Cannot open channel to 4 at election address /192.168.2.24:3888 (org.apache.zookeeper.server.quorum.QuorumCnxManager)java.net.ConnectException: Connection refused at java.net.PlainSocketImpl.socketConnect(Native Method) at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350) at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206) at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188) at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392) at java.net.Socket.connect(Socket.java:589) at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368) at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:402) at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:840) at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:762)[2015-11-13 19:18:04,233] INFO Notification time out: 6400 (org.apache.zookeeper.server.quorum.FastLeaderElection) ç”±äºzookeeperé›†ç¾¤åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œæ¯ä¸ªç»“ç‚¹éƒ½è¯•å›¾å»è¿æ¥é›†ç¾¤ä¸­çš„å…¶å®ƒç»“ç‚¹ï¼Œå…ˆå¯åŠ¨çš„è‚¯å®šè¿ä¸ä¸Šåé¢è¿˜æ²¡å¯åŠ¨çš„ï¼Œæ‰€ä»¥ä¸Šé¢æ—¥å¿—å‰é¢éƒ¨åˆ†çš„å¼‚å¸¸æ˜¯å¯ä»¥å¿½ç•¥çš„ã€‚é€šè¿‡åé¢éƒ¨åˆ†å¯ä»¥çœ‹åˆ°ï¼Œé›†ç¾¤åœ¨é€‰å‡ºä¸€ä¸ªLeaderåï¼Œæœ€åç¨³å®šäº†ã€‚ å…¶ä»–èŠ‚ç‚¹ä¹Ÿå¯èƒ½ä¼šå‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼Œå±äºæ­£å¸¸ã€‚ 9.zookeeperæœåŠ¡æ£€æŸ¥ [root@kafka1~]# netstat -nlpt | grep -E â€œ2181|2888|3888â€tcp 0 0 192.168.2.24:3888 0.0.0.0:* LISTEN 1959/javatcp 0 0 0.0.0.0:2181 0.0.0.0:* LISTEN 1959/java [root@kafka2 ~]# netstat -nlpt | grep -E â€œ2181|2888|3888â€tcp 0 0 192.168.2.23:3888 0.0.0.0:* LISTEN 1723/javatcp 0 0 0.0.0.0:2181 0.0.0.0:* LISTEN 1723/java [root@kafka3 ~]# netstat -nlpt | grep -E â€œ2181|2888|3888â€tcp 0 0 192.168.2.24:3888 0.0.0.0:* LISTEN 950/javatcp 0 0 0.0.0.0:2181 0.0.0.0:* LISTEN 950/javatcp 0 0 192.168.2.24:2888 0.0.0.0:* LISTEN 950/java #å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœå“ªå°æ˜¯Leader,é‚£ä¹ˆå®ƒå°±æ‹¥æœ‰2888è¿™ä¸ªç«¯å£ ok. &nbsp;è¿™æ—¶å€™zookeeperé›†ç¾¤å·²ç»å¯åŠ¨èµ·æ¥äº†ï¼Œä¸‹é¢å¯åŠ¨kafkaï¼Œä¹Ÿæ˜¯ä¾æ¬¡æŒ‰ç…§é¡ºåºå¯åŠ¨ [root@kafka1 ~]# nohup /usr/local/kafka/bin/kafka-server-start.sh /usr/local/kafka/config/server.properties &amp; #kafkaå¯åŠ¨çš„å‘½ä»¤[root@kafka1 ~]# /usr/local/kafka/bin/kafka-server-stop.sh #kafkaåœæ­¢çš„å‘½ä»¤ æ³¨æ„ï¼Œè·ŸzookeeperæœåŠ¡ä¸€æ ·ï¼Œå¦‚æœkafkaæœ‰é—®é¢˜ nohupçš„æ—¥å¿—æ–‡ä»¶ä¼šéå¸¸å¤§,æŠŠç£ç›˜å æ»¡ï¼Œè¿™ä¸ªkafkaæœåŠ¡åŒæ ·å¯ä»¥é€šè¿‡è‡ªå·±äº›æœåŠ¡è„šæœ¬æ¥ç®¡ç†æœåŠ¡çš„å¯åŠ¨ä¸å…³é—­ã€‚ æ­¤æ—¶ä¸‰å°ä¸Šé¢çš„zookeeperåŠkafkaéƒ½å·²ç»å¯åŠ¨å®Œæ¯•ï¼Œæ¥æ£€æµ‹ä»¥ä¸‹å§ (1)å»ºç«‹ä¸€ä¸ªä¸»é¢˜ [root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“create â€“zookeeper localhost:2181 â€“replication-factor 3 â€“partitions 1 â€“topic summer#æ³¨æ„ï¼šfactorå¤§å°ä¸èƒ½è¶…è¿‡brokeræ•° (2)æŸ¥çœ‹æœ‰å“ªäº›ä¸»é¢˜å·²ç»åˆ›å»º [root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“list â€“zookeeper 192.168.2.22:2181 #åˆ—å‡ºé›†ç¾¤ä¸­æ‰€æœ‰çš„topicsummer #å·²ç»åˆ›å»ºæˆåŠŸ (3)æŸ¥çœ‹summerè¿™ä¸ªä¸»é¢˜çš„è¯¦æƒ… [root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“describe â€“zookeeper 192.168.2.22:2181 â€“topic summerTopic:summer PartitionCount:1 ReplicationFactor:3 Configs: Topic: summer Partition: 0 Leader: 2 Replicas: 2,4,3 Isr: 2,4,3 #ä¸»é¢˜åç§°ï¼šsummer#Partition:åªæœ‰ä¸€ä¸ªï¼Œä»0å¼€å§‹#leader ï¼šidä¸º2çš„broker#Replicas å‰¯æœ¬å­˜åœ¨äºbroker idä¸º2,3,4çš„ä¸Šé¢#Isr:æ´»è·ƒçŠ¶æ€çš„broker (4)å‘é€æ¶ˆæ¯ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ç”Ÿäº§è€…è§’è‰² [root@kafka1 ~]# /bin/bash /usr/local/kafka/bin/kafka-console-producer.sh â€“broker-list 192.168.2.22:9092 â€“topic summerThis is a messageswelcome to kafka (5)æ¥æ”¶æ¶ˆæ¯ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯æ¶ˆè´¹è€…è§’è‰² [root@kafka2 ~]# /usr/local/kafka/bin/kafka-console-consumer.sh â€“zookeeper 192.168.2.24:2181 â€“topic summer â€“from-beginningThis is a messageswelcome to kafka å¦‚æœèƒ½å¤Ÿåƒä¸Šé¢ä¸€æ ·èƒ½å¤Ÿæ¥æ”¶åˆ°ç”Ÿäº§è€…å‘è¿‡æ¥çš„æ¶ˆæ¯ï¼Œé‚£è¯´æ˜åŸºäºkafkaçš„zookeeperé›†ç¾¤å°±æˆåŠŸå•¦ã€‚ 10ï¼Œä¸‹é¢æˆ‘ä»¬å°†webserver1ä¸Šé¢çš„logstashçš„è¾“å‡ºæ”¹åˆ°kafkaä¸Šé¢ï¼Œå°†æ•°æ®å†™å…¥åˆ°kafkaä¸­ (1)ä¿®æ”¹webserver1ä¸Šé¢çš„logstashé…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼šå„ä¸ªå‚æ•°å¯ä»¥åˆ°å®˜ç½‘æŸ¥è¯¢. root@webserver1 etc]# cat logstash.confinput { #è¿™é‡Œçš„è¾“å…¥è¿˜æ˜¯å®šä¹‰çš„æ˜¯ä»æ—¥å¿—æ–‡ä»¶è¾“å…¥ file { type =&gt; â€œsystem-messageâ€ path =&gt; â€œ/var/log/messagesâ€ start_position =&gt; â€œbeginningâ€ }} output { #stdout { codec =&gt; rubydebug } #è¿™æ˜¯æ ‡å‡†è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œå¯ä»¥ç”¨äºè°ƒè¯•çœ‹æœ‰æ²¡æœ‰è¾“å‡ºï¼Œæ³¨æ„è¾“å‡ºçš„æ–¹å‘å¯ä»¥æœ‰å¤šä¸ª kafka { #è¾“å‡ºåˆ°kafka bootstrap_servers =&gt; â€œ192.168.2.22:9092,192.168.2.23:9092,192.168.2.24:9092â€ #ä»–ä»¬å°±æ˜¯ç”Ÿäº§è€… topic_id =&gt; â€œsystem-messagesâ€ #è¿™ä¸ªå°†ä½œä¸ºä¸»é¢˜çš„åç§°ï¼Œå°†ä¼šè‡ªåŠ¨åˆ›å»º compression_type =&gt; â€œsnappyâ€ #å‹ç¼©ç±»å‹ }}[root@webserver1 etc]# (2)é…ç½®æ£€æµ‹ [root@webserver1 etc]# /usr/local/logstash/bin/logstash -f logstash.conf â€“configtest â€“verboseConfiguration OK[root@webserver1 etc]# (2)å¯åŠ¨Logstashï¼Œè¿™é‡Œæˆ‘ç›´æ¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œå³å¯ [root@webserver1 etc]# /usr/local/logstash/bin/logstash -f logstash.conf (3)éªŒè¯æ•°æ®æ˜¯å¦å†™å…¥åˆ°kafkaï¼Œè¿™é‡Œæˆ‘ä»¬æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†ä¸€ä¸ªå«system-messagesçš„ä¸»é¢˜ [root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“list â€“zookeeper 192.168.2.22:2181summersystem-messages #å¯ä»¥çœ‹åˆ°è¿™ä¸ªä¸»é¢˜å·²ç»ç”Ÿæˆäº† #å†çœ‹çœ‹è¿™ä¸ªä¸»é¢˜çš„è¯¦æƒ…:[root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“describe â€“zookeeper 192.168.2.22:2181 â€“topic system-messagesTopic:system-messages PartitionCount:16 ReplicationFactor:1 Configs: Topic: system-messages Partition: 0 Leader: 2 Replicas: 2 Isr: 2 Topic: system-messages Partition: 1 Leader: 3 Replicas: 3 Isr: 3 Topic: system-messages Partition: 2 Leader: 4 Replicas: 4 Isr: 4 Topic: system-messages Partition: 3 Leader: 2 Replicas: 2 Isr: 2 Topic: system-messages Partition: 4 Leader: 3 Replicas: 3 Isr: 3 Topic: system-messages Partition: 5 Leader: 4 Replicas: 4 Isr: 4 Topic: system-messages Partition: 6 Leader: 2 Replicas: 2 Isr: 2 Topic: system-messages Partition: 7 Leader: 3 Replicas: 3 Isr: 3 Topic: system-messages Partition: 8 Leader: 4 Replicas: 4 Isr: 4 Topic: system-messages Partition: 9 Leader: 2 Replicas: 2 Isr: 2 Topic: system-messages Partition: 10 Leader: 3 Replicas: 3 Isr: 3 Topic: system-messages Partition: 11 Leader: 4 Replicas: 4 Isr: 4 Topic: system-messages Partition: 12 Leader: 2 Replicas: 2 Isr: 2 Topic: system-messages Partition: 13 Leader: 3 Replicas: 3 Isr: 3 Topic: system-messages Partition: 14 Leader: 4 Replicas: 4 Isr: 4 Topic: system-messages Partition: 15 Leader: 2 Replicas: 2 Isr: 2[root@kafka1 ~]# å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªä¸»é¢˜ç”Ÿæˆäº†16ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºéƒ½æœ‰å¯¹åº”è‡ªå·±çš„Leaderï¼Œä½†æ˜¯æˆ‘æƒ³è¦æœ‰10ä¸ªåˆ†åŒºï¼Œ3ä¸ªå‰¯æœ¬å¦‚ä½•åŠï¼Ÿè¿˜æ˜¯è·Ÿæˆ‘ä»¬ä¸Šé¢ä¸€æ ·å‘½ä»¤è¡Œæ¥åˆ›å»ºä¸»é¢˜å°±è¡Œï¼Œå½“ç„¶å¯¹äºlogstashè¾“å‡ºçš„æˆ‘ä»¬ä¹Ÿå¯ä»¥æå‰å…ˆå®šä¹‰ä¸»é¢˜ï¼Œç„¶åå¯åŠ¨logstash ç›´æ¥å¾€å®šä¹‰å¥½çš„ä¸»é¢˜å†™æ•°æ®å°±è¡Œå•¦ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š [root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“create â€“zookeeper 192.168.2.22:2181 â€“replication-factor 3 â€“partitions 10 â€“topic TOPIC_NAME å¥½äº†ï¼Œæˆ‘ä»¬å°†logstashæ”¶é›†åˆ°çš„æ•°æ®å†™å…¥åˆ°äº†kafkaä¸­äº†ï¼Œåœ¨å®éªŒè¿‡ç¨‹ä¸­æˆ‘ä½¿ç”¨whileè„šæœ¬æµ‹è¯•äº†å¦‚æœä¸æ–­çš„å¾€kafkaå†™æ•°æ®çš„åŒæ—¶åœæ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œæ•°æ®å†™å…¥æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚ é‚£å¦‚ä½•å°†æ•°æ®ä»kafkaä¸­è¯»å–ç„¶åç»™æˆ‘ä»¬çš„esé›†ç¾¤å‘¢ï¼Ÿé‚£ä¸‹é¢æˆ‘ä»¬åœ¨kafkaé›†ç¾¤ä¸Šå®‰è£…Logstashï¼Œå®‰è£…æ­¥éª¤ä¸å†èµ˜è¿°ï¼›ä¸‰å°ä¸Šé¢çš„logstash çš„é…ç½®å¦‚ä¸‹ï¼Œä½œç”¨æ˜¯å°†kafkaé›†ç¾¤çš„æ•°æ®è¯»å–ç„¶åè½¬äº¤ç»™esé›†ç¾¤ï¼Œè¿™é‡Œä¸ºäº†æµ‹è¯•æˆ‘è®©ä»–æ–°å»ºä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼Œæ³¨æ„è¿™é‡Œçš„è¾“å…¥æ—¥å¿—è¿˜æ˜¯messagesï¼Œä¸»é¢˜åç§°è¿˜æ˜¯â€œsystem-messagesâ€ [root@kafka1 etc]# more logstash.confinput { kafka { zk_connect =&gt; â€œ192.168.2.22:2181,192.168.2.23:2181,192.168.2.24:2181â€ #æ¶ˆè´¹è€…ä»¬ topic_id =&gt; â€œsystem-messagesâ€ codec =&gt; plain reset_beginning =&gt; false consumer_threads =&gt; 5 decorate_events =&gt; true }} output { elasticsearch { hosts =&gt; [â€œ192.168.2.18:9200â€,â€192.168.2.19:9200â€] index =&gt; â€œtest-system-messages-%{+YYYY-MM}â€ #ä¸ºäº†åŒºåˆ†ä¹‹å‰å®éªŒï¼Œæˆ‘è¿™é‡Œæ–°ç”Ÿæˆçš„æ‰€ä»¥åå­—ä¸ºâ€œtest-system-messages-%{+YYYY-MM}â€ } } åœ¨ä¸‰å°kafkaä¸Šé¢å¯åŠ¨Logstashï¼Œæ³¨æ„æˆ‘è¿™é‡Œæ˜¯åœ¨å‘½ä»¤è¡Œå¯åŠ¨çš„ï¼› [root@kafka1 etc]# pwd/usr/local/logstash/etc[root@kafka1 etc]# /usr/local/logstash/bin/logstash -f logstash.conf[root@kafka2 etc]# pwd/usr/local/logstash/etc[root@kafka2 etc]# /usr/local/logstash/bin/logstash -f logstash.conf[root@kafka3 etc]# pwd/usr/local/logstash/etc[root@kafka3 etc]# /usr/local/logstash/bin/logstash -f logstash.conf åœ¨webserver1ä¸Šå†™å…¥æµ‹è¯•å†…å®¹ï¼Œå³webserver1ä¸Šé¢åˆ©ç”¨messageè¿™ä¸ªæ–‡ä»¶æ¥æµ‹è¯•ï¼Œæˆ‘å…ˆå°†å…¶æ¸…ç©ºï¼Œç„¶åå¯åŠ¨ [root@webserver1 etc]# &gt;/var/log/messages[root@webserver1 etc]# echo â€œæˆ‘å°†é€šè¿‡kafkaé›†ç¾¤è¾¾åˆ°esé›†ç¾¤å“¦^0^â€ &gt;&gt; /var/log/messages#å¯åŠ¨logstash,è®©å…¶è¯»å–messagesä¸­çš„å†…å®¹ ä¸‹å›¾ä¸ºæˆ‘åœ¨å®¢æˆ·ç«¯å†™å…¥åˆ°kafkaé›†ç¾¤çš„åŒæ—¶ä¹Ÿå°†å…¶è¾“å…¥åˆ°ç»ˆç«¯ï¼Œè¿™é‡Œå†™å…¥äº†ä¸‰æ¡å†…å®¹ è€Œä¸‹é¢ä¸‰å¼ å›¾ä¾§å¯ä»¥çœ‹å‡ºï¼Œä¸‰å°Logstash å¾ˆå¹³å‡çš„ä»kafkaé›†ç¾¤å½“ä¸­è¯»å–å‡ºæ¥äº†æ—¥å¿—å†…å®¹ å†æ¥çœ‹çœ‹æˆ‘ä»¬çš„esç®¡ç†ç•Œé¢ ok ,çœ‹åˆ°äº†å§ï¼Œ æµç¨‹å·®ä¸å¤šå°±æ˜¯ä¸‹é¢ é…±ç´«å’¯ ç”±äºç¯‡å¹…è¾ƒé•¿ï¼Œæˆ‘å°† 4.Kibanaéƒ¨ç½²; 5.Nginxè´Ÿè½½å‡è¡¡Kibanaè¯·æ±‚; 6.æ¡ˆä¾‹ï¼šnginxæ—¥å¿—æ”¶é›†ä»¥åŠMySQLæ…¢æ—¥å¿—æ”¶é›†; 7.KibanaæŠ¥è¡¨åŸºæœ¬ä½¿ç”¨; æ”¾åˆ°ä¸‹ä¸€ç¯‡åšå®¢ã€‚","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"ELK","slug":"ELK","permalink":"https://blog.sctux.cc/tags/ELK/"},{"name":"kafka","slug":"kafka","permalink":"https://blog.sctux.cc/tags/kafka/"},{"name":"zookeeper","slug":"zookeeper","permalink":"https://blog.sctux.cc/tags/zookeeper/"}],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"æ¸…ç†Elasticsearchçš„ç´¢å¼•","slug":"e6-b8-85-e7-90-86elasticsearch-e7-9a-84-e7-b4-a2-e5-bc-95","date":"2015-10-23T14:17:33.000Z","updated":"2025-09-01T01:59:08.937Z","comments":true,"path":"2015/10/23/e6-b8-85-e7-90-86elasticsearch-e7-9a-84-e7-b4-a2-e5-bc-95/","permalink":"https://blog.sctux.cc/2015/10/23/e6-b8-85-e7-90-86elasticsearch-e7-9a-84-e7-b4-a2-e5-bc-95/","excerpt":"æœ€è¿‘åœ¨ä½¿ç”¨ logstashæ¥åšæ—¥å¿—æ”¶é›† å¹¶ç”¨ elasticsearchæ¥æœç´¢ï¼Œå› ä¸ºæ—¥å¿—æ²¡æœ‰è¿›è¡Œè¿‡æ»¤ï¼Œæ²¡å‡ å¤©å°±å‘ç°elasticsearchçš„ç´¢å¼•æ–‡ä»¶å¤§çš„å“äººï¼Œä¹‹å‰è¿˜çœŸæ²¡æ¸…ç†è¿‡ã€‚å…¶å®è¦è¯´æ¸…ç† ä¹Ÿç®€å•ï¼Œç›´æ¥åˆ° elasticsearch dataæ–‡ä»¶å¤¹é‡Œåˆ æ‰å°±è¡Œäº†ï¼Œä½†æ€ä¹ˆä¹Ÿå¾—åšçš„æœ‰ç‚¹æŠ€æœ¯å«é‡ä¸æ˜¯ï¼Ÿ ä¸Šç½‘ç«™çœ‹äº†çœ‹æ–‡æ¡£ï¼Œå…¶å®ä¹ŸæŒºç®€å•ä¸€æ¡å‘½ä»¤å°±è¡Œäº† 1, # curl -XDELETE â€˜http://localhost:9200/logstash-*â€™ 2, æ¸…ç†æ‰äº†æ‰€æœ‰çš„ç´¢å¼•æ–‡ä»¶ï¼Œæˆ‘å‘ç°curlåˆ é™¤æ¯”rmåˆ é™¤è¦å¿«å‡ºå¾ˆå¤š ä¸‹é¢æ˜¯ä¸»é¡µä¸Šçš„è¯¦ç»†ä»‹ç»ï¼Œå…¶ä»–éƒ¨åˆ†å¯ä»¥è‡ªå·±çœ‹ï¼Œ http://www.elasticsearch.org/guide/reference/api/delet","text":"æœ€è¿‘åœ¨ä½¿ç”¨ logstashæ¥åšæ—¥å¿—æ”¶é›† å¹¶ç”¨ elasticsearchæ¥æœç´¢ï¼Œå› ä¸ºæ—¥å¿—æ²¡æœ‰è¿›è¡Œè¿‡æ»¤ï¼Œæ²¡å‡ å¤©å°±å‘ç°elasticsearchçš„ç´¢å¼•æ–‡ä»¶å¤§çš„å“äººï¼Œä¹‹å‰è¿˜çœŸæ²¡æ¸…ç†è¿‡ã€‚å…¶å®è¦è¯´æ¸…ç† ä¹Ÿç®€å•ï¼Œç›´æ¥åˆ° elasticsearch dataæ–‡ä»¶å¤¹é‡Œåˆ æ‰å°±è¡Œäº†ï¼Œä½†æ€ä¹ˆä¹Ÿå¾—åšçš„æœ‰ç‚¹æŠ€æœ¯å«é‡ä¸æ˜¯ï¼Ÿ ä¸Šç½‘ç«™çœ‹äº†çœ‹æ–‡æ¡£ï¼Œå…¶å®ä¹ŸæŒºç®€å•ä¸€æ¡å‘½ä»¤å°±è¡Œäº† 1, # curl -XDELETE â€˜http://localhost:9200/logstash-*â€™ 2, æ¸…ç†æ‰äº†æ‰€æœ‰çš„ç´¢å¼•æ–‡ä»¶ï¼Œæˆ‘å‘ç°curlåˆ é™¤æ¯”rmåˆ é™¤è¦å¿«å‡ºå¾ˆå¤š ä¸‹é¢æ˜¯ä¸»é¡µä¸Šçš„è¯¦ç»†ä»‹ç»ï¼Œå…¶ä»–éƒ¨åˆ†å¯ä»¥è‡ªå·±çœ‹ï¼Œ http://www.elasticsearch.org/guide/reference/api/delet","categories":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}],"tags":[{"name":"logstash","slug":"logstash","permalink":"https://blog.sctux.cc/tags/logstash/"}],"keywords":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}]},{"title":"è¿ç»´äºº,ä½ åº”è¯¥äº†è§£çš„ä¸‰å¼ æ­¦åŠŸå¿ƒæ³•å›¾(è½¬è½½)","slug":"e8-bf-90-e7-bb-b4-e4-ba-ba-e4-bd-a0-e5-ba-94-e8-af-a5-e4-ba-86-e8-a7-a3-e7-9a-84-e4-b8-89-e5-bc-a0-e6-ad-a6-e5-8a-9f-e5-bf-83-e6-b3-95-e5-9b-be-e8-bd-ac-e8-bd-bd","date":"2015-10-23T07:10:41.000Z","updated":"2025-09-01T01:59:08.932Z","comments":true,"path":"2015/10/23/e8-bf-90-e7-bb-b4-e4-ba-ba-e4-bd-a0-e5-ba-94-e8-af-a5-e4-ba-86-e8-a7-a3-e7-9a-84-e4-b8-89-e5-bc-a0-e6-ad-a6-e5-8a-9f-e5-bf-83-e6-b3-95-e5-9b-be-e8-bd-ac-e8-bd-bd/","permalink":"https://blog.sctux.cc/2015/10/23/e8-bf-90-e7-bb-b4-e4-ba-ba-e4-bd-a0-e5-ba-94-e8-af-a5-e4-ba-86-e8-a7-a3-e7-9a-84-e4-b8-89-e5-bc-a0-e6-ad-a6-e5-8a-9f-e5-bf-83-e6-b3-95-e5-9b-be-e8-bd-ac-e8-bd-bd/","excerpt":"ä¸€ã€è¿ç»´æŠ€èƒ½å›¾ åšä¸ºä¸€ä¸ªè¿ç»´å·¥ç¨‹å¸ˆï¼Œä½ çŸ¥é“ä½ åº”è¯¥å­¦ä¹ ä»€ä¹ˆï¼Ÿæ€ä¹ˆå­¦ä¹ å—ï¼Ÿæœå“ªä¸ªæ–¹å‘å‘å±•å—ï¼Ÿä¸‹é¢ä¸€å¼ è¿ç»´å·¥ç¨‹å¸ˆæŠ€èƒ½å›¾ï¼Œè®©ä½ äº†è§£ï¼ å›¾ç‰‡é“¾æ¥ï¼Œç‚¹æˆ‘^_^ äºŒã€è‡ªåŠ¨åŒ–è¿ç»´è·¯çº¿å›¾ è¿ç»´è‡ªåŠ¨åŒ–åœ¨å›½å†…å·²ç»å£°åè¿œèºäº†ï¼Œéšç€äº’è”ç½‘å¿«é€Ÿçš„å‘å±•ï¼Œè¿ç»´ä¸å•å•æ˜¯å‡ ä¸ªè„šæœ¬ï¼Œå‡ ä¸ªæ–‡æ¡£å¯ä»¥èƒœä»»çš„ï¼DevOpsåœ¨å›½å†…å¾ˆå—çƒ­æ§ï¼Œä½†æ˜¯çœŸæ­£çš„è‡ªåŠ¨åŒ–ä¹‹è·¯ï¼Œä½ èµ°åˆ°äº†å“ªï¼Ÿä½ çŸ¥é“è¯¥æ€ä¹ˆèµ°å—ï¼Ÿä¸‹é¢çš„æ­¦åŠŸå¿ƒæ³•å›¾å‘Šè¯‰ä½ è¯¥æ€ä¹ˆèµ°ï¼ å›¾ç‰‡é“¾æ¥ï¼Œç‚¹æˆ‘^_^ ä¸‰ã€äº‘è®¡ç®—çŸ¥è¯†å¤§å®å…¸ ä»2013å¹´å¼€å§‹ï¼Œæˆ‘å›½äº‘è®¡ç®—æŒç»­å¿«é€Ÿå‘å±•ï¼Œäº§ä¸šè§„æ¨¡ä¸æ–­æ‰©å¤§ï¼Œäº§ä¸šé“¾æ—¥è¶‹å®Œå–„ï¼Œäº§ä¸šç¯å¢ƒä¸æ–­ä¼˜åŒ–ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸å°‘åˆ›ä¸šè€…çœ‹åˆ°äº†å¸‚åœºï¼Œä¸å°‘äº‘è®¡ç®—å…¬å¸å´›èµ·ã€‚ä½†æ˜¯äººæ‰åœ¨å“ªé‡Œï¼Œå“ªäº›æ˜¯çœŸæ­£çš„äº‘è®¡ç®—äººæ‰ï¼Ÿäº‘è®¡ç®—äººæ‰ä»–åº”è¯¥ä¼šä»€ä¹ˆï¼Œä¸‹é¢Cloud computing imageå‘Šè¯‰ä½  å›¾ç‰‡é“¾æ¥ï¼Œç‚¹æˆ‘^_^ ç”±äºåŸä½œè€…åˆ¶ä½œçš„å›¾ç‰‡è¾ƒå¤§ï¼Œè¿™é‡Œä¸èƒ½æ­£å¸¸çš„æ˜¾ç¤ºï¼Œç‚¹å‡»é“¾æ¥ç„¶åæ‰©å¤§å¯æ¸…æ™°çœ‹åˆ°ï¼ å¤©ä¸‹æ­¦åŠŸå”¯å¿«ä¸æ”»ï¼Œè¿™å¥è¯è¿ç”¨åˆ°äº’è”ç½‘ï¼Œå°±æ˜¯ä½ æœ€å¿«ã€æœ€å¥½ã€æœ€æ—©çš„æŒæ¡äº†äº’è”ç½‘çš„æœ€æ–°æŠ€æœ¯ï¼Œä½ å°±æ˜¯æ¯”è¾ƒåƒé¦™çš„äººæ‰ï¼å°±åƒæœ€æ–°æ¯”è¾ƒäººä»¬çš„å®¹å™¨DockeræŠ€æœ¯ä¸€æ ·ï¼Œå¦‚æœä½ æ˜¯å…ˆè¡Œè€…ï¼Œä½ ç°åœ¨è‡³å°‘æ˜¯ä¸€å®¶Dockerç”Ÿæ€æŠ€æœ¯åˆ›ä¸šæœåŠ¡çš„åˆä¼™äººï¼é©å‘½è¿˜æœªèƒœåˆ©ï¼ŒåŒå¿—è¿˜éœ€åŠªåŠ›ï¼Œå„ä½è‹¦é€¼çš„äº’è”ç½‘å·¥ä½œè€…ï¼ŒåŠ æ²¹ï¼","text":"ä¸€ã€è¿ç»´æŠ€èƒ½å›¾ åšä¸ºä¸€ä¸ªè¿ç»´å·¥ç¨‹å¸ˆï¼Œä½ çŸ¥é“ä½ åº”è¯¥å­¦ä¹ ä»€ä¹ˆï¼Ÿæ€ä¹ˆå­¦ä¹ å—ï¼Ÿæœå“ªä¸ªæ–¹å‘å‘å±•å—ï¼Ÿä¸‹é¢ä¸€å¼ è¿ç»´å·¥ç¨‹å¸ˆæŠ€èƒ½å›¾ï¼Œè®©ä½ äº†è§£ï¼ å›¾ç‰‡é“¾æ¥ï¼Œç‚¹æˆ‘^_^ äºŒã€è‡ªåŠ¨åŒ–è¿ç»´è·¯çº¿å›¾ è¿ç»´è‡ªåŠ¨åŒ–åœ¨å›½å†…å·²ç»å£°åè¿œèºäº†ï¼Œéšç€äº’è”ç½‘å¿«é€Ÿçš„å‘å±•ï¼Œè¿ç»´ä¸å•å•æ˜¯å‡ ä¸ªè„šæœ¬ï¼Œå‡ ä¸ªæ–‡æ¡£å¯ä»¥èƒœä»»çš„ï¼DevOpsåœ¨å›½å†…å¾ˆå—çƒ­æ§ï¼Œä½†æ˜¯çœŸæ­£çš„è‡ªåŠ¨åŒ–ä¹‹è·¯ï¼Œä½ èµ°åˆ°äº†å“ªï¼Ÿä½ çŸ¥é“è¯¥æ€ä¹ˆèµ°å—ï¼Ÿä¸‹é¢çš„æ­¦åŠŸå¿ƒæ³•å›¾å‘Šè¯‰ä½ è¯¥æ€ä¹ˆèµ°ï¼ å›¾ç‰‡é“¾æ¥ï¼Œç‚¹æˆ‘^_^ ä¸‰ã€äº‘è®¡ç®—çŸ¥è¯†å¤§å®å…¸ ä»2013å¹´å¼€å§‹ï¼Œæˆ‘å›½äº‘è®¡ç®—æŒç»­å¿«é€Ÿå‘å±•ï¼Œäº§ä¸šè§„æ¨¡ä¸æ–­æ‰©å¤§ï¼Œäº§ä¸šé“¾æ—¥è¶‹å®Œå–„ï¼Œäº§ä¸šç¯å¢ƒä¸æ–­ä¼˜åŒ–ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸å°‘åˆ›ä¸šè€…çœ‹åˆ°äº†å¸‚åœºï¼Œä¸å°‘äº‘è®¡ç®—å…¬å¸å´›èµ·ã€‚ä½†æ˜¯äººæ‰åœ¨å“ªé‡Œï¼Œå“ªäº›æ˜¯çœŸæ­£çš„äº‘è®¡ç®—äººæ‰ï¼Ÿäº‘è®¡ç®—äººæ‰ä»–åº”è¯¥ä¼šä»€ä¹ˆï¼Œä¸‹é¢Cloud computing imageå‘Šè¯‰ä½  å›¾ç‰‡é“¾æ¥ï¼Œç‚¹æˆ‘^_^ ç”±äºåŸä½œè€…åˆ¶ä½œçš„å›¾ç‰‡è¾ƒå¤§ï¼Œè¿™é‡Œä¸èƒ½æ­£å¸¸çš„æ˜¾ç¤ºï¼Œç‚¹å‡»é“¾æ¥ç„¶åæ‰©å¤§å¯æ¸…æ™°çœ‹åˆ°ï¼ å¤©ä¸‹æ­¦åŠŸå”¯å¿«ä¸æ”»ï¼Œè¿™å¥è¯è¿ç”¨åˆ°äº’è”ç½‘ï¼Œå°±æ˜¯ä½ æœ€å¿«ã€æœ€å¥½ã€æœ€æ—©çš„æŒæ¡äº†äº’è”ç½‘çš„æœ€æ–°æŠ€æœ¯ï¼Œä½ å°±æ˜¯æ¯”è¾ƒåƒé¦™çš„äººæ‰ï¼å°±åƒæœ€æ–°æ¯”è¾ƒäººä»¬çš„å®¹å™¨DockeræŠ€æœ¯ä¸€æ ·ï¼Œå¦‚æœä½ æ˜¯å…ˆè¡Œè€…ï¼Œä½ ç°åœ¨è‡³å°‘æ˜¯ä¸€å®¶Dockerç”Ÿæ€æŠ€æœ¯åˆ›ä¸šæœåŠ¡çš„åˆä¼™äººï¼é©å‘½è¿˜æœªèƒœåˆ©ï¼ŒåŒå¿—è¿˜éœ€åŠªåŠ›ï¼Œå„ä½è‹¦é€¼çš„äº’è”ç½‘å·¥ä½œè€…ï¼ŒåŠ æ²¹ï¼","categories":[{"name":"å¿ƒæƒ…éšç¬”","slug":"å¿ƒæƒ…éšç¬”","permalink":"https://blog.sctux.cc/categories/%E5%BF%83%E6%83%85%E9%9A%8F%E7%AC%94/"}],"tags":[],"keywords":[{"name":"å¿ƒæƒ…éšç¬”","slug":"å¿ƒæƒ…éšç¬”","permalink":"https://blog.sctux.cc/categories/%E5%BF%83%E6%83%85%E9%9A%8F%E7%AC%94/"}]},{"title":"Zabbix ç›‘æ§MysqlçŠ¶æ€ä»¥åŠmysqlä¸»ä»","slug":"zabbix-e7-9b-91-e6-8e-a7mysql-e7-8a-b6-e6-80-81-e4-bb-a5-e5-8f-8amysql-e4-b8-bb-e4-bb-8e","date":"2015-10-23T06:48:07.000Z","updated":"2025-09-01T01:59:08.958Z","comments":true,"path":"2015/10/23/zabbix-e7-9b-91-e6-8e-a7mysql-e7-8a-b6-e6-80-81-e4-bb-a5-e5-8f-8amysql-e4-b8-bb-e4-bb-8e/","permalink":"https://blog.sctux.cc/2015/10/23/zabbix-e7-9b-91-e6-8e-a7mysql-e7-8a-b6-e6-80-81-e4-bb-a5-e5-8f-8amysql-e4-b8-bb-e4-bb-8e/","excerpt":"ä¸€ï¼Œåˆ©ç”¨zabbixè‡ªå¸¦æ¨¡æ¿ç›‘æ§mysqlçŠ¶æ€ï¼š 1ï¼Œåœ¨ä»çš„mysqlæœåŠ¡å™¨ä¸Šé¢åˆ›å»ºä¸€ä¸ªç”¨äºzabbixç›‘æ§çš„ç”¨æˆ· grant replication client on . to zabbix@â€™localhostâ€™ &nbsp;IDENTIFIED BY â€˜PASSWORDâ€™; 2ï¼Œæ ¹æ®zabbixç›‘æ§mysqlçš„keyæ”¹å†™è„šæœ¬ #/bin/bashDEF=â€â€“defaults-file=/etc/zabbix/my.confâ€MYSQL=â€™/usr/local/webservers/mysql-5.6.19/bin/mysqladminâ€™ARGS=1if [ $# -ne â€œ$ARGSâ€ ];then echo â€œPlease input one arguement:â€ficase $1 in Uptime) result=${MYSQL} $DEF status|cut -f2 -d\":\"|cut -f1 -d\"T\" echo $result ;; Com_update) result=${MYSQL} $DEF extended-status |grep -w \"Com_update\"|cut -d\"|\" -f3 echo $result ;; Slow_queries) result=${MYSQL} $DEF status |cut -f5 -d\":\"|cut -f1 -d\"O\" echo $result ;; Com_select) result=${MYSQL} $DEF extended-status |grep -w \"Com_select\"|cut -d\"|\" -f3 echo $result ;; Com_rollback) result=${MYSQL} $DEF extended-status |grep -w \"Com_rollback\"|cut -d\"|\" -f3 echo $result ;; Questions) result=${MYSQL} $DEF status|cut -f4 -d\":\"|cut -f1 -d\"S\" echo $result ;; Com_insert) result=${MYSQL} $DEF extended-status |grep -w \"Com_insert\"|cut -d\"|\" -f3 echo $result ;; Com_delete) result=${MYSQL} $DEF extended-status |grep -w \"Com_delete\"|cut -d\"|\" -f3 echo $result ;; Com_commit) result=${MYSQL} $DEF extended-status |grep -w \"Com_commit\"|cut -d\"|\" -f3 echo $result ;; Bytes_sent) result=${MYSQL} $DEF extended-status |grep -w \"Bytes_sent\" |cut -d\"|\" -f3 echo $result ;; Bytes_received) result=${MYSQL} $DEF extended-status |grep -w \"Bytes_received\" |cut -d\"|\" -f3 echo $result ;; Com_begin) result=${MYSQL} $DEF extended-status |grep -w \"Com_begin\"|cut -d\"|\" -f3 echo $result ;; *) echo \"Usage:$0(Uptime|Com\\_update|Slow\\_queries|Com\\_select|Com\\_rollback|Questions)\" ;; esac ä¸Šé¢çš„è„šæœ¬ä¸­ï¼š /etc/zabbix/my.conf è¿™ä¸ªæ–‡ä»¶å®šä¹‰çš„æ˜¯zabbixè¿™ä¸ªmysqlç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åç›´æ¥æŒ‡å®šè¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å‘½ä»¤è¡Œç›´æ¥è¾“å…¥zabbixçš„ç”¨æˆ·å¯†ç çš„è¯ä¼šä¸€è¡Œæç¤ºï¼Œå½±å“æˆ‘ä»¬zabbixå–å€¼ï¼Œä¾‹å¦‚ï¼š å¦‚æœæˆ‘ä»¬ç›´æ¥æŒ‡å®šäº†è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆé‚£è¡Œæç¤ºå°±ä¸ä¼šå‡ºç° /etc/zabbix/my.confçš„å†…å®¹ï¼š [client]host=localhostuser=zabbixpassword=â€™PASSWORDâ€™socket = /data/mysql/mysql.sock 3ï¼Œè®¾ç½®zabbix_agentç«¯ é¦–å…ˆå¯ç”¨è‡ªå®šä¹‰çš„key å»æ‰zabbix_agenté…ç½®æ–‡ä»¶çš„259è¡Œ: Include=/usr/local/etc/zabbix_agentd.conf.d/*.conf ç„¶åè‡ªå®šä¹‰ä¸€ä¸ªmysql-status.conf åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œå†…å®¹ä¸ºï¼š UserParameter=mysql.version,/usr/local/webservers/mysql-5.6.19/bin/mysql -VUserParameter=mysql.ping,/usr/local/webservers/mysql-5.6.19/bin/mysqladmin â€“defaults-file=/etc/zabbix/my.conf ping | grep -c aliveUserParameter=mysql.status[*],/home/shell/mysql-status.sh $1#æ³¨æ„ï¼šè¿™é‡Œè‡ªå®šä¹‰çš„key å»ºè®®ä½¿ç”¨å‘½ä»¤çš„ç»å¯¹è·¯å¾„ ok ä¸Šé¢çš„å†…å®¹å®šä¹‰å¥½ä¹‹åé‡å¯zabbix_agentæœåŠ¡ï¼Œç„¶åå°±å¯ä»¥åœ¨zabbix_serverç«¯çœ‹ä¸€ä¸‹èƒ½ä¸èƒ½è·å–åˆ°keyå€¼ å¥½å•¦ï¼Œä»¥ä¸Šå†…å®¹ä¸­å¯ä»¥çœ‹åˆ°å–å€¼æ­£å¸¸ï¼Œæˆ‘ä»¬åœ¨zabbix dashboardä¸­æŸ¥çœ‹ä¸€ä¸‹å§ï¼› è‡³æ­¤å·²ç»ç›‘æ§åˆ°mysqlçš„çŠ¶æ€å•¦ï¼›è¿™é‡Œä¸€å®šè¦æ³¨æ„mysqlç”¨æˆ·å–è·å–mysqlæœåŠ¡çš„çŠ¶æ€æ—¶å€™çš„æƒé™ï¼› äºŒã€zabbixç›‘æ§mysqlä¸»ä»çŠ¶æ€ è·Ÿä¸Šé¢çš„æ­¥éª¤å·®ä¸å¤šï¼Œè¿™é‡Œä½¿ç”¨çš„mysqlç”¨æˆ·æˆ‘è¿˜æ˜¯ä½¿ç”¨çš„zabbixç”¨æˆ· é‚£è¿™é‡Œç›´æ¥å°±è‡ªå®šä¹‰key å•¦ï¼Œå¤§å®¶éƒ½çŸ¥é“mysqlä¸»ä»çŠ¶æ€æˆ‘ä»¬ä¸€èˆ¬é€šè¿‡åœ¨mysql slavesä¸Šé¢çš„show slave status ç„¶åçœ‹ Slave_IO_Running: YesSlave_SQL_Running: Yes","text":"ä¸€ï¼Œåˆ©ç”¨zabbixè‡ªå¸¦æ¨¡æ¿ç›‘æ§mysqlçŠ¶æ€ï¼š 1ï¼Œåœ¨ä»çš„mysqlæœåŠ¡å™¨ä¸Šé¢åˆ›å»ºä¸€ä¸ªç”¨äºzabbixç›‘æ§çš„ç”¨æˆ· grant replication client on . to zabbix@â€™localhostâ€™ &nbsp;IDENTIFIED BY â€˜PASSWORDâ€™; 2ï¼Œæ ¹æ®zabbixç›‘æ§mysqlçš„keyæ”¹å†™è„šæœ¬ #/bin/bashDEF=â€â€“defaults-file=/etc/zabbix/my.confâ€MYSQL=â€™/usr/local/webservers/mysql-5.6.19/bin/mysqladminâ€™ARGS=1if [ $# -ne â€œ$ARGSâ€ ];then echo â€œPlease input one arguement:â€ficase $1 in Uptime) result=${MYSQL} $DEF status|cut -f2 -d\":\"|cut -f1 -d\"T\" echo $result ;; Com_update) result=${MYSQL} $DEF extended-status |grep -w \"Com_update\"|cut -d\"|\" -f3 echo $result ;; Slow_queries) result=${MYSQL} $DEF status |cut -f5 -d\":\"|cut -f1 -d\"O\" echo $result ;; Com_select) result=${MYSQL} $DEF extended-status |grep -w \"Com_select\"|cut -d\"|\" -f3 echo $result ;; Com_rollback) result=${MYSQL} $DEF extended-status |grep -w \"Com_rollback\"|cut -d\"|\" -f3 echo $result ;; Questions) result=${MYSQL} $DEF status|cut -f4 -d\":\"|cut -f1 -d\"S\" echo $result ;; Com_insert) result=${MYSQL} $DEF extended-status |grep -w \"Com_insert\"|cut -d\"|\" -f3 echo $result ;; Com_delete) result=${MYSQL} $DEF extended-status |grep -w \"Com_delete\"|cut -d\"|\" -f3 echo $result ;; Com_commit) result=${MYSQL} $DEF extended-status |grep -w \"Com_commit\"|cut -d\"|\" -f3 echo $result ;; Bytes_sent) result=${MYSQL} $DEF extended-status |grep -w \"Bytes_sent\" |cut -d\"|\" -f3 echo $result ;; Bytes_received) result=${MYSQL} $DEF extended-status |grep -w \"Bytes_received\" |cut -d\"|\" -f3 echo $result ;; Com_begin) result=${MYSQL} $DEF extended-status |grep -w \"Com_begin\"|cut -d\"|\" -f3 echo $result ;; *) echo \"Usage:$0(Uptime|Com\\_update|Slow\\_queries|Com\\_select|Com\\_rollback|Questions)\" ;; esac ä¸Šé¢çš„è„šæœ¬ä¸­ï¼š /etc/zabbix/my.conf è¿™ä¸ªæ–‡ä»¶å®šä¹‰çš„æ˜¯zabbixè¿™ä¸ªmysqlç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åç›´æ¥æŒ‡å®šè¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å‘½ä»¤è¡Œç›´æ¥è¾“å…¥zabbixçš„ç”¨æˆ·å¯†ç çš„è¯ä¼šä¸€è¡Œæç¤ºï¼Œå½±å“æˆ‘ä»¬zabbixå–å€¼ï¼Œä¾‹å¦‚ï¼š å¦‚æœæˆ‘ä»¬ç›´æ¥æŒ‡å®šäº†è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆé‚£è¡Œæç¤ºå°±ä¸ä¼šå‡ºç° /etc/zabbix/my.confçš„å†…å®¹ï¼š [client]host=localhostuser=zabbixpassword=â€™PASSWORDâ€™socket = /data/mysql/mysql.sock 3ï¼Œè®¾ç½®zabbix_agentç«¯ é¦–å…ˆå¯ç”¨è‡ªå®šä¹‰çš„key å»æ‰zabbix_agenté…ç½®æ–‡ä»¶çš„259è¡Œ: Include=/usr/local/etc/zabbix_agentd.conf.d/*.conf ç„¶åè‡ªå®šä¹‰ä¸€ä¸ªmysql-status.conf åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œå†…å®¹ä¸ºï¼š UserParameter=mysql.version,/usr/local/webservers/mysql-5.6.19/bin/mysql -VUserParameter=mysql.ping,/usr/local/webservers/mysql-5.6.19/bin/mysqladmin â€“defaults-file=/etc/zabbix/my.conf ping | grep -c aliveUserParameter=mysql.status[*],/home/shell/mysql-status.sh $1#æ³¨æ„ï¼šè¿™é‡Œè‡ªå®šä¹‰çš„key å»ºè®®ä½¿ç”¨å‘½ä»¤çš„ç»å¯¹è·¯å¾„ ok ä¸Šé¢çš„å†…å®¹å®šä¹‰å¥½ä¹‹åé‡å¯zabbix_agentæœåŠ¡ï¼Œç„¶åå°±å¯ä»¥åœ¨zabbix_serverç«¯çœ‹ä¸€ä¸‹èƒ½ä¸èƒ½è·å–åˆ°keyå€¼ å¥½å•¦ï¼Œä»¥ä¸Šå†…å®¹ä¸­å¯ä»¥çœ‹åˆ°å–å€¼æ­£å¸¸ï¼Œæˆ‘ä»¬åœ¨zabbix dashboardä¸­æŸ¥çœ‹ä¸€ä¸‹å§ï¼› è‡³æ­¤å·²ç»ç›‘æ§åˆ°mysqlçš„çŠ¶æ€å•¦ï¼›è¿™é‡Œä¸€å®šè¦æ³¨æ„mysqlç”¨æˆ·å–è·å–mysqlæœåŠ¡çš„çŠ¶æ€æ—¶å€™çš„æƒé™ï¼› äºŒã€zabbixç›‘æ§mysqlä¸»ä»çŠ¶æ€ è·Ÿä¸Šé¢çš„æ­¥éª¤å·®ä¸å¤šï¼Œè¿™é‡Œä½¿ç”¨çš„mysqlç”¨æˆ·æˆ‘è¿˜æ˜¯ä½¿ç”¨çš„zabbixç”¨æˆ· é‚£è¿™é‡Œç›´æ¥å°±è‡ªå®šä¹‰key å•¦ï¼Œå¤§å®¶éƒ½çŸ¥é“mysqlä¸»ä»çŠ¶æ€æˆ‘ä»¬ä¸€èˆ¬é€šè¿‡åœ¨mysql slavesä¸Šé¢çš„show slave status ç„¶åçœ‹ Slave_IO_Running: YesSlave_SQL_Running: Yes è¿™ä¸¤ä¸ªå€¼ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªä¸ä¸ºYesé‚£è¯´æ˜ä¸»ä»åŒæ­¥æ˜¯æœ‰é—®é¢˜çš„ï¼Œé‚£æˆ‘ä»¬ç”¨zabbixè¿™ä¸ªçš„èº«ä»½æ¥è·å–è¿™ä¸ªå€¼ ç¼–å†™è„šæœ¬ï¼šmysql_replication.sh #!/bin/bash/usr/local/webservers/mysql-5.6.19/bin/mysql â€“defaults-file=/etc/zabbix/my.conf -e â€˜show slave status\\Gâ€™ | grep -E â€œSlave_IO_Running:|Slave_SQL_Running:â€ | awk â€˜{print $2}â€™ | grep -c Yes è¿™ä¸ªè„šæœ¬çš„ç”¨é€”æ˜¯ï¼Œç”¨zabbixç”¨æˆ·èº«ä»½æ‰§è¡Œâ€show slave status\\Gâ€è¿™ä¸ªå‘½ä»¤ï¼Œç„¶åæˆªå–Yesè¿™ä¸ªå…³é”®å­—çš„è¡Œæ•°æ˜¯2 æˆ–è€…é 2 åœ¨zabbix_server ç«¯/usr/local/etc/zabbix_agentd.conf.d/ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ï¼šmysql-replication.confï¼Œå†…å®¹ä¸ºï¼š UserParameter=mysql.replication,/home/shell/mysql-replication.sh å†™å¥½ä¹‹åï¼Œé‡å¯zabbix_agent ç„¶ååœ¨zabbix_serverç«¯æµ‹è¯•ä¸€ä¸‹çœ‹èƒ½å¦è·å–åˆ°è¿™ä¸ªå€¼ zabbix_serverç«¯èƒ½è·å–ï¼Œç°åœ¨åœ¨zabbix dashboardæ·»åŠ è¿™ä¸ªitemå§ Configurationâ€“&gt;Hostâ€“&gt;database-node2â€“&gt;Itemsâ€“&gt;Create item è¿™é‡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„key éœ€è¦æ‰‹åŠ¨è¾“å…¥keyåç§°ã€‚æˆ‘è¿™é‡Œå®šä¹‰è¿‡äº†ï¼Œç›´æ¥ç‚¹å‡»â€œAddâ€å°±è¡Œäº† ç„¶åæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªTriggers Triggersâ€“&gt;Create triggers æ£€æµ‹å®ƒæœ€åä¸€æ¬¡çš„å–å€¼æ˜¯ä¸æ˜¯å°äº2ï¼Œå®šä¹‰Nçš„å€¼ä¸º2ï¼Œå¦‚æœå–å¾—çš„å€¼å°äº2å°±è¯´æ˜æœ‰é—®é¢˜å•¦ï¼Œ å®šä¹‰ä¸€ä¸‹æŠ¥è­¦ï¼š Configurationâ€“&gt;Actionâ€“&gt;Create action é‚®ä»¶é€šçŸ¥å†…å®¹ï¼šMySQL.RepliactionERRORâ€”MySQL master-slave â€“&gt;{ITEM.VALUE1}MySQL ä¸»ä»å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æµ‹ä¸»ä»çŠ¶æ€ï¼ï¼ï¼å‘Šè­¦ä¸»æœº : {HOSTNAME1}å‘Šè­¦æ—¶é—´ : {EVENT.DATE} {EVENT.TIME}å‘Šè­¦ç­‰çº§ : {TRIGGER.SEVERITY}å‘Šè­¦ä¿¡æ¯ : {TRIGGER.NAME}å‘Šè­¦é¡¹ç›® : {TRIGGER.KEY1}é—®é¢˜è¯¦æƒ… : {ITEM.NAME}:{ITEM.VALUE}å½“å‰çŠ¶æ€ : {TRIGGER.STATUS}:{ITEM.VALUE1}äº‹ä»¶ID : {EVENT.ID} æ¢å¤åçš„å›å¤:OKâ€”MySQL master-slave â€“&gt;{ITEM.VALUE1}MySQL ä¸»ä»é—®é¢˜æ¢å¤ï¼Œè¯·ç¡®è®¤ä¸»ä»çŠ¶æ€ï¼ï¼ï¼å‘Šè­¦ä¸»æœº : {HOSTNAME1}å‘Šè­¦æ—¶é—´ : {EVENT.DATE} {EVENT.TIME}å‘Šè­¦ç­‰çº§ : {TRIGGER.SEVERITY}å‘Šè­¦ä¿¡æ¯ : {TRIGGER.NAME}å‘Šè­¦é¡¹ç›® : {TRIGGER.KEY1}é—®é¢˜è¯¦æƒ… : {ITEM.NAME}:{ITEM.VALUE}å½“å‰çŠ¶æ€ : {TRIGGER.STATUS}:{ITEM.VALUE1}äº‹ä»¶ID : {EVENT.ID} æ¡ä»¶ï¼š zabbixè‡ªå®šä¹‰è„šæœ¬å‘é€é‚®ä»¶ï¼› é¦–å…ˆæˆ‘ä»¬è¦åœ¨zabbix_serverç«¯å¯ç”¨è‡ªå®šä¹‰è„šæœ¬å‘é€é‚®ä»¶ï¼Œåœ¨zabbix_serverä¸»é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ä¸º AlertScriptsPath=/usr/lib/zabbix/alertscripts &nbsp;è„šæœ¬å­˜æ”¾çš„ç›®å½• ç„¶åæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªè„šæœ¬mail.py #!/usr/bin/python#coding:utf-8 import smtplibfrom email.mime.text import MIMETextimport sys #é‚®ç®±æœåŠ¡å™¨åœ°å€mail_host = â€˜smtp.qq.comâ€™#é‚®ç®±ç”¨æˆ·åmail_user = â€˜xxxxxxxâ€™#é‚®ç®±å¯†ç mail_pass = â€˜xxxxxxxxâ€™mail_postfix = â€˜qq.comâ€™ def send_mail(to_list,subject,content): me = mail_user+â€&lt;â€+mail_user+â€@â€+mail_postfix+â€&gt;â€ msg = MIMEText(content,_charset=â€™utf-8â€™) msg[â€˜Subjectâ€™] = subject msg[â€˜Fromâ€™] = me msg[â€˜toâ€™] = to_list try: s = smtplib.SMTP() s.connect(mail_host) s.login(mail\\_user,mail\\_pass) s.sendmail(me,to\\_list,msg.as\\_string()) s.close() return True except Exception,e: print str(e) return False if __name__ == â€œ__main__â€œ: send_mail(sys.argv[1], sys.argv[2], sys.argv[3]) è®°å¾—åŠ ä¸Šæ‰§è¡Œæƒé™ï¼› ç„¶ååœ¨zabbix dashboardä¸Šé¢å®šä¹‰ç”¨æˆ·çš„mediaåŠ ä¸Šç”¨æˆ·çš„é‚®ç®±å³å¯ ä»¥ä¸Šå°±å¯ä»¥å®ç°æŠ¥è­¦å•¦ æµ‹è¯•ä¸€ä¸‹ï¼Œå°†mysql-replication.shè¿™ä¸ªè„šæœ¬çš„å€¼è‡ªå®šä¹‰ä¸€ä¸ªè¾“å‡ºå€¼ä¸º0æˆ–è€…1 æŸ¥çœ‹é‚®ä»¶ï¼š å¦‚æœæ¢å¤åçš„å›å¤ ok å·²ç»æˆåŠŸèƒ½çœ‹åˆ°è¿™ä¸ªç›‘æ§æ²¡é—®é¢˜å•¦ã€‚ ä¸‹é¢æ¥çœ‹ä¸€ä¸‹zabbix + grafana ,è¿™ä¸ªæ˜¯ä½œä¸ºé¡µé¢å±•ç¤ºæ¯”è¾ƒåä¸½çš„æ•ˆæœ åªè¦æ˜¯åœ¨zabbix ä¸­æœ‰çš„ itemséƒ½å¯ä»¥åœ¨grafanaä¸­å±•ç¤ºã€‚","categories":[{"name":"Monitor","slug":"Monitor","permalink":"https://blog.sctux.cc/categories/Monitor/"}],"tags":[{"name":"zabbix","slug":"zabbix","permalink":"https://blog.sctux.cc/tags/zabbix/"},{"name":"grafana","slug":"grafana","permalink":"https://blog.sctux.cc/tags/grafana/"}],"keywords":[{"name":"Monitor","slug":"Monitor","permalink":"https://blog.sctux.cc/categories/Monitor/"}]},{"title":"æ£€æŸ¥æ–‡ä»¶æ—¶é—´æˆ³ï¼Œå¯¹æ¯”æ—¶é—´çš„Shellè„šæœ¬","slug":"e6-a3-80-e6-9f-a5-e6-96-87-e4-bb-b6-e6-97-b6-e9-97-b4-e6-88-b3-ef-bc-8c-e5-af-b9-e6-af-94-e6-97-b6-e9-97-b4-e7-9a-84shell-e8-84-9a-e6-9c-ac","date":"2015-10-16T14:30:11.000Z","updated":"2025-09-01T01:59:08.861Z","comments":true,"path":"2015/10/16/e6-a3-80-e6-9f-a5-e6-96-87-e4-bb-b6-e6-97-b6-e9-97-b4-e6-88-b3-ef-bc-8c-e5-af-b9-e6-af-94-e6-97-b6-e9-97-b4-e7-9a-84shell-e8-84-9a-e6-9c-ac/","permalink":"https://blog.sctux.cc/2015/10/16/e6-a3-80-e6-9f-a5-e6-96-87-e4-bb-b6-e6-97-b6-e9-97-b4-e6-88-b3-ef-bc-8c-e5-af-b9-e6-af-94-e6-97-b6-e9-97-b4-e7-9a-84shell-e8-84-9a-e6-9c-ac/","excerpt":"åº”å¼€å‘éœ€æ±‚ï¼Œæœ‰äº›é”æ–‡ä»¶ç”Ÿæˆä¹‹åä¸ä¼šåœ¨å›ºå®šæ—¶é—´å†…åˆ é™¤ï¼Œé€ æˆç¨‹åºçš„è®¡åˆ’ä»»åŠ¡ä¼šå¡æ­»ï¼Œäºæ˜¯éœ€è¦ä¸€ä¸ªæ£€æŸ¥å¯¹æ¯”locksæ–‡ä»¶çš„è„šæœ¬æ¥å®æ—¶æ£€æµ‹è¿™ä¸ªç›®å½•ä¸‹çš„*.locksæ–‡ä»¶ 12345678910111213141516171819202122232425262728293031#!/bin/bashwhile truedo#è·å–å½“å‰æ—¶é—´curren_time=\\`date +%H:%M:%S\\` #--time-stype=FORMATls -l --time-style=+%H:%M:%S /xxxxxx/*.locks &gt;/tmp/locks 2&gt;/dev/nullwhile read -r linedo#æ–‡ä»¶å†…å®¹file_time=\\`echo $line | awk -F ' ' '{print $6}'\\` #æ–‡ä»¶ç»å¯¹è·¯å¾„åŠåç§°File=\\`echo $line | awk -F ' ' '{print $7}'\\`#è½¬æ¢æˆUnixæ—¶é—´æˆ³date1=\\`date -d \"$curren_time\" +%s\\`date2=\\`date -d \"$file_time\" +%s\\`#å½“å‰æ—¶é—´å‡å»æ–‡ä»¶ç”Ÿäº§æ—¶é—´çš„å·®å€¼è¿›è¡Œæ¯”è¾ƒ(shell çš„è¿ç®—ç”¨exprå…³é”®å­—)DD=$(expr $date1 - $date2)if \\[ $DD -gt 120 \\];then echo \"$curren_time --- Greater than 2 minutes, $File will be delete.\" sleep 2 rm -rf $Filefidone &lt; /tmp/locksdonechmod +x /home/shell/check\\_locks\\_file.shnohup /bin/bash /home/shell/check\\_locks\\_file.sh &gt;/var/log/check_locks.log &amp; ä¸¤ä¸ªå…³é”®ç‚¹1ã€lså‘½ä»¤çš„ç”¨æ³• ï¼š â€“time-type=FORMAT å‚æ•°2ã€å°†å¸¸è§„çš„æ—¶é—´è½¬æ¢æˆUnixæ—¶é—´æˆ³","text":"åº”å¼€å‘éœ€æ±‚ï¼Œæœ‰äº›é”æ–‡ä»¶ç”Ÿæˆä¹‹åä¸ä¼šåœ¨å›ºå®šæ—¶é—´å†…åˆ é™¤ï¼Œé€ æˆç¨‹åºçš„è®¡åˆ’ä»»åŠ¡ä¼šå¡æ­»ï¼Œäºæ˜¯éœ€è¦ä¸€ä¸ªæ£€æŸ¥å¯¹æ¯”locksæ–‡ä»¶çš„è„šæœ¬æ¥å®æ—¶æ£€æµ‹è¿™ä¸ªç›®å½•ä¸‹çš„*.locksæ–‡ä»¶ 12345678910111213141516171819202122232425262728293031#!/bin/bashwhile truedo#è·å–å½“å‰æ—¶é—´curren_time=\\`date +%H:%M:%S\\` #--time-stype=FORMATls -l --time-style=+%H:%M:%S /xxxxxx/*.locks &gt;/tmp/locks 2&gt;/dev/nullwhile read -r linedo#æ–‡ä»¶å†…å®¹file_time=\\`echo $line | awk -F ' ' '{print $6}'\\` #æ–‡ä»¶ç»å¯¹è·¯å¾„åŠåç§°File=\\`echo $line | awk -F ' ' '{print $7}'\\`#è½¬æ¢æˆUnixæ—¶é—´æˆ³date1=\\`date -d \"$curren_time\" +%s\\`date2=\\`date -d \"$file_time\" +%s\\`#å½“å‰æ—¶é—´å‡å»æ–‡ä»¶ç”Ÿäº§æ—¶é—´çš„å·®å€¼è¿›è¡Œæ¯”è¾ƒ(shell çš„è¿ç®—ç”¨exprå…³é”®å­—)DD=$(expr $date1 - $date2)if \\[ $DD -gt 120 \\];then echo \"$curren_time --- Greater than 2 minutes, $File will be delete.\" sleep 2 rm -rf $Filefidone &lt; /tmp/locksdonechmod +x /home/shell/check\\_locks\\_file.shnohup /bin/bash /home/shell/check\\_locks\\_file.sh &gt;/var/log/check_locks.log &amp; ä¸¤ä¸ªå…³é”®ç‚¹1ã€lså‘½ä»¤çš„ç”¨æ³• ï¼š â€“time-type=FORMAT å‚æ•°2ã€å°†å¸¸è§„çš„æ—¶é—´è½¬æ¢æˆUnixæ—¶é—´æˆ³","categories":[{"name":"Shell","slug":"Shell","permalink":"https://blog.sctux.cc/categories/Shell/"},{"name":"è„šæœ¬ç¼–ç¨‹","slug":"Shell/è„šæœ¬ç¼–ç¨‹","permalink":"https://blog.sctux.cc/categories/Shell/%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/"}],"tags":[{"name":"expr","slug":"expr","permalink":"https://blog.sctux.cc/tags/expr/"}],"keywords":[{"name":"Shell","slug":"Shell","permalink":"https://blog.sctux.cc/categories/Shell/"},{"name":"è„šæœ¬ç¼–ç¨‹","slug":"Shell/è„šæœ¬ç¼–ç¨‹","permalink":"https://blog.sctux.cc/categories/Shell/%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/"}]},{"title":"åŸºäºCentOS6.5 X86_64 æºç æ­å»ºGitLab","slug":"e5-9f-ba-e4-ba-8ecentos6-5-x86-64-e6-ba-90-e7-a0-81-e6-90-ad-e5-bb-bagitlab","date":"2015-09-30T07:31:43.000Z","updated":"2025-09-01T01:59:08.937Z","comments":true,"path":"2015/09/30/e5-9f-ba-e4-ba-8ecentos6-5-x86-64-e6-ba-90-e7-a0-81-e6-90-ad-e5-bb-bagitlab/","permalink":"https://blog.sctux.cc/2015/09/30/e5-9f-ba-e4-ba-8ecentos6-5-x86-64-e6-ba-90-e7-a0-81-e6-90-ad-e5-bb-bagitlab/","excerpt":"ç³»ç»Ÿï¼šCentOS6.5 X86_64 å·²å®Œæˆåˆå§‹åŒ–ï¼šé˜²ç«å¢™ã€SELinux å…³é—­ã€ä¸å¿…è¦æœåŠ¡åœæ­¢ï¼Œä¸å¿…è¦ç”¨æˆ·åˆ é™¤â€¦â€¦â€¦ 1.æ·»åŠ epelæº wget -O /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 https://www.fedoraproject.org/static/0608B895.txt &amp;&amp; rpm â€“import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 #æŸ¥çœ‹Keyæ˜¯å¦å®‰è£…æˆåŠŸrpm -qa gpg* &nbsp; 2.å®‰è£…epelæº rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm &nbsp; 3.æ·»åŠ PUIASæº wget -O /etc/yum.repos.d/PUIAS_6_computational.repo https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/install/centos/PUIAS\\_6\\_computational.repo &nbsp; 4.ä¸‹è½½å¹¶å®‰è£…gpg-key wget -O /etc/pki/rpm-gpg/RPM-GPG-KEY-puias http://springdale.math.ias.edu/data/puias/6/x86_64/os/RPM-GPG-KEY-puias &amp;&amp; rpm â€“import /etc/pki/rpm-gpg/RPM-GPG-KEY-puias #æŸ¥çœ‹æºæ˜¯å¦æ·»åŠ æˆåŠŸ[å¦‚æœä¸æˆåŠŸï¼Œæ‰§è¡Œï¼šyum-config-manager â€“enable epel â€“enable PUIAS_6_computational]yum repolist","text":"ç³»ç»Ÿï¼šCentOS6.5 X86_64 å·²å®Œæˆåˆå§‹åŒ–ï¼šé˜²ç«å¢™ã€SELinux å…³é—­ã€ä¸å¿…è¦æœåŠ¡åœæ­¢ï¼Œä¸å¿…è¦ç”¨æˆ·åˆ é™¤â€¦â€¦â€¦ 1.æ·»åŠ epelæº wget -O /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 https://www.fedoraproject.org/static/0608B895.txt &amp;&amp; rpm â€“import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 #æŸ¥çœ‹Keyæ˜¯å¦å®‰è£…æˆåŠŸrpm -qa gpg* &nbsp; 2.å®‰è£…epelæº rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm &nbsp; 3.æ·»åŠ PUIASæº wget -O /etc/yum.repos.d/PUIAS_6_computational.repo https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/install/centos/PUIAS\\_6\\_computational.repo &nbsp; 4.ä¸‹è½½å¹¶å®‰è£…gpg-key wget -O /etc/pki/rpm-gpg/RPM-GPG-KEY-puias http://springdale.math.ias.edu/data/puias/6/x86_64/os/RPM-GPG-KEY-puias &amp;&amp; rpm â€“import /etc/pki/rpm-gpg/RPM-GPG-KEY-puias #æŸ¥çœ‹æºæ˜¯å¦æ·»åŠ æˆåŠŸ[å¦‚æœä¸æˆåŠŸï¼Œæ‰§è¡Œï¼šyum-config-manager â€“enable epel â€“enable PUIAS_6_computational]yum repolist &nbsp; 5.å®‰è£…æ•´ä¸ªæ­å»ºgitlabçš„ç›¸å…³çš„ä¾èµ–åŒ… yum -y groupinstall â€˜Development Toolsâ€™yum -y install readline readline-devel ncurses-devel gdbm-devel glibc-devel tcl-devel openssl-devel curl-devel expat-devel db4-devel byacc sqlite-devel libyaml libyaml-devel libffi libffi-devel libxml2 libxml2-devel libxslt libxslt-devel libicu libicu-devel system-config-firewall-tui redis sudo wget crontabs logwatch logrotate perl-Time-HiRes git cmake libcom_err-devel.i686 libcom_err-devel.x86_64 nodejs &nbsp; 6.é…ç½®é»˜è®¤ç¼–è¾‘å™¨ yum -y install vim-enhancedupdate-alternatives â€“set editor /usr/bin/vim.basicln -s /usr/bin/vim /usr/bin/edito #reStructuredText markupè¯­æ³•æ”¯æŒï¼Œéœ€è¦å®‰è£…ä¾èµ–åŒ…ï¼šyum install -y python-docutils &nbsp; 7.å®‰è£…git(git&gt;=1.7.10 å¦‚æœä½äºæˆ‘ä»¬å¯ä»¥ä»æ–°ç¼–è¯‘å®‰è£…) yum install zlib-devel perl-CPAN gettext curl-devel expat-devel gettext-devel openssl-develmkdir /tmp/git &amp;&amp; cd /tmp/gitcurl â€“progress https://www.kernel.org/pub/software/scm/git/git-2.1.3.tar.gz | tar xzcd git-2.1.3/ &amp;&amp; ./configure â€“prefix=/usr/local/git &amp;&amp; make &amp;&amp; make install &nbsp; 8.å®‰è£…ruby(å¦‚æœç³»ç»Ÿä¸­Rubyçš„ç‰ˆæœ¬æ˜¯2.0ä»¥å‰çš„é‚£ä¹ˆè¯·ç§»é™¤ï¼ŒGitLabåªæ”¯æŒRuby 2.0+ç‰ˆæœ¬) yum remove ruby mkdir /tmp/ruby &amp;&amp; cd /tmp/rubycurl â€“progress ftp://ftp.ruby-lang.org/pub/ruby/2.1/ruby-2.1.2.tar.gz | tar xzcd ruby-2.1.2./configure â€“prefix=/usr/local/ â€“disable-install-rdocmakemake install#è®°å¾—æ£€æŸ¥rubyçš„ç‰ˆæœ¬æ˜¯å¦æ˜¯æœ€æ–°ruby â€“version &nbsp; 9.å®‰è£…Bundler Gem(ç”±äº`http://rubygems.org\\`å·²è¢«å¢™ï¼Œè¿™é‡Œæ›¿æ¢æºä¸º\\`https://ruby.taobao.org\\`) # æ·»åŠ æ·˜å®æºå¹¶ä¸”ç§»é™¤å®˜æ–¹æºgem sources -a https://ruby.taobao.orggem sources -r https://rubygems.org/ &nbsp; 10.å®‰è£…Bundler gem install bundler -vâ€™1.5.2â€™ â€“no-doc &nbsp; 11.System Usersä¸ºGitLabåˆ›å»ºç”¨æˆ· adduser â€“system â€“shell /bin/bash â€“comment â€˜GitLabâ€™ â€“create-home â€“home-dir /home/git/ git &nbsp; 12.ç¼–è¾‘sudoersæ–‡ä»¶ï¼Œå°†rubyå’Œgitçš„ç¨‹åºè·¯å¾„æ·»åŠ åˆ°PATHä¸­ï¼Œä½¿gitç”¨æˆ·ä½œä¸ºrootæ¥ä½¿ç”¨gemå‘½ä»¤ sed -ie â€˜s@Defaults\\ secure_path\\ \\=\\ \\/sbin\\:\\/bin\\:\\/usr\\/sbin\\:\\/usr\\/bin@Defaults\\ secure_path\\ \\=\\ \\/sbin\\:\\/bin\\:\\/usr\\/sbin\\:\\/usr\\/bin\\:/usr\\/local\\/bin@gâ€™ /etc/sudoers &nbsp; 13.å®‰è£…mysql yum install -y mysql mysql-devel mysql-serverservice mysqld start #ä¸ºgitlabåˆ›å»ºæ•°æ®åº“#åˆ›å»ºç”¨æˆ·mysql -e â€œCREATE USER â€˜gitâ€˜@â€™localhostâ€™ IDENTIFIED BY â€˜xxxxxâ€™;â€ #åˆ›å»ºæ•°æ®åº“mysql -e â€œCREATE DATABASE IF NOT EXISTS \\`gitlabhq_production\\` DEFAULT CHARACTER SET \\`utf8\\` COLLATE \\`utf8_unicode_ci\\`;â€ #æˆæƒmysql -e â€œGRANT SELECT, LOCK TABLES, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON \\`gitlabhq_production\\`.* TO â€˜gitâ€˜@â€™localhostâ€™;â€ #ç”¨gitç”¨æˆ·å°è¯•ç™»é™†éªŒè¯æ˜¯å¦æˆåŠŸsudo -u git -H mysql -u git -pxxxxxx -e â€˜show databases;â€™ #è®°å¾—è¦ç»™rootç”¨æˆ·å¯†ç å“¦ã€‚ &nbsp; 14.å®‰è£…redis(å·²ç»åœ¨å‰é¢çš„ä¾èµ–åŒ…å®‰è£…æ—¶å®‰è£…äº†) chkconfig redis on #é…ç½®Redisä½¿ç”¨socketscp /etc/redis.conf /etc/redis.conf.orig # å…³é—­Redis ç›‘å¬äºTCPsed â€˜s/^port .*/port 0/â€˜ /etc/redis.conf.orig | sudo tee /etc/redis.conf #å¯ç”¨Redis socketecho â€˜unixsocket /var/run/redis/redis.sockâ€™ | sudo tee -a /etc/redis.confecho -e â€˜unixsocketperm 0770â€™ | sudo tee -a /etc/redis.conf #è®¾ç½®socketç›®å½•å±ä¸»ï¼ˆç»„ï¼‰ä¸ºredischown redis:redis /var/run/redischmod 755 /var/run/redis #å°†gitç”¨æˆ·æ·»åŠ è‡³redisç»„usermod -aG redis git #å¯åŠ¨redisæœåŠ¡service redis start &nbsp; 15.å®‰è£…gitlabï¼Œä»¥åŠç›¸å…³é…ç½® cd /home/git/sudo -u git -H git clone http://git.oschina.net/Yxnt/gitlab # é…ç½®gitlabcd /home/git/gitlab &amp;&amp; sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml #è®¿é—®åœ°å€ä¸ºæœ¬æœºIPsudo -u git -H sed -ie â€œs/host: .*/host: `hostname â€“all-ip-addresses`/gâ€ config/gitlab.yml #åˆ›å»ºsatellitesç›®å½•sudo -u git -H mkdir /home/git/gitlab-satellites &amp;&amp; chmod u+rwx,g=rx,o-rwx /home/git/gitlab-satellites #ç¡®è®¤gitlabå¯ä»¥å†™å…¥tmp/pidsã€tmp/socketsä»¥åŠpublic/uploads/ç›®å½•chmod -R u+rwX tmp/pids/ &amp;&amp; chmod -R u+rwX tmp/sockets/ &amp;&amp; chmod -R u+rwX public/uploads #å¤åˆ¶Unicorné…ç½®æ–‡ä»¶sudo -u git -H cp config/unicorn.rb.example config/unicorn.rb #å¤åˆ¶Rack attacké…ç½®æ–‡ä»¶sudo -u git -H cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb #é…ç½®Git å…¨å±€è®¾ç½®sudo -u git -H git config â€“global user.name â€œGitLabâ€sudo -u git -H git config â€“global user.email â€œexample@example.comâ€œsudo -u git -H git config â€“global core.autocrlf input #é…ç½®Redisè¿æ¥è®¾ç½®sudo -u git -H cp config/resque.yml.example config/resque.ymlsudo -u git -H sed -ie â€œs/develo.*/development:\\ unix:\\/var\\/run\\/redis\\/redis.sock/gâ€ config/resque.yml #é…ç½®Gitlab æ•°æ®åº“è®¾ç½®ï¼ˆæ³¨æ„è¿™é‡Œçš„socketæ–‡ä»¶ä½ç½®ï¼Œä¸åŒç‰ˆæœ¬çš„mysqlä½ç½®ä¸ä¸€æ ·)sudo -u git cp config/database.yml.mysql config/database.ymlsudo -u git sed -ie â€œ12s/password: \\â€œsecure password\\â€œ/password: $MYSQL_PASS/gâ€ config/database.ymlsudo -u git sed -ie â€œ13,14s/#\\ //gâ€ config/database.ymlsudo -u git sed -ie â€œ14s@socket: \\/tmp\\/mysql.sock@socket: \\/var\\/lib/mysql\\/mysql.sock@gâ€ config/database.yml #ç¡®å®šdatabase.ymlæ–‡ä»¶åªä¸ºgitç”¨æˆ·å¯è¯»sudo -u git -H chmod o-rwx config/database.yml &nbsp; 16.å®‰è£…Gems cd /home/git/gitlab #æ›´æ¢é…ç½®æ–‡ä»¶ä¸­çš„rubyæºsudo -u git -H sed -ie â€œs@source\\ \\â€œhttp:\\/\\/rubygems.org\\â€œ@source\\ \\â€œhttp:\\/\\/ruby.taobao.org\\â€œ@gâ€ ../gitlab-shell/Gemfile #å®‰è£…sudo -u git -H bundle install â€“deployment â€“without development test postgres aws &nbsp; 17.å®‰è£…,é…ç½®gitlab-shell cd /home/git/gitlab/sudo -u git -H bundle exec rake gitlabğŸšinstall[v2.6.3] REDIS_URL=unix:/var/run/redis/redis.sock RAILS_ENV=production #é…ç½®(åœ¨å®‰è£…è¿‡ç¨‹ä¸­å…¶å®gitlab-shellé…ç½®å·²ç»è‡ªåŠ¨ç”Ÿæˆäº†ï¼Œä½†æ˜¯æœ‰å¿…è¦æ£€æŸ¥æ ¸å®ä¸€ä¸‹é‡Œé¢çš„é…ç½®ï¼Œå°¤å…¶æ˜¯gitlab_url)cp /home/git/gitlab-shell/config.yml /home/git/gitlab-shell/config.yml.bak &nbsp; 18.åˆå§‹åŒ–æ•°æ®å¹¶ä¸”æ¿€æ´»é«˜çº§ç‰¹æ€§ #è¿™é‡Œä¼šæç¤ºè¾“å…¥yes/noï¼Œè¾“å…¥yeså³å¯ï¼ˆæˆ‘è¿™é‡Œç›´æ¥ä¼ é€’ä¸€ä¸ªyesè¿‡å»ï¼‰echo yes| sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production#è¿™é‡Œä¼šç”Ÿæˆä¸€ä¸ªè´¦æˆ·å’Œå¯†ç ï¼š#loginâ€¦â€¦â€¦root#passwordâ€¦â€¦5iveL!fe è¿™ä¸ªå¯†ç å¯ä»¥æ›´æ”¹ï¼š sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production GITLAB_ROOT_PASSWORD=YOUR_NETPASSWORD #ç”Ÿæˆjs.cssç­‰æ–‡ä»¶ï¼ˆå¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥çš„è¯ï¼Œä½ åœ¨è®¿é—®æ—¶ç½‘é¡µcssç­‰æ˜¯ä¹±çš„ï¼‰cd /home/git/gitlabbundle exec rake assets:precompile RAILS_ENV=production &nbsp; 19.å®‰è£…gitlabå¯åŠ¨ç®¡ç†è„šæœ¬ wget -O /etc/init.d/gitlab https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/init/sysvinit/centos/gitlab-unicornchmod +x /etc/init.d/gitlabchkconfig â€“add gitlabchkconfig gitlab on #è®¾ç½®gitlabæœåŠ¡çš„æ—¥å¿—æ»šåŠ¨cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab &nbsp; 20.æ£€æŸ¥åº”ç”¨ç¨‹åºçŠ¶æ€ sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production#æ‰§è¡Œè¯¥å‘½ä»¤ å¦‚æœé¡ºåˆ©çš„è¯ï¼Œä¼šå°†å…³äºgitlabçš„ ç›¸å…³è¯¦ç»†ä¿¡æ¯å±•ç¤ºå‡ºæ¥ å’Œä¸‹å›¾å·®ä¸å¤š &nbsp; 21.å¯åŠ¨gitlab #å¯åŠ¨gitlabservice gitlab start &nbsp; 22.å®‰è£…nginx ï¼Œå°†è®¿é—®è¯·æ±‚åä»£åˆ°åç«¯çš„8080ç«¯å£ yum install -y nginx &amp;&amp; chkconfig nginx on #åˆ é™¤nginxä¸­çš„è¿™ä¸ªé»˜è®¤é…ç½®æ–‡ä»¶rm -rf /etc/nginx/conf.d/default.conf #è·å–gitlabçš„nginxæ¨¡æ¿é…ç½®æ–‡ä»¶wget -O /etc/nginx/conf.d/gitlab.conf https://gitlab.com/gitlab-org/gitlab-ce/raw/master/lib/support/nginx/gitlab #å¯¹æ¨¡æ¿æ–‡ä»¶çš„ä¸€äº›ä¿®æ”¹sed -ie â€œ38s/.*/server\\ localhost:8080;/gâ€ /etc/nginx/conf.d/gitlab.confsed -ie â€œs/YOUR_SERVER_FQDN/`hostname`/gâ€ /etc/nginx/conf.d/gitlab.confsed -ie â€œ52dâ€ /etc/nginx/conf.d/gitlab.conf #å°†ç”¨æˆ·nginxåŠ å…¥åˆ°gitç»„(è¿™æ­¥éå¸¸çš„å…³é”®)usermod -a -G git nginxchmod g+rx /home/git/ #å¯åŠ¨nginxservice nginx start &nbsp; ok ï¼Œè‡³æ­¤gitlabçš„å®‰è£…å·²ç»ç»“æŸã€‚æˆ‘ä»¬é€šè¿‡http://YOUR-SERVER-IP/ å°±å¯ä»¥è®¿é—®åˆ°ä½ çš„gitlabå¹³å°äº†","categories":[{"name":"Webç›¸å…³","slug":"Webç›¸å…³","permalink":"https://blog.sctux.cc/categories/Web%E7%9B%B8%E5%85%B3/"}],"tags":[{"name":"git","slug":"git","permalink":"https://blog.sctux.cc/tags/git/"},{"name":"gitlab","slug":"gitlab","permalink":"https://blog.sctux.cc/tags/gitlab/"}],"keywords":[{"name":"Webç›¸å…³","slug":"Webç›¸å…³","permalink":"https://blog.sctux.cc/categories/Web%E7%9B%B8%E5%85%B3/"}]},{"title":"é€šè¿‡Inodeåˆ é™¤linuxä¸‹çš„æ–‡ä»¶","slug":"e9-80-9a-e8-bf-87inode-e5-88-a0-e9-99-a4linux-e4-b8-8b-e7-9a-84-e6-96-87-e4-bb-b6","date":"2015-09-19T05:38:20.000Z","updated":"2025-09-01T01:59:08.958Z","comments":true,"path":"2015/09/19/e9-80-9a-e8-bf-87inode-e5-88-a0-e9-99-a4linux-e4-b8-8b-e7-9a-84-e6-96-87-e4-bb-b6/","permalink":"https://blog.sctux.cc/2015/09/19/e9-80-9a-e8-bf-87inode-e5-88-a0-e9-99-a4linux-e4-b8-8b-e7-9a-84-e6-96-87-e4-bb-b6/","excerpt":"ç”±äºæŸäº›åŸå› åœ¨æˆ‘ä»¬linuxç³»ç»Ÿä¸Šé¢æ€»ä¼šå‡ºç°ä¸€äº›ä¹±ç æ–‡ä»¶ï¼Œæˆ–è€…ä¸èƒ½æ­£å¸¸è¾“å…¥çš„æ–‡ä»¶åï¼Œå½“é‡åˆ°è¿™äº›æ— æ³•æ­£å¸¸è¾“å…¥çš„æ–‡ä»¶åè¦åˆ é™¤çš„æ—¶å€™å°±éœ€è¦ä½¿ç”¨æ–‡ä»¶å¯¹åº”çš„inodeå·å¯¹æ–‡ä»¶è¿›è¡Œåˆ é™¤ã€‚ inodeçš„åŸç†è¿™é‡Œå°±ä¸å†è¯´äº†ï¼Œå…·ä½“è¯´æ˜å‚è§ï¼šhttp://www.ruanyifeng.com/blog/2011/12/inode.html ä¸‹é¢è¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶æ˜¯æˆ‘åœ¨ç½‘ä¸Šä¸‹è½½çš„ä¸€ä¸ªç½‘é¡µæ¨¡æ¿ï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ªä¸èƒ½rm çš„æ–‡ä»¶ï¼š é‚£ä»ä½•å¾—çŸ¥ -?+?.txt è¿™ä¸ªæ–‡ä»¶çš„inodeå·å‘¢ï¼Œls&nbsp; å‘½ä»¤æœ‰ä¸ªå‚æ•° -i -i, â€“inode print the index number of each file ä¸Šå›¾ä¸­ï¼š291606&nbsp; è¿™ä¸ªå·ç å°±æ˜¯ è¿™ä¸ªæ–‡ä»¶çš„inode å·å•¦ã€‚ç„¶åæˆ‘ä»¬ç»“åˆfindå‘½ä»¤å°±å¯ä»¥å°†å®ƒåˆ é™¤å•¦","text":"ç”±äºæŸäº›åŸå› åœ¨æˆ‘ä»¬linuxç³»ç»Ÿä¸Šé¢æ€»ä¼šå‡ºç°ä¸€äº›ä¹±ç æ–‡ä»¶ï¼Œæˆ–è€…ä¸èƒ½æ­£å¸¸è¾“å…¥çš„æ–‡ä»¶åï¼Œå½“é‡åˆ°è¿™äº›æ— æ³•æ­£å¸¸è¾“å…¥çš„æ–‡ä»¶åè¦åˆ é™¤çš„æ—¶å€™å°±éœ€è¦ä½¿ç”¨æ–‡ä»¶å¯¹åº”çš„inodeå·å¯¹æ–‡ä»¶è¿›è¡Œåˆ é™¤ã€‚ inodeçš„åŸç†è¿™é‡Œå°±ä¸å†è¯´äº†ï¼Œå…·ä½“è¯´æ˜å‚è§ï¼šhttp://www.ruanyifeng.com/blog/2011/12/inode.html ä¸‹é¢è¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶æ˜¯æˆ‘åœ¨ç½‘ä¸Šä¸‹è½½çš„ä¸€ä¸ªç½‘é¡µæ¨¡æ¿ï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ªä¸èƒ½rm çš„æ–‡ä»¶ï¼š é‚£ä»ä½•å¾—çŸ¥ -?+?.txt è¿™ä¸ªæ–‡ä»¶çš„inodeå·å‘¢ï¼Œls&nbsp; å‘½ä»¤æœ‰ä¸ªå‚æ•° -i -i, â€“inode print the index number of each file ä¸Šå›¾ä¸­ï¼š291606&nbsp; è¿™ä¸ªå·ç å°±æ˜¯ è¿™ä¸ªæ–‡ä»¶çš„inode å·å•¦ã€‚ç„¶åæˆ‘ä»¬ç»“åˆfindå‘½ä»¤å°±å¯ä»¥å°†å®ƒåˆ é™¤å•¦","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"inode","slug":"inode","permalink":"https://blog.sctux.cc/tags/inode/"}],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}]},{"title":"Expectè¯¦è§£(sshè‡ªåŠ¨ç™»å½•)","slug":"expect-e8-af-a6-e8-a7-a3ssh-e8-87-aa-e5-8a-a8-e7-99-bb-e5-bd-95","date":"2015-09-16T06:31:02.000Z","updated":"2025-09-01T01:59:08.958Z","comments":true,"path":"2015/09/16/expect-e8-af-a6-e8-a7-a3ssh-e8-87-aa-e5-8a-a8-e7-99-bb-e5-bd-95/","permalink":"https://blog.sctux.cc/2015/09/16/expect-e8-af-a6-e8-a7-a3ssh-e8-87-aa-e5-8a-a8-e7-99-bb-e5-bd-95/","excerpt":"Expectæ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†äº¤äº’çš„å‘½ä»¤ã€‚å€ŸåŠ©Expectï¼Œæˆ‘ä»¬å¯ä»¥å°†äº¤äº’è¿‡ç¨‹å†™åœ¨ä¸€ä¸ªè„šæœ¬ä¸Šï¼Œä½¿ä¹‹è‡ªåŠ¨åŒ–å®Œæˆã€‚å½¢è±¡çš„è¯´ï¼Œsshç™»å½•ï¼Œftpç™»å½•ç­‰éƒ½ç¬¦åˆäº¤äº’çš„å®šä¹‰ã€‚ä¸‹æ–‡æˆ‘ä»¬é¦–å…ˆæå‡ºä¸€ä¸ªé—®é¢˜ï¼Œç„¶åä»‹ç»åŸºç¡€çŸ¥å››ä¸ªå‘½ä»¤ï¼Œæœ€åæå‡ºè§£å†³æ–¹æ³•ã€‚ Expectä¸­æœ€å…³é”®çš„å››ä¸ªå‘½ä»¤æ˜¯send,expect,spawn,interactã€‚ sendï¼šç”¨äºå‘è¿›ç¨‹å‘é€å­—ç¬¦ä¸²expectï¼šä»è¿›ç¨‹æ¥æ”¶å­—ç¬¦ä¸²spawnï¼šå¯åŠ¨æ–°çš„è¿›ç¨‹interactï¼šå…è®¸ç”¨æˆ·äº¤äº’ 1. sendå‘½ä»¤sendå‘½ä»¤æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œå¹¶å°†è¯¥å‚æ•°å‘é€åˆ°è¿›ç¨‹ã€‚ expect1.1&gt; send â€œhello world\\nâ€hello world 2. expectå‘½ä»¤(1)åŸºç¡€çŸ¥è¯†expectå‘½ä»¤å’Œsendå‘½ä»¤æ­£å¥½ç›¸åï¼Œexpecté€šå¸¸æ˜¯ç”¨æ¥ç­‰å¾…ä¸€ä¸ªè¿›ç¨‹çš„åé¦ˆã€‚expectå¯ä»¥æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œä¹Ÿå¯ä»¥æ¥æ”¶æ­£åˆ™è¡¨è¾¾å¼å‚æ•°ã€‚å’Œä¸Šæ–‡çš„sendå‘½ä»¤ç»“åˆï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„äº¤äº’å¼çš„ä¾‹å­ï¼š expect â€œhi\\nâ€send â€œhello there!\\nâ€ è¿™ä¸¤è¡Œä»£ç çš„æ„æ€æ˜¯ï¼šä»æ ‡å‡†è¾“å…¥ä¸­ç­‰åˆ°hiå’Œæ¢è¡Œé”®åï¼Œå‘æ ‡å‡†è¾“å‡ºè¾“å‡ºhello thereã€‚","text":"Expectæ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†äº¤äº’çš„å‘½ä»¤ã€‚å€ŸåŠ©Expectï¼Œæˆ‘ä»¬å¯ä»¥å°†äº¤äº’è¿‡ç¨‹å†™åœ¨ä¸€ä¸ªè„šæœ¬ä¸Šï¼Œä½¿ä¹‹è‡ªåŠ¨åŒ–å®Œæˆã€‚å½¢è±¡çš„è¯´ï¼Œsshç™»å½•ï¼Œftpç™»å½•ç­‰éƒ½ç¬¦åˆäº¤äº’çš„å®šä¹‰ã€‚ä¸‹æ–‡æˆ‘ä»¬é¦–å…ˆæå‡ºä¸€ä¸ªé—®é¢˜ï¼Œç„¶åä»‹ç»åŸºç¡€çŸ¥å››ä¸ªå‘½ä»¤ï¼Œæœ€åæå‡ºè§£å†³æ–¹æ³•ã€‚ Expectä¸­æœ€å…³é”®çš„å››ä¸ªå‘½ä»¤æ˜¯send,expect,spawn,interactã€‚ sendï¼šç”¨äºå‘è¿›ç¨‹å‘é€å­—ç¬¦ä¸²expectï¼šä»è¿›ç¨‹æ¥æ”¶å­—ç¬¦ä¸²spawnï¼šå¯åŠ¨æ–°çš„è¿›ç¨‹interactï¼šå…è®¸ç”¨æˆ·äº¤äº’ 1. sendå‘½ä»¤sendå‘½ä»¤æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œå¹¶å°†è¯¥å‚æ•°å‘é€åˆ°è¿›ç¨‹ã€‚ expect1.1&gt; send â€œhello world\\nâ€hello world 2. expectå‘½ä»¤(1)åŸºç¡€çŸ¥è¯†expectå‘½ä»¤å’Œsendå‘½ä»¤æ­£å¥½ç›¸åï¼Œexpecté€šå¸¸æ˜¯ç”¨æ¥ç­‰å¾…ä¸€ä¸ªè¿›ç¨‹çš„åé¦ˆã€‚expectå¯ä»¥æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œä¹Ÿå¯ä»¥æ¥æ”¶æ­£åˆ™è¡¨è¾¾å¼å‚æ•°ã€‚å’Œä¸Šæ–‡çš„sendå‘½ä»¤ç»“åˆï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„äº¤äº’å¼çš„ä¾‹å­ï¼š expect â€œhi\\nâ€send â€œhello there!\\nâ€ è¿™ä¸¤è¡Œä»£ç çš„æ„æ€æ˜¯ï¼šä»æ ‡å‡†è¾“å…¥ä¸­ç­‰åˆ°hiå’Œæ¢è¡Œé”®åï¼Œå‘æ ‡å‡†è¾“å‡ºè¾“å‡ºhello thereã€‚ tipsï¼š $expect_out(buffer)å­˜å‚¨äº†æ‰€æœ‰å¯¹expectçš„è¾“å…¥ï¼Œ&lt;$expect_out(0,string)&gt;å­˜å‚¨äº†åŒ¹é…åˆ°expectå‚æ•°çš„è¾“å…¥ã€‚ æ¯”å¦‚å¦‚ä¸‹ç¨‹åºï¼š expect â€œhi\\nâ€send â€œyou typed &lt;$expect_out(buffer)&gt;â€send â€œbut I only expected &lt;$expect_out(0,string)&gt;â€ å½“åœ¨æ ‡å‡†è¾“å…¥ä¸­è¾“å…¥ testhi æ˜¯ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ you typed: testhiI only expect: hi (2)æ¨¡å¼-åŠ¨ä½œexpectæœ€å¸¸ç”¨çš„è¯­æ³•æ˜¯æ¥è‡ªtclè¯­è¨€çš„æ¨¡å¼-åŠ¨ä½œã€‚è¿™ç§è¯­æ³•æå…¶çµæ´»ï¼Œä¸‹é¢æˆ‘ä»¬å°±å„ç§è¯­æ³•åˆ†åˆ«è¯´æ˜ã€‚ å•ä¸€åˆ†æ”¯æ¨¡å¼è¯­æ³•ï¼š expect â€œhiâ€ {send â€œYou said hiâ€} åŒ¹é…åˆ°hiåï¼Œä¼šè¾“å‡ºâ€you said hiâ€ å¤šåˆ†æ”¯æ¨¡å¼è¯­æ³•ï¼š expect â€œhiâ€ { send â€œYou said hi\\nâ€ } â€œhelloâ€ { send â€œHello yourself\\nâ€ } â€œbyeâ€ { send â€œThat was unexpected\\nâ€ } åŒ¹é…åˆ°hi,hello,byeä»»æ„ä¸€ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œæ‰§è¡Œç›¸åº”çš„è¾“å‡ºã€‚ç­‰åŒäºå¦‚ä¸‹å†™æ³•ï¼š expect {â€œhiâ€ { send â€œYou said hi\\nâ€}â€œhelloâ€ { send â€œHello yourself\\nâ€}â€œbyeâ€ { send â€œThat was unexpected\\nâ€}} 3. spawnå‘½ä»¤ä¸Šæ–‡çš„æ‰€æœ‰demoéƒ½æ˜¯å’Œæ ‡å‡†è¾“å…¥è¾“å‡ºè¿›è¡Œäº¤äº’ï¼Œä½†æ˜¯æˆ‘ä»¬è·Ÿå¸Œæœ›ä»–å¯ä»¥å’ŒæŸä¸€ä¸ªè¿›ç¨‹è¿›è¡Œäº¤äº’ã€‚spawmå‘½ä»¤å°±æ˜¯ç”¨æ¥å¯åŠ¨æ–°çš„è¿›ç¨‹çš„ã€‚spawnå çš„sendå’Œexpectå‘½ä»¤éƒ½æ˜¯å’Œspawnæ‰“å¼€çš„è¿›ç¨‹è¿›è¡Œäº¤äº’çš„ã€‚ç»“åˆä¸Šæ–‡çš„sendå’Œexpectå‘½ä»¤æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æ›´å¤æ‚çš„ç¨‹åºæ®µäº†ã€‚ set timeout -1spawn ftp ftp.test.com //æ‰“å¼€æ–°çš„è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹ç”¨æˆ·è¿æ¥è¿œç¨‹ftpæœåŠ¡å™¨expect â€œNameâ€ //è¿›ç¨‹è¿”å›Nameæ—¶send â€œuser\\râ€ //å‘è¿›ç¨‹è¾“å…¥anonymous\\rexpect â€œPassword:â€ //è¿›ç¨‹è¿”å›Password:æ—¶send â€œ123456\\râ€ //å‘è¿›ç¨‹è¾“å…¥don@libes.com\\rexpect â€œftp&gt; â€œ //è¿›ç¨‹è¿”å›ftp&gt;æ—¶send â€œbinary\\râ€ //å‘è¿›ç¨‹è¾“å…¥binary\\rexpect â€œftp&gt; â€œ //è¿›ç¨‹è¿”å›ftp&gt;æ—¶send â€œget test.tar.gz\\râ€ //å‘è¿›ç¨‹è¾“å…¥get test.tar.gz\\r è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯ç™»å½•åˆ°ftpæœåŠ¡å™¨ftp ftp.uu.netä¸Šï¼Œå¹¶ä»¥äºŒè¿›åˆ¶çš„æ–¹å¼ä¸‹è½½æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶test.tar.gzã€‚ç¨‹åºä¸­æœ‰è¯¦ç»†çš„æ³¨é‡Šã€‚ 4.interactåˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ç»“åˆspawnã€expectã€sendè‡ªåŠ¨åŒ–çš„å®Œæˆå¾ˆå¤šä»»åŠ¡äº†ã€‚ä½†æ˜¯ï¼Œå¦‚ä½•è®©äººåœ¨é€‚å½“çš„æ—¶å€™å¹²é¢„è¿™ä¸ªè¿‡ç¨‹äº†ã€‚æ¯”å¦‚ä¸‹è½½å®Œ ftpæ–‡ä»¶æ—¶ï¼Œä»ç„¶å¯ä»¥åœç•™åœ¨ftpå‘½ä»¤è¡ŒçŠ¶æ€ï¼Œä»¥ä¾¿æ‰‹åŠ¨çš„æ‰§è¡Œåç»­å‘½ä»¤ã€‚interactå¯ä»¥è¾¾åˆ°è¿™äº›ç›®çš„ã€‚ä¸‹é¢çš„demoåœ¨è‡ªåŠ¨ç™»å½•ftpåï¼Œå…è®¸ç”¨ æˆ·äº¤äº’ã€‚ spawn ftp ftp.test.comexpect â€œNameâ€send â€œuser\\râ€expect â€œPassword:â€send â€œ123456\\râ€interact å¦‚ä½•å®ç°expect sshè‡ªåŠ¨ç™»å½•ï¼Ÿ yum install -y expect vim loging_myvps.sh#!/usr/bin/expect -fset ip xxx.xxx.xxx.xxxset password **********set timeout 10spawn ssh USERNAME@$ipexpect {â€œ*yes/noâ€ { send â€œyes\\râ€; exp_continue}â€œ*password:â€ { send â€œ$password\\râ€ }}interact ./login_myvps.sh å³å¯ç™»å½•","categories":[{"name":"Shell","slug":"Shell","permalink":"https://blog.sctux.cc/categories/Shell/"},{"name":"è„šæœ¬ç¼–ç¨‹","slug":"Shell/è„šæœ¬ç¼–ç¨‹","permalink":"https://blog.sctux.cc/categories/Shell/%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/"}],"tags":[{"name":"expect","slug":"expect","permalink":"https://blog.sctux.cc/tags/expect/"}],"keywords":[{"name":"Shell","slug":"Shell","permalink":"https://blog.sctux.cc/categories/Shell/"},{"name":"è„šæœ¬ç¼–ç¨‹","slug":"Shell/è„šæœ¬ç¼–ç¨‹","permalink":"https://blog.sctux.cc/categories/Shell/%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/"}]},{"title":"Python os.systemçš„ç»“æœä¸èƒ½èµ‹å€¼åˆ°å˜é‡","slug":"python-os-system-e7-9a-84-e7-bb-93-e6-9e-9c-e4-b8-8d-e8-83-bd-e8-b5-8b-e5-80-bc-e5-88-b0-e5-8f-98-e9-87-8f","date":"2015-09-15T14:52:05.000Z","updated":"2025-09-01T01:59:08.860Z","comments":true,"path":"2015/09/15/python-os-system-e7-9a-84-e7-bb-93-e6-9e-9c-e4-b8-8d-e8-83-bd-e8-b5-8b-e5-80-bc-e5-88-b0-e5-8f-98-e9-87-8f/","permalink":"https://blog.sctux.cc/2015/09/15/python-os-system-e7-9a-84-e7-bb-93-e6-9e-9c-e4-b8-8d-e8-83-bd-e8-b5-8b-e5-80-bc-e5-88-b0-e5-8f-98-e9-87-8f/","excerpt":"ä»Šå¤©åœ¨å­¦ä¹ python osæ¨¡å—çš„systemæ–¹æ³•æ—¶ï¼Œå‘ç°ä¸èƒ½èµ‹å€¼ç»™å˜é‡ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ &nbsp; åæ¥æŸ¥è¯¢å¾—çŸ¥æœ‰æ›´æ–°çš„æ¨¡å—ï¼Œå¦‚ä¸‹ï¼š os.systemos.spawn*os.popen*popen2.*commands.* é‡æ–°ä½¿ç”¨a = os.popen(â€˜df -hTâ€™).read()&nbsp; å°±èƒ½è·å–åˆ°å•¦ã€‚","text":"ä»Šå¤©åœ¨å­¦ä¹ python osæ¨¡å—çš„systemæ–¹æ³•æ—¶ï¼Œå‘ç°ä¸èƒ½èµ‹å€¼ç»™å˜é‡ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ &nbsp; åæ¥æŸ¥è¯¢å¾—çŸ¥æœ‰æ›´æ–°çš„æ¨¡å—ï¼Œå¦‚ä¸‹ï¼š os.systemos.spawn*os.popen*popen2.*commands.* é‡æ–°ä½¿ç”¨a = os.popen(â€˜df -hTâ€™).read()&nbsp; å°±èƒ½è·å–åˆ°å•¦ã€‚","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}],"tags":[],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}]},{"title":"Git ä»£ç æ‹‰å–ã€åŒæ­¥ã€é€šçŸ¥","slug":"git-e4-bb-a3-e7-a0-81-e6-8b-89-e5-8f-96-e3-80-81-e5-90-8c-e6-ad-a5-e3-80-81-e9-80-9a-e7-9f-a5","date":"2015-09-14T06:10:14.000Z","updated":"2025-09-01T01:59:08.958Z","comments":true,"path":"2015/09/14/git-e4-bb-a3-e7-a0-81-e6-8b-89-e5-8f-96-e3-80-81-e5-90-8c-e6-ad-a5-e3-80-81-e9-80-9a-e7-9f-a5/","permalink":"https://blog.sctux.cc/2015/09/14/git-e4-bb-a3-e7-a0-81-e6-8b-89-e5-8f-96-e3-80-81-e5-90-8c-e6-ad-a5-e3-80-81-e9-80-9a-e7-9f-a5/","excerpt":"ä»£ç æ‰˜ç®¡åˆ°gtihubï¼Œå¼€å‘äººå‘˜è¿›è¡Œæœ¬åœ°ä¿®æ”¹pushåˆ°ä»“åº“åï¼Œè¿™é‡Œä½¿ç”¨pullåœ¨webæœåŠ¡å™¨ä¸Šå®šæœŸæ‹‰å»ä»£ç è‡³å¼€å‘å¼€å‘æœåŠ¡å™¨ more code_sync_template.sh#!/bin/shupdate_dir=â€/home/demo/â€œ #every time upload code main dirwebroot=â€/var/www/templateâ€#bak_dir=â€/codedata/bak/deployâ€ #backup file main dirgibin=â€/usr/bin/gitâ€ #git bin pathrsync_bin=â€/usr/bin/rsyncâ€ #rsync path#è¿™ä¸ªå˜é‡å®šä¹‰çš„æ˜¯ä»£ç æ‹‰å–åˆ°æœ¬åœ°ä¹‹ååŒæ­¥åˆ°webç›®å½•æ—¶è¿‡æ’é™¤ä¸€äº›ç‰¹å®šçš„æ–‡ä»¶#rsync_exclude=â€.svn|.gz|.cache|.txt|.git|_tmp|temp|pma|dsn.php|gem*|global_config.phpâ€œName=â€templateâ€LOG=â€/var/log/code_sync_template.logâ€TIME=`date +%F\\ %T`OLD_IFS=â€$IFSâ€ #backup IFSCOMMAND=â€sed -n â€˜/$TIME start/,\\$pâ€™ $LOG &gt; /tmp/template.logâ€ #get gitos code to localpull_code(){if [ -d $update_dir/$Name ];then if cd $update_dir/$Name &amp;&amp; $gibin pull git@è¿™é‡Œæ˜¯ä½ çš„ä»£ç ä»“åº“åœ°å€ &amp;&gt;&gt; $LOG ;then echo -e â€œ\\033[32m `date` git pull code success \\033[mâ€ else echo -e â€œ\\033[31m `date` git pull code error \\033[mâ€ &amp;&amp; exit 1 fielse echo -e â€œ\\033[32m Clone code to local. \\033[mâ€ cd $update_dir &amp;&amp; $gibin clone git@è¿™é‡Œæ˜¯ä½ çš„ä»£ç ä»“åº“åœ°å€fi} #sync local code to webroot#å®šä¹‰çš„æ˜¯å°†æœ€æ–°æ‹‰å–åˆ°çš„ä»£ç åŒæ­¥åˆ°webç›®å½•sync_code(){ #$rsync_bin -uavz $update_dir/$Name $webroot/$Nameif [ â€œ$rsync_excludeâ€ ];thenIFS=â€|â€ exclude_arr=($rsync_exclude) for e_arr in ${exclude_arr[@]};do echo $e_arr &gt;&gt;/tmp/code_exclude_list done $rsync_bin -avz â€“exclude-from=â€/tmp/code_exclude_listâ€ $update_dir/$Name/* $webroot/else $rsync_bin -avz $update_dir/$Name/* $webroot/fiIFS=â€$OLD_IFSâ€} Notice(){ #è¿™ä¸ªæ˜¯é€šè¿‡ä¸€ä¸ªevalå‘½ä»¤æ¥æ‰§è¡Œä¸€æ®µå‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤æè¿°çš„æ˜¯ä»ä¸Šæ¬¡è„šæœ¬æ‰§è¡Œè®°å½•æ—¥å¿—åå¼€å§‹åˆ°æœ€åçš„æ—¥å¿—ä¿¡æ¯eval $COMMAND #è¿™é‡Œæ˜¯åœ¨è¿‡æ»¤æ­¤æ¬¡åŒæ­¥æ˜¯è®°å½•çš„æ—¥å¿—ä¸­pullæœ‰æ²¡æœ‰æ–‡ä»¶æ›´æ–°grep -E â€œfiles changed|Fast-forwardâ€ /tmp/template.logif [ $? -eq 0 ];then #è¿™é‡Œä½¿ç”¨ä¸€ä¸ªpythonè„šæœ¬æ¥è·å–pullæ—¶æ›´æ–°äº†çš„å…·ä½“æ–‡ä»¶æœ‰å“ªäº›ï¼Œç„¶åå°†å†…å®¹é€šè¿‡é‚®ä»¶å‘é€åˆ°æŒ‡å®šé‚®ç®± python /home/demo/mail-template.pyelse exit 5fi} echo â€˜ â€˜ &gt;&gt; $LOGecho -e â€œ\\033[42;37m ############ Template $TIME start ############ \\033[mâ€ &gt;&gt; $LOGecho -e â€œ\\033[47;30m Template Pull remote code to local. \\033[0mâ€ &gt;&gt; $LOGecho -e â€œ\\033[47;30m Template Pull remote code to local. \\033[0mâ€pull_code &gt;&gt; $LOGecho -e â€œ\\033[47;30m Template Sync local code to wwwroot.\\033[0mâ€ &gt;&gt; $LOGecho -e â€œ\\033[47;30m Template Sync local code to wwwroot.\\033[0mâ€sync_code &gt;&gt; $LOGecho -e â€œ\\033[46;37m ############ Template $TIME end ############ \\033[mâ€ &gt;&gt; $LOGecho â€˜ â€˜ &gt;&gt; $LOGNotice &nbsp; é‚®ä»¶é€šçŸ¥è„šæœ¬ï¼Œèƒ½å¤Ÿåœ¨è‡ªå®šä¹‰çš„æ—¶é—´å‘¨æœŸå†…è·å–åˆ°æœ€æ–°ä»£ç æ—¶ èƒ½å‘é€é‚®ä»¶åˆ°æŒ‡å®šçš„é‚®ç®±ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æé†’ç®¡ç†äººå‘˜çŸ¥æ‚‰è¿™ä¸€åŠ¨ä½œã€‚ #!/usr/bin/env python#-*- coding: UTF-8 -*-import smtplibimport os,sysfrom email.mime.text import MIMEText","text":"ä»£ç æ‰˜ç®¡åˆ°gtihubï¼Œå¼€å‘äººå‘˜è¿›è¡Œæœ¬åœ°ä¿®æ”¹pushåˆ°ä»“åº“åï¼Œè¿™é‡Œä½¿ç”¨pullåœ¨webæœåŠ¡å™¨ä¸Šå®šæœŸæ‹‰å»ä»£ç è‡³å¼€å‘å¼€å‘æœåŠ¡å™¨ more code_sync_template.sh#!/bin/shupdate_dir=â€/home/demo/â€œ #every time upload code main dirwebroot=â€/var/www/templateâ€#bak_dir=â€/codedata/bak/deployâ€ #backup file main dirgibin=â€/usr/bin/gitâ€ #git bin pathrsync_bin=â€/usr/bin/rsyncâ€ #rsync path#è¿™ä¸ªå˜é‡å®šä¹‰çš„æ˜¯ä»£ç æ‹‰å–åˆ°æœ¬åœ°ä¹‹ååŒæ­¥åˆ°webç›®å½•æ—¶è¿‡æ’é™¤ä¸€äº›ç‰¹å®šçš„æ–‡ä»¶#rsync_exclude=â€.svn|.gz|.cache|.txt|.git|_tmp|temp|pma|dsn.php|gem*|global_config.phpâ€œName=â€templateâ€LOG=â€/var/log/code_sync_template.logâ€TIME=`date +%F\\ %T`OLD_IFS=â€$IFSâ€ #backup IFSCOMMAND=â€sed -n â€˜/$TIME start/,\\$pâ€™ $LOG &gt; /tmp/template.logâ€ #get gitos code to localpull_code(){if [ -d $update_dir/$Name ];then if cd $update_dir/$Name &amp;&amp; $gibin pull git@è¿™é‡Œæ˜¯ä½ çš„ä»£ç ä»“åº“åœ°å€ &amp;&gt;&gt; $LOG ;then echo -e â€œ\\033[32m `date` git pull code success \\033[mâ€ else echo -e â€œ\\033[31m `date` git pull code error \\033[mâ€ &amp;&amp; exit 1 fielse echo -e â€œ\\033[32m Clone code to local. \\033[mâ€ cd $update_dir &amp;&amp; $gibin clone git@è¿™é‡Œæ˜¯ä½ çš„ä»£ç ä»“åº“åœ°å€fi} #sync local code to webroot#å®šä¹‰çš„æ˜¯å°†æœ€æ–°æ‹‰å–åˆ°çš„ä»£ç åŒæ­¥åˆ°webç›®å½•sync_code(){ #$rsync_bin -uavz $update_dir/$Name $webroot/$Nameif [ â€œ$rsync_excludeâ€ ];thenIFS=â€|â€ exclude_arr=($rsync_exclude) for e_arr in ${exclude_arr[@]};do echo $e_arr &gt;&gt;/tmp/code_exclude_list done $rsync_bin -avz â€“exclude-from=â€/tmp/code_exclude_listâ€ $update_dir/$Name/* $webroot/else $rsync_bin -avz $update_dir/$Name/* $webroot/fiIFS=â€$OLD_IFSâ€} Notice(){ #è¿™ä¸ªæ˜¯é€šè¿‡ä¸€ä¸ªevalå‘½ä»¤æ¥æ‰§è¡Œä¸€æ®µå‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤æè¿°çš„æ˜¯ä»ä¸Šæ¬¡è„šæœ¬æ‰§è¡Œè®°å½•æ—¥å¿—åå¼€å§‹åˆ°æœ€åçš„æ—¥å¿—ä¿¡æ¯eval $COMMAND #è¿™é‡Œæ˜¯åœ¨è¿‡æ»¤æ­¤æ¬¡åŒæ­¥æ˜¯è®°å½•çš„æ—¥å¿—ä¸­pullæœ‰æ²¡æœ‰æ–‡ä»¶æ›´æ–°grep -E â€œfiles changed|Fast-forwardâ€ /tmp/template.logif [ $? -eq 0 ];then #è¿™é‡Œä½¿ç”¨ä¸€ä¸ªpythonè„šæœ¬æ¥è·å–pullæ—¶æ›´æ–°äº†çš„å…·ä½“æ–‡ä»¶æœ‰å“ªäº›ï¼Œç„¶åå°†å†…å®¹é€šè¿‡é‚®ä»¶å‘é€åˆ°æŒ‡å®šé‚®ç®± python /home/demo/mail-template.pyelse exit 5fi} echo â€˜ â€˜ &gt;&gt; $LOGecho -e â€œ\\033[42;37m ############ Template $TIME start ############ \\033[mâ€ &gt;&gt; $LOGecho -e â€œ\\033[47;30m Template Pull remote code to local. \\033[0mâ€ &gt;&gt; $LOGecho -e â€œ\\033[47;30m Template Pull remote code to local. \\033[0mâ€pull_code &gt;&gt; $LOGecho -e â€œ\\033[47;30m Template Sync local code to wwwroot.\\033[0mâ€ &gt;&gt; $LOGecho -e â€œ\\033[47;30m Template Sync local code to wwwroot.\\033[0mâ€sync_code &gt;&gt; $LOGecho -e â€œ\\033[46;37m ############ Template $TIME end ############ \\033[mâ€ &gt;&gt; $LOGecho â€˜ â€˜ &gt;&gt; $LOGNotice &nbsp; é‚®ä»¶é€šçŸ¥è„šæœ¬ï¼Œèƒ½å¤Ÿåœ¨è‡ªå®šä¹‰çš„æ—¶é—´å‘¨æœŸå†…è·å–åˆ°æœ€æ–°ä»£ç æ—¶ èƒ½å‘é€é‚®ä»¶åˆ°æŒ‡å®šçš„é‚®ç®±ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æé†’ç®¡ç†äººå‘˜çŸ¥æ‚‰è¿™ä¸€åŠ¨ä½œã€‚ #!/usr/bin/env python#-*- coding: UTF-8 -*-import smtplibimport os,sysfrom email.mime.text import MIMEText mailto_list=[â€˜guomaoqiu@gmail.comâ€˜]mail_host=â€™smtp.qq.comâ€™mail_port=â€™25â€™mail_user=â€™2399447849â€™mail_pass=â€™xxxxxxâ€™mail_postfix=â€™qq.comâ€™ filename = â€œ/tmp/template.logâ€ fo = open(filename,â€rbâ€)filecon = fo.read();str1 = â€œ{0}â€œ.format(filecon) def send_mail(to_list,sub,content): me=â€Code Sync Noticeã€Templateã€‘â€+â€&lt;â€+mail_user+â€@â€+mail_postfix+â€&gt;â€ msg = MIMEText(content,_subtype=â€™htmlâ€™,_charset=â€™utt-8â€™) msg[â€˜Subjectâ€™] = sub msg[â€˜Fromâ€™]=me msg[â€˜toâ€™]=â€;â€.join(to_list) try: s = smtplib.SMTP() s.connect(mail_host) s.login(mail_user,mail_pass) s.sendmail(me,to_list,msg.as_string()) s.close() return True except Exception, e: print str(e) return Falseif __name__==â€™__main__â€˜: if send_mail(mailto_list,â€New Files Are Addedâ€,str1): print â€œå‘é€æˆåŠŸâ€ else: print â€œå‘é€å¤±è´¥â€","categories":[{"name":"Python","slug":"Python","permalink":"https://blog.sctux.cc/categories/Python/"},{"name":"Shell","slug":"Python/Shell","permalink":"https://blog.sctux.cc/categories/Python/Shell/"}],"tags":[],"keywords":[{"name":"Python","slug":"Python","permalink":"https://blog.sctux.cc/categories/Python/"},{"name":"Shell","slug":"Python/Shell","permalink":"https://blog.sctux.cc/categories/Python/Shell/"}]},{"title":"Pythonå‘é€é‚®ä»¶(é‚®ä»¶å†…å®¹ä»æ–‡ä»¶è¯»å…¥)","slug":"python-e5-8f-91-e9-80-81-e9-82-ae-e4-bb-b6-e9-82-ae-e4-bb-b6-e5-86-85-e5-ae-b9-e4-bb-8e-e6-96-87-e4-bb-b6-e8-af-bb-e5-85-a5","date":"2015-09-10T14:50:49.000Z","updated":"2025-09-01T01:59:08.877Z","comments":true,"path":"2015/09/10/python-e5-8f-91-e9-80-81-e9-82-ae-e4-bb-b6-e9-82-ae-e4-bb-b6-e5-86-85-e5-ae-b9-e4-bb-8e-e6-96-87-e4-bb-b6-e8-af-bb-e5-85-a5/","permalink":"https://blog.sctux.cc/2015/09/10/python-e5-8f-91-e9-80-81-e9-82-ae-e4-bb-b6-e9-82-ae-e4-bb-b6-e5-86-85-e5-ae-b9-e4-bb-8e-e6-96-87-e4-bb-b6-e8-af-bb-e5-85-a5/","excerpt":"æœ‰ä¸ªéœ€æ±‚ï¼Œåˆ©ç”¨pythonè„šæœ¬å‘å‡ºæ¥çš„é‚®ä»¶çš„å†…å®¹æ˜¯ä»æ–‡ä»¶è¯»å–çš„ã€‚å¹¶ä¸”ä¿æŒè¿™ä¸ªæ–‡ä»¶åŸæœ‰çš„æ ¼å¼ã€‚ #!/usr/bin/env python#-*- coding: UTF-8 -*-import smtplib,os,sysfrom email.mime.text import MIMEText mailto_list=[â€˜guomaoqiu@gmail.comâ€˜]mail_host=â€™smtp.qq.comâ€™mail_port=â€™25â€™mail_user=â€™2399447849â€™mail_pass=â€™xxxxxxxxxâ€™ #-&gt;ä½ æ‡‚çš„â€¦mail_postfix=â€™qq.comâ€™ filename = â€œ/tmp/test.logâ€ #-&gt;å°†è¦è¯»å–ä½œä¸ºé‚®ä»¶å†…å®¹çš„æ–‡ä»¶ fo = open(filename,â€rbâ€)filecon = fo.read();str1 = â€œ{0}â€œ.format(filecon) def send_mail(to_list,sub,content): me=â€Code Sync Noticeâ€+â€&lt;â€+mail_user+â€@â€+mail_postfix+â€&gt;â€ msg = MIMEText(content,_subtype=â€™htmlâ€™,_charset=â€™utf-8â€™) msg[â€˜Subjectâ€™] = sub msg[â€˜Fromâ€™]=me msg[â€˜toâ€™]=â€;â€.join(to_list) try: s = smtplib.SMTP() s.connect(mail_host) s.login(mail_user,mail_pass) s.sendmail(me,to_list,msg.as_string()) s.close() return True except Exception, e: print str(e) return Falseif __name__==â€™__main__â€˜: if send_mail(mailto_list,â€New Flies Are Addedâ€,str1): print â€œå‘é€æˆåŠŸâ€ else: print â€œå‘é€å¤±è´¥â€ æ‰§è¡Œç»“æœï¼š ä¹‹å‰å‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘åœ¨æ–‡ä»¶è¯»å–ä¹‹åå†™æˆè¿™æ ·çš„ï¼Œæœªå¯¹è¯»å…¥çš„å­—ç¬¦ä¸²æ ¼å¼æ ¼å¼åŒ–ã€‚ fo = open(filename,â€rbâ€)filecon = fo.read();str1 = filecon","text":"æœ‰ä¸ªéœ€æ±‚ï¼Œåˆ©ç”¨pythonè„šæœ¬å‘å‡ºæ¥çš„é‚®ä»¶çš„å†…å®¹æ˜¯ä»æ–‡ä»¶è¯»å–çš„ã€‚å¹¶ä¸”ä¿æŒè¿™ä¸ªæ–‡ä»¶åŸæœ‰çš„æ ¼å¼ã€‚ #!/usr/bin/env python#-*- coding: UTF-8 -*-import smtplib,os,sysfrom email.mime.text import MIMEText mailto_list=[â€˜guomaoqiu@gmail.comâ€˜]mail_host=â€™smtp.qq.comâ€™mail_port=â€™25â€™mail_user=â€™2399447849â€™mail_pass=â€™xxxxxxxxxâ€™ #-&gt;ä½ æ‡‚çš„â€¦mail_postfix=â€™qq.comâ€™ filename = â€œ/tmp/test.logâ€ #-&gt;å°†è¦è¯»å–ä½œä¸ºé‚®ä»¶å†…å®¹çš„æ–‡ä»¶ fo = open(filename,â€rbâ€)filecon = fo.read();str1 = â€œ{0}â€œ.format(filecon) def send_mail(to_list,sub,content): me=â€Code Sync Noticeâ€+â€&lt;â€+mail_user+â€@â€+mail_postfix+â€&gt;â€ msg = MIMEText(content,_subtype=â€™htmlâ€™,_charset=â€™utf-8â€™) msg[â€˜Subjectâ€™] = sub msg[â€˜Fromâ€™]=me msg[â€˜toâ€™]=â€;â€.join(to_list) try: s = smtplib.SMTP() s.connect(mail_host) s.login(mail_user,mail_pass) s.sendmail(me,to_list,msg.as_string()) s.close() return True except Exception, e: print str(e) return Falseif __name__==â€™__main__â€˜: if send_mail(mailto_list,â€New Flies Are Addedâ€,str1): print â€œå‘é€æˆåŠŸâ€ else: print â€œå‘é€å¤±è´¥â€ æ‰§è¡Œç»“æœï¼š ä¹‹å‰å‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘åœ¨æ–‡ä»¶è¯»å–ä¹‹åå†™æˆè¿™æ ·çš„ï¼Œæœªå¯¹è¯»å…¥çš„å­—ç¬¦ä¸²æ ¼å¼æ ¼å¼åŒ–ã€‚ fo = open(filename,â€rbâ€)filecon = fo.read();str1 = filecon è€Œè¿™æ ·å‘å‡ºæ¥çš„é‚®ä»¶ç»“æœå´æ˜¯è¿™æ ·çš„ å‘é€ HTML å½¢å¼çš„é‚®ä»¶ï¼Œéœ€è¦ email.mime.text ä¸­çš„ MIMEText çš„ _subtype è®¾ç½®ä¸º htmlï¼Œå¹¶ä¸” _text çš„å†…å®¹åº”è¯¥ä¸º HTML å½¢å¼ å¯å‚è€ƒï¼šhttp://m.blog.chinaunix.net/uid-23802873-id-4477364.html","categories":[{"name":"Python","slug":"Python","permalink":"https://blog.sctux.cc/categories/Python/"}],"tags":[],"keywords":[{"name":"Python","slug":"Python","permalink":"https://blog.sctux.cc/categories/Python/"}]},{"title":"Pythoné“¾æ¥mysqlæ•°æ®åº“çš„ä¸€äº›æ“ä½œ","slug":"python-e9-93-be-e6-8e-a5mysql-e6-95-b0-e6-8d-ae-e5-ba-93-e7-9a-84-e4-b8-80-e4-ba-9b-e6-93-8d-e4-bd-9c","date":"2015-09-10T14:01:18.000Z","updated":"2025-09-01T01:59:08.932Z","comments":true,"path":"2015/09/10/python-e9-93-be-e6-8e-a5mysql-e6-95-b0-e6-8d-ae-e5-ba-93-e7-9a-84-e4-b8-80-e4-ba-9b-e6-93-8d-e4-bd-9c/","permalink":"https://blog.sctux.cc/2015/09/10/python-e9-93-be-e6-8e-a5mysql-e6-95-b0-e6-8d-ae-e5-ba-93-e7-9a-84-e4-b8-80-e4-ba-9b-e6-93-8d-e4-bd-9c/","excerpt":"ä¸€ã€å®éªŒè§„åˆ’ 1ã€é¦–å…ˆå®éªŒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æå‰åˆ›å»ºä¸€ä¸ªæ•°æ®åº“TESTDBï¼Œç„¶åæˆä¸€ä¸ªç”¨æˆ·testç®¡ç†è¯¥æ•°æ®åº“,è¿™é‡Œæˆ‘è®¾ç½®çš„å¯†ç æ˜¯test123; 2ã€è¦ç”¨pythoné“¾æ¥æ•°æ®åº“éœ€è¦ç”¨åˆ°ç¬¬ä¸‰æ–¹æ³•æ¨¡å—MySQLdb; 3ã€åˆ©ç”¨pythonè„šæœ¬å¯¹æ•°æ®åº“åšä¸€äº›ç®€å•æ“ä½œ; äºŒã€å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å—MySQLdb. 1ã€è·å–æ¨¡å— wget https://pypi.python.org/packages/source/M/MySQL-python/MySQL-python-1.2.5.zip 2ã€è§£å‹ï¼Œå®‰è£… unzip MySQL-python-1.2.5.zipcd MySQL-python-1.2.5python setup.py buildpython setup.py install 3ã€æ£€æŸ¥å®‰è£…æƒ…å†µï¼Œè¿›å…¥pythonå‘½ä»¤è¡Œæ‰§è¡Œ importï¼Œå¦‚æœä¸æŠ¥å‡ºä»»ä½•ä¿¡æ¯è¯´æ˜æˆåŠŸå®‰è£…å¹¶ä¸”å¯¼å…¥æˆåŠŸ demo@demo:~$ pythonPython 2.7.9 (default, Apr 2 2015, 15:33:21)[GCC 4.9.2] on linux2Type â€œhelpâ€, â€œcopyrightâ€, â€œcreditsâ€ or â€œlicenseâ€ for more information. &gt; import MySQLdb ä¸‰ã€å¯¹mysqlæ•°æ®åº“çš„ä¸€äº›æ“ä½œ 1ã€è¿æ¥æ•°æ®åº“TESTDBå¹¶æŸ¥çœ‹æ•°æ®åº“çš„ç‰ˆæœ¬ #!/usr/bin/env python#-*- coding: UTF-8 -*-import MySQLdb db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€)","text":"ä¸€ã€å®éªŒè§„åˆ’ 1ã€é¦–å…ˆå®éªŒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æå‰åˆ›å»ºä¸€ä¸ªæ•°æ®åº“TESTDBï¼Œç„¶åæˆä¸€ä¸ªç”¨æˆ·testç®¡ç†è¯¥æ•°æ®åº“,è¿™é‡Œæˆ‘è®¾ç½®çš„å¯†ç æ˜¯test123; 2ã€è¦ç”¨pythoné“¾æ¥æ•°æ®åº“éœ€è¦ç”¨åˆ°ç¬¬ä¸‰æ–¹æ³•æ¨¡å—MySQLdb; 3ã€åˆ©ç”¨pythonè„šæœ¬å¯¹æ•°æ®åº“åšä¸€äº›ç®€å•æ“ä½œ; äºŒã€å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å—MySQLdb. 1ã€è·å–æ¨¡å— wget https://pypi.python.org/packages/source/M/MySQL-python/MySQL-python-1.2.5.zip 2ã€è§£å‹ï¼Œå®‰è£… unzip MySQL-python-1.2.5.zipcd MySQL-python-1.2.5python setup.py buildpython setup.py install 3ã€æ£€æŸ¥å®‰è£…æƒ…å†µï¼Œè¿›å…¥pythonå‘½ä»¤è¡Œæ‰§è¡Œ importï¼Œå¦‚æœä¸æŠ¥å‡ºä»»ä½•ä¿¡æ¯è¯´æ˜æˆåŠŸå®‰è£…å¹¶ä¸”å¯¼å…¥æˆåŠŸ demo@demo:~$ pythonPython 2.7.9 (default, Apr 2 2015, 15:33:21)[GCC 4.9.2] on linux2Type â€œhelpâ€, â€œcopyrightâ€, â€œcreditsâ€ or â€œlicenseâ€ for more information. &gt; import MySQLdb ä¸‰ã€å¯¹mysqlæ•°æ®åº“çš„ä¸€äº›æ“ä½œ 1ã€è¿æ¥æ•°æ®åº“TESTDBå¹¶æŸ¥çœ‹æ•°æ®åº“çš„ç‰ˆæœ¬ #!/usr/bin/env python#-*- coding: UTF-8 -*-import MySQLdb db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€) cursor = db.cursor() cursor.execute(â€œSELECT VERSION()â€) data = cursor.fetchone() print â€œDatabase version: %s â€œ % data db.close() æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š demo@demo:/python_learn$ python mysql_connect.pyDatabase version: 5.6.25-0ubuntu0.15.04.1demo@demo:/python_learn$ 2ã€é“¾æ¥åˆ°æ•°æ®åº“TESTDBå¹¶ä¸”åˆ›å»ºä¸€ä¸ªå¼ è¡¨ #!/usr/bin/env python#-*- coding: UTF-8 -*-import MySQLdb db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€) cursor = db.cursor() cursor.execute(â€œDROP TABLE IF EXISTS EMPLOYEEâ€) sql = â€œâ€â€CREATE TABLE `EMPLOYEE` ( `FIRST_NAME` varchar(20) DEFAULT NULL, `LAST_NAME` varchar(20) DEFAULT NULL, `AGE` int(11) DEFAULT NULL, `SEX` varchar(20) DEFAULT NULL, `INCOME` varchar(20) DEFAULT NULL) ENGINE=InnoDB DEFAULT CHARSET=latin1 â€œâ€â€ cursor.execute(sql) db.close() æ‰§è¡Œç»“æœæˆ‘ä»¬é€šè¿‡é“¾æ¥åˆ°æ•°æ®åº“å»æŸ¥çœ‹ mysql&gt; use TESTDB;Database changedmysql&gt; SHOW TABLES;+â€”â€”â€”â€”â€”â€”+| Tables_in_TESTDB |+â€”â€”â€”â€”â€”â€”+| EMPLOYEE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |+â€”â€”â€”â€”â€”â€”+1 row in set (0.00 sec) mysql&gt;mysql&gt; DESC EMPLOYEE;+â€”â€”â€”â€”+â€”â€”â€”â€”-+â€”â€”+â€”â€“+â€”â€”â€”+â€”â€”-+| Field&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Null | Key | Default | Extra |+â€”â€”â€”â€”+â€”â€”â€”â€”-+â€”â€”+â€”â€“+â€”â€”â€”+â€”â€”-+| FIRST_NAME | varchar(20) | YES&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; || LAST_NAME&nbsp; | varchar(20) | YES&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; || AGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | int(11)&nbsp;&nbsp;&nbsp;&nbsp; | YES&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; || SEX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | varchar(20) | YES&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; || INCOME&nbsp;&nbsp;&nbsp;&nbsp; | varchar(20) | YES&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |+â€”â€”â€”â€”+â€”â€”â€”â€”-+â€”â€”+â€”â€“+â€”â€”â€”+â€”â€”-+5 rows in set (0.00 sec) mysql&gt; select * from EMPLOYEE; #ç›®å‰è¯¥è¡¨æ²¡æœ‰ä»»ä½•æ•°æ®Empty set (0.00 sec) mysql&gt; 3ã€è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¹¶åœ¨EMPLOYEEè¡¨ä¸­æ’å…¥æ•°æ® #!/usr/bin/env python#-*- coding: UTF-8 -*-import MySQLdb db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€) cursor = db.cursor() sql = â€œâ€â€INSERT INTO EMPLOYEE(FIRST_NAME, LAST_NAME,AGE,SEX,INCOME) VALUES (â€˜Guoâ€™,â€™Maoqiuoâ€™,â€™24â€™,â€™Mâ€™,â€™1991â€™)â€â€â€ try: cursor.execute(sql) db.commit()except: db.rollback() db.close() æ‰§è¡Œç»“æœå¦‚ä¸‹ mysql&gt; select * from EMPLOYEE;+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+| FIRST_NAME | LAST_NAME | AGE | SEX | INCOME |+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+| Guo | Maoqiuo | 24 | M | 1991 |+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+1 row in set (0.00 sec) mysql&gt; 4ã€é“¾æ¥æ•°æ®åº“ä½¿ç”¨selectè¯­å¥è¿›è¡ŒæŸ¥è¯¢ï¼Œè¿™é‡Œå®éªŒä½¿ç”¨æ¡ä»¶æŸ¥è¯¢ï¼Œé‚£æˆ‘éœ€è¦å¤šä¸€ç‚¹æ•°æ®æ‰è¡Œï¼Œé‚£æˆ‘ä¿®æ”¹ä¸Šé¢çš„é‚£ä¸ªè„šæœ¬ç„¶åå¤šæ‰§è¡Œå‡ éå³å¯ï¼Œçœ‹åˆ°çš„ç»“æœå¦‚ä¸‹ mysql&gt; select * from EMPLOYEE;+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+| FIRST_NAME | LAST_NAME | AGE | SEX | INCOME |+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+| Guo | Maoqiuo | 24 | M | 1991 || Bruce | Li | 25 | M | 1989 || Fan | bingbing | 28 | F | 1988 || Jack | cheng | 45 | M | 1968 || joy | jiang | 26 | F | 1977 |+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+5 rows in set (0.00 sec) ä½¿ç”¨æ¡ä»¶æŸ¥è¯¢ #!/usr/bin/env python#-*- coding: UTF-8 -*-import MySQLdb db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€) cursor = db.cursor() sql = â€œSELECT * FROM EMPLOYEE WHERE INCOME &gt; â€˜%dâ€™â€ % (1988) try: cursor.execute(sql) results = cursor.fetchall() for row in results: fname = row\\[0\\] lname = row\\[1\\] age = row\\[2\\] sex = row\\[3\\] income = row\\[4\\] print \"Fname=%s, Lanme=%s, Age=%d, Sex=%s, Income=%s\\\\n\" % (fname,lname,age,sex,income) except: print â€œError: unable to fecth dataâ€ db.close() æ‰§è¡Œç»“æœå¦‚ä¸‹ deamon@deamon:~/python_learn$ python mysql_select.pyFname=Guo, Lanme=Maoqiuo, Age=24, Sex=M, Income=1991 Fname=Bruce, Lanme=Li, Age=25, Sex=M, Income=1989 4ã€è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¹¶æ›´æ–°åœ¨EMPLOYEEè¡¨çš„æ•°æ®ï¼Œå°†æ€§åˆ«ä¸ºMçš„äººå‘˜åœ¨å¹´é¾„ä¸ŠåŠ 2 #!/usr/bin/env python#-*- coding: UTF-8 -*-import MySQLdb db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€) cursor = db.cursor() sql = â€œUPDATE EMPLOYEE SET AGE = AGE +2 WHERE SEX = â€˜%câ€™ â€œ % (â€˜Mâ€™) try: cursor.execute(sql) db.commit()except: db.rollback() print â€œErrorâ€ db.close() æ‰§è¡Œåçš„ç»“æœ mysql&gt; select * from TESTDB.EMPLOYEE;+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+| FIRST_NAME | LAST_NAME | AGE | SEX | INCOME |+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+| Guo | Maoqiuo | 26 | M | 1991 || Bruce | Li | 27 | M | 1989 || Fan | bingbing | 28 | F | 1988 || Jack | cheng | 47 | M | 1968 || joy | jiang | 26 | F | 1977 |+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+5 rows in set (0.00 sec) mysql&gt;","categories":[{"name":"Python","slug":"Python","permalink":"https://blog.sctux.cc/categories/Python/"}],"tags":[{"name":"mysqldb","slug":"mysqldb","permalink":"https://blog.sctux.cc/tags/mysqldb/"},{"name":"python-mysql","slug":"python-mysql","permalink":"https://blog.sctux.cc/tags/python-mysql/"}],"keywords":[{"name":"Python","slug":"Python","permalink":"https://blog.sctux.cc/categories/Python/"}]},{"title":"Seafile-ä¸ªäºº/å›¢é˜Ÿ/å…¬å¸ä¸“å±ç§æœ‰æ–‡ä»¶åŒæ­¥æœåŠ¡ (äº‘å­˜å‚¨ç½‘ç›˜)","slug":"seafile-e4-b8-aa-e4-ba-ba-e5-9b-a2-e9-98-9f-e5-85-ac-e5-8f-b8-e4-b8-93-e5-b1-9e-e7-a7-81-e6-9c-89-e6-96-87-e4-bb-b6-e5-90-8c-e6-ad-a5-e6-9c-8d-e5-8a-a1-e4-ba-91-e5-ad-98-e5-82-a8-e7-bd-91","date":"2015-09-08T15:38:37.000Z","updated":"2025-09-01T01:59:08.922Z","comments":true,"path":"2015/09/08/seafile-e4-b8-aa-e4-ba-ba-e5-9b-a2-e9-98-9f-e5-85-ac-e5-8f-b8-e4-b8-93-e5-b1-9e-e7-a7-81-e6-9c-89-e6-96-87-e4-bb-b6-e5-90-8c-e6-ad-a5-e6-9c-8d-e5-8a-a1-e4-ba-91-e5-ad-98-e5-82-a8-e7-bd-91/","permalink":"https://blog.sctux.cc/2015/09/08/seafile-e4-b8-aa-e4-ba-ba-e5-9b-a2-e9-98-9f-e5-85-ac-e5-8f-b8-e4-b8-93-e5-b1-9e-e7-a7-81-e6-9c-89-e6-96-87-e4-bb-b6-e5-90-8c-e6-ad-a5-e6-9c-8d-e5-8a-a1-e4-ba-91-e5-ad-98-e5-82-a8-e7-bd-91/","excerpt":"ä¸€ã€ç®€ä»‹ï¼š seafile æ˜¯ç”±å›½å†…å›¢é˜Ÿå¼€å‘çš„ä¸€ä¸ªå›½é™…åŒ–çš„å¼€æºäº‘å­˜å‚¨è½¯ä»¶é¡¹ç›®ï¼Œç›®å‰æ®è¯´å·²æœ‰10ä¸‡å·¦å³çš„ç”¨æˆ·ï¼Œå…¸å‹çš„æœºæ„ç”¨æˆ·åŒ…æ‹¬æ¯”åˆ©æ—¶çš„çš‡å®¶è‡ªç„¶ç§‘å­¦åšç‰©é¦†ã€å¾·å›½çš„ Wuppertal æ°”å€™ã€èƒ½æºç ”ç©¶æ‰€ç­‰ç­‰ã€‚Seafile åŒæ—¶æä¾›äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è½¯ä»¶å…è´¹ä¸‹è½½ï¼Œä»»ä½•ä¸ªäººæˆ–å…¬å¸éƒ½èƒ½æ­å»ºå±äºè‡ªå·±çš„ç§æœ‰æ–‡ä»¶åŒæ­¥æœåŠ¡ã€‚Seafile çš„æœåŠ¡å™¨ç«¯æ”¯æŒ Linux&nbsp;ã€Windows ä»¥åŠæ ‘è“æ´¾å¹³å°ï¼Œå®¢æˆ·ç«¯é™¤äº†ç½‘é¡µç‰ˆä¹‹å¤–ï¼Œè¿˜æ”¯æŒ Macã€Linuxã€Windows ä¸‰ä¸ªæ¡Œé¢å¹³å°ä»¥åŠ Android å’Œ iOS ä¸¤ä¸ªç§»åŠ¨å¹³å°ã€‚ä½ å¯ä»¥åˆ©ç”¨å±€åŸŸç½‘é‡Œçš„ä¸€å°ç”µè„‘ä½œä¸ºæœåŠ¡å™¨ï¼Œæ­å»ºä¸€ä¸ªä»…å±€åŸŸç½‘å†…éƒ¨èƒ½è®¿é—®çš„ä¸“æœ‰äº‘å­˜å‚¨æœåŠ¡ï¼Œä¹Ÿèƒ½å°† Seafile éƒ¨ç½²åˆ°äº’è”ç½‘ä¸Šçš„è¯¸å¦‚é˜¿é‡Œäº‘ã€Linode æˆ–ä»»ä½• VPSã€ç‹¬ç«‹æœåŠ¡å™¨ä¸Šï¼Œå®ç°ä¸€ä¸ªç§äººçš„åœ¨çº¿äº‘å­˜å‚¨æœåŠ¡ã€‚ åŒæ—¶ï¼ŒSeafile æ”¯æŒç”¨æˆ·åŒæ—¶ä½¿ç”¨å¤šä¸ªåŒæ­¥æœåŠ¡å™¨ï¼Œè€Œä¸”èƒ½å¤Ÿåœ¨ä¸åŒæœåŠ¡å™¨ä¹‹é—´åˆ‡æ¢ã€‚æ¯”å¦‚ï¼Œç”¨æˆ·å¯ä»¥ç”¨å…¬å¸æœåŠ¡å™¨æ¥åŒæ­¥å·¥ä½œæ–‡ä»¶ï¼Œç”¨ä¸ªäººæœåŠ¡å™¨ä¸æœ‹å‹å…±äº«ç§äººæ–‡ä»¶ï¼Œä¸¤è€…äº’ä¸å¹²æ‰°ï¼Œç§å¯†æ€§ä¹Ÿå¯ä¿è¯ã€‚è€Œä¸”ï¼Œç”±äº Seafile æ˜¯å¼€æºçš„é¡¹ç›®ï¼Œå› æ­¤ç›¸å¯¹æ¥è¯´æ•°æ®çš„ç§å¯†æ€§è¿˜æ˜¯æœ‰ä¿éšœçš„ï¼Œèµ·ç ä¸å¿…æ‹…å¿ƒæœ‰ä»€ä¹ˆçœ‹ä¸è§çš„åé—¨ã€‚å…·ä½“ä»‹ç»å¯ä»¥å‚è§seafileå®˜æ–¹æ–‡æ¡£ä»‹ç»ã€‚ ä¸‹é¢æˆ‘ä»¬å°±å¼€å§‹åœ¨å±€åŸŸç½‘å†…æ­å»ºä¸€å°ç§æœ‰çš„äº‘å­˜å‚¨ã€‚ äºŒã€å®‰è£…seafileæœåŠ¡å™¨ 1ã€å®‰è£…å‰å‡†å¤‡ï¼š è¯·ç¡®ä¿æœåŠ¡å™¨ ä¸Šé¢å®‰è£…äº†ä»¥ä¸‹æ¨¡å—(è¿™æ¬¾è½¯ä»¶æ˜¯ç”¨Django+Python2.7æ‰€å¼€å‘çš„ï¼Œæ‰€ä»¥è¦ä¿è¯æœåŠ¡å™¨ä¸Šé¢çš„pythonç‰ˆæœ¬) python 2.7 python-setuptools python-imaging (è¿™ä¸ªæ˜¯pythonçš„ä¸€ä¸ªåº“ï¼Œç½‘ä¸Šä¸å¥½æ‰¾åˆ°ï¼Œä¸‹è½½åœ°å€http://www.pythonware.com/products/pil/) python-mysqldb 2ã€è·å–æœåŠ¡ç«¯è½¯ä»¶åŒ… wget https://bintray.com/artifact/download/seafile-org/seafile/seafile-server\\_4.3.2\\_x86-64.tar.gz 3ã€è§£å‹å®‰è£… tar -xf seafile-server_4.3.2_x86-64.tar.gzmkdir /home/seafilemv seafile-server-4.3.2 /home/seafile/seafile-servercd /home/seafile/seafile-server ./setup-seafile-mysql.sh #è¿è¡Œå®‰è£…è„šæœ¬å¹¶å›ç­”é¢„è®¾é—®é¢˜ å¦‚æœä½ çš„ç³»ç»Ÿä¸­æ²¡æœ‰å®‰è£…ä¸Šé¢çš„æŸä¸ªè½¯ä»¶ï¼Œé‚£ä¹ˆ Seafileåˆå§‹åŒ–è„šæœ¬ä¼šæé†’ä½ å®‰è£…ç›¸åº”çš„è½¯ä»¶åŒ…. ./setup-seafile-mysql.shChecking python on this machine â€¦ #-&gt;æ‰§è¡Œè¿™ä¸ªè„šæœ¬ä¹‹åä¼šå»æ£€æŸ¥ä¹‹å‰è¯´çš„é‚£äº›ä¾èµ–åŒ…ï¼Œå¦‚æœå®‰è£…åŒ…ä¸å®Œæ•´å°†ä¼šæç¤ºä½ æŸä¸ªè½¯ä»¶åŒ…æœªå®‰è£… Checking python module: setuptools â€¦ Done. Checking python module: python-imaging â€¦ Done. Checking python module: python-mysqldb â€¦ Done. -----------------------------------------------------------------This script will guide you to setup your seafile server using MySQL.Make sure you have read seafile server manual at https://github.com/haiwen/seafile/wiki Press ENTER to continue #-&gt;è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸‹å›è½¦ï¼Œå†ç»§ç»­-----------------------------------------------------------------","text":"ä¸€ã€ç®€ä»‹ï¼š seafile æ˜¯ç”±å›½å†…å›¢é˜Ÿå¼€å‘çš„ä¸€ä¸ªå›½é™…åŒ–çš„å¼€æºäº‘å­˜å‚¨è½¯ä»¶é¡¹ç›®ï¼Œç›®å‰æ®è¯´å·²æœ‰10ä¸‡å·¦å³çš„ç”¨æˆ·ï¼Œå…¸å‹çš„æœºæ„ç”¨æˆ·åŒ…æ‹¬æ¯”åˆ©æ—¶çš„çš‡å®¶è‡ªç„¶ç§‘å­¦åšç‰©é¦†ã€å¾·å›½çš„ Wuppertal æ°”å€™ã€èƒ½æºç ”ç©¶æ‰€ç­‰ç­‰ã€‚Seafile åŒæ—¶æä¾›äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è½¯ä»¶å…è´¹ä¸‹è½½ï¼Œä»»ä½•ä¸ªäººæˆ–å…¬å¸éƒ½èƒ½æ­å»ºå±äºè‡ªå·±çš„ç§æœ‰æ–‡ä»¶åŒæ­¥æœåŠ¡ã€‚Seafile çš„æœåŠ¡å™¨ç«¯æ”¯æŒ Linux&nbsp;ã€Windows ä»¥åŠæ ‘è“æ´¾å¹³å°ï¼Œå®¢æˆ·ç«¯é™¤äº†ç½‘é¡µç‰ˆä¹‹å¤–ï¼Œè¿˜æ”¯æŒ Macã€Linuxã€Windows ä¸‰ä¸ªæ¡Œé¢å¹³å°ä»¥åŠ Android å’Œ iOS ä¸¤ä¸ªç§»åŠ¨å¹³å°ã€‚ä½ å¯ä»¥åˆ©ç”¨å±€åŸŸç½‘é‡Œçš„ä¸€å°ç”µè„‘ä½œä¸ºæœåŠ¡å™¨ï¼Œæ­å»ºä¸€ä¸ªä»…å±€åŸŸç½‘å†…éƒ¨èƒ½è®¿é—®çš„ä¸“æœ‰äº‘å­˜å‚¨æœåŠ¡ï¼Œä¹Ÿèƒ½å°† Seafile éƒ¨ç½²åˆ°äº’è”ç½‘ä¸Šçš„è¯¸å¦‚é˜¿é‡Œäº‘ã€Linode æˆ–ä»»ä½• VPSã€ç‹¬ç«‹æœåŠ¡å™¨ä¸Šï¼Œå®ç°ä¸€ä¸ªç§äººçš„åœ¨çº¿äº‘å­˜å‚¨æœåŠ¡ã€‚ åŒæ—¶ï¼ŒSeafile æ”¯æŒç”¨æˆ·åŒæ—¶ä½¿ç”¨å¤šä¸ªåŒæ­¥æœåŠ¡å™¨ï¼Œè€Œä¸”èƒ½å¤Ÿåœ¨ä¸åŒæœåŠ¡å™¨ä¹‹é—´åˆ‡æ¢ã€‚æ¯”å¦‚ï¼Œç”¨æˆ·å¯ä»¥ç”¨å…¬å¸æœåŠ¡å™¨æ¥åŒæ­¥å·¥ä½œæ–‡ä»¶ï¼Œç”¨ä¸ªäººæœåŠ¡å™¨ä¸æœ‹å‹å…±äº«ç§äººæ–‡ä»¶ï¼Œä¸¤è€…äº’ä¸å¹²æ‰°ï¼Œç§å¯†æ€§ä¹Ÿå¯ä¿è¯ã€‚è€Œä¸”ï¼Œç”±äº Seafile æ˜¯å¼€æºçš„é¡¹ç›®ï¼Œå› æ­¤ç›¸å¯¹æ¥è¯´æ•°æ®çš„ç§å¯†æ€§è¿˜æ˜¯æœ‰ä¿éšœçš„ï¼Œèµ·ç ä¸å¿…æ‹…å¿ƒæœ‰ä»€ä¹ˆçœ‹ä¸è§çš„åé—¨ã€‚å…·ä½“ä»‹ç»å¯ä»¥å‚è§seafileå®˜æ–¹æ–‡æ¡£ä»‹ç»ã€‚ ä¸‹é¢æˆ‘ä»¬å°±å¼€å§‹åœ¨å±€åŸŸç½‘å†…æ­å»ºä¸€å°ç§æœ‰çš„äº‘å­˜å‚¨ã€‚ äºŒã€å®‰è£…seafileæœåŠ¡å™¨ 1ã€å®‰è£…å‰å‡†å¤‡ï¼š è¯·ç¡®ä¿æœåŠ¡å™¨ ä¸Šé¢å®‰è£…äº†ä»¥ä¸‹æ¨¡å—(è¿™æ¬¾è½¯ä»¶æ˜¯ç”¨Django+Python2.7æ‰€å¼€å‘çš„ï¼Œæ‰€ä»¥è¦ä¿è¯æœåŠ¡å™¨ä¸Šé¢çš„pythonç‰ˆæœ¬) python 2.7 python-setuptools python-imaging (è¿™ä¸ªæ˜¯pythonçš„ä¸€ä¸ªåº“ï¼Œç½‘ä¸Šä¸å¥½æ‰¾åˆ°ï¼Œä¸‹è½½åœ°å€http://www.pythonware.com/products/pil/) python-mysqldb 2ã€è·å–æœåŠ¡ç«¯è½¯ä»¶åŒ… wget https://bintray.com/artifact/download/seafile-org/seafile/seafile-server\\_4.3.2\\_x86-64.tar.gz 3ã€è§£å‹å®‰è£… tar -xf seafile-server_4.3.2_x86-64.tar.gzmkdir /home/seafilemv seafile-server-4.3.2 /home/seafile/seafile-servercd /home/seafile/seafile-server ./setup-seafile-mysql.sh #è¿è¡Œå®‰è£…è„šæœ¬å¹¶å›ç­”é¢„è®¾é—®é¢˜ å¦‚æœä½ çš„ç³»ç»Ÿä¸­æ²¡æœ‰å®‰è£…ä¸Šé¢çš„æŸä¸ªè½¯ä»¶ï¼Œé‚£ä¹ˆ Seafileåˆå§‹åŒ–è„šæœ¬ä¼šæé†’ä½ å®‰è£…ç›¸åº”çš„è½¯ä»¶åŒ…. ./setup-seafile-mysql.shChecking python on this machine â€¦ #-&gt;æ‰§è¡Œè¿™ä¸ªè„šæœ¬ä¹‹åä¼šå»æ£€æŸ¥ä¹‹å‰è¯´çš„é‚£äº›ä¾èµ–åŒ…ï¼Œå¦‚æœå®‰è£…åŒ…ä¸å®Œæ•´å°†ä¼šæç¤ºä½ æŸä¸ªè½¯ä»¶åŒ…æœªå®‰è£… Checking python module: setuptools â€¦ Done. Checking python module: python-imaging â€¦ Done. Checking python module: python-mysqldb â€¦ Done. -----------------------------------------------------------------This script will guide you to setup your seafile server using MySQL.Make sure you have read seafile server manual at https://github.com/haiwen/seafile/wiki Press ENTER to continue #-&gt;è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸‹å›è½¦ï¼Œå†ç»§ç»­----------------------------------------------------------------- What is the name of the server? It will be displayed on the client.3 - 15 letters or digits[ server name ] seafile-server #-&gt;è®¾ç½®æˆ‘ä»¬çš„æœåŠ¡å™¨åç§° What is the ip or domain of the server?For example: www.mycompany.com, 192.168.1.101 #-&gt;æœåŠ¡å™¨çš„IP[ This serverâ€™s ip or domain ] 192.168.2.108 Where do you want to put your seafile data?Please use a volume with enough free space[ default â€œ/home/seafile/seafile-dataâ€ ] /data/seafile #-&gt;å­˜å‚¨çš„ä½ç½®æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯/data/seafile Which port do you want to use for the seafile fileserver?[ default â€œ8082â€ ] #-&gt;é»˜è®¤çš„å·¥ä½œç«¯å£ -------------------------------------------------------Please choose a way to initialize seafile databases:-------------------------------------------------------#-&gt;å¦‚æœé€‰æ‹©1, ä½ éœ€è¦æä¾›æ ¹å¯†ç . è„šæœ¬ç¨‹åºä¼šåˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·ã€‚#-&gt;å¦‚æœé€‰æ‹©2, ccnet/seafile/seahub æ•°æ®åº“åº”è¯¥å·²ç»è¢«ä½ ï¼ˆæˆ–è€…å…¶ä»–äººï¼‰æå‰åˆ›å»ºã€‚[1] Create new ccnet/seafile/seahub databases[2] Use existing ccnet/seafile/seahub databases [ 1 or 2 ] 1 What is the host of mysql server?[ default â€œlocalhostâ€ ] What is the port of mysql server?[ default â€œ3306â€ ] What is the password of the mysql root user?[ root password ] #-&gt;è¿™é‡Œéœ€è¦mysqlçš„rootæƒé™è¿›è¡Œåˆ›å»ºåº“çš„æ“ä½œ verifying password of user root â€¦ done Enter the name for mysql user of seafile. It would be created if not exists.[ default â€œrootâ€ ] Enter the database name for ccnet-server:[ default â€œccnet-dbâ€ ] Enter the database name for seafile-server:[ default â€œseafile-dbâ€ ] Enter the database name for seahub:[ default â€œseahub-dbâ€ ] #-&gt;ä»¥ä¸Šä¸‰ä¸ªåº“åéƒ½ç”¨é»˜è®¤çš„ ä»¥ä¸Šæ­¥éª¤å®Œæˆåå°†ä¼šå‡ºç°ä¸€ä¸‹æç¤ºä¿¡æ¯ï¼Œè¯´æ˜æˆ‘ä»¬å®‰è£…å°±æˆåŠŸå•¦ ä¸‰ã€å¯åŠ¨seafileæœåŠ¡å’Œseahubç½‘ç«™ 1ã€åœ¨/home/seafile/seafile-serverç›®å½•ä¸‹æ‰§è¡Œ #-&gt;å¯åŠ¨seafile./seafile.sh start # å¯åŠ¨ Seafile æœåŠ¡ #-&gt;å¯åŠ¨seahub./seahub.sh start # å¯åŠ¨ Seahub ç½‘ç«™ ï¼ˆé»˜è®¤è¿è¡Œåœ¨8000ç«¯å£ä¸Šï¼‰ æ³¨æ„ï¼šä½ ç¬¬ä¸€æ¬¡å¯åŠ¨ seahub æ—¶ï¼Œseahub.sh è„šæœ¬ä¼šæç¤ºä½ åˆ›å»ºä¸€ä¸ª seafile ç®¡ç†å‘˜å¸å·ï¼Œå°±åƒä¸‹é¢è¿™æ · è¿™ä¸ªç®¡ç†è´¦å·å¿…é¡»æ˜¯ä½ è‡ªå·±å–æ³¨å†Œçš„ä»»æ„é‚®ç®±åœ°å€ï¼Œç™»é™†ç®¡ç†ä½¿ç”¨è¿™ä¸ªåœ°å€ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯gmail. æœåŠ¡å¯åŠ¨å, æ‰“å¼€æµè§ˆå™¨å¹¶è¾“å…¥è¿™ä¸ªåœ°å€ http://192.168.2.108:8000 è¾“å…¥è´¦å·å¯†ç å°±ä¼šè¢«é‡å®šå‘åˆ°ç™»é™†é¡µé¢. è¾“å…¥ä½ åœ¨å®‰è£… Seafile æ—¶æä¾›çš„ç”¨æˆ·åå’Œå¯†ç åï¼Œä½ ä¼šè¿›å…¥ Myhome é¡µé¢ï¼Œæ–°å»ºèµ„æ–™åº“. &nbsp; è‡³æ­¤ï¼Œseafileç§æœ‰ä¸å­˜å‚¨å…±äº«å¹³å°å·²ç»éƒ¨ç½²å®Œæ¯•äº†ã€‚ ä¸‹é¢æˆ‘ä»¬å¯ä»¥å»ä¸‹è½½ä¸€ä¸ªå®¢æˆ·ç«¯å®‰è£…ä¸Š æˆ‘è¿™é‡Œä½¿ç”¨çš„Ubuntuä¸‹çš„å®¢æˆ·ç«¯ &nbsp; å› ä¸ºä¹‹å‰å°±æŠŠæˆ‘çš„åº“ä¸‹è½½åˆ°äº†æœ¬åœ°ï¼Œä½ å¯ä»¥åœ¨æœ¬åœ°åº“æ·»åŠ æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»åŒæ­¥å°±ä¼šåŒæ­¥åˆ°æœåŠ¡å™¨ç«¯å•¦ï¼Œå°±åƒè¿™æ ·(å¦‚æœä½ ä¸ä½¿ç”¨å®¢æˆ·ç«¯çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ç½‘é¡µç‰ˆ) å½“ç„¶ä»–çš„å®¢æˆ·ç«¯ä¸åªæ˜¯åœ¨linux(ubuntu) ä¸Šé¢æ‰æœ‰å“¦ï¼Œ å®¢æˆ·ç«¯åœ¨ï¼š ç§»åŠ¨ç«¯æœ‰ï¼šAndroidï¼ŒIos æ¡Œé¢ç«¯æœ‰ï¼šwindowsã€Linuxã€Mac æœåŠ¡ç«¯åœ¨ï¼š Windowsã€Linuxã€æ ‘è“æ´¾ ä»»ä½•å¹³å°çš„æµè§ˆå™¨ã€‚ ä¸‹é¢æ˜¯æˆ‘æ‰‹æœºç«¯çš„æˆªå›¾ï¼ŒæœåŠ¡å™¨è·Ÿæ‰‹æœºçš„wifiæ˜¯åœ¨ä¸€ä¸ªå±€åŸŸç½‘å†…çš„ &nbsp; æ—¢ç„¶è¯´äº†æ˜¯å›¢é˜Ÿã€ä¼ä¸šæˆ–è€…ä¸ªäººä½¿ç”¨ï¼Œé‚£æ¯ä¸ªäººéƒ½è¦æœ‰ä¸ªè´¦å·ï¼Œé‚£æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªè´¦å·æ‰è¡Œï¼Œå› ä¸ºæˆ‘ä½¿ç”¨çš„seafile serveræ˜¯ç¤¾åŒºç‰ˆï¼Œæœ‰è®¸å¤šçš„åŠŸèƒ½éƒ½ä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘è§‰å¾—ä½œä¸ºä¸€ä¸ªå°å›¢é˜Ÿï¼Œæˆ–è€…ä¸ªäººä½¿ç”¨å†é€‚åˆä¸è¿‡äº†ã€‚ ä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè´¦å·ï¼Œåœ¨winä¸Šé¢ç™»é™†ï¼Œå¿…é¡»è¦è®©ä½ éƒ½æœåŠ¡å™¨è¿æ¥ç½‘ç»œï¼Œå¹¶ä¸”æ³¨å†Œä½¿ç”¨seafileçš„ç”¨æˆ·å¿…é¡»ä½¿ç”¨emailåœ°å€ä½œä¸ºç™»é™†è´¦å·ï¼Œè¿™ä¸ªè´¦å·å¿…é¡»æ˜¯å­˜åœ¨å¯ç™»å½•çš„email æˆ‘ä»¬åªéœ€è¦å°†è¿™ä¸ªèµ„æ–™åº“ä¸‹è½½åˆ°æœ¬åœ°å°±å¯äº†ï¼Œæ·»åŠ æ–‡ä»¶ï¼Œç„¶åå³å‡»â€œæˆ‘çš„èµ„æ–™åº“â€å°±å¯ä»¥çœ‹åˆ°åŒæ­¥åˆ°æœåŠ¡å™¨äº†ã€‚ ç„¶åæˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°èµ„æ–™åº“ä¸­æŒ‡å®šæŸä¸ªæ–‡ä»¶ç”Ÿæˆä¸€ä¸ªä¸‹è½½é“¾æ¥ï¼Œå¯ä»¥åˆ†äº«ç»™æˆ‘çš„å°ä¼™ä¼´ä¸‹è½½ã€‚ æˆ‘çœ‹äº†ä¸€ä¸‹æœåŠ¡å™¨ä¸Šé¢çš„æ•°æ®å­˜å‚¨ç›®å½•ï¼Œæ•°æ®ä¼ å…¥åˆ°æœåŠ¡å™¨ç«¯å°±ç±»ä¼¼äºMap Reduceè¿™ç§è½¯ä»¶æ¶æ„å°†æ•°æ®åˆ‡æˆäº†å¾ˆå¤šå¾ˆå¤šä»½ï¼Œç„¶ååˆ›å»ºç´¢å¼•ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè·å–æ•°æ®æ—¶æ‹¿åˆ°ç´¢å¼•ï¼Œæœ€åæ ¹æ®ç´¢å¼•é‡ç»„æ•°æ®ï¼Œå†è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ã€‚ ä¸Šå›¾ä¸­0211e*********è¿™ä¸ªç›®å½•æ˜¯ç”¨æˆ·seafileshareçš„èµ„æ–™åº“ï¼Œæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨æ˜¯å®ƒå°±å°†ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶æ‹†æ•£äº†ï¼Œåœ¨æœåŠ¡ç«¯æˆ‘ä»¬æ‰¾ä¸åˆ°ä¸€ä¸ªå®Œæ•´çš„è½¯ä»¶åŒ…ã€‚è¿™ç§å­˜å‚¨æ–¹å¼è·Ÿmogilefsæœ‰äº›ç±»ä¼¼ã€‚ æ„Ÿè§‰ç¤¾åŒºç‰ˆè¿˜æ˜¯æœ‰äº›å±€é™æ€§ï¼Œä½†æ˜¯å¯¹äºä¸ªäººï¼Œä¸€ä¸ªå›¢é˜Ÿæˆ‘ä¸ªäººè§‰å¾—å®Œå…¨è¶³å¤Ÿå•¦ã€‚ å¥½äº†å¦‚æœéœ€è¦äº†è§£æ›´å¤šï¼Œå¯ä»¥åˆ°å®˜ç½‘äº†è§£ä½¿ç”¨ï¼šhttp://www.seafile.com","categories":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}],"tags":[],"keywords":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}]},{"title":"å­¦ä¹ SaltStackå°è®°â€”ç¬¬ä¸‰ç« ã€ŠPillarä½¿ç”¨æ–¹æ³•ã€‹","slug":"saltstack-pillar-de-shi-xian-fang-shi","date":"2015-08-18T15:00:00.000Z","updated":"2025-09-01T01:59:08.873Z","comments":true,"path":"2015/08/18/saltstack-pillar-de-shi-xian-fang-shi/","permalink":"https://blog.sctux.cc/2015/08/18/saltstack-pillar-de-shi-xian-fang-shi/","excerpt":"1.è¦å¯ç”¨pillarï¼Œé¦–å…ˆè¦ä¿®æ”¹masterä¸­çš„é…ç½®[root@salt-master pillar]# vim /etc/salt/master pillar_roots: &nbsp;baseï¼š &nbsp; &nbsp;- /salt/pillar 2.é‡å¯master[root@salt-master pillar]# systemctl restar salt-master 3.æ˜¯å­˜æ”¾åœ¨masterç«¯ï¼Œé»˜è®¤ä½ç½®/srv/pillarï¼Œéœ€è¦æ–°å»ºç›®å½•ã€‚å’Œsalt slsç±»ä¼¼ï¼Œä¹Ÿæ˜¯éœ€è¦top.slsmkdir /srv/pillar 4.åœ¨/srv/pillarç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªtop.slsæ–‡ä»¶[root@salt-master pillar]# vim top.sls #å†…å®¹å¦‚ä¸‹ï¼š base: &nbsp;'node2.example.com': &nbsp;#æŒ‡å®šçš„ä¸»æœº &nbsp; &nbsp;- sc #è°ƒç”¨scæ¨¡ç‰ˆä¸­çš„å€¼ 5.åœ¨/srv/pillarä¸­åˆ›å»ºä¸€ä¸ªsc.slsæ–‡ä»¶[root@salt-master pillar]# vim sc.sls #å†…å®¹ä¸ºé”®å€¼å¯¹,k, væ ¼å¼çš„ name: guomaoqiu age: 22 language: chineses","text":"1.è¦å¯ç”¨pillarï¼Œé¦–å…ˆè¦ä¿®æ”¹masterä¸­çš„é…ç½®[root@salt-master pillar]# vim /etc/salt/master pillar_roots: &nbsp;baseï¼š &nbsp; &nbsp;- /salt/pillar 2.é‡å¯master[root@salt-master pillar]# systemctl restar salt-master 3.æ˜¯å­˜æ”¾åœ¨masterç«¯ï¼Œé»˜è®¤ä½ç½®/srv/pillarï¼Œéœ€è¦æ–°å»ºç›®å½•ã€‚å’Œsalt slsç±»ä¼¼ï¼Œä¹Ÿæ˜¯éœ€è¦top.slsmkdir /srv/pillar 4.åœ¨/srv/pillarç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªtop.slsæ–‡ä»¶[root@salt-master pillar]# vim top.sls #å†…å®¹å¦‚ä¸‹ï¼š base: &nbsp;'node2.example.com': &nbsp;#æŒ‡å®šçš„ä¸»æœº &nbsp; &nbsp;- sc #è°ƒç”¨scæ¨¡ç‰ˆä¸­çš„å€¼ 5.åœ¨/srv/pillarä¸­åˆ›å»ºä¸€ä¸ªsc.slsæ–‡ä»¶[root@salt-master pillar]# vim sc.sls #å†…å®¹ä¸ºé”®å€¼å¯¹,k, væ ¼å¼çš„ name: guomaoqiu age: 22 language: chineses å¥½å•¦ï¼Œæ­¤æ—¶pillarå®šä¹‰å¥½äº† 6.æ‰§è¡Œsaltutil.sync_grains #åˆ·æ–°pillarçš„å€¼[root@salt-master pillar]# salt 'node2.exmaple.com' saltutil.refresh_pillar #çœ‹ä¸‹ç»“æœï¼š [root@salt-master pillar]# salt \"node2.example.com\" pillar.data node2.example.com: &nbsp; &nbsp;---------- &nbsp; &nbsp;age: &nbsp; &nbsp; &nbsp; &nbsp;22 &nbsp; &nbsp;language: &nbsp; &nbsp; &nbsp; &nbsp;chineses &nbsp; &nbsp;name: &nbsp; &nbsp; &nbsp; &nbsp;guomaoqiu 7.ç”±ä¸Šå¯è§åœ¨node2è¿™å°ä¸»æœºä¸Šå·²ç»æœ‰pillarå€¼å•¦ï¼Œåªæ˜¯è¿™ä¸ªå€¼æ˜¯ä¿å­˜åœ¨masterç«¯çš„ï¼›é‚£é—®é¢˜æ¥äº†,å¦‚ä½•ä½¿ç”¨jinjaæ¨¡æ¿æ¥è°ƒç”¨grainsæˆ–è€…æ˜¯pillarçš„å€¼å‘¢ï¼Ÿçœ‹ä¸‹é¢ï¼š[root@salt-master salt]# pwd /srv/salt [root@salt-master salt]# cat top.sls base: &nbsp;'node2.example.com': &nbsp; &nbsp;- test.test [root@salt-master salt]# cat test/test.sls /tmp/test1.conf: &nbsp;file.managed: &nbsp; &nbsp;- source: salt://test/test1.conf.jinja &nbsp; &nbsp;- template: jinja &nbsp;#è°ƒç”¨jinjaæ¨¡æ¿ çœ‹ä¸€ä¸‹æ¨¡æ¿æ–‡ä»¶ï¼štest1.conf.jinja ï¿¼ è¯¥æ¨¡æ¿æ–‡ä»¶éƒ½è°ƒç”¨äº†grainsåŠpillarçš„å€¼ 8.æ¨åˆ°node2ä¸Šé¢å»ï¼šï¿¼ 9.åœ¨minionç«¯æŸ¥çœ‹ï¿¼ çœ‹åˆ°äº†çº¢è‰²æ¡†ä½çš„å°±æ˜¯é€šè¿‡è°ƒç”¨grains,pillarå€¼ç”Ÿæˆçš„ã€‚","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"å­¦ä¹ SaltStackå°è®°â€”ç¬¬äºŒç« ã€Šç¼–å†™é…ç½®åŠåº”ç”¨ã€‹","slug":"e5-ad-a6-e4-b9-a0saltstack-e5-b0-8f-e8-ae-b0-e7-ac-ac-e4-ba-8c-e7-ab-a0-e3-80-8a-e7-bc-96-e5-86-99-e9-85-8d-e7-bd-ae-e5-8f-8a-e5-ba-94-e7-94-a8-e3-80-8b","date":"2015-08-13T12:17:38.000Z","updated":"2025-09-01T01:59:08.980Z","comments":true,"path":"2015/08/13/e5-ad-a6-e4-b9-a0saltstack-e5-b0-8f-e8-ae-b0-e7-ac-ac-e4-ba-8c-e7-ab-a0-e3-80-8a-e7-bc-96-e5-86-99-e9-85-8d-e7-bd-ae-e5-8f-8a-e5-ba-94-e7-94-a8-e3-80-8b/","permalink":"https://blog.sctux.cc/2015/08/13/e5-ad-a6-e4-b9-a0saltstack-e5-b0-8f-e8-ae-b0-e7-ac-ac-e4-ba-8c-e7-ab-a0-e3-80-8a-e7-bc-96-e5-86-99-e9-85-8d-e7-bd-ae-e5-8f-8a-e5-ba-94-e7-94-a8-e3-80-8b/","excerpt":"ä¸Šæ¬¡è®°å½•äº†ä¸€ä¸‹saltçš„å®‰è£…å’Œé…ç½®ï¼Œä¸‹é¢è®°å½•ä¸€ä¸‹å¦‚ä½•å»ç¼–å†™ä¸€ä¸ªé…ç½®å¹¶ä¸”åº”ç”¨åˆ°minion. SaltStacké»˜è®¤çš„é…ç½®æ–‡ä»¶è·¯å¾„åœ¨/srv/slatä¸‹ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªç›®å½•å°±æ–°å»ºä¸ªã€‚å¦‚æœä¸ç¡®å®šå¯ä»¥æ‰“å¼€Masterçš„ä¸»é…ç½®æ–‡ä»¶çœ‹ä¸‹ã€‚ åœ¨masterä¸»é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‰“å¼€ä¸€ä¸‹ä¸‰è¡Œçš„æ³¨é‡Šï¼Œè¿™å°±æ˜¯saltçš„é»˜è®¤é…ç½®è·¯å¾„ã€‚ è¿™é‡Œé»˜è®¤é…ç½®æ–‡ä»¶æ˜¯æ³¨é‡Šäº†çš„ï¼Œå¦‚æœéœ€è¦ç›´æ¥å–æ¶ˆæ³¨é‡Šå°±è¡Œäº†ã€‚ åˆ‡è®°ï¼Œæ¯æ¬¡ä¿®æ”¹äº†é…ç½®æ–‡ä»¶éƒ½è¦é‡å¯æœåŠ¡ ä¸‹é¢ä»¥ä¸¤ä¸ªéœ€æ±‚ä¸ºä¾‹å­è¿›è¡Œå­¦ä¹ : a.åœ¨minionä¸Šé¢å®‰è£…httpdæœåŠ¡ï¼Œå¹¶ä¸”å¯åŠ¨ä¹‹ b.è‡ªå»ºindex.htmlæ–‡ä»¶ï¼Œåœ¨masterç«¯åº”ç”¨é…ç½®å®Œæˆåç›´æ¥è®¿é—®minionçš„httpæœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤ºæˆ‘è‡ªå®šçš„index.htmlæ–‡ä»¶å†…å®¹ é¢ï¼Œåˆšå¼€å§‹å­¦ä¹ è¿™ä¸ªçš„æ—¶å€™é…ç½®æ–‡ä»¶ç¼–å†™å¾ˆæ˜¯ä¸€ä»¶å¤´ç–¼çš„äº‹æƒ…ï¼› ä¸€ã€é…ç½®æ–‡ä»¶è¯´æ˜ 1.å¼•å¯¼é…ç½®æ–‡ä»¶ top.sls saltstackçš„ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶é»˜è®¤ä¸ºtop.slsï¼Œæ˜¯ä½äº/srv/salt/ç›®å½•ä¸‹çš„ï¼Œå½“ç„¶è¿™ä¸æ˜¯ç»å¯¹çš„ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶çš„å“¦ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯å¿…é¡»è¦æœ‰çš„ã€‚ ä¾‹å¦‚ï¼š [root@saltstack-node1 salt]# more top.slsbase: ###å¯ä»¥ç†è§£ä¸ºä»“åº“ â€˜node0.example.comâ€™: ###å¯¹è±¡åï¼Œå°±æ˜¯é’ˆå¯¹é‚£äº›minionï¼Œè¿™é‡Œå¯ä»¥æ”¯æŒç»„ä»€ä¹ˆçš„ï¼Œå°±æ˜¯å„ç§åŒ¹é…å§ - apache ###èµ„æºå(è‡ªå®šä¹‰) è¯´æ˜ï¼šèµ„æºåéœ€è¦åœ¨/srv/saltç›®å½•æ–°å»ºæ–‡ä»¶ä¸ºapache.slsï¼Œæ³¨æ„ï¼šæ‰€æœ‰ç”Ÿæ•ˆçš„é…ç½®æ–‡ä»¶éƒ½æ˜¯ä»¥slsç»“å°¾çš„ã€‚ 2.èµ„æºé…ç½®æ–‡ä»¶ /srv/salt/apache.sls è¿™ä¸ªå°±æ˜¯ä¸Šé¢topä¸­æŒ‡å®šçš„èµ„æºå [root@saltstack-node1 salt]# cat apache.slsapache-service: ###ID,è‡ªå®šä¹‰ pkg.installed: ###ä½¿ç”¨åŒ…ç®¡ç†çš„insalledæ–¹æ³• - names: ###åç§° - httpd ###è½¯ä»¶åŒ…å - httpd-devel service.running: ###æ¨¡å—åç§°ï¼Œå®‰è£…å¥½ä¹‹åè¦å¯åŠ¨å®ƒ - name: httpd ###å¯åŠ¨ä»€ä¹ˆ - enable: True ###å¼€æœºè‡ªå¯åŠ¨ - reload: True ###ç›‘è§†è¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæœ‰å˜åŠ¨ï¼Œæˆ‘ä»¬è¦é‡è½½æœåŠ¡ - watch: - file: /var/www/html/index.html ###æ–‡ä»¶è·¯å¾„ - require: ###åº”ç”¨å‰æï¼Œhttpdè¿™ä¸ªè½¯ä»¶åŒ…å®‰è£…å¥½ä¹‹åï¼Œæ‰æ‰§è¡Œserviceè¿™ä¸ªæ¨¡å— - pkg: httpd file.managed: ###æ¨¡å—åç§°ï¼Œä½¿ç”¨fileæ¨¡å—çš„managedè¿™ä¸ªæ–¹æ³•ï¼Œç›®çš„ï¼Œæ–‡ä»¶ç®¡ç† - name: /var/www/html/index.html ###minionç«¯çš„æ–‡ä»¶å…·ä½“è·¯å¾„ - source: salt://index.html ###æºæ–‡ä»¶ - user: apache ###è¿™ä¸ªæ–‡ä»¶çš„ä¸€äº›å±æ€§ - group: root - mode: 644 - backup: minion ###æ”¹å˜ä¹‹å‰å¤‡ä»½ - require: ###åŒä¸Šï¼Œæ‰§è¡Œå®Œä¸Šé¢çš„ï¼Œåœ¨æ‰§è¡Œè¿™ä¸ª - pkg: httpd è¯´æ˜ï¼šæºæ–‡ä»¶çš„ä½ç½®å°±æ˜¯åœ¨/srv/saltç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶index.htmlã€‚ æˆ‘è¿™é‡Œå†…å®¹è‡ªå®šä¹‰ï¼š echo â€œSaltStackâ€œ &gt; index.html é…ç½®ç¼–å†™å®Œæ¯•æœ€åçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š äºŒã€åº”ç”¨äºå®¢æˆ·ç«¯ ç»è¿‡ä¸Šé¢Masterç«¯ç¼–å†™é…ç½®æ–‡ä»¶åï¼Œæ­¤æ—¶å·²ç»ç”Ÿæ•ˆã€‚Minionsåªè¦åŒæ­¥èµ„æºå³å¯å®ç°ä¸Šé¢çš„ä¸¤ä¸ªéœ€æ±‚ã€‚é‚£ä¹ˆå°±æ˜¯å¦‚ä½•æ¥åŒæ­¥ï¼Ÿ è¿™é‡Œæœ‰ä¸¤ç§æ–¹å¼ï¼š ç¬¬ä¸€ç§æ‰‹åŠ¨åœ¨Masterä¸Šæ‰§è¡Œæ¨é€å‘½ä»¤ï¼Œç¬¬äºŒç§æ˜¯åœ¨Minionè®¾ç½®æ—¶é—´é—´éš”è‡ªåŠ¨æƒ³Masterç«¯åŒæ­¥æœ€æ–°çš„èµ„æºã€‚ 1ã€Masteræ‰‹åŠ¨åŒæ­¥ åœ¨Masterä¸Šæ‰§è¡Œ# salt â€˜*â€™ state.highstate ###æ„æ€æ˜¯å‘æ‰€æœ‰Minionsæ¨é€æœ€æ–°èµ„æº 2ã€Minionè‡ªåŠ¨åŒæ­¥ åœ¨/etc/salt/minioné…ç½®æ–‡ä»¶ä¸­å¢åŠ  schedule:highstate:function: state.highstateseconds: 30 ###æ„æ€æ˜¯æ¯30ç§’å‘MasteråŒæ­¥ä¸€æ¬¡æœ€æ–°èµ„æºï¼Œä¹Ÿå¯è®¾ç½®åˆ†-mintusã€å°æ—¶-hours","text":"ä¸Šæ¬¡è®°å½•äº†ä¸€ä¸‹saltçš„å®‰è£…å’Œé…ç½®ï¼Œä¸‹é¢è®°å½•ä¸€ä¸‹å¦‚ä½•å»ç¼–å†™ä¸€ä¸ªé…ç½®å¹¶ä¸”åº”ç”¨åˆ°minion. SaltStacké»˜è®¤çš„é…ç½®æ–‡ä»¶è·¯å¾„åœ¨/srv/slatä¸‹ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªç›®å½•å°±æ–°å»ºä¸ªã€‚å¦‚æœä¸ç¡®å®šå¯ä»¥æ‰“å¼€Masterçš„ä¸»é…ç½®æ–‡ä»¶çœ‹ä¸‹ã€‚ åœ¨masterä¸»é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‰“å¼€ä¸€ä¸‹ä¸‰è¡Œçš„æ³¨é‡Šï¼Œè¿™å°±æ˜¯saltçš„é»˜è®¤é…ç½®è·¯å¾„ã€‚ è¿™é‡Œé»˜è®¤é…ç½®æ–‡ä»¶æ˜¯æ³¨é‡Šäº†çš„ï¼Œå¦‚æœéœ€è¦ç›´æ¥å–æ¶ˆæ³¨é‡Šå°±è¡Œäº†ã€‚ åˆ‡è®°ï¼Œæ¯æ¬¡ä¿®æ”¹äº†é…ç½®æ–‡ä»¶éƒ½è¦é‡å¯æœåŠ¡ ä¸‹é¢ä»¥ä¸¤ä¸ªéœ€æ±‚ä¸ºä¾‹å­è¿›è¡Œå­¦ä¹ : a.åœ¨minionä¸Šé¢å®‰è£…httpdæœåŠ¡ï¼Œå¹¶ä¸”å¯åŠ¨ä¹‹ b.è‡ªå»ºindex.htmlæ–‡ä»¶ï¼Œåœ¨masterç«¯åº”ç”¨é…ç½®å®Œæˆåç›´æ¥è®¿é—®minionçš„httpæœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤ºæˆ‘è‡ªå®šçš„index.htmlæ–‡ä»¶å†…å®¹ é¢ï¼Œåˆšå¼€å§‹å­¦ä¹ è¿™ä¸ªçš„æ—¶å€™é…ç½®æ–‡ä»¶ç¼–å†™å¾ˆæ˜¯ä¸€ä»¶å¤´ç–¼çš„äº‹æƒ…ï¼› ä¸€ã€é…ç½®æ–‡ä»¶è¯´æ˜ 1.å¼•å¯¼é…ç½®æ–‡ä»¶ top.sls saltstackçš„ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶é»˜è®¤ä¸ºtop.slsï¼Œæ˜¯ä½äº/srv/salt/ç›®å½•ä¸‹çš„ï¼Œå½“ç„¶è¿™ä¸æ˜¯ç»å¯¹çš„ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶çš„å“¦ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯å¿…é¡»è¦æœ‰çš„ã€‚ ä¾‹å¦‚ï¼š [root@saltstack-node1 salt]# more top.slsbase: ###å¯ä»¥ç†è§£ä¸ºä»“åº“ â€˜node0.example.comâ€™: ###å¯¹è±¡åï¼Œå°±æ˜¯é’ˆå¯¹é‚£äº›minionï¼Œè¿™é‡Œå¯ä»¥æ”¯æŒç»„ä»€ä¹ˆçš„ï¼Œå°±æ˜¯å„ç§åŒ¹é…å§ - apache ###èµ„æºå(è‡ªå®šä¹‰) è¯´æ˜ï¼šèµ„æºåéœ€è¦åœ¨/srv/saltç›®å½•æ–°å»ºæ–‡ä»¶ä¸ºapache.slsï¼Œæ³¨æ„ï¼šæ‰€æœ‰ç”Ÿæ•ˆçš„é…ç½®æ–‡ä»¶éƒ½æ˜¯ä»¥slsç»“å°¾çš„ã€‚ 2.èµ„æºé…ç½®æ–‡ä»¶ /srv/salt/apache.sls è¿™ä¸ªå°±æ˜¯ä¸Šé¢topä¸­æŒ‡å®šçš„èµ„æºå [root@saltstack-node1 salt]# cat apache.slsapache-service: ###ID,è‡ªå®šä¹‰ pkg.installed: ###ä½¿ç”¨åŒ…ç®¡ç†çš„insalledæ–¹æ³• - names: ###åç§° - httpd ###è½¯ä»¶åŒ…å - httpd-devel service.running: ###æ¨¡å—åç§°ï¼Œå®‰è£…å¥½ä¹‹åè¦å¯åŠ¨å®ƒ - name: httpd ###å¯åŠ¨ä»€ä¹ˆ - enable: True ###å¼€æœºè‡ªå¯åŠ¨ - reload: True ###ç›‘è§†è¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæœ‰å˜åŠ¨ï¼Œæˆ‘ä»¬è¦é‡è½½æœåŠ¡ - watch: - file: /var/www/html/index.html ###æ–‡ä»¶è·¯å¾„ - require: ###åº”ç”¨å‰æï¼Œhttpdè¿™ä¸ªè½¯ä»¶åŒ…å®‰è£…å¥½ä¹‹åï¼Œæ‰æ‰§è¡Œserviceè¿™ä¸ªæ¨¡å— - pkg: httpd file.managed: ###æ¨¡å—åç§°ï¼Œä½¿ç”¨fileæ¨¡å—çš„managedè¿™ä¸ªæ–¹æ³•ï¼Œç›®çš„ï¼Œæ–‡ä»¶ç®¡ç† - name: /var/www/html/index.html ###minionç«¯çš„æ–‡ä»¶å…·ä½“è·¯å¾„ - source: salt://index.html ###æºæ–‡ä»¶ - user: apache ###è¿™ä¸ªæ–‡ä»¶çš„ä¸€äº›å±æ€§ - group: root - mode: 644 - backup: minion ###æ”¹å˜ä¹‹å‰å¤‡ä»½ - require: ###åŒä¸Šï¼Œæ‰§è¡Œå®Œä¸Šé¢çš„ï¼Œåœ¨æ‰§è¡Œè¿™ä¸ª - pkg: httpd è¯´æ˜ï¼šæºæ–‡ä»¶çš„ä½ç½®å°±æ˜¯åœ¨/srv/saltç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶index.htmlã€‚ æˆ‘è¿™é‡Œå†…å®¹è‡ªå®šä¹‰ï¼š echo â€œSaltStackâ€œ &gt; index.html é…ç½®ç¼–å†™å®Œæ¯•æœ€åçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š äºŒã€åº”ç”¨äºå®¢æˆ·ç«¯ ç»è¿‡ä¸Šé¢Masterç«¯ç¼–å†™é…ç½®æ–‡ä»¶åï¼Œæ­¤æ—¶å·²ç»ç”Ÿæ•ˆã€‚Minionsåªè¦åŒæ­¥èµ„æºå³å¯å®ç°ä¸Šé¢çš„ä¸¤ä¸ªéœ€æ±‚ã€‚é‚£ä¹ˆå°±æ˜¯å¦‚ä½•æ¥åŒæ­¥ï¼Ÿ è¿™é‡Œæœ‰ä¸¤ç§æ–¹å¼ï¼š ç¬¬ä¸€ç§æ‰‹åŠ¨åœ¨Masterä¸Šæ‰§è¡Œæ¨é€å‘½ä»¤ï¼Œç¬¬äºŒç§æ˜¯åœ¨Minionè®¾ç½®æ—¶é—´é—´éš”è‡ªåŠ¨æƒ³Masterç«¯åŒæ­¥æœ€æ–°çš„èµ„æºã€‚ 1ã€Masteræ‰‹åŠ¨åŒæ­¥ åœ¨Masterä¸Šæ‰§è¡Œ# salt â€˜*â€™ state.highstate ###æ„æ€æ˜¯å‘æ‰€æœ‰Minionsæ¨é€æœ€æ–°èµ„æº 2ã€Minionè‡ªåŠ¨åŒæ­¥ åœ¨/etc/salt/minioné…ç½®æ–‡ä»¶ä¸­å¢åŠ  schedule:highstate:function: state.highstateseconds: 30 ###æ„æ€æ˜¯æ¯30ç§’å‘MasteråŒæ­¥ä¸€æ¬¡æœ€æ–°èµ„æºï¼Œä¹Ÿå¯è®¾ç½®åˆ†-mintusã€å°æ—¶-hours ä¸‹é¢æ˜¯åœ¨masterç«¯æ‰§è¡Œçš„ç»“æœï¼š å½“ç„¶åœ¨æ¨é€èµ„æºæ—¶æˆ‘ä»¬å¯ä»¥å…ˆæµ‹è¯•ä¸€ä¸‹ï¼Œå‘½ä»¤ï¼š salt â€˜node0.example.comâ€™ state.highstate test=True ä¸Šé¢çš„æ¨é€å·²ç»å®Œæˆï¼Œä¸‹é¢éªŒè¯ç»“æœï¼š è‡³æ­¤ä¸Šé¢ä¸¤ä¸ªéœ€æ±‚å·²ç»å®ç°äº†ã€‚è¿™ä¹Ÿæ˜¯saltæœ€åŸºæœ¬çš„ç”¨æ³•åŠåŠŸèƒ½å•¦ã€‚åé¢ç»§ç»­å­¦ä¹ ã€‚ çœ‹æ¥æä¸ªlampæˆ–è€…lnmpå¹³å°ä¹Ÿå¯ä»¥è½»è€Œæ˜“ä¸¾çš„å®ç°äº†ã€‚","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"å­¦ä¹ SaltStackå°è®°---ç¬¬ä¸€ç« ã€Šå®‰è£…åŠç®€å•æµ‹è¯•ã€‹","slug":"e5-ad-a6-e4-b9-a0saltstack-e5-b0-8f-e8-ae-b0-e7-ac-ac-e4-b8-80-e7-ab-a0-e3-80-8a-e5-ae-89-e8-a3-85-e5-8f-8a-e7-ae-80-e5-8d-95-e6-b5-8b-e8-af-95-e3-80-8b","date":"2015-08-12T08:22:39.000Z","updated":"2025-09-01T01:59:08.931Z","comments":true,"path":"2015/08/12/e5-ad-a6-e4-b9-a0saltstack-e5-b0-8f-e8-ae-b0-e7-ac-ac-e4-b8-80-e7-ab-a0-e3-80-8a-e5-ae-89-e8-a3-85-e5-8f-8a-e7-ae-80-e5-8d-95-e6-b5-8b-e8-af-95-e3-80-8b/","permalink":"https://blog.sctux.cc/2015/08/12/e5-ad-a6-e4-b9-a0saltstack-e5-b0-8f-e8-ae-b0-e7-ac-ac-e4-b8-80-e7-ab-a0-e3-80-8a-e5-ae-89-e8-a3-85-e5-8f-8a-e7-ae-80-e5-8d-95-e6-b5-8b-e8-af-95-e3-80-8b/","excerpt":"ä¸€ã€ä»€ä¹ˆæ˜¯saltstack Saltï¼Œ,ä¸€ç§å…¨æ–°çš„åŸºç¡€è®¾æ–½ç®¡ç†æ–¹å¼ï¼Œéƒ¨ç½²è½»æ¾ï¼Œåœ¨å‡ åˆ†é’Ÿå†…å¯è¿è¡Œèµ·æ¥ï¼Œæ‰©å±•æ€§å¥½ï¼Œå¾ˆå®¹æ˜“ç®¡ç†ä¸Šä¸‡å°æœåŠ¡å™¨ï¼Œé€Ÿåº¦å¤Ÿå¿«ï¼ŒæœåŠ¡å™¨ä¹‹é—´ç§’çº§é€šè®¯ã€‚saltåº•å±‚é‡‡ç”¨åŠ¨æ€çš„è¿æ¥æ€»çº¿, ä½¿å…¶å¯ä»¥ç”¨äºç¼–é…, è¿œç¨‹æ‰§è¡Œ, é…ç½®ç®¡ç†ç­‰ç­‰. SaltStack æ˜¯ç»§ Puppetã€Chef ä¹‹åæ–°å‡ºç°çš„é…ç½®ç®¡ç†åŠè¿œç¨‹æ‰§è¡Œå·¥å…·ï¼Œ ç›®å‰ï¼ŒSaltStack æ­£å¾—åˆ°è¶Šæ¥è¶Šå¤šçš„ç©ç›®ã€‚ä¸ Puppet ç›¸æ¯”ï¼ŒSaltStack æ²¡æœ‰é‚£ä¹ˆç¬¨é‡ï¼Œæ„Ÿè§‰è¾ƒä¸ºè½»é‡ï¼›ä¸åƒ Puppet æœ‰ ä¸€å¥—è‡ªå·±çš„ DSL ç”¨æ¥å†™é…ç½®ï¼ŒSaltStack ä½¿ç”¨ YAML ä½œä¸ºé…ç½®æ–‡ä»¶æ ¼å¼ï¼Œå†™ èµ·æ¥æ—¢ç®€å•åˆå®¹æ˜“ï¼ŒåŒæ—¶ä¹Ÿä¾¿äºåŠ¨æ€ç”Ÿæˆï¼›æ­¤å¤–ï¼ŒSaltStack åœ¨è¿œç¨‹æ‰§è¡Œå‘½ä»¤ æ—¶çš„é€Ÿåº¦éå¸¸å¿«ï¼Œä¹ŸåŒ…å«ä¸°å¯Œçš„æ¨¡å—ã€‚ å®˜æ–¹ç«™ç‚¹ï¼šhttp://www.saltstack.com/ å®˜æ–¹æ–‡æ¡£ï¼šhttp://docs.saltstack.com/ ä¸­æ–‡ç«™ç‚¹ï¼šhttp://www.saltstack.cn/ ä¸­æ–‡æ‰‹å†Œï¼šhttp://docs.saltstack.cn/ ä¸­æ–‡wikiï¼šhttp://wiki.saltstack.cn/doc &nbsp; äºŒã€å®‰è£… è¿™é‡Œé‡‡ç”¨çš„æ˜¯ä»EPELæºç›´æ¥yumå®‰è£…ï¼Œå½“ç„¶æˆ‘ä»¬è¦æ›´æ–°epelæºï¼š # rpm -Uvh http://dl.fedoraproject.org/pub/epel/5/x86_64/epel-release-5-4.noarch.rpm SaltStack-Masterï¼ˆä¸»æœåŠ¡å™¨ï¼‰ # yum -y install salt-master SaltStack-Minionï¼ˆä»æœåŠ¡å™¨ï¼‰ # yum -y install salt-minion &nbsp; ä¸‰ã€ç®€å•é…ç½®åŠä½¿ç”¨ 1ã€åŸºæœ¬ä¿¡æ¯ï¼š Masterç«¯ï¼š192.168.1.21 saltstack-node1.example.comMinionç«¯ï¼š192.168.1.22 saltstack-node2.example.com 2ã€å¯åŠ¨å‘½ä»¤ï¼š Masterç«¯ï¼š/etc/init.d/salt-master {start|stop|status|restart|condrestart|reload}Minionç«¯ï¼š/etc/init.d/salt-minion {start|stop|status|restart|condrestart|reload} 3.ä¸»é…ç½®æ–‡ä»¶ï¼š Masterç«¯ï¼š/etc/salt/masterMinionç«¯ï¼š/etc/salt/master 4.é…ç½®Masterç«¯ ä¿®æ”¹ç›‘å¬åœ°å€é»˜è®¤ä¸ºç›‘å¬æ‰€æœ‰ sed -ie â€˜s/^#.*interface:.*/\\ interface: 192.168.1.111/gâ€™ /etc/salt/master###æ³¨ï¼šå¦‚æœä½¿ç”¨ä¸»æœºåï¼Œè¯·ç»‘å®šhosts","text":"ä¸€ã€ä»€ä¹ˆæ˜¯saltstack Saltï¼Œ,ä¸€ç§å…¨æ–°çš„åŸºç¡€è®¾æ–½ç®¡ç†æ–¹å¼ï¼Œéƒ¨ç½²è½»æ¾ï¼Œåœ¨å‡ åˆ†é’Ÿå†…å¯è¿è¡Œèµ·æ¥ï¼Œæ‰©å±•æ€§å¥½ï¼Œå¾ˆå®¹æ˜“ç®¡ç†ä¸Šä¸‡å°æœåŠ¡å™¨ï¼Œé€Ÿåº¦å¤Ÿå¿«ï¼ŒæœåŠ¡å™¨ä¹‹é—´ç§’çº§é€šè®¯ã€‚saltåº•å±‚é‡‡ç”¨åŠ¨æ€çš„è¿æ¥æ€»çº¿, ä½¿å…¶å¯ä»¥ç”¨äºç¼–é…, è¿œç¨‹æ‰§è¡Œ, é…ç½®ç®¡ç†ç­‰ç­‰. SaltStack æ˜¯ç»§ Puppetã€Chef ä¹‹åæ–°å‡ºç°çš„é…ç½®ç®¡ç†åŠè¿œç¨‹æ‰§è¡Œå·¥å…·ï¼Œ ç›®å‰ï¼ŒSaltStack æ­£å¾—åˆ°è¶Šæ¥è¶Šå¤šçš„ç©ç›®ã€‚ä¸ Puppet ç›¸æ¯”ï¼ŒSaltStack æ²¡æœ‰é‚£ä¹ˆç¬¨é‡ï¼Œæ„Ÿè§‰è¾ƒä¸ºè½»é‡ï¼›ä¸åƒ Puppet æœ‰ ä¸€å¥—è‡ªå·±çš„ DSL ç”¨æ¥å†™é…ç½®ï¼ŒSaltStack ä½¿ç”¨ YAML ä½œä¸ºé…ç½®æ–‡ä»¶æ ¼å¼ï¼Œå†™ èµ·æ¥æ—¢ç®€å•åˆå®¹æ˜“ï¼ŒåŒæ—¶ä¹Ÿä¾¿äºåŠ¨æ€ç”Ÿæˆï¼›æ­¤å¤–ï¼ŒSaltStack åœ¨è¿œç¨‹æ‰§è¡Œå‘½ä»¤ æ—¶çš„é€Ÿåº¦éå¸¸å¿«ï¼Œä¹ŸåŒ…å«ä¸°å¯Œçš„æ¨¡å—ã€‚ å®˜æ–¹ç«™ç‚¹ï¼šhttp://www.saltstack.com/ å®˜æ–¹æ–‡æ¡£ï¼šhttp://docs.saltstack.com/ ä¸­æ–‡ç«™ç‚¹ï¼šhttp://www.saltstack.cn/ ä¸­æ–‡æ‰‹å†Œï¼šhttp://docs.saltstack.cn/ ä¸­æ–‡wikiï¼šhttp://wiki.saltstack.cn/doc &nbsp; äºŒã€å®‰è£… è¿™é‡Œé‡‡ç”¨çš„æ˜¯ä»EPELæºç›´æ¥yumå®‰è£…ï¼Œå½“ç„¶æˆ‘ä»¬è¦æ›´æ–°epelæºï¼š # rpm -Uvh http://dl.fedoraproject.org/pub/epel/5/x86_64/epel-release-5-4.noarch.rpm SaltStack-Masterï¼ˆä¸»æœåŠ¡å™¨ï¼‰ # yum -y install salt-master SaltStack-Minionï¼ˆä»æœåŠ¡å™¨ï¼‰ # yum -y install salt-minion &nbsp; ä¸‰ã€ç®€å•é…ç½®åŠä½¿ç”¨ 1ã€åŸºæœ¬ä¿¡æ¯ï¼š Masterç«¯ï¼š192.168.1.21 saltstack-node1.example.comMinionç«¯ï¼š192.168.1.22 saltstack-node2.example.com 2ã€å¯åŠ¨å‘½ä»¤ï¼š Masterç«¯ï¼š/etc/init.d/salt-master {start|stop|status|restart|condrestart|reload}Minionç«¯ï¼š/etc/init.d/salt-minion {start|stop|status|restart|condrestart|reload} 3.ä¸»é…ç½®æ–‡ä»¶ï¼š Masterç«¯ï¼š/etc/salt/masterMinionç«¯ï¼š/etc/salt/master 4.é…ç½®Masterç«¯ ä¿®æ”¹ç›‘å¬åœ°å€é»˜è®¤ä¸ºç›‘å¬æ‰€æœ‰ sed -ie â€˜s/^#.*interface:.*/\\ interface: 192.168.1.111/gâ€™ /etc/salt/master###æ³¨ï¼šå¦‚æœä½¿ç”¨ä¸»æœºåï¼Œè¯·ç»‘å®šhosts 5.é…ç½®minionç«¯ å®¢æˆ·ç«¯minionçš„é…ç½®ï¼Œvim /etc/salt/minion,æ·»åŠ master IPåœ°å€å’Œminion IDå·ï¼ŒIDå»ºè®®ç”¨ä¸»æœºåæ¥é…ç½®,ç„¶åå¼€å¯æ—¥å¿—åŠŸèƒ½ï¼Œä¸ºäº†ä¸é‡å¤æ“ä½œæˆ‘ä¸‹é¢å†™äº†ä¸€ä¸ªè„šæœ¬ï¼Œå½“æˆ‘ä»¬é…ç½®minionæ—¶èƒ½å¿«é€Ÿæå®šï¼š #/bin/bash#desc : salt client setttingsread -p â€œInput Mster IP: â€œ MIP ###æŒ‡å®šmasterIPCOMM1=â€sed -i \\â€œs/#master: salt/master: $MIP/\\â€œ /etc/salt/minionâ€eval $COMM1 echo â€˜ â€˜read -p â€œInput Minion ID: â€œ MID ###ä¿®æ”¹minion IDCOMM2=â€sed -i \\â€œs/#id:.*/id: $MID/\\â€œ /etc/salt/minionâ€eval $COMM2### å¼€å¯æ—¥å¿—sed -i â€œs@#log_file: /var/log/salt/minion@log_file: /var/log/salt/minion@1â€ /etc/salt/minionsed -i â€˜488dâ€™ /etc/salt/minion sed -i â€œs@#key_logfile: /var/log/salt/key@key_logfile: /var/log/salt/key@â€ /etc/salt/minion echo â€˜ â€˜echo -e â€œ\\033[42;37m Salt-minion Information: \\033[0mâ€echo â€˜##############################â€™sed -e â€˜/^#/d;/^$/dâ€™ /etc/salt/minionecho â€˜##############################â€™echo â€˜ â€˜###å¯åŠ¨æœåŠ¡/etc/init.d/salt-minion start###åªè¦æœ‰æ–°çš„minionå®¢æˆ·ç«¯æ·»åŠ è¿›æ¥æˆ‘ä»¬è¿è¡Œè¿™ä¸ªè„šæœ¬å°±å¯å¿«é€Ÿå®Œæˆminionç«¯çš„é…ç½®å•¦. 6.ä¿®æ”¹å®Œæ¯•æˆ‘ä»¬å°±å¯ä»¥é‡å¯æœåŠ¡å•¦. &nbsp; å››ã€å¼€å§‹å’ŒMasterç«¯é€šä¿¡ 1.Minionç¬¬ä¸€æ¬¡ä¸Masterç«¯é€šä¿¡ä¼šå‘å…¶ç”³è¯·ç­¾å‘è¯ä¹¦ã€‚åœ¨Masterç«¯æ‰§è¡Œ# salt-key å³å¯çœ‹åˆ°å·²ç»ç­¾å‘ã€å¾…ç­¾å‘ä»¥åŠæ‹’ç»çš„Minionåˆ—è¡¨ã€‚ä¸Šé¢é‚£å°Minionåˆšåˆšç”³è¯·ï¼Œæ‰€ä»¥ç°åœ¨åœ¨Masterä¸Šæ‰§è¡Œå‘½ä»¤åSaltStack- Minion01å°†ä¼šå‡ºç°åœ¨å¾…ç­¾å‘çš„åˆ—è¡¨ä¸­ã€‚ å¯¹äºæ‰¹é‡ç®¡ç†ï¼Œé¦–å…ˆå»ºè®®çš„å°±æ˜¯æ‰“å¼€Masterç«¯çš„è‡ªåŠ¨ç­¾å‘è¯ä¹¦ï¼Œè¦ä¸ç„¶å°±å¾—åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œå‘½ä»¤# salt-key -a Minion-IDæˆ–è€…# salt-key -Aï¼Œä½†ç›¸æ¯”éƒ½æ¯”è¾ƒéº»çƒ¦,äºæ˜¯æˆ‘ä»¬å¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†å…¶è‡ªåŠ¨ç­¾å‘ sed -ie â€˜s/^#auto_accept:.*/\\auto_accept: True/gâ€™ /etc/salt/master/etc/init.d/salt-master restart æ­¤æ—¶å†æ¬¡æ‰§è¡Œ# salt-key å°†ä¼šçœ‹åˆ°saltstack-node2.example.comå‡ºç°åœ¨å·²ç­¾å‘çš„åˆ—è¡¨ä¸­ã€‚ &nbsp; 2.ç®€å•æµ‹è¯•å…¶åŠŸèƒ½ï¼š ç›®å‰ä¸ºæ­¢ï¼ŒMasterç«¯å·²ç»å¯ä»¥å’ŒMinionæ­£å¸¸é€šä¿¡ã€‚ é¦–å…ˆæµ‹è¯•ä¸‹ï¼Œå‘saltstack-node2.example.comæ‰§è¡Œä¸€æ¡æŸ¥çœ‹å†…å­˜çš„å‘½ä»¤ è¿™é‡Œå°±å…ˆä¸è§£é‡Šå‘½ä»¤çš„å«ä¹‰å•¦,åé¢åœ¨ç»†è¯´ã€‚ è‡³æ­¤ï¼Œç®€å•æµ‹è¯•å®Œæ¯• å½“ç„¶SaltStackçš„åŠŸèƒ½ä¸æ­¢äºæ­¤ï¼Œä¸‹ç¯‡æ­£å¼çœ‹ä¸‹ä»–æ˜¯å¦‚ä½•å·¥ä½œä»¥åŠå„ç§é…ç½®çš„ç¼–å†™.","categories":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}],"tags":[{"name":"saltstack","slug":"saltstack","permalink":"https://blog.sctux.cc/tags/saltstack/"}],"keywords":[{"name":"è‡ªåŠ¨åŒ–è¿ç»´","slug":"è‡ªåŠ¨åŒ–è¿ç»´","permalink":"https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"}]},{"title":"Linuxç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬","slug":"linux-e7-b3-bb-e7-bb-9f-e5-88-9d-e5-a7-8b-e5-8c-96","date":"2015-06-19T12:06:31.000Z","updated":"2025-09-01T01:59:08.921Z","comments":true,"path":"2015/06/19/linux-e7-b3-bb-e7-bb-9f-e5-88-9d-e5-a7-8b-e5-8c-96/","permalink":"https://blog.sctux.cc/2015/06/19/linux-e7-b3-bb-e7-bb-9f-e5-88-9d-e5-a7-8b-e5-8c-96/","excerpt":"æˆ‘ä»¬åœ¨å®‰è£…å¥½æ“ä½œç³»ç»Ÿåä¸€èˆ¬éƒ½éœ€è¦å¯¹ç³»ç»Ÿåšä¸€äº›é’ˆå¯¹äºè‡ªå·±ç¯å¢ƒçš„æƒ…å†µåšä¸€ä¸‹ç³»ç»Ÿåˆå§‹åŒ–ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸€èˆ¬ç”¨shellè„šæœ¬æ¥è·‘ä¸€éï¼ŒæŠŠç›¸å…³çš„å‚æ•°ã€é…ç½®è°ƒæ•´ä¸€ä¸‹å°±å¥½äº†ã€‚ä½¿ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬å°±å¯ä»¥åˆå§‹åŒ–æˆ‘ä»¬ç³»ç»Ÿå•¦ã€‚ #!/bin/bash#Version 1.9#Auth: guomaoqiu#For CentOS_mini#Made on 2015-06-19 echo â€œ â€œecho â€œ#############################################################################â€echo â€œ# Initialize for the CentOS 6.4/6.5 mini_installed. #â€echo â€œ# #â€echo â€œ# Please affirm this OS connected net already before running this script ! #â€echo â€œ# #â€echo â€œ# must first connect to the Internet. because yum need it. #â€echo â€œ#############################################################################â€echo â€œ â€œ format() { #echo -e â€œ\\033[42;37m ########### Finished ########### \\033[0mâ€ sleep 5 echo -e â€œ\\033[42;37m ########### Finished ########### \\033[0mâ€ echo â€œ â€œ } ########################################################################### Set time æ—¶åŒº/æ—¶é—´åŒæ­¥è®¾ç½®echo â€œSet time.â€ /bin/cp -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&gt; /dev/nullyum -y install ntpdate &amp;&gt; /dev/nullntpdate 0.centos.pool.ntp.org &amp;&gt; /dev/nullhwclock -wformat #####################################################################################Set network ç½‘å¡å¼€æœºè‡ªå¯åŠ¨#sed -i â€œs/ONBOOT=no/ONBOOT=yes/gâ€ /etc/sysconfig/network-scripts/ifcfg-eth0#sed -i â€œs/NM_CONTROLLED=no/NM_CONTROLLED=no/gâ€/etc/sysconfig/network-scripts/ifcfg-eth0#/etc/init.d/network restart &amp;&gt;/dev/null#echo â€œ==================================â€ &gt;&gt; $LOG#format ########################################################################### Create Log åˆ›å»ºè¯¥è„šæœ¬è¿è¡Œè®°å½•æ—¥å¿—echo â€œCreate log file.â€DATE1=`date +â€%F %H:%Mâ€`LOG=/var/log/sysinitinfo.logecho $DATE1 &gt;&gt; $LOGecho â€œâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€œ &gt;&gt; $LOGecho â€œFor CentOS_miniâ€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGecho â€œSet timezone is Shanghaiâ€ &gt;&gt; $LOGecho â€œFinished ntpdateâ€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Disabled Selinux ç¦ç”¨Selinuxecho â€œDisabled SELinux.â€sed -i â€˜s/^SELINUX=enforcing/SELINUX=disabled/â€˜ /etc/sysconfig/selinuxecho â€œ==================================================â€echo â€œDisabled SELinux.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Stop iptables ç¦ç”¨iptablesecho â€œStop iptables.â€service iptables stop &amp;&gt; /dev/nullchkconfig â€“level 35 iptables offecho â€œStop iptables.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Disable ipv6 ç¦ç”¨IPV6echo â€œDisable ipv6.â€echo â€œalias net-pf-10 offâ€ &gt;&gt; /etc/modprobe.confecho â€œalias ipv6 offâ€ &gt;&gt; /etc/modprobe.confchkconfig â€“level 35 ip6tables offecho â€œDisable ipv6.â€&gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat","text":"æˆ‘ä»¬åœ¨å®‰è£…å¥½æ“ä½œç³»ç»Ÿåä¸€èˆ¬éƒ½éœ€è¦å¯¹ç³»ç»Ÿåšä¸€äº›é’ˆå¯¹äºè‡ªå·±ç¯å¢ƒçš„æƒ…å†µåšä¸€ä¸‹ç³»ç»Ÿåˆå§‹åŒ–ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸€èˆ¬ç”¨shellè„šæœ¬æ¥è·‘ä¸€éï¼ŒæŠŠç›¸å…³çš„å‚æ•°ã€é…ç½®è°ƒæ•´ä¸€ä¸‹å°±å¥½äº†ã€‚ä½¿ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬å°±å¯ä»¥åˆå§‹åŒ–æˆ‘ä»¬ç³»ç»Ÿå•¦ã€‚ #!/bin/bash#Version 1.9#Auth: guomaoqiu#For CentOS_mini#Made on 2015-06-19 echo â€œ â€œecho â€œ#############################################################################â€echo â€œ# Initialize for the CentOS 6.4/6.5 mini_installed. #â€echo â€œ# #â€echo â€œ# Please affirm this OS connected net already before running this script ! #â€echo â€œ# #â€echo â€œ# must first connect to the Internet. because yum need it. #â€echo â€œ#############################################################################â€echo â€œ â€œ format() { #echo -e â€œ\\033[42;37m ########### Finished ########### \\033[0mâ€ sleep 5 echo -e â€œ\\033[42;37m ########### Finished ########### \\033[0mâ€ echo â€œ â€œ } ########################################################################### Set time æ—¶åŒº/æ—¶é—´åŒæ­¥è®¾ç½®echo â€œSet time.â€ /bin/cp -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&gt; /dev/nullyum -y install ntpdate &amp;&gt; /dev/nullntpdate 0.centos.pool.ntp.org &amp;&gt; /dev/nullhwclock -wformat #####################################################################################Set network ç½‘å¡å¼€æœºè‡ªå¯åŠ¨#sed -i â€œs/ONBOOT=no/ONBOOT=yes/gâ€ /etc/sysconfig/network-scripts/ifcfg-eth0#sed -i â€œs/NM_CONTROLLED=no/NM_CONTROLLED=no/gâ€/etc/sysconfig/network-scripts/ifcfg-eth0#/etc/init.d/network restart &amp;&gt;/dev/null#echo â€œ==================================â€ &gt;&gt; $LOG#format ########################################################################### Create Log åˆ›å»ºè¯¥è„šæœ¬è¿è¡Œè®°å½•æ—¥å¿—echo â€œCreate log file.â€DATE1=`date +â€%F %H:%Mâ€`LOG=/var/log/sysinitinfo.logecho $DATE1 &gt;&gt; $LOGecho â€œâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€œ &gt;&gt; $LOGecho â€œFor CentOS_miniâ€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGecho â€œSet timezone is Shanghaiâ€ &gt;&gt; $LOGecho â€œFinished ntpdateâ€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Disabled Selinux ç¦ç”¨Selinuxecho â€œDisabled SELinux.â€sed -i â€˜s/^SELINUX=enforcing/SELINUX=disabled/â€˜ /etc/sysconfig/selinuxecho â€œ==================================================â€echo â€œDisabled SELinux.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Stop iptables ç¦ç”¨iptablesecho â€œStop iptables.â€service iptables stop &amp;&gt; /dev/nullchkconfig â€“level 35 iptables offecho â€œStop iptables.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Disable ipv6 ç¦ç”¨IPV6echo â€œDisable ipv6.â€echo â€œalias net-pf-10 offâ€ &gt;&gt; /etc/modprobe.confecho â€œalias ipv6 offâ€ &gt;&gt; /etc/modprobe.confchkconfig â€“level 35 ip6tables offecho â€œDisable ipv6.â€&gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ###########################################################################Set history commands è®¾ç½®å‘½ä»¤å†å²è®°å½•å‚æ•°echo â€œSet history commands.â€echo â€œHISTFILESIZE=4000â€ &gt;&gt; /etc/bashrcecho â€œHISTSIZE=4000â€ &gt;&gt; /etc/bashrcecho â€œHISTTIMEFORMAT=â€™%F/%Tâ€™â€ &gt;&gt; /etc/bashrcsource /etc/bashrcecho â€œ==================================â€ &gt;&gt; $LOGformat ########################################################################### Epel å‡çº§epelæºecho â€œInstall epelâ€rpm -Uvh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm &amp;&gt; /dev/nullsed -i â€œs/^#base/base/gâ€ /etc/yum.repos.d/epel.reposed -i â€œs/^mirr/#mirr/gâ€ /etc/yum.repos.d/epel.repoecho â€œ==================================================â€echo â€œInstall epelâ€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ###########################################################################Yum install Development tools å®‰è£…å¼€å‘åŒ…ç»„åŠå¿…å¤‡è½¯ä»¶echo â€œInstall Development tools(It will be a moment,waitâ€¦â€¦)â€yum groupinstall -y â€œDevelopment toolsâ€ &amp;&gt; /dev/nullyum groupinstall -y â€œServer Platform Developmentâ€ &amp;&gt; /dev/nullyum groupinstall -y â€œDesktop Platform Developmentâ€ &amp;&gt; /dev/nullyum groupinstall -y â€œchinese-supportâ€ &amp;&gt;/dev/nullfor I in bind-utils lrzsz wget gcc gcc-c++ vim htop ;do yum install -y $Idoneecho â€œ==================================================â€echo â€œInstall Development toolsâ€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ########################################################################### Yum update bash and openssl å‡çº§bash/opensslecho â€œUpdate bash and opensslâ€yum -y update bash &amp;&gt; /dev/nullyum -y update openssl &amp;&gt; /dev/nullecho â€œ==================================================â€echo â€œUpdate bash and opensslâ€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Set ssh è®¾ç½®sshç™»å½•ç­–ç•¥echo â€œDisabled EmptyPassword.â€echo â€œDisabled SSH-DNS.â€echo â€œSet timeout is 6m.â€sed -i â€œs/^#PermitEmptyPasswords/PermitEmptyPasswords/â€œ /etc/ssh/sshd_configsed -i â€œs/^#LoginGraceTime 2m/LoginGraceTime 6m/â€œ /etc/ssh/sshd_configecho â€œUseDNS noâ€ &gt;&gt; /etc/ssh/sshd_configecho â€œ==================================================â€echo â€œDisabled EmptyPassword.â€ &gt;&gt; $LOGecho â€œDisabled SSH-DNS.â€ &gt;&gt; $LOGecho â€œSet timeout is 6m.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Set default init 3 è®¾ç½®ç³»ç»Ÿé»˜è®¤åˆå§‹åŒ–echo â€œDefault init 3.â€sed -i â€˜s/^id:5:initdefault:/id:3:initdefault:/â€˜ /etc/inittabecho â€œ==================================================â€echo â€œDefault init 3.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Stop Service å…³é—­ä¸å¿…è¦çš„æœåŠ¡echo â€œSome services are turned off now.â€for SER in rpcbind postfix portreserve certmonger mdmonitor blk-availability lvm2-monitor udev-post cups dhcpd firstboot gpm haldaemon hidd ip6tables ipsec isdn kudzu lpd mcstrans messagebus microcode_ctl netfs nfs nfslock nscd acpid anacron apmd atd auditd autofs avahi-daemon avahi-dnsconfd bluetooth cpuspeed pcscd portmap readahead_early restorecond rpcgssd rpcidmapd rstatd sendmail setroubleshoot snmpd sysstat xfs xinetd yppasswdd ypserv yum-updatesd do /sbin/chkconfig â€“list $SER &amp;&gt; /dev/null if [ $? -eq 0 ] then chkconfig â€“level 35 $SER off echo â€œ$SERâ€ &gt;&gt; $LOG fi doneecho â€œ==================================================â€echo â€œSome services are turned off now:â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Del unnecessary users åˆ é™¤ä¸å¿…è¦çš„ç”¨æˆ·echo â€œDel unnecessary users.â€for USERS in adm lp sync shutdown halt mail news uucp operator games gopher do grep $USERS /etc/passwd &amp;&gt;/dev/null if [ $? -eq 0 ] then userdel $USERS &amp;&gt; /dev/null echo $USERS &gt;&gt; $LOG fi doneecho â€œ==================================================â€echo â€œDel unnecessary users.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Del unnecessary groups åˆ é™¤ä¸å¿…è¦çš„ç”¨æˆ·ç»„echo â€œDel unnecessary groups.â€for GRP in adm lp mail news uucp games gopher mailnull floppy dip pppusers popusers slipusers daemon do grep $GRP /etc/group &amp;&gt; /dev/null if [ $? -eq 0 ] then groupdel $GRP &amp;&gt; /dev/null echo $GRP &gt;&gt; $LOG fi doneecho â€œ==================================================â€echo â€œDel unnecessary groups.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Disabled reboot by keys ctlaltdelete ç¦ç”¨ctlaltdeleteé‡å¯åŠŸèƒ½echo â€œDisabled reboot by keys ctlaltdeleteâ€sed -i â€˜s/^exec/#exec/â€˜ /etc/init/control-alt-delete.confecho â€œ==================================================â€echo â€œDisabled reboot by keys ctlaltdeleteâ€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Set ulimit è®¾ç½®æ–‡ä»¶å¥æŸ„æ•°echo â€œSet ulimit 1000000â€echo â€œ* soft nofile 1000000â€ &gt;&gt; /etc/security/limits.confecho â€œ* hard nofile 1000000â€ &gt;&gt; /etc/security/limits.confecho â€œ* soft nproc 102400â€ &gt;&gt; /etc/security/limits.confecho â€œ* hard nproc 102400â€ &gt;&gt; /etc/security/limits.confsed -i â€˜s/102400/1000000/â€˜ /etc/security/limits.d/90-nproc.confecho â€œ==================================================â€echo â€œSet ulimit 1000000â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Set login message è®¾ç½®ç™»å½•æ—¶æ˜¾ç¤ºçš„ä¿¡æ¯echo â€œSet login message.â€echo â€œThis is not a public Serverâ€ &gt; /etc/issueecho â€œThis is not a public Serverâ€ &gt; /etc/redhat-releaseecho â€œ==================================================â€echo â€œSet login message.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Record SUID and SGID filesDATE2=`date +â€%Fâ€`echo â€œRecord SUID and SGID files.â€echo â€œSUID â€” â€œ &gt; /var/log/SuSg_â€$DATE2â€.logfind / -path â€˜/procâ€™ -prune -o -perm -4000 &gt;&gt; /var/log/SuSg_â€$DATE2â€.logecho â€œâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” â€œ &gt;&gt; /var/log/SuSg_â€$DATE2â€.logecho â€œSGID â€” â€œ &gt;&gt; /var/log/SuSg_â€$DATE2â€.logfind / -path â€˜/procâ€™ -prune -o -perm -2000 &gt;&gt; /var/log/SuSg_â€$DATE2â€.logecho â€œ==================================================â€echo â€œRecord SUID and SGID.â€ &gt;&gt; $LOGecho â€œRecord is in /var/log/SuSg_â€$DATE2â€.logâ€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Disabled crontab send mail ç¦ç”¨æ‰§è¡Œä»»åŠ¡è®¡åˆ’æ—¶å‘rootå‘é€é‚®ä»¶echo â€œDisable crontab send mail.â€sed -i â€˜s/^MAILTO=root/MAILTO=â€â€/â€˜ /etc/crontabsed -i â€˜s/^mail\\.\\*/mail\\.err/â€˜ /etc/rsyslog.confecho â€œ==================================================â€echo â€œDisable crontab send mail.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Set ntp client è®¾ç½®æ—¶é—´æœåŠ¡å®¢æˆ·ç«¯echo â€œSet ntp client.â€SED() { cp -p /etc/ntp.conf /etc/ntp.conf.bak sed -i â€˜/^server/dâ€™ /etc/ntp.conf sed -i â€˜/^includefile/ i\\server 0.centos.pool.ntp.org iburstâ€™ /etc/ntp.conf sed -i â€˜/0.centos.pool.ntp.org/ a\\server 1.centos.pool.ntp.org iburstâ€™ /etc/ntp.conf sed -i â€˜/1.centos.pool.ntp.org/ a\\server 2.centos.pool.ntp.org iburstâ€™ /etc/ntp.conf sed -i â€˜/2.centos.pool.ntp.org/ a\\server 3.centos.pool.ntp.org iburstâ€™ /etc/ntp.conf chkconfig â€“level 35 ntpd on &amp;&gt; /dev/null echo â€œ==================================================â€}rpm -q ntp &amp;&gt; /dev/nullif [ $? -eq 0 ] then SED else yum -y install ntp &amp;&gt; /dev/null SEDfiecho â€œSet ntp client.â€ &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat ############################################################################ Set sysctl.conf è®¾ç½®å†…æ ¸å‚æ•°echo â€œSet sysctl.confâ€#webåº”ç”¨ä¸­listenå‡½æ•°çš„backlogé»˜è®¤ä¼šå°†å†…æ ¸å‚æ•°çš„net.core.somaxconné™åˆ¶åˆ°128ï¼Œè€Œnginxå®šä¹‰çš„NGX_LISTEN_BACKLOGé»˜è®¤æ˜¯511ï¼Œæ‰€ä»¥å¿…é¡»è°ƒæ•´,ä¸€èˆ¬è°ƒæ•´ä¸º2048echo â€œnet.core.somaxconn = 2048â€ &gt;&gt; /etc/sysctl.conf echo â€œnet.core.rmem_default = 262144â€ &gt;&gt; /etc/sysctl.confecho â€œnet.core.wmem_default = 262144â€ &gt;&gt; /etc/sysctl.confecho â€œnet.core.rmem_max = 16777216â€ &gt;&gt; /etc/sysctl.confecho â€œnet.core.wmem_max = 16777216â€ &gt;&gt; /etc/sysctl.confecho â€œnet.ipv4.tcp_rmem = 4096 4096 16777216â€ &gt;&gt; /etc/sysctl.confecho â€œnet.ipv4.tcp_wmem = 4096 4096 16777216â€ &gt;&gt; /etc/sysctl.confecho â€œnet.ipv4.tcp_mem = 786432 2097152 3145728â€ &gt;&gt; /etc/sysctl.confecho â€œnet.ipv4.tcp_max_syn_backlog = 16384â€ &gt;&gt; /etc/sysctl.confecho â€œnet.core.netdev_max_backlog = 20000â€ &gt;&gt; /etc/sysctl.confecho â€œnet.ipv4.tcp_fin_timeout = 15â€ &gt;&gt; /etc/sysctl.confecho â€œnet.ipv4.tcp_tw_reuse = 1â€ &gt;&gt; /etc/sysctl.confecho â€œnet.ipv4.tcp_tw_recycle = 1â€ &gt;&gt; /etc/sysctl.confecho â€œnet.ipv4.tcp_max_orphans = 131072â€ &gt;&gt; /etc/sysctl.confecho â€œnet.ipv4.ip_local_port_range = 1024 65535â€ &gt;&gt; /etc/sysctl.confecho â€œSet sysctl.conf â€”- â€œ &gt;&gt; $LOG/sbin/sysctl -p &gt;&gt; $LOGecho â€œ==================================â€ &gt;&gt; $LOGformat############################################################################ Doneecho â€œFinished,You can check infomations in $LOG .â€#echo â€œSystem will reboot in 60s.â€#shutdown -r 1 å¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹ï¼Œå„ä½å¤§å©¶å¯ä»¥æå‡ºæ¥ï¼Œå¤§å®¶ä¸€èµ·è¿›æ­¥å“ˆï¼›è°¢è°¢æ‚¨çš„æ„è§ã€‚ Download Script: initsystem.sh","categories":[{"name":"Shell","slug":"Shell","permalink":"https://blog.sctux.cc/categories/Shell/"}],"tags":[],"keywords":[{"name":"Shell","slug":"Shell","permalink":"https://blog.sctux.cc/categories/Shell/"}]},{"title":"é€šè¿‡ Ulimit æ”¹å–„ç³»ç»Ÿæ€§èƒ½","slug":"e9-80-9a-e8-bf-87-ulimit-e6-94-b9-e5-96-84-e7-b3-bb-e7-bb-9f-e6-80-a7-e8-83-bd","date":"2015-04-23T12:29:29.000Z","updated":"2025-09-01T01:59:08.872Z","comments":true,"path":"2015/04/23/e9-80-9a-e8-bf-87-ulimit-e6-94-b9-e5-96-84-e7-b3-bb-e7-bb-9f-e6-80-a7-e8-83-bd/","permalink":"https://blog.sctux.cc/2015/04/23/e9-80-9a-e8-bf-87-ulimit-e6-94-b9-e5-96-84-e7-b3-bb-e7-bb-9f-e6-80-a7-e8-83-bd/","excerpt":"æ¦‚è¿° ç³»ç»Ÿæ€§èƒ½ä¸€ç›´æ˜¯ä¸€ä¸ªå—å…³æ³¨çš„è¯é¢˜ï¼Œå¦‚ä½•é€šè¿‡æœ€ç®€å•çš„è®¾ç½®æ¥å®ç°æœ€æœ‰æ•ˆçš„æ€§èƒ½è°ƒä¼˜ï¼Œå¦‚ä½•åœ¨æœ‰é™èµ„æºçš„æ¡ä»¶ä¸‹ä¿è¯ç¨‹åºçš„è¿ä½œï¼Œulimit æ˜¯æˆ‘ä»¬åœ¨å¤„ç†è¿™äº›é—®é¢˜æ—¶ï¼Œç»å¸¸ä½¿ç”¨çš„ä¸€ç§ç®€å•æ‰‹æ®µã€‚ulimit æ˜¯ä¸€ç§ linux ç³»ç»Ÿçš„å†…é”®åŠŸèƒ½ï¼Œå®ƒå…·æœ‰ä¸€å¥—å‚æ•°é›†ï¼Œç”¨äºä¸ºç”±å®ƒç”Ÿæˆçš„ shell è¿›ç¨‹åŠå…¶å­è¿›ç¨‹çš„èµ„æºä½¿ç”¨è®¾ç½®é™åˆ¶ã€‚æœ¬æ–‡å°†åœ¨åé¢çš„ç« èŠ‚ä¸­è¯¦ç»†è¯´æ˜ ulimit çš„åŠŸèƒ½ï¼Œä½¿ç”¨ä»¥åŠå®ƒçš„å½±å“ï¼Œå¹¶ä»¥å…·ä½“çš„ä¾‹å­æ¥è¯¦ç»†åœ°é˜è¿°å®ƒåœ¨é™åˆ¶èµ„æºä½¿ç”¨æ–¹é¢çš„å½±å“ã€‚ ulimit çš„åŠŸèƒ½å’Œç”¨æ³• ulimit åŠŸèƒ½ç®€è¿° å‡è®¾æœ‰è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå½“ä¸€å° Linux ä¸»æœºä¸ŠåŒæ—¶ç™»é™†äº† 10 ä¸ªäººï¼Œåœ¨ç³»ç»Ÿèµ„æºæ— é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œè¿™ 10 ä¸ªç”¨æˆ·åŒæ—¶æ‰“å¼€äº† 500 ä¸ªæ–‡æ¡£ï¼Œè€Œå‡è®¾æ¯ä¸ªæ–‡æ¡£çš„å¤§å°æœ‰ 10Mï¼Œè¿™æ—¶ç³»ç»Ÿçš„å†…å­˜èµ„æºå°±ä¼šå—åˆ°å·¨å¤§çš„æŒ‘æˆ˜ã€‚ è€Œå®é™…åº”ç”¨çš„ç¯å¢ƒè¦æ¯”è¿™ç§å‡è®¾å¤æ‚çš„å¤šï¼Œä¾‹å¦‚åœ¨ä¸€ä¸ªåµŒå…¥å¼å¼€å‘ç¯å¢ƒä¸­ï¼Œå„æ–¹é¢çš„èµ„æºéƒ½æ˜¯éå¸¸ç´§ç¼ºçš„ï¼Œå¯¹äºå¼€å¯æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ï¼Œåˆ†é…å †æ ˆçš„å¤§å°ï¼ŒCPU æ—¶é—´ï¼Œè™šæ‹Ÿå†…å­˜å¤§å°ï¼Œç­‰ç­‰ï¼Œéƒ½æœ‰éå¸¸ä¸¥æ ¼çš„è¦æ±‚ã€‚èµ„æºçš„åˆç†é™åˆ¶å’Œåˆ†é…ï¼Œä¸ä»…ä»…æ˜¯ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§çš„å¿…è¦æ¡ä»¶ï¼Œä¹Ÿä¸ç³»ç»Ÿä¸Šè½¯ä»¶è¿è¡Œçš„æ€§èƒ½æœ‰ç€å¯†ä¸å¯åˆ†çš„è”ç³»ã€‚è¿™æ—¶ï¼Œulimit å¯ä»¥èµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ï¼Œå®ƒæ˜¯ä¸€ç§ç®€å•å¹¶ä¸”æœ‰æ•ˆçš„å®ç°èµ„æºé™åˆ¶çš„æ–¹å¼ã€‚ ulimit ç”¨äºé™åˆ¶ shell å¯åŠ¨è¿›ç¨‹æ‰€å ç”¨çš„èµ„æºï¼Œæ”¯æŒä»¥ä¸‹å„ç§ç±»å‹çš„é™åˆ¶ï¼šæ‰€åˆ›å»ºçš„å†…æ ¸æ–‡ä»¶çš„å¤§å°ã€è¿›ç¨‹æ•°æ®å—çš„å¤§å°ã€Shell è¿›ç¨‹åˆ›å»ºæ–‡ä»¶çš„å¤§å°ã€å†…å­˜é”ä½çš„å¤§å°ã€å¸¸é©»å†…å­˜é›†çš„å¤§å°ã€æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€åˆ†é…å †æ ˆçš„æœ€å¤§å¤§å°ã€CPU æ—¶é—´ã€å•ä¸ªç”¨æˆ·çš„æœ€å¤§çº¿ç¨‹æ•°ã€Shell è¿›ç¨‹æ‰€èƒ½ä½¿ç”¨çš„æœ€å¤§è™šæ‹Ÿå†…å­˜ã€‚åŒæ—¶ï¼Œå®ƒæ”¯æŒç¡¬èµ„æºå’Œè½¯èµ„æºçš„é™åˆ¶ã€‚ ä½œä¸ºä¸´æ—¶é™åˆ¶ï¼Œulimit å¯ä»¥ä½œç”¨äºé€šè¿‡ä½¿ç”¨å…¶å‘½ä»¤ç™»å½•çš„ shell ä¼šè¯ï¼Œåœ¨ä¼šè¯ç»ˆæ­¢æ—¶ä¾¿ç»“æŸé™åˆ¶ï¼Œå¹¶ä¸å½±å“äºå…¶ä»– shell ä¼šè¯ã€‚è€Œå¯¹äºé•¿æœŸçš„å›ºå®šé™åˆ¶ï¼Œulimit å‘½ä»¤è¯­å¥åˆå¯ä»¥è¢«æ·»åŠ åˆ°ç”±ç™»å½• shell è¯»å–çš„æ–‡ä»¶ä¸­ï¼Œä½œç”¨äºç‰¹å®šçš„ shell ç”¨æˆ·ã€‚ åœ¨ä¸‹é¢çš„ç« èŠ‚ä¸­ï¼Œå°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ ulimit åšç›¸åº”çš„èµ„æºé™åˆ¶ã€‚ å¦‚ä½•ä½¿ç”¨ ulimit ulimit é€šè¿‡ä¸€äº›å‚æ•°é€‰é¡¹æ¥ç®¡ç†ä¸åŒç§ç±»çš„ç³»ç»Ÿèµ„æºã€‚åœ¨æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†è®²è§£è¿™äº›å‚æ•°çš„ä½¿ç”¨ã€‚ ulimit å‘½ä»¤çš„æ ¼å¼ä¸ºï¼šulimit [options] [limit] å…·ä½“çš„ options å«ä¹‰ä»¥åŠç®€å•ç¤ºä¾‹å¯ä»¥å‚è€ƒä»¥ä¸‹è¡¨æ ¼ã€‚ è¡¨ 1. ulimit å‚æ•°è¯´æ˜ é€‰é¡¹ [options] å«ä¹‰ ä¾‹å­ -H è®¾ç½®ç¡¬èµ„æºé™åˆ¶ï¼Œä¸€æ—¦è®¾ç½®ä¸èƒ½å¢åŠ ã€‚ ulimit â€“ Hs 64ï¼›é™åˆ¶ç¡¬èµ„æºï¼Œçº¿ç¨‹æ ˆå¤§å°ä¸º 64Kã€‚ -S è®¾ç½®è½¯èµ„æºé™åˆ¶ï¼Œè®¾ç½®åå¯ä»¥å¢åŠ ï¼Œä½†æ˜¯ä¸èƒ½è¶…è¿‡ç¡¬èµ„æºè®¾ç½®ã€‚","text":"æ¦‚è¿° ç³»ç»Ÿæ€§èƒ½ä¸€ç›´æ˜¯ä¸€ä¸ªå—å…³æ³¨çš„è¯é¢˜ï¼Œå¦‚ä½•é€šè¿‡æœ€ç®€å•çš„è®¾ç½®æ¥å®ç°æœ€æœ‰æ•ˆçš„æ€§èƒ½è°ƒä¼˜ï¼Œå¦‚ä½•åœ¨æœ‰é™èµ„æºçš„æ¡ä»¶ä¸‹ä¿è¯ç¨‹åºçš„è¿ä½œï¼Œulimit æ˜¯æˆ‘ä»¬åœ¨å¤„ç†è¿™äº›é—®é¢˜æ—¶ï¼Œç»å¸¸ä½¿ç”¨çš„ä¸€ç§ç®€å•æ‰‹æ®µã€‚ulimit æ˜¯ä¸€ç§ linux ç³»ç»Ÿçš„å†…é”®åŠŸèƒ½ï¼Œå®ƒå…·æœ‰ä¸€å¥—å‚æ•°é›†ï¼Œç”¨äºä¸ºç”±å®ƒç”Ÿæˆçš„ shell è¿›ç¨‹åŠå…¶å­è¿›ç¨‹çš„èµ„æºä½¿ç”¨è®¾ç½®é™åˆ¶ã€‚æœ¬æ–‡å°†åœ¨åé¢çš„ç« èŠ‚ä¸­è¯¦ç»†è¯´æ˜ ulimit çš„åŠŸèƒ½ï¼Œä½¿ç”¨ä»¥åŠå®ƒçš„å½±å“ï¼Œå¹¶ä»¥å…·ä½“çš„ä¾‹å­æ¥è¯¦ç»†åœ°é˜è¿°å®ƒåœ¨é™åˆ¶èµ„æºä½¿ç”¨æ–¹é¢çš„å½±å“ã€‚ ulimit çš„åŠŸèƒ½å’Œç”¨æ³• ulimit åŠŸèƒ½ç®€è¿° å‡è®¾æœ‰è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå½“ä¸€å° Linux ä¸»æœºä¸ŠåŒæ—¶ç™»é™†äº† 10 ä¸ªäººï¼Œåœ¨ç³»ç»Ÿèµ„æºæ— é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œè¿™ 10 ä¸ªç”¨æˆ·åŒæ—¶æ‰“å¼€äº† 500 ä¸ªæ–‡æ¡£ï¼Œè€Œå‡è®¾æ¯ä¸ªæ–‡æ¡£çš„å¤§å°æœ‰ 10Mï¼Œè¿™æ—¶ç³»ç»Ÿçš„å†…å­˜èµ„æºå°±ä¼šå—åˆ°å·¨å¤§çš„æŒ‘æˆ˜ã€‚ è€Œå®é™…åº”ç”¨çš„ç¯å¢ƒè¦æ¯”è¿™ç§å‡è®¾å¤æ‚çš„å¤šï¼Œä¾‹å¦‚åœ¨ä¸€ä¸ªåµŒå…¥å¼å¼€å‘ç¯å¢ƒä¸­ï¼Œå„æ–¹é¢çš„èµ„æºéƒ½æ˜¯éå¸¸ç´§ç¼ºçš„ï¼Œå¯¹äºå¼€å¯æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ï¼Œåˆ†é…å †æ ˆçš„å¤§å°ï¼ŒCPU æ—¶é—´ï¼Œè™šæ‹Ÿå†…å­˜å¤§å°ï¼Œç­‰ç­‰ï¼Œéƒ½æœ‰éå¸¸ä¸¥æ ¼çš„è¦æ±‚ã€‚èµ„æºçš„åˆç†é™åˆ¶å’Œåˆ†é…ï¼Œä¸ä»…ä»…æ˜¯ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§çš„å¿…è¦æ¡ä»¶ï¼Œä¹Ÿä¸ç³»ç»Ÿä¸Šè½¯ä»¶è¿è¡Œçš„æ€§èƒ½æœ‰ç€å¯†ä¸å¯åˆ†çš„è”ç³»ã€‚è¿™æ—¶ï¼Œulimit å¯ä»¥èµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ï¼Œå®ƒæ˜¯ä¸€ç§ç®€å•å¹¶ä¸”æœ‰æ•ˆçš„å®ç°èµ„æºé™åˆ¶çš„æ–¹å¼ã€‚ ulimit ç”¨äºé™åˆ¶ shell å¯åŠ¨è¿›ç¨‹æ‰€å ç”¨çš„èµ„æºï¼Œæ”¯æŒä»¥ä¸‹å„ç§ç±»å‹çš„é™åˆ¶ï¼šæ‰€åˆ›å»ºçš„å†…æ ¸æ–‡ä»¶çš„å¤§å°ã€è¿›ç¨‹æ•°æ®å—çš„å¤§å°ã€Shell è¿›ç¨‹åˆ›å»ºæ–‡ä»¶çš„å¤§å°ã€å†…å­˜é”ä½çš„å¤§å°ã€å¸¸é©»å†…å­˜é›†çš„å¤§å°ã€æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€åˆ†é…å †æ ˆçš„æœ€å¤§å¤§å°ã€CPU æ—¶é—´ã€å•ä¸ªç”¨æˆ·çš„æœ€å¤§çº¿ç¨‹æ•°ã€Shell è¿›ç¨‹æ‰€èƒ½ä½¿ç”¨çš„æœ€å¤§è™šæ‹Ÿå†…å­˜ã€‚åŒæ—¶ï¼Œå®ƒæ”¯æŒç¡¬èµ„æºå’Œè½¯èµ„æºçš„é™åˆ¶ã€‚ ä½œä¸ºä¸´æ—¶é™åˆ¶ï¼Œulimit å¯ä»¥ä½œç”¨äºé€šè¿‡ä½¿ç”¨å…¶å‘½ä»¤ç™»å½•çš„ shell ä¼šè¯ï¼Œåœ¨ä¼šè¯ç»ˆæ­¢æ—¶ä¾¿ç»“æŸé™åˆ¶ï¼Œå¹¶ä¸å½±å“äºå…¶ä»– shell ä¼šè¯ã€‚è€Œå¯¹äºé•¿æœŸçš„å›ºå®šé™åˆ¶ï¼Œulimit å‘½ä»¤è¯­å¥åˆå¯ä»¥è¢«æ·»åŠ åˆ°ç”±ç™»å½• shell è¯»å–çš„æ–‡ä»¶ä¸­ï¼Œä½œç”¨äºç‰¹å®šçš„ shell ç”¨æˆ·ã€‚ åœ¨ä¸‹é¢çš„ç« èŠ‚ä¸­ï¼Œå°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ ulimit åšç›¸åº”çš„èµ„æºé™åˆ¶ã€‚ å¦‚ä½•ä½¿ç”¨ ulimit ulimit é€šè¿‡ä¸€äº›å‚æ•°é€‰é¡¹æ¥ç®¡ç†ä¸åŒç§ç±»çš„ç³»ç»Ÿèµ„æºã€‚åœ¨æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†è®²è§£è¿™äº›å‚æ•°çš„ä½¿ç”¨ã€‚ ulimit å‘½ä»¤çš„æ ¼å¼ä¸ºï¼šulimit [options] [limit] å…·ä½“çš„ options å«ä¹‰ä»¥åŠç®€å•ç¤ºä¾‹å¯ä»¥å‚è€ƒä»¥ä¸‹è¡¨æ ¼ã€‚ è¡¨ 1. ulimit å‚æ•°è¯´æ˜ é€‰é¡¹ [options] å«ä¹‰ ä¾‹å­ -H è®¾ç½®ç¡¬èµ„æºé™åˆ¶ï¼Œä¸€æ—¦è®¾ç½®ä¸èƒ½å¢åŠ ã€‚ ulimit â€“ Hs 64ï¼›é™åˆ¶ç¡¬èµ„æºï¼Œçº¿ç¨‹æ ˆå¤§å°ä¸º 64Kã€‚ -S è®¾ç½®è½¯èµ„æºé™åˆ¶ï¼Œè®¾ç½®åå¯ä»¥å¢åŠ ï¼Œä½†æ˜¯ä¸èƒ½è¶…è¿‡ç¡¬èµ„æºè®¾ç½®ã€‚ ulimit â€“ Sn 32ï¼›é™åˆ¶è½¯èµ„æºï¼Œ32 ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚ -a æ˜¾ç¤ºå½“å‰æ‰€æœ‰çš„ limit ä¿¡æ¯ã€‚ ulimit â€“ aï¼›æ˜¾ç¤ºå½“å‰æ‰€æœ‰çš„ limit ä¿¡æ¯ã€‚ -c æœ€å¤§çš„ core æ–‡ä»¶çš„å¤§å°ï¼Œ ä»¥ blocks ä¸ºå•ä½ã€‚ ulimit â€“ c unlimitedï¼› å¯¹ç”Ÿæˆçš„ core æ–‡ä»¶çš„å¤§å°ä¸è¿›è¡Œé™åˆ¶ã€‚ -d è¿›ç¨‹æœ€å¤§çš„æ•°æ®æ®µçš„å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚ ulimit -d unlimitedï¼›å¯¹è¿›ç¨‹çš„æ•°æ®æ®µå¤§å°ä¸è¿›è¡Œé™åˆ¶ã€‚ -f è¿›ç¨‹å¯ä»¥åˆ›å»ºæ–‡ä»¶çš„æœ€å¤§å€¼ï¼Œä»¥ blocks ä¸ºå•ä½ã€‚ ulimit â€“ f 2048ï¼›é™åˆ¶è¿›ç¨‹å¯ä»¥åˆ›å»ºçš„æœ€å¤§æ–‡ä»¶å¤§å°ä¸º 2048 blocksã€‚ -l æœ€å¤§å¯åŠ é”å†…å­˜å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚ ulimit â€“ l 32ï¼›é™åˆ¶æœ€å¤§å¯åŠ é”å†…å­˜å¤§å°ä¸º 32 Kbytesã€‚ -m æœ€å¤§å†…å­˜å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚ ulimit â€“ m unlimitedï¼›å¯¹æœ€å¤§å†…å­˜ä¸è¿›è¡Œé™åˆ¶ã€‚ -n å¯ä»¥æ‰“å¼€æœ€å¤§æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚ ulimit â€“ n 128ï¼›é™åˆ¶æœ€å¤§å¯ä»¥ä½¿ç”¨ 128 ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚ -p ç®¡é“ç¼“å†²åŒºçš„å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚ ulimit â€“ p 512ï¼›é™åˆ¶ç®¡é“ç¼“å†²åŒºçš„å¤§å°ä¸º 512 Kbytesã€‚ -s çº¿ç¨‹æ ˆå¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚ ulimit â€“ s 512ï¼›é™åˆ¶çº¿ç¨‹æ ˆçš„å¤§å°ä¸º 512 Kbytesã€‚ -t æœ€å¤§çš„ CPU å ç”¨æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚ ulimit â€“ t unlimitedï¼›å¯¹æœ€å¤§çš„ CPU å ç”¨æ—¶é—´ä¸è¿›è¡Œé™åˆ¶ã€‚ -u ç”¨æˆ·æœ€å¤§å¯ç”¨çš„è¿›ç¨‹æ•°ã€‚ ulimit â€“ u 64ï¼›é™åˆ¶ç”¨æˆ·æœ€å¤šå¯ä»¥ä½¿ç”¨ 64 ä¸ªè¿›ç¨‹ã€‚ -v è¿›ç¨‹æœ€å¤§å¯ç”¨çš„è™šæ‹Ÿå†…å­˜ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚ ulimit â€“ v 200000ï¼›é™åˆ¶æœ€å¤§å¯ç”¨çš„è™šæ‹Ÿå†…å­˜ä¸º 200000 Kbytesã€‚ æ–°è£…çš„linuxé»˜è®¤åªæœ‰1024ï¼Œå½“ä½œè´Ÿè½½è¾ƒå¤§çš„æœåŠ¡å™¨æ—¶ï¼Œå¾ˆå®¹æ˜“é‡åˆ°error: too many open filesã€‚å› æ­¤ï¼Œéœ€è¦å°†å…¶æ”¹å¤§ã€‚ ä½¿ç”¨ ulimit -n 65535 å¯å³æ—¶ä¿®æ”¹ï¼Œä½†é‡å¯åå°±æ— æ•ˆäº†ã€‚ï¼ˆæ³¨ulimit -SHn 65535 ç­‰æ•ˆ ulimit -n 65535ï¼Œ-SæŒ‡softï¼Œ-HæŒ‡hard) æœ‰å¦‚ä¸‹ä¸‰ç§ä¿®æ”¹æ–¹å¼ï¼š 1.åœ¨/etc/rc.local ä¸­å¢åŠ ä¸€è¡Œ ulimit -SHn 65535 2.åœ¨/etc/profile ä¸­å¢åŠ ä¸€è¡Œ ulimit -SHn 65535 3.åœ¨/etc/security/limits.confæœ€åå¢åŠ å¦‚ä¸‹ä¸¤è¡Œè®°å½• * soft nofile 65535 * hard nofile 65535","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"ulimit","slug":"ulimit","permalink":"https://blog.sctux.cc/tags/ulimit/"}],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}]},{"title":"æ•°æ®åº“é“¾æ¥è¶…æ—¶ï¼Œå¯èƒ½åŸå› ç”±äºç©ºé—´ä¸è¶³é€ æˆ","slug":"e6-95-b0-e6-8d-ae-e5-ba-93-e9-93-be-e6-8e-a5-e8-b6-85-e6-97-b6-ef-bc-8c-e5-8f-af-e8-83-bd-e5-8e-9f-e5-9b-a0-e7-94-b1-e4-ba-8e-e7-a9-ba-e9-97-b4-e4-b8-8d-e8-b6-b3-e9-80-a0-e6-88-90","date":"2015-04-15T11:41:42.000Z","updated":"2025-09-01T01:59:08.871Z","comments":true,"path":"2015/04/15/e6-95-b0-e6-8d-ae-e5-ba-93-e9-93-be-e6-8e-a5-e8-b6-85-e6-97-b6-ef-bc-8c-e5-8f-af-e8-83-bd-e5-8e-9f-e5-9b-a0-e7-94-b1-e4-ba-8e-e7-a9-ba-e9-97-b4-e4-b8-8d-e8-b6-b3-e9-80-a0-e6-88-90/","permalink":"https://blog.sctux.cc/2015/04/15/e6-95-b0-e6-8d-ae-e5-ba-93-e9-93-be-e6-8e-a5-e8-b6-85-e6-97-b6-ef-bc-8c-e5-8f-af-e8-83-bd-e5-8e-9f-e5-9b-a0-e7-94-b1-e4-ba-8e-e7-a9-ba-e9-97-b4-e4-b8-8d-e8-b6-b3-e9-80-a0-e6-88-90/","excerpt":"ä»Šå¤©å¼€å‘äººå‘˜å‘ŠçŸ¥ï¼Œæµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“é“¾æ¥è¶…æ—¶ æˆ‘ç™»å½•æµ‹è¯•æœåŠ¡å™¨1ã€æ£€æŸ¥mysqlè¿è¡ŒçŠ¶æ€ï¼Œç»“æœï¼šæ­£å¸¸ é€šè¿‡æ‰§è¡Œss -tunl | grep â€œ3306â€ ä»¥åŠ ps aux | grep â€œmysqldâ€ æ¥åˆ¤å®š2ã€æ£€æŸ¥mysqlæ—¥å¿—ï¼Œç»“æœï¼šæ­£å¸¸ é€šè¿‡æŸ¥çœ‹mysqlçš„é”™è¯¯æ—¥å¿—3ã€ç”±äºç³»ç»Ÿç”¨çš„æ˜¯CentOS7 äºæ˜¯ä¹é€šè¿‡å¦å¤–ä¸€ç§æ–¹å¼æŸ¥çœ‹mysqlçš„çŠ¶æ€systemctl status mysqldå¯ä»¥çœ‹å‡ºæ¥ï¼Œè™½ç„¶è¿æ¥æ•°æ®åº“æ—¶å‡ºç°äº†ç‚¹é—®é¢˜ï¼Œä½†æ˜¯mysql å¹¶æœªåœæ­¢è¿è¡Œã€‚ è§£å†³åŠæ³•ï¼šæ¸…ç†ç£ç›˜ç©ºé—´ï¼Œä¸ºmysqlæ•°æ® æ‰€åœ¨åˆ†åŒºè…¾å‡ºç©ºé—´ã€‚","text":"ä»Šå¤©å¼€å‘äººå‘˜å‘ŠçŸ¥ï¼Œæµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“é“¾æ¥è¶…æ—¶ æˆ‘ç™»å½•æµ‹è¯•æœåŠ¡å™¨1ã€æ£€æŸ¥mysqlè¿è¡ŒçŠ¶æ€ï¼Œç»“æœï¼šæ­£å¸¸ é€šè¿‡æ‰§è¡Œss -tunl | grep â€œ3306â€ ä»¥åŠ ps aux | grep â€œmysqldâ€ æ¥åˆ¤å®š2ã€æ£€æŸ¥mysqlæ—¥å¿—ï¼Œç»“æœï¼šæ­£å¸¸ é€šè¿‡æŸ¥çœ‹mysqlçš„é”™è¯¯æ—¥å¿—3ã€ç”±äºç³»ç»Ÿç”¨çš„æ˜¯CentOS7 äºæ˜¯ä¹é€šè¿‡å¦å¤–ä¸€ç§æ–¹å¼æŸ¥çœ‹mysqlçš„çŠ¶æ€systemctl status mysqldå¯ä»¥çœ‹å‡ºæ¥ï¼Œè™½ç„¶è¿æ¥æ•°æ®åº“æ—¶å‡ºç°äº†ç‚¹é—®é¢˜ï¼Œä½†æ˜¯mysql å¹¶æœªåœæ­¢è¿è¡Œã€‚ è§£å†³åŠæ³•ï¼šæ¸…ç†ç£ç›˜ç©ºé—´ï¼Œä¸ºmysqlæ•°æ® æ‰€åœ¨åˆ†åŒºè…¾å‡ºç©ºé—´ã€‚","categories":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}],"tags":[{"name":"mysql","slug":"mysql","permalink":"https://blog.sctux.cc/tags/mysql/"},{"name":"nospace","slug":"nospace","permalink":"https://blog.sctux.cc/tags/nospace/"}],"keywords":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}]},{"title":"Vsftp-è™šæ‹Ÿç”¨æˆ·è®¾ç½®ä¸åŒæƒé™","slug":"vsftp-xu-ni-yong-hu-she-zhi-bu-tong-quan-xian","date":"2015-04-01T22:38:50.000Z","updated":"2025-09-01T01:59:08.872Z","comments":true,"path":"2015/04/02/vsftp-xu-ni-yong-hu-she-zhi-bu-tong-quan-xian/","permalink":"https://blog.sctux.cc/2015/04/02/vsftp-xu-ni-yong-hu-she-zhi-bu-tong-quan-xian/","excerpt":"1.system versionCentOS Linux release 7.2.1511 (Core) 2.install vsftpdyum install -y vsftpd 3.create rootdirmkdir /data/program/ftpdata &amp;&amp; chmod a-w /data/program/ftpdata/ 4.create local user(for map to virtualuser)useradd -s /sbin/nologin -d /data/program/ftpdata ftpuser 5.install db(for auth)yum install -y db*","text":"1.system versionCentOS Linux release 7.2.1511 (Core) 2.install vsftpdyum install -y vsftpd 3.create rootdirmkdir /data/program/ftpdata &amp;&amp; chmod a-w /data/program/ftpdata/ 4.create local user(for map to virtualuser)useradd -s /sbin/nologin -d /data/program/ftpdata ftpuser 5.install db(for auth)yum install -y db* 6.create virtual userscd /etc/vsftpd/ vim virtualuser.txt user1 # this username 1234qwer # this password user2 # this username 123.com # this password 7.create dbdb_load -T -t hash -f virtualuser.txt /etc/vsftpd/virtualuser.db 8.create pam auth filevim /etc/pam.d/vsftpd.vu auth required /lib64/security/pam_userdb.so db=/etc/vsftpd/virtualuser account required /lib64/security/pam_userdb.so db=/etc/vsftpd/virtualuser # if your system is centos6.x release so use this configure: auth sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/virtualuser account sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/virtualuser 9.configure vsftpd.confvim /etc/vsftpd.conf anonymous_enable=NO #allow_writeable_chroot # if your vsftpd version is 3.x local_enable=YES write_enable=YES local_umask=022 dirmessage_enable=YES xferlog_enable=YES connect_from_port_20=YES xferlog_std_format=YES chroot_local_user=YES chroot_list_enable=YES chroot_list_file=/etc/vsftpd/chroot_list listen=NO listen_ipv6=YES pam_service_name=ftpuser userlist_enable=YES tcp_wrappers=YES guest_enable=YES guest_username=ftp01 pam_service_name=vsftpd.vu user_config_dir=/etc/vsftpd/user_conf 10.create each user config dircd /etc/vsftpd/ &amp;&amp; mkdir user_conf &amp;&amp; cd user_conf # for user1 config # this user can uploadã€wirteã€download vim user1 anon_world_readable_only=NO anon_upload_enable=YES anon_mkdir_write_enable=YES anon_other_write_enable=YES /data/program/ftpdata/user1_home/ # virtual user's datadir # for user2 config # this user only can readã€download, can't upload vim user2 anon_world_readable_only=NO anon_upload_enable=NO anon_mkdir_write_enable=NO anon_other_write_enable=NO /data/program/ftpdata/user2_home # virtual user's datadir","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"ftp","slug":"ftp","permalink":"https://blog.sctux.cc/tags/ftp/"}],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}]},{"title":"Vim Nginxé…ç½®æ–‡ä»¶è¯­æ³•é«˜äº®","slug":"vim-nginx-e9-85-8d-e7-bd-ae-e6-96-87-e4-bb-b6-e8-af-ad-e6-b3-95-e9-ab-98-e4-ba-ae","date":"2015-03-09T06:49:06.000Z","updated":"2025-09-01T01:59:08.936Z","comments":true,"path":"2015/03/09/vim-nginx-e9-85-8d-e7-bd-ae-e6-96-87-e4-bb-b6-e8-af-ad-e6-b3-95-e9-ab-98-e4-ba-ae/","permalink":"https://blog.sctux.cc/2015/03/09/vim-nginx-e9-85-8d-e7-bd-ae-e6-96-87-e4-bb-b6-e8-af-ad-e6-b3-95-e9-ab-98-e4-ba-ae/","excerpt":"æˆ‘ä»¬åœ¨ç¼–è¾‘é…ç½®nginxçš„é…ç½®æ–‡ä»¶æ—¶ï¼Œç”±äºä»–æ²¡æœ‰é«˜äº®çš„åŠŸèƒ½ï¼Œä½†æ˜¯nginxå®˜æ–¹æ˜¯æ”¯æŒè¿™ä¸ªåŠŸèƒ½çš„ï¼›è¦æƒ³åœ¨ç¼–è¾‘é…ç½®nginxé…ç½®æ–‡ä»¶çš„æ—¶å€™é«˜äº®è¯­æ³•ä»¥é™ä½é…ç½®çš„é”™è¯¯å‘ç”Ÿç‡å¯ç§»æ‰§è¡Œè¿™ä¸ªå°è„šæœ¬è€Œåˆ°è¾¾ç›®çš„ï¼š #!/bin/bashmkdir -p ~/.vim/syntax &amp;&amp; cd ~/.vim/syntaxwget http://www.vim.org/scripts/download\\_script.php?src\\_id=14376 -O nginx.vim &gt;/dev/nullecho â€œau BufRead,BufNewFile /usr/local/webserver/nginx/conf/* set ft=nginxâ€ &gt; ~/.vim/filetype.vim#å…¶ä¸­è·¯å¾„/usr/local/webserver/nginx/conf/*ä¸ºä½ çš„nginx.confæ–‡ä»¶è·¯å¾„","text":"æˆ‘ä»¬åœ¨ç¼–è¾‘é…ç½®nginxçš„é…ç½®æ–‡ä»¶æ—¶ï¼Œç”±äºä»–æ²¡æœ‰é«˜äº®çš„åŠŸèƒ½ï¼Œä½†æ˜¯nginxå®˜æ–¹æ˜¯æ”¯æŒè¿™ä¸ªåŠŸèƒ½çš„ï¼›è¦æƒ³åœ¨ç¼–è¾‘é…ç½®nginxé…ç½®æ–‡ä»¶çš„æ—¶å€™é«˜äº®è¯­æ³•ä»¥é™ä½é…ç½®çš„é”™è¯¯å‘ç”Ÿç‡å¯ç§»æ‰§è¡Œè¿™ä¸ªå°è„šæœ¬è€Œåˆ°è¾¾ç›®çš„ï¼š #!/bin/bashmkdir -p ~/.vim/syntax &amp;&amp; cd ~/.vim/syntaxwget http://www.vim.org/scripts/download\\_script.php?src\\_id=14376 -O nginx.vim &gt;/dev/nullecho â€œau BufRead,BufNewFile /usr/local/webserver/nginx/conf/* set ft=nginxâ€ &gt; ~/.vim/filetype.vim#å…¶ä¸­è·¯å¾„/usr/local/webserver/nginx/conf/*ä¸ºä½ çš„nginx.confæ–‡ä»¶è·¯å¾„","categories":[{"name":"Shell","slug":"Shell","permalink":"https://blog.sctux.cc/categories/Shell/"}],"tags":[],"keywords":[{"name":"Shell","slug":"Shell","permalink":"https://blog.sctux.cc/categories/Shell/"}]},{"title":"Zabbix æ¸…ç†è¿‡ä¹…çš„å†å²ä¿¡æ¯","slug":"zabbix-e6-b8-85-e7-90-86-e8-bf-87-e4-b9-85-e7-9a-84-e5-8e-86-e5-8f-b2-e4-bf-a1-e6-81-af","date":"2014-11-04T08:17:57.000Z","updated":"2025-09-01T01:59:08.954Z","comments":true,"path":"2014/11/04/zabbix-e6-b8-85-e7-90-86-e8-bf-87-e4-b9-85-e7-9a-84-e5-8e-86-e5-8f-b2-e4-bf-a1-e6-81-af/","permalink":"https://blog.sctux.cc/2014/11/04/zabbix-e6-b8-85-e7-90-86-e8-bf-87-e4-b9-85-e7-9a-84-e5-8e-86-e5-8f-b2-e4-bf-a1-e6-81-af/","excerpt":"å½“æˆ‘ä»¬çš„zabbixè¿è¡Œæ—¶é—´ä¹…äº†ï¼Œç›‘æ§çš„èŠ‚ç‚¹å¤šäº†ï¼Œæ•°æ®ä¿¡æ¯ä¼šå¢é•¿çš„å¾ˆå¿«ï¼Œæƒ³å¤‡ä»½é‡Œé¢çš„æ•°æ®åº“æ—¶ï¼Œè¦æµªè´¹å¤§é‡çš„æ—¶é—´ï¼Œzabbixé‡Œé¢æœ€å¤§çš„è¡¨å°±æ˜¯å†å²è®°å½•çš„è¡¨äº†ï¼Œç½‘ä¸Šå¾ˆå¤šäººéƒ½æ˜¯å†™å…¨éƒ¨æ¸…ç©ºè¿™äº›è¡¨çš„æ•°æ®ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥æŒ‰æ—¶é—´æ¥åˆ é™¤é‡Œé¢çš„å†å²è®°å½•ï¼› é‡Œé¢æœ€å¤§çš„è¡¨æ˜¯ â€œhistoryâ€ å’Œ â€œhistory_uintâ€ä¸¤ä¸ªè¡¨ï¼› zabbixé‡Œé¢çš„æ—¶é—´æ˜¯ç”¨çš„æ—¶é—´æˆ³æ–¹å¼è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥è½¬æ¢ä¸€ä¸‹ï¼Œç„¶åæ ¹æ®æ—¶é—´æˆ³æ¥åˆ é™¤ï¼› æ¯”å¦‚è¦åˆ é™¤2012å¹´çš„11æœˆ25å·ä»¥å‰çš„æ•°æ® 1ã€å…ˆå°†æ ‡å‡†æ—¶é—´è½¬æ¢ä¸ºæ—¶é—´æˆ³ # date +%s -d â€œ2012-11-25 00:00:00â€1353772800 2ã€mysqlæ¸…ç†æ•°æ® mysql&gt; use zabbix;mysql&gt; DELETE FROM `history_uint` WHERE `clock` &lt; 1327939201;mysql&gt; optimize table history_uint; æ³¨ï¼šæ‰§è¡Œè¿‡ç¬¬äºŒè¡Œå‘½ä»¤ä¹‹åå¯èƒ½ä¼šéœ€è¦å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´ï¼Œä¸­é—´ä¸è¦Kæ‰äº†ï¼Œå¦åˆ™å®¹æ˜“ä¸¢å¤±æ•°æ®çš„ã€‚","text":"å½“æˆ‘ä»¬çš„zabbixè¿è¡Œæ—¶é—´ä¹…äº†ï¼Œç›‘æ§çš„èŠ‚ç‚¹å¤šäº†ï¼Œæ•°æ®ä¿¡æ¯ä¼šå¢é•¿çš„å¾ˆå¿«ï¼Œæƒ³å¤‡ä»½é‡Œé¢çš„æ•°æ®åº“æ—¶ï¼Œè¦æµªè´¹å¤§é‡çš„æ—¶é—´ï¼Œzabbixé‡Œé¢æœ€å¤§çš„è¡¨å°±æ˜¯å†å²è®°å½•çš„è¡¨äº†ï¼Œç½‘ä¸Šå¾ˆå¤šäººéƒ½æ˜¯å†™å…¨éƒ¨æ¸…ç©ºè¿™äº›è¡¨çš„æ•°æ®ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥æŒ‰æ—¶é—´æ¥åˆ é™¤é‡Œé¢çš„å†å²è®°å½•ï¼› é‡Œé¢æœ€å¤§çš„è¡¨æ˜¯ â€œhistoryâ€ å’Œ â€œhistory_uintâ€ä¸¤ä¸ªè¡¨ï¼› zabbixé‡Œé¢çš„æ—¶é—´æ˜¯ç”¨çš„æ—¶é—´æˆ³æ–¹å¼è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥è½¬æ¢ä¸€ä¸‹ï¼Œç„¶åæ ¹æ®æ—¶é—´æˆ³æ¥åˆ é™¤ï¼› æ¯”å¦‚è¦åˆ é™¤2012å¹´çš„11æœˆ25å·ä»¥å‰çš„æ•°æ® 1ã€å…ˆå°†æ ‡å‡†æ—¶é—´è½¬æ¢ä¸ºæ—¶é—´æˆ³ # date +%s -d â€œ2012-11-25 00:00:00â€1353772800 2ã€mysqlæ¸…ç†æ•°æ® mysql&gt; use zabbix;mysql&gt; DELETE FROM `history_uint` WHERE `clock` &lt; 1327939201;mysql&gt; optimize table history_uint; æ³¨ï¼šæ‰§è¡Œè¿‡ç¬¬äºŒè¡Œå‘½ä»¤ä¹‹åå¯èƒ½ä¼šéœ€è¦å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´ï¼Œä¸­é—´ä¸è¦Kæ‰äº†ï¼Œå¦åˆ™å®¹æ˜“ä¸¢å¤±æ•°æ®çš„ã€‚","categories":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}],"tags":[],"keywords":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}]},{"title":"LVS+Keepalived","slug":"lvskeepalived","date":"2014-10-31T02:54:30.000Z","updated":"2025-09-01T01:59:08.872Z","comments":true,"path":"2014/10/31/lvskeepalived/","permalink":"https://blog.sctux.cc/2014/10/31/lvskeepalived/","excerpt":"è¯´æ˜ï¼š æœ¬æ–‡æ¡£ä»…å›´ç»•lvs+keepalivedå¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ã€æ•…éšœå‰”é™¤ã€åç«¯realserverå¥åº·ç›‘æµ‹ã€ä¸»å¤‡åˆ‡æ¢é‚®ä»¶é€šçŸ¥;è€Œé˜²ç«å¢™ã€ç½‘ç»œ(è·¯ç”±äº¤æ¢)ã€åç«¯æ•°æ®å­˜å‚¨ã€å†…å¤–ç½‘æš‚æœªè€ƒè™‘; ä¸€ã€ç¯å¢ƒå‡†å¤‡ï¼š 1.æ“ä½œç³»ç»Ÿ CentOS6.4-x86_64 2.è½¯ä»¶ç‰ˆæœ¬ï¼š ipvsadm-1.25-10.el6.x86_64keepalived-1.2.7-3.el6.x86_64httpd-2.2.15-26.el6.centos.x86_64 3.å®éªŒæ‹“æ‰‘ï¼š 4.æ—¶é—´åŒæ­¥ï¼š 123456789101112node1:\\[root@node1 ~\\]# ntpdate 203.117.180.36\\[root@node1 ~\\]# echo \"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36\" &gt;&gt; /etc/crontabnode2:\\[root@node2 ~\\]# ntpdate 203.117.180.36\\[root@node1 ~\\]# echo \"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36\" &gt;&gt; /etc/crontabmaster:\\[root@master ~\\]# ntpdate 203.117.180.36\\[root@master ~\\]# echo \"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36\" &gt;&gt; /etc/crontabSlave:\\[root@slave ~\\]# ntpdate 203.117.180.36\\[root@slave ~\\]# echo \"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36\" &gt;&gt; /etc/crontab 5.ä¸»æœºåç›¸äº’è§£æï¼š 123456789101112node1:\\[root@node1 ~\\]# cat /etc/hosts127.0.0.1&nbsp;&nbsp; localhost localhost.localdomain localhost4 localhost4.localdomain4&nbsp;::1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; localhost localhost.localdomain localhost6 localhost6.localdomain6&nbsp;192.168.254.201&nbsp;&nbsp;&nbsp; node1.test.com&nbsp;&nbsp;&nbsp; node1&nbsp;192.168.254.202&nbsp;&nbsp;&nbsp; node2.test.com&nbsp;&nbsp;&nbsp; node2node2:\\[root@node2 ~\\]# cat /etc/hosts127.0.0.1&nbsp;&nbsp; localhost localhost.localdomain localhost4 localhost4.localdomain4&nbsp;::1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; localhost localhost.localdomain localhost6 localhost6.localdomain6&nbsp;192.168.254.201&nbsp;&nbsp;&nbsp; node1.test.com&nbsp;&nbsp;&nbsp; node1&nbsp;192.168.254.202&nbsp;&nbsp;&nbsp; node2.test.com&nbsp;&nbsp;&nbsp; node2 6.å®‰è£…yumæºï¼š(å…¶ä»–ä¸‰å°ä¸»æœºä¸Šé¢åŒæ ·æ‰§è¡Œä»¥ä¸‹ä¸¤æ¡å‘½ä»¤å³å¯ï¼Œå‰æ:èƒ½ä¸Šç½‘) 1234node1:\\[root@node1~\\]#rpm -ivh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm\\[root@node1 ~\\]# rpm -ivh http://elrepo.org/elrepo-release-6-5.el6.elrepo.noarch.rpm","text":"è¯´æ˜ï¼š æœ¬æ–‡æ¡£ä»…å›´ç»•lvs+keepalivedå¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ã€æ•…éšœå‰”é™¤ã€åç«¯realserverå¥åº·ç›‘æµ‹ã€ä¸»å¤‡åˆ‡æ¢é‚®ä»¶é€šçŸ¥;è€Œé˜²ç«å¢™ã€ç½‘ç»œ(è·¯ç”±äº¤æ¢)ã€åç«¯æ•°æ®å­˜å‚¨ã€å†…å¤–ç½‘æš‚æœªè€ƒè™‘; ä¸€ã€ç¯å¢ƒå‡†å¤‡ï¼š 1.æ“ä½œç³»ç»Ÿ CentOS6.4-x86_64 2.è½¯ä»¶ç‰ˆæœ¬ï¼š ipvsadm-1.25-10.el6.x86_64keepalived-1.2.7-3.el6.x86_64httpd-2.2.15-26.el6.centos.x86_64 3.å®éªŒæ‹“æ‰‘ï¼š 4.æ—¶é—´åŒæ­¥ï¼š 123456789101112node1:\\[root@node1 ~\\]# ntpdate 203.117.180.36\\[root@node1 ~\\]# echo \"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36\" &gt;&gt; /etc/crontabnode2:\\[root@node2 ~\\]# ntpdate 203.117.180.36\\[root@node1 ~\\]# echo \"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36\" &gt;&gt; /etc/crontabmaster:\\[root@master ~\\]# ntpdate 203.117.180.36\\[root@master ~\\]# echo \"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36\" &gt;&gt; /etc/crontabSlave:\\[root@slave ~\\]# ntpdate 203.117.180.36\\[root@slave ~\\]# echo \"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36\" &gt;&gt; /etc/crontab 5.ä¸»æœºåç›¸äº’è§£æï¼š 123456789101112node1:\\[root@node1 ~\\]# cat /etc/hosts127.0.0.1&nbsp;&nbsp; localhost localhost.localdomain localhost4 localhost4.localdomain4&nbsp;::1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; localhost localhost.localdomain localhost6 localhost6.localdomain6&nbsp;192.168.254.201&nbsp;&nbsp;&nbsp; node1.test.com&nbsp;&nbsp;&nbsp; node1&nbsp;192.168.254.202&nbsp;&nbsp;&nbsp; node2.test.com&nbsp;&nbsp;&nbsp; node2node2:\\[root@node2 ~\\]# cat /etc/hosts127.0.0.1&nbsp;&nbsp; localhost localhost.localdomain localhost4 localhost4.localdomain4&nbsp;::1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; localhost localhost.localdomain localhost6 localhost6.localdomain6&nbsp;192.168.254.201&nbsp;&nbsp;&nbsp; node1.test.com&nbsp;&nbsp;&nbsp; node1&nbsp;192.168.254.202&nbsp;&nbsp;&nbsp; node2.test.com&nbsp;&nbsp;&nbsp; node2 6.å®‰è£…yumæºï¼š(å…¶ä»–ä¸‰å°ä¸»æœºä¸Šé¢åŒæ ·æ‰§è¡Œä»¥ä¸‹ä¸¤æ¡å‘½ä»¤å³å¯ï¼Œå‰æ:èƒ½ä¸Šç½‘) 1234node1:\\[root@node1~\\]#rpm -ivh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm\\[root@node1 ~\\]# rpm -ivh http://elrepo.org/elrepo-release-6-5.el6.elrepo.noarch.rpm *äºŒã€webèŠ‚ç‚¹å®‰è£…é…ç½®ï¼š* å®‰è£…webæœåŠ¡å¹¶æ‰§è¡Œrealserver.sh,ä¸ºlo:0ç»‘å®šVIPåœ°å€192.168.254.200ï¼ŒæŠ‘åˆ¶ARPå¹¿æ’­; node1/node2é…ç½®ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859\\[root@node1 ~\\]# yum install -y httpd&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;\\[root@node1 ~\\]# echo \"&lt;h1&gt;Rs1.test.com&lt;/h1&gt;\" &gt; /var/www/html/index.html\\[root@node1 ~\\]# service httpd start\\[root@node1 ~\\]# chkconfig httpd on\\[root@node1 ~\\]# mkdir script\\[root@node1 ~\\]# cd script/\\[root@node1 ~\\]# vim script/realserver.sh#-&gt;LVSå®¢æˆ·ç«¯é…ç½®è„šæœ¬realserver.shï¼š#!/bin/bash&nbsp;\\# Script to start LVS DR real server.&nbsp;&nbsp;\\# description: LVS DR real server&nbsp;&nbsp;.&nbsp; /etc/rc.d/init.d/functionsVIP=192.168.254.200&nbsp;host=`/bin/hostname`case \"$1\" in&nbsp;start)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Start LVS-DR real server on this machine.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /sbin/ifconfig lo down&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /sbin/ifconfig lo up&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /sbin/ifconfig lo:0 $VIP broadcast $VIP netmask 255.255.255.255 up&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /sbin/route add -host $VIP dev lo:0;;&nbsp;stop)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Stop LVS-DR real server loopback device(s).&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /sbin/ifconfig lo:0 down&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce;;&nbsp;status)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Status of LVS-DR real server.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; islothere=`/sbin/ifconfig lo:0 | grep $VIP`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; isrothere=\\`netstat -rn | grep \"lo:0\" | grep $VIP\\`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if \\[ ! \"$islothere\" -o ! \"isrothere\" \\];then&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Either the route or the lo:0 device&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # not found.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo \"LVS-DR real server Stopped.\"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo \"LVS-DR real server Running.\"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi&nbsp;&nbsp;;;&nbsp;&nbsp;*)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Invalid entry.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo \"$0: Usage: $0 {start|status|stop}\"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit 1&nbsp;&nbsp;;;&nbsp;&nbsp;esac\\[root@node1 ~\\]# chmod +x script/realserver.sh\\[root@node1 ~\\]# ./script/realserver.sh start #-&gt;å°†è¯¥è„šæœ¬scpåˆ°node2èŠ‚ç‚¹æ‰§è¡Œ./script/realserver.sh startå³å¯ #-&gt;å¦‚æœæœåŠ¡å™¨é‡å¯ï¼Œé‚£è¿˜éœ€è¦æ‰‹åŠ¨çš„å»æ‰§è¡Œè¿™ä¸ªè„šæœ¬ï¼ŒæœåŠ¡ä¾¿ä¸å¯ä½¿ç”¨äº†ï¼Œæ‰€ä»¥å¯ä»¥å°†realserver.shåŠ å…¥åˆ°å¼€æœºå¯åŠ¨é¡¹ä¸­; 1234567\\[root@node1 ~\\]# vim /etc/rc.local/bin/bash /root/script/realserver.sh start\\[root@node1 ~\\]# scp /script/realserver 192.168.254.46:/root/script#-&gt;æ•ˆæœå¦‚ä¸‹ï¼š[![2](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/2.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/2.png) [![3](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/3.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/3.png)#-&gt;å®¢æˆ·ç«¯è®¿é—®æµ‹è¯•ï¼š[![4](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/4.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/4.png) *ä¸‰ã€LVS-DR-Master/Slaveå®‰è£…é…ç½®ï¼š* 3.1.master/slaveéƒ½å®‰è£…keepalivedå’Œipvsadm : 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677master:\\[root@master ~\\]# yum install -y ipvsadm keepalived\\[root@master ~\\]# cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak&nbsp; #-&gt;ä¿®æ”¹é…ç½®æ–‡ä»¶ä¹‹å‰æœ€å¥½å°†è¯¥é…ç½®æ–‡ä»¶å¤‡ä»½ã€‚é¿å…åç»­å‡ºç°é—®é¢˜Slave:\\[root@slave ~\\]# yum install -y ipvsadm keepalived\\[root@slave ~\\]# cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak**3.2.****åœ¨****Lvs-DR-Master****ä¸Šé¢çš„é…ç½®ï¼š**\\[root@master ~\\]# vim /etc/keepalived/keepalived.conf! Configuration File for keepalivedglobal_defs {&nbsp;&nbsp; notification_email {&nbsp;&nbsp;&nbsp; 2399447849@qq.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#-&gt;#è®¾ç½®æŠ¥è­¦é‚®ä»¶åœ°å€ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªï¼Œæ¯è¡Œä¸€ä¸ª&nbsp;&nbsp; }&nbsp;&nbsp; notification\\_email\\_from root@localhost.localdomain&nbsp;&nbsp; smtp_server 127.0.0.1&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#-&gt;è®¾ç½®smtp serverçš„åœ°å€&nbsp;&nbsp; smtp\\_connect\\_timeout 30 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#-&gt;è®¾ç½®è¿æ¥smtp serverçš„è¶…æ—¶æ—¶é—´&nbsp;&nbsp; router\\_id LVS\\_DEVEL&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#-&gt;è¡¨ç¤ºè¿è¡ŒkeepalivedæœåŠ¡å™¨çš„ä¸€ä¸ªæ ‡è¯†ã€‚å‘é‚®ä»¶æ—¶æ˜¾ç¤ºåœ¨é‚®ä»¶ä¸»é¢˜çš„ä¿¡æ¯}vrrp\\_instance VI\\_1 {&nbsp;&nbsp;&nbsp; state MASTER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;æŒ‡å®škeepalivedçš„è§’è‰²ï¼ŒMASTERè¡¨ç¤ºæ­¤ä¸»æœºæ˜¯ä¸»æœåŠ¡å™¨ï¼ŒBACKUPè¡¨ç¤ºæ­¤ä¸»æœºæ˜¯å¤‡ç”¨æœåŠ¡å™¨&nbsp;&nbsp;&nbsp; interface eth0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;æŒ‡å®šHAç›‘æµ‹ç½‘ç»œçš„æ¥å£&nbsp;&nbsp;&nbsp; virtual\\_router\\_id 60 &nbsp;#-&gt;è™šæ‹Ÿè·¯ç”±æ ‡è¯†ï¼Œè¿™ä¸ªæ ‡è¯†æ˜¯ä¸€ä¸ªæ•°å­—,åŒä¸€ä¸ªvrrpå®ä¾‹ä½¿ç”¨å”¯ä¸€çš„æ ‡è¯†ã€‚å³åŒä¸€vrrp_instanceä¸‹,MASTERå’ŒBACKUP&gt;å¿…é¡»æ˜¯ä¸€è‡´çš„&nbsp;&nbsp;&nbsp; priority 101&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;å®šä¹‰ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œåœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERçš„ä¼˜å…ˆçº§å¿…é¡»å¤§äºBACKUPçš„ä¼˜å…ˆçº§&nbsp;&nbsp;&nbsp; advert_int 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;è®¾å®šMASTERä¸BACKUPè´Ÿè½½å‡è¡¡å™¨ä¹‹é—´åŒæ­¥æ£€æŸ¥çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’&nbsp;&nbsp;&nbsp; authentication {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;è®¾ç½®éªŒè¯ç±»å‹å’Œå¯†ç &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth_type PASS&nbsp;&nbsp;&nbsp; #-&gt;è®¾ç½®éªŒè¯ç±»å‹ï¼Œä¸»è¦æœ‰PASSå’ŒAHä¸¤ç§&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth\\_pass 1111&nbsp;&nbsp;&nbsp; #-&gt;è®¾ç½®éªŒè¯å¯†ç ï¼Œåœ¨åŒä¸€ä¸ªvrrp\\_instanceä¸‹ï¼ŒMASTERä¸BACKUPå¿…é¡»ä½¿ç”¨ç›¸åŒçš„å¯†ç æ‰èƒ½æ­£å¸¸é€šä¿¡&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; virtual_ipaddress {&nbsp;&nbsp; #-&gt;è®¾ç½®è™šæ‹ŸIPåœ°å€ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªè™šæ‹ŸIPåœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.254.200&nbsp;&nbsp; #-&gt;å®¢æˆ·ç«¯é€šè¿‡è®¿é—®çš„å°±æ˜¯è¯¥IPåœ°å€&nbsp;&nbsp;&nbsp; }}virtual_server 192.168.254.200 80 {&nbsp; #-&gt;è®¾ç½®è™šæ‹ŸæœåŠ¡å™¨ï¼Œéœ€è¦æŒ‡å®šè™šæ‹ŸIPåœ°å€å’ŒæœåŠ¡ç«¯å£ï¼ŒIPä¸ç«¯å£ä¹‹é—´ç”¨ç©ºæ ¼éš”å¼€&nbsp;&nbsp;&nbsp; delay_loop 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;è®¾ç½®è¿è¡Œæƒ…å†µæ£€æŸ¥æ—¶é—´ï¼Œå•ä½æ˜¯ç§’&nbsp;&nbsp;&nbsp; lb_algo rr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;è®¾ç½®è´Ÿè½½è°ƒåº¦ç®—æ³•ï¼Œè¿™é‡Œè®¾ç½®ä¸ºrrï¼Œå³è½®è¯¢ç®—æ³•&nbsp;&nbsp;&nbsp; lb_kind DR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;è®¾ç½®LVSå®ç°è´Ÿè½½å‡è¡¡çš„æœºåˆ¶ï¼Œæœ‰NATã€TUNã€DRä¸‰ä¸ªæ¨¡å¼å¯é€‰nat_mask 255.255.255.0#persistence_timeout 50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;ä¼šè¯ä¿æŒæ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚è¿™ä¸ªé€‰é¡¹å¯¹åŠ¨æ€ç½‘é¡µæ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œä¸ºé›†ç¾¤ç³»ç»Ÿä¸­çš„sessionå…±äº«æä¾›äº†ä¸€ä¸ªå¾ˆå¥½&gt;çš„è§£å†³æ–¹æ¡ˆã€‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;æœ‰äº†è¿™ä¸ªä¼šè¯ä¿æŒåŠŸèƒ½ï¼Œç”¨æˆ·çš„è¯·æ±‚ä¼šè¢«ä¸€ç›´åˆ†å‘åˆ°æŸä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œç›´åˆ°è¶…è¿‡è¿™ä¸ªä¼šè¯çš„ä¿æŒæ—¶é—´ã€‚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªä¼šè¯ä¿æŒæ—¶é—´æ˜¯æœ€å¤§æ— å“åº”è¶…æ—¶æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·åœ¨æ“ä½œåŠ¨æ€é¡µé¢æ—¶ï¼Œå¦‚æœ50ç§’å†…æ²¡æœ‰æ‰§è¡Œä»»ä½•æ“ä½œï¼Œ&nbsp;&nbsp;&nbsp; protocol TCP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;æŒ‡å®šè½¬å‘åè®®ç±»å‹ï¼Œæœ‰TCPå’ŒUDPä¸¤ç§&nbsp;&nbsp;&nbsp; real_server 192.168.254.45 80&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;é…ç½®æœåŠ¡èŠ‚ç‚¹1ï¼Œéœ€è¦æŒ‡å®šreal serverçš„çœŸå®IPåœ°å€å’Œç«¯å£ï¼ŒIPä¸ç«¯å£ä¹‹é—´ç”¨ç©ºæ ¼éš”å¼€&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; weight 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;é…ç½®æœåŠ¡èŠ‚ç‚¹çš„æƒå€¼ï¼Œæƒå€¼å¤§å°ç”¨æ•°å­—è¡¨ç¤ºï¼Œæ•°å­—è¶Šå¤§ï¼Œæƒå€¼è¶Šé«˜ï¼Œè®¾ç½®æƒå€¼å¤§å°å¯ä»¥ä¸ºä¸åŒæ€§èƒ½çš„æœåŠ¡å™¨&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;åˆ†é…ä¸åŒçš„è´Ÿè½½ï¼Œå¯ä»¥ä¸ºæ€§èƒ½é«˜çš„æœåŠ¡å™¨è®¾ç½®è¾ƒé«˜çš„æƒå€¼ï¼Œè€Œä¸ºæ€§èƒ½è¾ƒä½çš„æœåŠ¡å™¨è®¾ç½®ç›¸å¯¹è¾ƒä½çš„æƒå€¼ï¼Œè¿™æ ·æ‰èƒ½åˆç†åœ°åˆ©ç”¨å’Œåˆ†é…ç³»ç»Ÿèµ„æº&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HTTP_GET {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;realserverçš„çŠ¶æ€æ£€æµ‹è®¾ç½®éƒ¨åˆ†ï¼Œå•ä½æ˜¯ç§’&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; url {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; path /&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status_code 200&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;çŠ¶æ€ç å®šä¹‰&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connect_timeout 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;è¡¨ç¤º3ç§’æ— å“åº”è¶…æ—¶&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nb\\_get\\_retry 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;è¡¨ç¤ºé‡è¯•æ¬¡æ•°&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay\\_before\\_retry 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;è¡¨ç¤ºé‡è¯•é—´éš”&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; real_server 192.168.254.46 80 {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; weight 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HTTP_GET {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; url {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; path /&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status_code 200&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connect_timeout 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nb\\_get\\_retry 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay\\_before\\_retry 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; }} #-&gt;æ ¹æ®å®éªŒçš„æ‹“æ‰‘å¯çŸ¥åç«¯çš„realserveræœ‰ä¸¤å°ï¼Œæ‰€ä»¥ä¸Šé¢å®šä¹‰äº†ä¸¤ä¸ªrealserverçš„é…ç½® 3.3åœ¨Lvs-DR-Slave****ä¸Šé¢çš„é…ç½®ï¼š [root@master ~]# scp /etc/keepalived/keepalived.conf 192.168.254.48:/etc/keepalived/&nbsp; #-&gt;å°†masterä¸Šé¢çš„é…ç½®å¤åˆ¶è‡³slave,ç„¶åç¨ä½œä¿®æ”¹ï¼š[root@slave ~]# vim /etc/keepalived/keepalived.conf#-&gt;é…ç½®æ–‡ä»¶å„ä¸ªå‚æ•°ä¸Šé¢ä»¥è§£é‡Šï¼Œè¿™é‡Œåªå¯¹éœ€è¦ä¿®æ”¹çš„ä½œè¯´æ˜ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566! Configuration File for keepalivedglobal_defs {&nbsp;&nbsp; notification_email {&nbsp;&nbsp;&nbsp; 2399447849@qq.com&nbsp;&nbsp; }&nbsp;&nbsp; notification\\_email\\_from root&nbsp;&nbsp; smtp_server 127.0.0.1&nbsp;&nbsp; smtp\\_connect\\_timeout 30&nbsp;&nbsp; router\\_id LVS\\_DEVEL}&nbsp;vrrp\\_instance VI\\_1 {&nbsp;&nbsp;&nbsp; state BACKUP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;æŒ‡å®šè¯¥æœåŠ¡å™¨çš„keepalivedè§’è‰²ä¸ºBACKUP(å¤‡ç”¨æœåŠ¡å™¨)&nbsp;&nbsp; interface eth0&nbsp;&nbsp; virtual\\_router\\_id 60&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; priority 100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;åœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERçš„ä¼˜å…ˆçº§å¿…é¡»å¤§äºBACKUPçš„ä¼˜å…ˆçº§&nbsp;&nbsp;&nbsp; advert_int 1&nbsp;&nbsp;&nbsp; authentication {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth_type PASS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth_pass 1111&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; virtual_ipaddress {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.254.200&nbsp;&nbsp;&nbsp; }}&nbsp;virtual_server 192.168.254.200 80 {&nbsp;&nbsp;&nbsp; delay_loop 6&nbsp;&nbsp;&nbsp; lb_algo rr&nbsp;&nbsp;&nbsp; lb_kind DR&nbsp;&nbsp; nat_mask 255.255.255.0&nbsp;&nbsp;&nbsp; #persistence_timeout 50protocol TCP&nbsp;&nbsp; real_server 192.168.254.45 80&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; weight 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HTTP_GET {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; url {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; path /&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status_code 200&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connect_timeout 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nb\\_get\\_retry 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay\\_before\\_retry 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; real_server 192.168.254.46 80 {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; weight 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HTTP_GET {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; url {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; path /&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status_code 200&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connect_timeout 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nb\\_get\\_retry 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay\\_before\\_retry 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; }} *3.4.å¯åŠ¨keepalived (å¯åŠ¨è¿‡ç¨‹ä¸­è§‚å¯Ÿæ—¥å¿—)* 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641master:\\[root@master ~\\]# service keepalived start &amp;&amp; tail -f /var/log/messages......................Oct 29 21:42:14 master Keepalived_healthcheckers\\[31358\\]: Opening file '/etc/keepalived/keepalived.conf'.Oct 29 21:42:14 master Keepalived_healthcheckers\\[31358\\]: Configuration is using : 16384 BytesOct 29 21:42:14 master Keepalived_healthcheckers\\[31358\\]: Using LinkWatch kernel netlink reflector...Oct 29 21:42:14 master Keepalived_healthcheckers\\[31358\\]: Activating healthchecker for service \\[192.168.254.45\\]:80Oct 29 21:42:14 master Keepalived_healthcheckers\\[31358\\]: Activating healthchecker for service \\[192.168.254.46\\]:80Oct 29 21:42:15 master Keepalived\\_vrrp\\[31359\\]: VRRP\\_Instance(VI_1) Transition to MASTER STATEOct 29 21:42:16 master Keepalived\\_vrrp\\[31359\\]: VRRP\\_Instance(VI_1) Entering MASTER STATE&nbsp; #-&gt;ä¸»æœåŠ¡å™¨çŠ¶æ€Oct 29 21:42:16 master Keepalived\\_vrrp\\[31359\\]: VRRP\\_Instance(VI_1) setting protocol VIPs.Oct 29 21:42:16 master Keepalived\\_vrrp\\[31359\\]: VRRP\\_Instance(VI_1) Sending gratuitous ARPs on eth0 for 192.168.254.200Oct 29 21:42:16 master Keepalived_healthcheckers\\[31358\\]: Netlink reflector reports IP 192.168.254.200 addedOct 29 21:42:21 master Keepalived\\_vrrp\\[31359\\]: VRRP\\_Instance(VI_1) Sending gratuitous ARPs on eth0 for 192.168.254.200......................\\[root@master ~\\]# ipvsadm -L â€“n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;LVSçŠ¶æ€IP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags&nbsp; -\\&gt; RemoteAddress:Port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Forward Weight ActiveConn InActConnTCP&nbsp; 192.168.254.200:80 rr&nbsp; -\\&gt; 192.168.254.45:80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Route&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -\\&gt; 192.168.254.46:80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Route&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\[root@master ~\\]# ip a1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN&nbsp;&nbsp;&nbsp; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00&nbsp;&nbsp;&nbsp; inet 127.0.0.1/8 scope host lo&nbsp;&nbsp;&nbsp; inet6 ::1/128 scope host&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; valid\\_lft forever preferred\\_lft forever2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER\\_UP&gt; mtu 1500 qdisc pfifo\\_fast state UP qlen 1000&nbsp;&nbsp; link/ether 00:0c:29:5d:7d:94 brd ff:ff:ff:ff:ff:ff&nbsp;&nbsp;&nbsp; inet 192.168.254.47/24 brd 192.168.254.255 scope global eth0&nbsp;&nbsp;&nbsp; inet 192.168.254.200/32 scope global eth0&nbsp;&nbsp;&nbsp; #-&gt;æ­¤æ—¶VIPåœ¨masterä¸Šé¢&nbsp;&nbsp;&nbsp; inet6 fe80::20c:29ff:fe5d:7d94/64 scope link&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; valid\\_lft forever preferred\\_lft forever\\[root@master ~\\]#Slave:\\[root@slave ~\\]# service keepalived start &amp;&amp; tail -f /var/log/messages......................Oct 29 21:42:34 slave Keepalived_vrrp\\[31389\\]: Opening file '/etc/keepalived/keepalived.conf'.Oct 29 21:42:34 slave Keepalived_vrrp\\[31389\\]: Configuration is using : 62845 BytesOct 29 21:42:34 slave Keepalived_vrrp\\[31389\\]: Using LinkWatch kernel netlink reflector...Oct 29 21:42:34 slave Keepalived\\_vrrp\\[31389\\]: VRRP\\_Instance(VI_1) Entering BACKUP STATE&nbsp; #-&gt;å¤‡ç”¨æœåŠ¡å™¨çŠ¶æ€Oct 29 21:42:34 slave Keepalived_vrrp\\[31389\\]: VRRP sockpool: \\[ifindex(2), proto(112), fd(10,11)\\]Oct 29 21:42:34 slave Keepalived_healthcheckers\\[31388\\]: Opening file '/etc/keepalived/keepalived.conf'.Oct 29 21:42:34 slave Keepalived_healthcheckers\\[31388\\]: Configuration is using : 16384 BytesOct 29 21:42:34 slave Keepalived_healthcheckers\\[31388\\]: Using LinkWatch kernel netlink reflector...Oct 29 21:42:34 slave Keepalived_healthcheckers\\[31388\\]: Activating healthchecker for service \\[192.168.254.45\\]:80Oct 29 21:42:34 slave Keepalived_healthcheckers\\[31388\\]: Activating healthchecker for service \\[192.168.254.46\\]:80......................**3.5.****æµ‹è¯•ï¼š** [![5](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/5.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/5.png) **3.6.****æ¨¡æ‹Ÿæ•…éšœ**ï¼š (1)åœæ‰node1èŠ‚ç‚¹çš„webæœåŠ¡ï¼š\\[root@node1 ~\\]# service httpd stopåœæ­¢ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]\\[root@node1 ~\\]#(2)æŸ¥çœ‹ä¸€ä¸‹æŠ¥è­¦é‚®ä»¶ï¼š [![6](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/6.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/6.png) (3)å†åœ¨å‰ç«¯è°ƒåº¦å™¨ä¸ŠæŸ¥çœ‹ä¸€ä¸‹LVSçŠ¶æ€ï¼š [![7](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/7.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/7.png) å¾ˆæ˜æ˜¾é‚£å°å‡ºç°é—®é¢˜çš„realserveræ¡ç›®å·²ç»è¢«å‰”é™¤äº† (4)æ¢å¤node1èŠ‚ç‚¹ä¸Šçš„webæœåŠ¡ï¼š\\[root@node1 ~\\]# service httpd startå¯åŠ¨ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]\\[root@node1 ~\\]#(5) æŸ¥çœ‹ä¸€ä¸‹æŠ¥è­¦é‚®ä»¶ï¼š [![8](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/8.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/8.png) (6)å…³é—­masterä¸Šé¢çš„keepalivedï¼š\\[root@master ~\\]# service keepalived stopåœæ­¢ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]\\[root@master ~\\]# ipvsadm -L -nIP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags&nbsp; -\\&gt; RemoteAddress:Port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Forward Weight ActiveConn InActConn\\[root@master ~\\]#(7)æŸ¥çœ‹slaveçŠ¶æ€ï¼š\\[root@slave ~\\]# ip a..............&nbsp;&nbsp;&nbsp; inet 192.168.254.200/32 scope global eth0&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;å¯è§VIPå·²ç»è½¬ç§»åˆ°äº†slaveä¸Šé¢ï¼›å¹¶ä¸”é€šè¿‡å®¢æˆ·ç«¯è®¿é—®ä»ç„¶æ­£å¸¸ï¼..............&nbsp;\\[root@slave ~\\]# ipvsadm -L -nIP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags&nbsp; -\\&gt; RemoteAddress:Port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Forward Weight ActiveConn InActConnTCP&nbsp; 192.168.254.200:80 rr&nbsp; -\\&gt; 192.168.254.45:80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Route&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -\\&gt; 192.168.254.46:80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Route&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\[root@slave ~\\]#**é€šè¿‡ä¸Šé¢çš„æ¼”ç¤ºç°åœ¨çš„****LVS****çš„é«˜å¯ç”¨å³å‰ç«¯è´Ÿè½½å‡è¡¡è°ƒåº¦å™¨çš„é«˜å¯ç”¨ï¼ŒåŒæ—¶å®ç°äº†å¯¹åç«¯****realserver****ç›‘æ§ï¼Œä¹Ÿå®ç°äº†åç«¯****realserver****å®•æœºæ—¶ä¼šç»™ç®¡ç†å‘˜å‘é€é‚®ä»¶ï¼›ä½†æ˜¯ç›®å‰è¿˜é¢ä¸´å‡ ä¸ªé—®é¢˜ï¼š**1. **å¦‚æœæ‰€æœ‰çš„****realserver****éƒ½å®•æœºï¼Œå¦‚ä½•å¤„ç†ï¼Œç”¨æˆ·æ‰“ä¸å¼€å°±ç­‰å®ƒæ‰“ä¸å¼€ï¼Œè¿˜æ˜¯å‹å–„çš„æç¤ºä¸€ä¸‹ï¼Ÿ**2. **æ€ä¹ˆå®Œæˆç»´æŠ¤æ¨¡å¼****keepalived****åˆ‡æ¢ï¼Ÿ**3. **å¦‚ä½•åœ¨****keepalived****ä¸»å¤‡åˆ‡æ¢æ—¶å‘ç®¡ç†å‘˜å‘é€é‚®ä»¶ï¼Ÿ****å››ã€****LVS+Keepalived****åç»­å»¶ä¼¸ï¼š** **4.1.****æ‰€æœ‰****realserver****éƒ½å®•æœºå¦‚ä½•å¤„ç†ï¼Ÿ** åœ¨é›†ç¾¤ä¸­å¦‚æœæ‰€æœ‰real serverå…¨éƒ¨å®•æœºäº†ï¼Œå®¢æˆ·ç«¯è®¿é—®æ—¶å°±ä¼šå‡ºç°é”™è¯¯é¡µé¢ï¼Œè¿™æ ·æ˜¯å¾ˆä¸å‹å¥½çš„ï¼Œæˆ‘ä»¬å¾—æä¾›ä¸€ä¸ªç»´æŠ¤é¡µé¢æ¥æé†’ç”¨æˆ·ï¼ŒæœåŠ¡å™¨æ­£åœ¨ç»´æŠ¤ï¼Œä»€ä¹ˆæ—¶é—´å¯ä»¥è®¿é—®ç­‰ï¼Œä¸‹é¢å°±æ¥è§£å†³ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æä¾›ä¸€å°å¤‡ç”¨çš„real serverå½“æ‰€æœ‰çš„æœåŠ¡å™¨å®•æœºæ—¶ï¼Œæä¾›ç»´æŠ¤é¡µé¢ï¼Œä½†è¿™æ ·åšæœ‰ç‚¹æµªè´¹æœåŠ¡å™¨ã€‚å¦ä¸€ç§å°±æ˜¯åœ¨è´Ÿè½½å‡è¡¡å™¨ä¸Šæä¾›ç»´æŠ¤é¡µé¢ï¼Œè¿™æ ·æ˜¯æ¯”è¾ƒé è°±çš„ï¼Œä¹Ÿæ¯”è¾ƒå¸¸ç”¨ã€‚ä¸‹é¢å°±æ¥å…·ä½“æ“ä½œä¸€ä¸‹ã€‚ (1)åœ¨masterå’Œslaveä¸Šé¢å®‰è£…httpd\\[root@master ~\\]# yum install -y httpd\\[root@slave ~\\]# yum install -y httpd(2)æä¾›ç»´æŠ¤é¡µé¢æ–‡ä»¶\\[root@master ~\\]# echo \"Oops ... you visit the page does not exist, the server may be maintained?\" &gt; /var/www/html/index.html\\[root@master ~\\]# service httpd startå¯åŠ¨ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]\\[root@slave ~\\]# echo \"Oops ... you visit the page does not exist, the server may be maintained?\" &gt; /var/www/html/index.html\\[root@slave ~\\]# service httpd startå¯åŠ¨ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\](3)æµ‹è¯•ï¼š [![9](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/9.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/9.png) (4)ä¿®æ”¹master/slaveçš„keepalivedé…ç½®æ–‡ä»¶ï¼š\\[root@master ~\\]# vim /etc/keepalived/keepalived.conf! Configuration File for keepalivedglobal_defs {notification_email {2399447849@qq.com}notification\\_email\\_from rootsmtp_server 127.0.0.1smtp\\_connect\\_timeout 30router\\_id LVS\\_DEVEL}vrrp\\_instance VI\\_1 {state MASTERinterface eth0 virtual\\_router\\_id 60 priority 101 advert_int 1 authentication { auth_type PASS auth_pass 1111}virtual_ipaddress { 192.168.254.200 }}virtual_server 192.168.254.200 80 {delay_loop 6lb_algo rrlb_kind DRnat_mask 255.255.255.0#persistence_timeout 50protocol TCPreal_server 192.168.254.45 80&amp;nbsp; {weight 1HTTP_GET { url { path / status_code 200}connect_timeout 3nb\\_get\\_retry 3delay\\_before\\_retry 3 }}real_server 192.168.254.46 80 {weight 1HTTP_GET {url {path /status_code 200}connect_timeout 3nb\\_get\\_retry 3delay\\_before\\_retry 3}}sorry_server 127.0.0.1&amp;nbsp;&amp;nbsp; #-&gt;å¢åŠ è¯¥é…ç½®å‚æ•°ï¼Œslaveä¸Šé¢ä¹Ÿéœ€è¦æ·»åŠ ï¼Œæ­¤å¤„ç•¥ã€‚}(5)å…³é—­æ‰€æœ‰çš„realserver webæœåŠ¡,é‡æ–°å¯åŠ¨master/slave çš„keepalived: &nbsp;node1:\\[root@node1 ~\\]# service httpd stopåœæ­¢ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]\\[root@node1 ~\\]#node2:\\[root@node2 ~\\]# service httpd stopåœæ­¢ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]\\[root@node2 ~\\]#master:\\[root@master ~\\]# service keepalived restartåœæ­¢ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]æ­£åœ¨å¯åŠ¨ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]\\[root@master ~\\]#slave:\\[root@slave ~\\]# service keepalived restartåœæ­¢ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]æ­£åœ¨å¯åŠ¨ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]\\[root@slave ~\\]#(6)æŸ¥çœ‹ä¸€ä¸‹LVSçŠ¶æ€ï¼š [![10](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/10.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/10.png) (7)è®¿é—®æµ‹è¯•ï¼š [![11](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/11.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/11.png) **4.2.****å¦‚ä½•å®Œæˆç»´æŠ¤æ¨¡å¼****keepalived** **åˆ‡æ¢ï¼Ÿ** ä¸€èˆ¬æˆ‘ä»¬åœ¨æµ‹è¯•ä¸»ä»åˆ‡æ¢çš„è¿‡ç¨‹å½“ä¸­è¦ä¹ˆæ˜¯æ‰‹åŠ¨åœæ­¢keepalivedæœåŠ¡ï¼Œè¦ä¹ˆæ˜¯æ‰‹åŠ¨å…³é—­ç½‘å¡ï¼Œé‚£è¿˜æœ‰å…¶ä»–æ–¹æ³•å®ç°ç»´æŠ¤æ¨¡å¼çš„åˆ‡æ¢ï¼Œè¿™å°±æ˜¯vrrp_scriptåŠŸèƒ½ï¼› (1)master/slaveé…ç½®ï¼š**(****æ³¨****:****è¿™é‡Œæ¼”ç¤ºä¸»æœåŠ¡å™¨çš„é…ç½®ï¼Œæ·»åŠ ä¸Šå»çš„åœ¨****slave****ä¸Šé¢ä¹Ÿéœ€è¦æ·»åŠ ä»¥çº¢è‰²æ ‡æ³¨å†…å®¹****)**\\[root@master ~\\]# vim /etc/keepalived/keepalived.conf! Configuration File for keepalivedglobal_defs {notification_email {2399447849@qq.com}notification\\_email\\_from rootsmtp_server 127.0.0.1smtp\\_connect\\_timeout 30router\\_id LVS\\_DEVEL}vrrp\\_script chk\\_schedown {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;å®šä¹‰vrrpæ‰§è¡Œè„šæœ¬&nbsp;&nbsp; script \"\\[ -e /etc/keepalived/down \\] &amp;&amp; exit 1 || exit 0\" &nbsp;#-&gt;æŸ¥çœ‹æ˜¯å¦æœ‰downæ–‡ä»¶ï¼Œæœ‰å°±è¿›å…¥ç»´æŠ¤æ¨¡å¼&nbsp;&nbsp; interval 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;ç›‘æ§é—´éš”æ—¶é—´&nbsp;&nbsp; weight -5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;é™ä½ä¼˜å…ˆçº§,å³priorityå‚æ•°&nbsp;&nbsp; fall 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;å¤±è´¥æ¬¡æ•°&nbsp;&nbsp; rise 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #-&gt;æˆåŠŸæ¬¡æ•°}vrrp\\_instance VI\\_1 {state MASTERinterface eth0virtual\\_router\\_id 60priority 101advert_int 1authentication {auth_type PASSauth_pass 1111}virtual_ipaddress {192.168.254.200}track_script {&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#-&gt;è„šæœ¬è¿½è¸ª&nbsp;&nbsp;&nbsp; chk_schedown&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;#-&gt;ä¸Šé¢è‡ªå®šä¹‰çš„vrrpè„šæœ¬åç§° }}virtual_server 192.168.254.200 80 {delay_loop 6lb_algo rrlb_kind DRnat_mask 255.255.255.0#persistence_timeout 50protocol TCP&nbsp;real_server 192.168.254.45 80&nbsp; {weight 1HTTP_GET {url {path /status_code 200}connect_timeout 3nb\\_get\\_retry 3delay\\_before\\_retry 3}}real_server 192.168.254.46 80 {weight 1HTTP_GET {url {path /status_code 200}connect_timeout 3nb\\_get\\_retry 3delay\\_before\\_retry 3}}sorry_server 127.0.0.1}(2)æµ‹è¯•ï¼š master:\\[root@master keepalived\\]# touch down &nbsp;#-&gt;æ–°å»ºä¸€ä¸ªdownæ–‡ä»¶ï¼Œè¿›å…¥ç»´æŠ¤æ¨¡å¼\\[root@master keepalived\\]# llæ€»ç”¨é‡ 4-rw-r--r--. 1 root root&nbsp;&nbsp;&nbsp; 0 10æœˆ 30 00:16 down-rw-r--r--. 1 root root 1513 10æœˆ 30 00:08 keepalived.conf\\[root@master keepalived\\]# tail -f /var/log/messages..............Oct 30 00:16:43 node3 Keepalived\\_vrrp\\[31993\\]: VRRP\\_Script(chk_schedown) failedOct 30 00:16:44 node3 Keepalived\\_vrrp\\[31993\\]: VRRP\\_Instance(VI_1) Received higher prio advertOct 30 00:16:44 node3 Keepalived\\_vrrp\\[31993\\]: VRRP\\_Instance(VI_1) Entering BACKUP STATEOct 30 00:16:44 node3 Keepalived\\_vrrp\\[31993\\]: VRRP\\_Instance(VI_1) removing protocol VIPs.Oct 30 00:16:44 node3 Keepalived_healthcheckers\\[31992\\]: Netlink reflector reports IP 192.168.254.200 removed&nbsp; #-&gt;è¯¥VIPå·²è½¬ç§»åˆ°slave...............\\[root@master keepalived\\]# ip a&nbsp;&nbsp; #-&gt;VIP å·²è½¬ç§»åˆ°slave1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWNlink/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00inet 127.0.0.1/8 scope host loinet6 ::1/128 scope hostvalid\\_lft forever preferred\\_lft forever2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER\\_UP&gt; mtu 1500 qdisc pfifo\\_fast state UP qlen 1000link/ether 00:0c:29:5d:7d:94 brd ff:ff:ff:ff:ff:ffinet 192.168.254.47/24 brd 192.168.254.255 scope global eth0inet6 fe80::20c:29ff:fe5d:7d94/64 scope linkvalid\\_lft forever preferred\\_lft forever\\[root@master keepalived\\]#slave:\\[root@slave keepalived\\]# ip a..............inet 192.168.254.200/32 scope global eth0&nbsp;&nbsp; #-&gt;VIP å·²è½¬ç§»è¿‡æ¥..............\\[root@slave keepalived\\]#&nbsp; **è‡³æ­¤è‡ªå†™ç›‘æµ‹è„šæœ¬ï¼Œå®Œæˆç»´æŠ¤æ¨¡å¼åˆ‡æ¢ï¼Œå·²ç»å®Œæˆï¼›ä¸‹é¢æ¥è§£å†³æœ€åä¸€ä¸ªé—®é¢˜ï¼š** **4.3.****å¦‚ä½•åœ¨****Keepalived****ä¸»ä»åˆ‡æ¢æ—¶å‘ç®¡ç†å‘˜å‘é€é€šçŸ¥é‚®ä»¶ï¼Ÿ** (1)Keepalivedé€šçŸ¥è„šæœ¬è¿›é˜¶ç¤ºä¾‹ï¼šä¸‹é¢çš„è„šæœ¬å¯ä»¥æ¥å—é€‰é¡¹ï¼Œå…¶ä¸­ï¼š-s, --service SERVICE,...ï¼šæŒ‡å®šæœåŠ¡è„šæœ¬åç§°ï¼Œå½“çŠ¶æ€åˆ‡æ¢æ—¶å¯è‡ªåŠ¨å¯åŠ¨ã€é‡å¯æˆ–å…³é—­æ­¤æœåŠ¡ï¼›-a, --address VIP: æŒ‡å®šç›¸å…³è™šæ‹Ÿè·¯ç”±å™¨çš„VIPåœ°å€ï¼›-m, --mode {mm|mb}ï¼šæŒ‡å®šè™šæ‹Ÿè·¯ç”±çš„æ¨¡å‹ï¼Œmmè¡¨ç¤ºä¸»ä¸»ï¼Œmbè¡¨ç¤ºä¸»å¤‡ï¼›å®ƒä»¬è¡¨ç¤ºç›¸å¯¹äºåŒä¸€ç§æœåŠ¡è€Œæ–¹ï¼Œå…¶VIPçš„å·¥ä½œç±»å‹ï¼›-n, --notify {master|backup|fault}ï¼šæŒ‡å®šé€šçŸ¥çš„ç±»å‹ï¼Œå³vrrpè§’è‰²åˆ‡æ¢çš„ç›®æ ‡è§’è‰²ï¼›-h, --helpï¼šè·å–è„šæœ¬çš„ä½¿ç”¨å¸®åŠ©ï¼›#!/bin/bash\\# Author: Tux\\# description: An example of notify script\\# Usage: notify.sh -m|--mode {mm|mb} -s|--service SERVICE1,... -a|--address VIP&amp;nbsp; -n|--notify {master|backup|falut} -h|--help&amp;nbsp;helpflag=0serviceflag=0modeflag=0addressflag=0notifyflag=0contact='2399447849@qq.com'&amp;nbsp;&amp;nbsp; #-&gt;æŒ‡å®šè”ç³»äºº;å¯ä»¥æœ‰å¤šä¸ªï¼Œç”¨â€,â€åˆ†éš”å¼€æ¥&lt;br&gt;Usage() { echo \"Usage: notify.sh \\[-m|--mode {mm|mb}\\] \\[-s|--service SERVICE1,...\\] &lt;-a|--address VIP&gt; &lt;-n|--notify {master|backup|falut}&gt;\" echo \"Usage: notify.sh -h|--help\"}########################################################################################ParseOptions() { local I=1; if \\[ $# -gt 0 \\]; then while \\[ $I -le $# \\]; do case $1 in -s|--service) \\[ $# -lt 2 \\] &amp;&amp; return 3 serviceflag=1 services=(\\`echo $2|awk -F\",\" '{for(i=1;i&lt;=NF;i++) print $i}'\\`) shift 2 ;; -h|--help) helpflag=1 return 0 shift ;; -a|--address) \\[ $# -lt 2 \\] &amp;&amp; return 3 addressflag=1 vip=$2 shift 2 ;; -m|--mode) \\[ $# -lt 2 \\] &amp;&amp; return 3 mode=$2 shift 2 ;; -n|--notify) \\[ $# -lt 2 \\] &amp;&amp; return 3 notifyflag=1 notify=$2 shift 2 ;; *) echo \"Wrong options...\" Usage return 7 ;; esac done return 0 fi}#workspace=$(dirname $0)RestartService() { if \\[ ${#@} -gt 0 \\]; then for I in $@; do if \\[ -x /etc/rc.d/init.d/$I \\]; then /etc/rc.d/init.d/$I restart else echo \"$I is not a valid service...\" fi done fi}StopService() { if \\[ ${#@} -gt 0 \\]; then for I in $@; do if \\[ -x /etc/rc.d/init.d/$I \\]; then /etc/rc.d/init.d/$I stop else echo \"$I is not a valid service...\" fi done fi}Notify() { mailsubject=\"\\`hostname\\` to be $1: $vip floating\" mailbody=\"\\`date '+%F %H:%M:%S'\\`, vrrp transition, \\`hostname\\` changed to be $1.\" echo $mailbody | mail -s \"$mailsubject\" $contact}\\# Main FunctionParseOptions $@\\[ $? -ne 0 \\] &amp;&amp; Usage &amp;&amp; exit 5\\[ $helpflag -eq 1 \\] &amp;&amp; Usage &amp;&amp; exit 0if \\[ $addressflag -ne 1 -o $notifyflag -ne 1 \\]; then Usage exit 2fimode=${mode:-mb}case $notify in'master') if \\[ $serviceflag -eq 1 \\]; then RestartService ${services\\[*\\]} fi Notify master ;;'backup') if \\[ $serviceflag -eq 1 \\]; then if \\[ \"$mode\" == 'mb' \\]; then StopService ${services\\[*\\]} else RestartService ${services\\[*\\]} fi fi Notify backup ;;'fault') Notify fault ;;*) Usage exit 4 ;;esac(2) åœ¨keepalived.confé…ç½®æ–‡ä»¶ä¸­ï¼Œå…¶è°ƒç”¨æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼šnotify\\_master \"/etc/keepalived/notify.sh -n master -a VIP\\_address\"notify\\_backup \"/etc/keepalived/notify.sh -n backup -a VIP\\_address\"notify\\_fault \"/etc/keepalived/notify.sh -n fault -a VIP\\_address\"(3)ä¿®æ”¹master/slave çš„keepalivedé…ç½®æ–‡ä»¶ï¼šã€ &nbsp;master:\\[root@master ~\\]# vim /etc/keepalived/keepalived.conf! Configuration File for keepalivedglobal_defs {notification_email {2399447849@qq.com}notification\\_email\\_from rootsmtp_server 127.0.0.1smtp\\_connect\\_timeout 30router\\_id LVS\\_DEVEL}&nbsp;vrrp\\_script chk\\_schedown {script \"\\[ -e /etc/keepalived/down \\] &amp;&amp; exit 1 || exit 0\"interval 1weight -5fall 2rise 1}vrrp\\_instance VI\\_1 {state MASTERinterface eth0virtual\\_router\\_id 60priority 101advert_int 1authentication {auth_type PASSauth_pass 1111}virtual_ipaddress {192.168.254.200}track_script { chk_schedown}#-&gt;å¢åŠ ä»¥ä¸‹ä¸‰è¡Œ(æ³¨ï¼šåœ¨slaveä¸Šé¢ä¹Ÿä¸€æ ·æ·»åŠ è¿™ä¸‰è¡Œï¼Œæ­¤å¤„ç•¥)&nbsp;&nbsp;&nbsp; notify_master \"/etc/keepalived/notify.sh -n master -a 192.168.254.200\"&nbsp;&nbsp;&nbsp; notify_backup \"/etc/keepalived/notify.sh -n backup -a 192.168.254.200\"&nbsp;&nbsp;&nbsp; notify_fault \"/etc/keepalived/notify.sh -n fault -a 192.168.254.200\"}&nbsp;virtual_server 192.168.254.200 80 {delay_loop 6lb_algo rrlb_kind DRnat_mask 255.255.255.0#persistence_timeout 50protocol TCP&nbsp;real_server 192.168.254.45 80&nbsp; {weight 1HTTP_GET { url { path / status_code 200}connect_timeout 3nb\\_get\\_retry 3delay\\_before\\_retry 3}}real_server 192.168.254.46 80 {weight 1HTTP_GET {url {path /status_code 200}connect_timeout 3nb\\_get\\_retry 3delay\\_before\\_retry 3}}sorry_server 127.0.0.1 80}&nbsp; (4)æ·»åŠ è„šæœ¬ï¼š è®²ä¸Šè¿°çš„è„šæœ¬æ·»åŠ è‡³masterå’Œslaveçš„/etc/keepalived/ç›®å½•ä¸‹(æ³¨æ„æƒé™)ï¼š\\[root@master ~\\]# ll /etc/keepalivedæ€»ç”¨é‡ 8-rw-r--r--. 1 root root 1748 10æœˆ 30 17:08 keepalived.conf-rwxr-xr-x. 1 root root 2380 10æœˆ 30 00:57 notify.sh\\[root@master ~\\]#&nbsp;#-&gt;å¤åˆ¶è‡³slave\\[root@master ~\\]# scp /etc/keepalived/notify.sh 192.168.254.48:/etc/keepalived/(5)æµ‹è¯•ä¸€ä¸‹è„šæœ¬å¯ç”¨æ€§ï¼š\\[root@slave keepalived\\]# ./notify.sh --helpUsage: notify.sh \\[-m|--mode {mm|mb}\\] \\[-s|--service SERVICE1,...\\] &lt;-a|--address VIP&gt;&nbsp; &lt;-n|--notify {master|backup|falut}&gt;Usage: notify.sh -h|--help\\[root@slave keepalived\\]# ./notify.sh -m mb -a 2.2.2.2 -n master\\[root@slave keepalived\\]#æŸ¥çœ‹é‚®ä»¶: [![12](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/12.png)](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/12.png) åœ¨æ¨¡æ‹Ÿæ•…éšœæ—¶é‡å¯ä¸€ä¸‹keepalived,ä»¥å…å‰é¢çš„å®éªŒé€ æˆå½±å“ã€‚ æ³¨ï¼šç°åœ¨å·²ç»å¯ä»¥æˆåŠŸæ”¶åˆ°é‚®ä»¶ï¼Œé€šçŸ¥è„šæœ¬å¯ç”¨ï¼› (6)æ•…éšœæ¨¡æ‹Ÿï¼š &lt;1&gt;å…ˆé‡å¯ä¸»å¤‡keepalivedæœåŠ¡master:\\[root@master ~\\]# service keepalived restartåœæ­¢ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]æ­£åœ¨å¯åŠ¨ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]\\[root@master ~\\]#slave:\\[root@slave ~\\]# service keepalived restartåœæ­¢ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\[ç¡®å®š\\]æ­£åœ¨å¯åŠ¨ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \\[ç¡®å®š\\]\\[root@slave ~\\]#&lt;2&gt;æ­£å¸¸æƒ…å†µä¸‹æ­¤æ—¶VIPåœ¨masterä¸Šé¢master:\\[root@master ~\\]# ip a..............inet 192.168.254.200/32 scope global eth0..............\\[root@master ~\\]#&lt;3&gt;åœ¨masterçš„/etc/keepalivedç›®å½•ä¸‹ touchä¸€ä¸ªæ–‡ä»¶â€downâ€master:\\[root@master keepalived\\]# touch down&lt;4&gt;è§‚å¯ŸVIP è½¬ç§»æƒ…å†µslave:\\[root@slave ~\\]# ip a..............inet 192.168.254.200/32 scope global eth0..............\\[root@slave ~\\]# &lt;5&gt;ç»“æœæŸ¥çœ‹â€”&gt;é‚®ä»¶æ”¶å– &lt;6&gt;Clientè®¿é—®æµ‹è¯• ä»ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œåœ¨keepalivedä¸»å¤‡åˆ‡æ¢æ—¶ï¼Œä¸ä»…èƒ½å¤Ÿå‘é€é‚®ä»¶ï¼Œè€Œä¸”è®¿é—®æœåŠ¡ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼› è‡³æ­¤Lvs+Keepalivedçš„åŸºæœ¬åº”ç”¨å®éªŒæ¼”ç¤ºå®Œæ¯•ï¼","categories":[{"name":"è´Ÿè½½å‡è¡¡","slug":"è´Ÿè½½å‡è¡¡","permalink":"https://blog.sctux.cc/categories/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"}],"tags":[{"name":"Floating","slug":"Floating","permalink":"https://blog.sctux.cc/tags/Floating/"},{"name":"keepalived","slug":"keepalived","permalink":"https://blog.sctux.cc/tags/keepalived/"},{"name":"lvs","slug":"lvs","permalink":"https://blog.sctux.cc/tags/lvs/"}],"keywords":[{"name":"è´Ÿè½½å‡è¡¡","slug":"è´Ÿè½½å‡è¡¡","permalink":"https://blog.sctux.cc/categories/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"}]},{"title":"Tomcatç¯å¢ƒæ­å»ºåŠjspç«™ç‚¹å®ç°","slug":"tomcat-e7-8e-af-e5-a2-83-e6-90-ad-e5-bb-ba-e5-8f-8ajsp-e7-ab-99-e7-82-b9-e5-ae-9e-e7-8e-b0","date":"2014-08-28T03:31:53.000Z","updated":"2025-09-01T01:59:08.877Z","comments":true,"path":"2014/08/28/tomcat-e7-8e-af-e5-a2-83-e6-90-ad-e5-bb-ba-e5-8f-8ajsp-e7-ab-99-e7-82-b9-e5-ae-9e-e7-8e-b0/","permalink":"https://blog.sctux.cc/2014/08/28/tomcat-e7-8e-af-e5-a2-83-e6-90-ad-e5-bb-ba-e5-8f-8ajsp-e7-ab-99-e7-82-b9-e5-ae-9e-e7-8e-b0/","excerpt":"&nbsp; å®‰è£…JDK(é…ç½®javaç¯å¢ƒ)ï¼š ç¯å¢ƒï¼šCentOS6.5_x86-64bit ä¸€ã€å…ˆå®‰è£…JVM 1.ä½¿ç”¨7ç‰ˆæœ¬çš„jdk(åˆ°å®˜ç½‘ä¸‹è½½ç›¸åº”çš„è½¯ä»¶åŒ…åˆ°æœ¬åœ°http://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase7-521261.html#jre-7u9-oth-JPR) [root@localhost ~]# rpm -ivh jdk-7u9-linux-x64.rpmPreparingâ€¦ ########################################### [100%]1:jdk ########################################### [100%]Unpacking JAR filesâ€¦rt.jarâ€¦Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/rt.packjsse.jar..Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/jsse.packcharsets.jarâ€¦Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/charsets.packtools.jarâ€¦Error: Could not open input file: /usr/java/jdk1.7.0_09/lib/tools.packlocaledata.jarâ€¦Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/ext/localedata.pack#-&gt;ä»¥ä¸Šé‚£äº›é”™è¯¯å¯ä»¥å¿½ç•¥ï¼Œä¸å½±å“jdkåˆ°å®‰è£…å’Œä½¿ç”¨ 2.å®‰è£…åç”Ÿæˆçš„æ–‡ä»¶ï¼š [root@localhost ~]# cd /usr/java/[root@localhost java]# lltotal 4lrwxrwxrwx 1 root root 16 May 6 10:58 default -&gt; /usr/java/latestdrwxr-xr-x 10 root root 4096 May 6 10:58 jdk1.7.0_09lrwxrwxrwx 1 root root 21 May 6 10:58 latest -&gt; /usr/java/jdk1.7.0_09 3.ä¿®æ”¹javaç¯å¢ƒå˜é‡ï¼š [root@localhost ~]# vim /etc/profile.d/java.shexport JAVA_HOME=/usr/java/latestexport PATH=$JAVA_HOME/bin:$PATH[root@localhost ~]# . /etc/profile.d/java.sh 4.æµ‹è¯•javaç¯å¢ƒæ˜¯å¦å¯ç”¨. [root@localhost java]# java -versionjava version â€œ1.7.0_09â€Java(TM) SE Runtime Environment (build 1. 7.0_09-b05)Java HotSpot(TM) 64-Bit Server VM (build 23.5-b02, mixed mode)[root@localhost java]# æ­¤æ—¶åªæ˜¯éƒ¨ç½²å¥½äº†javaç¯å¢ƒ,è€Œå¹¶éè¿è¡Œä»»ä½•çš„JAVAç¨‹åº,è€ŒTomcatå°±æ˜¯è¿è¡Œåœ¨è¿™ä¸ªç¯å¢ƒä¸Šé¢çš„JAVAç¨‹åº äºŒã€å®‰è£…é…ç½®tomcat 1.è·å–è½¯ä»¶åŒ…å¹¶è§£å‹å®‰è£…ï¼š [root@localhost ~]# wget http://apache.fayea.com/apache-mirror/tomcat/tomcat-7/v7.0.55/bin/apache-tomcat-7.0.55.tar.gz[root@localhost ~]# tar -xf apache-tomcat-7.0.55.tar.gz -C /usr/local/[root@localhost ~]# cd /usr/local/[root@localhost local]# ln -sv apache-tomcat-7.0.5 tomcat`tomcatâ€™ -&gt; `apache-tomcat-7.0.55â€™[root@localhost local]# cd tomcat/[root@localhost tomcat]#","text":"&nbsp; å®‰è£…JDK(é…ç½®javaç¯å¢ƒ)ï¼š ç¯å¢ƒï¼šCentOS6.5_x86-64bit ä¸€ã€å…ˆå®‰è£…JVM 1.ä½¿ç”¨7ç‰ˆæœ¬çš„jdk(åˆ°å®˜ç½‘ä¸‹è½½ç›¸åº”çš„è½¯ä»¶åŒ…åˆ°æœ¬åœ°http://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase7-521261.html#jre-7u9-oth-JPR) [root@localhost ~]# rpm -ivh jdk-7u9-linux-x64.rpmPreparingâ€¦ ########################################### [100%]1:jdk ########################################### [100%]Unpacking JAR filesâ€¦rt.jarâ€¦Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/rt.packjsse.jar..Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/jsse.packcharsets.jarâ€¦Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/charsets.packtools.jarâ€¦Error: Could not open input file: /usr/java/jdk1.7.0_09/lib/tools.packlocaledata.jarâ€¦Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/ext/localedata.pack#-&gt;ä»¥ä¸Šé‚£äº›é”™è¯¯å¯ä»¥å¿½ç•¥ï¼Œä¸å½±å“jdkåˆ°å®‰è£…å’Œä½¿ç”¨ 2.å®‰è£…åç”Ÿæˆçš„æ–‡ä»¶ï¼š [root@localhost ~]# cd /usr/java/[root@localhost java]# lltotal 4lrwxrwxrwx 1 root root 16 May 6 10:58 default -&gt; /usr/java/latestdrwxr-xr-x 10 root root 4096 May 6 10:58 jdk1.7.0_09lrwxrwxrwx 1 root root 21 May 6 10:58 latest -&gt; /usr/java/jdk1.7.0_09 3.ä¿®æ”¹javaç¯å¢ƒå˜é‡ï¼š [root@localhost ~]# vim /etc/profile.d/java.shexport JAVA_HOME=/usr/java/latestexport PATH=$JAVA_HOME/bin:$PATH[root@localhost ~]# . /etc/profile.d/java.sh 4.æµ‹è¯•javaç¯å¢ƒæ˜¯å¦å¯ç”¨. [root@localhost java]# java -versionjava version â€œ1.7.0_09â€Java(TM) SE Runtime Environment (build 1. 7.0_09-b05)Java HotSpot(TM) 64-Bit Server VM (build 23.5-b02, mixed mode)[root@localhost java]# æ­¤æ—¶åªæ˜¯éƒ¨ç½²å¥½äº†javaç¯å¢ƒ,è€Œå¹¶éè¿è¡Œä»»ä½•çš„JAVAç¨‹åº,è€ŒTomcatå°±æ˜¯è¿è¡Œåœ¨è¿™ä¸ªç¯å¢ƒä¸Šé¢çš„JAVAç¨‹åº äºŒã€å®‰è£…é…ç½®tomcat 1.è·å–è½¯ä»¶åŒ…å¹¶è§£å‹å®‰è£…ï¼š [root@localhost ~]# wget http://apache.fayea.com/apache-mirror/tomcat/tomcat-7/v7.0.55/bin/apache-tomcat-7.0.55.tar.gz[root@localhost ~]# tar -xf apache-tomcat-7.0.55.tar.gz -C /usr/local/[root@localhost ~]# cd /usr/local/[root@localhost local]# ln -sv apache-tomcat-7.0.5 tomcat`tomcatâ€™ -&gt; `apache-tomcat-7.0.55â€™[root@localhost local]# cd tomcat/[root@localhost tomcat]# 2.æ›´æ”¹tomcatç¯å¢ƒå˜é‡ï¼š [root@localhost ~]# vim /etc/profile.d/tomcat.shexport CATALINA_HOME=/usr/local/tomcatexport PATH=$CATALINA_HOME/bin/:$PATH[root@localhost ~]# . /etc/profile.d/tomcat 3.å¯åŠ¨tomcat [root@localhost tomcat]# catalina.sh start 4.éªŒè¯æ˜¯å¦å¯åŠ¨ [root@localhost tomcat]# ss -tunlp | grep javatcp LISTEN 0 100 :::8080 :::* users:((â€œjavaâ€,25953,42))tcp LISTEN 0 1 ::ffff:127.0.0.1:8005 :::* users:((â€œjavaâ€,25953,46))tcp LISTEN 0 100 :::8009 :::* users:((â€œjavaâ€,25953,43))#â€”&gt;æ³¨æ„ä¸‰ä¸ªç«¯å£ï¼Œæ¯ä¸€ä¸ªå•ç‹¬çš„javaç¨‹åºéƒ½æ˜¯ç”±ä¸€ä¸ªjvmæ¥è¿è¡Œçš„.[root@localhost tomcat]# jps25953 Bootstrap #â€”&gt;è¿™ä¸ªè¿›ç¨‹æ˜¯tomcatå¯åŠ¨æ—¶ä¸ºäº†å®ç°å…¶åŠ é€Ÿçš„ä¸€ä¸ªç¨‹åº.æœ‰è¿™ä¸ªè¿›ç¨‹åˆ™è¡¨ç¤ºå¯åŠ¨æˆåŠŸ.25995 Jps[root@localhost tomcat]# 5.ç½‘é¡µè®¿é—®æµ‹è¯•ï¼šhttp://IP:8080 ç°åœ¨tomcatå·²ç»å¯åŠ¨äº†,æ³¨æ„ä¸Šå›¾ä¸­çš„ä¸‰ä¸ªæŒ‰é’®,åç»­è¯´. 6.ä¸ºäº†æ–¹ä¾¿ç®¡ç†tomcatï¼Œä¸ºå…¶æä¾›SysVç®¡ç†è„šæœ¬. [root@localhost ~]# vim /etc/rc.d/init.d/tomcat#!/bin/sh# Tomcat init script for Linux. # chkconfig: 2345 96 14# description: The Apache Tomcat servlet/JSP container.JAVA_HOME=/usr/java/latestCATALINA_HOME=/usr/local/tomcatexport JAVA_HOME CATALINA_HOME. /etc/init.d/functions case $1 instart) $CATALINA_HOME/bin/catalina.sh start &amp;&gt;/dev/null;;stop) $CATALINA_HOME/bin/catalina.sh stop &amp;&gt;/dev/null;; restart)$CATALINA_HOME/bin/catalina.sh stop &amp;&gt;/dev/null sleep 2 $CATALINA_HOME/bin/catalina.sh start &amp;&gt;/dev/null;;*) echo â€œUsage:`basename $0` {start|stop|restart}â€exit 1;;esac[root@localhost ~]# chmod +X /etc/rc.d/init.d/tomcat[root@localhost ~]# chkconfig â€“add tomcat#-&gt;é€šè¿‡ä¸Šé¢è¿™ä¸ªæœåŠ¡æ§åˆ¶è„šæœ¬å°±å¯ä»¥æ§åˆ¶tomcatçš„å¯åŠ¨ã€å…³é—­ç­‰æ“ä½œäº†; 7.Tomcat é…ç½®æ–‡ä»¶é…ç½®å±‚æ¬¡ï¼š Tomcatæ˜¯ä¸€ä¸ªåŸºäºç»„ä»¶çš„æœåŠ¡å™¨ï¼Œå®ƒçš„æ„æˆç»„ä»¶éƒ½æ˜¯å¯é…ç½®çš„ï¼Œå…¶ä¸­æœ€å¤–å±‚çš„ç»™ä»¶æ˜¯CATALINA SERVLETå®¹å™¨ï¼Œå…¶ä»–çš„ç»„ä»¶æŒ‰ç…§ä¸€å®šçš„æ ¼å¼è¦æ±‚é…ç½®åœ¨è¿™ä¸ªé¡¶å±‚å®¹å™¨ä¸­ã€‚Tomcatçš„å„ä¸ªç»„ä»¶æ˜¯server.xmlæ–‡ä»¶ä¸­é…ç½®çš„ï¼ŒTomcatæœåŠ¡å™¨é»˜è®¤æƒ…å†µä¸‹å¯¹å„ç§ç»„ä»¶éƒ½æœ‰é»˜è®¤çš„å®ç°ï¼Œä¸‹é¢é€šè¿‡åˆ†æserver.xmlæ–‡ä»¶æ¥ç†è§£Tomcatçš„å„ä¸ªç»„ä»¶æ˜¯å¦‚ä½•ç»„ç»‡çš„ã€‚ #â€”&gt;é¡¶å±‚ç»„ä»¶ï¼Œä»£è¡¨ä¸€ä¸ªæœåŠ¡å™¨ #â€”&gt;é¡¶å±‚ç»„ä»¶ï¼Œæ˜¯Connectorçš„é›†åˆï¼Œå°†è¿æ¥å™¨å…³è”è‡³engineï¼›å› æ­¤ä¸€ä¸ªserviceå†…éƒ¨å¯ä»¥æœ‰å¤šä¸ªconnectorï¼Œä½†åªèƒ½æœ‰ä¸€ä¸ªengine #â€”&gt;è¿æ¥å™¨ç±»ç»„ä»¶ï¼Œä»£è¡¨é€šä¿¡æ¥å£ #â€”&gt;å®¹å™¨ç±»ç»„ä»¶ï¼Œä¸ºç‰¹å®šçš„Serviceç»„ä»¶å¤„ç†æ‰€æœ‰å®¢æˆ·è¯·æ±‚ï¼Œå¯åŒ…å«å¤šä¸ªHost #â€”&gt;ä¸ºç‰¹å®šçš„è™šæ‹Ÿä¸»æœºå¤„ç†æ‰€æœ‰å®¢æˆ·è¯·æ±‚ #â€”&gt;ä¸ºç‰¹å®šçš„WEBåº”ç”¨å¤„ç†æ‰€æœ‰å®¢æˆ·è¯·æ±‚ è¯¦è¿°è¿™äº›ç»„ä»¶ï¼š **é¡¶çº§ç»„ä»¶ï¼š**ä½äºæ•´ä¸ªé…ç½®çš„é¡¶å±‚ï¼› **å®¹å™¨ç±»ï¼š**å¯ä»¥åŒ…å«å…¶å®ƒç»„ä»¶çš„ç»„ä»¶ï¼›&nbsp; &nbsp; &nbsp;engine: æ ¸å¿ƒå®¹å™¨ï¼Œcatalinaå¼•æ“ï¼Œè´Ÿè´£é€šè¿‡connectoræ¥æ”¶ç”¨æˆ·è¯·æ±‚,åœ¨ä¸€ä¸ªenginå†…éƒ¨å¯ä»¥æœ‰å¤šä¸ªhost&nbsp; &nbsp; &nbsp;host: ç±»ä¼¼äºhttpdä¸­çš„è™šæ‹Ÿä¸»æœºï¼›æ”¯æŒåŸºäºFQDNçš„è™šæ‹Ÿä¸»æœº&nbsp;&nbsp;&nbsp;&nbsp; context: æœ€å†…å±‚çš„å®¹å™¨ç±»ç»„ä»¶ï¼Œä¸€ä¸ªcontextä»£è¡¨ä¸€ä¸ªwebåº”ç”¨ç¨‹åºï¼›é…ç½®contextçš„ä¸»è¦ç›®çš„ï¼ŒæŒ‡å®šå¯¹åº”çš„webappçš„æ ¹ç›®å½•ï¼›è¿˜èƒ½ä¸ºwebappæŒ‡å®šé¢å¤–çš„å±æ€§ï¼Œå¦‚éƒ¨ç½²æ–¹å¼ç­‰ï¼› **è¿æ¥å™¨ç»„ä»¶ï¼š**è¿æ¥ç”¨æˆ·è¯·æ±‚è‡³tomcatï¼› ä¸¤ç±»è¿æ¥å™¨ï¼š 1.åŸºäºHTTP åè®® 2.åŸºäºAJP äºŒè¿›åˆ¶åè®®,ä½¿ç”¨httpdåå‘ä»£ç†ç”¨æˆ·è¯·æ±‚è‡³tomcatæ—¶,åœ¨httpdå’Œtomcatä¹‹é—´ä½¿ç”¨.è¢«åµŒå¥—ç±»çš„ç»„ä»¶ï¼šä½äºä¸€ä¸ªå®¹å™¨å½“ä¸­ï¼Œä¸èƒ½åŒ…å«å…¶å®ƒç»„ä»¶ï¼› **è¢«åµŒå¥—ç±»çš„ç»„ä»¶ï¼š**ä½äºä¸€ä¸ªå®¹å™¨å½“ä¸­ï¼Œä¸èƒ½åŒ…å«å…¶å®ƒç»„ä»¶ï¼› valve: æ‹¦æˆªè¯·æ±‚å¹¶åœ¨å°†å…¶è½¬è‡³å¯¹åº”çš„webappä¹‹å‰è¿›è¡ŒæŸç§å¤„ç†æ“ä½œï¼›å¯ä»¥ç”¨äºä»»ä½•å®¹å™¨ä¸­ï¼›&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; access log valve:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; remote address filter value: åŸºäºIPåšè®¿é—®æ§åˆ¶&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger: æ—¥å¿—è®°å½•å™¨ï¼Œç”¨äºè®°å½•ç»„ä»¶ å†…éƒ¨çš„çŠ¶æ€ä¿¡æ¯(å¯ç”¨äºé™¤contextä¹‹å¤–çš„ä»»ä½•å®¹å™¨ä¸­)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; realm: å¯ä»¥ç”¨äºä»»ä½•å®¹å™¨ç±»çš„ç»„ä»¶ä¸­ï¼Œå…³è”ä¸€ä¸ªç”¨æˆ·è®¤è¯åº“ï¼Œå®ç°è®¤è¯å’Œæˆæƒï¼›&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UserDatabaseRealm: ä½¿ç”¨JNDIè‡ªå®šä¹‰çš„ç”¨æˆ·è®¤è¯åº“ï¼›&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MemoryRealm: tomcat-users.xmlä¸­&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JDBCRealm: åŸºäºJDBCè¿æ¥è‡³æ•°æ®åº“ä¸­æŸ¥æ‰¾ç”¨æˆ·ï¼› **éƒ¨ç½²:**ä½¿ç”¨ç±»åŠ è½½å™¨,ä¸ºwebappå‡†å¤‡å¥½å…¶ä¾èµ–æ‰€æœ‰ç±». 8.æœåŠ¡ç«¯å£è¯´æ˜ï¼š åœ¨æˆ‘ä»¬å¯åŠ¨ä¹‹åæœ‰3ä¸ªç«¯å£ï¼š8005ï¼Œ8009ï¼Œ8080 8005 &nbsp;==&gt;ä½äºserveré¡¶çº§ç»„ä»¶å½“ä¸­,å®ƒç›‘å¬äºæœ¬åœ°&lt;127.0.0.1&gt; é€šè¿‡è¿™ä¸ªportæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨æœ¬åœ°å…³é—­tomcatåº”ç”¨ç¨‹åº,ä»¥åŠjavaè¿›ç¨‹. å¦‚ä¸‹ï¼š (1)åœ¨æœ¬æœºå®‰è£…telnet ;&nbsp; [root@localhost ~]# yum install -y telnet (2)è¿æ¥æœ¬æœº8005port,å‘é€â€SHUTDOWNâ€æŒ‡ä»¤ [root@localhost ~]# telnet localhost 8005 #â€“&gt;telnetæœ¬åœ°8005portTrying ::1â€¦telnet: connect to address ::1: Connection refusedTrying 127.0.0.1â€¦Connected to localhost.Escape character is â€˜^]â€˜.SHUTDOWN #â€“&gt;å‘é€â€SHUTDOWNâ€æŒ‡ä»¤ï¼Connection closed by foreign host.[root@node1 ~]# ss -tunlp | grep java #â€“&gt;æ­¤æ—¶å†å»æ£€æŸ¥ç«¯å£,æ˜¾ç¤ºæ²¡æœ‰,è¯´æ˜æˆ‘ä»¬é€šè¿‡telnetå·²ç»å‘é€æŒ‡ä»¤å°†å…¶å…³é—­æˆåŠŸå•¦,å±é™©ç³»æ•°è¾ƒé«˜,é…ç½®æœåŠ¡å®‰å…¨æ€§æ—¶éœ€æ³¨æ„ï¼[root@node1 ~]# service tomcat start #â€“&gt;å†æ¬¡å¯åŠ¨,æ£€æŸ¥ç«¯å£æ­£å¸¸å¦.[root@node1 ~]# ss -tunlp | grep javatcp LISTEN 0 100 :::8080 :::* users:((â€œjavaâ€,6430,42))tcp LISTEN 0 1 ::ffff:127.0.0.1:8005 :::* users:((â€œjavaâ€,6430,46))tcp LISTEN 0 100 :::8009 :::* users:((â€œjavaâ€,6430,43))[root@node1 ~]# **&nbsp;8009ï¼Œ8080 &nbsp;==&gt;**å‰é¢å·²è¯´åˆ°äº†åœ¨è¿æ¥å™¨ç»„ä»¶å½“ä¸­æœ‰ä¸ª,ä»–ä»¬åœ¨è¿™ä¸ªç»„ä»¶å½“ä¸­åˆ†åˆ«å¯¹åº”äº†ä¸¤ç§åè®®. 8009 &nbsp;&nbsp;åŸºäºAJDåè®® 8080 &nbsp;åŸºäºhttpåè®®,å½“ç„¶åœ¨ä¸­å¯ä»¥æ·»åŠ å„ç§å‚æ•°,ä¾‹å¦‚â€addressâ€ç­‰,é»˜è®¤é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æŒ‡å®šipåœ°å€,é»˜è®¤å°±æ˜¯ç›‘å¬æ‰€æœ‰.è¿™ä¸ªç«¯å£ä¸€èˆ¬ä¿®æ”¹ä¸º80. ä¸‰ã€è™šæ‹Ÿä¸»æœºå®šä¹‰ï¼š (1)åˆ›å»ºç½‘é¡µç›®å½•ï¼š [root@node1 ~]# mkdir /www/webapps/ROOT (2)åˆ›å»ºç½‘é¡µæµ‹è¯•æ–‡ä»¶: [root@localhost ~]# vim /www/webapps/ROOT/index.jsp&lt;%@ page language=â€javaâ€ %&gt;&lt;%@ page import=â€java.util.*â€ %&gt; JSP test page. &lt;% out.println(\"hello,world!\"); %&gt; (3)ä¿®æ”¹é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š [root@node1 ~]# vim /usr/local/tomcat/conf/server.xmlâ€¦â€¦â€¦â€¦ â€¦..â€¦.. &lt;Valve className=â€org.apache.catalina.valves.AccessLogValveâ€ directory=â€logsâ€ #-&gt;æ—¥å¿—ä¿å­˜æ ¼å¼ prefix=â€www.aaa.www_log.â€ suffix=â€.txtâ€ pattern=â€%h %l %u %t \"%r\" %s %bâ€ /&gt;â€¦â€¦â€¦â€¦ (4)é‡å¯æœåŠ¡æµ‹è¯•ï¼š [root@localhost ~]# service tomcat restart æ³¨æ„:æ­¤å¤„æˆ‘å·²ç»å¯¹è¯¥æœåŠ¡å™¨åšäº†è§£æ. (5)è™šæ‹Ÿä¸»æœºçš„åˆ«åæœºåˆ¶ï¼š [root@node1 ~]# vim /usr/local/tomcat/conf/server.xmlâ€¦â€¦â€¦â€¦ â€¦..â€¦.. #â€”&gt;åœ¨åŸæœ‰è™šæ‹Ÿä¸»æœºä¸­æ·»åŠ ä¸€ä¸ªContext &lt;Valve className=â€org.apache.catalina.valves.AccessLogValveâ€ directory=â€logsâ€ #-&gt;æ—¥å¿—ä¿å­˜æ ¼å¼ prefix=â€www.aaa.www_log.â€ suffix=â€.txtâ€ pattern=â€%h %l %u %t \"%r\" %s %bâ€ /&gt;â€¦â€¦ #â€”&gt;åˆ›å»ºç›®å½•bbsapp[root@localhost ~]# mkdir /www/webapps/bbsapp#â€”&gt;åˆ›å»ºæµ‹è¯•æ–‡ä»¶[root@localhost ~]# cp /www/webapps/ROOT/index.jsp /www/webapps/bbsapp/index.jsp#â€”&gt;ç¼–è¾‘æµ‹è¯•æ–‡ä»¶,ä¸ä¸Šé¢çš„ä¸åŒå³å¯[root@localhost ~]# vim /www/webapps/bbsapp/index.jsp#â€”&gt;é‡å¯æœåŠ¡æµ‹è¯•[root@localhost ~]# service tomcat restart[root@localhost ~]#â€¦â€¦ å››ã€æœåŠ¡çŠ¶æ€ä¿¡æ¯&amp;Dashboard: åœ¨æœ€å‰é¢çš„é‚£ç§å›¾ç‰‡å½“ä¸­æˆ‘ä»¬çœ‹åˆ°äº†tomcatæœåŠ¡çš„é»˜è®¤ç•Œé¢æœ‰ä¸‰ä¸ªæŒ‰é’®ï¼š &nbsp; å½“æˆ‘ä»¬ç‚¹å‡»â€Server Statusâ€æ—¶,éœ€è¦èº«ä»½éªŒè¯ï¼š ç‚¹å‡»â€å–æ¶ˆâ€,ç½‘é¡µä¼šæç¤ºæˆ‘ä»¬å¦‚ä½•å»ä¿®æ”¹,å¹¶èƒ½å¤Ÿç™»å½•æŸ¥çœ‹çŠ¶æ€ç­‰ä¿¡æ¯. &nbsp;é‚£å°±å»ä¿®æ”¹è¿™ä¸ªé…ç½®æ–‡ä»¶å§ï¼š [root@localhost ~]# vim /usr/local/tomcat/conf/tomcat-users.xmlâ€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦ #â€”&gt;é‡å¯æœåŠ¡[root@varnish ~]# service tomcat restart#â€”&gt;#æµ‹è¯•ï¼š(è¿™é‡Œåªæ˜¯çŠ¶æ€ç•Œé¢,å¦‚æœæƒ³çœ‹å…¶ä»–è¯·çœ‹å¸®åŠ©ä¿¡æ¯)","categories":[{"name":"Webç›¸å…³","slug":"Webç›¸å…³","permalink":"https://blog.sctux.cc/categories/Web%E7%9B%B8%E5%85%B3/"}],"tags":[{"name":"Java","slug":"Java","permalink":"https://blog.sctux.cc/tags/Java/"},{"name":"jdk","slug":"jdk","permalink":"https://blog.sctux.cc/tags/jdk/"},{"name":"tomcat","slug":"tomcat","permalink":"https://blog.sctux.cc/tags/tomcat/"}],"keywords":[{"name":"Webç›¸å…³","slug":"Webç›¸å…³","permalink":"https://blog.sctux.cc/categories/Web%E7%9B%B8%E5%85%B3/"}]},{"title":"Snmpåè®®è¯¦è§£","slug":"snmp-e5-8d-8f-e8-ae-ae-e8-af-a6-e8-a7-a3","date":"2014-08-27T03:16:07.000Z","updated":"2025-09-01T01:59:08.967Z","comments":true,"path":"2014/08/27/snmp-e5-8d-8f-e8-ae-ae-e8-af-a6-e8-a7-a3/","permalink":"https://blog.sctux.cc/2014/08/27/snmp-e5-8d-8f-e8-ae-ae-e8-af-a6-e8-a7-a3/","excerpt":"ç›‘æ§ä¸»æœºçš„æ–¹å¼ï¼š 1.åŸºäºé€šè¡Œçš„snmp 2.åŸºäºä¸“ç”¨agent 3.åŸºäºssh(shell) å¯¹äºä¸åŒçš„ç›‘æ§æŒ‡æ ‡ï¼Œæœ€åå®ç°çš„åŠŸèƒ½ä¹Ÿæœ‰æ‰€ä¸åŒ.ä¸‹é¢æ˜¯æœ¬äººé€šè¿‡å­¦ä¹ æ€»ç»“å…³äºä¸snmpåè®®çš„ä¸€äº›è§£é‡Šä»¥åŠè¿ç”¨ SNMP ä¸»è¦å‡ ä¸ªç®€å•çš„æ“ä½œå°±å¯ä»¥å®ç°å¯¹è¿œç¨‹è®¾å¤‡ä¸Šçš„æœåŠ¡ã€èµ„æºç­‰å„ç§ç³»ç»ŸçŠ¶æ€ä¿¡æ¯çš„è·å–,ä¸ä»…ä»…æ˜¯è·å–ä¿¡æ¯è¿™ä¹ˆç®€å•,è¿˜èƒ½åœ¨è¾¾åˆ°æˆ‘ä»¬è®¾å®šå€¼æˆ–çŠ¶æ€çŠ¶æ€å‘ç”Ÿè½¬æ¢æ—¶èƒ½å‘å¯¹æ–¹å‘é€æ§åˆ¶æŒ‡ä»¤; SNMPçš„å·¥ä½œæœºåˆ¶ï¼š ç›‘æ§ç«¯/ä¸€ä¸ªæˆ–å¤šä¸ªè¢«ç›‘æ§ç«¯ ç›‘æ§ç«¯:NMS,è¿™ä¸ªå¹³å°ä¼šä¸ºç®¡ç†å‘˜æä¾›å‘½ä»¤è¡Œæ¥å£,å¯ä»¥å‘é€snmpæŒ‡ä»¤åˆ°ä»»ä½•ä¸€ä¸ªè¢«ç›‘æ§ä¸»æœº,è€Œåœ¨è¢«ç›‘æ§ç«¯å®‰è£…äº†ä¸€ä¸ªæœåŠ¡è¿›ç¨‹,å®ƒç”¨äºæ¥æ”¶æ¥è‡ªç›‘æ§ç«¯çš„æŸ¥è¯¢è¯·æ±‚, å¹¶ä¸”èƒ½å¤Ÿè§£æå¯¹æ–¹çš„æŸ¥è¯¢è¯·æ±‚,å¹¶å°†æŸ¥è¯¢æ•°æ®è¿”å›ç»™å¯¹æ–¹,æ‰€ä»¥è¿™ä¸ªæœåŠ¡è¿›ç¨‹å¯ä»¥ç§°ä¹‹ä¸ºæ˜¯ä¸€ä¸ªagent,å®ƒåªæ˜¯æ¥æ”¶ä¸€äº›æŸ¥è¯¢æˆ–è€…æ˜¯ç®¡ç†æŒ‡ä»¤è€Œå­˜åœ¨çš„ï¼› ç›‘æ§ç«¯å‘é€è¯·æ±‚â€”&gt;agentæ¥å—è¯·æ±‚(æ ¹æ®æŸ¥è¯¢è¯·æ±‚å†…å®¹)â€”&gt;agentè¿”å›æŸ¥è¯¢è¯·æ±‚åˆ°ç›‘æ§ç«¯. ä½†æ˜¯ä¸Šé¢æœ‰ä¸ªå¼Šç«¯,ä¹Ÿå°±æ˜¯è¯´ä»»ä½•ä¸»æœºè¿æ¥åˆ°æˆ‘ä»¬çš„agentå°±å¯ä»¥å‘é€æŒ‡ä»¤,è¿™æ ·ä¸€æ¥å®‰å…¨æ–¹é¢å°±æœ‰äº†å¾ˆå¤§çš„éšæ‚£,äºæ˜¯åœ¨æ­¤åŸºç¡€ä¸Šé¢å°±å¼•å…¥äº†communitiesåœ¨ç›‘æ§ç«¯å’Œagentä¹‹é—´å»ºç«‹é€šä¿¡çš„;ç›¸å½“äºä¸¤ä¸ªç«¯ä¹‹é—´å‘é€è®¤è¯ä¿¡æ¯,ä½†æ˜¯è¿™ä¸ªè®¤è¯ä¿¡æ¯æ˜¯æ˜æ–‡çš„; SNMPçš„åè®® v1: æ‰€æœ‰çš„å®‰å…¨æœºåˆ¶éƒ½æ˜¯åŸºäºcommunitiesæœºåˆ¶æ¥å®ç°,snmpçš„æ‰€æœ‰æ“ä½œåœ¨æœåŠ¡å™¨ç«¯ã€å®¢æˆ·ç«¯ä¹Ÿæ˜¯åŸºäºcommunitiesæœºåˆ¶æ¥å®ç°,åœ¨æ­¤ç‰ˆæœ¬ä¸­communitiesæœ‰ä¸‰ç§: read-only:åªè¯»,ç›‘æ§ç«¯åªèƒ½åˆ°agentç«¯è·å–ä¿¡æ¯; read-write:è¯»å†™,å¯å‘é€ç®¡ç†æŒ‡ä»¤;æœ‰æƒé™æ“ä½œagentç«¯ trap:agentç«¯ä¸»åŠ¨è”ç³»ç›‘æ§ç«¯ï¼›å¼•èµ·ç›‘æ§ç«¯æ³¨æ„çš„ä¸€ç§æœºåˆ¶ï¼› v2: å¯¹äºv2æ¥è¯´åªæ˜¯å¯¹v1åšäº†å¼ºåŒ–,æ­¤ç‰ˆæœ¬æ˜¯åŸºäºcommunity-string-based,è¿™ä¸ªç‰ˆæœ¬ä¹Ÿå«åšv2cï¼› v3: ç”±äºå‰é¢ä¸¤ä¸ªç‰ˆæœ¬è¿‡äºç®€åŒ–,è®¤è¯æœºåˆ¶è¾ƒä¸ºè–„å¼±,æ•…æ­¤å¢å¼ºäº†å…¶è®¤è¯æœºåˆ¶,æ•°æ®ä¼ è¾“æ–¹é¢ä¹Ÿæœ‰äº†å®‰å…¨æ€§.ä½†æ˜¯åœ¨ä¸‰ä¸ªç‰ˆæœ¬ä¸­ç”¨å¾—æœ€å¤šçš„è¿˜æ˜¯v1ç‰ˆæœ¬,åŸå› æ˜¯ç®€å•; snmp(NMS)åªæ˜¯æä¾›äº†å‘½ä»¤æ¥å£å»å®Œæˆé‡‡é›†æ•°æ®è€Œå·²,å¯¹äºé‡‡é›†åˆ°çš„æ•°æ®ä¿å­˜åœ¨å“ªé‡Œå®ƒä¸ä¼šå…³å¿ƒï¼› snmpè¿™ç§æœºåˆ¶è™½ç„¶å®ç°äº†ç½‘ç»œç®¡ç†åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒåªæ˜¯ä¸€ç§åè®®,æŠŠè¿™ç§åè®®äºˆä»¥å®ç°çš„è½¯ä»¶çš„åŠŸèƒ½ä¹Ÿæ˜¯å„ä¸ç›¸åŒçš„; MIBsç®¡ç†ä¿¡æ¯åº“. OID&lt;å¯¹è±¡æ ‡è¯†ç¬¦&gt; å°†å¤§å¤šæ•°ç›‘æ§å¯¹è±¡å®ƒçš„åç§°å’ŒIDå·ä¹‹é—´çš„å¯¹åº”å…³ç³»; æ¯”å¦‚åœ¨agentç«¯,å®ƒä¸ä»…ä»…è¦æ”¶é›†ä¸»æœºçš„ä¿¡æ¯å¤–è¿˜éœ€è¦ç»´æŒä¸€ä¸ªMIB,è¯·æ±‚è¾¾åˆ°agentç«¯åå®ƒè¦çŸ¥é“è¯·æ±‚çš„å†…å®¹æ˜¯ä»€ä¹ˆ,é‚£ä¹ˆåœ¨agentç«¯å°±ä¼šè®°å½•ä¸‹ç›‘æ§å¯¹è±¡å’ŒIDä¹‹é—´çš„æ˜ å°„å…³ç³»;æ‰€ä»¥ä¸€ä¸ªæ ‡å‡†çš„agentè¦æä¾›è‡³å°‘ä¸€ä¸ªåŸºæœ¬çš„MIB,ä»¥ç»´æŒç›‘æ§å¯¹è±¡;ä¹Ÿå«åšMIB-II,æ ¹æ®ä¸»æœºä¸åŒçš„éœ€è¦,MIBçš„å†…å®¹ä¹Ÿæœ‰æ‰€ä¸åŒï¼› å¤§å¤šæ•°èƒ½å¤ŸåŸºäºsnmpçš„ç®¡ç†åŠŸèƒ½éƒ½å±äºmgmtèŠ‚ç‚¹,è€Œåœ¨mgmtä¸‹é¢çš„è¿™ä¸ªmibä¸‹é¢åˆ™æœ‰ä¼—å¤šçš„ç›‘æ§å¯¹è±¡ï¼Œ1.3.6.1.2.1æ˜¯æ¯ä¸€ä¸ªä¸»æœºæˆ–è®¾å¤‡é»˜è®¤æä¾›çš„MIBçš„æ ‡è¯†ï¼š","text":"ç›‘æ§ä¸»æœºçš„æ–¹å¼ï¼š 1.åŸºäºé€šè¡Œçš„snmp 2.åŸºäºä¸“ç”¨agent 3.åŸºäºssh(shell) å¯¹äºä¸åŒçš„ç›‘æ§æŒ‡æ ‡ï¼Œæœ€åå®ç°çš„åŠŸèƒ½ä¹Ÿæœ‰æ‰€ä¸åŒ.ä¸‹é¢æ˜¯æœ¬äººé€šè¿‡å­¦ä¹ æ€»ç»“å…³äºä¸snmpåè®®çš„ä¸€äº›è§£é‡Šä»¥åŠè¿ç”¨ SNMP ä¸»è¦å‡ ä¸ªç®€å•çš„æ“ä½œå°±å¯ä»¥å®ç°å¯¹è¿œç¨‹è®¾å¤‡ä¸Šçš„æœåŠ¡ã€èµ„æºç­‰å„ç§ç³»ç»ŸçŠ¶æ€ä¿¡æ¯çš„è·å–,ä¸ä»…ä»…æ˜¯è·å–ä¿¡æ¯è¿™ä¹ˆç®€å•,è¿˜èƒ½åœ¨è¾¾åˆ°æˆ‘ä»¬è®¾å®šå€¼æˆ–çŠ¶æ€çŠ¶æ€å‘ç”Ÿè½¬æ¢æ—¶èƒ½å‘å¯¹æ–¹å‘é€æ§åˆ¶æŒ‡ä»¤; SNMPçš„å·¥ä½œæœºåˆ¶ï¼š ç›‘æ§ç«¯/ä¸€ä¸ªæˆ–å¤šä¸ªè¢«ç›‘æ§ç«¯ ç›‘æ§ç«¯:NMS,è¿™ä¸ªå¹³å°ä¼šä¸ºç®¡ç†å‘˜æä¾›å‘½ä»¤è¡Œæ¥å£,å¯ä»¥å‘é€snmpæŒ‡ä»¤åˆ°ä»»ä½•ä¸€ä¸ªè¢«ç›‘æ§ä¸»æœº,è€Œåœ¨è¢«ç›‘æ§ç«¯å®‰è£…äº†ä¸€ä¸ªæœåŠ¡è¿›ç¨‹,å®ƒç”¨äºæ¥æ”¶æ¥è‡ªç›‘æ§ç«¯çš„æŸ¥è¯¢è¯·æ±‚, å¹¶ä¸”èƒ½å¤Ÿè§£æå¯¹æ–¹çš„æŸ¥è¯¢è¯·æ±‚,å¹¶å°†æŸ¥è¯¢æ•°æ®è¿”å›ç»™å¯¹æ–¹,æ‰€ä»¥è¿™ä¸ªæœåŠ¡è¿›ç¨‹å¯ä»¥ç§°ä¹‹ä¸ºæ˜¯ä¸€ä¸ªagent,å®ƒåªæ˜¯æ¥æ”¶ä¸€äº›æŸ¥è¯¢æˆ–è€…æ˜¯ç®¡ç†æŒ‡ä»¤è€Œå­˜åœ¨çš„ï¼› ç›‘æ§ç«¯å‘é€è¯·æ±‚â€”&gt;agentæ¥å—è¯·æ±‚(æ ¹æ®æŸ¥è¯¢è¯·æ±‚å†…å®¹)â€”&gt;agentè¿”å›æŸ¥è¯¢è¯·æ±‚åˆ°ç›‘æ§ç«¯. ä½†æ˜¯ä¸Šé¢æœ‰ä¸ªå¼Šç«¯,ä¹Ÿå°±æ˜¯è¯´ä»»ä½•ä¸»æœºè¿æ¥åˆ°æˆ‘ä»¬çš„agentå°±å¯ä»¥å‘é€æŒ‡ä»¤,è¿™æ ·ä¸€æ¥å®‰å…¨æ–¹é¢å°±æœ‰äº†å¾ˆå¤§çš„éšæ‚£,äºæ˜¯åœ¨æ­¤åŸºç¡€ä¸Šé¢å°±å¼•å…¥äº†communitiesåœ¨ç›‘æ§ç«¯å’Œagentä¹‹é—´å»ºç«‹é€šä¿¡çš„;ç›¸å½“äºä¸¤ä¸ªç«¯ä¹‹é—´å‘é€è®¤è¯ä¿¡æ¯,ä½†æ˜¯è¿™ä¸ªè®¤è¯ä¿¡æ¯æ˜¯æ˜æ–‡çš„; SNMPçš„åè®® v1: æ‰€æœ‰çš„å®‰å…¨æœºåˆ¶éƒ½æ˜¯åŸºäºcommunitiesæœºåˆ¶æ¥å®ç°,snmpçš„æ‰€æœ‰æ“ä½œåœ¨æœåŠ¡å™¨ç«¯ã€å®¢æˆ·ç«¯ä¹Ÿæ˜¯åŸºäºcommunitiesæœºåˆ¶æ¥å®ç°,åœ¨æ­¤ç‰ˆæœ¬ä¸­communitiesæœ‰ä¸‰ç§: read-only:åªè¯»,ç›‘æ§ç«¯åªèƒ½åˆ°agentç«¯è·å–ä¿¡æ¯; read-write:è¯»å†™,å¯å‘é€ç®¡ç†æŒ‡ä»¤;æœ‰æƒé™æ“ä½œagentç«¯ trap:agentç«¯ä¸»åŠ¨è”ç³»ç›‘æ§ç«¯ï¼›å¼•èµ·ç›‘æ§ç«¯æ³¨æ„çš„ä¸€ç§æœºåˆ¶ï¼› v2: å¯¹äºv2æ¥è¯´åªæ˜¯å¯¹v1åšäº†å¼ºåŒ–,æ­¤ç‰ˆæœ¬æ˜¯åŸºäºcommunity-string-based,è¿™ä¸ªç‰ˆæœ¬ä¹Ÿå«åšv2cï¼› v3: ç”±äºå‰é¢ä¸¤ä¸ªç‰ˆæœ¬è¿‡äºç®€åŒ–,è®¤è¯æœºåˆ¶è¾ƒä¸ºè–„å¼±,æ•…æ­¤å¢å¼ºäº†å…¶è®¤è¯æœºåˆ¶,æ•°æ®ä¼ è¾“æ–¹é¢ä¹Ÿæœ‰äº†å®‰å…¨æ€§.ä½†æ˜¯åœ¨ä¸‰ä¸ªç‰ˆæœ¬ä¸­ç”¨å¾—æœ€å¤šçš„è¿˜æ˜¯v1ç‰ˆæœ¬,åŸå› æ˜¯ç®€å•; snmp(NMS)åªæ˜¯æä¾›äº†å‘½ä»¤æ¥å£å»å®Œæˆé‡‡é›†æ•°æ®è€Œå·²,å¯¹äºé‡‡é›†åˆ°çš„æ•°æ®ä¿å­˜åœ¨å“ªé‡Œå®ƒä¸ä¼šå…³å¿ƒï¼› snmpè¿™ç§æœºåˆ¶è™½ç„¶å®ç°äº†ç½‘ç»œç®¡ç†åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒåªæ˜¯ä¸€ç§åè®®,æŠŠè¿™ç§åè®®äºˆä»¥å®ç°çš„è½¯ä»¶çš„åŠŸèƒ½ä¹Ÿæ˜¯å„ä¸ç›¸åŒçš„; MIBsç®¡ç†ä¿¡æ¯åº“. OID&lt;å¯¹è±¡æ ‡è¯†ç¬¦&gt; å°†å¤§å¤šæ•°ç›‘æ§å¯¹è±¡å®ƒçš„åç§°å’ŒIDå·ä¹‹é—´çš„å¯¹åº”å…³ç³»; æ¯”å¦‚åœ¨agentç«¯,å®ƒä¸ä»…ä»…è¦æ”¶é›†ä¸»æœºçš„ä¿¡æ¯å¤–è¿˜éœ€è¦ç»´æŒä¸€ä¸ªMIB,è¯·æ±‚è¾¾åˆ°agentç«¯åå®ƒè¦çŸ¥é“è¯·æ±‚çš„å†…å®¹æ˜¯ä»€ä¹ˆ,é‚£ä¹ˆåœ¨agentç«¯å°±ä¼šè®°å½•ä¸‹ç›‘æ§å¯¹è±¡å’ŒIDä¹‹é—´çš„æ˜ å°„å…³ç³»;æ‰€ä»¥ä¸€ä¸ªæ ‡å‡†çš„agentè¦æä¾›è‡³å°‘ä¸€ä¸ªåŸºæœ¬çš„MIB,ä»¥ç»´æŒç›‘æ§å¯¹è±¡;ä¹Ÿå«åšMIB-II,æ ¹æ®ä¸»æœºä¸åŒçš„éœ€è¦,MIBçš„å†…å®¹ä¹Ÿæœ‰æ‰€ä¸åŒï¼› å¤§å¤šæ•°èƒ½å¤ŸåŸºäºsnmpçš„ç®¡ç†åŠŸèƒ½éƒ½å±äºmgmtèŠ‚ç‚¹,è€Œåœ¨mgmtä¸‹é¢çš„è¿™ä¸ªmibä¸‹é¢åˆ™æœ‰ä¼—å¤šçš„ç›‘æ§å¯¹è±¡ï¼Œ1.3.6.1.2.1æ˜¯æ¯ä¸€ä¸ªä¸»æœºæˆ–è®¾å¤‡é»˜è®¤æä¾›çš„MIBçš„æ ‡è¯†ï¼š","categories":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}],"tags":[],"keywords":[{"name":"Other","slug":"Other","permalink":"https://blog.sctux.cc/categories/Other/"}]},{"title":"Perl: Warning: Falling Back to the Standard Locale (â€œCâ€)","slug":"perl-warning-falling-back-to-the-standard-locale-c","date":"2014-08-21T07:56:27.000Z","updated":"2025-09-01T01:59:08.984Z","comments":true,"path":"2014/08/21/perl-warning-falling-back-to-the-standard-locale-c/","permalink":"https://blog.sctux.cc/2014/08/21/perl-warning-falling-back-to-the-standard-locale-c/","excerpt":"ä»Šå¤©åœ¨å®‰è£…memcacheçš„phpçš„æ‰©å±•æ—¶é‡åˆ°çš„é”™è¯¯ï¼š 1.å°†è¯¥æ‰©å±•åŒ…è§£å‹ 2.ä½¿ç”¨/usr/bin/phpize(rpmåŒ…å®‰è£…åçš„ä½ç½®)å‘½ä»¤æ¥å‡†å¤‡ PHP å¤–æŒ‚æ¨¡å—çš„ç¼–è¯‘ç¯å¢ƒ(å¦‚æœæ‰¾ä¸åˆ°è¯¥å‘½ä»¤åˆ™éœ€è¦å®‰è£…ï¼Œè¿™ä¸ªå‘½ä»¤æœ‰php-develè¿™ä¸ªåŒ…ç”Ÿæˆï¼Œå¹¶ä¸”è¯¥åŒ…ä½äºDVD2ä¸­) ä¸Šé¢1ã€2æ­¥æˆåŠŸ 3.ä½¿ç”¨/usr/bin/phpizeæ—¶æŠ¥ä»¥ä¸‹é”™è¯¯: [root@node1 memcache-2.2.5]# /usr/bin/phpizeConfiguring for:PHP Api Version: 20090626Zend Module Api No: 20090626Zend Extension Api No: 220090626perl: warning: Setting locale failed.perl: warning: Please check that your locale settings: LANGUAGE = (unset), LC_ALL = (unset), LANG = â€œenâ€ are supported and installed on your system.perl: warning: Falling back to the standard locale (â€œCâ€).perl: warning: Setting locale failed.perl: warning: Please check that your locale settings: LANGUAGE = (unset), LC_ALL = (unset), LANG = â€œenâ€ are supported and installed on your system.perl: warning: Falling back to the standard locale (â€œCâ€). åœ¨ä½¿ç”¨å…¶å®ƒçš„æŸäº›å‘½ä»¤æ—¶(å¦‚ï¼šmysqlhotcopy)ä¹Ÿä¼šä¹Ÿå‡ºç°ç±»ä¼¼çš„æç¤ºã€‚ æœç´¢äº†å¥½ä¸€æ®µæ—¶é—´ï¼Œå¹¶è¯•äº†å‡ æ¬¡ï¼Œæ‰¾åˆ°ä¸€ä¸ªè§£å†³æ­¤é—®é¢˜çš„ç®€å•æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š [root@node1 memcache-2.2.5]#vim /root/.bashrc#-&gt;å†æœ€åº•éƒ¨åŠ ä¸Šexport LC_ALL=C#-&gt;æˆ–è€…ç›´æ¥è¿è¡Œ[root@node1 memcache-2.2.5]# echo â€œexport LC_ALL=Câ€ &gt;&gt; /root/.bashrc#-&gt;ç„¶åæ‰§è¡Œä¸€ä¸‹ï¼š[root@node1 memcache-2.2.5]# source /root/.bashrc","text":"ä»Šå¤©åœ¨å®‰è£…memcacheçš„phpçš„æ‰©å±•æ—¶é‡åˆ°çš„é”™è¯¯ï¼š 1.å°†è¯¥æ‰©å±•åŒ…è§£å‹ 2.ä½¿ç”¨/usr/bin/phpize(rpmåŒ…å®‰è£…åçš„ä½ç½®)å‘½ä»¤æ¥å‡†å¤‡ PHP å¤–æŒ‚æ¨¡å—çš„ç¼–è¯‘ç¯å¢ƒ(å¦‚æœæ‰¾ä¸åˆ°è¯¥å‘½ä»¤åˆ™éœ€è¦å®‰è£…ï¼Œè¿™ä¸ªå‘½ä»¤æœ‰php-develè¿™ä¸ªåŒ…ç”Ÿæˆï¼Œå¹¶ä¸”è¯¥åŒ…ä½äºDVD2ä¸­) ä¸Šé¢1ã€2æ­¥æˆåŠŸ 3.ä½¿ç”¨/usr/bin/phpizeæ—¶æŠ¥ä»¥ä¸‹é”™è¯¯: [root@node1 memcache-2.2.5]# /usr/bin/phpizeConfiguring for:PHP Api Version: 20090626Zend Module Api No: 20090626Zend Extension Api No: 220090626perl: warning: Setting locale failed.perl: warning: Please check that your locale settings: LANGUAGE = (unset), LC_ALL = (unset), LANG = â€œenâ€ are supported and installed on your system.perl: warning: Falling back to the standard locale (â€œCâ€).perl: warning: Setting locale failed.perl: warning: Please check that your locale settings: LANGUAGE = (unset), LC_ALL = (unset), LANG = â€œenâ€ are supported and installed on your system.perl: warning: Falling back to the standard locale (â€œCâ€). åœ¨ä½¿ç”¨å…¶å®ƒçš„æŸäº›å‘½ä»¤æ—¶(å¦‚ï¼šmysqlhotcopy)ä¹Ÿä¼šä¹Ÿå‡ºç°ç±»ä¼¼çš„æç¤ºã€‚ æœç´¢äº†å¥½ä¸€æ®µæ—¶é—´ï¼Œå¹¶è¯•äº†å‡ æ¬¡ï¼Œæ‰¾åˆ°ä¸€ä¸ªè§£å†³æ­¤é—®é¢˜çš„ç®€å•æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š [root@node1 memcache-2.2.5]#vim /root/.bashrc#-&gt;å†æœ€åº•éƒ¨åŠ ä¸Šexport LC_ALL=C#-&gt;æˆ–è€…ç›´æ¥è¿è¡Œ[root@node1 memcache-2.2.5]# echo â€œexport LC_ALL=Câ€ &gt;&gt; /root/.bashrc#-&gt;ç„¶åæ‰§è¡Œä¸€ä¸‹ï¼š[root@node1 memcache-2.2.5]# source /root/.bashrc","categories":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}],"tags":[{"name":"perl","slug":"perl","permalink":"https://blog.sctux.cc/tags/perl/"},{"name":"phpize","slug":"phpize","permalink":"https://blog.sctux.cc/tags/phpize/"}],"keywords":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}]},{"title":"Vmware Cloneé™·é˜±","slug":"vmware-clone-e9-99-b7-e9-98-b1","date":"2014-07-19T14:59:06.000Z","updated":"2025-09-01T01:59:08.876Z","comments":true,"path":"2014/07/19/vmware-clone-e9-99-b7-e9-98-b1/","permalink":"https://blog.sctux.cc/2014/07/19/vmware-clone-e9-99-b7-e9-98-b1/","excerpt":"åœ¨æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨vmware workstationåšå®éªŒæ—¶ï¼Œä¼šé‡åˆ°ä¸»æœºä¸å¤Ÿç”¨çš„æƒ…å†µï¼Œé‚£æ­¤æ—¶æˆ‘ä»¬çš„è§£å†³åŠæ³•ä¸€èˆ¬éƒ½æ˜¯è¦ä¹ˆä»æ–°è£…ä¸€å°æ–°çš„ï¼Œè¦ä¹ˆå°±æ˜¯é€šè¿‡vmware workstationå¼ºå¤§çš„å…‹éš†åŠŸèƒ½å…‹éš†å‡ºæˆ‘ä»¬éœ€è¦çš„è™šæ‹Ÿæœºï¼›æ˜¾ç„¶åè€…çš„ä¼˜åŠ¿æ¯”å‰è€…å¤§ï¼Œæ¯•ç«Ÿä½ ä»æ–°è£…ä¸€å°çš„è¯å ç”¨ä½ çš„ç‰©ç†ç¡¬ç›˜ç©ºé—´ï¼Œå…¶æ¬¡å°±æ˜¯æµªè´¹Your Time. SO,å°±é€‰æ‹©Cloneå§. æˆ‘ç°åœ¨æœ‰ä¸€å°åˆšè£…å¥½çš„è™šæ‹Ÿæœº(æ¯æœº)ï¼Œç”±äºåšå®éªŒæˆ‘éœ€è¦å¤šå°ä¸»æœºï¼›æˆ‘å°†è¿™å°ä¸»æœºå‘½åä¸ºnode1ï¼Œç›®çš„æ˜¯é€šè¿‡è¿™å°æ¯æœºå…‹éš†ä¸€å°è™šæ‹Ÿæœºnode2ï¼› åœ¨Clone Typeé¡µä¸­ï¼Œå•å‡»Create a linked clone(åˆ›å»ºä¸€ä¸ªå…‹éš†é“¾æ¥)ã€‚å¦‚æœé€‰æ‹©ç¬¬äºŒé¡¹Create a full cloneï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„å…‹éš†ã€‚è¿™ä¸¤ä¸ªåŒºåˆ«åœ¨äºï¼šç¬¬ä¸€é¡¹åˆ›å»ºçš„è™šæ‹Ÿæœºå°†ä¾èµ–äºæºè™šæ‹Ÿæœºçš„å­˜åœ¨ï¼Œä½¿ç”¨è¿™é¡¹åˆ›å»ºçš„è™šæ‹Ÿæœºå ç”¨è¾ƒå°‘çš„ç¡¬ç›˜ç©ºé—´ï¼›ç¬¬äºŒé¡¹åˆ›å»ºçš„ è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºï¼Œä½†å ç”¨è¾ƒå¤šçš„ç¡¬ç›˜ç©ºé—´ã€‚æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯Create a linked cloneï¼Œå…·ä½“çš„æ­¥éª¤æˆ‘å°±ä¸å†ç»™å‡ºï¼› node2é€šè¿‡node1ä¸åˆ°10så°±å…‹éš†å¥½å•¦ï¼Œä½†æ˜¯å¾…æˆ‘æŸ¥çœ‹å…‹éš†å‡ºæ¥çš„ä¸¤å°æœºå­çš„ç½‘ç»œä¿¡æ¯æ—¶å±…ç„¶ä¸æ˜¯é»˜è®¤çš„eth0ç½‘å¡ï¼Œæ€ä¹ˆå˜æˆeth1äº†å‘¢ï¼Œå¯¹äºæˆ‘è¿™ç§å­¦ä¹ å¼ºè¿«ç—‡çš„æ¥è¯´ï¼Œè¿™ç§äº‹æƒ…çœŸä¸èƒ½å‘ç”Ÿï¼Œè¿˜æœ‰çš„åŒå­¦é‡åˆ°äº†é€šè¿‡cloneè¿™ç§æœºåˆ¶åœ¨æ“ä½œæ—¶ç½‘å¡å†²çªã€æ— æ³•å¯åŠ¨ç½‘å¡ã€æˆ–è€…æ˜¯é…ç½®äº†IPä¹Ÿä¸æµäºæ˜¯ï¼›äºæ˜¯é€šè¿‡googleäº†ä¸€ä¸‹ï¼š åŸå› å¦‚ä¸‹ï¼š Centosæˆ–RedHatä½¿ç”¨udevåŠ¨æ€ç®¡ç†è®¾å¤‡æ–‡ä»¶ï¼Œå¹¶æ ¹æ®è®¾å¤‡çš„ä¿¡æ¯å¯¹å…¶è¿›è¡ŒæŒä¹…åŒ–å‘½åã€‚udevä¼šåœ¨ç³»ç»Ÿå¼•å¯¼çš„è¿‡ç¨‹ä¸­è¯†åˆ«ç½‘å¡ï¼Œå°†macåœ°å€å’Œç½‘å¡åç§°å¯¹åº”èµ·æ¥è®°å½•åœ¨udevçš„è§„åˆ™è„šæœ¬ä¸­ã€‚è€Œå¯¹äºæ–°çš„è™šæ‹Ÿæœºï¼ŒVMwareä¼šè‡ªåŠ¨ä¸ºè™šæ‹Ÿæœºçš„ç½‘å¡ç”ŸæˆMACåœ°å€ï¼Œå½“ä½ å…‹éš†æˆ–è€…é‡è£…è™šæ‹Ÿæœºè½¯ä»¶æ—¶ï¼Œç”±äºä½ ä½¿ç”¨çš„æ˜¯ä»¥å‰ç³»ç»Ÿè™šæ‹Ÿç¡¬ç›˜çš„ä¿¡æ¯ï¼Œè€Œè¯¥ç³»ç»Ÿä¸­å·²ç»æœ‰eth0çš„ä¿¡æ¯ï¼Œå¯¹äºæ–°å¢çš„ç½‘å¡ï¼Œudevä¼šè‡ªåŠ¨å°†å…¶å‘½åä¸ºeth1ï¼ˆç´¯åŠ çš„åŸåˆ™ï¼‰ï¼Œæ‰€ä»¥åœ¨ä½ çš„ç³»ç»Ÿå¯åŠ¨åï¼Œä½ ä½¿ç”¨ifconfigçœ‹åˆ°çš„ç½‘å¡åä¸ºeth1ã€‚è¿™æ—¶å€™åœ¨/etc/sysconfig/network-script/ä¸‹ä¾ç„¶æ˜¯eth0çš„é…ç½®æ–‡ä»¶ï¼Œè‡ªç„¶ä»–ä¼šè¯†åˆ«å‡ºeth1äº†å™»ã€‚ è§£å†³åŠæ³•ï¼š 1. å°†node2è¿™å°ä¸»æœºçš„/etc/udev/rules.d/70-persistent-net.rules ä¸­ 2. å°†/etc/sysconfig/network-script/ifcfg-eth0 ä¸­å…³äºmacä¿¡æ¯åˆ æ‰ï¼› 3. æ”¹å®Œårebootæˆ–è€…é‡å¯ç½‘å¡ï¼šservice network restart.å®Œæˆåä½ ä¼šå‘ç°ä¸ç½‘å¡ç¼–å·ä¸ä½ çš„æ­£å¸¸é€»è¾‘ä¸­çš„ä¸€æ ·å•¦.","text":"åœ¨æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨vmware workstationåšå®éªŒæ—¶ï¼Œä¼šé‡åˆ°ä¸»æœºä¸å¤Ÿç”¨çš„æƒ…å†µï¼Œé‚£æ­¤æ—¶æˆ‘ä»¬çš„è§£å†³åŠæ³•ä¸€èˆ¬éƒ½æ˜¯è¦ä¹ˆä»æ–°è£…ä¸€å°æ–°çš„ï¼Œè¦ä¹ˆå°±æ˜¯é€šè¿‡vmware workstationå¼ºå¤§çš„å…‹éš†åŠŸèƒ½å…‹éš†å‡ºæˆ‘ä»¬éœ€è¦çš„è™šæ‹Ÿæœºï¼›æ˜¾ç„¶åè€…çš„ä¼˜åŠ¿æ¯”å‰è€…å¤§ï¼Œæ¯•ç«Ÿä½ ä»æ–°è£…ä¸€å°çš„è¯å ç”¨ä½ çš„ç‰©ç†ç¡¬ç›˜ç©ºé—´ï¼Œå…¶æ¬¡å°±æ˜¯æµªè´¹Your Time. SO,å°±é€‰æ‹©Cloneå§. æˆ‘ç°åœ¨æœ‰ä¸€å°åˆšè£…å¥½çš„è™šæ‹Ÿæœº(æ¯æœº)ï¼Œç”±äºåšå®éªŒæˆ‘éœ€è¦å¤šå°ä¸»æœºï¼›æˆ‘å°†è¿™å°ä¸»æœºå‘½åä¸ºnode1ï¼Œç›®çš„æ˜¯é€šè¿‡è¿™å°æ¯æœºå…‹éš†ä¸€å°è™šæ‹Ÿæœºnode2ï¼› åœ¨Clone Typeé¡µä¸­ï¼Œå•å‡»Create a linked clone(åˆ›å»ºä¸€ä¸ªå…‹éš†é“¾æ¥)ã€‚å¦‚æœé€‰æ‹©ç¬¬äºŒé¡¹Create a full cloneï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„å…‹éš†ã€‚è¿™ä¸¤ä¸ªåŒºåˆ«åœ¨äºï¼šç¬¬ä¸€é¡¹åˆ›å»ºçš„è™šæ‹Ÿæœºå°†ä¾èµ–äºæºè™šæ‹Ÿæœºçš„å­˜åœ¨ï¼Œä½¿ç”¨è¿™é¡¹åˆ›å»ºçš„è™šæ‹Ÿæœºå ç”¨è¾ƒå°‘çš„ç¡¬ç›˜ç©ºé—´ï¼›ç¬¬äºŒé¡¹åˆ›å»ºçš„ è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºï¼Œä½†å ç”¨è¾ƒå¤šçš„ç¡¬ç›˜ç©ºé—´ã€‚æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯Create a linked cloneï¼Œå…·ä½“çš„æ­¥éª¤æˆ‘å°±ä¸å†ç»™å‡ºï¼› node2é€šè¿‡node1ä¸åˆ°10så°±å…‹éš†å¥½å•¦ï¼Œä½†æ˜¯å¾…æˆ‘æŸ¥çœ‹å…‹éš†å‡ºæ¥çš„ä¸¤å°æœºå­çš„ç½‘ç»œä¿¡æ¯æ—¶å±…ç„¶ä¸æ˜¯é»˜è®¤çš„eth0ç½‘å¡ï¼Œæ€ä¹ˆå˜æˆeth1äº†å‘¢ï¼Œå¯¹äºæˆ‘è¿™ç§å­¦ä¹ å¼ºè¿«ç—‡çš„æ¥è¯´ï¼Œè¿™ç§äº‹æƒ…çœŸä¸èƒ½å‘ç”Ÿï¼Œè¿˜æœ‰çš„åŒå­¦é‡åˆ°äº†é€šè¿‡cloneè¿™ç§æœºåˆ¶åœ¨æ“ä½œæ—¶ç½‘å¡å†²çªã€æ— æ³•å¯åŠ¨ç½‘å¡ã€æˆ–è€…æ˜¯é…ç½®äº†IPä¹Ÿä¸æµäºæ˜¯ï¼›äºæ˜¯é€šè¿‡googleäº†ä¸€ä¸‹ï¼š åŸå› å¦‚ä¸‹ï¼š Centosæˆ–RedHatä½¿ç”¨udevåŠ¨æ€ç®¡ç†è®¾å¤‡æ–‡ä»¶ï¼Œå¹¶æ ¹æ®è®¾å¤‡çš„ä¿¡æ¯å¯¹å…¶è¿›è¡ŒæŒä¹…åŒ–å‘½åã€‚udevä¼šåœ¨ç³»ç»Ÿå¼•å¯¼çš„è¿‡ç¨‹ä¸­è¯†åˆ«ç½‘å¡ï¼Œå°†macåœ°å€å’Œç½‘å¡åç§°å¯¹åº”èµ·æ¥è®°å½•åœ¨udevçš„è§„åˆ™è„šæœ¬ä¸­ã€‚è€Œå¯¹äºæ–°çš„è™šæ‹Ÿæœºï¼ŒVMwareä¼šè‡ªåŠ¨ä¸ºè™šæ‹Ÿæœºçš„ç½‘å¡ç”ŸæˆMACåœ°å€ï¼Œå½“ä½ å…‹éš†æˆ–è€…é‡è£…è™šæ‹Ÿæœºè½¯ä»¶æ—¶ï¼Œç”±äºä½ ä½¿ç”¨çš„æ˜¯ä»¥å‰ç³»ç»Ÿè™šæ‹Ÿç¡¬ç›˜çš„ä¿¡æ¯ï¼Œè€Œè¯¥ç³»ç»Ÿä¸­å·²ç»æœ‰eth0çš„ä¿¡æ¯ï¼Œå¯¹äºæ–°å¢çš„ç½‘å¡ï¼Œudevä¼šè‡ªåŠ¨å°†å…¶å‘½åä¸ºeth1ï¼ˆç´¯åŠ çš„åŸåˆ™ï¼‰ï¼Œæ‰€ä»¥åœ¨ä½ çš„ç³»ç»Ÿå¯åŠ¨åï¼Œä½ ä½¿ç”¨ifconfigçœ‹åˆ°çš„ç½‘å¡åä¸ºeth1ã€‚è¿™æ—¶å€™åœ¨/etc/sysconfig/network-script/ä¸‹ä¾ç„¶æ˜¯eth0çš„é…ç½®æ–‡ä»¶ï¼Œè‡ªç„¶ä»–ä¼šè¯†åˆ«å‡ºeth1äº†å™»ã€‚ è§£å†³åŠæ³•ï¼š 1. å°†node2è¿™å°ä¸»æœºçš„/etc/udev/rules.d/70-persistent-net.rules ä¸­ 2. å°†/etc/sysconfig/network-script/ifcfg-eth0 ä¸­å…³äºmacä¿¡æ¯åˆ æ‰ï¼› 3. æ”¹å®Œårebootæˆ–è€…é‡å¯ç½‘å¡ï¼šservice network restart.å®Œæˆåä½ ä¼šå‘ç°ä¸ç½‘å¡ç¼–å·ä¸ä½ çš„æ­£å¸¸é€»è¾‘ä¸­çš„ä¸€æ ·å•¦.","categories":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}],"tags":[{"name":"vmware workstation","slug":"vmware-workstation","permalink":"https://blog.sctux.cc/tags/vmware-workstation/"}],"keywords":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}]},{"title":"è·å–LinuxæœåŠ¡å™¨ç¡¬ä»¶ä¿¡æ¯","slug":"e8-8e-b7-e5-8f-96linux-e6-9c-8d-e5-8a-a1-e5-99-a8-e7-a1-ac-e4-bb-b6-e4-bf-a1-e6-81-af","date":"2014-06-29T10:13:58.000Z","updated":"2025-09-01T01:59:08.885Z","comments":true,"path":"2014/06/29/e8-8e-b7-e5-8f-96linux-e6-9c-8d-e5-8a-a1-e5-99-a8-e7-a1-ac-e4-bb-b6-e4-bf-a1-e6-81-af/","permalink":"https://blog.sctux.cc/2014/06/29/e8-8e-b7-e5-8f-96linux-e6-9c-8d-e5-8a-a1-e5-99-a8-e7-a1-ac-e4-bb-b6-e4-bf-a1-e6-81-af/","excerpt":"1.æŸ¥çœ‹æœåŠ¡å™¨å‹å·ã€åºåˆ—å·ï¼š [root@localhots ~]#dmidecode|grep â€œSystem Informationâ€ -A9|egrep â€œManufacturer|Product|Serialâ€ Manufacturer: HP Product Name: ProLiant DL360 G6 Serial Number: JPT0012J2W 2.Linux æŸ¥çœ‹å†…å­˜çš„æ’æ§½æ•°,å·²ç»ä½¿ç”¨å¤šå°‘æ’æ§½.æ¯æ¡å†…å­˜å¤šå¤§: [root@localhost ~]#dmidecode|grep -A5 â€œMemory Deviceâ€|grep Size|grep -v Range Size: No Module Installed Size: No Module Installed Size: 4096 MB Size: No Module Installed Size: No Module Installed Size: 4096 MB Size: No Module Installed Size: No Module Installed Size: No Module Installed Size: No Module Installed Size: No Module Installed Size: 4096 MB Size: No Module Installed Size: No Module Installed Size: 4096 MB Size: No Module Installed Size: No Module Installed Size: No Module Installed 3.Linux æŸ¥çœ‹å†…å­˜çš„é¢‘ç‡: [root@localhost ~]#dmidecode|grep -A16 â€œMemory Deviceâ€|grep â€˜Speedâ€™ Speed: Unknown Speed: Unknown Speed: 1067 MHz Speed: Unknown Speed: Unknown Speed: 1067 MHz Speed: Unknown Speed: Unknown Speed: Unknown Speed: Unknown Speed: Unknown Speed: 1067 MHz Speed: Unknown Speed: Unknown Speed: 1067 MHz Speed: Unknown Speed: Unknown Speed: Unknown 4.æŸ¥çœ‹cpuçš„ç»Ÿè®¡ä¿¡æ¯: [root@localhost ~]# lscpu #-&gt;å¦‚è¯¥å‘½ä»¤æ‰¾ä¸åˆ°,è¯·å®‰è£…è½¯ä»¶åŒ…util-linux-ngArchitecture: x86_64 #-&gt;cpuæ¶æ„CPU op-mode(s): 32-bit, 64-bitByte Order: Little Endian #-&gt;å°å°¾åºCPU(s): 8 #-&gt;æ€»å…±æœ‰8æ ¸On-line CPU(s) list: 0-7Thread(s) per core: 1 #-&gt;æ¯ä¸ªcpuæ ¸ï¼Œåªèƒ½æ”¯æŒä¸€ä¸ªçº¿ç¨‹ï¼Œå³ä¸æ”¯æŒè¶…çº¿ç¨‹Core(s) per socket: 4 #-&gt;æ¯ä¸ªcpuï¼Œæœ‰4ä¸ªæ ¸Socket(s): 2 #-&gt;æ€»å…±æœ‰2ä¸€ä¸ªcpuNUMA node(s): 2Vendor ID: GenuineIntel #-&gt;cpuäº§å•† intelCPU family: 6Model: 26Stepping: 5CPU MHz: 2266.877BogoMIPS: 4532.68Virtualization: VT-x #-&gt;æ”¯æŒcpuè™šæ‹ŸåŒ–æŠ€æœ¯L1d cache: 32KL1i cache: 32KL2 cache: 256KL3 cache: 8192KNUMA node0 CPU(s): 0,2,4,6NUMA node1 CPU(s): 1,3,5,7 5.æŸ¥çœ‹/proc/cpuinfo,å¯ä»¥çŸ¥é“æ¯ä¸ªcpuä¿¡æ¯ï¼Œå¦‚æ¯ä¸ªCPUçš„å‹å·ï¼Œä¸»é¢‘ç­‰: [root@localhost ~]#cat /proc/cpuinfoprocessor : 0vendor_id : GenuineIntelcpu family : 6model : 26model name : Intel(R) Xeon(R) CPU E5520 @ 2.27GHzâ€¦..â€¦..â€¦..#-&gt;ä¸Šé¢è¾“å‡ºçš„æ˜¯ç¬¬ä¸€ä¸ªcpuéƒ¨åˆ†ä¿¡æ¯ï¼Œè¿˜æœ‰7ä¸ªcpuä¿¡æ¯çœç•¥äº†","text":"1.æŸ¥çœ‹æœåŠ¡å™¨å‹å·ã€åºåˆ—å·ï¼š [root@localhots ~]#dmidecode|grep â€œSystem Informationâ€ -A9|egrep â€œManufacturer|Product|Serialâ€ Manufacturer: HP Product Name: ProLiant DL360 G6 Serial Number: JPT0012J2W 2.Linux æŸ¥çœ‹å†…å­˜çš„æ’æ§½æ•°,å·²ç»ä½¿ç”¨å¤šå°‘æ’æ§½.æ¯æ¡å†…å­˜å¤šå¤§: [root@localhost ~]#dmidecode|grep -A5 â€œMemory Deviceâ€|grep Size|grep -v Range Size: No Module Installed Size: No Module Installed Size: 4096 MB Size: No Module Installed Size: No Module Installed Size: 4096 MB Size: No Module Installed Size: No Module Installed Size: No Module Installed Size: No Module Installed Size: No Module Installed Size: 4096 MB Size: No Module Installed Size: No Module Installed Size: 4096 MB Size: No Module Installed Size: No Module Installed Size: No Module Installed 3.Linux æŸ¥çœ‹å†…å­˜çš„é¢‘ç‡: [root@localhost ~]#dmidecode|grep -A16 â€œMemory Deviceâ€|grep â€˜Speedâ€™ Speed: Unknown Speed: Unknown Speed: 1067 MHz Speed: Unknown Speed: Unknown Speed: 1067 MHz Speed: Unknown Speed: Unknown Speed: Unknown Speed: Unknown Speed: Unknown Speed: 1067 MHz Speed: Unknown Speed: Unknown Speed: 1067 MHz Speed: Unknown Speed: Unknown Speed: Unknown 4.æŸ¥çœ‹cpuçš„ç»Ÿè®¡ä¿¡æ¯: [root@localhost ~]# lscpu #-&gt;å¦‚è¯¥å‘½ä»¤æ‰¾ä¸åˆ°,è¯·å®‰è£…è½¯ä»¶åŒ…util-linux-ngArchitecture: x86_64 #-&gt;cpuæ¶æ„CPU op-mode(s): 32-bit, 64-bitByte Order: Little Endian #-&gt;å°å°¾åºCPU(s): 8 #-&gt;æ€»å…±æœ‰8æ ¸On-line CPU(s) list: 0-7Thread(s) per core: 1 #-&gt;æ¯ä¸ªcpuæ ¸ï¼Œåªèƒ½æ”¯æŒä¸€ä¸ªçº¿ç¨‹ï¼Œå³ä¸æ”¯æŒè¶…çº¿ç¨‹Core(s) per socket: 4 #-&gt;æ¯ä¸ªcpuï¼Œæœ‰4ä¸ªæ ¸Socket(s): 2 #-&gt;æ€»å…±æœ‰2ä¸€ä¸ªcpuNUMA node(s): 2Vendor ID: GenuineIntel #-&gt;cpuäº§å•† intelCPU family: 6Model: 26Stepping: 5CPU MHz: 2266.877BogoMIPS: 4532.68Virtualization: VT-x #-&gt;æ”¯æŒcpuè™šæ‹ŸåŒ–æŠ€æœ¯L1d cache: 32KL1i cache: 32KL2 cache: 256KL3 cache: 8192KNUMA node0 CPU(s): 0,2,4,6NUMA node1 CPU(s): 1,3,5,7 5.æŸ¥çœ‹/proc/cpuinfo,å¯ä»¥çŸ¥é“æ¯ä¸ªcpuä¿¡æ¯ï¼Œå¦‚æ¯ä¸ªCPUçš„å‹å·ï¼Œä¸»é¢‘ç­‰: [root@localhost ~]#cat /proc/cpuinfoprocessor : 0vendor_id : GenuineIntelcpu family : 6model : 26model name : Intel(R) Xeon(R) CPU E5520 @ 2.27GHzâ€¦..â€¦..â€¦..#-&gt;ä¸Šé¢è¾“å‡ºçš„æ˜¯ç¬¬ä¸€ä¸ªcpuéƒ¨åˆ†ä¿¡æ¯ï¼Œè¿˜æœ‰7ä¸ªcpuä¿¡æ¯çœç•¥äº† 6.æŸ¥çœ‹ç‰©ç†CPUä¸ªæ•°: [root@localhost ~]# grep â€œphysical idâ€ /proc/cpuinfo | sort -uphysical id : 0physical id : 1 7.æŸ¥çœ‹CPUæ ¸å¿ƒæ•°: [root@localhost ~]# grep â€˜core idâ€™ /proc/cpuinfo | sort -u | wc -l4 8.æŸ¥çœ‹CPUçº¿ç¨‹æ•°: [root@localhost ~]# grep â€˜processorâ€™ /proc/cpuinfo | sort -u | wc -l8","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"cpu","slug":"cpu","permalink":"https://blog.sctux.cc/tags/cpu/"}],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}]},{"title":"å¦‚ä½•è®©è®¡åˆ’ä»»åŠ¡å®ç°ç§’çº§æ‰§è¡Œ","slug":"e5-a6-82-e4-bd-95-e8-ae-a9-e8-ae-a1-e5-88-92-e4-bb-bb-e5-8a-a1-e5-ae-9e-e7-8e-b0-e7-a7-92-e7-ba-a7-e6-89-a7-e8-a1-8c","date":"2014-06-16T14:37:51.000Z","updated":"2025-09-01T01:59:08.877Z","comments":true,"path":"2014/06/16/e5-a6-82-e4-bd-95-e8-ae-a9-e8-ae-a1-e5-88-92-e4-bb-bb-e5-8a-a1-e5-ae-9e-e7-8e-b0-e7-a7-92-e7-ba-a7-e6-89-a7-e8-a1-8c/","permalink":"https://blog.sctux.cc/2014/06/16/e5-a6-82-e4-bd-95-e8-ae-a9-e8-ae-a1-e5-88-92-e4-bb-bb-e5-8a-a1-e5-ae-9e-e7-8e-b0-e7-a7-92-e7-ba-a7-e6-89-a7-e8-a1-8c/","excerpt":"æœ€è¿‘æœ‰ä¸ªåº”ç”¨éœ€æ±‚ï¼Œæ ¹æ®å®é™…è¦æ±‚æœ€å¥½æ˜¯æ¯3ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œä½†æ˜¯crondåªèƒ½æ”¯æŒåˆ°åˆ†ã€‚è¿™è¯¥å¦‚ä½•æ˜¯å¥½ï¼Ÿ ç¬¬ä¸€ç§æ–¹æ³•ï¼š é¦–å…ˆæƒ³åˆ°çš„æ˜¯é€šè¿‡ä¸€ä¸ªè§¦å‘çš„è„šæœ¬ï¼Œç„¶ååœ¨è„šæœ¬ä¸­ä½¿ç”¨æ­»å¾ªç¯æ¥è§£å†³æ­¤é—®é¢˜ï¼Œå¦‚ï¼š cat test.sh----------------#!/bin/bashwhile : ;do /home/script/test.sh 2&gt;/dev/null &amp; sleep 3done---------------- æ³¨æ„ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶è¯·ä¸è¦ä½¿ç”¨sh test.sh&nbsp;&amp; è¿™ç§åå°è¿è¡Œçš„æ–¹å¼ï¼Œå®ƒä¼šåƒµæ­»çš„ã€‚ å¯ä»¥æŠŠå®ƒæ”¾åˆ°è®¡åˆ’ä»»åŠ¡ä½¿å…¶è¿è¡Œï¼Œç„¶åå°†è®¡åˆ’ä»»åŠ¡ä¸­çš„æ­¤æ¡ç›®åˆ é™¤å³å¯ã€‚æœ€åæŠŠè¿™ä¸ªè„šæœ¬æ”¾åˆ°/etc/rc.localè®©å®ƒæ¯æ¬¡å¼€æœºéƒ½å¯ä»¥è¢«è¿è¡Œã€‚ ç¬¬äºŒç§æ–¹æ³•ï¼š å’Œç¬¬äºŒç§æ–¹æ³•ç±»ä¼¼ï¼Œä½†æ˜¯æ¯”èµ·æ¥æ›´ä¾¿æ·ä¸€äº›ã€‚ cat cron-seconds.sh----------------#!/bin/bash#For excuting the scripts every 3 seconds in crond. for((i=1;i&lt;=20;i++));do /home/script/test.sh 2&gt;/dev/null &amp; sleep 3 done---------------- ç„¶åå†™å…¥çš„crontabé‡Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚ä¸‹: crontab -e----------------* * * * * /bin/bash /home/somedir/cron-seconds.sh---------------- ç¬¬ä¸‰ç§æ–¹æ³•ï¼š é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨è®¡åˆ’ä»»åŠ¡æ¥ç›´æ¥å®ç°å‘¢ï¼Ÿ æœ€åè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼Œè™½ç„¶æ¡ç›®çœ‹èµ·æ¥å¾ˆå¤šï¼Œä½†æ˜¯ç»éªŒè¯ï¼Œè„šæœ¬è¿è¡Œéå¸¸ç¨³å®šã€‚","text":"æœ€è¿‘æœ‰ä¸ªåº”ç”¨éœ€æ±‚ï¼Œæ ¹æ®å®é™…è¦æ±‚æœ€å¥½æ˜¯æ¯3ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œä½†æ˜¯crondåªèƒ½æ”¯æŒåˆ°åˆ†ã€‚è¿™è¯¥å¦‚ä½•æ˜¯å¥½ï¼Ÿ ç¬¬ä¸€ç§æ–¹æ³•ï¼š é¦–å…ˆæƒ³åˆ°çš„æ˜¯é€šè¿‡ä¸€ä¸ªè§¦å‘çš„è„šæœ¬ï¼Œç„¶ååœ¨è„šæœ¬ä¸­ä½¿ç”¨æ­»å¾ªç¯æ¥è§£å†³æ­¤é—®é¢˜ï¼Œå¦‚ï¼š cat test.sh----------------#!/bin/bashwhile : ;do /home/script/test.sh 2&gt;/dev/null &amp; sleep 3done---------------- æ³¨æ„ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶è¯·ä¸è¦ä½¿ç”¨sh test.sh&nbsp;&amp; è¿™ç§åå°è¿è¡Œçš„æ–¹å¼ï¼Œå®ƒä¼šåƒµæ­»çš„ã€‚ å¯ä»¥æŠŠå®ƒæ”¾åˆ°è®¡åˆ’ä»»åŠ¡ä½¿å…¶è¿è¡Œï¼Œç„¶åå°†è®¡åˆ’ä»»åŠ¡ä¸­çš„æ­¤æ¡ç›®åˆ é™¤å³å¯ã€‚æœ€åæŠŠè¿™ä¸ªè„šæœ¬æ”¾åˆ°/etc/rc.localè®©å®ƒæ¯æ¬¡å¼€æœºéƒ½å¯ä»¥è¢«è¿è¡Œã€‚ ç¬¬äºŒç§æ–¹æ³•ï¼š å’Œç¬¬äºŒç§æ–¹æ³•ç±»ä¼¼ï¼Œä½†æ˜¯æ¯”èµ·æ¥æ›´ä¾¿æ·ä¸€äº›ã€‚ cat cron-seconds.sh----------------#!/bin/bash#For excuting the scripts every 3 seconds in crond. for((i=1;i&lt;=20;i++));do /home/script/test.sh 2&gt;/dev/null &amp; sleep 3 done---------------- ç„¶åå†™å…¥çš„crontabé‡Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚ä¸‹: crontab -e----------------* * * * * /bin/bash /home/somedir/cron-seconds.sh---------------- ç¬¬ä¸‰ç§æ–¹æ³•ï¼š é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨è®¡åˆ’ä»»åŠ¡æ¥ç›´æ¥å®ç°å‘¢ï¼Ÿ æœ€åè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼Œè™½ç„¶æ¡ç›®çœ‹èµ·æ¥å¾ˆå¤šï¼Œä½†æ˜¯ç»éªŒè¯ï¼Œè„šæœ¬è¿è¡Œéå¸¸ç¨³å®šã€‚ crontab -e#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“## For excuting test.sh.sh every 3 seconds* * * * * /home/script/test.sh.sh* * * * * sleep 3 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 6 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 9 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 12 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 15 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 18 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 21 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 24 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 27 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 30 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 33 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 36 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 39 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 42 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 45 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 48 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 51 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 54 &amp;&amp; /home/script/test.sh.sh* * * * * sleep 57 &amp;&amp; /home/script/test.sh.sh#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“ &nbsp; ä¸ªäººè¿˜æ˜¯æ¯”è¾ƒå€¾å‘äºç¬¬ä¸‰ç§æ–¹æ³•ï¼Œæ¯•ç«Ÿä½ æ‰§è¡Œtest.shä¹Ÿæ˜¯éœ€è¦æ—¶é—´çš„ã€‚ä½†æ˜¯å¦‚æœå¯¹äºæ—¶é—´ç²¾åº¦ä¸æ˜¯å¾ˆé«˜çš„ï¼Œæ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"crond","slug":"crond","permalink":"https://blog.sctux.cc/tags/crond/"}],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}]},{"title":"Zabbix Server Is Not Running:é”™è¯¯çš„è§£å†³","slug":"zabbix-server-is-not-running-e9-94-99-e8-af-af-e7-9a-84-e8-a7-a3-e5-86-b3","date":"2014-06-16T02:08:22.000Z","updated":"2025-09-01T01:59:08.957Z","comments":true,"path":"2014/06/16/zabbix-server-is-not-running-e9-94-99-e8-af-af-e7-9a-84-e8-a7-a3-e5-86-b3/","permalink":"https://blog.sctux.cc/2014/06/16/zabbix-server-is-not-running-e9-94-99-e8-af-af-e7-9a-84-e8-a7-a3-e5-86-b3/","excerpt":"ä»Šå¤©åœ¨å®‰è£…äº†zabbix-serverç«¯å &nbsp;åœ¨zabbixçš„dashboardä¸­ä¸­å‡ºç°ä¸‹é¢çš„ä¿¡æ¯: &nbsp; éšå³æ£€æŸ¥äº†zabbix-serverçš„è¿è¡ŒçŠ¶æ€å’Œmysqlçš„è¿è¡ŒçŠ¶æ€éƒ½æ˜¯æ­£å¸¸çš„ï¼›å›°æ‰°æœ‰åŠåˆ»é’Ÿå·¦å³ï¼Œå°†æ‰€æœ‰çš„é…ç½®æ–‡ä»¶æ£€æŸ¥äº†ä¸€é å‘ç°åœ¨/etc/zabbix/web/zabbix.conf.php ä¸­æœ‰è¿™ä¹ˆä¸€è¡Œä¿¡æ¯ï¼š è§£å†³ï¼š æˆ‘å°†â€ZABBIX-SERVERâ€ æ”¹æˆäº†æˆ‘çš„zabbix-serverçš„IP.ä¿å­˜é€€å‡ºã€é‡å¯zabbix-serverã€åˆ·æ–°dashboard;æ¢å¤æ­£å¸¸å•¦ï¼ é—®é¢˜åŸå› ï¼š æˆ‘ä»æ–°å®‰è£…äº†ä¸€æ¬¡,å‘ç°åœ¨dashboardç•Œé¢å®‰è£…è¿‡ç¨‹ä¸­,æˆ‘å°†hostçš„åç§°ç»™è‡ªå®šä¹‰äº†, å®ƒé»˜è®¤æ˜¯â€localhostâ€,è¿™é‡Œæ ¹æœ¬å°±ä¸éœ€è¦ä¿®æ”¹,é»˜è®¤å°±è¡Œå•¦ï¼ &nbsp; â€œNameâ€å€’æ˜¯æ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥ã€‚ æ¯”è¾ƒé‡è¦çš„æ–‡ä»¶å°±æ˜¯/etc/zabbix/ä¸­çš„é‚£ä¸€å †äº†;æ—¥å¿—æ–‡ä»¶çš„è¯éƒ½åœ¨/var/log/zabbixsrv/ä¸‹é¢. è¿˜æœ‰ä¸€äº›é”™è¯¯å€’æ˜¯èƒ½æ ¹æ®ä¸€äº›æç¤ºè§£å†³,æ¯”å¦‚/etc/php.iniä¸­çš„å¥½å‡ ä¸ªå‚æ•°éœ€è¦ä¿®æ”¹ï¼ŒæŒ‰ç…§æç¤ºä¿®æ”¹å®Œï¼Œé‡å¯ä¸€ä¸‹apacheå°±ok!","text":"ä»Šå¤©åœ¨å®‰è£…äº†zabbix-serverç«¯å &nbsp;åœ¨zabbixçš„dashboardä¸­ä¸­å‡ºç°ä¸‹é¢çš„ä¿¡æ¯: &nbsp; éšå³æ£€æŸ¥äº†zabbix-serverçš„è¿è¡ŒçŠ¶æ€å’Œmysqlçš„è¿è¡ŒçŠ¶æ€éƒ½æ˜¯æ­£å¸¸çš„ï¼›å›°æ‰°æœ‰åŠåˆ»é’Ÿå·¦å³ï¼Œå°†æ‰€æœ‰çš„é…ç½®æ–‡ä»¶æ£€æŸ¥äº†ä¸€é å‘ç°åœ¨/etc/zabbix/web/zabbix.conf.php ä¸­æœ‰è¿™ä¹ˆä¸€è¡Œä¿¡æ¯ï¼š è§£å†³ï¼š æˆ‘å°†â€ZABBIX-SERVERâ€ æ”¹æˆäº†æˆ‘çš„zabbix-serverçš„IP.ä¿å­˜é€€å‡ºã€é‡å¯zabbix-serverã€åˆ·æ–°dashboard;æ¢å¤æ­£å¸¸å•¦ï¼ é—®é¢˜åŸå› ï¼š æˆ‘ä»æ–°å®‰è£…äº†ä¸€æ¬¡,å‘ç°åœ¨dashboardç•Œé¢å®‰è£…è¿‡ç¨‹ä¸­,æˆ‘å°†hostçš„åç§°ç»™è‡ªå®šä¹‰äº†, å®ƒé»˜è®¤æ˜¯â€localhostâ€,è¿™é‡Œæ ¹æœ¬å°±ä¸éœ€è¦ä¿®æ”¹,é»˜è®¤å°±è¡Œå•¦ï¼ &nbsp; â€œNameâ€å€’æ˜¯æ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥ã€‚ æ¯”è¾ƒé‡è¦çš„æ–‡ä»¶å°±æ˜¯/etc/zabbix/ä¸­çš„é‚£ä¸€å †äº†;æ—¥å¿—æ–‡ä»¶çš„è¯éƒ½åœ¨/var/log/zabbixsrv/ä¸‹é¢. è¿˜æœ‰ä¸€äº›é”™è¯¯å€’æ˜¯èƒ½æ ¹æ®ä¸€äº›æç¤ºè§£å†³,æ¯”å¦‚/etc/php.iniä¸­çš„å¥½å‡ ä¸ªå‚æ•°éœ€è¦ä¿®æ”¹ï¼ŒæŒ‰ç…§æç¤ºä¿®æ”¹å®Œï¼Œé‡å¯ä¸€ä¸‹apacheå°±ok!","categories":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}],"tags":[{"name":"zabbix","slug":"zabbix","permalink":"https://blog.sctux.cc/tags/zabbix/"}],"keywords":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}]},{"title":"Linuxä¸Šipå½’å±æŸ¥çœ‹ç¥å™¨","slug":"linux-e4-b8-8aip-e5-bd-92-e5-b1-9e-e6-9f-a5-e7-9c-8b-e7-a5-9e-e5-99-a8","date":"2014-04-12T11:23:15.000Z","updated":"2025-09-01T01:59:08.958Z","comments":true,"path":"2014/04/12/linux-e4-b8-8aip-e5-bd-92-e5-b1-9e-e6-9f-a5-e7-9c-8b-e7-a5-9e-e5-99-a8/","permalink":"https://blog.sctux.cc/2014/04/12/linux-e4-b8-8aip-e5-bd-92-e5-b1-9e-e6-9f-a5-e7-9c-8b-e7-a5-9e-e5-99-a8/","excerpt":"naliå–åâ€å“ªé‡Œâ€çš„æ‹¼éŸ³ã€‚ naliåŒ…å«ä¸€ç»„å‘½ä»¤è¡Œç¨‹åºï¼Œå…¶ä¸»è¦åŠŸèƒ½å°±æ˜¯æŠŠä¸€äº›ç½‘ç»œå·¥å…·çš„è¾“å‡ºçš„IPå­—ç¬¦ä¸²ï¼Œé™„åŠ ä¸Šåœ°ç†ä½ç½®ä¿¡æ¯(ä½¿ç”¨çº¯çœŸæ•°æ®åº“) ä¾‹å¦‚218.65.137.1ä¼šå˜æˆ218.65.137.1[å¹¿è¥¿å—å®å¸‚ ç”µä¿¡]ã€‚ æŸ¥è¯¢æ˜¯åœ¨æœ¬åœ°è¿›è¡Œï¼Œå¹¶ä¸ä¼šè¿›è¡Œè”ç½‘æŸ¥è¯¢ï¼Œæ‰€ä»¥æ•ˆç‡æ–¹é¢ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ã€‚ ç›®å‰åŒ…å«ä»¥ä¸‹å‡ ä¸ªå‘½ä»¤ï¼š nali nali-dig nali-nslookup nali-traceroute nali-tracepath nali-ping ä½¿ç”¨è¿™äº›å‘½ä»¤çš„å‰ææ˜¯ï¼Œä»–ä»¬å¯¹åº”çš„å‘½ä»¤å¿…é¡»å­˜åœ¨ã€‚ä¾‹å¦‚ä½ è¦ç”¨nali-digï¼Œå¿…é¡»ä¿è¯digæ˜¯å­˜åœ¨çš„ã€‚ä»–ä»¬çš„ç”¨æ³•å’ŒåŸå§‹å‘½ä»¤æ˜¯ä¸€æ ·çš„ã€‚ä¾‹å¦‚nali-digï¼Œç”¨æ³•å°±å’Œdigä¸€æ ·ã€‚ å¤§å®¶å¯èƒ½æ³¨æ„åˆ°äº†naliè¿™ä¸ªå‘½ä»¤ï¼Œå®ƒå¯ä»¥å¯¹æ ‡å‡†è¾“å‡ºçš„IPä¸²é™„åŠ ä¸Šåœ°ç†ä¿¡æ¯ã€‚nali-*ç³»åˆ—å·¥å…·éƒ½æ˜¯åŸºäºè¿™ä¸ªæ¥å®ç°çš„ã€‚ ä¸‹è½½ wget http://www.sctux.com/package/nali-0.1.tar.gz å®‰è£… ./configure â€“prefix=/usr &amp;&amp; make &amp;&amp; make instal ä½¿ç”¨ 1.ç»Ÿè®¡nginxçš„è®¿é—®è®°å½• [root@sctux ~]# awk -F â€˜ â€˜ â€˜{print $1}â€™ /var/log/access_sctux.log | sort -n | uniq -cd | sort -rn | nali ç»“æœå¦‚ä¸‹ï¼š 2.ä½¿ç”¨traceroute ä¹Ÿå°±æ˜¯è¯´ï¼Œnaliè¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥å¯¹æ ‡å‡†è¾“å‡ºçš„ipï¼Œé™„åŠ ä¸Šåœ°ç†ä¿¡æ¯ã€‚åŒç†ï¼Œå¦‚æœä½ ä¸å–œæ¬¢ç”¨nali-digï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç”¨dig ip|naliè¿™æ ·çš„å‘½ä»¤ã€‚ å¦‚æœä½ è§‰å¾—è¾“å…¥nali-xxxéº»çƒ¦ï¼Œé‚£ä¹ˆå¯ä»¥åšä¸€äº›aliasï¼Œä¾‹å¦‚ï¼š vim /root/.bashrcalias traceroute=â€™nali-tracerouteâ€™alias dig=â€™nali-digâ€™","text":"naliå–åâ€å“ªé‡Œâ€çš„æ‹¼éŸ³ã€‚ naliåŒ…å«ä¸€ç»„å‘½ä»¤è¡Œç¨‹åºï¼Œå…¶ä¸»è¦åŠŸèƒ½å°±æ˜¯æŠŠä¸€äº›ç½‘ç»œå·¥å…·çš„è¾“å‡ºçš„IPå­—ç¬¦ä¸²ï¼Œé™„åŠ ä¸Šåœ°ç†ä½ç½®ä¿¡æ¯(ä½¿ç”¨çº¯çœŸæ•°æ®åº“) ä¾‹å¦‚218.65.137.1ä¼šå˜æˆ218.65.137.1[å¹¿è¥¿å—å®å¸‚ ç”µä¿¡]ã€‚ æŸ¥è¯¢æ˜¯åœ¨æœ¬åœ°è¿›è¡Œï¼Œå¹¶ä¸ä¼šè¿›è¡Œè”ç½‘æŸ¥è¯¢ï¼Œæ‰€ä»¥æ•ˆç‡æ–¹é¢ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ã€‚ ç›®å‰åŒ…å«ä»¥ä¸‹å‡ ä¸ªå‘½ä»¤ï¼š nali nali-dig nali-nslookup nali-traceroute nali-tracepath nali-ping ä½¿ç”¨è¿™äº›å‘½ä»¤çš„å‰ææ˜¯ï¼Œä»–ä»¬å¯¹åº”çš„å‘½ä»¤å¿…é¡»å­˜åœ¨ã€‚ä¾‹å¦‚ä½ è¦ç”¨nali-digï¼Œå¿…é¡»ä¿è¯digæ˜¯å­˜åœ¨çš„ã€‚ä»–ä»¬çš„ç”¨æ³•å’ŒåŸå§‹å‘½ä»¤æ˜¯ä¸€æ ·çš„ã€‚ä¾‹å¦‚nali-digï¼Œç”¨æ³•å°±å’Œdigä¸€æ ·ã€‚ å¤§å®¶å¯èƒ½æ³¨æ„åˆ°äº†naliè¿™ä¸ªå‘½ä»¤ï¼Œå®ƒå¯ä»¥å¯¹æ ‡å‡†è¾“å‡ºçš„IPä¸²é™„åŠ ä¸Šåœ°ç†ä¿¡æ¯ã€‚nali-*ç³»åˆ—å·¥å…·éƒ½æ˜¯åŸºäºè¿™ä¸ªæ¥å®ç°çš„ã€‚ ä¸‹è½½ wget http://www.sctux.com/package/nali-0.1.tar.gz å®‰è£… ./configure â€“prefix=/usr &amp;&amp; make &amp;&amp; make instal ä½¿ç”¨ 1.ç»Ÿè®¡nginxçš„è®¿é—®è®°å½• [root@sctux ~]# awk -F â€˜ â€˜ â€˜{print $1}â€™ /var/log/access_sctux.log | sort -n | uniq -cd | sort -rn | nali ç»“æœå¦‚ä¸‹ï¼š 2.ä½¿ç”¨traceroute ä¹Ÿå°±æ˜¯è¯´ï¼Œnaliè¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥å¯¹æ ‡å‡†è¾“å‡ºçš„ipï¼Œé™„åŠ ä¸Šåœ°ç†ä¿¡æ¯ã€‚åŒç†ï¼Œå¦‚æœä½ ä¸å–œæ¬¢ç”¨nali-digï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç”¨dig ip|naliè¿™æ ·çš„å‘½ä»¤ã€‚ å¦‚æœä½ è§‰å¾—è¾“å…¥nali-xxxéº»çƒ¦ï¼Œé‚£ä¹ˆå¯ä»¥åšä¸€äº›aliasï¼Œä¾‹å¦‚ï¼š vim /root/.bashrcalias traceroute=â€™nali-tracerouteâ€™alias dig=â€™nali-digâ€™","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}],"tags":[],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}]},{"title":"Nagios-NRPEè„šæœ¬è¿”å›å€¼","slug":"nagios-nrpe-e8-84-9a-e6-9c-ac-e8-bf-94-e5-9b-9e-e5-80-bc","date":"2014-02-08T07:34:42.000Z","updated":"2025-09-01T01:59:08.884Z","comments":true,"path":"2014/02/08/nagios-nrpe-e8-84-9a-e6-9c-ac-e8-bf-94-e5-9b-9e-e5-80-bc/","permalink":"https://blog.sctux.cc/2014/02/08/nagios-nrpe-e8-84-9a-e6-9c-ac-e8-bf-94-e5-9b-9e-e5-80-bc/","excerpt":"è‡ªå®šä¹‰Nagios NRPEè„šæœ¬EXITé€€å‡ºå€¼å’ŒnagiosçŠ¶æ€éƒ½åº”å…³ç³»ï¼š çŠ¶æ€ EXITé€€å‡ºå€¼ è¾“å‡º ä¾‹å­ OK 0 echo â€œOK - itâ€™s ok.â€ echo â€œOK - itâ€™s ok.â€ exit 0 WARNING","text":"è‡ªå®šä¹‰Nagios NRPEè„šæœ¬EXITé€€å‡ºå€¼å’ŒnagiosçŠ¶æ€éƒ½åº”å…³ç³»ï¼š çŠ¶æ€ EXITé€€å‡ºå€¼ è¾“å‡º ä¾‹å­ OK 0 echo â€œOK - itâ€™s ok.â€ echo â€œOK - itâ€™s ok.â€ exit 0 WARNING 1 echo â€œWARNING - itâ€™s warning.â€ echo â€œWARNING - itâ€™s warning.â€ exit 1 CRITICAL 2 echo â€œCRITICAL - itâ€™s critical.â€ echo â€œCRITICAL - itâ€™s critical.â€ exit 2 UNKNOWN 3 echo â€œUNKNOWN - itâ€™s unknown.â€ echo â€œUNKNOWN - itâ€™s unknown.â€ exit 3 é”™è¯¯çš„ä¾‹å­ï¼š shellè„šæœ¬ä¸­echoå’Œé€€å‡ºå€¼ï¼š echo â€œOK - itâ€™s ok.â€ exit 1 æ­¤æ—¶ï¼ŒNagiosä¼šæ˜¾ç¤ºï¼š è¿™æ¡æœåŠ¡å¯¹åº”çš„çŠ¶æ€æ˜¯â€WARNINGâ€œï¼Œä½†æ˜¯è¾“å‡ºçš„ä¿¡æ¯æ˜¯â€OK - itâ€™s ok.â€","categories":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}],"tags":[{"name":"nrpe","slug":"nrpe","permalink":"https://blog.sctux.cc/tags/nrpe/"}],"keywords":[{"name":"å¿…å¤‡çŸ¥è¯†","slug":"å¿…å¤‡çŸ¥è¯†","permalink":"https://blog.sctux.cc/categories/%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86/"}]},{"title":"Vsftp å¼€å¯ PASVæ¨¡å¼","slug":"vsftp-e5-bc-80-e5-90-af-pasv-e6-a8-a1-e5-bc-8f","date":"2013-06-19T06:01:31.000Z","updated":"2025-09-01T01:59:08.958Z","comments":true,"path":"2013/06/19/vsftp-e5-bc-80-e5-90-af-pasv-e6-a8-a1-e5-bc-8f/","permalink":"https://blog.sctux.cc/2013/06/19/vsftp-e5-bc-80-e5-90-af-pasv-e6-a8-a1-e5-bc-8f/","excerpt":"ä»Šå¤©åº”è€å¤§è¦æ±‚è¦åœ¨ä¸€å°åœ¨å…¬ç½‘çš„æœºå™¨é…ç½®ä¸€ä¸ªvsftpæœåŠ¡ï¼Œé…ç½®å¥½ä¹‹åå±…ç„¶ä¸èƒ½ç”¨ï¼Œç”šæ˜¯çº³é—·ï¼Œå…·ä½“æŠ¥é”™å¦‚ä¸‹å›¾ï¼š 1ã€æˆ‘åœ¨æœ¬æœº ftp localhost å´ä¸€ç‚¹æ²¡æœ‰é—®é¢˜ï¼Ÿ 2ã€ä¸ºä»€ä¹ˆä¸€å‡ºå¤–ç½‘å°±æœ‰é—®é¢˜ï¼Ÿ 3ã€è¿™å°æœåŠ¡å™¨åœ¨å…¬ç½‘ï¼Œåœ¨é˜²ç«å¢™åé¢ï¼Œæœ¬æœºiptablesæ˜¯åœäº†çš„ï¼› 4ã€ä»¥å‰éƒ½æ˜¯åœ¨å†…ç½‘ï¼Œç”šè‡³æ˜¯åŒä¸€ä¸ªç½‘æ®µæ­å»ºvsftpæ¥ä½¿ç”¨ï¼› 5ã€vsftpçš„é…ç½®éå¸¸çš„ç®€å•ï¼Œéš¾é“è¿˜æœ‰äº›åœ°æ–¹æœ‰ç–æ¼ï¼Ÿ è§£å†³æ–¹æ³•ï¼š 1ã€åœ¨/etc/vsftpd/vsftpd.confæœ«å°¾æ·»åŠ ï¼š #YESï¼Œå…è®¸æ•°æ®ä¼ è¾“æ—¶ä½¿ç”¨PASVæ¨¡å¼ã€‚NOï¼Œä¸å…è®¸ä½¿ç”¨PASVæ¨¡å¼ã€‚é»˜è®¤å€¼ä¸ºYESã€‚pasv_enable=YES #è®¾å®šåœ¨PASVæ¨¡å¼ä¸‹ï¼Œå»ºç«‹æ•°æ®ä¼ è¾“æ‰€å¯ä»¥ä½¿ç”¨portèŒƒå›´çš„ä¸‹ç•Œå’Œä¸Šç•Œï¼Œ0 è¡¨ç¤ºä»»æ„ã€‚é»˜è®¤å€¼ä¸º0ã€‚æŠŠç«¯å£èŒƒå›´è®¾åœ¨æ¯”è¾ƒé«˜çš„ä¸€æ®µèŒƒå›´å†…ï¼Œæ¯”å¦‚50000-60000ï¼Œå°†æœ‰åŠ©äºå®‰å…¨æ€§çš„æé«˜.pasv_min_port=30000pasv_max_port=30005 #æ­¤é€‰é¡¹ä¸ºä¸€ä¸ªæ•°å­—IPåœ°å€ï¼Œä½œä¸ºPASVå‘½ä»¤çš„å“åº”ã€‚é»˜è®¤å€¼ä¸ºnoneï¼Œå³åœ°å€æ˜¯ä»å‘¼å…¥çš„è¿æ¥å¥—æ¥å­—(incoming connectd socket)ä¸­è·å–ã€‚pasv_address=xxxxxxxxx #æˆ‘è¿™é‡Œé…ç½®çš„æ˜¯è¿™å°æœåŠ¡å™¨çš„å¤–ç½‘IP #æ­¤é€‰é¡¹æ¿€æ´»æ—¶ï¼Œå°†å…³é—­PASVæ¨¡å¼çš„å®‰å…¨æ£€æŸ¥ã€‚è¯¥æ£€æŸ¥ç¡®ä¿æ•°æ®è¿æ¥å’Œæ§åˆ¶è¿æ¥æ˜¯æ¥è‡ªåŒä¸€ä¸ªIPåœ°å€ã€‚å°å¿ƒæ‰“å¼€æ­¤é€‰é¡¹ã€‚æ­¤é€‰é¡¹å”¯ä¸€åˆç†çš„ç”¨æ³•æ˜¯å­˜åœ¨äºç”±å®‰å…¨éš§é“æ–¹æ¡ˆæ„æˆçš„ç»„ç»‡ä¸­ã€‚é»˜è®¤å€¼ä¸ºNO#pasv_promiscuous=NO 2ã€åœ¨é˜²ç«å¢™ä¸Šå¼€å¯30000-30005ç«¯å£ã€‚ 3ã€é‡å¯vsftpdæœåŠ¡ /etc/init.d/vsftpd restart å®¢æˆ·ç«¯å†æ¬¡è®¿é—®å°±æ­£å¸¸å•¦ï¼š","text":"ä»Šå¤©åº”è€å¤§è¦æ±‚è¦åœ¨ä¸€å°åœ¨å…¬ç½‘çš„æœºå™¨é…ç½®ä¸€ä¸ªvsftpæœåŠ¡ï¼Œé…ç½®å¥½ä¹‹åå±…ç„¶ä¸èƒ½ç”¨ï¼Œç”šæ˜¯çº³é—·ï¼Œå…·ä½“æŠ¥é”™å¦‚ä¸‹å›¾ï¼š 1ã€æˆ‘åœ¨æœ¬æœº ftp localhost å´ä¸€ç‚¹æ²¡æœ‰é—®é¢˜ï¼Ÿ 2ã€ä¸ºä»€ä¹ˆä¸€å‡ºå¤–ç½‘å°±æœ‰é—®é¢˜ï¼Ÿ 3ã€è¿™å°æœåŠ¡å™¨åœ¨å…¬ç½‘ï¼Œåœ¨é˜²ç«å¢™åé¢ï¼Œæœ¬æœºiptablesæ˜¯åœäº†çš„ï¼› 4ã€ä»¥å‰éƒ½æ˜¯åœ¨å†…ç½‘ï¼Œç”šè‡³æ˜¯åŒä¸€ä¸ªç½‘æ®µæ­å»ºvsftpæ¥ä½¿ç”¨ï¼› 5ã€vsftpçš„é…ç½®éå¸¸çš„ç®€å•ï¼Œéš¾é“è¿˜æœ‰äº›åœ°æ–¹æœ‰ç–æ¼ï¼Ÿ è§£å†³æ–¹æ³•ï¼š 1ã€åœ¨/etc/vsftpd/vsftpd.confæœ«å°¾æ·»åŠ ï¼š #YESï¼Œå…è®¸æ•°æ®ä¼ è¾“æ—¶ä½¿ç”¨PASVæ¨¡å¼ã€‚NOï¼Œä¸å…è®¸ä½¿ç”¨PASVæ¨¡å¼ã€‚é»˜è®¤å€¼ä¸ºYESã€‚pasv_enable=YES #è®¾å®šåœ¨PASVæ¨¡å¼ä¸‹ï¼Œå»ºç«‹æ•°æ®ä¼ è¾“æ‰€å¯ä»¥ä½¿ç”¨portèŒƒå›´çš„ä¸‹ç•Œå’Œä¸Šç•Œï¼Œ0 è¡¨ç¤ºä»»æ„ã€‚é»˜è®¤å€¼ä¸º0ã€‚æŠŠç«¯å£èŒƒå›´è®¾åœ¨æ¯”è¾ƒé«˜çš„ä¸€æ®µèŒƒå›´å†…ï¼Œæ¯”å¦‚50000-60000ï¼Œå°†æœ‰åŠ©äºå®‰å…¨æ€§çš„æé«˜.pasv_min_port=30000pasv_max_port=30005 #æ­¤é€‰é¡¹ä¸ºä¸€ä¸ªæ•°å­—IPåœ°å€ï¼Œä½œä¸ºPASVå‘½ä»¤çš„å“åº”ã€‚é»˜è®¤å€¼ä¸ºnoneï¼Œå³åœ°å€æ˜¯ä»å‘¼å…¥çš„è¿æ¥å¥—æ¥å­—(incoming connectd socket)ä¸­è·å–ã€‚pasv_address=xxxxxxxxx #æˆ‘è¿™é‡Œé…ç½®çš„æ˜¯è¿™å°æœåŠ¡å™¨çš„å¤–ç½‘IP #æ­¤é€‰é¡¹æ¿€æ´»æ—¶ï¼Œå°†å…³é—­PASVæ¨¡å¼çš„å®‰å…¨æ£€æŸ¥ã€‚è¯¥æ£€æŸ¥ç¡®ä¿æ•°æ®è¿æ¥å’Œæ§åˆ¶è¿æ¥æ˜¯æ¥è‡ªåŒä¸€ä¸ªIPåœ°å€ã€‚å°å¿ƒæ‰“å¼€æ­¤é€‰é¡¹ã€‚æ­¤é€‰é¡¹å”¯ä¸€åˆç†çš„ç”¨æ³•æ˜¯å­˜åœ¨äºç”±å®‰å…¨éš§é“æ–¹æ¡ˆæ„æˆçš„ç»„ç»‡ä¸­ã€‚é»˜è®¤å€¼ä¸ºNO#pasv_promiscuous=NO 2ã€åœ¨é˜²ç«å¢™ä¸Šå¼€å¯30000-30005ç«¯å£ã€‚ 3ã€é‡å¯vsftpdæœåŠ¡ /etc/init.d/vsftpd restart å®¢æˆ·ç«¯å†æ¬¡è®¿é—®å°±æ­£å¸¸å•¦ï¼š","categories":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}],"tags":[],"keywords":[{"name":"æ•…éšœå¤„ç†","slug":"æ•…éšœå¤„ç†","permalink":"https://blog.sctux.cc/categories/%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86/"}]}]}