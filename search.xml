<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>æ±‚èŒ-ç³»ç»Ÿè¿ç»´/SREæ–¹å‘</title>
      <link href="/2025/08/29/%E6%B1%82%E8%81%8C%E5%B8%96/"/>
      <url>/2025/08/29/%E6%B1%82%E8%81%8C%E5%B8%96/</url>
      
        <content type="html"><![CDATA[<p>å„ä½æœ‹å‹ï¼Œå¤§å®¶å¥½ï¼</p><p>æˆ‘äºä»Šå¹´7æœˆåº•æ­£å¼ç¦»èŒï¼Œç»“æŸäº†ä¸Šä¸€æ®µå·¥ä½œæ—…ç¨‹ã€‚ç›®å‰æ­£åœ¨å¯»æ‰¾ä¸‹ä¸€ä»½ç³»ç»Ÿè¿ç»´æˆ–SREç›¸å…³çš„å·¥ä½œï¼Œå¸Œæœ›èƒ½å€ŸåŠ©å¤§å®¶çš„åŠ›é‡ã€‚</p><p>æˆ‘æœ‰10å¹´å·¦å³çš„è¿ç»´ç»éªŒï¼Œç†Ÿæ‚‰Linuxã€ç½‘ç»œã€Kubernetesã€ç›‘æ§å’Œè‡ªåŠ¨åŒ–å¼€å‘ã€‚åœ¨è¿‡å»çš„å·¥ä½œä¸­ï¼Œæˆ‘è´Ÿè´£ç»´æŠ¤ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œï¼Œå¤„ç†è¿‡ä¸€äº›æ•…éšœï¼Œä¹Ÿå‚ä¸ä»ä¼ ç»Ÿæ¶æ„åˆ°äº‘åŸç”Ÿæ¶æ„çš„è¿ç§»å’Œè½¬å‹ã€‚æˆ‘å¯èƒ½ä¸æ˜¯æœ€é¡¶å°–çš„å¤§ç‰›ï¼Œä½†æˆ‘ç›¸ä¿¡è‡ªå·±æœ‰å¾ˆå¼ºçš„è´£ä»»å¿ƒã€å­¦ä¹ èƒ½åŠ›å’Œå›¢é˜Ÿåä½œç²¾ç¥ï¼Œèƒ½è„šè¸å®åœ°åœ°å®Œæˆä»»åŠ¡ã€‚</p><p>æˆ‘éå¸¸æ¸´æœ›èƒ½åŠ å…¥ä¸€ä¸ªä¼˜ç§€çš„å›¢é˜Ÿï¼Œä¸å¤§å®¶å…±åŒæˆé•¿ï¼Œä¸ºå…¬å¸åˆ›é€ ä»·å€¼ã€‚</p><p>å¦‚æœæ‚¨æ‰€åœ¨å›¢é˜Ÿæœ‰æ‹›è˜éœ€æ±‚ï¼Œæˆ–è€…æœ‰ç›¸å…³çš„ä¿¡æ¯ï¼Œæ³è¯·æ‚¨ä¸åæ¨èæˆ–è”ç³»æˆ‘ã€‚æ„Ÿæ¿€ä¸å°½ï¼</p><p><strong>ğŸ“ æˆ‘çš„è”ç³»æ–¹å¼</strong><br>æ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸æˆ‘äº¤æµï¼š</p><ul><li>ğŸ“§ é‚®ç®±ï¼š<a href="mailto:guomaoqiu@icloud.com">guomaoqiu@icloud.com</a></li><li>ğŸ“ TG: <a href="https://t.me/noardguo_devops">@noardguo_devops</a></li><li>ğŸ’» GitHubï¼š<a href="https://github.com/guomaoqiu">https://github.com/guomaoqiu</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Dockeræ„å»ºæ—¥å¿—æ”¶é›†å¹³å°EFK(TLS)</title>
      <link href="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/"/>
      <url>/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å¦‚é¢˜ï¼Œ ä¸»è¦è®°å½•ä¸€ä¸‹ä¹‹å‰æ­å»ºéƒ¨ç½²çš„ä¸€å¥—æ—¥å¿—æ”¶é›†ç³»ç»Ÿã€‚è¿™é‡Œé‡‡ç”¨docker-composeçš„æ–¹å¼è¿è¡Œï¼Œè¿˜æ˜¯é‚£å¥è¯ä¸»è¦æ˜¯æ€è·¯ã€‚</p><p>æ–¹å¼: <code>ä¸€å°æœåŠ¡å™¨ä¸Šé¢åˆ©ç”¨docker-composeè¿è¡Œä¸‰ä¸ªESèŠ‚ç‚¹è·ŸKibana,å¹¶å¯ç”¨SSL,å†ä½¿ç”¨Filebeatæ¥æ”¶é›†æœåŠ¡å™¨ä¸Šé¢çš„åº”ç”¨æ—¥å¿—åˆ°ESï¼Œ æœ€åKibanaæ¥åšå±•ç¤º</code></p><h1 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h1><h3 id="ç›®å½•åˆ›å»º"><a href="#ç›®å½•åˆ›å»º" class="headerlink" title="ç›®å½•åˆ›å»º"></a>ç›®å½•åˆ›å»º</h3><figure class="highlight haskell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/{<span class="title">es</span>/<span class="title">node</span>-1/{<span class="title">data</span>,<span class="title">certs</span>,<span class="title">logs</span>,<span class="title">config</span>},plugins}</span></span><br><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/{<span class="title">es</span>/<span class="title">node</span>-2/{<span class="title">data</span>,<span class="title">certs</span>,<span class="title">logs</span>,<span class="title">config</span>},plugins}</span></span><br><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/{<span class="title">es</span>/<span class="title">node</span>-3/{<span class="title">data</span>,<span class="title">certs</span>,<span class="title">logs</span>,<span class="title">config</span>},plugins}</span></span><br><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/kibana/{<span class="title">certs</span>,<span class="title">config</span>} -p</span></span><br></pre></td></tr></tbody></table></figure><h3 id="éƒ¨ç½²æ–‡ä»¶"><a href="#éƒ¨ç½²æ–‡ä»¶" class="headerlink" title="éƒ¨ç½²æ–‡ä»¶"></a>éƒ¨ç½²æ–‡ä»¶</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="params">services:</span></span><br><span class="line">  <span class="params">node-1:</span></span><br><span class="line">    <span class="params">image:</span> registry.cn-hangzhou.aliyuncs.com<span class="operator">/</span>bigdata_cloudnative<span class="operator">/</span>elasticsearch:<span class="number">7.17</span>.<span class="number">5</span></span><br><span class="line">    <span class="params">networks:</span> </span><br><span class="line">      <span class="params">bitdata:</span></span><br><span class="line">        <span class="params">ipv4_address:</span> <span class="number">172.20</span>.<span class="number">0.3</span></span><br><span class="line">    <span class="params">container_name:</span> node-<span class="number">1</span></span><br><span class="line">    <span class="params">hostname:</span> node-<span class="number">1</span></span><br><span class="line">    <span class="params">environment:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"ES_JAVA_OPTS=-Xms1024m -Xmx1024m"</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"TZ=Asia/Shanghai"</span></span><br><span class="line">    <span class="params">ulimits:</span></span><br><span class="line">      <span class="params">memlock:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">        <span class="params">hard:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">      <span class="params">nofile:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="number">65536</span></span><br><span class="line">        <span class="params">hard:</span> <span class="number">65536</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"9200:9200"</span></span><br><span class="line">    <span class="params">logging:</span></span><br><span class="line">      <span class="params">driver:</span> <span class="string">"json-file"</span></span><br><span class="line">      <span class="params">options:</span></span><br><span class="line">        <span class="params">max-size:</span> <span class="string">"50m"</span></span><br><span class="line">    <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">1</span><span class="operator">/</span>config<span class="operator">/</span>elasticsearch.yml:<span class="symbol">/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>plugins:<span class="symbol">/usr/share/elasticsearch/plugins</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">1</span><span class="operator">/</span>data:<span class="symbol">/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">1</span><span class="operator">/</span>certs:<span class="symbol">/usr/share/elasticsearch/config/certs</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">1</span><span class="operator">/</span>log:<span class="symbol">/usr/share/elasticsearch/log</span></span><br><span class="line">    <span class="params">healthcheck:</span></span><br><span class="line">      <span class="params">test:</span> [<span class="string">"CMD-SHELL"</span>, <span class="string">"curl -I http://localhost:9200 || exit 1"</span>]</span><br><span class="line">      <span class="params">interval:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">timeout:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">retries:</span> <span class="number">5</span></span><br><span class="line">  <span class="params">node-2:</span></span><br><span class="line">    <span class="params">image:</span> registry.cn-hangzhou.aliyuncs.com<span class="operator">/</span>bigdata_cloudnative<span class="operator">/</span>elasticsearch:<span class="number">7.17</span>.<span class="number">5</span></span><br><span class="line">    <span class="params">networks:</span> </span><br><span class="line">      <span class="params">bitdata:</span></span><br><span class="line">        <span class="params">ipv4_address:</span> <span class="number">172.20</span>.<span class="number">0.4</span></span><br><span class="line">    <span class="params">container_name:</span> node-<span class="number">2</span></span><br><span class="line">    <span class="params">hostname:</span> node-<span class="number">2</span></span><br><span class="line">    <span class="params">environment:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"ES_JAVA_OPTS=-Xms1024m -Xmx1024m"</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"TZ=Asia/Shanghai"</span></span><br><span class="line">    <span class="params">ulimits:</span></span><br><span class="line">      <span class="params">memlock:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">        <span class="params">hard:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">      <span class="params">nofile:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="number">65536</span></span><br><span class="line">        <span class="params">hard:</span> <span class="number">65536</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"9201:9200"</span></span><br><span class="line">    <span class="params">logging:</span></span><br><span class="line">      <span class="params">driver:</span> <span class="string">"json-file"</span></span><br><span class="line">      <span class="params">options:</span></span><br><span class="line">        <span class="params">max-size:</span> <span class="string">"50m"</span></span><br><span class="line">    <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">2</span><span class="operator">/</span>config<span class="operator">/</span>elasticsearch.yml:<span class="symbol">/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>plugins:<span class="symbol">/usr/share/elasticsearch/plugins</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">2</span><span class="operator">/</span>data:<span class="symbol">/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">2</span><span class="operator">/</span>certs:<span class="symbol">/usr/share/elasticsearch/config/certs</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">2</span><span class="operator">/</span>log:<span class="symbol">/usr/share/elasticsearch/log</span></span><br><span class="line">    <span class="params">healthcheck:</span></span><br><span class="line">      <span class="params">test:</span> [<span class="string">"CMD-SHELL"</span>, <span class="string">"curl -I http://localhost:9200 || exit 1"</span>]</span><br><span class="line">      <span class="params">interval:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">timeout:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">retries:</span> <span class="number">5</span></span><br><span class="line">  <span class="params">node-3:</span></span><br><span class="line">    <span class="params">image:</span> registry.cn-hangzhou.aliyuncs.com<span class="operator">/</span>bigdata_cloudnative<span class="operator">/</span>elasticsearch:<span class="number">7.17</span>.<span class="number">5</span></span><br><span class="line">    <span class="params">networks:</span> </span><br><span class="line">      <span class="params">bitdata:</span></span><br><span class="line">        <span class="params">ipv4_address:</span> <span class="number">172.20</span>.<span class="number">0.5</span></span><br><span class="line">    <span class="params">container_name:</span> node-<span class="number">3</span></span><br><span class="line">    <span class="params">hostname:</span> node-<span class="number">3</span></span><br><span class="line">    <span class="params">environment:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"ES_JAVA_OPTS=-Xms1024m -Xmx1024m"</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"TZ=Asia/Shanghai"</span></span><br><span class="line">    <span class="params">ulimits:</span></span><br><span class="line">      <span class="params">memlock:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">        <span class="params">hard:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">      <span class="params">nofile:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="number">65536</span></span><br><span class="line">        <span class="params">hard:</span> <span class="number">65536</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"9202:9200"</span></span><br><span class="line">    <span class="params">logging:</span></span><br><span class="line">      <span class="params">driver:</span> <span class="string">"json-file"</span></span><br><span class="line">      <span class="params">options:</span></span><br><span class="line">        <span class="params">max-size:</span> <span class="string">"50m"</span></span><br><span class="line">    <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">3</span><span class="operator">/</span>config<span class="operator">/</span>elasticsearch.yml:<span class="symbol">/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>plugins:<span class="symbol">/usr/share/elasticsearch/plugins</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">3</span><span class="operator">/</span>data:<span class="symbol">/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">3</span><span class="operator">/</span>certs:<span class="symbol">/usr/share/elasticsearch/config/certs</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">3</span><span class="operator">/</span>log:<span class="symbol">/usr/share/elasticsearch/log</span></span><br><span class="line">    <span class="params">healthcheck:</span></span><br><span class="line">      <span class="params">test:</span> [<span class="string">"CMD-SHELL"</span>, <span class="string">"curl -I http://localhost:9200 || exit 1"</span>]</span><br><span class="line">      <span class="params">interval:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">timeout:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">retries:</span> <span class="number">5</span></span><br><span class="line">  <span class="params">kibana:</span></span><br><span class="line">    <span class="params">networks:</span> </span><br><span class="line">      <span class="params">bitdata:</span></span><br><span class="line">        <span class="params">ipv4_address:</span> <span class="number">172.20</span>.<span class="number">0.6</span></span><br><span class="line">    <span class="params">container_name:</span> kibana</span><br><span class="line">    <span class="params">hostname:</span> kibana</span><br><span class="line">    <span class="params">image:</span> registry.cn-hangzhou.aliyuncs.com<span class="operator">/</span>bigdata_cloudnative<span class="operator">/</span>kibana:<span class="number">7.17</span>.<span class="number">5</span></span><br><span class="line">    <span class="params">environment:</span></span><br><span class="line">      <span class="params">TZ:</span> 'Asia<span class="operator">/</span>Shanghai'</span><br><span class="line">    <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>kibana<span class="operator">/</span>cert:<span class="symbol">/etc/kibana/cert</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>kibana<span class="operator">/</span>config<span class="operator">/</span>kibana.yml:<span class="symbol">/usr/share/kibana/config/kibana.yml</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">      <span class="operator">-</span> <span class="number">5601</span>:<span class="number">5601</span></span><br><span class="line">    <span class="params">healthcheck:</span></span><br><span class="line">      <span class="params">test:</span> [<span class="string">"CMD-SHELL"</span>, <span class="string">"curl -I http://localhost:5601 || exit 1"</span>]</span><br><span class="line">      <span class="params">interval:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">timeout:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥å¤–éƒ¨ç½‘ç»œ</span></span><br><span class="line"><span class="params">networks:</span></span><br><span class="line">  <span class="params">bitdata:</span></span><br><span class="line">    <span class="params">driver:</span> bridge</span><br><span class="line">    <span class="params">ipam:</span> </span><br><span class="line">      <span class="params">config:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">subnet:</span> <span class="number">172.20</span>.<span class="number">0.0</span><span class="operator">/</span><span class="number">24</span></span><br></pre></td></tr></tbody></table></figure><h2 id="éSSL"><a href="#éSSL" class="headerlink" title="éSSL"></a>éSSL</h2><h3 id="elasticsearch-yamlé…ç½®æ–‡ä»¶"><a href="#elasticsearch-yamlé…ç½®æ–‡ä»¶" class="headerlink" title="elasticsearch.yamlé…ç½®æ–‡ä»¶"></a>elasticsearch.yamlé…ç½®æ–‡ä»¶</h3><p>è¿™é‡Œä»¥<code>node-1</code>ä¸ºä¾‹ï¼Œå…¶ä»–ä¸åŒçš„åœ°æ–¹å°±æ˜¯ <code>node.name</code></p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="symbol">/data/es/node-1/config/elasticsearch.yml</span></span><br><span class="line"><span class="comment">#é›†ç¾¤åç§°</span></span><br><span class="line">cluster.<span class="params">name:</span> elastic</span><br><span class="line"><span class="comment">#å½“å‰è¯¥èŠ‚ç‚¹çš„åç§°</span></span><br><span class="line">node.<span class="params">name:</span> node-<span class="number">1</span></span><br><span class="line"><span class="comment">#æ˜¯ä¸æ˜¯æœ‰èµ„æ ¼ç«é€‰ä¸»èŠ‚ç‚¹</span></span><br><span class="line">node.<span class="params">master:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#æ˜¯å¦å­˜å‚¨æ•°æ®</span></span><br><span class="line">node.<span class="params">data:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#æœ€å¤§é›†ç¾¤èŠ‚ç‚¹æ•°</span></span><br><span class="line">node.<span class="params">max_local_storage_nodes:</span> <span class="number">3</span></span><br><span class="line"><span class="comment">#ç»™å½“å‰èŠ‚ç‚¹è‡ªå®šä¹‰å±æ€§ï¼ˆå¯ä»¥çœç•¥ï¼‰</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#æ•°æ®å­˜æ¡£ä½ç½®</span></span><br><span class="line">path.<span class="params">data:</span> <span class="symbol">/usr/share/elasticsearch/data</span></span><br><span class="line"><span class="comment">#æ—¥å¿—å­˜æ”¾ä½ç½®</span></span><br><span class="line">path.<span class="params">logs:</span> <span class="symbol">/usr/share/elasticsearch/log</span></span><br><span class="line"><span class="comment">#æ˜¯å¦å¼€å¯æ—¶é”å®šå†…å­˜ï¼ˆé»˜è®¤ä¸ºæ˜¯ï¼‰</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#è®¾ç½®ç½‘å…³åœ°å€ï¼Œæˆ‘æ˜¯è¢«è¿™ä¸ªå‘æ­»äº†ï¼Œè¿™ä¸ªåœ°å€æˆ‘åŸå…ˆå¡«å†™äº†è‡ªå·±çš„å®é™…ç‰©ç†IPåœ°å€ï¼Œ</span></span><br><span class="line"><span class="comment">#ç„¶åå¯åŠ¨ä¸€ç›´æŠ¥æ— æ•ˆçš„IPåœ°å€ï¼Œæ— æ³•æ³¨å…¥9300ç«¯å£ï¼Œè¿™é‡Œåªéœ€è¦å¡«å†™0.0.0.0</span></span><br><span class="line">network.<span class="params">host:</span> <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="comment">#è®¾ç½®æ˜ å°„ç«¯å£</span></span><br><span class="line">http.<span class="params">port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment">#å†…éƒ¨èŠ‚ç‚¹ä¹‹é—´æ²Ÿé€šç«¯å£</span></span><br><span class="line">transport.tcp.<span class="params">port:</span> <span class="number">9300</span></span><br><span class="line"><span class="comment">#é›†ç¾¤å‘ç°é»˜è®¤å€¼ä¸º127.0.0.1:9300,å¦‚æœè¦åœ¨å…¶ä»–ä¸»æœºä¸Šå½¢æˆåŒ…å«èŠ‚ç‚¹çš„ç¾¤é›†,å¦‚æœæ­å»ºé›†ç¾¤åˆ™éœ€è¦å¡«å†™</span></span><br><span class="line"><span class="comment">#es7.x ä¹‹åæ–°å¢çš„é…ç½®ï¼Œå†™å…¥å€™é€‰ä¸»èŠ‚ç‚¹çš„è®¾å¤‡åœ°å€ï¼Œåœ¨å¼€å¯æœåŠ¡åå¯ä»¥è¢«é€‰ä¸ºä¸»èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å†™ä¸Š</span></span><br><span class="line">discovery.<span class="params">seed_hosts:</span> [<span class="string">"172.20.0.3"</span>,<span class="string">"172.20.0.4"</span>,<span class="string">"172.17.0.5"</span>]</span><br><span class="line"><span class="comment">#å½“ä½ åœ¨æ­å»ºé›†ç¾¤çš„æ—¶å€™ï¼Œé€‰å‡ºåˆæ ¼çš„èŠ‚ç‚¹é›†ç¾¤ï¼Œæœ‰äº›äººè¯´çš„å¤ªå®˜æ–¹äº†ï¼Œ</span></span><br><span class="line"><span class="comment">#å…¶å®å°±æ˜¯ï¼Œè®©ä½ é€‰æ‹©æ¯”è¾ƒå¥½çš„å‡ ä¸ªèŠ‚ç‚¹ï¼Œåœ¨ä½ èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œåœ¨è¿™äº›èŠ‚ç‚¹ä¸­é€‰ä¸€ä¸ªåšé¢†å¯¼è€…ï¼Œ</span></span><br><span class="line"><span class="comment">#å¦‚æœä½ ä¸è®¾ç½®å‘¢ï¼Œelasticsearchå°±ä¼šè‡ªå·±é€‰ä¸¾ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠä¸‰ä¸ªèŠ‚ç‚¹éƒ½å†™ä¸Š</span></span><br><span class="line">cluster.<span class="params">initial_master_nodes:</span> [<span class="string">"node-1"</span>,<span class="string">"node-2"</span>,<span class="string">"node-3"</span>]</span><br><span class="line"><span class="comment">#åœ¨ç¾¤é›†å®Œå…¨é‡æ–°å¯åŠ¨åé˜»æ­¢åˆå§‹æ¢å¤ï¼Œç›´åˆ°å¯åŠ¨Nä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">#ç®€å•ç‚¹è¯´åœ¨é›†ç¾¤å¯åŠ¨åï¼Œè‡³å°‘å¤æ´»å¤šå°‘ä¸ªèŠ‚ç‚¹ä»¥ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡æ‰å¯ä»¥è¢«ä½¿ç”¨ï¼Œå¦åˆ™ä¸å¯ä»¥è¢«ä½¿ç”¨ï¼Œ</span></span><br><span class="line">gateway.<span class="params">recover_after_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="comment">#åˆ é™¤ç´¢å¼•æ˜¯æ˜¯å¦éœ€è¦æ˜¾ç¤ºå…¶åç§°ï¼Œé»˜è®¤ä¸ºæ˜¾ç¤º</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"><span class="comment"># ç¦ç”¨å®‰å…¨é…ç½®</span></span><br><span class="line">xpack.security.<span class="params">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure><h3 id="kibana-yaml"><a href="#kibana-yaml" class="headerlink" title="kibana.yaml"></a>kibana.yaml</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="symbol">/data/kibana/config/kibana.yml</span></span><br><span class="line">server.<span class="params">host:</span> <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="comment"># ç›‘å¬ç«¯å£</span></span><br><span class="line">server.<span class="params">port:</span> <span class="number">5601</span></span><br><span class="line">server.<span class="params">name:</span> <span class="string">"kibana"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kibanaè®¿é—®esæœåŠ¡å™¨çš„URL,å°±å¯ä»¥æœ‰å¤šä¸ªï¼Œä»¥é€—å·","éš”å¼€</span></span><br><span class="line">elasticsearch.<span class="params">hosts:</span> [<span class="string">"http://172.20.0.3:9200"</span>,<span class="string">"http://172.20.0.4:9200"</span>,<span class="string">"http://172.20.0.5:9200"</span>]</span><br><span class="line">monitoring.ui.container.elasticsearch.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># kibanaè®¿é—®Elasticsearchçš„è´¦å·ä¸å¯†ç (å¦‚æœElasticSearchè®¾ç½®äº†çš„è¯)</span></span><br><span class="line">elasticsearch.<span class="params">username:</span> <span class="string">""</span></span><br><span class="line">elasticsearch.<span class="params">password:</span> <span class="string">""</span></span><br><span class="line"><span class="comment"># kibana webè¯­è¨€</span></span><br><span class="line">i18n.<span class="params">locale:</span> <span class="string">"zh-CN"</span></span><br></pre></td></tr></tbody></table></figure><h3 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h3><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ip-<span class="number">10</span>-<span class="number">10</span>-<span class="number">10</span>-<span class="number">29</span>:/data<span class="comment"># docker-compose up -d</span></span><br><span class="line">[+] Running <span class="number">5</span>/<span class="number">5</span></span><br><span class="line"> â ¿ Network data_bitdata  Created                                                 <span class="number">0.0s</span></span><br><span class="line"> â ¿ Container <span class="keyword">node</span><span class="title">-2</span>      <span class="literal">Started</span>                                                 <span class="number">0.6s</span></span><br><span class="line"> â ¿ Container <span class="keyword">node</span><span class="title">-3</span>      <span class="literal">Started</span>                                                 <span class="number">0.8s</span></span><br><span class="line"> â ¿ Container <span class="keyword">node</span><span class="title">-1</span>      <span class="literal">Started</span>                                                 <span class="number">0.8s</span></span><br><span class="line"> â ¿ Container kibana      <span class="literal">Started</span>                                                 <span class="number">0.5s</span></span><br><span class="line"></span><br><span class="line">CONTAINER ID   IMAGE                                                                        COMMAND                  CREATED              STATUS                         PORTS                                                  NAMES</span><br><span class="line"><span class="number">4</span>d5dae9021be   registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:<span class="number">7.17</span>.<span class="number">5</span>   <span class="string">"/bin/tini -- /usr/lâ€¦"</span>   About a minute ago   Up About a minute (healthy)    <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9200</span>-&gt;<span class="number">9200</span>/tcp, :::<span class="number">9200</span>-&gt;<span class="number">9200</span>/tcp, <span class="number">9300</span>/tcp    <span class="keyword">node</span><span class="title">-1</span></span><br><span class="line"><span class="number">84</span>e191d6f875   registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:<span class="number">7.17</span>.<span class="number">5</span>   <span class="string">"/bin/tini -- /usr/lâ€¦"</span>   About a minute ago   Up About a minute (healthy)    <span class="number">9300</span>/tcp, <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9202</span>-&gt;<span class="number">9200</span>/tcp, :::<span class="number">9202</span>-&gt;<span class="number">9200</span>/tcp    <span class="keyword">node</span><span class="title">-3</span></span><br><span class="line"><span class="number">758</span>a4bff2a73   registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:<span class="number">7.17</span>.<span class="number">5</span>   <span class="string">"/bin/tini -- /usr/lâ€¦"</span>   About a minute ago   Up About a minute (healthy)    <span class="number">9300</span>/tcp, <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9201</span>-&gt;<span class="number">9200</span>/tcp, :::<span class="number">9201</span>-&gt;<span class="number">9200</span>/tcp    <span class="keyword">node</span><span class="title">-2</span></span><br><span class="line">fe55f0446902   registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/kibana:<span class="number">7.17</span>.<span class="number">5</span>          <span class="string">"/bin/tini -- /usr/lâ€¦"</span>   About a minute ago   Up About a minute (healthy)    <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">5601</span>-&gt;<span class="number">5601</span>/tcp, :::<span class="number">5601</span>-&gt;<span class="number">5601</span>/tcp              kibana</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢å·²ç»å¯åŠ¨ï¼Œå¦‚æœæœ‰æŠ¥é”™æŸ¥çœ‹å®¹å™¨æ—¥å¿—å°±è¡Œäº†ï¼Œä¹‹å‰éƒ¨ç½²çš„æ—¶å€™æŠ¥é”™å†…å®¹è¿˜æ˜¯å¾ˆæ¸…æ™°</p><p>è¿›å…¥å®¹å™¨æŸ¥çœ‹ï¼š</p><figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># curl localhost:9200</span></span><br><span class="line">{</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"node-1"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elastic"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"tcKUxyWVQb-7LV4zmomsgg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : {</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.17.5"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2022-06-23T21:57:28.736740635Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.11.1"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">}</span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># curl 172.20.3:9200</span></span><br><span class="line">{</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"node-1"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elastic"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"tcKUxyWVQb-7LV4zmomsgg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : {</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.17.5"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2022-06-23T21:57:28.736740635Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.11.1"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">}</span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># curl 172.20.4:9200</span></span><br><span class="line">{</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"node-2"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elastic"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"tcKUxyWVQb-7LV4zmomsgg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : {</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.17.5"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2022-06-23T21:57:28.736740635Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.11.1"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">}</span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># curl 172.20.5:9200</span></span><br><span class="line">{</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"node-3"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elastic"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"tcKUxyWVQb-7LV4zmomsgg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : {</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.17.5"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2022-06-23T21:57:28.736740635Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.11.1"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">}</span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data</span><span class="comment"># curl -s 172.20.0.3:9200/_cluster/health | python3 -m json.tool</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"cluster_name"</span>: <span class="string">"elastic"</span>,</span><br><span class="line">    <span class="string">"status"</span>: <span class="string">"green"</span>,</span><br><span class="line">    <span class="string">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"number_of_nodes"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">"number_of_data_nodes"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">"active_primary_shards"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">"active_shards"</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="string">"relocating_shards"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"initializing_shards"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"unassigned_shards"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"delayed_unassigned_shards"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"number_of_pending_tasks"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"number_of_in_flight_fetch"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"task_max_waiting_in_queue_millis"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"active_shards_percent_as_number"</span>: <span class="number">100.0</span></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šè¯´æ˜ESé›†ç¾¤å·²ç»æ­£å¸¸å·¥ä½œï¼Œçœ‹ä¸€ä¸‹é€šè¿‡nginxä»£ç†è½¬å‘åˆ°kibanaçš„ç»“æœ</p><p><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/1.png"></p><p>kibanaä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼Œåªæ˜¯è¿™é‡Œåœ¨è®¿é—®çš„æ—¶å€™ç›´æ¥å°±è¿›å…¥äº†kibanaï¼Œå¦‚æœä¸åŠ ä¸€ä¸ªèº«ä»½éªŒè¯åŠŸèƒ½ï¼Œè¿™å°±ç­‰äºè£¸å¥”ï¼Œå³ä¾¿åœ¨æ”¾åœ¨å†…ç½‘ä¹Ÿæ˜¯æå…¶ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸€ä¸ªèº«ä»½éªŒè¯ã€‚</p><h2 id="SSLæ–¹å¼"><a href="#SSLæ–¹å¼" class="headerlink" title="SSLæ–¹å¼"></a>SSLæ–¹å¼</h2><p>åˆ©ç”¨è‡ªå¸¦çš„å·¥å…·ç”Ÿæˆè¯ä¹¦ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œç”Ÿæˆè¯ä¹¦ï¼Œä½†æ³¨æ„è¦é™åˆ¶åŸŸåå’ŒIPï¼Œå¦åˆ™åœ¨è¿›è¡Œhttpsé€šè®¯æ—¶ä¼šæ ¡éªŒå¤±è´¥</p><p>è¿›å…¥node-1å®¹å™¨ ï¼Œæ“ä½œ</p><figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:~</span><span class="comment"># docker exec -it node-1 bash</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®å®é™…æƒ…å†µé…ç½®ç”Ÿæˆè¯ä¹¦çš„yaml</span></span><br><span class="line">cat &lt;&lt;<span class="title class_">EOF</span> &gt; /usr/share/elasticsearch/node.yml</span><br><span class="line"><span class="symbol">instances:</span></span><br><span class="line">  - <span class="symbol">name:</span> <span class="string">"node"</span></span><br><span class="line">    <span class="symbol">ip:</span></span><br><span class="line">      - <span class="string">"172.20.0.3"</span></span><br><span class="line">      - <span class="string">"172.20.0.4"</span></span><br><span class="line">      - <span class="string">"172.20.0.5"</span></span><br><span class="line">      - <span class="string">"127.0.0.1"</span></span><br><span class="line">      - <span class="string">"172.20.0.6"</span></span><br><span class="line">      - <span class="string">"10.10.10.29"</span> <span class="comment"># è¿™ä¸ªIPæ˜¯æœåŠ¡å™¨çš„IPåœ°å€ï¼Œå› ä¸ºæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯dockerè¿è¡Œesé›†ç¾¤ï¼Œè¿™ä¸ªå¿…é¡»åŠ ä¸Šå»</span></span><br><span class="line">    <span class="symbol">dns:</span></span><br><span class="line">      - <span class="string">"node-1"</span></span><br><span class="line">      - <span class="string">"node-2"</span></span><br><span class="line">      - <span class="string">"node-3 "</span></span><br><span class="line">      - <span class="string">"localhost"</span></span><br><span class="line">      - <span class="string">"kibana"</span></span><br><span class="line">      - <span class="string">"others"</span></span><br><span class="line"><span class="title class_">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆcaè¯ä¹¦ï¼Œé»˜è®¤æ–‡ä»¶åä¸ºelastic-stack-ca.p12ï¼Œå¯æ·»åŠ å¯†ç </span></span><br><span class="line">bin/elasticsearch-certutil ca <span class="comment"># ä¸€è·¯å›è½¦å³å¯</span></span><br><span class="line"><span class="comment"># ç”Ÿæˆè¯ä¹¦ï¼Œé»˜è®¤æ–‡ä»¶åä¸ºcertificate-bundle.zip</span></span><br><span class="line">bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 --silent --<span class="keyword">in</span> node.yml  <span class="comment"># ä¸€è·¯å›è½¦å³å¯</span></span><br><span class="line"><span class="comment"># å°†è¯ä¹¦å¤åˆ¶åˆ°node-1é…ç½®ç›®å½•ä¸‹</span></span><br><span class="line"></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># cp certificate-bundle.zip elastic-stack-ca.p12 config/certs/</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># cd config/certs/</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># ls</span></span><br><span class="line">certificate-bundle.zip  elastic-stack-ca.p12</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹è¯ä¹¦ï¼Œç›®å½•ç»“æ„ä¸º å®ä¾‹å/å®ä¾‹å.p12 ,æ­¤å¤„ä¸ºnode/node.p12</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># unzip certificate-bundle.zip </span></span><br><span class="line"><span class="symbol">Archive:</span>  certificate-bundle.zip</span><br><span class="line">   <span class="symbol">creating:</span> node/</span><br><span class="line">  <span class="symbol">inflating:</span> node/node.p12           </span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># ls</span></span><br><span class="line">certificate-bundle.zip  elastic-stack-ca.p12  node</span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># ls node/</span></span><br><span class="line">node.p12</span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># rm -rf node certificate-bundle.zip</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># ls</span></span><br><span class="line">certificate-bundle.zip  elastic-stack-ca.p12  node.p12</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹è¯ä¹¦è®¿é—®æƒé™</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config</span><span class="comment"># chown -R root:elasticsearch certs/       </span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config</span><span class="comment"># chmod -R a+rx certs/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶æˆ‘ä»¬éœ€è¦çš„è¯ä¹¦å·²ç»ç”Ÿæˆäº†ï¼ŒåŒæ ·çš„æ–¹å¼å¤åˆ¶åˆ°node-2,node3åä¿®æ”¹æƒé™ï¼Œä¿®æ”¹å±ä¸»ç­‰æ“ä½œ</span></span><br><span class="line"><span class="comment"># é€€å‡ºå®¹å™¨,è¿›å…¥node-1çš„æŒ‚åœ¨ç›®å½•ï¼š</span></span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span>/certs<span class="comment"># pwd</span></span><br><span class="line">/data/es/node<span class="number">-1</span>/certs</span><br><span class="line"></span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span>/certs<span class="comment"># cd ..</span></span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span><span class="comment"># ls</span></span><br><span class="line">certs  config  data  log</span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span><span class="comment"># cp -rf certs ../node-2/</span></span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span><span class="comment"># cp -rf certs ../node-3/</span></span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span><span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯ä¹¦å·²ç»å‡†å¤‡å®Œæ¯•</span></span><br><span class="line">es/</span><br><span class="line">â”œâ”€â”€ node<span class="number">-1</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ certs</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elastic-stack-ca.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ node.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ config</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elasticsearch.yml</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ data</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ nodes</span><br><span class="line">â”‚&nbsp;&nbsp; â””â”€â”€ log</span><br><span class="line">â”œâ”€â”€ node<span class="number">-2</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ certs</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elastic-stack-ca.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ node.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ config</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elasticsearch.yml</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ data</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ nodes</span><br><span class="line">â”‚&nbsp;&nbsp; â””â”€â”€ log</span><br><span class="line">â”œâ”€â”€ node<span class="number">-3</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ certs</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elastic-stack-ca.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ node.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ config</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elasticsearch.yml</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ data</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ nodes</span><br><span class="line">â”‚&nbsp;&nbsp; â””â”€â”€ log</span><br><span class="line">â””â”€â”€ plugins</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶/data/es/node-1/config/elasticsearch.yml. ä»¥èŠ‚ç‚¹<code>node-1</code>ä¸ºä¾‹</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™é‡Œçš„å†…å®¹åŒéssléƒ¨ç½²ä¸€æ ·</span></span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line"><span class="comment"># å¼€å¯xpackå®‰å…¨ç‰¹æ€§</span></span><br><span class="line">xpack.security.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line">xpack.security.authc.api_key.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># å¼€å¯httpså¹¶é…ç½®è¯ä¹¦</span></span><br><span class="line">xpack.security.http.ssl.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line">xpack.security.http.ssl.keystore.<span class="params">path:</span> certs<span class="symbol">/node.p12</span></span><br><span class="line">xpack.security.http.ssl.truststore.<span class="params">path:</span> certs<span class="symbol">/node.p12</span></span><br><span class="line"><span class="comment"># å¼€å¯èŠ‚ç‚¹é—´é€šè®¯sslå¹¶é…ç½®è¯ä¹¦</span></span><br><span class="line">xpack.security.transport.ssl.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line">xpack.security.transport.ssl.<span class="params">verification_mode:</span> certificate</span><br><span class="line">xpack.security.transport.ssl.<span class="params">client_authentication:</span> required</span><br><span class="line">xpack.security.transport.ssl.keystore.<span class="params">path:</span> certs<span class="symbol">/node.p12</span></span><br><span class="line">xpack.security.transport.ssl.truststore.<span class="params">path:</span> certs<span class="operator">/</span>node.p12</span><br></pre></td></tr></tbody></table></figure><p>æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€ä¿®æ”¹åï¼Œé‡å¯ä¸€ä¸‹esé›†ç¾¤ </p><p>é‡å¯å®Œæ¯•åï¼ŒæŸ¥çœ‹çŠ¶æ€å’Œæ—¥å¿—ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸  </p><p>è‹¥æ— å¼‚å¸¸ï¼Œå¯ä»¥å¼€å§‹è®¾ç½®å¯†ç ï¼Œ è¿›å…¥å®¹å™¨ <code>node-1</code></p><figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data</span><span class="comment"># docker exec -it node-1 bash</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># ./bin/elasticsearch-setup-passwords auto </span></span><br><span class="line"><span class="title class_">Initiating</span> the setup of passwords <span class="keyword">for</span> reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.</span><br><span class="line"><span class="title class_">The</span> passwords will be randomly generated <span class="keyword">and</span> printed to the console.</span><br><span class="line"><span class="title class_">Please</span> confirm that you would like to continue [y/N]y</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‹¥é›†ç¾¤æ²¡é—®é¢˜çš„è¯è¿™é‡Œå°±ä¼šè‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿçš„ä¸€äº›å¯†ç ï¼š</span></span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥æ‰‹åŠ¨è‡ªå®šä¹‰å¯†ç </span></span><br><span class="line">./bin/elasticsearch-setup-passwords interactive</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ ES API æ£€æŸ¥å„ä¸ªèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -k --<span class="keyword">user</span> <span class="title">elastic</span>:å¯†ç  -X GET <span class="string">"https://172.20.0.3:9200"</span> --cert-<span class="keyword">type</span> P12 --cert /usr/share/elasticsearch/config/certs/node.p12</span><br><span class="line">curl -k --<span class="keyword">user</span> <span class="title">elastic</span>:å¯†ç  -X GET <span class="string">"https://172.20.0.4:9200"</span> --cert-<span class="keyword">type</span> P12 --cert /usr/share/elasticsearch/config/certs/node.p12</span><br><span class="line">curl -k --<span class="keyword">user</span> <span class="title">elastic</span>:å¯†ç  -X GET <span class="string">"https://172.20.0.5:9200"</span> --cert-<span class="keyword">type</span> P12 --cert /usr/share/elasticsearch/config/certs/node.p12</span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ—¶sslå·²é…ç½®å®Œæ¯•ï¼Œé…ç½®kibana</p><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># æŠŠä¹‹å‰æ”¾åœ¨node-1ä¸‹é¢çš„è¯ä¹¦å¤åˆ¶åˆ°kibana/certä¸‹é¢ï¼š</span><br><span class="line"># æå–å…¬é’¥</span><br><span class="line">openssl pkcs12 -<span class="keyword">in</span> elastic-<span class="keyword">stack</span>-<span class="keyword">ca</span>.p12 -<span class="keyword">out</span> elastic-<span class="keyword">stack</span>-<span class="keyword">ca</span>.pem -nokeys -clcerts</span><br><span class="line">openssl pkcs12 -<span class="keyword">in</span> node.p12 -<span class="keyword">out</span> node.pem -nokeys -clcerts</span><br><span class="line"># æå–ç§é’¥</span><br><span class="line">openssl pkcs12 -<span class="keyword">in</span> node.p12 -<span class="keyword">out</span> node.key -nocerts -nodes</span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶kibana/config/kibana.yml</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server.<span class="params">host:</span> <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="comment"># ç›‘å¬ç«¯å£</span></span><br><span class="line">server.<span class="params">port:</span> <span class="number">5601</span></span><br><span class="line">server.<span class="params">name:</span> <span class="string">"kibana"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kibanaè®¿é—®esæœåŠ¡å™¨çš„URL,å°±å¯ä»¥æœ‰å¤šä¸ªï¼Œä»¥é€—å·","éš”å¼€</span></span><br><span class="line"><span class="comment"># es å¼€å¯äº† sslï¼Œæ‰€ä»¥è¿™é‡Œçš„url å¿…é¡»ä½¿ç”¨httpsåè®®</span></span><br><span class="line">elasticsearch.<span class="params">hosts:</span> [<span class="string">"https://172.20.0.3:9200"</span>,<span class="string">"https://172.20.0.4:9200"</span>,<span class="string">"https://172.20.0.5:9200"</span>]</span><br><span class="line">monitoring.ui.container.elasticsearch.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># kibanaè®¿é—®Elasticsearchçš„è´¦å·ä¸å¯†ç (å¦‚æœElasticSearchè®¾ç½®äº†çš„è¯)</span></span><br><span class="line">elasticsearch.<span class="params">username:</span> <span class="string">"kibana_system"</span></span><br><span class="line">elasticsearch.<span class="params">password:</span> <span class="string">"xxxxxxxxxxxx"</span></span><br><span class="line"><span class="comment"># kibana webè¯­è¨€</span></span><br><span class="line">i18n.<span class="params">locale:</span> <span class="string">"zh-CN"</span></span><br><span class="line"><span class="comment"># esè¯ä¹¦é…ç½®, è¿™é‡Œæ˜¯åœ¨docker-composeä¸­å·²ç»æŒ‚è½½è¿›å®¹å™¨äº†</span></span><br><span class="line">elasticsearch.ssl.<span class="params">certificate:</span> <span class="symbol">/etc/kibana/cert/node.pem</span></span><br><span class="line">elasticsearch.ssl.<span class="params">key:</span> <span class="symbol">/etc/kibana/cert/node.key</span></span><br><span class="line"><span class="comment"># esçš„caè¯ä¹¦</span></span><br><span class="line">elasticsearch.ssl.<span class="params">certificateAuthorities:</span> [ <span class="string">"/etc/kibana/cert/elastic-stack-ca.pem"</span> ]</span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹å®Œæ¯•å ï¼Œé‡æ–°éƒ¨ç½²ä¸€ä¸‹ kibanaæœåŠ¡å³å¯</p><p><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/2.png"></p><p>ä»¥ä¸Šåªè¦ç™»å½•å°±å¯ä»¥ä½¿ç”¨äº†ã€‚</p><h2 id="Filebeat-æ—¥å¿—é‡‡é›†"><a href="#Filebeat-æ—¥å¿—é‡‡é›†" class="headerlink" title="Filebeat æ—¥å¿—é‡‡é›†"></a>Filebeat æ—¥å¿—é‡‡é›†</h2><p>è¿™é‡Œæˆ‘æ‰ç”¨çš„æ–¹å¼æ˜¯ dockerè¿è¡Œ filebeatæœåŠ¡ï¼Œç„¶åå°†ç½‘å…³æœåŠ¡å™¨çš„Nginxæ—¥å¿—æŒ‚è½½è¿›filebeat</p><figure class="highlight dts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="keyword">/opt/</span>filbeat/docker-compose.yaml</span><br><span class="line"><span class="symbol">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"><span class="symbol">  filebeat:</span></span><br><span class="line"><span class="symbol">    container_name:</span> filebeat_test</span><br><span class="line"><span class="symbol">    image:</span> elastic/filebeat:<span class="number">7.9</span><span class="number">.0</span></span><br><span class="line"><span class="symbol">    user:</span> root</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - <span class="keyword">/data/</span>wwwlogs/:<span class="keyword">/var/</span>log/nginx:ro</span><br><span class="line">      - ./filebeat.yml:<span class="keyword">/usr/</span>share<span class="keyword">/filebeat/</span>filebeat.yml:ro</span><br><span class="line">      - ./ca.crt:<span class="keyword">/usr/</span>share<span class="keyword">/filebeat/</span>certs/ca.crt</span><br><span class="line">      <span class="meta"># è¿™ä¸ªè¯ä¹¦åœ¨æ¥å…¥kibanaçš„æ—¶å€™å·²ç»æå–å‡ºæ¥äº†ï¼Œå³æ–‡ä»¶ï¼šelastic-stack-ca.pem</span></span><br><span class="line">      <span class="meta"># ä»–ä»¬å†…å®¹æ˜¯ä¸€æ ·çš„åªæ˜¯æ–‡ä»¶åã€æ ¼å¼ä¸ä¸€æ ·</span></span><br><span class="line"><span class="symbol">    command:</span> filebeat -e</span><br></pre></td></tr></tbody></table></figure><p>filebeatçš„é…ç½®æ–‡ä»¶åœ¨ /opt/filebeat/filebeat.yml</p><figure class="highlight clean"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/filebeat/filebeat.yml</span><br><span class="line">filebeat.inputs:  </span><br><span class="line">##################################################################################</span><br><span class="line">- type: log</span><br><span class="line">  paths:  </span><br><span class="line">    - /var/log/nginx/testnet-xxxxxxxxxxxx.com.log</span><br><span class="line">  tags: [<span class="string">"proxy-testnet-xxxxxxxxxxxx.com.log"</span>]  </span><br><span class="line">  fields:  </span><br><span class="line">    index: <span class="string">"proxy-testnet-xxxxxxxxxxxx.com.log"</span>  </span><br><span class="line">  json.keys_under_root: true</span><br><span class="line">  json.overwrite_keys: true</span><br><span class="line">  processors:  </span><br><span class="line">    - add_kubernetes_metadata:  </span><br><span class="line">        matchers:  </span><br><span class="line">        - logs_path:  </span><br><span class="line">            logs_path: <span class="string">"/var/log/nginx/"</span>  </span><br><span class="line">    - decode_json_fields:  </span><br><span class="line">        when:  </span><br><span class="line">           regexp:  </span><br><span class="line">             message: <span class="string">"{*}"</span>  </span><br><span class="line">        fields: [<span class="string">"message"</span>]  </span><br><span class="line">        overwrite_keys: true  </span><br><span class="line">##################################################################################</span><br><span class="line">output.elasticsearch:  </span><br><span class="line">  hosts: [<span class="string">"https://10.10.10.29:9200"</span>,<span class="string">"https://10.10.10.29:9201"</span>,<span class="string">"https://10.10.10.29:9201"</span>]</span><br><span class="line">  username: elastic</span><br><span class="line">  password: vDNnbd8FXqR2i13NYGfj</span><br><span class="line">  ssl.certificate_authorities:</span><br><span class="line">    - /usr/share/filebeat/certs/ca.crt</span><br><span class="line">  indices:  </span><br><span class="line">    - index: <span class="string">"proxy-testnet-xxxxxxxxxxxx.com.log-%{+yyyy.MM.dd}"</span>  </span><br><span class="line">      when.contains:  </span><br><span class="line">        fields:  </span><br><span class="line">          index: <span class="string">"proxy-testnet-xxxxxxxxxxxx.com.log"</span> </span><br><span class="line">setup.kibana:</span><br><span class="line">  hosts: <span class="string">"http://10.10.10.29:5601"</span></span><br><span class="line">  username: <span class="string">"elastic"</span></span><br><span class="line">  password: <span class="string">"xxxxxxxxxxxx"</span></span><br></pre></td></tr></tbody></table></figure><p>é…ç½®å®Œæ¯•ä¹‹åï¼ŒæŸ¥çœ‹æ—¥å¿—æ˜¯å¦å¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œåˆ°<code>node-1</code>ä¸Šé¢é€šè¿‡ES APIæŸ¥è¯¢æ˜¯å¦æœ‰indexç”Ÿæˆ</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@node-1:/usr/share/elasticsearch# curl -k --user elastic:xxxxxxxxxxxx -X GET "https://172.20.0.3:9200/<span class="emphasis">_cat/indices " --cert-type P12 --cert /usr/share/elasticsearch/config/certs/node.p12</span></span><br><span class="line"><span class="emphasis">......</span></span><br><span class="line"><span class="emphasis">......</span></span><br><span class="line"><span class="emphasis">......</span></span><br><span class="line"><span class="emphasis">green open proxy-testnet-xxxxxxxxxxxx.com.log-2024.07.23 Su-T62zGTheqbDsDZLzH_</span>A 1 1 2911    0   1.7mb 914.2kb</span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Kibanaé…ç½®"><a href="#Kibanaé…ç½®" class="headerlink" title="Kibanaé…ç½®"></a>Kibanaé…ç½®</h2><p>ä¸Šé¢å¯ä»¥çœ‹åˆ°filebeatå·²ç»æ­£å¸¸å¾€ESå†™å…¥æ•°æ®ï¼Œåœ¨kibanaä¸­é…ç½®ä¸€ä¸‹ï¼š</p><p><code>Stack Manager</code> - <code>Index Patterns</code> - <code>Create index pattern</code></p><p><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/3.png"></p><p>ç›´æ¥åˆ›å»ºåèœå•æ ï¼š <code>Discover</code> é€‰æ‹©åˆšåˆšåˆ›å»ºçš„è¿™ä¸ªIndex Pattern</p><p><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/4.png"><br>æœ€åç›´æ¥å°±å¯ä»¥çœ‹åˆ°æ”¶é›†åˆ°çš„æ—¥å¿—kibanaå·²ç»åšå¥½äº†å­—æ®µåˆ†éš”ï¼Œåªéœ€è¦é€‰æ‹©éœ€è¦çš„å­—æ®µï¼Œæˆ–è€…åŒ¹é…æŸäº›å­—æ®µå°±å¯ä»¥äº†ã€‚</p><p>æ¯”å¦‚ æˆ‘æƒ³çœ‹çŠ¶æ€ç å¤§äºç­‰äº500çš„ï¼š <code>status &gt;= 500</code>ï¼Œéƒ½å¯ä»¥åœ¨ä¸Šé¢çš„æœç´¢æ¡†ä¸­å»å®šä¹‰ç­›é€‰</p><p>å½“ç„¶ä¹Ÿå¯ä»¥æŠŠè¿™ä¸ªæ—¥å¿—åšæˆå¯è§†åŒ–ï¼Œä½†é€‰æ‹©æŸä¸ªæŒ‡æ ‡çš„æ—¶å€™ï¼Œå…¶ä»–æŒ‡æ ‡ä¹Ÿå¯ä»¥è”åŠ¨èµ·æ¥ï¼Œä¾‹å¦‚ï¼š<br><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/5.png"></p><p>æœ€åå†ç»“åˆå‰é¢å†™è¿‡çš„ <a href="https://blog.sctux.cc/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/">å¦‚ä½•åˆ©ç”¨ElastAlert2å¯¹ESä¸­çš„æ—¥å¿—åˆ›å»ºå‘Šè­¦</a> å°±å¯ä»¥è½»æ¾çš„å¯¹æ—¥å¿—è¿›è¡Œç›‘æ§å‘Šè­¦å•¦~</p><p>å†™åœ¨æœ€å </p><p>ä¸Šé¢è¿‡ç¨‹ä»…ä»…æ˜¯è®°å½•ï¼Œä¸»è¦è¿˜æ˜¯æ€è·¯ã€‚</p><p><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/6.png"></p><h2 id="k8s-version"><a href="#k8s-version" class="headerlink" title="k8s version"></a>k8s version</h2><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line"><span class="attr">data:</span>  </span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|-  </span></span><br><span class="line"><span class="string">    #====================== input =================  </span></span><br><span class="line"><span class="string">    filebeat.inputs:  </span></span><br><span class="line"><span class="string">    # nginx-ingress  </span></span><br><span class="line"><span class="string">    - type: container  </span></span><br><span class="line"><span class="string">      paths:  </span></span><br><span class="line"><span class="string">        - /var/log/containers/*goerli-testnet-collector*.log  </span></span><br><span class="line"><span class="string">      tags: ["goerli-testnet-collector"]  </span></span><br><span class="line"><span class="string">      fields:  </span></span><br><span class="line"><span class="string">        index: "goerli-testnet-collector"  </span></span><br><span class="line"><span class="string">      processors:  </span></span><br><span class="line"><span class="string">        - add_kubernetes_metadata:  </span></span><br><span class="line"><span class="string">            host: ${NODE_NAME}  </span></span><br><span class="line"><span class="string">            matchers:  </span></span><br><span class="line"><span class="string">            - logs_path:  </span></span><br><span class="line"><span class="string">                logs_path: "/var/log/containers/"  </span></span><br><span class="line"><span class="string">        - decode_json_fields:  </span></span><br><span class="line"><span class="string">            when:  </span></span><br><span class="line"><span class="string">               regexp:  </span></span><br><span class="line"><span class="string">                 message: "{*}"  </span></span><br><span class="line"><span class="string">            fields: ["message"]  </span></span><br><span class="line"><span class="string">            overwrite_keys: true  </span></span><br><span class="line"><span class="string">            target: ""  </span></span><br><span class="line"><span class="string">    # testnet-bsc-collector  </span></span><br><span class="line"><span class="string">    - type: container  </span></span><br><span class="line"><span class="string">      paths:  </span></span><br><span class="line"><span class="string">        - /var/log/containers/*testnet-bsc-collector*.log  </span></span><br><span class="line"><span class="string">      tags: ["testnet-bsc-collector"]  </span></span><br><span class="line"><span class="string">      fields:  </span></span><br><span class="line"><span class="string">        index: "testnet-bsc-collector"  </span></span><br><span class="line"><span class="string">      processors:  </span></span><br><span class="line"><span class="string">        - add_kubernetes_metadata:  </span></span><br><span class="line"><span class="string">            host: ${NODE_NAME}  </span></span><br><span class="line"><span class="string">            matchers:  </span></span><br><span class="line"><span class="string">            - logs_path:  </span></span><br><span class="line"><span class="string">                logs_path: "/var/log/containers/"  </span></span><br><span class="line"><span class="string">        - decode_json_fields:  </span></span><br><span class="line"><span class="string">            when:  </span></span><br><span class="line"><span class="string">               regexp:  </span></span><br><span class="line"><span class="string">                 message: "{*}"  </span></span><br><span class="line"><span class="string">            fields: ["message"]  </span></span><br><span class="line"><span class="string">            #overwrite_keys: true  </span></span><br><span class="line"><span class="string">            target: ""  </span></span><br><span class="line"><span class="string">    #================ output =====================  </span></span><br><span class="line"><span class="string">    output.elasticsearch:  </span></span><br><span class="line"><span class="string">      hosts: ["https://10.10.20.23:9200", "https://10.10.20.120:9200", "https://10.10.20.160:9200"]</span></span><br><span class="line"><span class="string">      username: elastic</span></span><br><span class="line"><span class="string">      password: r40SgkMhmjwK8rIpClFM</span></span><br><span class="line"><span class="string">      ssl.certificate_authorities:</span></span><br><span class="line"><span class="string">        - /usr/share/filebeat/ca.crt</span></span><br><span class="line"><span class="string">      indices:  </span></span><br><span class="line"><span class="string">        - index: "INDEX-NAME-%{+yyyy.MM.dd}"  </span></span><br><span class="line"><span class="string">          when.contains:  </span></span><br><span class="line"><span class="string">            fields:  </span></span><br><span class="line"><span class="string">              index: "INDEX-NAME"  </span></span><br><span class="line"><span class="string">        - index: "testnet-bsc-collector-%{+yyyy.MM.dd}"  </span></span><br><span class="line"><span class="string">          when.contains:  </span></span><br><span class="line"><span class="string">            fields:  </span></span><br><span class="line"><span class="string">              index: "testnet-bsc-collector"  </span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">    <span class="comment">#============== Elasticsearch template setting ==========  </span></span><br><span class="line">    <span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span>  </span><br><span class="line">    <span class="attr">setup.template.name:</span> <span class="string">'k8s-logs'</span>  </span><br><span class="line">    <span class="attr">setup.template.pattern:</span> <span class="string">'k8s-logs-*'</span>  </span><br><span class="line">    <span class="attr">processors:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">drop_fields:</span>  </span><br><span class="line">          <span class="attr">fields:</span> [<span class="string">"agent"</span>,<span class="string">"kubernetes.labels"</span>,<span class="string">"input.type"</span>,<span class="string">"log"</span>,<span class="string">"ecs.version"</span>,<span class="string">"host.name"</span>,<span class="string">"kubernetes.replicaset.name"</span>,<span class="string">"kubernetes.pod.uid"</span>,<span class="string">"kubernetes.pod.uid"</span>,<span class="string">"tags"</span>,<span class="string">"stream"</span>,<span class="string">"kubernetes.container.name"</span>]  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">template:</span>  </span><br><span class="line">    <span class="attr">metadata:</span>  </span><br><span class="line">      <span class="attr">labels:</span>  </span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line">    <span class="attr">spec:</span>  </span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">filebeat</span>  </span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span>  </span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span>  </span><br><span class="line">      <span class="attr">tolerations:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span>  </span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span>  </span><br><span class="line">      <span class="attr">containers:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">        <span class="attr">image:</span> <span class="string">elastic/filebeat:7.9.0</span>  </span><br><span class="line">        <span class="attr">args:</span> [  </span><br><span class="line">          <span class="string">"-c"</span>, <span class="string">"/etc/filebeat.yml"</span>,  </span><br><span class="line">          <span class="string">"-e"</span>,  </span><br><span class="line">        ]  </span><br><span class="line">        <span class="attr">env:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span>  </span><br><span class="line">          <span class="attr">valueFrom:</span>  </span><br><span class="line">            <span class="attr">fieldRef:</span>  </span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span>  </span><br><span class="line">        <span class="attr">securityContext:</span>  </span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">0</span>  </span><br><span class="line">          <span class="comment"># If using Red Hat OpenShift uncomment this:  </span></span><br><span class="line">          <span class="comment">#privileged: true  </span></span><br><span class="line">        <span class="attr">resources:</span>  </span><br><span class="line">          <span class="attr">limits:</span>  </span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span>  </span><br><span class="line">          <span class="attr">requests:</span>  </span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span>  </span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span>  </span><br><span class="line">        <span class="attr">volumeMounts:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span>  </span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/filebeat.yml</span>  </span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span>  </span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">filebeat.yml</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span>  </span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/filebeat/data</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span>  </span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/containerd/</span>  </span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span>  </span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span>  </span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">volumes:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span>  </span><br><span class="line">        <span class="attr">configMap:</span>  </span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">0600</span>  </span><br><span class="line">          <span class="attr">name:</span> <span class="string">filebeat-config</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span>  </span><br><span class="line">        <span class="attr">hostPath:</span>  </span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/containerd/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span>  </span><br><span class="line">        <span class="attr">hostPath:</span>  </span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span>  </span><br><span class="line">      <span class="comment"># data folder stores a registry of read status for all files, so we don't send everything again on a Filebeat pod restart  </span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span>  </span><br><span class="line">        <span class="attr">hostPath:</span>  </span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/filebeat-data</span>  </span><br><span class="line">          <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span>  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line"><span class="attr">subjects:</span>  </span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line"><span class="attr">roleRef:</span>  </span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span>  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line"><span class="attr">rules:</span>  </span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">""</span>] <span class="comment"># "" indicates the core API group  </span></span><br><span class="line">  <span class="attr">resources:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span>  </span><br><span class="line">  <span class="attr">verbs:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span>  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line"><span class="meta">---  </span></span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•åˆ©ç”¨ElastAlert2å¯¹ESä¸­çš„æ—¥å¿—åˆ›å»ºå‘Šè­¦</title>
      <link href="/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/"/>
      <url>/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/</url>
      
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>çº¿ä¸ŠAPIæœåŠ¡å‡ºç°äº†5xxçš„è¯·æ±‚é”™è¯¯, æœªèƒ½åœ¨ç¬¬ä¸€æ—¶é—´å‘ç°å¯¼è‡´ç”¨æˆ·ä¸»åŠ¨å‘å›¢é˜ŸæŠ¥å‘Šæ¥å£æœ‰å¼‚å¸¸ï¼Œ ç”±äºAPIçš„æ¥å£æ¯”è¾ƒå¤šï¼Œä¹Ÿåªæ˜¯ç›‘æ§äº†éƒ¨åˆ†ï¼Œäº‹åé€šè¿‡æ—¥å¿—æ‰å‘ç°çš„ç¡®ç”¨æˆ·ä¾§åœ¨å¯¹æŸä¸ªæ¥å£è®¿é—®æ—¶ï¼Œé¢‘ç¹å‡ºç°5xxå‘Šè­¦ï¼Œæˆ‘è¿™è¾¹ä¹Ÿæ²¡æœ‰æ”¶åˆ°ä»€ä¹ˆé€šçŸ¥ï¼Œç›®å‰å…ˆæš‚ä¸”ä¸è¯´å‡ºç°5xxæ˜¯ä»€ä¹ˆé€ æˆçš„ï¼Œè€Œæ˜¯åœ¨APIæ¥å£å“åº”çŠ¶æ€çš„ç›‘æ§æ–¹é¢æ²¡æœ‰åšåˆ°å¾ˆåˆ°ä½ï¼Œ æ‰€ä»¥éœ€è¦å¯¹Nginxæ—¥å¿—ä¸­çš„çŠ¶æ€ä¸º5xxçš„è¯·æ±‚ç›‘æ§å‘Šè­¦ï¼Œä»¥ä¾¿èƒ½å¿«é€Ÿå“åº”ï¼Œè§£å†³é—®é¢˜ã€‚</p><h1 id="ElastAlert2"><a href="#ElastAlert2" class="headerlink" title="ElastAlert2"></a>ElastAlert2</h1><p>ElastAlert 2æ˜¯ä¸€ä¸ªç®€å•çš„æ¡†æ¶ï¼Œç”¨äºå¯¹æ¥è‡ª Elasticsearch å’Œ OpenSearch çš„æ•°æ®çš„å¼‚å¸¸ã€å°–å³°æˆ–å…¶ä»–æ„Ÿå…´è¶£çš„æ¨¡å¼å‘å‡ºè­¦æŠ¥ã€‚</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://elastalert2.readthedocs.io/en/latest/">https://elastalert2.readthedocs.io/en/latest/</a></p><p>Github: <a href="https://github.com/jertel/elastalert2">https://github.com/jertel/elastalert2</a></p><h1 id="é…ç½®éƒ¨ç½²"><a href="#é…ç½®éƒ¨ç½²" class="headerlink" title="é…ç½®éƒ¨ç½²"></a>é…ç½®éƒ¨ç½²</h1><p>å½“ç„¶è¿˜æ˜¯é€‰æ‹©å®¹å™¨åŒ–æ–¹å¼è¿è¡Œï¼Œå®˜æ–¹ä¹Ÿæä¾›å¾—æœ‰é•œåƒï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker pull jertel/elastalert2</span><br></pre></td></tr></tbody></table></figure><h3 id="é…ç½®æ–‡ä»¶é…ç½®"><a href="#é…ç½®æ–‡ä»¶é…ç½®" class="headerlink" title="é…ç½®æ–‡ä»¶é…ç½®"></a>é…ç½®æ–‡ä»¶é…ç½®</h3><p>å¯å‚è€ƒ <a href="https://github.com/jertel/elastalert2">https://github.com/jertel/elastalert2</a>  ç›®å½•ä¸­çš„ <code>examples/config.yaml.example</code></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/opt/elastalert2/{data,rules}</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">/opt/elastalert2/config.yaml</span></span><br><span class="line"><span class="attr">rules_folder:</span> <span class="string">rules</span> <span class="comment"># å­˜æ”¾è§„åˆ™æ–‡ä»¶çš„ç›®å½•ï¼Œè¿™ä¸ªç›®å½•éœ€è¦æŒ‚è½½åˆ°/opt/elastalert/ä¸‹</span></span><br><span class="line"><span class="attr">run_every:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">buffer_time:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">es_host:</span> <span class="number">10.10</span><span class="number">.20</span><span class="number">.23</span></span><br><span class="line"><span class="attr">es_port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">use_ssl:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">verify_certs:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">ca_certs:</span> <span class="string">/opt/elastalert/ca.crt</span> <span class="comment"># å¦‚æœé›†ç¾¤å¯ç”¨äº†sslè®°å¾—è¦æŠŠcaè¯ä¹¦æŒ‚åœ¨åˆ°å®¹å™¨çš„è¿™ä¸ªä½ç½®</span></span><br><span class="line"><span class="attr">ssl_show_warn:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">es_send_get_body_as:</span> <span class="string">GET</span></span><br><span class="line"><span class="attr">es_username:</span> <span class="comment"># YOUR ES USERNAME</span></span><br><span class="line"><span class="attr">es_password:</span> <span class="comment"># YOUR ES PASSWORD</span></span><br><span class="line"><span class="attr">writeback_index:</span> <span class="string">elastalert_status</span></span><br><span class="line"><span class="attr">alert_time_limit:</span></span><br><span class="line">  <span class="attr">days:</span> <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Ruleè§„åˆ™é…ç½®"><a href="#Ruleè§„åˆ™é…ç½®" class="headerlink" title="Ruleè§„åˆ™é…ç½®"></a>Ruleè§„åˆ™é…ç½®</h3><p>æˆ‘ä»¬ç½‘å…³æœåŠ¡å™¨çš„Nginxæ—¥å¿—æ˜¯é€šè¿‡filebeatå†™åˆ°Elasticsearchçš„ï¼Œä¹Ÿåšå¥½äº†indexï¼Œå…¶å®åœ¨ELK ç•Œé¢ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™äº›çŠ¶æ€æ•°æ®ï¼Œä½†æ˜¯ä»…ä»…åªæ˜¯å±•ç¤ºï¼Œæ²¡æœ‰å‘Šè­¦ï¼Œæ‰€ä»¥æ‰æœ‰äº†è¿™ç¯‡blogã€‚</p><p>åˆ›å»ºä¸€ä¸ªé’ˆå¯¹ æŸä¸ªAPIåŸŸåçš„æ—¥å¿—çš„çŠ¶æ€ç›‘æ§æ–‡ä»¶ï¼š </p><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vim  /opt/elastalert2/rules/mainnet-api.xxxxx.yaml</span></span><br><span class="line"><span class="attribute">#ruleåå­—,å¿…é¡»å”¯ä¸€</span></span><br><span class="line"><span class="attribute">name</span><span class="punctuation">:</span> <span class="string">The number of times this request responds with a status code of 5xx in the log is greater than 5 times within 1 minute, please pay attention(mainnet-api.xxxxx)!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç±»å‹,å®˜æ–¹æä¾›å¤šç§ç±»å‹</span></span><br><span class="line"><span class="attribute">type</span><span class="punctuation">:</span> <span class="string">frequency</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ESç´¢å¼•,æ”¯æŒé€šé…ç¬¦</span></span><br><span class="line"><span class="attribute">index</span><span class="punctuation">:</span> <span class="string">proxy-mainnet-api.xxxxx.log-*</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åœ¨timeframeæ—¶é—´å†…,åŒ¹é…åˆ°å¤šå°‘ä¸ªç»“æœä¾¿å‘Šè­¦</span></span><br><span class="line"><span class="attribute">num_events</span><span class="punctuation">:</span> <span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç›‘æ§å‘¨æœŸ.é»˜è®¤æ˜¯minutes: 1</span></span><br><span class="line"><span class="attribute">timeframe</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">seconds</span><span class="punctuation">:</span> <span class="string">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åŒ¹é…æ¨¡å¼.è¿™é‡Œæˆ‘åŒ¹é…çš„æ˜¯500â€”599çš„æ‰€æœ‰å¯èƒ½ä¼šå‡ºç°çš„çŠ¶æ€ç </span></span><br><span class="line"><span class="attribute">filter</span><span class="punctuation">:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">range:</span></span><br><span class="line">    <span class="attribute">status</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">from</span><span class="punctuation">:</span> <span class="string">500</span></span><br><span class="line">      <span class="attribute">to</span><span class="punctuation">:</span> <span class="string">599</span></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰å‘é€æ ¼å¼(start)</span></span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š ä»¥ä¸‹å¯ä»¥è‡ªå®šä¹‰å‘é€çš„å†…å®¹ï¼Œå¦‚æœä»€ä¹ˆéƒ½ä¸æŒ‡å®šï¼Œä¼šå‘é€ElastAlert2åŸç”Ÿçš„ä¸€å¤§å †jsonæ ¼å¼çš„å†…å®¹ï¼Œæ˜“è¯»æ€§å¾ˆä½ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºäº†å†…å®¹ç®€ä»‹ï¼Œæˆ‘è¿™é‡Œå°±åªæ˜¯å®šä¹‰äº†è¿™äº›å†…å®¹ï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">alert_text_type</span><span class="punctuation">:</span> <span class="string">alert_text_only</span></span><br><span class="line"><span class="attribute">alert_text</span><span class="punctuation">:</span> <span class="string">" </span></span><br><span class="line">  <span class="attribute">å“åº”çŠ¶æ€ç </span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">å‘ç”Ÿæ—¶é—´UTC</span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">ES Index</span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">num_hits</span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">è¯·æ±‚URL</span><span class="punctuation">:</span> <span class="string">https://mainnet-api.xxxxx{} \n</span></span><br><span class="line">  <span class="attribute">ClientIP</span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">num_matches</span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">http_user_agent</span><span class="punctuation">:</span> <span class="string">{}</span></span><br><span class="line"><span class="attribute">"</span></span><br><span class="line"><span class="attribute">alert_text_args</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">status</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"@timestamp"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">_index</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">num_hits</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">request_uri</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">http_x_forwarded_for</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">num_matches</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">http_user_agent</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰å‘é€æ ¼å¼(end)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œé€‰æ‹©ä½¿ç”¨çš„æ˜¯Discordæ¥æ¥æ”¶é€šçŸ¥ï¼ŒElastAlert2å…¶å®å¾ˆå¼ºå¤§ï¼Œæ”¯æŒå¾ˆå¤šæ¸ é“çš„å‘Šè­¦</span></span><br><span class="line"><span class="comment"># è¿™é‡Œå‘ç°å¹¶ä¸èƒ½åŒæ—¶å¤šä¸ªæ¸ é“å‘é€å‘Šè­¦æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"># å¦‚æœéœ€è¦å¤šä¸ªå‘Šè­¦æ¸ é“ï¼Œå¯ä»¥å†™ä¸€ä¸ªç±»ä¼¼äºAlertCenterçš„æœåŠ¡ï¼Œé€šè¿‡è¿™ä¸ªæœåŠ¡æ•´åˆåå‘é€åˆ°ä¸åŒçš„æ¸ é“ï¼Œè¿™é‡Œè¿™æ˜¯ä¸ªæ€è·¯ï¼Œç›®å‰å…ˆæ»¡è¶³éœ€æ±‚</span></span><br><span class="line"><span class="attribute">alert</span><span class="punctuation">:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"discord"</span></span><br><span class="line"><span class="attribute">discord_webhook_url</span><span class="punctuation">:</span> <span class="string">"YOUR DISCORD WEBHOOK URL"</span></span><br><span class="line"><span class="attribute">discord_emoji_title</span><span class="punctuation">:</span> <span class="string">":lock:"</span></span><br><span class="line"><span class="attribute">discord_embed_color</span><span class="punctuation">:</span> <span class="string">0xE24D42</span></span><br><span class="line"><span class="attribute">discord_embed_footer</span><span class="punctuation">:</span> <span class="string">"Message sent by from api status moniotor(for @noardguo)"</span></span><br><span class="line"><span class="attribute">discord_embed_icon_url</span><span class="punctuation">:</span> <span class="string">"https://humancoders-formations.s3.amazonaws.com/uploads/course/logo/38/thumb_bigger_formation-elasticsearch.png"</span></span><br></pre></td></tr></tbody></table></figure><h3 id="éƒ¨ç½²è¿è¡Œ"><a href="#éƒ¨ç½²è¿è¡Œ" class="headerlink" title="éƒ¨ç½²è¿è¡Œ"></a>éƒ¨ç½²è¿è¡Œ</h3><p>ä¸Šé¢å·²ç»å‡†å¤‡å¥½äº†æ‰€éœ€è¦çš„æ–‡ä»¶ï¼š</p><figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-11</span><span class="symbol">:/opt/elastalert2</span><span class="comment"># tree -L 2</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ ca.crt</span><br><span class="line">â”œâ”€â”€ config.yaml</span><br><span class="line">â”œâ”€â”€ data</span><br><span class="line">â””â”€â”€ rules</span><br><span class="line">    â”œâ”€â”€ mainnet-api.xxxxx.yml</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> directories, <span class="number">3</span> files</span><br></pre></td></tr></tbody></table></figure><p>docker æ–¹å¼è¿è¡Œï¼š</p><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=elastalert2 \</span><br><span class="line">--env=TZ=Asia/Shanghai \</span><br><span class="line">--volume=/<span class="keyword">opt</span>/elastalert2/data:/<span class="keyword">opt</span>/elastalert/data \</span><br><span class="line">--volume=/<span class="keyword">opt</span>/elastalert2/config.yaml:/<span class="keyword">opt</span>/elastalert/config.yaml \</span><br><span class="line">--volume=/<span class="keyword">opt</span>/elastalert2/rules:/<span class="keyword">opt</span>/elastalert/rules \</span><br><span class="line">--volume=/<span class="keyword">opt</span>/elastalert2/<span class="keyword">ca</span>.crt:/<span class="keyword">opt</span>/elastalert/<span class="keyword">ca</span>.crt \</span><br><span class="line">--restart=always \</span><br><span class="line">jertel/elastalert2 </span><br><span class="line"></span><br><span class="line">root@ip-<span class="number">10</span>-<span class="number">10</span>-<span class="number">10</span>-<span class="number">11</span>:/<span class="keyword">opt</span>/elastalert2# docker logs -<span class="keyword">f</span> wonderful_tharp</span><br><span class="line">Reading Elastic <span class="number">7</span> <span class="built_in">index</span> mappings:</span><br><span class="line">Reading <span class="built_in">index</span> mapping <span class="string">'es_mappings/7/silence.json'</span></span><br><span class="line">Reading <span class="built_in">index</span> mapping <span class="string">'es_mappings/7/elastalert_status.json'</span></span><br><span class="line">Reading <span class="built_in">index</span> mapping <span class="string">'es_mappings/7/elastalert.json'</span></span><br><span class="line">Reading <span class="built_in">index</span> mapping <span class="string">'es_mappings/7/past_elastalert.json'</span></span><br><span class="line">Reading <span class="built_in">index</span> mapping <span class="string">'es_mappings/7/elastalert_error.json'</span></span><br><span class="line">Index elastalert_status already <span class="built_in">exists</span>. Skipping <span class="built_in">index</span> creation.</span><br><span class="line">WARNING:<span class="keyword">py</span>.warnings:/usr/local/lib/<span class="keyword">python3</span>.<span class="number">12</span>/site-packages/elasticsearch/connection/base.<span class="keyword">py</span>:<span class="number">193</span>: ElasticsearchDeprecationWarning: Camel case format name dateOptionalTime <span class="keyword">is</span> deprecated <span class="built_in">and</span> will <span class="keyword">be</span> removed in <span class="keyword">a</span> future <span class="keyword">version</span>. Use snake case name date_optional_time instead.</span><br><span class="line">  warnings.warn(message, category=ElasticsearchDeprecationWarning)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæ²¡æœ‰æŠ¥é”™å°±è¯´æ˜è¿è¡Œæ­£å¸¸ï¼Œæ­¤æ—¶ä»kibanaé¢æ¿ä¹Ÿå¯ä»¥çœ‹åˆ°ElaltAlert2ç”Ÿæˆäº†ç›‘æ§å‘Šè­¦æ‰€éœ€è¦çš„index:<br><img src="/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/1.jpeg"></p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>å½“è¿è¡Œèµ·æ¥åï¼Œæ­¤æ—¶å°±æ˜¯æ˜¯æ—¶é—´ç›‘æ§æ—¥å¿—æ–‡ä»¶çš„ä¸€ä¸ªçŠ¶æ€</p><p>åœ¨ç½‘å…³æœåŠ¡å™¨ä¸Šé¢echoä¸€æ®µå¸¦æœ‰statusä¸º500çš„messageåˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">echo</span> '''{<span class="string">"@timestamp"</span>:<span class="string">"2024-07-16T20:28:10+08:00"</span>,<span class="string">"server_addr"</span>:<span class="string">"110.10.30.187"</span>,<span class="string">"remote_addr"</span>:<span class="string">"10.10.10.248"</span>,<span class="string">"http_x_forwarded_for"</span>:<span class="string">"172.104.86.126, 172.68.119.188"</span>,<span class="string">"scheme"</span>:<span class="string">"http"</span>,<span class="string">"request_method"</span>:<span class="string">"POST"</span>,<span class="string">"request_uri"</span>: <span class="string">"Alert_Test"</span>,<span class="string">"request_length"</span>: <span class="string">"953"</span>,<span class="string">"uri"</span>: <span class="string">"/api/v1/alerttest"</span>, <span class="string">"request_time"</span>:<span class="number">0</span>.<span class="number">002</span>,<span class="string">"body_bytes_sent"</span>:<span class="number">0</span>,<span class="string">"bytes_sent"</span>:<span class="number">335</span>,<span class="string">"status"</span>:<span class="string">"500"</span>,<span class="string">"upstream_time"</span>:<span class="string">"0.002"</span>,<span class="string">"upstream_host"</span>:<span class="string">"10.10.10.139:31333"</span>,<span class="string">"upstream_status"</span>:<span class="string">"200"</span>,<span class="string">"host"</span>:<span class="string">"mainnet-api.xxxxxx"</span>,<span class="string">"http_referer"</span>:<span class="string">"https://test.xyz/"</span>,<span class="string">"http_user_agent"</span>:<span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36"</span>}''' &gt;&gt; mainnet-api.xxxxxx.log</span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ—¶æŸ¥çœ‹ indexå·²ç»è®°å½•åˆ°è¿™æ¡å‘Šè­¦æ¶ˆæ¯, é€šè¿‡æŸ¥è¯¢ç´¢å¼•ä¹Ÿæ‰¾åˆ°äº†è¿™ä¸ªè¯·æ±‚</p><p><img src="/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/2.jpeg"></p><p><img src="/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/4.png"></p><p>åŒæ—¶ï¼ŒDiscordä¹Ÿæ”¶åˆ°äº†å‘Šè­¦é€šçŸ¥</p><p><img src="/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/3.png"></p><p>æœ€åï¼Œå› ä¸ºæˆ‘ä»¬è·‘äº†k8s,ä¸‹é¢ç›´æ¥æŠŠç›¸å…³æ–‡ä»¶ç”¨configmapæ–¹å¼æŒ‚è½½è¿›å»ï¼Œè¿è¡Œä¸€ä¸ªDeploymentå‰¯æœ¬å³å¯ã€‚</p><ul><li>elastalert-config.yaml</li></ul><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  config.<span class="params">yaml:</span> |-</span><br><span class="line">    <span class="params">rules_folder:</span> rules</span><br><span class="line">    <span class="params">run_every:</span></span><br><span class="line">      <span class="params">minutes:</span> <span class="number">1</span></span><br><span class="line">    <span class="params">buffer_time:</span></span><br><span class="line">      <span class="params">minutes:</span> <span class="number">15</span></span><br><span class="line">    <span class="params">es_host:</span> <span class="number">10.10</span>.<span class="number">20.23</span></span><br><span class="line">    <span class="params">es_port:</span> <span class="number">9200</span></span><br><span class="line">    <span class="params">use_ssl:</span> True</span><br><span class="line">    <span class="params">verify_certs:</span> True</span><br><span class="line">    <span class="params">ca_certs:</span> <span class="symbol">/opt/elastalert/ca.crt</span></span><br><span class="line">    <span class="params">ssl_show_warn:</span> True</span><br><span class="line">    <span class="params">es_send_get_body_as:</span> GET</span><br><span class="line">    <span class="params">es_username:</span> elastic</span><br><span class="line">    <span class="params">es_password:</span> A2VdKUHHFoUmlyekVFgd</span><br><span class="line">    <span class="params">writeback_index:</span> elastalert_status</span><br><span class="line">    <span class="params">alert_time_limit:</span></span><br><span class="line">      <span class="params">days:</span> <span class="number">2</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> elastalert-config</span><br><span class="line">  <span class="params">namespace:</span> monitor</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><ul><li>ealstalert-rules.yaml</li></ul><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  mainnet-api.xxxxxx.<span class="params">yml:</span> <span class="string">"#ruleåå­—,å¿…é¡»å”¯ä¸€<span class="char escape_">\n</span>name: The number of times this</span></span><br><span class="line"><span class="string">    request responds with a status code of 5xx in the log is greater than 5 times</span></span><br><span class="line"><span class="string">    within 1 minute, please pay attention(mainnet-api.xxxxx)!<span class="char escape_">\n</span><span class="char escape_">\n</span>#ç±»å‹,å®˜æ–¹æä¾›å¤šç§ç±»å‹<span class="char escape_">\n</span>type:</span></span><br><span class="line"><span class="string">    frequency<span class="char escape_">\n</span><span class="char escape_">\n</span>#ESç´¢å¼•,æ”¯æŒé€šé…ç¬¦<span class="char escape_">\n</span>index: proxy-mainnet-api.xxxxx.log-*<span class="char escape_">\n</span><span class="char escape_">\n</span>#åœ¨timeframeæ—¶é—´å†…,åŒ¹é…åˆ°å¤šå°‘ä¸ªç»“æœä¾¿å‘Šè­¦<span class="char escape_">\n</span>num_events:</span></span><br><span class="line"><span class="string">    1<span class="char escape_">\n</span><span class="char escape_">\n</span>#ç›‘æ§å‘¨æœŸ.é»˜è®¤æ˜¯minutes: 1<span class="char escape_">\n</span>timeframe:<span class="char escape_">\n</span>  seconds: 5  <span class="char escape_">\n</span>  <span class="char escape_">\n</span>#åŒ¹é…æ¨¡å¼.<span class="char escape_">\n</span>filter:<span class="char escape_">\n</span>- range:<span class="char escape_">\n</span></span></span><br><span class="line"><span class="string">    <span class="char escape_">\ </span>  status:<span class="char escape_">\n</span>      from: 500<span class="char escape_">\n</span>      to: 599<span class="char escape_">\n</span>      <span class="char escape_">\n</span>alert_text_type: alert_text_only<span class="char escape_">\n</span>alert_text:</span></span><br><span class="line"><span class="string">    <span class="char escape_">\"</span> <span class="char escape_">\n</span>  å“åº”çŠ¶æ€ç : {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  å‘ç”Ÿæ—¶é—´UTC: {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  ES Index: {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  num_hits: {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span></span></span><br><span class="line"><span class="string">    <span class="char escape_">\ </span>è¯·æ±‚URL: https://mainnet-api.xxxxx.org{} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  ClientIP: {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  num_matches:</span></span><br><span class="line"><span class="string">    {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  http_user_agent: {}<span class="char escape_">\n</span><span class="char escape_">\"</span><span class="char escape_">\n</span>alert_text_args:<span class="char escape_">\n</span>    - status<span class="char escape_">\n</span>    - <span class="char escape_">\"</span>@timestamp<span class="char escape_">\"</span><span class="char escape_">\n</span></span></span><br><span class="line"><span class="string">    <span class="char escape_">\ </span>  - _index<span class="char escape_">\n</span>    - num_hits<span class="char escape_">\n</span>    - request_uri<span class="char escape_">\n</span>    - http_x_forwarded_for<span class="char escape_">\n</span></span></span><br><span class="line"><span class="string">    <span class="char escape_">\ </span>  - num_matches<span class="char escape_">\n</span>    - http_user_agent<span class="char escape_">\n</span>      <span class="char escape_">\n</span>      <span class="char escape_">\n</span>alert:<span class="char escape_">\n</span>- <span class="char escape_">\"</span>discord<span class="char escape_">\"</span><span class="char escape_">\n</span>#discord_webhook_url:</span></span><br><span class="line"><span class="string">    <span class="char escape_">\"</span>DISCORD_WEBHOOK_URL"</span>\<span class="params">ndiscord_webhook_url:</span></span><br><span class="line">    \<span class="string">"https://https://discord.com/api/webhooks/1196752947493752933/VRQ01W1pT0PHpl55z0hayqsyjWzt3bzXUMSA4-_5W56fn9j5Nl1zDQT7ZtU_CQWnnlYH<span class="char escape_">\"</span><span class="char escape_">\n</span>discord_emoji_title:</span></span><br><span class="line"><span class="string">    <span class="char escape_">\"</span>:lock:<span class="char escape_">\"</span><span class="char escape_">\n</span>discord_embed_color: 0xE24D42<span class="char escape_">\n</span>discord_embed_footer: <span class="char escape_">\"</span>Message sent</span></span><br><span class="line"><span class="string">    by from api status moniotor(for @Ops-NoardGuo)<span class="char escape_">\"</span><span class="char escape_">\n</span>discord_embed_icon_url: <span class="char escape_">\"</span>https://humancoders-formations.s3.amazonaws.com/uploads/course/logo/38/thumb_bigger_formation-elasticsearch.png<span class="char escape_">\"</span></span></span><br><span class="line"><span class="string">kind: ConfigMap</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ealstalert-rules</span></span><br><span class="line"><span class="string">  namespace: monitor</span></span><br></pre></td></tr></tbody></table></figure><ul><li><p>ca.crt<br>ç•¥</p></li><li><p>elastalert-deployment.yaml</p></li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">k8s.kuboard.cn/displayName:</span> <span class="string">elastalert</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s.kuboard.cn/name:</span> <span class="string">elastalert</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elastalert</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s.kuboard.cn/name:</span> <span class="string">elastalert</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s.kuboard.cn/name:</span> <span class="string">elastalert</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">'--verbose'</span> <span class="comment"># è¿™é‡ŒæŒ‡å®šå‚æ•°æ˜¯é»˜è®¤é•œåƒé‡Œé¢å¯ä»¥è·å–çš„å‚æ•°ï¼Œç”¨äºå®šä¹‰æ—¥å¿—è®°å½• æ’é”™æˆ–è€…è¿è¡ŒçŠ¶æ€æŸ¥çœ‹</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">jertel/elastalert2</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">elastalert</span></span><br><span class="line">          <span class="attr">resources:</span> {}</span><br><span class="line">          <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">          <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/opt/elastalert/config.yaml</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">volume-ps74r</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">config.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/opt/elastalert/rules/</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">rules</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/opt/elastalert/ca.crt</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">volume-zmdx7</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">ca.crt</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> {}</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">elastalert-config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">volume-ps74r</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">mainnet-api.xxxxx.yml</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">mainnet-api.xxxxx.yml</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">ealstalert-rules</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">rules</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">elasticsearch-ca.crt</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">volume-zmdx7</span></span><br></pre></td></tr></tbody></table></figure><p>è‡³æ­¤å‘Šè­¦åŠŸèƒ½å·²ç»å®ç°ï¼Œä»¥ä¸Šåªæ˜¯ä¸€ä¸ªå¤§ä½“çš„æ€è·¯ï¼Œä¸ä»…ä»…ç›‘æ§çš„å¯ä»¥æ˜¯çŠ¶æ€ç ï¼Œåº”è¯¥æ˜¯ä½ èƒ½æƒ³åˆ°çš„ï¼Œä»–èƒ½æä¾›çš„éƒ½å¯ä»¥ç›‘æ§èµ·æ¥ã€‚</p><p>å¥½å•¦ï¼Œæˆ‘è¦å»çœ‹5xxçš„æŠ¥é”™åŸå› äº†ğŸ˜€</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•åˆ©ç”¨Pythonè·å–æ‰€æœ‰podå®¹å™¨çŠ¶æ€</title>
      <link href="/2024/07/09/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Python%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89pod%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81/"/>
      <url>/2024/07/09/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Python%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89pod%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æ—¥å¸¸å·¡æ£€è¿‡ç¨‹å½“ä¸­ï¼Œä¸éœ€è¦ç™»å½•æœåŠ¡å™¨å»æŸ¥çœ‹ï¼Œé€šè¿‡è°ƒç”¨k8s apiçš„æ–¹å¼è·å–æ‰€æœ‰podçš„çŠ¶æ€</p><p>ç„¶ååœ¨æ¯å¤©9ç‚¹æ‰§è¡Œæœ¬è„šæœ¬å³å¯ã€‚</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> kubernetes <span class="keyword">import</span> client, config</span><br><span class="line"><span class="keyword">from</span> kubernetes.client.rest <span class="keyword">import</span> ApiException</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timezone</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> pytz</span><br><span class="line"><span class="comment"># åŠ è½½ Kubernetes é…ç½®</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é»˜è®¤ä¼šåœ¨masterèŠ‚ç‚¹å»è¯»å– ~/.kube/config æ–‡ä»¶</span></span><br><span class="line">config.load_kube_config()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º Kubernetes API å®¢æˆ·ç«¯å®ä¾‹</span></span><br><span class="line">api_instance = client.CoreV1Api()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šè¦è·å–çš„å‘½åç©ºé—´åˆ—è¡¨</span></span><br><span class="line">target_namespaces = [sys.argv[<span class="number">1</span>]]  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„ç›®æ ‡å‘½åç©ºé—´åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line">filtered_keywords = [<span class="string">"mysql"</span>, <span class="string">"redis"</span>, <span class="string">"memcached"</span>, <span class="string">"postgres"</span>, <span class="string">"backend"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Discord Webhook URL</span></span><br><span class="line">discord_webhook_url = <span class="string">""</span> <span class="comment"># FOR TEST</span></span><br><span class="line"><span class="comment"># æ›¿æ¢ä¸ºä½ çš„ Discord Webhook URL</span></span><br><span class="line">containers_without_restart = []  <span class="comment"># æ²¡æœ‰é‡å¯åŸå› çš„å®¹å™¨åˆ—è¡¨</span></span><br><span class="line">containers_with_restart = []  <span class="comment"># å…·æœ‰é‡å¯åŸå› çš„å®¹å™¨åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">for</span> target_namespace <span class="keyword">in</span> target_namespaces:</span><br><span class="line">        <span class="comment"># è·å–å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ Pod</span></span><br><span class="line">        pods = api_instance.list_namespaced_pod(namespace=target_namespace).items</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> pod <span class="keyword">in</span> pods:</span><br><span class="line">            pod_name = pod.metadata.name</span><br><span class="line">            pod_status = pod.status.phase</span><br><span class="line">            pod_restart_reason = <span class="string">""</span></span><br><span class="line">            pod_start_time = pod.metadata.creation_timestamp</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> pod_name <span class="keyword">for</span> keyword <span class="keyword">in</span> filtered_keywords):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">            cst_timezone = pytz.timezone(<span class="string">"Asia/Shanghai"</span>)</span><br><span class="line">            current_time = datetime.now(timezone.utc)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è®¡ç®—è¿è¡Œæ—¶é•¿</span></span><br><span class="line">            <span class="keyword">if</span> pod_start_time <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                pod_duration = current_time - pod_start_time</span><br><span class="line">                pod_duration_str = <span class="built_in">str</span>(pod_duration).split(<span class="string">"."</span>)[<span class="number">0</span>]  <span class="comment"># æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå»æ‰å°æ•°éƒ¨åˆ†</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                pod_duration_str = <span class="string">"Unknown"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># æ£€æŸ¥ Pod æ˜¯å¦æœ‰é‡å¯è®°å½•</span></span><br><span class="line">            <span class="keyword">if</span> pod.status.container_statuses <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">for</span> container_status <span class="keyword">in</span> pod.status.container_statuses:</span><br><span class="line">                    restart_count = container_status.restart_count</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># å¦‚æœé‡å¯æ¬¡æ•°å¤§äº 0ï¼Œåˆ™è·å–é‡å¯åŸå› </span></span><br><span class="line">                    <span class="keyword">if</span> restart_count &gt; <span class="number">0</span>:</span><br><span class="line">                        pod_restart_reason = container_status.last_state.terminated.reason</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pod_restart_reason:</span><br><span class="line">                containers_with_restart.append(</span><br><span class="line">                    (pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count)</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                containers_without_restart.append(</span><br><span class="line">                    (pod_name, pod_status, pod_duration_str)</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç”Ÿæˆæ¶ˆæ¯</span></span><br><span class="line">    message = <span class="string">"ç¯å¢ƒ: {0} è·å–æ—¶é—´ï¼š{1}\n\n"</span>.<span class="built_in">format</span>(target_namespace,datetime.now(cst_timezone).strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>) + <span class="string">" CST"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ·»åŠ æ²¡æœ‰é‡å¯åŸå› çš„å®¹å™¨ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">for</span> container <span class="keyword">in</span> containers_without_restart:</span><br><span class="line">        pod_name, pod_status, pod_duration_str = container</span><br><span class="line">        message += <span class="string">"å®¹å™¨åç§°: {0}  å½“å‰çŠ¶æ€: {1}  è¿è¡Œæ—¶é•¿: {2}\n"</span>.<span class="built_in">format</span>(</span><br><span class="line">            pod_name, pod_status, pod_duration_str</span><br><span class="line">        )</span><br><span class="line">    message += <span class="string">"------------------------------------------------------\n"</span></span><br><span class="line">    <span class="comment"># æ·»åŠ å…·æœ‰é‡å¯åŸå› çš„å®¹å™¨ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">for</span> container <span class="keyword">in</span> containers_with_restart:</span><br><span class="line">        pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count = container</span><br><span class="line">        message += <span class="string">"å®¹å™¨åç§°: {0}  å½“å‰çŠ¶æ€: {1}  è¿è¡Œæ—¶é•¿: {2}  é‡å¯åŸå› : {3} é‡å¯æ¬¡æ•°ï¼š{4}\n"</span>.<span class="built_in">format</span>(</span><br><span class="line">            pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    message = <span class="string">"```{0}```"</span>.<span class="built_in">format</span>(message)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å‘é€æ¶ˆæ¯åˆ° Discord</span></span><br><span class="line">    payload = {<span class="string">"content"</span>: message}</span><br><span class="line">    headers = {<span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>}</span><br><span class="line">    response = requests.post(</span><br><span class="line">        discord_webhook_url, data=json.dumps(payload), headers=headers</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(response.content)</span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">204</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Message sent to Discord successfully"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"Failed to send message to Discord. Status code: <span class="subst">{response.status_code}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> ApiException <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Exception when calling CoreV1Api: <span class="subst">{e}</span>\n"</span>)</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s,pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8Sä¸­MySQLä½¿ç”¨NFSæŒ‚è½½çš„å¼‚å¸¸é—®é¢˜å¤„ç†</title>
      <link href="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"/>
      <url>/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1 id="é—®é¢˜åŸå› "><a href="#é—®é¢˜åŸå› " class="headerlink" title="é—®é¢˜åŸå› "></a>é—®é¢˜åŸå› </h1><p>åœ¨k8sä¸­ä½¿ç”¨nfsä½œä¸ºæŒä¹…å­˜å‚¨æ–¹å¼ï¼Œæ ¹æ®ä¸åŒç¯å¢ƒå¯¹åº”ä¸åŒåç§°ç©ºé—´çš„podä½¿ç”¨çš„å­˜å‚¨ç±»/å­˜å‚¨å· ç›¸å¯¹åº”ï¼Œå‘ç°mysql8.0.23 åœ¨å¯åŠ¨æ—¶æŒ‚è½½NFSä¼šå¡ä½çš„æƒ…å†µï¼š</p><h1 id="é—®é¢˜å¤ç°"><a href="#é—®é¢˜å¤ç°" class="headerlink" title="é—®é¢˜å¤ç°"></a>é—®é¢˜å¤ç°</h1><p>è¿™é‡Œåœ¨æŸå°å®¿ä¸»æœºä¸Šé¢åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°ç›®å½•ï¼Œç„¶åæŒ‰ç…§é»˜è®¤æ–¹å¼ï¼š</p><figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs   <span class="number">10.10</span>.<span class="number">10.142</span><span class="symbol">:/data/bbb</span> /tmp/cc</span><br></pre></td></tr></tbody></table></figure><p>å°†nfsæŒ‚è½½åˆ°æœ¬åœ°ï¼Œç„¶åæ˜ å°„åˆ°å®¹å™¨ä¸­å»ï¼Œæ‰€ä»¥è¿™é‡Œè·Ÿk8sç¯å¢ƒæ²¡å¤šå¤§è”ç³»ï¼Œä¸»è¦æ˜¯nfsæŒ‚è½½é—®é¢˜ï¼š</p><p> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/1.png"></p><p>åˆå§‹åŒ–ä¸€ç›´å¡ç€ï¼Œè€Œä¸”åœ¨æŒ‚è½½ç›®å½•å‘ç°åªæœ‰è¿™ä¸ªæ–‡ä»¶ï¼š</p><p> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/0.png"></p><h1 id="é—®é¢˜æ’æŸ¥"><a href="#é—®é¢˜æ’æŸ¥" class="headerlink" title="é—®é¢˜æ’æŸ¥"></a>é—®é¢˜æ’æŸ¥</h1><p>æ£€æŸ¥ä¸€ä¸‹nfsæŒ‚è½½çš„å‚æ•°æƒ…å†µï¼š</p><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mount -v  | grep nfs</span><br><span class="line"></span><br><span class="line">10.10.10.137:<span class="string">/data/nfs_share_137</span> on <span class="string">/tmp/fans</span> type nfs <span class="params">(rw,relatime,<span class="attr">vers</span>=3,<span class="attr">rsize</span>=1048576,<span class="attr">wsize</span>=1048576,<span class="attr">namlen</span>=255,hard,<span class="attr">proto</span>=tcp,<span class="attr">timeo</span>=600,<span class="attr">retrans</span>=2,<span class="attr">sec</span>=sys,<span class="attr">mountaddr</span>=10.10.10.137,<span class="attr">mountvers</span>=3,<span class="attr">mo</span>=udp,<span class="attr">local_lock</span>=none,<span class="attr">addr</span>=10.10.10.137)</span></span><br><span class="line"></span><br><span class="line">10.10.10.142:<span class="string">/data/bbb</span> on <span class="string">/tmp/cc</span> type nfs <span class="params">(rw,relatime,<span class="attr">vers</span>=3,<span class="attr">rsize</span>=1048576,<span class="attr">wsize</span>=1048576,<span class="attr">namlen</span>=255,hard,<span class="attr">proto</span>=tcp,<span class="attr">timeo</span>=600,<span class="attr">retrans</span>=2,<span class="attr">sec</span>=sys,<span class="attr">mountaddr</span>=10.10.10.142,<span class="attr">mountvers</span>=3,<span class="attr">mountport</span>=<span class="attr">569lock</span>=none,<span class="attr">addr</span>=10.10.10.142)</span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚ä¸Šå¯ä»¥çœ‹å‡ºæˆ‘ä»¬å¦‚æœä½¿ç”¨é»˜è®¤çš„æ–¹å¼ç›´æ¥æŒ‚è½½ï¼Œå®ƒä¼šæœ‰ä¸€äº›é»˜è®¤å‚æ•°</p><p>åé¢ä¹Ÿæ˜¯é€šè¿‡è¯¥å®¹å™¨è¿è¡Œçš„å®¿ä¸»æœºä¸Šçš„å†…æ ¸æ—¥å¿—æ‰å‘ç°ï¼Œè¿™ä¸ªé—®é¢˜ï¼š<br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/3.png"></p><h1 id="é—®é¢˜å¤„ç†"><a href="#é—®é¢˜å¤„ç†" class="headerlink" title="é—®é¢˜å¤„ç†"></a>é—®é¢˜å¤„ç†</h1><p>è¿™ä¸ªé”™è¯¯æç¤ºå®é™…ä¸Šæ˜¯NFSå®¢æˆ·ç«¯æ— æ³•è·å¾—æ–‡ä»¶é”å®šï¼Œè€Œä¸æ˜¯æ— æ³•ä¸NFSæœåŠ¡å™¨å»ºç«‹è”ç³»ã€‚å½“NFSå®¢æˆ·ç«¯æ— æ³•è·å¾—æ–‡ä»¶é”å®šæ—¶ï¼Œå®ƒä¼šå°è¯•å‘NFSæœåŠ¡å™¨å‘é€é”å®šè¯·æ±‚ï¼Œå¹¶ç­‰å¾…æœåŠ¡å™¨å“åº”ã€‚å¦‚æœNFSæœåŠ¡å™¨æ²¡æœ‰å“åº”ï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°ç±»ä¼¼çš„é”™è¯¯æç¤ºã€‚å¯èƒ½é€ æˆè¿™ä¸ªé”™è¯¯çš„åŸå› å¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥NFSæœåŠ¡å™¨çš„è´Ÿè½½æƒ…å†µï¼Œå¦‚æœè´Ÿè½½è¿‡é«˜ï¼Œåˆ™å¯èƒ½éœ€è¦ä¼˜åŒ–æœåŠ¡å™¨é…ç½®æˆ–å¢åŠ æœåŠ¡å™¨æ•°é‡ã€‚</li><li>æ£€æŸ¥NFSå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œå¦‚æœå­˜åœ¨ç½‘ç»œæ•…éšœï¼Œåˆ™å¯èƒ½éœ€è¦ä¿®å¤ç½‘ç»œé—®é¢˜æˆ–æ›´æ”¹ç½‘ç»œé…ç½®ã€‚</li><li>è€ƒè™‘ä½¿ç”¨NFSæŒ‚è½½é€‰é¡¹æ¥ä¼˜åŒ–NFSå®¢æˆ·ç«¯çš„è¡Œä¸ºï¼Œä¾‹å¦‚ä½¿ç”¨softé€‰é¡¹è€Œä¸æ˜¯hardé€‰é¡¹ï¼Œæˆ–è€…ä½¿ç”¨intré€‰é¡¹å…è®¸ä¸­æ–­NFSæ“ä½œã€‚</li><li>å¦‚æœNFSå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨ä¸åŒçš„æ—¶åŒºä¸­è¿è¡Œï¼Œåˆ™å¯èƒ½éœ€è¦ä½¿ç”¨noacé€‰é¡¹æ¥ç¦ç”¨NFSå®¢æˆ·ç«¯çš„å±æ€§ç¼“å­˜ï¼Œä»¥ç¡®ä¿æ–‡ä»¶é”å®šè¯·æ±‚å’Œå“åº”çš„æ—¶é—´æˆ³æ˜¯æ­£ç¡®çš„ã€‚</li><li>å¦‚æœæ‚¨çš„NFSå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¿è¡Œçš„æ˜¯ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œåˆ™å¯èƒ½éœ€è¦ä½¿ç”¨é€‚å½“çš„æŒ‚è½½é€‰é¡¹æ¥ç¡®ä¿æ–‡ä»¶é”å®šæœºåˆ¶å¾—åˆ°æ­£ç¡®æ”¯æŒï¼Œä¾‹å¦‚ä½¿ç”¨nolocké€‰é¡¹æ¥ç¦ç”¨æ–‡ä»¶é”å®šæœºåˆ¶ã€‚</li></ol><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†kuboard, æ— æ³•å…¨å±€å¯¹è¿™ä¸ªå­˜å‚¨ç±»åšæš‚æ—¶ä¸èƒ½å½±å“ä¸šåŠ¡ï¼Œä¸èƒ½æ‰€æœ‰å˜æ›´ï¼š<br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/4.png"><br>è¿™é‡Œåªæ˜¯å•ç‹¬è¿™ä¸ªmysqlæœåŠ¡æ²¡æœ‰åŠæ³•æŒ‚åœ¨ä½¿ç”¨ï¼Œæ˜¯ç”±éœ€è¦æ·»åŠ æŒ‚è½½å‚æ•°ï¼š<br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/5.png"></p><p> æ‰¾åˆ°æˆ‘ä»¬åœ¨é¡µé¢ä¸Šæ–°å»ºçš„pv:</p> <figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> kubectl edit pv <span class="operator">-</span>n testnet pvc-b0de2c7f-<span class="number">49</span>de-<span class="number">4</span>e16-<span class="number">83</span>cc-<span class="number">492</span>de8292e5f</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span></span><br><span class="line"><span class="comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span></span><br><span class="line"><span class="comment"># reopened with the relevant failures.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> PersistentVolume</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">annotations:</span></span><br><span class="line">    pv.kubernetes.io<span class="operator">/</span><span class="params">provisioned-by:</span> nfs-testnet</span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="string">"2023-07-20T16:29:30Z"</span></span><br><span class="line">  <span class="params">finalizers:</span></span><br><span class="line">  <span class="operator">-</span> kubernetes.io<span class="symbol">/pv-protection</span></span><br><span class="line">  <span class="params">name:</span> pvc-b0de2c7f-<span class="number">49</span>de-<span class="number">4</span>e16-<span class="number">83</span>cc-<span class="number">492</span>de8292e5f</span><br><span class="line">  <span class="params">resourceVersion:</span> <span class="string">"147600146"</span></span><br><span class="line">  <span class="params">uid:</span> e9f111ac-<span class="number">293</span>2-<span class="number">46</span>a0-b6bc-<span class="number">876275</span>dfa02f</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">accessModes:</span></span><br><span class="line">  <span class="operator">-</span> ReadWriteOnce</span><br><span class="line">  <span class="params">capacity:</span></span><br><span class="line">    <span class="params">storage:</span> <span class="number">2</span>G</span><br><span class="line">  <span class="params">claimRef:</span></span><br><span class="line">    <span class="params">apiVersion:</span> v1</span><br><span class="line">    <span class="params">kind:</span> PersistentVolumeClaim</span><br><span class="line">    <span class="params">name:</span> dassssssssssssssss</span><br><span class="line">    <span class="params">namespace:</span> testnet</span><br><span class="line">    <span class="params">resourceVersion:</span> <span class="string">"147600141"</span></span><br><span class="line">    <span class="params">uid:</span> b0de2c7f-<span class="number">49</span>de-<span class="number">4</span>e16-<span class="number">83</span>cc-<span class="number">492</span>de8292e5f</span><br><span class="line">  <span class="params">nfs:</span></span><br><span class="line">    <span class="params">path:</span> <span class="symbol">/data/testnet-dassssssssssssssss-pvc-b0de2c7f-49de-4e16-83cc-492de8292e5f</span></span><br><span class="line">    <span class="params">server:</span> <span class="number">10.10</span>.<span class="number">10.142</span></span><br><span class="line">  <span class="params">persistentVolumeReclaimPolicy:</span> Retain</span><br><span class="line">  <span class="params">storageClassName:</span> testnet</span><br><span class="line">  <span class="params">volumeMode:</span> Filesystem</span><br><span class="line"><span class="params">status:</span></span><br><span class="line">  <span class="params">phase:</span> Bound</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åæˆ‘ä»¬åœ¨<code>volumeModeåŒçº§</code> å°±å¯ä»¥å®šä¹‰æŒ‚è½½å‚æ•°(å…·ä½“å‚æ•°ï¼š<a href="https://poe.com/s/FyTCOkthr3VREHU3mByA)%EF%BC%9A">https://poe.com/s/FyTCOkthr3VREHU3mByA)ï¼š</a></p><figure class="highlight ldif"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mountOptions</span>:</span><br><span class="line"><span class="literal">-</span> nolock</span><br><span class="line"><span class="literal">-</span> timeo=120</span><br><span class="line"><span class="literal">-</span> intr</span><br><span class="line"><span class="literal">-</span> retrans=10</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·æˆ‘ä»¬å•ç‹¬ä¸ºMySQLæœåŠ¡åˆ›å»ºçš„è¿™ä¸ªpvcå°±æ‹¥æœ‰äº†è¿™äº›æŒ‚è½½å‚æ•°ï¼Œåˆå§‹åŒ–ï¼Œè¿è¡Œæ­£å¸¸ï¼š<br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/6.png"></p><p>åœ¨è¿™ä¸ªpodè¿è¡Œçš„å®¿ä¸»æœºä¸Š æŸ¥çœ‹ç»“æœï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¿®æ”¹pvåçš„å‚æ•°å·²ç»ç”Ÿæ•ˆï¼Œå¹¶ä¸”åœ¨nfsæœåŠ¡ç«¯å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„MySQLåˆå§‹åŒ–æ–‡ä»¶å·²ç»ç”Ÿæˆï¼š<br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/7.png"><br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/8.png"></p><p>æœ€ç»ˆè¯¥æŒ‚è½½é—®é¢˜å®Œç¾è§£å†³ã€‚</p><p>å¯¹äºç‰¹æ®Šï¼Œä¸åŒçš„deployment å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡ŒæŒ‰ç…§mysqlçš„éƒ¨ç½²ï¼Œè®°å½•ä¸€ä¸‹é¡ºåº</p><ol><li>åˆ›å»ºpvc</li><li>ä¿®æ”¹é»˜è®¤pvcé…ç½®ï¼Œå¢åŠ nfsæŒ‚è½½å‚æ•°</li><li>å¯åŠ¨pod</li><li>æ£€æŸ¥æŒ‚è½½ç›®å½•æ•°æ®æ˜¯å¦æ­£å¸¸ç”Ÿæˆ</li><li>æ£€æŸ¥æŒ‚è½½é€‰é¡¹æ˜¯å¦å·²ç»å¢åŠ </li></ol><p> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/00.jpeg"></p><p>By the way:<br>è°è¯´çš„K8Sä¸èƒ½è·‘MySQLï¼Œ æˆ‘å«©æ­»TA ğŸ”ªğŸ”ªğŸ”ª</p>]]></content>
      
      
      
        <tags>
            
            <tag> NFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus+Consulå®ç°ä¼ä¸šçº§å®¿ä¸»æœº+å®¹å™¨ç›‘æ§å‘Šè­¦</title>
      <link href="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/"/>
      <url>/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€èƒŒæ™¯"><a href="#ä¸€ã€èƒŒæ™¯" class="headerlink" title="ä¸€ã€èƒŒæ™¯"></a>ä¸€ã€èƒŒæ™¯</h1><p>å› å…¬å¸å†å²é—ç•™åŸå› æœ‰ä¸ªåˆ«ç¯å¢ƒæš‚æ—¶æ²¡æœ‰ä½¿ç”¨kubernets, ç°åœ¨éœ€è¦å°†è¿™æ‰¹æœåŠ¡å™¨çš„ç›‘æ§ç³»ç»Ÿä»zabbixæ›¿æ¢åˆ°Prometheus, äºæ˜¯ä¹è¿™è¾¹æœ‰ä¸ªé—®é¢˜å°±æ˜¯éœ€è¦å°†æ‰€æœ‰æœåŠ¡å™¨ä¸Šé¢çš„æ‰€æœ‰çš„exporter merticsï¼ˆå³ targetï¼‰åœ°å€å†™åˆ°Prometheusé…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶ï¼Œä¼¼ä¹è¿˜ç®—å¯ä»¥ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘é‡‡ç”¨Prometheus+Consulçš„æ–¹å¼æ¥ç®¡ç†æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰exporterï¼Œ é‚£ä¹ˆè¿™æ ·åšçš„å¥½å¤„æ˜¯æˆ‘ä»¬èƒ½æ›´æ¸…æ™°çš„é€šè¿‡Consulæ¥ç®¡ç†ä¸Šé¢çš„æ¯ä¸ªexporter url , ä»¥åŠé€šè¿‡consulè‡ªå¸¦çš„è‡ªå®šä¹‰å…ƒæ•°æ®ï¼Œå†ç»“åˆPromethuesæ— ç–‘æ˜¯ä¸ªå¾ˆçµæ´»çš„æ–¹å¼ã€‚</p><h1 id="äºŒã€æ¶æ„"><a href="#äºŒã€æ¶æ„" class="headerlink" title="äºŒã€æ¶æ„"></a>äºŒã€æ¶æ„</h1><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/arch.png"></p><ol><li>promtheusé…ç½®æ•°æ®æºä¸ºconsu_sd_configs åœ°å€æŒ‡å‘ä¸€ä¸ªconsulå®¢æˆ·ç«¯åœ°å€ï¼›</li><li>é€šè¿‡è„šæœ¬è°ƒç”¨consulapiçš„æ–¹å¼å°†å®¿ä¸»æœºä¸Šé¢çš„cadvisor-exporter,node-exporter metricsçš„åœ°å€æ³¨å†Œåˆ°consulä¸­ï¼›</li><li>promtheus æ£€æµ‹åˆ°äº†æ–°å¢æœåŠ¡åï¼Œä¼šé€šè¿‡è¿™ä¸ª<a href="http://xxxxxx:xxx/metrics">http://xxxxxx:xxx/metrics</a> url æŠ“å–é‡‡é›†æ•°æ®ï¼›</li><li>åç»­çš„æ•°æ®é‡‡é›†å°±è·Ÿå¹³å¸¸æˆ‘ä»¬ä½¿ç”¨çš„æ–¹å¼ä¸€æ ·äº†ï¼Œé‡‡é›†åˆ°çš„æ•°æ®æ—¶åºä¿å­˜åœ¨promtheusï¼›</li><li>Grafanaä½œä¸ºé‡‡é›†æ•°æ®çš„ä¸€ä¸ªå±•ç¤º,é€šè¿‡å„ç§labelï¼Œæ›´åŠ æ–¹ä¾¿çš„å¯¹é¢æ¿è¿›è¡Œé…ç½®ï¼›</li><li>æ·»åŠ node-exporterï¼Œ cadvisor-exporterçš„æŒ‡æ ‡æŠ¥è­¦è§„åˆ™ï¼Œé€šè¿‡Alertmanager å‘å‡ºä¸»æœºæˆ–å®¹å™¨çš„å‘Šè­¦ï¼›</li></ol><h1 id="ä¸‰ã€å®ç°"><a href="#ä¸‰ã€å®ç°" class="headerlink" title="ä¸‰ã€å®ç°"></a>ä¸‰ã€å®ç°</h1><h2 id="Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²"><a href="#Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²" class="headerlink" title="Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²"></a>Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²</h2><p>è¯¥ç¼–æ’æ–‡ä»¶ä¸­éƒ¨ç½²äº†</p><ol><li>Prometheus: ç›‘æ§ç³»ç»Ÿä¸»ç¨‹åº</li><li>Alertmanager: å‘Šè­¦å‘é€</li><li>Grafana: æ•°æ®å±•ç¤º</li><li>Prometheus-dingding-webhook: é’‰é’‰å‘Šè­¦æ¨é€</li><li>alertmanager-dashboard: ä¸»è¦ç”¨äºå‘Šè­¦æ¡ç›®å±•ç¤ºï¼Œè¯¥è½¯ä»¶æ˜¯å¼€æºé¡¹ç›®ï¼Œéšæ„ä¸‹è½½éƒ¨ç½²</li></ol><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cat &gt; docker-compose.yaml &lt;&lt; EOF</span></span><br><span class="line"><span class="attribute">version</span><span class="punctuation">:</span> <span class="string">'3.7'</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">services</span><span class="punctuation">:</span></span><br><span class="line"><span class="punctuation"></span></span><br><span class="line">  <span class="attribute">prometheus</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">prom/prometheus:latest</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus/:/etc/prometheus/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/prometheus-data:/prometheus</span></span><br><span class="line">    <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--config.file=/etc/prometheus/prometheus.yml'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--storage.tsdb.path=/prometheus'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.console.libraries=/usr/share/prometheus/console_libraries'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.console.templates=/usr/share/prometheus/consoles'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.enable-lifecycle'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.external-url=http://192.168.18.178:9090'</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9090:9090</span></span><br><span class="line">    <span class="attribute">links</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">alertmanager:alertmanager</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">alertmanager</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">prom/alertmanager</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9093:9093</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./alertmanager/:/etc/alertmanager/</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--config.file=/etc/alertmanager/config.yml'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--storage.path=/alertmanager'</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">grafana</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">grafana/grafana:8.4.0</span></span><br><span class="line">    <span class="attribute">depends_on</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">3000:3000</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/grafana-data:/var/lib/grafana</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./grafana/provisioning/:/etc/grafana/provisioning/</span></span><br><span class="line">    <span class="attribute">env_file</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./grafana/config.monitoring</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">webhook</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">timonwong/prometheus-webhook-dingtalk</span></span><br><span class="line">    <span class="attribute">depends_on</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus-webhook-dingtalk/config.yml:/config/config.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus-webhook-dingtalk/dingding.tmpl:/config/dingding.tmpl</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9060:8060</span></span><br><span class="line">    <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.listen-address=:8060'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--config.file=/config/config.yml'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.enable-ui'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.enable-lifecycle'</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">alertmanager-dashboard</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">ghcr.io/prymitive/karma:latest</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9094:8080</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">environment</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALERTMANAGER_URI=http://192.168.18.178:9093</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># runèµ·æ¥</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šè¿è¡Œèµ·æ¥åï¼ŒåŸºæœ¬çš„åŠŸèƒ½å·²ç»å®Œæˆï¼Œæ­¤æ—¶åªéœ€è¦å°†targetæ·»åŠ åˆ°prometheusä¸­å°±å¯ä»¥äº†</p><h2 id="3-2-exporter-æ•°æ®é‡‡é›†å™¨-éƒ¨ç½²"><a href="#3-2-exporter-æ•°æ®é‡‡é›†å™¨-éƒ¨ç½²" class="headerlink" title="3.2 exporter(æ•°æ®é‡‡é›†å™¨)éƒ¨ç½²"></a>3.2 exporter(æ•°æ®é‡‡é›†å™¨)éƒ¨ç½²</h2><p>ä¸Šé¢æåˆ°æˆ‘ä»¬è¿™éƒ¨åˆ†ç¯å¢ƒæ²¡æœ‰è¿ç§»åˆ°k8sï¼Œæ‰€æœ‰å¾®æœåŠ¡éƒ½æ˜¯dockeræ–¹å¼è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šé¢çš„ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œéœ€è¦å•ç‹¬éœ€è¦å»éƒ¨ç½²å¯¹å®¿ä¸»æœºè·Ÿå®¹å™¨çš„eporter(æ•°æ®é‡‡é›†å™¨), ç›®å‰çš„éœ€æ±‚å°±æ˜¯ç›‘æ§å®¿ä¸»æœºä»¥åŠå®¹å™¨ï¼Œå¹¶å°†é‡‡é›†åˆ°çš„æ•°æ®è¿›è¡Œå±•ç¤ºã€å‘Šè­¦ç­‰ã€‚</p><ul><li>å®¿ä¸»æœºçš„ç›‘æ§ï¼šåˆ©ç”¨Prometheusæ­å»ºéƒ¨ç½²ç›‘æ§ç³»ç»Ÿï¼Œé‚£ä¹ˆå¯¹äºæœåŠ¡å™¨å±‚é¢çš„æ•°æ®é‡‡é›†æˆ‘ä»¬é¦–é€‰çš„æ˜¯node-exporterï¼›</li><li>å®¹å™¨çš„ç›‘æ§ï¼šåœ¨è°ƒç ”å®¹å™¨ç›‘æ§è¿™å—å„¿çš„æ—¶å€™å‘ç°container-exporterç›‘æ§æŒ‡æ ‡è™½ç„¶èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯å‘ç°é‡‡é›†çš„æ•°æ®è¿‡äºç®€æ´ä¸”åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šé€ æˆå†…å­˜ç§¯å‹æœ€ç»ˆå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œé™¤éæ˜¯äººä¸ºå¹²æ¶‰é‡å¯ä¸€ä¸‹ï¼Œé‡Šæ”¾å†…å­˜ï¼Œä½†æ˜¯è¿™ç§äº‹å„¿ä¸åº”è¯¥å‘ç”Ÿã€‚å› æ­¤è¿˜æ˜¯é‡‡ç”¨cadvisor exporteræ¥è¿›è¡Œå®¹å™¨çš„æ•°æ®é‡‡é›†</li></ul><p>éœ€è¦åœ¨æ¯å°å®¿ä¸»æœºä¸Šé¢éƒ¨ç½²ä¸¤ä¸ªexporter</p><h3 id="åˆ›å»ºç›®å½•-ä¸€èˆ¬æ”¾åˆ°æ™®é€šç”¨æˆ·appå®¶ç›®å½•å³å¯"><a href="#åˆ›å»ºç›®å½•-ä¸€èˆ¬æ”¾åˆ°æ™®é€šç”¨æˆ·appå®¶ç›®å½•å³å¯" class="headerlink" title="åˆ›å»ºç›®å½•(ä¸€èˆ¬æ”¾åˆ°æ™®é€šç”¨æˆ·appå®¶ç›®å½•å³å¯)"></a>åˆ›å»ºç›®å½•(ä¸€èˆ¬æ”¾åˆ°æ™®é€šç”¨æˆ·appå®¶ç›®å½•å³å¯)</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> exporter-deploy &amp;&amp; <span class="built_in">cd</span> exporter-deploy</span><br></pre></td></tr></tbody></table></figure><h3 id="ç¼–æ’æ–‡ä»¶å‡†å¤‡"><a href="#ç¼–æ’æ–‡ä»¶å‡†å¤‡" class="headerlink" title="ç¼–æ’æ–‡ä»¶å‡†å¤‡"></a>ç¼–æ’æ–‡ä»¶å‡†å¤‡</h3><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cat &gt; docker-compose.yaml &lt;&lt; EOF</span></span><br><span class="line"><span class="attribute">version</span><span class="punctuation">:</span> <span class="string">'3.7'</span></span><br><span class="line"><span class="attribute">services</span><span class="punctuation">:</span></span><br><span class="line">  <span class="comment"># å®¿ä¸»æœºæ•°æ®é‡‡é›†</span></span><br><span class="line">  <span class="attribute">node-exporter</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">bitnami/node-exporter:latest</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/proc:/host/proc:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/sys:/host/sys:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/:/rootfs:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/:/host:ro,rslave</span></span><br><span class="line">    <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--path.rootfs=/host'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--path.procfs=/host/proc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--path.sysfs=/host/sys'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--web.disable-exporter-metrics</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-mount-points</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)"</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9100:9100</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line">          </span><br><span class="line">  <span class="comment"># å®¹å™¨æ•°æ®é‡‡é›†</span></span><br><span class="line">  <span class="attribute">cadvisor-exporter</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">gcr.io/cadvisor/cadvisor/cadvisor:v0.45.0</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/:/rootfs:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run:/var/run:rw</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/sys:/sys:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/lib/docker/:/var/lib/docker:ro</span></span><br><span class="line">    <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"-docker_only=true"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"-housekeeping_interval=10s"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"-docker_only=true"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"--allow_dynamic_housekeeping=false"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"--storage_duration=20s"</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9105:8080</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">mode</span><span class="punctuation">:</span> <span class="string">global</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"2.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line">EOF</span><br><span class="line"> </span><br><span class="line"><span class="comment"># runèµ·æ¥</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šï¼Œåªéœ€è¦æ­¤é…ç½®æ–‡ä»¶å°±éƒ¨ç½²å¥½äº† â€œexporterå®¢æˆ·ç«¯â€ </p><p>ä¸‹é¢å°±æ˜¯ å°†è¿™å°æœåŠ¡å™¨ä»¥åŠè¿ä¸ªexporterçš„url æ³¨å†Œåˆ°consulä¸­ï¼Œå¦‚æœæœ‰æ‰¹é‡å®‰è£…éœ€æ±‚ï¼Œç›´æ¥åœ¨jumpä¸Šé¢é€šè¿‡ansible æ¨é€å³å¯</p><h2 id="3-3-consul-é›†ç¾¤éƒ¨ç½²"><a href="#3-3-consul-é›†ç¾¤éƒ¨ç½²" class="headerlink" title="3.3 consul é›†ç¾¤éƒ¨ç½²"></a>3.3 consul é›†ç¾¤éƒ¨ç½²</h2><h3 id="æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªdocker-ç½‘ç»œ"><a href="#æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªdocker-ç½‘ç»œ" class="headerlink" title="æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªdocker ç½‘ç»œ"></a>æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªdocker ç½‘ç»œ</h3><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> network create --driver bridge --subnet <span class="number">10.10.0.0</span>/<span class="number">24</span>  consul-network</span><br></pre></td></tr></tbody></table></figure><h3 id="åˆ›å»ºconsulçš„æ•°æ®ã€é…ç½®ç›®å½•"><a href="#åˆ›å»ºconsulçš„æ•°æ®ã€é…ç½®ç›®å½•" class="headerlink" title="åˆ›å»ºconsulçš„æ•°æ®ã€é…ç½®ç›®å½•"></a>åˆ›å»ºconsulçš„æ•°æ®ã€é…ç½®ç›®å½•</h3><figure class="highlight haskell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">sudo</span> mkdir  -p /<span class="class"><span class="keyword">data</span>/consul/consul-server{1..3}/{<span class="title">data</span>,<span class="title">config</span>}</span></span><br><span class="line"><span class="title">sudo</span> mkdir  -p /<span class="class"><span class="keyword">data</span>/consul/consul-client{1..2}/{<span class="title">data</span>,<span class="title">config</span>}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="ç¼–è¾‘docker-composeé…ç½®"><a href="#ç¼–è¾‘docker-composeé…ç½®" class="headerlink" title="ç¼–è¾‘docker-composeé…ç½®"></a>ç¼–è¾‘docker-composeé…ç½®</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; docker-compose-consul-cluster.yaml &lt;&lt; \EOF</span><br><span class="line">version: <span class="string">'3.7'</span></span><br><span class="line"> </span><br><span class="line">services:</span><br><span class="line">  consul-server1:</span><br><span class="line">    image: consul:latest</span><br><span class="line">    network_mode: consul-network</span><br><span class="line">    container_name: consul-server1</span><br><span class="line">    restart: always</span><br><span class="line">    <span class="built_in">command</span>: agent -server -client=0.0.0.0 -bootstrap-expect=3 -node=consul-server1  -<span class="built_in">bind</span>=0.0.0.0  -config-dir=/consul/config</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/consul/consul-server1/data:/consul/data</span><br><span class="line">      - /data/consul/consul-server1/config:/consul/config</span><br><span class="line"> </span><br><span class="line">  consul-server2:</span><br><span class="line">    image: consul:latest</span><br><span class="line">    network_mode: consul-network</span><br><span class="line">    container_name: consul-server2</span><br><span class="line">    restart: always</span><br><span class="line">    <span class="built_in">command</span>: agent -server -client=0.0.0.0 -retry-join=consul-server1 -node=consul-server2  -<span class="built_in">bind</span>=0.0.0.0   -config-dir=/consul/config</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/consul/consul-server2/data:/consul/data</span><br><span class="line">      - /data/consul/consul-server2/config:/consul/config</span><br><span class="line">    depends_on:</span><br><span class="line">      - consul-server1</span><br><span class="line"> </span><br><span class="line">  consul-server3:</span><br><span class="line">    image: consul:latest</span><br><span class="line">    network_mode: consul-network</span><br><span class="line">    container_name: consul-server3</span><br><span class="line">    restart: always</span><br><span class="line">    <span class="built_in">command</span>: agent -server -client=0.0.0.0 -retry-join=consul-server1 -node=consul-server3  -<span class="built_in">bind</span>=0.0.0.0   -config-dir=/consul/config</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/consul/consul-server3/data:/consul/data</span><br><span class="line">      - /data/consul/consul-server3/config:/consul/config</span><br><span class="line">    depends_on:</span><br><span class="line">      - consul-server1</span><br><span class="line"> </span><br><span class="line">  consul-client1:</span><br><span class="line">    image: consul:latest</span><br><span class="line">    network_mode: consul-network</span><br><span class="line">    container_name: consul-client1</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 8500:8500</span><br><span class="line">    <span class="built_in">command</span>: agent -client=0.0.0.0 -retry-join=consul-server1 -ui -node=consul-client1  -<span class="built_in">bind</span>=0.0.0.0   -config-dir=/consul/config</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/consul/consul-client1/data:/consul/data</span><br><span class="line">      - /data/consul/consul-client1/config:/consul/config</span><br><span class="line">    depends_on:</span><br><span class="line">      - consul-server2</span><br><span class="line">      - consul-server3</span><br><span class="line"> </span><br><span class="line">  consul-client2:</span><br><span class="line">    image: consul:latest</span><br><span class="line">    network_mode: consul-network</span><br><span class="line">    container_name: consul-client2</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 8501:8500</span><br><span class="line">    <span class="built_in">command</span>: agent -client=0.0.0.0 -retry-join=consul-server1 -ui -node=consul-client2  -<span class="built_in">bind</span>=0.0.0.0  -config-dir=/consul/config</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/consul/consul-client2/data:/consul/data</span><br><span class="line">      - /data/consul/consul-client2/config:/consul/config</span><br><span class="line">    depends_on:</span><br><span class="line">      - consul-server2</span><br><span class="line">      - consul-server3</span><br><span class="line">EOF</span><br><span class="line"> </span><br><span class="line"><span class="comment"># è¿è¡Œèµ·æ¥ï¼š</span></span><br><span class="line">docker-compose -f docker-compose-consul-cluster.yaml up -d</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE                                                                COMMAND                  CREATED         STATUS                     PORTS                                                                                         NAMES</span><br><span class="line">223826237a7b   consul:latest                                                        <span class="string">"docker-entrypoint.sâ€¦"</span>   3 seconds ago   Up 2 seconds               8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8501-&gt;8500/tcp, :::8501-&gt;8500/tcp   consul-client2</span><br><span class="line">337a3188fb75   consul:latest                                                        <span class="string">"docker-entrypoint.sâ€¦"</span>   3 seconds ago   Up 2 seconds               8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8500-&gt;8500/tcp, :::8500-&gt;8500/tcp   consul-client1</span><br><span class="line">685440aefca3   consul:latest                                                        <span class="string">"docker-entrypoint.sâ€¦"</span>   4 seconds ago   Up 3 seconds               8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                                    consul-server2</span><br><span class="line">5f9927f2ecac   consul:latest                                                        <span class="string">"docker-entrypoint.sâ€¦"</span>   4 seconds ago   Up 3 seconds               8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                                    consul-server3</span><br><span class="line">612b93b95ad9   consul:latest                                                        <span class="string">"docker-entrypoint.sâ€¦"</span>   5 seconds ago   Up 4 seconds               8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                                    consul-server1</span><br><span class="line"> </span><br><span class="line"><span class="comment"># æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š</span></span><br><span class="line">docker <span class="built_in">exec</span> -it consul-server1 consul  members</span><br><span class="line">Node            Address         Status  Type    Build   Protocol  DC   Partition  Segment</span><br><span class="line">consul-server1  10.10.0.2:8301  alive   server  1.13.1  2         dc1  default    &lt;all&gt;</span><br><span class="line">consul-server2  10.10.0.3:8301  alive   server  1.13.1  2         dc1  default    &lt;all&gt;</span><br><span class="line">consul-server3  10.10.0.4:8301  alive   server  1.13.1  2         dc1  default    &lt;all&gt;</span><br><span class="line">consul-client1  10.10.0.6:8301  alive   client  1.13.1  2         dc1  default    &lt;default&gt;</span><br><span class="line">consul-client2  10.10.0.5:8301  alive   client  1.13.1  2         dc1  default    &lt;default&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="è®¿é—®consulçš„webé¡µé¢"><a href="#è®¿é—®consulçš„webé¡µé¢" class="headerlink" title="è®¿é—®consulçš„webé¡µé¢"></a>è®¿é—®consulçš„webé¡µé¢</h3><p><a href="http://192.168.18.179:8501/ui/dc1/overview/server-status">http://192.168.18.179:8501/ui/dc1/overview/server-status</a><br><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/consul.png"></p><p>æ­¤æ—¶é›†ç¾¤å·²ç»æ­å»ºå®Œæ¯•</p><h3 id="å°†æœåŠ¡å™¨çš„exporteræ³¨å†Œåˆ°consul"><a href="#å°†æœåŠ¡å™¨çš„exporteræ³¨å†Œåˆ°consul" class="headerlink" title="å°†æœåŠ¡å™¨çš„exporteræ³¨å†Œåˆ°consul"></a>å°†æœåŠ¡å™¨çš„exporteræ³¨å†Œåˆ°consul</h3><p>åœ¨consul uiä¸­å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ç»“æœ</p><p>ä»¥ä¸Šå°±æ˜¯å°†191.168.18.21ä¸»æœºä¸Šçš„cadvisoræœåŠ¡æ³¨å†Œåˆ°äº†consuä¸Šé¢ï¼Œå°†è¿™ç±»æœåŠ¡çš„åç§°ç»Ÿç§°ä¸º cadvisor-exporter ,å› ä¸ºæœåŠ¡å®ä¾‹idå¿…é¡»å”¯ä¸€ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç‰¹æ®Šå®šä¹‰ä¸€ä¸‹ exporter type - ä¸»æœºå - ipåœ°å€</p><p>æœ€åå°±æ˜¯å°†ä¸¤ä¸ªepxorteréƒ½å°†21è¿™å°ä¸»æœºçš„ä¸¤ä¸ªexporteréƒ½æ³¨å†Œåˆ°äº†consul.</p><h3 id="é…ç½®promeheus-ä½¿å…¶æ”¯æŒconsul"><a href="#é…ç½®promeheus-ä½¿å…¶æ”¯æŒconsul" class="headerlink" title="é…ç½®promeheus ä½¿å…¶æ”¯æŒconsul"></a>é…ç½®promeheus ä½¿å…¶æ”¯æŒconsul</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="params">scrape_configs:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">job_name:</span> 'prometheus'</span><br><span class="line">    <span class="params">scrape_interval:</span> <span class="number">15</span>s</span><br><span class="line">    <span class="params">static_configs:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">targets:</span> ['localhost:<span class="number">9090</span>']</span><br><span class="line"></span><br><span class="line">  <span class="operator">-</span> <span class="params">job_name:</span> <span class="string">"cnosul-prometheus"</span></span><br><span class="line">    <span class="params">consul_sd_configs:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">server:</span> <span class="string">"192.168.18.178:8501"</span></span><br><span class="line">        <span class="params">services:</span> []</span><br><span class="line">    <span class="params">relabel_configs:</span> <span class="comment"># relabe é‡å†™</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">source_labels:</span> [__meta_consul_service] <span class="comment"># serviceæºæ ‡ç­¾</span></span><br><span class="line">        <span class="params">regex:</span> <span class="string">"consul"</span> <span class="comment"># serviceåŒ¹é…</span></span><br><span class="line">        <span class="params">action:</span> drop  <span class="comment"># æ‰§è¡Œçš„åŠ¨ä½œ, è¿™é‡Œä¸éœ€è¦consulçš„metricsï¼Œæ‰€ä»¥dropæ‰</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">source_labels:</span> [__meta_consul_service_metadata_hostname] <span class="comment"># å°†æ­¤æ ‡ç­¾çš„å€¼é‡å†™ä¸ºinstance</span></span><br><span class="line">        <span class="params">target_label:</span> instance</span><br><span class="line">        <span class="params">action:</span> replace</span><br><span class="line">      <span class="operator">-</span> <span class="params">source_labels:</span> [__meta_consul_service_metadata_group]</span><br><span class="line">        <span class="params">target_label:</span> group</span><br><span class="line">        <span class="params">action:</span> replace</span><br><span class="line">      <span class="operator">-</span> <span class="params">source_labels:</span> [__scheme__, __address__, __metrics_path__]</span><br><span class="line">        <span class="params">regex:</span> <span class="string">"(http|https)(.*)"</span>    <span class="comment"># ä¸¤ä¸ªåˆ†ç»„</span></span><br><span class="line">        <span class="params">separator:</span> <span class="string">""</span></span><br><span class="line">        <span class="params">target_label:</span> <span class="string">"endpoint"</span></span><br><span class="line">        <span class="params">replacement:</span> <span class="string">"<span class="subst">${<span class="number">1</span>}</span>://<span class="subst">${<span class="number">2</span>}</span>"</span>   <span class="comment"># å¼•ç”¨ä¸¤ä¸ªåˆ†ç»„</span></span><br><span class="line">        <span class="params">action:</span> replace</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>æ–°å¢åŠ ä»¥ä¸Šé…ç½®ä»¥åé‡æ–°åŠ è½½é…ç½®promtheusæœåŠ¡</p><p>curl -I -X POST <a href="http://127.0.0.1:9090/-/reload">http://127.0.0.1:9090/-/reload</a></p><p>æ³¨æ„ï¼šprometheuså¼€å¯apiçƒ­åŠ è½½ï¼Œéœ€è¦åŠ ä¸Šå¯åŠ¨å‚æ•°ï¼š â€“web.enable-lifecycle</p><p>consulæ³¨å†ŒæœåŠ¡/å®ä¾‹çš„æ—¶å€™å°±éœ€è¦æ·»åŠ è¿™ä¸¤ä¸ªå…ƒæ ‡ç­¾ï¼Œå†é€šè¿‡æ ‡ç­¾é‡æ–° ä¸ºæˆ‘ä»¬éœ€è¦çš„labelï¼Œä¾¿äºåé¢prometheus/grafanaä½¿ç”¨</p><p>ä»¥ä¸Šï¼Œé€šè¿‡é…ç½® prometheus ä¸º consul_sd_configsï¼Œä¹‹åèƒ½å¤Ÿæ­£ç¡®é€šè¿‡æœåŠ¡å‘ç°è·å–åˆ°ä¸¤ä¸ªæœåŠ¡å¾—metircs urlã€‚</p><p>æœåŠ¡å™¨ä¼—å¤šçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é‚£ä¹ˆè¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡è„šæœ¬çš„æ–¹å¼å»æ·»åŠ ï¼Œå› ä¸ºconsulæœ‰ä»¥ä¸‹å…ƒæ ‡ç­¾ï¼Œé‚£ä¹ˆæ›´å®¹æ˜“ä½¿å¾—æˆ‘ä»¬çš„æ•°æ®å¯æ§ï¼Œä¾‹å¦‚ä¸Šé¢æˆ‘ä»¬åœ¨æ³¨å†ŒæœåŠ¡çš„æ—¶å€™åŠ äº†ä¸€ä¸ª group ï¼Œhostname, consulä¼ é€’åˆ°promtheusä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡relableçš„æ–¹å¼å»é‡å†™, ä»¥ä¸Šä»£è¡¨çš„å°±æ˜¯è¿™ä¸ªä¸»æœºå±äºå“ªä¸ªåˆ†ç»„ï¼Œåç»­å¯ä»¥ä½œä¸ºgrafané¢æ¿ä¸­ï¼Œæˆ–è€…æŠ¥è­¦ä¸­çš„ä¸€ä¸ªå…³é”®æŒ‡æ ‡ã€‚</p><h3 id="å¦‚ä½•æ‰¹é‡æ³¨å†Œcadvisor-node-exporter-åˆ°-consul"><a href="#å¦‚ä½•æ‰¹é‡æ³¨å†Œcadvisor-node-exporter-åˆ°-consul" class="headerlink" title="å¦‚ä½•æ‰¹é‡æ³¨å†Œcadvisor/node exporter åˆ° consul"></a>å¦‚ä½•æ‰¹é‡æ³¨å†Œcadvisor/node exporter åˆ° consul</h3><p>consul è‡ªèº«æä¾›äº†APIï¼Œ å°±åƒä¸Šé¢ä¸€æ ·åšæˆè„šæœ¬ä»¥åï¼Œæ‰¹é‡æ³¨å†ŒæœåŠ¡/å®ä¾‹å³å¯ï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; register_exporter_to_consul.py &lt;&lt; \EOF</span><br><span class="line"> </span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># date: 2022-09-06</span></span><br><span class="line"><span class="comment"># author: guomaoqiu</span></span><br><span class="line"><span class="comment"># desc: æ‰¹é‡æ³¨å†Œcadvisor-exporter, node-exporteræœåŠ¡åˆ°consul</span></span><br><span class="line"> </span><br><span class="line">import json</span><br><span class="line">import requests</span><br><span class="line">import  json</span><br><span class="line"> </span><br><span class="line">consul_url = <span class="string">"http://192.168.18.179:8501/v1/agent/service/register"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># æ³¨å†Œnode-exporter</span></span><br><span class="line">def register_node_exporter(ip,hostname,group):</span><br><span class="line">    nodedata = {</span><br><span class="line">            <span class="string">"id"</span>: <span class="string">"node-exporter-{0}-{1}"</span>.format(hostname,ip),</span><br><span class="line">            # <span class="string">"id"</span>: hostname,</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"node-exporter"</span>,</span><br><span class="line">            <span class="string">"address"</span>: ip,</span><br><span class="line">            <span class="string">"port"</span>: 9100,</span><br><span class="line">            <span class="string">"tags"</span>: [],</span><br><span class="line">            <span class="string">"meta"</span>: {</span><br><span class="line">                <span class="string">"hostname"</span>: hostname,</span><br><span class="line">                <span class="string">"group"</span>:<span class="built_in"> group</span></span><br><span class="line"><span class="built_in"></span>            },</span><br><span class="line">            <span class="string">"checks"</span>: [</span><br><span class="line">                {</span><br><span class="line">                <span class="string">"http"</span>: <span class="string">"http://{0}:9100/metrics"</span>.format(ip),</span><br><span class="line">                <span class="string">"interval"</span>: <span class="string">"5s"</span></span><br><span class="line">                }</span><br><span class="line">        ]</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">print</span>(nodedata)</span><br><span class="line">    try:</span><br><span class="line">        r = requests.put(<span class="attribute">url</span>=consul_url, <span class="attribute">data</span>=json.dumps(nodedata))</span><br><span class="line">        <span class="keyword">if</span> r.status_code == 200:</span><br><span class="line">            <span class="built_in">print</span>(ip, <span class="string">"Node Exporter æ³¨å†ŒæˆåŠŸ"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(ip, <span class="string">"Node Exporter æ³¨å†Œå¤±è´¥"</span>)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># æ³¨å†Œcadvisor-exporter</span></span><br><span class="line">def register_container_exporter(ip,hostname,group):</span><br><span class="line">    container_data = {</span><br><span class="line">            <span class="string">"id"</span>: <span class="string">"cadvisor-exporter-{0}-{1}"</span>.format(hostname,ip),</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"cadvisor-exporter"</span>,</span><br><span class="line">            <span class="string">"address"</span>: ip,</span><br><span class="line">            <span class="string">"port"</span>: 9105,</span><br><span class="line">            <span class="string">"tags"</span>: [],</span><br><span class="line">            <span class="string">"meta"</span>: {</span><br><span class="line">                <span class="string">"hostname"</span>: hostname,</span><br><span class="line">            <span class="string">"group"</span>:<span class="built_in"> group</span></span><br><span class="line"><span class="built_in"></span>            },</span><br><span class="line">            <span class="string">"checks"</span>: [</span><br><span class="line">                {</span><br><span class="line">                <span class="string">"http"</span>: <span class="string">"http://{0}:9105/metrics"</span>.format(ip),</span><br><span class="line">                <span class="string">"interval"</span>: <span class="string">"5s"</span></span><br><span class="line">                }</span><br><span class="line">        ]</span><br><span class="line">    }</span><br><span class="line">    try:</span><br><span class="line">        r = requests.put(<span class="attribute">url</span>=consul_url, <span class="attribute">data</span>=json.dumps(container_data))</span><br><span class="line">        <span class="built_in">print</span>(r.status_code,r.content)</span><br><span class="line">        <span class="keyword">if</span> r.status_code == 200:</span><br><span class="line">            <span class="built_in">print</span>(ip, <span class="string">"Container Exporter æ³¨å†ŒæˆåŠŸ"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(ip, <span class="string">"Container Exporter æ³¨å†Œå¤±è´¥"</span>)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">def register():</span><br><span class="line">    with open(<span class="string">"server_list.txt"</span>,<span class="string">"r"</span>) as f:</span><br><span class="line">        lines = (f.readlines())</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> lines:</span><br><span class="line">           <span class="built_in"> ip </span>=  (str(data).split(<span class="string">"\t"</span>)[1].strip(<span class="string">"\n"</span>))</span><br><span class="line">           <span class="built_in"> group </span>=  (str(data).split(<span class="string">"\t"</span>)[2].strip(<span class="string">"\n"</span>))</span><br><span class="line">            hostname =  (str(data).split(<span class="string">"\t"</span>)[0])</span><br><span class="line">            register_node_exporter(<span class="attribute">ip</span>=ip,hostname=hostname,group=group)</span><br><span class="line">            register_container_exporter(<span class="attribute">ip</span>=ip,hostname=hostname,group=group)</span><br><span class="line"> </span><br><span class="line">register()</span><br><span class="line"> </span><br><span class="line">EOF</span><br><span class="line"> </span><br><span class="line"><span class="comment">### ä»¥ä¸Šéœ€è¦æå‰å‡†å¤‡å¥½ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡Œä¸€æ¡æ•°æ®é‡Œé¢æ ¼å¼å¦‚ä¸‹ï¼š</span></span><br><span class="line"> </span><br><span class="line">cat server_list.txt</span><br><span class="line">hostname1 192.168.18.21   IDE</span><br><span class="line">hostname2 192.168.18.22   IDE</span><br><span class="line">hostname3 192.168.18.31   IDE</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line"> </span><br><span class="line"><span class="comment"># è¿™é‡Œæ˜¯çº¿ä¸‹ç¯å¢ƒçš„ä¸€ä¸ªé…ç½®ï¼Œæ‰€ä»¥å•çº¯åªæ˜¯å°†ç¯å¢ƒä½œä¸ºåˆ†ç»„ï¼Œè¿™é‡Œå¯ä»¥è‡ªå®šä¹‰ï¼Œä½†æ˜¯ä¸èƒ½å°‘äº†æˆ–å¤šäº†å­—æ®µæ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œè„šæœ¬ï¼š</span></span><br><span class="line">python3 register_exporter_to_consul.py </span><br></pre></td></tr></tbody></table></figure><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p8.png"></p><p>æ‰§è¡Œä»¥ä¸Šè„šæœ¬ä»¥åå°±å¯ä»¥åœ¨consulä»¥åŠpromtheus webé¡µé¢è¿›è¡ŒæŸ¥çœ‹æ£€éªŒäº†ï¼š</p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p9.png"></p><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°å·²ç»æ³¨å†Œäº†54ä¸ªï¼Œä½†æ˜¯è¿™å…¶å®åªæ·»åŠ äº†27å°æœåŠ¡å™¨è€Œå·²ï¼Œå› ä¸ºæ¯å°æœåŠ¡å™¨ä¸Šé¢è¿è¡Œäº†ä¸¤ä¸ªexporter,ä¸€ä¸ªæ˜¯node-exporter,ä¸€ä¸ªæ˜¯cadvisor-exporterï¼Œ ä»–ä»¬æœ‰å„è‡ªçš„metrics URL ,æœ€åå†åˆ°prometheusæ£€æŸ¥æ˜¯å¦æ·»åŠ å³å¯ã€‚</p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p10.png"></p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p11.png"><br>ä»¥ä¸Šå¯ä»¥çœ‹åˆ° ï¼ŒæœåŠ¡æ•°é‡ã€exporteræ•°æ®è·å–æ­£å¸¸ã€‚</p><p>è‡³æ­¤ï¼Œconsulçš„éƒ¨ç½²ï¼ŒæœåŠ¡/å®ä¾‹çš„æ³¨å†Œï¼Œpromtheusçš„consul_sd_configsæœåŠ¡è‡ªåŠ¨å‘ç° ï¼Œæ•°æ®é‡‡é›†å·²ç»å®Œæˆï¼Œåç»­å°±æ˜¯å°†prometheus æ¥å…¥åˆ° grafanaï¼š</p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p12.png"></p><p>ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°é€šè¿‡è‡ªå®šä¹‰çš„labelè¿›è¡Œåˆ†ç»„</p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p13.png"></p><h2 id="å‘Šè­¦ç³»ç»Ÿæ¥å…¥"><a href="#å‘Šè­¦ç³»ç»Ÿæ¥å…¥" class="headerlink" title="å‘Šè­¦ç³»ç»Ÿæ¥å…¥"></a>å‘Šè­¦ç³»ç»Ÿæ¥å…¥</h2><p>å·²ç»å¯ä»¥çœ‹åˆ°å®¹å™¨&amp;å®¿ä¸»æœºçš„æ•°æ®å·²ç»æ­£å¸¸é‡‡é›†å¹¶ä¸”å·²ç»èƒ½å¤Ÿåœ¨grafané¢æ¿ä¸Šè¿›è¡Œå±•ç¤º</p><p>æŠ¥è­¦ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Alertmanager æ­é… Webhookæ¥å®ç°ï¼š</p><h3 id="alertmanageré…ç½®"><a href="#alertmanageré…ç½®" class="headerlink" title="alertmanageré…ç½®"></a>alertmanageré…ç½®</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span> alertmanager<span class="symbol">/config.yml</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">global:</span> <span class="comment"># å…¨å±€é…ç½®</span></span><br><span class="line">  <span class="params">resolve_timeout:</span> <span class="number">10</span>m <span class="comment"># è¶…æ—¶æ—¶é—´ é»˜è®¤10m</span></span><br><span class="line"><span class="params">inhibit_rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">source_match:</span>      <span class="comment">## æºæŠ¥è­¦è§„åˆ™</span></span><br><span class="line">      <span class="params">alertname:</span> 'critical'</span><br><span class="line">    <span class="params">target_match:</span></span><br><span class="line">      <span class="params">alertname:</span> 'warning'</span><br><span class="line">    <span class="params">equal:</span> ['alertname']  <span class="comment"># é€šè¿‡alertnameå»æŠ‘åˆ¶</span></span><br><span class="line"><span class="params">route:</span></span><br><span class="line">  <span class="params">receiver:</span> default-receiver</span><br><span class="line">  <span class="params">group_wait:</span> <span class="number">30</span>s</span><br><span class="line">  <span class="params">group_interval:</span> <span class="number">5</span>m</span><br><span class="line">  <span class="params">repeat_interval:</span> <span class="number">3</span>h</span><br><span class="line">  <span class="params">group_by:</span> ['alertname']</span><br><span class="line">  <span class="params">routes:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">receiver:</span> webhook-ide</span><br><span class="line">    <span class="params">matchers:</span></span><br><span class="line">    <span class="operator">-</span> group <span class="operator">=</span> IDE  <span class="comment"># é€šè¿‡prometehus alert rule æŸ¥è¯¢å‡ºæ¥çš„ç»“æœå¿…é¡»åŒ…å« groupå­—æ®µï¼Œå¦åˆ™è¯¥æ¡æŠ¥è­¦ä¸èƒ½å‘é€å‡ºæ¥</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">receiver:</span> webhook-stage</span><br><span class="line">    <span class="params">matchers:</span></span><br><span class="line">    <span class="operator">-</span> group <span class="operator">=</span> Stage</span><br><span class="line">  <span class="operator">-</span> <span class="params">receiver:</span> webhook-Pet</span><br><span class="line">    <span class="params">matchers:</span></span><br><span class="line">    <span class="operator">-</span> group <span class="operator">=</span> Pet</span><br><span class="line"><span class="params">receivers:</span></span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> default-receiver <span class="comment"># è¿™é‡Œä¸éœ€è¦è®¾ç½®ï¼Œéœ€è¦ç²¾ç¡®åŒ¹é…åˆ°æ¯ä¸€æ¡å‘Šè§„åˆ™ ï¼Œä½†æ˜¯è¿™é‡Œå¿…é¡»è¦å­˜åœ¨ï¼Œä¸Šé¢å¼ºè°ƒäº†å¿…é¡»è¦æœ‰ä¸€ä¸ªé»˜è®¤çš„receiver</span></span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> webhook-ide</span><br><span class="line">  <span class="params">webhook_configs:</span> <span class="comment"># webhookå‘Šè­¦é…ç½®</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">url:</span> 'http:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">18.178</span>:<span class="number">9060</span><span class="operator">/</span>dingtalk<span class="operator">/</span>webhook-ide<span class="operator">/</span>send'</span><br><span class="line">    <span class="params">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> webhook-stage</span><br><span class="line">  <span class="params">webhook_configs:</span> <span class="comment"># webhookå‘Šè­¦é…ç½®</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">url:</span> 'http:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">18.178</span>:<span class="number">9060</span><span class="operator">/</span>dingtalk<span class="operator">/</span>webhook-stage<span class="operator">/</span>send'</span><br><span class="line">    <span class="params">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> webhook-Pet</span><br><span class="line">  <span class="params">webhook_configs:</span> <span class="comment"># webhookå‘Šè­¦é…ç½®</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">url:</span> 'http:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">18.178</span>:<span class="number">9060</span><span class="operator">/</span>dingtalk<span class="operator">/</span>webhook-Pet<span class="operator">/</span>send'</span><br><span class="line">    <span class="params">send_resolved:</span> <span class="literal">true</span> </span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯æœåŠ¡åŠ è½½</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="dingding-webhooké…ç½®"><a href="#dingding-webhooké…ç½®" class="headerlink" title="dingding-webhooké…ç½®"></a>dingding-webhooké…ç½®</h3><p>è¿™é‡ŒæŒ‰ç…§ç¯å¢ƒè¿›è¡Œäº†åˆ†ç»„ï¼Œå°†ä¸åŒçš„å‘Šè­¦ä¿¡æ¯é€šè¿‡ç¯å¢ƒå‘é€åˆ°ä¸åŒçš„é’‰é’‰ç¾¤</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span> prometheus-dingding-webhook<span class="symbol">/config.yml</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="comment">## Request timeout</span></span><br><span class="line"><span class="comment"># timeout: 5s</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">## Uncomment following line in order to write template from scratch (be careful!)</span></span><br><span class="line"><span class="comment">#no_builtin_template: false</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">## Customizable templates path</span></span><br><span class="line"><span class="comment">#templates:</span></span><br><span class="line"><span class="comment">#     - /config/dingding.tmpl</span></span><br><span class="line"><span class="params">templates:</span></span><br><span class="line">  <span class="operator">-</span> <span class="symbol">/config/template.tmpl</span></span><br><span class="line"><span class="comment">## You can also override default template using `default_message`</span></span><br><span class="line"><span class="comment">## The following example to use the 'legacy' template from v0.3.0</span></span><br><span class="line"><span class="comment">#default_message:      </span></span><br><span class="line"><span class="comment">#  title: '{{ template "legacy.title" . }}'</span></span><br><span class="line"><span class="comment">#  text: '{{ template "legacy.content" . }}'</span></span><br><span class="line"><span class="comment">## Targets, previously was known as "profiles"</span></span><br><span class="line"><span class="comment">#    text: '{{ template "_dingtalk.link.content" . }}'</span></span><br><span class="line"><span class="params">targets:</span></span><br><span class="line"></span><br><span class="line">  <span class="params">webhook1:</span></span><br><span class="line">    <span class="params">url:</span> https:<span class="operator">//</span>oapi.dingtalk.com<span class="operator">/</span>robot<span class="operator">/</span>send<span class="operator">?</span>access_token<span class="operator">=</span><span class="number">92268</span>cd2c48db0ec2a10a753213dda6a11e4d54ea8fdbce356f217fa44925a7f</span><br><span class="line">    <span class="params">secret:</span> å¡«å†™ä½ çš„é’‰é’‰secret</span><br><span class="line">    </span><br><span class="line">  <span class="params">webhook-ide:</span></span><br><span class="line">    <span class="params">url:</span> https:<span class="operator">//</span>oapi.dingtalk.com<span class="operator">/</span>robot<span class="operator">/</span>send<span class="operator">?</span>access_token<span class="operator">=</span><span class="number">92268</span>cd2c48db0ec2a10a753213dda6a11e4d54ea8fdbce356f217fa44925a7f</span><br><span class="line">    <span class="params">secret:</span> å¡«å†™ä½ çš„é’‰é’‰secret</span><br><span class="line"> </span><br><span class="line">  <span class="params">webhook-stage:</span></span><br><span class="line">    <span class="params">url:</span> https:<span class="operator">//</span>oapi.dingtalk.com<span class="operator">/</span>robot<span class="operator">/</span>send<span class="operator">?</span>access_token<span class="operator">=</span><span class="number">9</span>d7172785d72f50ab335367bd7db8cb013073f62bd0fd7bfc9605020a6a4b95c</span><br><span class="line">    <span class="params">secret:</span> å¡«å†™ä½ çš„é’‰é’‰secret</span><br><span class="line"> </span><br><span class="line">  <span class="params">webhook-Pet:</span></span><br><span class="line">    <span class="params">url:</span> https:<span class="operator">//</span>oapi.dingtalk.com<span class="operator">/</span>robot<span class="operator">/</span>send<span class="operator">?</span>access_token<span class="operator">=</span><span class="number">89</span>b881f5798ec7cdff1538ecf3a7001dd30d19c7e5281e5e8329cb1e243b813e</span><br><span class="line">    <span class="params">secret:</span> ä½ çš„é’‰é’‰secret</span><br><span class="line">    </span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œè¿˜è‡ªå®šä¹‰äº†æŠ¥è­¦æ¨¡æ¿ï¼Œä¸Šè¿°æ–‡ä»¶ä¸­éœ€è¦å¼•å…¥ï¼š</p><figure class="highlight handlebars"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">cat &gt; dingding.tmpl &lt;&lt; EOF</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"__subject"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">[</span><span class="template-variable">{{ <span class="name">.Status</span> | toUpper }}</span><span class="template-variable">{{ <span class="name"><span class="built_in">if</span></span> eq .Status <span class="string">"firing"</span> }}</span><span class="language-xml">:</span><span class="template-variable">{{ <span class="name">.Alerts.Firing</span> | len }}</span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml">]</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"__alert_list"</span> }}</span><span class="template-variable">{{ <span class="name">range</span> . }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">---</span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦åç§°**: </span><span class="template-variable">{{ <span class="name">index</span> .Annotations <span class="string">"title"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦çº§åˆ«**: </span><span class="template-variable">{{ <span class="name">.Labels.severity</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦ä¸»æœºç»„**: </span><span class="template-variable">{{ <span class="name">.Labels.group</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦ä¸»æœº**: </span><span class="template-variable">{{ <span class="name">.Labels.instance</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å›¾è¡¨æ•°æ®**: [Click](</span><span class="template-variable">{{ <span class="name">.GeneratorURL</span> }}</span><span class="language-xml">)</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦ä¿¡æ¯**: </span><span class="template-variable">{{ <span class="name">index</span> .Annotations <span class="string">"description"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦æ—¶é—´**: </span><span class="template-variable">{{ <span class="name">dateInZone</span> <span class="string">"2006.01.02 15:04:05"</span> (<span class="name">.StartsAt</span>) <span class="string">"Asia/Shanghai"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**é¢„æ¡ˆé“¾æ¥**: [CONFæ–‡æ¡£](</span><span class="template-variable">{{ <span class="name">index</span> .Annotations <span class="string">"plan_url"</span> }}</span><span class="language-xml">)</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"__resolved_list"</span> }}</span><span class="template-variable">{{ <span class="name">range</span> . }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">---</span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦åç§°**: </span><span class="template-variable">{{ <span class="name">index</span> .Annotations <span class="string">"title"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦çº§åˆ«**: </span><span class="template-variable">{{ <span class="name">.Labels.severity</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦ä¸»æœº**: </span><span class="template-variable">{{ <span class="name">.Labels.instance</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å›¾è¡¨æ•°æ®**: [Click](</span><span class="template-variable">{{ <span class="name">.GeneratorURL</span> }}</span><span class="language-xml">)</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦ä¿¡æ¯**: </span><span class="template-variable">{{ <span class="name">index</span> .Annotations <span class="string">"description"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦æ—¶é—´**: </span><span class="template-variable">{{ <span class="name">dateInZone</span> <span class="string">"2006.01.02 15:04:05"</span> (<span class="name">.StartsAt</span>) <span class="string">"Asia/Shanghai"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**æ¢å¤æ—¶é—´**: </span><span class="template-variable">{{ <span class="name">dateInZone</span> <span class="string">"2006.01.02 15:04:05"</span> (<span class="name">.EndsAt</span>) <span class="string">"Asia/Shanghai"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"default.title"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"__subject"</span> . }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"default.content"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">if</span></span> gt (<span class="name">len</span> .Alerts.Firing) <span class="number">0</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**ğŸ’”ğŸ’”ğŸ’”ä¾¦æµ‹åˆ°</span><span class="template-variable">{{ <span class="name">.Alerts.Firing</span> | len  }}</span><span class="language-xml">ä¸ªå‘Šè­¦ğŸ’”ğŸ’”ğŸ’”**</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"__alert_list"</span> .Alerts.Firing }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">---</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">if</span></span> gt (<span class="name">len</span> .Alerts.Resolved) <span class="number">0</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**ğŸ’šğŸ’šğŸ’šæ¢å¤</span><span class="template-variable">{{ <span class="name">.Alerts.Resolved</span> | len  }}</span><span class="language-xml">ä¸ªå‘Šè­¦ğŸ’šğŸ’šğŸ’š**</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"__resolved_list"</span> .Alerts.Resolved }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"ding.link.title"</span> }}</span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"default.title"</span> . }}</span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"ding.link.content"</span> }}</span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"default.content"</span> . }}</span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"default.title"</span> . }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"default.content"</span> . }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">EOF</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ¨¡æ¿ä¸­æˆ‘ä»¬åŠ äº†è‡ªå®šä¹‰çš„ä¸€äº›è‡ªå·±æƒ³è¦çš„ä¸œè¥¿ï¼š</p><ul><li><p>éœ€è¦åœ¨å‘Šè­¦çš„æ—¶å€™åŠ ä¸Šé’ˆå¯¹æ¯ä¸ªå‘Šè­¦çš„æ—¥å¸¸å¤„ç†æ–¹å¼çš„ä¸€ä¸ªé¢„æ¡ˆï¼Œé‚£ä¹ˆè¿™ä¸ªå°±ç»™å‡ºä¸€ä¸ªæ–‡æ¡£çš„é“¾æ¥å°±è¡Œäº†ï¼Œæ—¥å¸¸è¿ç»´äººå‘˜çœ‹åˆ°å‘Šè­¦ä¹‹åï¼Œä¸€èˆ¬éƒ½ä¼šè¿›è¡Œä¸€ä¸ªæ•…éšœå¤„ç†è¿‡ç¨‹æˆ–è®°å½•å§ï¼Œè¿™æ ·èƒ½æ›´åŠ å‹å¥½ã€‚é‚£å¦‚ä½•å®šä¹‰ï¼Ÿ<br>é¦–å…ˆåœ¨å‘Šè­¦è§„åˆ™ä¸­å»å®šä¹‰å­—æ®µ,æ¯”å¦‚è¿™é‡Œæˆ‘æ·»åŠ äº†ä¸€ä¸ª <code>plan_url</code>:<br><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p15.png"><br>ç„¶åå†æ¨¡æ¿ä¸­å¼•ç”¨å³å¯.</p></li><li><p>Prometheusä¸­éœ€è¦å¼€å¯ å¤–éƒ¨url è®¿é—®ï¼Œå³åœ¨å¯åŠ¨çš„æ—¶å€™åŠ å…¥å‚æ•°<code>- '--web.external-url=http://192.168.18.178:9090'</code>, å¦åˆ™å‘Šè­¦æ¨¡æ¿ä¸­çš„ <code>.GeneratorURL </code>è¿™ä¸ªå€¼åº”ç”¨çš„æ˜¯prometheusçš„ä¸»æœºåï¼Œå³è¿è¡Œprometheusçš„é‚£ä¸ªå®¹å™¨çš„ä¸»æœºåï¼Œé‚£æ ·è®¿é—®æ˜¯è®¿é—®ä¸åˆ°çš„ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹</p></li></ul><p>å¦å¤–åœ¨éƒ¨ç½²prometheus æˆ‘ä»¬è¿˜éƒ¨ç½²äº†ä¸€ä¸ªå®¹å™¨ä¸Šæ˜¯githubä¸Šæœ‰äººå¼€æºäº†ä¸€ä¸ªæ¥å…¥alertmanager api çš„æ–¹å¼è·å–æŠ¥è­¦å†…å®¹å¹¶è¿›è¡Œå±•ç¤ºã€‚æ¯”èµ·alertmanagerè¿™ä¸ªç»„ä»¶è‡ªèº«çš„é‚£ä¸ªuiæ›´åŠ å¥½ç”¨ã€‚å‡ºå¤„ï¼š(<a href="https://github.com/prymitive/karma%EF%BC%89">https://github.com/prymitive/karmaï¼‰</a></p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p17.png"></p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p18.png"></p><p>è‡³æ­¤æ•´ä¸ªç›‘æ§ç³»ç»Ÿå°±æ­å»ºå®Œæ¯•ï¼Œè¿˜æ˜¯æœ‰æ¯”è¾ƒç»†èŠ‚çš„åœ°æ–¹éœ€è¦å¤„ç†æ¯”å¦‚å‘Šè­¦è§„åˆ™ã€å‘Šè­¦é¢‘ç‡è¿™äº›éœ€è¦å»ä¼˜åŒ–ã€‚</p><hr><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/111.jpeg"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Consul </tag>
            
            <tag> Alertmanager </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºå®¹å™¨åŒ–éƒ¨ç½²Nacosé›†ç¾¤</title>
      <link href="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/"/>
      <url>/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€æ­å»ºæ¶æ„"><a href="#ä¸€ã€æ­å»ºæ¶æ„" class="headerlink" title="ä¸€ã€æ­å»ºæ¶æ„"></a>ä¸€ã€æ­å»ºæ¶æ„</h1><p><img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/arch-1.png"><br>â— 3ä¸ªæˆ–3ä¸ªä»¥ä¸ŠNacosèŠ‚ç‚¹æ‰èƒ½æ„æˆé›†ç¾¤ï¼›<br>â— Nacos Nginx Proxyç”¨äºä»£ç†è½¬å‘ï¼›</p><hr><h1 id="äºŒã€å‡†å¤‡å·¥ä½œ"><a href="#äºŒã€å‡†å¤‡å·¥ä½œ" class="headerlink" title="äºŒã€å‡†å¤‡å·¥ä½œ"></a>äºŒã€å‡†å¤‡å·¥ä½œ</h1><p><em><strong>Nacos2.0ç‰ˆæœ¬ç›¸æ¯”1.Xæ–°å¢äº†gRPCçš„é€šä¿¡æ–¹å¼ï¼Œå› æ­¤éœ€è¦å¢åŠ 2ä¸ªç«¯å£ã€‚æ–°å¢ç«¯å£æ˜¯åœ¨é…ç½®çš„ä¸»ç«¯å£(server.port)åŸºç¡€ä¸Šï¼Œè¿›è¡Œä¸€å®šåç§»é‡è‡ªåŠ¨ç”Ÿæˆã€‚</strong></em></p><table><thead><tr><th>ç«¯å£</th><th>ä¸ä¸»ç«¯å£çš„åç§»é‡</th><th>æè¿°</th></tr></thead><tbody><tr><td>8848</td><td>0</td><td>Nacosç¨‹åºä¸»é…ç½®ç«¯å£</td></tr><tr><td>9848</td><td>+1000</td><td>å®¢æˆ·ç«¯gRPCè¯·æ±‚æœåŠ¡ç«¯ç«¯å£ï¼Œç”¨äºå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥å’Œè¯·æ±‚</td></tr><tr><td>9849</td><td>+1001</td><td>æœåŠ¡ç«¯gRPCè¯·æ±‚æœåŠ¡ç«¯ç«¯å£ï¼Œç”¨äºæœåŠ¡é—´åŒæ­¥ç­‰</td></tr><tr><td>7848</td><td>-1000</td><td>Nacos é›†ç¾¤é€šä¿¡ç«¯å£ï¼Œç”¨äºNacos é›†ç¾¤é—´è¿›è¡Œé€‰ä¸¾ï¼Œæ£€æµ‹ç­‰</td></tr></tbody></table><p><em><strong>ä½¿ç”¨VIP/nginxè¯·æ±‚æ—¶ï¼Œéœ€è¦é…ç½®æˆTCPè½¬å‘ï¼Œä¸èƒ½é…ç½®http2è½¬å‘ï¼Œå¦åˆ™è¿æ¥ä¼šè¢«nginxæ–­å¼€</strong></em><br><img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/arch-2.png"></p><p>æŒ‰ç…§ä¸Šè¿°å®˜æ–¹çš„ç«¯å£åˆ†é…è¦æ±‚ ï¼Œæ­¤å¤„éƒ¨ç½²çš„ä½¿ç”¨ä¸‰å°æœåŠ¡å™¨ä¸Šé¢åˆ›å»ºçš„Nacosé›†ç¾¤ç«¯å£åˆ†é…å¦‚ä¸‹ï¼š</p><table><thead><tr><th>èŠ‚ç‚¹</th><th>IP</th><th>ç«¯å£ï¼ˆæ‰€éœ€æš´éœ²ï¼‰</th><th>å¤‡æ³¨</th><th>ç‰ˆæœ¬</th><th>å½“å‰çº¿ä¸‹ç¯å¢ƒéƒ¨ç½²æ–‡ä»¶è·¯å¾„</th></tr></thead><tbody><tr><td>Nacos_1</td><td>192168.18.73</td><td>å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858  å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858</td><td>Nacos èŠ‚ç‚¹ä¸€</td><td>nacos/nacos-server:2.0.2</td><td>/root/nacos-deploy/</td></tr><tr><td>Nacos_2</td><td>192168.18.74</td><td>å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858  å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858</td><td>Nacos èŠ‚ç‚¹äºŒ</td><td>nacos/nacos-server:2.0.2</td><td>/root/nacos-deploy/</td></tr><tr><td>Nacos_3</td><td>192168.18.75</td><td>å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858  å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858</td><td>Nacos èŠ‚ç‚¹ä¸‰</td><td>nacos/nacos-server:2.0.2</td><td>/root/nacos-deploy/</td></tr><tr><td>Nacos DB</td><td>192168.18.75</td><td>å®¿ä¸»æœºï¼š3306 å®¹å™¨ï¼š3306</td><td>Nacosæ‰€éœ€æ•°æ®åº“</td><td>mysql:5.7.34</td><td>/root/nacos-mysql-deploy</td></tr><tr><td>Nacos  Nginx Proxy</td><td>192168.18.75</td><td>å®¿ä¸»æœºï¼š80  å®¹å™¨ï¼š80</td><td>Nacosä»£ç†</td><td>nginx:stable-alpine</td><td>/root/nacos-proxy-deploy</td></tr></tbody></table><h2 id="2-1-åˆ›å»ºNacosæ•°æ®åº“"><a href="#2-1-åˆ›å»ºNacosæ•°æ®åº“" class="headerlink" title="2.1  åˆ›å»ºNacosæ•°æ®åº“"></a>2.1  åˆ›å»ºNacosæ•°æ®åº“</h2><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯å®¹å™¨åŒ–è¿è¡Œnacosï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå¹¶ä»å®˜æ–¹å¯¹åº”çš„ç‰ˆæœ¬ä¸­å»å¯¼å…¥åŸºæœ¬æ•°æ®åº“ç»“æ„çš„æ•°æ®æ–‡ä»¶</p><h2 id="2-1-1-è·å–nacos-2-0-2-åŒ…æ–‡ä»¶ä¸­çš„åŸºç¡€è¡¨ç»“æ„æ•°æ®"><a href="#2-1-1-è·å–nacos-2-0-2-åŒ…æ–‡ä»¶ä¸­çš„åŸºç¡€è¡¨ç»“æ„æ•°æ®" class="headerlink" title="2.1.1 è·å–nacos 2.0.2 åŒ…æ–‡ä»¶ä¸­çš„åŸºç¡€è¡¨ç»“æ„æ•°æ®"></a>2.1.1 è·å–nacos 2.0.2 åŒ…æ–‡ä»¶ä¸­çš„åŸºç¡€è¡¨ç»“æ„æ•°æ®</h2><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/alibaba/nacos/releases/download/<span class="number">2.0</span><span class="number">.2</span>/nacos-<span class="keyword">server</span><span class="number">-2.0</span><span class="number">.2</span>.tar.gz</span><br><span class="line"></span><br><span class="line"># tar -xf nacos-<span class="keyword">server</span><span class="number">-2.0</span><span class="number">.2</span>.tar.gz</span><br><span class="line"># cd  nacos</span><br><span class="line"># tree -L <span class="number">2</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚   â”œâ”€â”€ shutdown.cmd</span><br><span class="line">â”‚   â”œâ”€â”€ shutdown.sh</span><br><span class="line">â”‚   â”œâ”€â”€ startup.cmd</span><br><span class="line">â”‚   â””â”€â”€ startup.sh</span><br><span class="line">â”œâ”€â”€ conf</span><br><span class="line">â”‚   â”œâ”€â”€ <span class="number">1.4</span><span class="number">.0</span>-ipv6_support-<span class="keyword">update</span>.<span class="keyword">sql</span></span><br><span class="line">â”‚   â”œâ”€â”€ application.properties</span><br><span class="line">â”‚   â”œâ”€â”€ application.properties.example</span><br><span class="line">â”‚   â”œâ”€â”€ <span class="keyword">cluster</span>.conf.example</span><br><span class="line">â”‚   â”œâ”€â”€ nacos-logback.xml</span><br><span class="line">â”‚   â”œâ”€â”€ nacos-mysql.<span class="keyword">sql</span></span><br><span class="line">â”‚   â””â”€â”€ <span class="keyword">schema</span>.<span class="keyword">sql</span></span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ <span class="keyword">NOTICE</span></span><br><span class="line">â””â”€â”€ target</span><br><span class="line">    â””â”€â”€ nacos-<span class="keyword">server</span>.jar</span><br><span class="line">ä»¥ä¸Šæ˜¯nacosçš„äºŒè¿›åˆ¶åŒ…æ–‡ä»¶ ï¼Œè¿™é‡Œåªç”¨åˆ°äº† nacos-mysql.<span class="keyword">sql</span>  è¿™ä¸ªæ–‡ä»¶</span><br></pre></td></tr></tbody></table></figure><h2 id="2-1-2-åˆ›å»ºmysqlæœåŠ¡"><a href="#2-1-2-åˆ›å»ºmysqlæœåŠ¡" class="headerlink" title="2.1.2 åˆ›å»ºmysqlæœåŠ¡"></a>2.1.2 åˆ›å»ºmysqlæœåŠ¡</h2><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.18.75</span></span><br><span class="line">sudo <span class="operator">-</span>i </span><br><span class="line">mkdir <span class="symbol">/data/mysql</span></span><br><span class="line">cat <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF <span class="operator">&gt;</span> <span class="symbol">/root/nacos-mysql-deploy/mysql.yaml</span></span><br><span class="line"><span class="params">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="params">services:</span></span><br><span class="line">  <span class="params">mysql-db:</span></span><br><span class="line">    <span class="params">container_name:</span> nacos-mysql</span><br><span class="line">    <span class="params">image:</span> mysql:<span class="number">5.7</span>.<span class="number">34</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"3306:3306"</span></span><br><span class="line">    <span class="params">environment:</span></span><br><span class="line">      <span class="params">MYSQL_ROOT_PASSWORD:</span> xxxxxxxxxxxx</span><br><span class="line">    <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"/data/mysql:/var/lib/mysql"</span></span><br><span class="line">    <span class="params">restart:</span> always</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">docker-compose <span class="operator">-</span>f  <span class="symbol">/root/nacos-mysql-deploy/mysql.yaml</span> up <span class="operator">-</span>d</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥å®˜æ–¹è¡¨æ•°æ®</span></span><br><span class="line">docker cp <span class="symbol">/root/nacos/conf/nacos-mysql.sql</span> nacos-mysql:<span class="symbol">/tmp</span></span><br><span class="line"></span><br><span class="line">docker exec <span class="operator">-</span>it nacos-mysql sh</span><br><span class="line"></span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>pxxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line">create database nacos;</span><br><span class="line"></span><br><span class="line">use nacos;</span><br><span class="line"></span><br><span class="line">source <span class="symbol">/tmp/nacos-mysql.sql</span>;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="2-2-NaocsæœåŠ¡"><a href="#2-2-NaocsæœåŠ¡" class="headerlink" title="2.2  NaocsæœåŠ¡"></a>2.2  NaocsæœåŠ¡</h2><h2 id="2-2-1-åˆ›å»ºã€ç¼–å†™yamlæ–‡ä»¶"><a href="#2-2-1-åˆ›å»ºã€ç¼–å†™yamlæ–‡ä»¶" class="headerlink" title="2.2.1 åˆ›å»ºã€ç¼–å†™yamlæ–‡ä»¶"></a>2.2.1 åˆ›å»ºã€ç¼–å†™yamlæ–‡ä»¶</h2><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">sudo -i</span><br><span class="line">mkdir /data/nacos2.0.2_1/logs -p</span><br><span class="line">mkdir /root/nacos-deploy/</span><br><span class="line">cat &lt;&lt; EOF &gt; /root/nacos-deploy/nacos1.yaml</span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line">  nacos1:</span><br><span class="line">    hostname: nacos2.0.2_1</span><br><span class="line">    container_name: nacos2.0.2_1</span><br><span class="line">    image: nacos/nacos-server:2.0.2</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/nacos2.0.2_1/logs:/home/nacos/logs</span><br><span class="line">      - /data/nacos2.0.2_1/custom.properties:/home/nacos/init.d/custom.properties</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8858:8858"</span></span><br><span class="line">      - <span class="string">"9858:9858"</span></span><br><span class="line">      - <span class="string">"9859:9859"</span></span><br><span class="line">      - <span class="string">"7858:7858"</span></span><br><span class="line">    environment:</span><br><span class="line">      - <span class="attribute">MODE</span>=cluster</span><br><span class="line">      - <span class="attribute">PREFER_HOST_MODE</span>=hostname</span><br><span class="line">      - <span class="attribute">NACOS_SERVER_IP</span>=192.168.18.73</span><br><span class="line">      - <span class="attribute">NACOS_APPLICATION_PORT</span>=8858</span><br><span class="line">      - <span class="attribute">NACOS_SERVERS</span>=192.168.18.73:8858 192.168.18.74:8858 192.168.18.75:8858</span><br><span class="line">      - <span class="attribute">SPRING_DATASOURCE_PLATFORM</span>=mysql</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_HOST</span>=192.168.18.75</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_DB_NAME</span>=nacos</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PORT</span>=3306</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_USER</span>=root</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PASSWORD</span>=xxxxxxxxxxx</span><br><span class="line">      - <span class="attribute">NACOS_AUTH_ENABLE</span>=<span class="literal">true</span></span><br><span class="line">      - <span class="attribute">MYSQL_DATABASE_NUM</span>=1</span><br><span class="line">    restart: always</span><br><span class="line">EOF</span><br><span class="line"><span class="comment">######################</span></span><br><span class="line">sudo -i</span><br><span class="line">mkdir /data/nacos2.0.2_2/logs -p</span><br><span class="line">mkdir /root/nacos-deploy/</span><br><span class="line">cat &lt;&lt; EOF &gt; /root/nacos-deploy/nacos2.yaml</span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line">  nacos2:</span><br><span class="line">    hostname: nacos2.0.2_2</span><br><span class="line">    container_name: nacos2.0.2_2</span><br><span class="line">    image: nacos/nacos-server:2.0.2</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/nacos2.0.2_2/logs:/home/nacos/logs</span><br><span class="line">      - /data/nacos2.0.2_2/custom.properties:/home/nacos/init.d/custom.properties</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8858:8858"</span></span><br><span class="line">      - <span class="string">"9858:9858"</span></span><br><span class="line">      - <span class="string">"9859:9859"</span></span><br><span class="line">      - <span class="string">"7858:7858"</span></span><br><span class="line">    environment:</span><br><span class="line">      - <span class="attribute">MODE</span>=cluster</span><br><span class="line">      - <span class="attribute">PREFER_HOST_MODE</span>=hostname</span><br><span class="line">      - <span class="attribute">NACOS_SERVER_IP</span>=192.168.18.74</span><br><span class="line">      - <span class="attribute">NACOS_APPLICATION_PORT</span>=8858</span><br><span class="line">      - <span class="attribute">NACOS_SERVERS</span>=192.168.18.73:8858 192.168.18.74:8858 192.168.18.75:8858</span><br><span class="line">      - <span class="attribute">SPRING_DATASOURCE_PLATFORM</span>=mysql</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_HOST</span>=192.168.18.75</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_DB_NAME</span>=nacos</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PORT</span>=3306</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_USER</span>=root</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PASSWORD</span>=xxxxxxxxxxx</span><br><span class="line">      - <span class="attribute">NACOS_AUTH_ENABLE</span>=<span class="literal">true</span></span><br><span class="line">      - <span class="attribute">MYSQL_DATABASE_NUM</span>=1</span><br><span class="line">    restart: always</span><br><span class="line">EOF</span><br><span class="line"><span class="comment">######################</span></span><br><span class="line">sudo -i</span><br><span class="line">mkdir /data/nacos2.0.2_3/logs -p</span><br><span class="line">mkdir /root/nacos-deploy/</span><br><span class="line">cat &lt;&lt; EOF &gt; /root/nacos-deploy/nacos3.yaml</span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line">  nacos3:</span><br><span class="line">    hostname: nacos2.0.2_3</span><br><span class="line">    container_name: nacos2.0.2_3</span><br><span class="line">    image: nacos/nacos-server:2.0.2</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/nacos2.0.2_3/logs:/home/nacos/logs</span><br><span class="line">      - /data/nacos2.0.2_3/custom.properties:/home/nacos/init.d/custom.properties</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8858:8858"</span></span><br><span class="line">      - <span class="string">"9858:9858"</span></span><br><span class="line">      - <span class="string">"9859:9859"</span></span><br><span class="line">      - <span class="string">"7858:7858"</span></span><br><span class="line">    environment:</span><br><span class="line">      - <span class="attribute">MODE</span>=cluster</span><br><span class="line">      - <span class="attribute">PREFER_HOST_MODE</span>=hostname</span><br><span class="line">      - <span class="attribute">NACOS_SERVER_IP</span>=192.168.18.75</span><br><span class="line">      - <span class="attribute">NACOS_APPLICATION_PORT</span>=8858</span><br><span class="line">      - <span class="attribute">NACOS_SERVERS</span>=192.168.18.73:8858 192.168.18.74:8858 192.168.18.75:8858</span><br><span class="line">      - <span class="attribute">SPRING_DATASOURCE_PLATFORM</span>=mysql</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_HOST</span>=192.168.18.75</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_DB_NAME</span>=nacos</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PORT</span>=3306</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_USER</span>=root</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PASSWORD</span>=xxxxxxxxxxx</span><br><span class="line">      - <span class="attribute">NACOS_AUTH_ENABLE</span>=<span class="literal">true</span></span><br><span class="line">      - <span class="attribute">MYSQL_DATABASE_NUM</span>=1</span><br><span class="line">    restart: always</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Š å„é…ç½®ä¸­çš„ç«¯å£éæ ‡å‡†ç«¯å£ï¼Œéœ€è¦æ³¨æ„ç¯å¢ƒå˜é‡ NACOS_APPLICATION_PORT  å¦‚æœä¸æŒ‡å®šä¸ºéç‰¹å®šç«¯å£ï¼Œé‚£ä¹ˆç¼ºçœåœ¨é…ç½®ä¸­çš„ç¯å¢ƒå˜é‡åˆ™ä¸º 8848 ï¼Œåœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œä¸‰ä¸ªèŠ‚ç‚¹ä¼šå‡ºç°é—®é¢˜ï¼</p><h2 id="2-2-2-è¿è¡ŒNacos"><a href="#2-2-2-è¿è¡ŒNacos" class="headerlink" title="2.2.2 è¿è¡ŒNacos"></a>2.2.2 è¿è¡ŒNacos</h2><p>å„èŠ‚ç‚¹è¿è¡Œå³å¯</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.18.73</span></span><br><span class="line">docker-compose -f <span class="regexp">/root/</span>nacos-deploy/nacos1.yaml up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.18.74</span></span><br><span class="line">docker-compose -f <span class="regexp">/root/</span>nacos-deploy/nacos2.yaml up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.18.75</span></span><br><span class="line">docker-compose -f <span class="regexp">/root/</span>nacos-deploy/nacos3.yaml up -d</span><br></pre></td></tr></tbody></table></figure><p><img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/3.png"></p><p>ä¸Šå›¾ ä¸‰ä¸ªèŠ‚ç‚¹å•ç‹¬è®¿é—®é¡µé¢æ­£å¸¸ï¼›é€šè¿‡ä»£ç†è®¿é—®æ­£å¸¸ï¼›</p><p>æ³¨æ„ï¼šwebé¡µé¢å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯gRPCè°ƒç”¨æœåŠ¡ï¼Œä½†æ˜¯åœ¨ç¨‹åºä¸­éœ€è¦è¯·æ±‚å¯¹åº”çš„ç«¯å£ï¼Œæ‰€ä»¥åŠ¡å¿…éœ€è¦æš´éœ²å‡ºæ¥ï¼Œå› ä¸ºä½¿ç”¨äº†éæ ‡å‡†ç«¯å£ï¼Œé‚£ä¹ˆåœ¨nginxåšä»£ç†æ—¶å°±ç›´æ¥(ä¼ªè£…)æ˜ å°„æˆæ ‡å‡†ç«¯å£å³å¯ã€‚</p><h2 id="2-3-Nginxä»£ç†é…ç½®"><a href="#2-3-Nginxä»£ç†é…ç½®" class="headerlink" title="2.3 Nginxä»£ç†é…ç½®"></a>2.3 Nginxä»£ç†é…ç½®</h2><p>æ­¤å¤„ä»ç„¶ä½¿ç”¨å®¹å™¨åŒ–æ–¹å¼è¿è¡Œã€‚<br>é…ç½®nginxä»£ç†</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/nacos-proxy-deploy</span><br><span class="line">cd /root/nacos-proxy-deploy</span><br><span class="line">cat &lt;&lt;EOF &gt; nginx.conf  </span><br><span class="line"><span class="keyword">user</span>  nginx;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"> </span><br><span class="line">error_log  /var/<span class="keyword">log</span>/nginx/error.<span class="keyword">log</span> <span class="keyword">notice</span>;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">events {</span><br><span class="line">    worker_connections  <span class="number">65535</span>;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">stream {</span><br><span class="line">    upstream nacos-<span class="keyword">server</span>-grpc9848 {</span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.73</span>:<span class="number">9858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.74</span>:<span class="number">9858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.75</span>:<span class="number">9858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s</span><br><span class="line">     }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">server</span> {</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">9848</span>;</span><br><span class="line">        proxy_pass nacos-<span class="keyword">server</span>-grpc9848;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    upstream nacos-<span class="keyword">server</span>-grpc9849 {</span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.73</span>:<span class="number">9859</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.74</span>:<span class="number">9859</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;      </span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.75</span>:<span class="number">9859</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">     }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">server</span> {</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">9849</span>;</span><br><span class="line">        proxy_pass nacos-<span class="keyword">server</span>-grpc9849;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">http {</span><br><span class="line">    <span class="keyword">include</span>       /etc/nginx/mime.<span class="keyword">types</span>;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"> </span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"> </span><br><span class="line">    access_log  /var/<span class="keyword">log</span>/nginx/<span class="keyword">access</span>.<span class="keyword">log</span>  main;</span><br><span class="line"> </span><br><span class="line">    sendfile        <span class="keyword">on</span>;</span><br><span class="line">    #tcp_nopush     <span class="keyword">on</span>;</span><br><span class="line"> </span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"> </span><br><span class="line">    #gzip  <span class="keyword">on</span>;</span><br><span class="line"> </span><br><span class="line">    upstream NACOS {</span><br><span class="line">      <span class="keyword">server</span>  <span class="number">192.168</span><span class="number">.18</span><span class="number">.73</span>:<span class="number">8858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">      <span class="keyword">server</span>  <span class="number">192.168</span><span class="number">.18</span><span class="number">.74</span>:<span class="number">8858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">      <span class="keyword">server</span>  <span class="number">192.168</span><span class="number">.18</span><span class="number">.75</span>:<span class="number">8858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">   }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">server</span> {</span><br><span class="line">      <span class="keyword">listen</span>       <span class="number">8848</span> default_server;</span><br><span class="line">      server_name  _;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">location</span> / {</span><br><span class="line">        proxy_pass http://NACOS;</span><br><span class="line">      }</span><br><span class="line"> </span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">include</span> /etc/nginx/conf.d<span class="comment">/*.conf;</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment">EOF</span></span><br></pre></td></tr></tbody></table></figure><p>ä»£ç†å®¹å™¨yamlæ–‡ä»¶ç¼–å†™</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">nacos-nginx-proxy.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span>  </span><br><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nacos_proxy:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos_nginx_proxy</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"nginx:stable-alpine"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">80:</span> <span class="number">8848</span>  <span class="comment">#è¿™é‡Œå®šä¹‰ä¸€ä¸ª80æ˜¯ä¸ºäº†å‰ç«¯è®¿é—®ï¼Œæˆ–å®¢æˆ·ç«¯é…ç½®å®šä¹‰æ—¶æ— éœ€å†åŠ ç«¯å£ï¼Œä¸€ä¸ªipæˆ–è€…åŸŸåå³å¯</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8848</span><span class="string">:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9848</span><span class="string">:9848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9849</span><span class="string">:9849</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/root/nacos-proxy-deploy/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¹å™¨è¿è¡Œ</span></span><br><span class="line"><span class="string">docker-compose</span> <span class="string">-f</span> <span class="string">nacos-proxy.yaml</span> <span class="string">up</span> <span class="string">-d</span></span><br></pre></td></tr></tbody></table></figure><p><img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/4.png"><br>è‡³æ­¤æ­å»ºå®Œæ¯•ï¼Œä½†æ˜¯å®¹å™¨è¿è¡Œæ­£å¸¸ä¸ä¸€å®šæœåŠ¡å°±æ˜¯æ­£å¸¸ï¼Œè¿™æ—¶éœ€è¦æµ‹è¯•å®ä¾‹æœåŠ¡æ³¨å†Œæ˜¯å¦æ­£å¸¸</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; nacos_check_status.py &lt;&lt; EOF</span><br><span class="line"><span class="comment"># author: maoqiu.guo</span></span><br><span class="line"><span class="comment"># desc: NacosæœåŠ¡æ³¨å†ŒåŠŸèƒ½æµ‹è¯•ã€çŠ¶æ€ç›‘æ§</span></span><br><span class="line"><span class="comment"># dateï¼š2022-06-11</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> logging.handlers <span class="keyword">import</span> RotatingFileHandler</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line"><span class="comment"># åˆ›å»ºæ—¥å¿—è®°å½•å™¨ï¼ŒæŒ‡æ˜æ—¥å¿—ä¿å­˜çš„è·¯å¾„ï¼Œæ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å€¼ï¼Œä¿å­˜çš„æ—¥å¿—æ–‡ä»¶ä¸ªæ•°ä¸Šé™</span></span><br><span class="line">log_handle = RotatingFileHandler(<span class="string">'./log.txt'</span>, maxBytes=<span class="number">1024</span>*<span class="number">1024</span>, backupCount=<span class="number">5</span>)</span><br><span class="line"><span class="comment"># åˆ›å»ºæ—¥å¿—è®°å½•çš„æ ¼å¼</span></span><br><span class="line">formatter = logging.Formatter(<span class="string">"format = '%(asctime)s - %(name)s - %(levelname)s - %(message)s-%(funcName)s',"</span>)</span><br><span class="line"><span class="comment"># ä¸ºåˆ›å»ºçš„æ—¥å¿—è®°å½•å™¨è®¾ç½®æ—¥å¿—è®°å½•æ ¼å¼</span></span><br><span class="line">log_handle.setFormatter(formatter)</span><br><span class="line"><span class="comment"># ä¸ºå…¨å±€çš„æ—¥å¿—å·¥å…·å¯¹è±¡æ·»åŠ æ—¥å¿—è®°å½•å™¨</span></span><br><span class="line">logging.getLogger().addHandler(log_handle)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›åº¦æ¡</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">progress_bar</span>(<span class="params">timmer</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">101</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\r"</span>, end=<span class="string">""</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Waiting: {}%: "</span>.<span class="built_in">format</span>(i), <span class="string">"â–‹"</span> * (i // <span class="number">2</span>), end=<span class="string">""</span>)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        time.sleep(timmer)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Nacos</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.webhookurl=<span class="string">"https://oapi.dingtalk.com/robot/send?access_token=1968dd11647dfd686c4e1107cf1ad3d0d21c3813a824ee632728327722d9fa82"</span></span><br><span class="line">        <span class="variable language_">self</span>.login_url = <span class="string">"/nacos/v1/auth/users/login"</span></span><br><span class="line">        <span class="variable language_">self</span>.accessToken=<span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.service_url =  <span class="string">"/nacos/v1/ns/catalog/services"</span></span><br><span class="line">        <span class="variable language_">self</span>.instance_url = <span class="string">"/nacos/v1/ns/instance"</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dingding</span>(<span class="params">self, content</span>):</span><br><span class="line">         </span><br><span class="line">        data = {</span><br><span class="line">            <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"text"</span>: {</span><br><span class="line">                <span class="string">"content"</span>: <span class="string">"Nacos-"</span> + content,</span><br><span class="line">            },</span><br><span class="line">        }</span><br><span class="line">        headers = {<span class="string">'Content-Type'</span>: <span class="string">'application/json;charset=utf-8'</span>}</span><br><span class="line">        response = requests.post(<span class="variable language_">self</span>.webhookurl, data=json.dumps(data), headers=headers)</span><br><span class="line">        <span class="built_in">print</span>(response.content)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_access_token</span>(<span class="params">self, nacos_server</span>):</span><br><span class="line">        logging.info(<span class="string">"\n\n************** NacosServer: {0} **************"</span>.<span class="built_in">format</span>(nacos_server))</span><br><span class="line">        <span class="string">"ç™»å½•è·å–nacos accessToken"</span></span><br><span class="line">        params= <span class="string">"username=nacos&amp;password=nacos"</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = json.loads(requests.post(params=params, url=<span class="string">"http://"</span> + nacos_server + <span class="variable language_">self</span>.login_url, timeout=<span class="number">5</span>).text)</span><br><span class="line">            accessToken = <span class="built_in">str</span>((r[<span class="string">'accessToken'</span>]))</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">"accessToken"</span>: accessToken, <span class="string">"result"</span>: <span class="literal">True</span>, <span class="string">"server"</span>: nacos_server, <span class="string">"msg"</span>: <span class="string">"Login Nacos Success...[{0}]"</span>.<span class="built_in">format</span>(nacos_server)}</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">"accessToken"</span>: <span class="literal">None</span>, <span class="string">"result"</span>: <span class="literal">False</span>, <span class="string">"server"</span>: nacos_server, <span class="string">"msg"</span>: <span class="string">"Login Nacos Falied...[{0}] Error: {1}"</span>.<span class="built_in">format</span>(nacos_server, <span class="built_in">str</span>(e))}</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_test</span>(<span class="params">self, accessToken, nacos_server</span>):</span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        1. åˆ›å»ºå®ä¾‹</span></span><br><span class="line"><span class="string">        2. æ³¨å†ŒæœåŠ¡</span></span><br><span class="line"><span class="string">        3. åˆ é™¤å®ä¾‹</span></span><br><span class="line"><span class="string">        4. åˆ é™¤æœåŠ¡</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        data={</span><br><span class="line">            <span class="string">"serviceName"</span>: <span class="string">"test_service_instance"</span>,</span><br><span class="line">            <span class="string">"namespaceId"</span>: <span class="string">"public"</span>,</span><br><span class="line">            <span class="string">"accessToken"</span>: accessToken,</span><br><span class="line">            <span class="string">"ip"</span>: nacos_server.split(<span class="string">":"</span>)[<span class="number">0</span>],</span><br><span class="line">            <span class="string">"port"</span>: nacos_server.split(<span class="string">":"</span>)[<span class="number">1</span>],</span><br><span class="line">            <span class="string">"ephemeral"</span>: <span class="literal">False</span></span><br><span class="line">        }</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># åˆ›å»ºæœåŠ¡(æ³¨å†Œå®ä¾‹)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = (requests.post(params=data, url=<span class="string">"http://"</span> + nacos_server + <span class="variable language_">self</span>.instance_url, timeout=<span class="number">5</span>).text)</span><br><span class="line">            <span class="keyword">if</span> r == <span class="string">"ok"</span>:</span><br><span class="line">                msg = <span class="string">"[æ³¨å†Œå®ä¾‹&amp;åˆ›å»ºæœåŠ¡æˆåŠŸ] Service: {0} NameSpace: {1} {2} InstanceIP: {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, data[<span class="string">'ip'</span>])</span><br><span class="line">                logging.info(msg)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                msg = <span class="string">"[æ³¨å†Œå®ä¾‹&amp;åˆ›å»ºæœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                msg = <span class="string">"[æ³¨å†Œå®ä¾‹&amp;åˆ›å»ºæœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">            </span><br><span class="line">    <span class="comment"># åˆ é™¤å®ä¾‹</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_instance_service</span>(<span class="params">self, accessToken, nacos_server</span>):</span><br><span class="line">        data={</span><br><span class="line">            <span class="string">"serviceName"</span>: <span class="string">"test_service_instance"</span>,</span><br><span class="line">            <span class="string">"namespaceId"</span>: <span class="string">"public"</span>,</span><br><span class="line">            <span class="string">"accessToken"</span>: accessToken,</span><br><span class="line">            <span class="string">"ip"</span>: nacos_server.split(<span class="string">":"</span>)[<span class="number">0</span>],</span><br><span class="line">            <span class="string">"port"</span>: nacos_server.split(<span class="string">":"</span>)[<span class="number">1</span>],</span><br><span class="line">            <span class="string">"ephemeral"</span>: <span class="literal">False</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment"># æ³¨é”€å®ä¾‹</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = (requests.delete(params=data, url=<span class="string">"http://"</span> + nacos_server + <span class="variable language_">self</span>.instance_url, timeout=<span class="number">5</span>).text)           </span><br><span class="line">            <span class="keyword">if</span> r == <span class="string">"ok"</span>:</span><br><span class="line">                msg = <span class="string">"[æ³¨é”€å®ä¾‹æˆåŠŸ] Service: {0} NameSpace: {1} {2} "</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server)</span><br><span class="line">                logging.info(msg)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                msg = <span class="string">"[æ³¨é”€å®ä¾‹å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                msg = <span class="string">"[æ³¨é”€å®ä¾‹å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line"> </span><br><span class="line">        progress_bar(timmer=<span class="number">0.08</span>)</span><br><span class="line">        <span class="comment"># åˆ é™¤æœåŠ¡</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = (requests.delete(params=data, url=<span class="string">"http://"</span> + nacos_server + <span class="string">"/nacos/v1/ns/service"</span>, timeout=<span class="number">5</span>).text)</span><br><span class="line">            <span class="keyword">if</span> r == <span class="string">"ok"</span>:</span><br><span class="line">                msg = <span class="string">"[åˆ é™¤æœåŠ¡æˆåŠŸ] Service: {0} NameSpace: {1} {2} "</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server)</span><br><span class="line">                logging.info(msg)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                msg = <span class="string">"[åˆ é™¤æœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                msg = <span class="string">"[åˆ é™¤æœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">        progress_bar(timmer=<span class="number">0.1</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_service_list</span>(<span class="params">self, accessToken, nacos_server</span>):</span><br><span class="line">        <span class="string">"è¯·æ±‚è®¿é—®æŸä¸ªç¯å¢ƒçš„æŸä¸€ä¸ªæœåŠ¡åˆ—è¡¨, æ£€æŸ¥è¿”å›æ•°æ®æ˜¯å¦ä¸ºç©º,ä¸ºç©ºåˆ™ä¸ºä¸æ­£å¸¸"</span></span><br><span class="line">        payload={</span><br><span class="line">            <span class="string">"accessToken"</span>: accessToken,</span><br><span class="line">            <span class="string">"pageNo"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">"pageSize"</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="string">"namespaceId"</span>: <span class="string">"stage"</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = json.loads(requests.get(params=payload, url=<span class="string">"http://"</span> + nacos_server + <span class="variable language_">self</span>.service_url).text)</span><br><span class="line">            <span class="keyword">if</span> r[<span class="string">'count'</span>] == <span class="number">0</span>:</span><br><span class="line">                msg = <span class="string">"[è·å–æ³¨å†ŒæœåŠ¡æ•°æ®å¤±è´¥] Nacos Server {0} å½“å‰StageæœåŠ¡åˆ—è¡¨ä¸ºç©º!"</span>.<span class="built_in">format</span>(nacos_server)</span><br><span class="line">                logging.info(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># print("Nacos æ³¨å†ŒæœåŠ¡æ•°æ®æ­£å¸¸...[{0}]".format(nacos_server))</span></span><br><span class="line">                logging.info(<span class="string">"[è·å–æ³¨å†ŒæœåŠ¡æ•°æ®æˆåŠŸ] ServiceTotal {1} on {0} - SercieName: stage "</span>.<span class="built_in">format</span>(nacos_server,r[<span class="string">'count'</span>]))</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">letsgo</span>(<span class="params">self, nacos_server</span>):</span><br><span class="line">        <span class="comment"># ç™»å½•è·å–token</span></span><br><span class="line">        login_nacos_res = (<span class="variable language_">self</span>.get_access_token(nacos_server))</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span> login_nacos_res[<span class="string">"result"</span>]:</span><br><span class="line">            logging.info(<span class="string">"[ç™»å½•è·å–accessToken æˆåŠŸ] Nacos Server {0} "</span>.<span class="built_in">format</span>((login_nacos_res[<span class="string">'server'</span>])))</span><br><span class="line"> </span><br><span class="line">            <span class="variable language_">self</span>.get_service_list(login_nacos_res[<span class="string">'accessToken'</span>], login_nacos_res[<span class="string">'server'</span>] )</span><br><span class="line"> </span><br><span class="line">            <span class="comment"># åˆ›å»ºå®ä¾‹&amp;æœåŠ¡</span></span><br><span class="line">            <span class="variable language_">self</span>.register_test(login_nacos_res[<span class="string">'accessToken'</span>], login_nacos_res[<span class="string">'server'</span>] )</span><br><span class="line"> </span><br><span class="line">            <span class="comment">#time.sleep(60 * 2)</span></span><br><span class="line">            progress_bar(timmer=<span class="number">0.1</span>)</span><br><span class="line">            <span class="variable language_">self</span>.delete_instance_service(login_nacos_res[<span class="string">'accessToken'</span>], login_nacos_res[<span class="string">'server'</span>] )</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = <span class="string">"[ç™»å½•è·å–accessToken å¤±è´¥] {0} "</span>.<span class="built_in">format</span>((login_nacos_res[<span class="string">'msg'</span>]))</span><br><span class="line">            logging.info(msg)</span><br><span class="line">            <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        nacos_server_list=[</span><br><span class="line">        <span class="comment">#"nacos.axiba.com",</span></span><br><span class="line">            <span class="string">"192.168.18.75:80"</span>,</span><br><span class="line">            <span class="string">"192.168.18.75:8848"</span>,</span><br><span class="line">            <span class="string">"192.168.18.73:8858"</span>,</span><br><span class="line">            <span class="string">"192.168.18.74:8858"</span>,</span><br><span class="line">            <span class="string">"192.168.18.75:8858"</span>,</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nacos_server_list:</span><br><span class="line">            Nacos().letsgo(i)</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>è¿è¡Œåï¼š</p><p>ä»¥ä¸Šè„šæœ¬é€šè¿‡Nacosçš„OpenApiå¾ªç¯å¼é€šè¿‡ä»æ¯ä¸ªèŠ‚ç‚¹è®¿é—®åå‘èµ·ä»¥åŠé€šè¿‡Nginxä»£ç†å‘èµ·æœåŠ¡å®ä¾‹çš„æŸ¥è¯¢ã€æ³¨å†Œã€åˆ é™¤æ“ä½œã€‚<br><img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/5.png"></p><ol><li>ç™»å½•è·å–AccessToke(æ¯ä¸ªè¯·æ±‚éœ€è¦æºå¸¦)</li><li>åœ¨ è·å–stageç¯å¢ƒçš„æœåŠ¡åˆ—è¡¨æ•°æ®ï¼Œè¿™æ˜¯ä¸ºäº†ç›‘æµ‹è¿”å›æ•°æ®æ˜¯å¦æ­£å¸¸ï¼Œå› ä¸ºè¿™é‡Œåˆšæ­å»ºèµ·æ¥ï¼Œå¦‚æœé‡Œé¢æœåŠ¡æ•°æ®ä¸æ­£å¸¸åˆ™ä¼šå‡ºç°ä¸Šé¢æç¤ºï¼Œå¹¶å‘é€æ¶ˆæ¯åˆ°é’‰é’‰ï¼›</li></ol><p> <img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/6.png">  </p><p>ä¸Šå›¾æ˜¯é€šè¿‡ä»£ç†è®¿é—®è·å–stageä¸­çš„æœåŠ¡ä¸º0ï¼Œåå‘é€é€šçŸ¥ï¼Œè¯´æ˜æ­¤æ—¶å¯èƒ½(å› ä¸ºé€šè¿‡è´Ÿè½½å¹¶ä¸çŸ¥é“è¯¥è¯·æ±‚æ˜¯è½åœ¨äº†å“ªä¸€ä¸ªNacosèŠ‚ç‚¹)é›†ç¾¤ä¸­æŸä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœæ•°æ®ä¸æ­£å¸¸äº†ï¼Œä½†æ˜¯åœ¨æ£€æµ‹è„šæœ¬ä¸­ä¼šé€šè¿‡æ¯ä¸ªèŠ‚ç‚¹å»æ³¨å†Œï¼Œé‚£ä¹ˆä¸€å®šä¼šåœ¨å‡ºç°é€šçŸ¥æŸä¸ªèŠ‚ç‚¹æ•…éšœã€‚<br>4. åœ¨publicç¯å¢ƒä¸­é€šè¿‡è°ƒç”¨OpenApiæ–¹å¼åˆ›å»ºã€æ³¨å†Œä¸€ä¸ªå®ä¾‹ test_service_instance è·ŸæœåŠ¡ï¼Œç„¶åæ³¨é”€å®ä¾‹ï¼Œå¹¶åˆ é™¤æœåŠ¡ï¼Œè¿™æ˜¯ä¸ºäº†ç›‘æµ‹é›†ç¾¤æ˜¯å¦æ­£å¸¸ã€‚</p><h1 id="ä¸‰ã€å°è®°"><a href="#ä¸‰ã€å°è®°" class="headerlink" title="ä¸‰ã€å°è®°"></a>ä¸‰ã€å°è®°</h1><ol><li>è™½ç„¶æ–‡æ¡£ç»™å‡ºçš„æè¿°æ˜¯åªæœ‰å½“æœåŠ¡ä¸‹å®ä¾‹æ•°ä¸º0æ—¶å…è®¸åˆ é™¤ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶æ²¡æœ‰å¼ºåˆ¶æ£€æŸ¥æ ¡éªŒæœåŠ¡ä¸‹çš„å®ä¾‹æ•°æ˜¯å¦ä¸º0ã€‚Nacosçš„æœåŠ¡åˆ›å»ºæœ‰å¤šç§æ–¹å¼ï¼Œå¯ä»¥ä¸»åŠ¨åˆ›å»ºå¯ä»¥åœ¨æ³¨å†Œå®ä¾‹çš„æ—¶å€™åˆ›å»ºï¼Œå¯ä»¥åœ¨å®ä¾‹å‘é€å¿ƒè·³æ—¶åˆ›å»ºï¼Œæ‰€ä»¥å“ªæ€•ä¸»åŠ¨åˆ é™¤äº†è¿˜ä¼šè‡ªåŠ¨åˆ›å»ºå›æ¥ã€‚ï¼›</li><li>æ‰€æœ‰å·²æ³¨å†ŒæœåŠ¡åœ¨å®¹å™¨é‡å¯åä¼šä¸¢å¤±ï¼Œä½†æ˜¯åªè¦ä¿è¯é›†ç¾¤ä¸­æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ­£å¸¸ï¼Œé‚£ä¹ˆé‡å¯åçš„æœåŠ¡æ•°æ®ä¼šåŒæ­¥å…¶ä»–æ­£å¸¸èŠ‚ç‚¹çš„ï¼Œå³éœ€è¦å®¢æˆ·ç«¯é‡æ–°æ³¨å†Œï¼›</li><li>æ­£å¸¸æƒ…å†µåœ¨æŸä¸ªèŠ‚ç‚¹æ³¨å†Œäº†æœåŠ¡åä¼šåŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚</li><li>å„èŠ‚ç‚¹æ— æ³•é€‰ä¸¾ä¸€ä¸ªleaderæ—¶ æŸ¥çœ‹æ—¥å¿—ï¼š/data/nacos2.0.2_1/logs/alipay-jraft.log</li><li>å®ä¾‹æœåŠ¡ç›¸å…³æ—¥å¿—:  /data/nacos2.0.2_1/naming-raft.log</li><li>é€šè¿‡æ—¥å¿—å‘ç°ï¼Œæš´éœ²8848ç«¯å£æ˜¯ä¸ºäº†nacoså®¢æˆ·ç«¯ç™»é™†è·å–Tokenï¼Œåç»­æ“ä½œéƒ½ä¼šæºå¸¦Tokenè¿›è¡Œèµ„æºæ“ä½œï¼›ç„¶åæš´éœ²9848ç«¯å£æ˜¯å®¢æˆ·ç«¯ç”¨äºgRPCçš„è¯·æ±‚ï¼Œæ‰€ä»¥å¦‚æœæ˜¯è®¾ç½®äº†ä»£ç†è½¬å‘ï¼ŒåŠ¡å¿…å°†å…¶æš´éœ²ï¼Œå¦åˆ™è¿æ¥å¤±è´¥å¤±è´¥ã€‚</li></ol><h1 id="å››ã€åæ§½"><a href="#å››ã€åæ§½" class="headerlink" title="å››ã€åæ§½"></a>å››ã€åæ§½</h1><p>Nacos å®˜æ–¹ä¸ºäº†æ¨å•†ä¸šç‰ˆï¼Œç¤¾åŒºç‰ˆå‡ ä¹æ¯›ç—…ç™¾å‡ºï¼Œä¸ç®¡ä¸é¡¾ï¼Œæ–‡æ¡£ä¹Ÿæ˜¯å†™å¾—ä¸€å›¢ç³Ÿ~ æ— åŠ›åæ§½</p><p> <img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/7.jpg">  </p>]]></content>
      
      
      <categories>
          
          <category> åŸºç¡€ç»„ä»¶ </category>
          
          <category> éƒ¨ç½² </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nacos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¿ç»´å·¥ä½œä¸­è‡ªåŠ¨åŒ–å·¡æ£€çš„å¿…è¦æ€§ä»¥åŠé‡è¦æ€§</title>
      <link href="/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/"/>
      <url>/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€"><a href="#ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€" class="headerlink" title="ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€"></a>ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€</h1><ol><li>å½“å‰å¹³å°æ¶æ„å¤æ‚ï¼Œä¸­é—´ä»¶ç¹å¤šï¼Œç»„ä»¶ä¹‹é—´è€¦åˆåº¦é«˜ï¼Œå¾®æœåŠ¡è¿˜æœªè¾¾åˆ°æ•…éšœè‡ªæ„ˆæ°´å¹³ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å‘Šè­¦æˆ–å·¡æ£€ç­‰æ‰‹æ®µå‘ç°é—®é¢˜æ¥ä¿éšœå¹³å°æŒç»­ç¨³å®šè¿è¡Œã€‚</li><li>å½“å‰æœ‰å®¢æˆ·å¯¹å¹³å°åŠä¸Šå±‚åº”ç”¨ä½¿ç”¨é¢‘ç‡ä½ï¼Œä¾‹å¦‚ä¸‰å››å¤©ç™»å½•æŸ¥çœ‹ä¸€æ¬¡æ•°æ®ï¼Œä½†æ˜¯è®¾å¤‡æ˜¯æ­£å¸¸è¿è½¬çš„ï¼Œä¸€æ—¦å¹³å°å‡ºç°é—®é¢˜ï¼Œåˆšå¥½å®¢æˆ·å‘ç°é—®é¢˜ï¼Œè¿ç»´ æ‰å»è§£å†³å°±ä¸ºæ—¶å·²æ™šã€‚</li><li>å®šæœŸå·¡æ£€æ–¹æ¡ˆæ˜¯æ¨¡æ‹Ÿäººå·¥ç™»å½•å„ä¸šåŠ¡é¡µé¢ï¼Œè€Œéæ¥å£è°ƒç”¨ï¼Œæ›´èƒ½çœŸå®åœ°å‘ç°é—®é¢˜ï¼Œå¹¶é€šè¿‡æˆªå›¾çœŸå®ä¿ç•™å¹³å°è¿è¡ŒçŠ¶æ€ã€‚</li><li>Prometheuså¹³å°çš„ç›‘æ§æŠ¥è­¦åŠŸèƒ½è¿˜æœªè¦†ç›–åˆ°æ•´ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œéƒ¨åˆ†é—®é¢˜è¿˜æœªèƒ½å®æ—¶ç›‘æ§åˆ°ï¼Œå¯¼è‡´å¹³å°å‡ºç°å¼‚å¸¸åè€Œæ— æ³•æ„ŸçŸ¥ã€‚</li><li>å½“å‰å¹¶ä¸èƒ½ä¿è¯å®¢æˆ·ç¯å¢ƒçš„Prometheuså¹³å°æœ¬èº«ä¸å­˜åœ¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ç§ä¸ç¡®å®šæ€§ï¼Œå®šæœŸå·¡æ£€æ˜¯ä¸€ä¸ªä¿éšœå¹³å°ç¨³å®šæ€§çš„æ–¹æ¡ˆï¼Œå®ç°å¹³å°åŒä¿éšœã€‚</li><li>éƒ¨åˆ†å®¢æˆ·ç¯å¢ƒä¸èƒ½å¤Ÿè¿æ¥å¤–ç½‘ï¼ŒPrometheusçš„ç›‘æ§å‘Šè­¦ä¿¡æ¯æ— æ³•åŒæ­¥åˆ°å¾®ä¿¡ã€é£ä¹¦ç­‰ï¼Œä½†å¯ä»¥é€šè¿‡å®šæœŸå·¡æ£€æ–¹æ¡ˆæ¥ä¿éšœå¹³å°ç¨³å®šè¿è¡Œã€‚</li></ol><p>ç”±äºä»¥ä¸ŠåŸå› ï¼Œä¸ºäº†ä¿è¯SLAï¼Œå¿…é¡»è¿›è¡Œå®šæœŸå·¡æ£€ã€‚</p><h1 id="äºŒã€å·¡æ£€æ£€æŸ¥é¡¹"><a href="#äºŒã€å·¡æ£€æ£€æŸ¥é¡¹" class="headerlink" title="äºŒã€å·¡æ£€æ£€æŸ¥é¡¹"></a>äºŒã€å·¡æ£€æ£€æŸ¥é¡¹</h1><h2 id="2-1-æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯"><a href="#2-1-æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯" class="headerlink" title="2.1  æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯"></a>2.1  æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯</h2><pre><code>cpu åˆ©ç”¨ç‡ç£ç›˜åˆ©ç”¨ç‡å†…å­˜åˆ©ç”¨ç‡æœåŠ¡å™¨æ—¶é—´åŒæ­¥æ—¥å¸¸æ•°æ®å¤‡ä»½æ–‡ä»¶æ£€æŸ¥</code></pre><h2 id="2-2-k8sé›†ç¾¤çŠ¶æ€"><a href="#2-2-k8sé›†ç¾¤çŠ¶æ€" class="headerlink" title="2.2  k8sé›†ç¾¤çŠ¶æ€"></a>2.2  k8sé›†ç¾¤çŠ¶æ€</h2><pre><code>è¯ä¹¦è¿‡æœŸæ£€æŸ¥APIé€šä¿¡æ˜¯å¦æ­£å¸¸å„åç§°ç©ºé—´ä¸‹çš„podè¿è¡ŒçŠ¶æ€cephå…±äº«å­˜å‚¨æ˜¯å¦æ­£å¸¸</code></pre><h2 id="2-3-ä¸šåŠ¡çŠ¶æ€"><a href="#2-3-ä¸šåŠ¡çŠ¶æ€" class="headerlink" title="2.3  ä¸šåŠ¡çŠ¶æ€"></a>2.3  ä¸šåŠ¡çŠ¶æ€</h2><pre><code>ä¸šåŠ¡å¹³å°ç™»å½•æ˜¯å¦æ­£å¸¸kafkaæ˜¯å¦ç§¯å‹kafkaæ¶ˆè´¹é€Ÿç‡</code></pre><h1 id="ä¸‰ã€å®ç°æ–¹å¼"><a href="#ä¸‰ã€å®ç°æ–¹å¼" class="headerlink" title="ä¸‰ã€å®ç°æ–¹å¼"></a>ä¸‰ã€å®ç°æ–¹å¼</h1><p><strong>å‰æœŸ</strong>ï¼šå‰æœŸå·¡æ£€åŒäº‹ç™»å½•å„å®¢æˆ·ç¯å¢ƒè¿›è¡Œäººå·¥æ‰‹åŠ¨å·¡æ£€(ç™»å½•VPNã€è¿æ¥è·³æ¿æœºã€ç™»å½•ä¸šåŠ¡å¹³å°ã€ç™»å½•grafanaå¹³å°ç­‰ç­‰)ä¸€äº›åˆ—æ“ä½œä¸‹æ¥ï¼Œä¸€è½®å·¡æ£€å·¥ä½œå¤§çº¦åœ¨2-3hoursã€‚</p><p><strong>ç›®å‰</strong>ï¼šé€šè¿‡è‡ªåŠ¨åŒ–çš„æ–¹å¼(shell+python+webæ¡†æ¶flask)å®ç°äº†ï¼Œäººå·¥åœ¨windowsè·³æ¿æœºä¸Šã€LinuxæœåŠ¡å™¨ä¸­çš„æ¨¡æ‹Ÿäººå·¥æ“ä½œè¿æ¥VPNã€ç™»å½•ä¸šåŠ¡å¹³å°ã€ç™»å½•grafanaå¹³å°ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œå®šæœŸå®šæ—¶å°†å·¡æ£€ä»»åŠ¡ç»“æœå‘é€è‡³ä¼ä¸šå¾®ä¿¡ç¾¤å†…ï¼›ä»å•äººå•æ¬¡å·¡æ£€çš„2-3å°æ—¶ï¼Œç›´æ¥ææ•ˆåˆ°äº†5-10minï¼Œæå¤§ç¨‹åº¦ä¸Šæé«˜äº†æ—¥å¸¸å·¡æ£€çš„å·¥ä½œæ•ˆç‡ã€‚<br><img src="/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/1.png"><br><img src="/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/2.png"></p><p><img src="/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/3.png"></p><p>é‚£ä¹ˆï¼Œåœ¨å®¢æˆ·ç¯å¢ƒæ•°é‡è¾¾åˆ°ä¸€å®šä½“é‡æ—¶ï¼Œç¾¤æ¶ˆæ¯æ¥æ”¶ä¹Ÿä¼šé€ æˆå·¡æ£€é—æ¼çš„æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹éœ€è¦ä¸€ä¸ªé›†ä¸­åŒ–çš„å¹³å°ä½œä¸ºå±•ç¤ºï¼Œäºæ˜¯å°†å·¡æ£€ç»“æœå‘é€åˆ°ç¾¤å†…çš„åŒæ—¶ä¹Ÿä¼šå°†æ¶ˆæ¯æ ¼å¼åŒ–(æ³¨ï¼šå›¾ç‰‡æ˜¯é€šè¿‡Pythonæˆªå›¾ç”Ÿæˆåå°†å…¶è½¬æ¢ä¸ºbase64ç¼–ç ï¼Œç„¶åå°†å…¶ä»–å·¡æ£€ç»“æœå†…å®¹æ ¼å¼åŒ–ä¸ºjsonåpoståˆ°webåç«¯ï¼Œå†åœ¨webå‰ç«¯è¿›è¡Œå±•ç¤º)</p><p><img src="/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/4.png"></p><p>Detail: é€šè¿‡ç‚¹å‡»åå¼¹å‡ºæ•´ä¸ªå·¡æ£€è¿‡ç¨‹ä»¥åŠç»“æœä¿¡æ¯ï¼›</p><p>Screenshoot: é€šè¿‡ç‚¹å‡»åå°†ä¼šå¼¹å‡ºbase64ç¼–ç è½¬æ¢ä¸ºå›¾ç‰‡çš„ä¸šåŠ¡å¹³å°åŠgrafanaæˆªå›¾</p><p>æœ€åï¼Œå·¡æ£€äººå‘˜åªéœ€è¦å®šæœŸæµè§ˆæ­¤æ±‡æ€»å±•ç¤ºå¹³å°å³å¯ï¼</p><p>(äººå·¥æ“ä½œæ˜¯åŸºç¡€ï¼Œè‡ªåŠ¨åŒ–æ“ä½œæ‰æ˜¯ç‹é“ğŸ˜€ )</p><h3 id="æŠ€æœ¯ç‚¹"><a href="#æŠ€æœ¯ç‚¹" class="headerlink" title="æŠ€æœ¯ç‚¹"></a>æŠ€æœ¯ç‚¹</h3><ul><li>Pythonè‡ªåŠ¨åŒ–</li><li>Seleniumçˆ¬è™«æŠ€æœ¯(ç½‘é¡µå†…å®¹è·å–)</li><li>Windowsç«¯UIè‡ªåŠ¨åŒ–(ç”¨äºè‡ªåŠ¨å¯åŠ¨VPNç¨‹åºï¼Œå¹¶å¡«å†™è´¦å·å¯†ç åè¿›è¡Œç™»å½•æ“ä½œ)</li><li>Flaskå‰åç«¯å¼€å‘(å¹³å°å±•ç¤ºï¼Œå†…å®¹æ¥æ”¶å…¥åº“)</li><li>ä¼ä¸šå¾®ä¿¡æœºå™¨äººWebhooké›†æˆ</li></ul>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è‡ªåŠ¨åŒ–è¿ç»´ </tag>
            
            <tag> Python </tag>
            
            <tag> Flask </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•è®©æ·»åŠ å®šæ—¶ä½œä¸šä»»åŠ¡å˜å¾—æ›´åŠ ä¼˜é›…</title>
      <link href="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/"/>
      <url>/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/</url>
      
        <content type="html"><![CDATA[<p> <img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/info.png"></p><h1 id="åº-APSCheduler-ç®€ä»‹"><a href="#åº-APSCheduler-ç®€ä»‹" class="headerlink" title="åº APSCheduler ç®€ä»‹"></a>åº APSCheduler ç®€ä»‹</h1><p>åœ¨å¹³å¸¸çš„å·¥ä½œä¸­æœ‰äº›å·¥ä½œéƒ½éœ€è¦å®šæ—¶ä»»åŠ¡æ¥æ¨åŠ¨ï¼Œä¾‹å¦‚é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªå®šæ—¶åˆ·æ–°æ’è¡Œæ¦œçš„ç¨‹åºè„šæœ¬ã€å®šæ—¶çˆ¬å‡ºç½‘ç«™çš„URLç¨‹åºã€å®šæ—¶æ£€æµ‹é’“é±¼ç½‘ç«™çš„ç¨‹åºç­‰ç­‰ï¼Œéƒ½æ¶‰åŠåˆ°äº†å…³äºå®šæ—¶ä»»åŠ¡çš„é—®é¢˜ï¼›è™½ç„¶è¿™äº›å®šæ—¶ä»»åŠ¡åœ¨æœåŠ¡å™¨ä¸Šé¢éƒ½èƒ½é€šè¿‡crontabæ¥åšï¼›å…¶æ¬¡æƒ³åˆ°çš„æ˜¯åˆ©ç”¨timeæ¨¡å—çš„time.sleep()æ–¹æ³•ä½¿ç¨‹åºä¼‘çœ æ¥è¾¾åˆ°å®šæ—¶ä»»åŠ¡çš„ç›®çš„ï¼Œè™½ç„¶å‰ä¸¤è€…ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æ€»è§‰å¾—ä¸æ˜¯é‚£ä¹ˆçš„ä¸“ä¸šï¼ŒğŸ˜æ‰€ä»¥å°±æ‰¾åˆ°äº†pythonçš„å®šæ—¶ä»»åŠ¡æ¨¡å—APScheduler;</p><p><strong>APScheduleråŸºäºQuartzçš„ä¸€ä¸ªPythonå®šæ—¶ä»»åŠ¡æ¡†æ¶ï¼Œå®ç°äº†Quartzçš„æ‰€æœ‰åŠŸèƒ½ï¼Œä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ã€‚æä¾›äº†åŸºäºæ—¥æœŸã€å›ºå®šæ—¶é—´é—´éš”ä»¥åŠcrontabç±»å‹çš„ä»»åŠ¡ï¼Œå¹¶ä¸”å¯ä»¥æŒä¹…åŒ–ä»»åŠ¡ã€‚åŸºäºè¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ä¸€ä¸ªpythonå®šæ—¶ä»»åŠ¡ç³»ç»Ÿã€‚</strong></p><p>åŒæ—¶APSchedulerè¿˜æä¾›äº†Flaskçš„æ‰©å±•<code>Flask-Apscheduler</code>, é‚£æ­£å¥½å°±å¯ä»¥æ‹¿æ¥åšä¸€ä¸ªé›†æˆå®šæ—¶ä»»åŠ¡å¹³å°;</p><p><img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/liuchengtu.png" alt="APSchedulerå·¥ä½œåŸç†"></p><h1 id="APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†"><a href="#APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†" class="headerlink" title="APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†"></a>APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†</h1><ol><li><p><code>è§¦å‘å™¨(trigger)</code>åŒ…å«è°ƒåº¦é€»è¾‘ï¼Œæ¯ä¸€ä¸ªä½œä¸šæœ‰å®ƒè‡ªå·±çš„è§¦å‘å™¨ï¼Œç”¨äºå†³å®šæ¥ä¸‹æ¥å“ªä¸€ä¸ªä½œä¸šä¼šè¿è¡Œã€‚é™¤äº†ä»–ä»¬è‡ªå·±åˆå§‹é…ç½®æ„å¤–ï¼Œè§¦å‘å™¨å®Œå…¨æ˜¯æ— çŠ¶æ€çš„ã€‚</p> <figure class="highlight livecodeserver"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cron: ç±»linuxä¸‹çš„crontabæ ¼å¼,å±äºå®šæ—¶è°ƒåº¦</span><br><span class="line">interval:æ¯éš”å¤šä¹…è°ƒåº¦ä¸€æ¬¡</span><br><span class="line"><span class="built_in">date</span>:ä¸€æ¬¡æ€§è°ƒåº¦</span><br><span class="line"></span><br><span class="line"><span class="comment">#1. croné£æ ¼</span></span><br><span class="line">(int|str) è¡¨ç¤ºå‚æ•°æ—¢å¯ä»¥æ˜¯intç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯strç±»å‹</span><br><span class="line">(datetime | str) è¡¨ç¤ºå‚æ•°æ—¢å¯ä»¥æ˜¯datetimeç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯strç±»å‹</span><br><span class="line">year (int|str) â€“ <span class="number">4</span>-digit year -ï¼ˆè¡¨ç¤ºå››ä½æ•°çš„å¹´ä»½ï¼Œå¦‚<span class="number">2008</span>å¹´ï¼‰</span><br><span class="line">month (int|str) â€“ month (<span class="number">1</span><span class="number">-12</span>) -ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º<span class="number">1</span><span class="number">-12</span>æœˆï¼‰</span><br><span class="line">day (int|str) â€“ day <span class="keyword">of</span> <span class="keyword">the</span> (<span class="number">1</span><span class="number">-31</span>) -ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º<span class="number">1</span><span class="number">-31</span>æ—¥ï¼‰</span><br><span class="line">week (int|str) â€“ ISO week (<span class="number">1</span><span class="number">-53</span>) -ï¼ˆæ ¼é‡Œå†<span class="number">2006</span>å¹´<span class="number">12</span>æœˆ<span class="number">31</span>æ—¥å¯ä»¥å†™æˆ<span class="number">2006</span>å¹´-W52<span class="number">-7</span>ï¼ˆæ‰©å±•å½¢å¼ï¼‰æˆ–<span class="number">2006</span>W527ï¼ˆç´§å‡‘å½¢å¼ï¼‰ï¼‰</span><br><span class="line">day_of_week (int|str) â€“ <span class="built_in">number</span> <span class="keyword">or</span> name <span class="keyword">of</span> weekday (<span class="number">0</span><span class="number">-6</span> <span class="keyword">or</span> mon,tue,wed,thu,fri,sat,sun) - ï¼ˆè¡¨ç¤ºä¸€å‘¨ä¸­çš„ç¬¬å‡ å¤©ï¼Œæ—¢å¯ä»¥ç”¨<span class="number">0</span><span class="number">-6</span>è¡¨ç¤ºä¹Ÿå¯ä»¥ç”¨å…¶è‹±è¯­ç¼©å†™è¡¨ç¤ºï¼‰</span><br><span class="line">hour (int|str) â€“ hour (<span class="number">0</span><span class="number">-23</span>) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º<span class="number">0</span><span class="number">-23</span>æ—¶ï¼‰</span><br><span class="line">minute (int|str) â€“ minute (<span class="number">0</span><span class="number">-59</span>) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º<span class="number">0</span><span class="number">-59</span>åˆ†ï¼‰</span><br><span class="line"><span class="keyword">second</span> (int|str) â€“ <span class="keyword">second</span> (<span class="number">0</span><span class="number">-59</span>) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º<span class="number">0</span><span class="number">-59</span>ç§’ï¼‰</span><br><span class="line">start_date (datetime|str) â€“ earliest possible <span class="built_in">date</span>/<span class="built_in">time</span> <span class="built_in">to</span> trigger <span class="keyword">on</span> (<span class="title">inclusive</span>) - ï¼ˆè¡¨ç¤ºå¼€å§‹æ—¶é—´ï¼‰</span><br><span class="line">end_date (datetime|str) â€“ latest possible <span class="built_in">date</span>/<span class="built_in">time</span> <span class="built_in">to</span> trigger <span class="keyword">on</span> (<span class="title">inclusive</span>) - ï¼ˆè¡¨ç¤ºç»“æŸæ—¶é—´ï¼‰</span><br><span class="line">timezone (datetime.tzinfo|str) â€“ <span class="built_in">time</span> zone <span class="built_in">to</span> use <span class="keyword">for</span> <span class="keyword">the</span> <span class="built_in">date</span>/<span class="built_in">time</span> calculations (defaults <span class="built_in">to</span> scheduler timezone) -ï¼ˆè¡¨ç¤ºæ—¶åŒºå–å€¼ï¼‰</span><br><span class="line"><span class="comment">#å¦‚:åœ¨6,7,8,11,12æœˆä»½çš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”çš„00:00,01:00,02:00,03:00 æ‰§è¡Œè¯¥ç¨‹åº</span></span><br><span class="line">sched.add_job(my_job, <span class="string">'cron'</span>, month=<span class="string">'6-8,11-12'</span>, day=<span class="string">'3rd fri'</span>, hour=<span class="string">'0-3'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.intervalé£æ ¼</span></span><br><span class="line">weeks (int) â€“ <span class="built_in">number</span> <span class="keyword">of</span> weeks <span class="built_in">to</span> <span class="built_in">wait</span></span><br><span class="line">days (int) â€“ <span class="built_in">number</span> <span class="keyword">of</span> days <span class="built_in">to</span> <span class="built_in">wait</span></span><br><span class="line">hours (int) â€“ <span class="built_in">number</span> <span class="keyword">of</span> hours <span class="built_in">to</span> <span class="built_in">wait</span></span><br><span class="line">minutes (int) â€“ <span class="built_in">number</span> <span class="keyword">of</span> minutes <span class="built_in">to</span> <span class="built_in">wait</span></span><br><span class="line"><span class="built_in">seconds</span> (int) â€“ <span class="built_in">number</span> <span class="keyword">of</span> <span class="built_in">seconds</span> <span class="built_in">to</span> <span class="built_in">wait</span></span><br><span class="line">start_date (datetime|str) â€“ starting point <span class="keyword">for</span> <span class="keyword">the</span> interval calculation</span><br><span class="line">end_date (datetime|str) â€“ latest possible <span class="built_in">date</span>/<span class="built_in">time</span> <span class="built_in">to</span> trigger <span class="keyword">on</span></span><br><span class="line">timezone (datetime.tzinfo|str) â€“ <span class="built_in">time</span> zone <span class="built_in">to</span> use <span class="keyword">for</span> <span class="keyword">the</span> <span class="built_in">date</span>/<span class="built_in">time</span> calculations</span><br><span class="line"><span class="comment">#å¦‚:æ¯éš”2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">scheduler.add_job(myfunc, <span class="string">'interval'</span>, minutes=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.dateé£æ ¼</span></span><br><span class="line">run_date (datetime|str) â€“ <span class="keyword">the</span> <span class="built_in">date</span>/<span class="built_in">time</span> <span class="built_in">to</span> run <span class="keyword">the</span> job <span class="keyword">at</span>  -ï¼ˆä»»åŠ¡å¼€å§‹çš„æ—¶é—´ï¼‰</span><br><span class="line">timezone (datetime.tzinfo|str) â€“ <span class="built_in">time</span> zone <span class="keyword">for</span> run_date <span class="keyword">if</span> <span class="keyword">it</span> doesnâ€™t have <span class="literal">one</span> already</span><br><span class="line"><span class="comment">#å¦‚:åœ¨2009å¹´11æœˆ6å·16æ—¶30åˆ†5ç§’æ—¶æ‰§è¡Œ</span></span><br><span class="line">sched.add_job(my_job, <span class="string">'date'</span>, run_date=datetime(<span class="number">2009</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">16</span>, <span class="number">30</span>, <span class="number">5</span>), args=[<span class="string">'text'</span>])</span><br></pre></td></tr></tbody></table></figure></li><li><p><code>ä½œä¸šå­˜å‚¨(job store)</code>å­˜å‚¨è¢«è°ƒåº¦çš„ä½œä¸šï¼Œé»˜è®¤çš„ä½œä¸šå­˜å‚¨æ˜¯ç®€å•åœ°æŠŠä½œä¸šä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå…¶ä»–çš„ä½œä¸šå­˜å‚¨æ˜¯å°†ä½œä¸šä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚ä¸€ä¸ªä½œä¸šçš„æ•°æ®è®²åœ¨ä¿å­˜åœ¨æŒä¹…åŒ–ä½œä¸šå­˜å‚¨æ—¶è¢«åºåˆ—åŒ–ï¼Œå¹¶åœ¨åŠ è½½æ—¶è¢«ååºåˆ—åŒ–ã€‚è°ƒåº¦å™¨ä¸èƒ½åˆ†äº«åŒä¸€ä¸ªä½œä¸šå­˜å‚¨ã€‚</p><p> jobstoreåˆ™æ˜¯æŒ‡çš„æ˜¯jobæŒä¹…åŒ–,é»˜è®¤jobè¿è¡Œåœ¨å†…å­˜ä¸­,å¯æŒä¹…åŒ–åœ¨æ•°æ®åº“,æŒ‡å®šä¸ºmongoçš„MongoDBJobStoreæˆ–è€…æ˜¯ä½¿ç”¨sqliteçš„SQLAlchemyJobStore,åŒæ—¶å¯æŒ‡å®šå¤šç§jobstore</p></li><li><p><code>æ‰§è¡Œå™¨(executor)</code>å¤„ç†ä½œä¸šçš„è¿è¡Œï¼Œä»–ä»¬é€šå¸¸é€šè¿‡åœ¨ä½œä¸šä¸­æäº¤åˆ¶å®šçš„å¯è°ƒç”¨å¯¹è±¡åˆ°ä¸€ä¸ªçº¿ç¨‹æˆ–è€…è¿›åŸæ± æ¥è¿›è¡Œã€‚å½“ä½œä¸šå®Œæˆæ—¶ï¼Œæ‰§è¡Œå™¨å°†ä¼šé€šçŸ¥è°ƒåº¦å™¨ã€‚</p><p> è¯´ç™½äº†å°±æ˜¯æŒ‡å®šä»»åŠ¡æ˜¯ä»¥çº¿ç¨‹æ± /è¿›ç¨‹æ± é‡Œè¿è¡Œ,è¿™åœ¨åˆå§‹åŒ–æ—¶å¯ä»¥æŒ‡å®š,åŒæ—¶å¯ä»¥æŒ‡å®šæœ€å¤§çš„å·¥ä½œæ± ,é»˜è®¤çš„ä¸ºdefault: ThreadPoolExecutor,max-workerä¸º20,å½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šä¸ºprocesspool,é»˜è®¤max-workerä¸º5</p></li><li><p><code>è°ƒåº¦å™¨(scheduler)</code>æ˜¯å…¶ä»–çš„ç»„æˆéƒ¨åˆ†ã€‚ä½ é€šå¸¸åœ¨åº”ç”¨åªæœ‰ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œåº”ç”¨çš„å¼€å‘è€…é€šå¸¸ä¸ä¼šç›´æ¥å¤„ç†ä½œä¸šå­˜å‚¨ã€è°ƒåº¦å™¨å’Œè§¦å‘å™¨ï¼Œç›¸åï¼Œè°ƒåº¦å™¨æä¾›äº†å¤„ç†è¿™äº›çš„åˆé€‚çš„æ¥å£ã€‚é…ç½®ä½œä¸šå­˜å‚¨å’Œæ‰§è¡Œå™¨å¯ä»¥åœ¨è°ƒåº¦å™¨ä¸­å®Œæˆï¼Œä¾‹å¦‚æ·»åŠ ã€ä¿®æ”¹å’Œç§»é™¤ä½œä¸šã€‚<br>è°ƒåº¦å™¨åˆ†ä¸ºä»¥ä¸‹å‡ ç§,å¯æ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯é€‰ç”¨ä¸åŒçš„è°ƒåº¦å™¨:</p> <figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">BlockingScheduler:</span> å¾ˆæ˜æ˜¾è¿™æ˜¯ç§é˜»å¡å‹,ä¸€èˆ¬ç”¨åœ¨æ²¡æœ‰å…¶å®ƒè¿›ç¨‹è¿è¡Œçš„åœºæ™¯ä¸‹</span><br><span class="line"><span class="symbol">BackGroundScheduler:</span> åå°å¼,ä¹Ÿå°±æ˜¯å•èµ·ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹è¿è¡Œè¯¥ä»»åŠ¡,ä¸å½±å“ä¸»ç¨‹åº</span><br><span class="line"><span class="symbol">ASyncIOScheduler:</span></span><br><span class="line"><span class="symbol">GeventScheduler:</span></span><br><span class="line"><span class="symbol">TornadoScheduler:</span></span><br><span class="line"><span class="symbol">TwistedScheduler:</span></span><br><span class="line"><span class="symbol">QtScheduler:</span></span><br></pre></td></tr></tbody></table></figure><p> æœ¬äººåªä½¿ç”¨è¿‡BlockingSchedulerè·ŸBackGroundScheduler,flask-schedulerä½¿ç”¨çš„å³ä¸ºBackGroundScheduler,å…¶å®ƒçš„åç»­å†ç ”ç©¶ç ”ç©¶<br> é€‰æ‹©ç±»å‹ä¹Ÿå¾ˆç®€å•,åˆå§‹åŒ–æ—¶ç›´æ¥å®ä¾‹åŒ–:</p> <figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from apscheduler.<span class="keyword">schedulers.background </span>import <span class="keyword">BackgroundScheduler</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">scheduler </span>= <span class="keyword">BackgroundScheduler()</span></span><br><span class="line"><span class="keyword"></span><span class="comment">#å¯åŠ¨</span></span><br><span class="line"><span class="keyword">scheduler.start()</span></span><br></pre></td></tr></tbody></table></figure></li></ol><p>ä»¥ä¸Šå°±æ˜¯apschedulerä¸»è¦ç»„æˆçš„å››ä¸ªæ–¹é¢ã€‚é‚£ä¹ˆæ—¢ç„¶æœ‰æä¾›flask-apschedulerè¿™ä¸ªæ‰©å±•ï¼Œé‚£ä¸€å®šæ˜¯æŠŠapschedulerå°è£…è¿‡åä¸ºæˆ‘ä»¬æä¾›æ›´åŠ æ–¹ä¾¿çš„é›†æˆå¼€å‘ï¼Œè¿™é‡Œæˆ‘çš„å­˜å‚¨é€‰æ‹©äº†MySQLä½œä¸ºä½œä¸šä»»åŠ¡å­˜å‚¨ï¼Œå› ä¸ºæˆ‘è¿™é‡Œçš„å¹³å°çš„ç”¨æˆ·æ˜¯ç”¨å®ƒæ¥å­˜å‚¨çš„ï¼›ä¸ºäº†æ–¹ä¾¿ç»Ÿä¸€ä½¿ç”¨äº†MySQL;</p><hr><p>ä»¥ä¸‹æ˜¯è¿™ä¸ªé¡¹ç›®çš„ç»“æ„:</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="symbol">/data/study/github_repo/JobCenter</span> $ tree <span class="operator">-</span>L <span class="number">2</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ Pipfile</span><br><span class="line">â”œâ”€â”€ Pipfile.lock</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ app</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ auth<span class="symbol">/</span>  <span class="comment"># å¹³å°ç™»å½•ç›¸å…³</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ commands.py</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ config.py  <span class="comment"># å¹³å°é…ç½®ç›¸å…³</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ decorators.py</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ email.py  <span class="comment"># é‚®ä»¶å‘é€</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ extensions.py</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ job<span class="symbol">/</span>  <span class="comment"># å®šæ—¶ä»»åŠ¡ä¸»è¦æ¨¡å—</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ main<span class="symbol">/</span>  <span class="comment"># ä¸»è¦ç”¨äºè·¯ç”±</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ models.py  <span class="comment"># æ•°æ®æ¨¡å‹</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ static</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ templates</span><br><span class="line">â””â”€â”€ test.py       </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ç›®å‰ä¸»è¦å®ç°çš„åŠŸèƒ½æœ‰:</p><ul><li>å¯è§†åŒ–ç•Œé¢æ“ä½œ</li><li>å®šæ—¶ä»»åŠ¡ç»Ÿä¸€ç®¡ç†</li><li>å®Œå…¨å…¼å®¹Crontab</li><li>æ”¯æŒç§’çº§å®šæ—¶ä»»åŠ¡</li><li>ä½œä¸šä»»åŠ¡å¯æœç´¢ã€æš‚åœã€ç¼–è¾‘ã€åˆ é™¤</li><li>ä½œä¸šä»»åŠ¡æŒä¹…åŒ–å­˜å‚¨ã€ä¸‰ç§ä¸åŒè§¦å‘å™¨ç±»å‹ä½œä¸šåŠ¨æ€æ·»åŠ </li></ul><hr><p><img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/login.png" alt="æ¸…çˆ½çš„ç™»å½•ç•Œé¢"></p><p><img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/pausejob.png" alt="ä»»åŠ¡åˆ—è¡¨ä¸­æš‚åœã€æ¢å¤å·²æ·»åŠ ä»»åŠ¡"></p><p><img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/addjob.png" alt="é’ˆå¯¹ä¸åŒè§¦å‘å™¨åŠ¨æ€å¢åŠ ä»»åŠ¡"></p><p><img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/stdout.png" alt="ä»»åŠ¡æ‰§è¡Œè¾“å‡ºæ—¥å¿—æŒä¹…åŒ–å­˜æ”¾å¹¶å±•ç¤º"></p><p>æ¬¢è¿star æ¬¢è¿æå»ºè®®~<br>é¡¹ç›®åœ°å€: <a href="https://github.com/guomaoqiu/JobCenter">https://github.com/guomaoqiu/JobCenter</a><br>Demoåœ°å€: <a href="https://jobcenter.sctux.cc/">https://jobcenter.sctux.cc</a></p>]]></content>
      
      
      <categories>
          
          <category> å®šæ—¶ä»»åŠ¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flask APScheduler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºHarboræ­å»ºä¼ä¸šçº§ç§æœ‰é•œåƒä»“åº“</title>
      <link href="/2019/01/07/docker-harbor/"/>
      <url>/2019/01/07/docker-harbor/</url>
      
        <content type="html"><![CDATA[<h1 id="åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“"><a href="#åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“" class="headerlink" title="åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“"></a>åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“</h1><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>dockerä¸­è¦ä½¿ç”¨é•œåƒï¼Œä¸€èˆ¬ä¼šä»æœ¬åœ°ã€docker Hupå…¬å…±ä»“åº“å’Œå…¶å®ƒç¬¬ä¸‰æ–¹å…¬å…±ä»“åº“ä¸­ä¸‹è½½é•œåƒï¼Œä¸€èˆ¬å‡ºäºå®‰å…¨å’Œå¤–ç½‘(å¢™)èµ„æºä¸‹è½½é€Ÿç‡çš„åŸå› è€ƒè™‘ä¼ä¸šçº§ä¸Šä¸ä¼šè½»æ˜“ä½¿ç”¨ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§åŠæ³•å¯ä»¥å­˜å‚¨è‡ªå·±çš„é•œåƒåˆæœ‰å®‰å…¨è®¤è¯çš„ä»“åº“å‘¢? </p><pre><code>     â€”-&gt; ä¼ä¸šçº§ç¯å¢ƒä¸­åŸºäºHarboræ­å»ºè‡ªå·±çš„å®‰å…¨è®¤è¯ä»“åº“ã€‚</code></pre><p>Harboræ˜¯VMwareå…¬å¸æœ€è¿‘å¼€æºçš„ä¼ä¸šçº§Docker Registryé¡¹ç›®, å…¶ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·è¿…é€Ÿæ­å»ºä¸€ä¸ªä¼ä¸šçº§çš„Docker registryæœåŠ¡ã€‚</p><h2 id="å®‰è£…Harbor"><a href="#å®‰è£…Harbor" class="headerlink" title="å®‰è£…Harbor"></a>å®‰è£…Harbor</h2><p>harboréœ€è¦å®‰è£…dockerå’Œdocker-composeæ‰èƒ½ä½¿ç”¨ï¼Œå®‰è£…dockeræ­¥éª¤çœç•¥ï¼Œ</p><h3 id="å®‰è£…docker-dompose"><a href="#å®‰è£…docker-dompose" class="headerlink" title="å®‰è£…docker-dompose"></a>å®‰è£…docker-dompose</h3><p>docker-domposeå®‰è£…æ­¥éª¤å¦‚ä¸‹ï¼š </p><p>ä¸‹è½½æœ€æ–°ç‰ˆçš„docker-composeæ–‡ä»¶ </p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -L https:<span class="regexp">//gi</span>thub.com<span class="regexp">/docker/</span>compose<span class="regexp">/releases/</span>download<span class="regexp">/1.23.2/</span>docker-compose-$(uname -s)-$(uname -m) -o <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>docker-compose</span><br></pre></td></tr></tbody></table></figure><p>æ·»åŠ å¯æ‰§è¡Œæƒé™</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span></span><br></pre></td></tr></tbody></table></figure><p>éªŒè¯ç‰ˆæœ¬</p><figure class="highlight applescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose -v</span><br><span class="line">docker-compose <span class="built_in">version</span> <span class="number">1.23</span><span class="number">.2</span>, build <span class="number">1110</span>ad01</span><br></pre></td></tr></tbody></table></figure><h3 id="è·å–Harborè½¯ä»¶åŒ…"><a href="#è·å–Harborè½¯ä»¶åŒ…" class="headerlink" title="è·å–Harborè½¯ä»¶åŒ…"></a>è·å–Harborè½¯ä»¶åŒ…</h3><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https</span>://storage.googleapis.com/harbor-releases/release-<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>/harbor-offline-installer-v1.<span class="number">7</span>.<span class="number">1</span>.tgz</span><br></pre></td></tr></tbody></table></figure><p>è§£å‹</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tar</span> -xf harbor-offline-installer-v1.<span class="number">7</span>.<span class="number">1</span>.tgz -C /usr/local/</span><br></pre></td></tr></tbody></table></figure><p>ç¼–è¾‘é…ç½®æ–‡ä»¶</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/harbor</span><br><span class="line">$ vim harbor.cfg</span><br><span class="line">hostname = reg.for-k8s.com   <span class="comment"># æœ¬æœºå¤–ç½‘IPæˆ–åŸŸåï¼Œè¯¥åœ°å€ä¾›ç”¨æˆ·é€šè¿‡UIè¿›è¡Œè®¿é—®ï¼Œä¸è¦ä½¿ç”¨127.0.0.1</span></span><br><span class="line">ui_url_protocol = https             <span class="comment"># ç”¨æˆ·è®¿é—®ç§ä»“æ—¶ä½¿ç”¨çš„åè®®ï¼Œé»˜è®¤æ—¶httpï¼Œé…ç½®æˆhttps</span></span><br><span class="line">db_password = root123           ã€€ã€€ <span class="comment"># æŒ‡å®šmysqlæ•°æ®åº“ç®¡ç†å‘˜å¯†ç </span></span><br><span class="line">harbor_admin_passwordï¼šHarbor12345   <span class="comment"># harborçš„ç®¡ç†å‘˜è´¦æˆ·å¯†ç </span></span><br><span class="line">ssl_cert = /data/cert/reg.for-k8s.com.crt ã€€ã€€<span class="comment"># è®¾ç½®è¯ä¹¦æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">ssl_cert_key = /data/cert/reg.for-k8s.com.key  <span class="comment"># è®¾ç½®è¯ä¹¦å¯†é’¥æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶ä»–é…ç½®é€‰é¡¹æŒ‰éœ€å¡«å†™å³å¯</span></span><br></pre></td></tr></tbody></table></figure><h3 id="ç”Ÿæˆsslè¯ä¹¦"><a href="#ç”Ÿæˆsslè¯ä¹¦" class="headerlink" title="ç”Ÿæˆsslè¯ä¹¦"></a>ç”Ÿæˆsslè¯ä¹¦</h3><p>ç”Ÿæˆæ ¹è¯ä¹¦</p><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">cd</span> /dada/cert/</span><br><span class="line"></span><br><span class="line">$ openssl req  -newkey rs<span class="variable">a:4096</span> -nodes -<span class="built_in">sha256</span> -keyout <span class="keyword">ca</span>.key -x509 -days <span class="number">365</span> -out <span class="keyword">ca</span>.crt -subj <span class="string">"/C=CN/L=Shanghai/O=harbor/CN=harbor-registry"</span></span><br></pre></td></tr></tbody></table></figure><p>ç”Ÿæˆä¸€ä¸ªè¯ä¹¦ç­¾å, è®¾ç½®è®¿é—®åŸŸåä¸º reg.for-k8s.com</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -newkey rsa:<span class="number">4096</span> -nodes -sha256 -keyout reg<span class="selector-class">.for-k8s</span><span class="selector-class">.com</span><span class="selector-class">.key</span> -out server<span class="selector-class">.csr</span> -subj <span class="string">"/C=CN/L=Shanghai/O=harbor/CN=reg.for-k8s.com"</span></span><br></pre></td></tr></tbody></table></figure><p>ç”Ÿæˆä¸»æœºè¯ä¹¦</p><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -req -days 365 -<span class="keyword">in</span> server.csr -<span class="keyword">CA</span> <span class="keyword">ca</span>.crt -CAkey <span class="keyword">ca</span>.key -CAcreateserial -<span class="keyword">out</span> <span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.com.crt</span><br></pre></td></tr></tbody></table></figure><h3 id="é€šè¿‡è‡ªå¸¦è„šæœ¬ä¸€é”®å®‰è£…"><a href="#é€šè¿‡è‡ªå¸¦è„šæœ¬ä¸€é”®å®‰è£…" class="headerlink" title="é€šè¿‡è‡ªå¸¦è„šæœ¬ä¸€é”®å®‰è£…"></a>é€šè¿‡è‡ªå¸¦è„šæœ¬ä¸€é”®å®‰è£…</h3><figure class="highlight lasso"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/<span class="built_in">local</span>/harbor/</span><br><span class="line">./install.sh</span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line">âœ” ---<span class="params">-Harbor</span> has been installed <span class="literal">and</span> started successfully.----</span><br><span class="line"></span><br><span class="line">Now you should be able <span class="keyword">to</span> visit the admin <span class="keyword">portal</span> at https:<span class="comment">//reg.for-k8s.com.</span></span><br><span class="line">For more details, please visit https:<span class="comment">//github.com/goharbor/harbor .</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ç„¶åç»‘å®šhostsè®¿é—®å³å¯:<br><img src="/2019/01/07/docker-harbor/15468488877244.jpg"></p><p>é»˜è®¤è´¦å·å¯†ç <code>admin / Harbor12345</code><br><img src="/2019/01/07/docker-harbor/15468489958269.jpg"></p><p>ok é‚£ä¸Šé¢çš„ç§æœ‰ä»“åº“æœåŠ¡å·²ç»æ­å»ºå®Œæ¯•äº†ï¼Œè¯¥æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ</p><ol start="0"><li><p>é¦–å…ˆåœ¨harborä¸Šåˆ›å»ºä¸€ä¸ªé¡¹ç›®<code>myproject</code>(æˆ‘è¿™é‡Œä¸ä½¿ç”¨é»˜è®¤çš„libary)<br><img src="/2019/01/07/docker-harbor/15468494639235.jpg"><br>è¿™é‡Œæˆ‘é€‰æ‹©ç§æœ‰ä»“åº“, pull/pushéƒ½éœ€è¦åœ¨ä¸»æœºä¸Šé¢æ‰§è¡Œ<code>docker login</code>æ‰è¡Œ;</p></li><li><p>å½“æˆ‘é€šè¿‡Dockerfileæ„å»ºä¸€ä¸ªæ–°é•œåƒçš„æ—¶å€™, ç›´æ¥æŒ‡æ˜registryå’Œæ ‡ç­¾, æ¯”å¦‚:</p></li></ol><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t <span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mydocker-image:v1.<span class="number">0.1</span> .</span><br><span class="line">Sending build context <span class="keyword">to</span> Docker daemon  <span class="number">97.21</span>MB</span><br><span class="line">Step <span class="number">1</span>/<span class="number">12</span> : FROM  <span class="number">1</span>and1internet/ubuntu-<span class="number">16</span></span><br><span class="line"> ---&gt; dbf985f1f449</span><br><span class="line">Step <span class="number">2</span>/<span class="number">12</span> : MAINTAINER guomaoqiu &lt;guomaoqiu@gmail.<span class="keyword">com</span>&gt;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; <span class="number">598894333</span>db9</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">Successfully built b190966f3773</span><br><span class="line">Successfully tagged <span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mydocker-image:v1.<span class="number">0.1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ docker images | <span class="keyword">grep</span> myproject</span><br><span class="line"><span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mydocker-image  v1.<span class="number">0.1</span>   b190966f3773   <span class="number">44</span> seconds ago    <span class="number">482</span>MB</span><br></pre></td></tr></tbody></table></figure><ol start="2"><li>åŠ å…¥å½“ä½ ä»åˆ«å¤„è·å–çš„é•œåƒæƒ³ä¸Šä¼ åˆ°ç§æœ‰ä»“åº“å‘¢ï¼Ÿå°±æ˜¯æ‰“ä¸ªtagå°±è¡Œå•¦, æ¯”å¦‚æˆ‘æƒ³æŠŠä»å®˜ç½‘çš„è¿™ä¸ªnginxé•œåƒæ”¾åˆ°æˆ‘çš„ä»“åº“:</li></ol><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">tag</span> nginx <span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mynginx:latest</span><br><span class="line">$ docker images | <span class="keyword">grep</span> myproject</span><br><span class="line"><span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mydocker-image    v1.<span class="number">0.1</span> b190966f3773  <span class="number">2</span> minutes ago       <span class="number">482</span>MB</span><br><span class="line"><span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mynginx           latest <span class="number">568</span>c4670fa80  <span class="number">5</span> weeks ago         <span class="number">109</span>MB</span><br></pre></td></tr></tbody></table></figure><ol start="3"><li>ç™»å½•ä»“åº“</li></ol><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ docker login -u admin -<span class="selector-tag">p</span> Harbor12345 reg<span class="selector-class">.for-k8s</span><span class="selector-class">.com</span></span><br><span class="line">Username: admin</span><br><span class="line">Password:</span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config<span class="selector-class">.json</span>.</span><br><span class="line">Configure <span class="selector-tag">a</span> credential helper to remove this warning. See</span><br><span class="line">https:<span class="comment">//docs.docker.com/engine/reference/commandline/login/#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><ol start="4"><li>æœ€åæŠŠæœ¬åœ°çš„é•œåƒpushåˆ°ä»“åº“<br>å½“æˆ‘æ‰§è¡Œè¿™ä¸ªçš„æ—¶å€™æŠ¥é”™äº†ï¼š</li></ol><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker push reg.for-k8s.com/myproject/mynginx:latest</span><br><span class="line"><span class="keyword">Error </span>response from daemon: Get https://reg.for-k8s.com/v2/: x509: certificate signed by unknown authority</span><br></pre></td></tr></tbody></table></figure><p>è§£å†³åŠæ³•å°±æ˜¯å¦‚æœä¸åœ¨å®¢æˆ·ç«¯éƒ¨ç½²è¯ä¹¦ï¼Œé‚£ä¹ˆåœ¨Dockerå¯åŠ¨æ—¶è®¾ç½®å‚æ•° â€œâ€“insecure-registry IP/ä»“åº“åŸŸåâ€,ç„¶åé‡è½½æœåŠ¡é‡å¯dockerè¿›ç¨‹ï¼›æ³¨æ„çš„æ˜¯æˆ‘è¿™é‡Œä½¿ç”¨çš„è¿™ä¸ªåŸŸåæ˜¯è‡ªå®šä¹‰çš„ï¼Œé‚£ä¹ˆéœ€è¦åœ¨éœ€è¦ä¸Šä¼ ä¸‹è½½é•œåƒçš„æœºå™¨ä¸Šï¼ŒåŒæ ·éœ€è¦ä¿®æ”¹dockerè¿›ç¨‹å‚æ•°ï¼Œå¹¶ä¸”ç»‘å®šhosts,å¦åˆ™å³ä½¿é…ç½®äº†å‚æ•°ï¼Œè¿™ä¸ªåŸŸåæ²¡æ³•è§£æä¹Ÿæ˜¯push/pullä¸åˆ°é•œåƒçš„ã€‚</p><ol start="5"><li>å†æ¬¡æ‰§è¡Œpushæ“ä½œ:</li></ol><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ docker push reg.for-k8s.com<span class="operator">/</span>myproject<span class="operator">/</span>mynginx:latest</span><br><span class="line">The push refers to repository [reg.for-k8s.com<span class="operator">/</span>myproject<span class="operator">/</span>mynginx]</span><br><span class="line"><span class="params">b7efe781401d:</span> Pushed</span><br><span class="line"><span class="params">c9c2a3696080:</span> Pushed</span><br><span class="line"><span class="number">7</span><span class="params">b4e562e58dc:</span> Pushed</span><br><span class="line"><span class="params">latest:</span> <span class="params">digest:</span> sha256:e2847e35d4e0e2d459a7696538cbfea42ea2d3b8a1ee8329ba7e68694950afd3 <span class="params">size:</span> <span class="number">948</span></span><br><span class="line"></span><br><span class="line">$ [root@k8s-m1 kubectl-terminal-ubuntu]<span class="comment"># docker push reg.for-k8s.com/myproject/mydocker-image:v1.0.1</span></span><br><span class="line">The push refers to repository [reg.for-k8s.com<span class="operator">/</span>myproject<span class="operator">/</span>mydocker-image]</span><br><span class="line"><span class="number">96</span><span class="params">dca48ee72c:</span> Pushed</span><br><span class="line"><span class="params">fa879b69764c:</span> Pushed</span><br><span class="line"><span class="number">4</span><span class="params">d823b00e6b7:</span> Pushed</span><br><span class="line"><span class="number">6</span><span class="params">bf6e96da4a0:</span> Pushed</span><br><span class="line"><span class="params">eedda540c6a8:</span> Pushed</span><br><span class="line"><span class="params">f2a971e53afa:</span> Pushed</span><br><span class="line"><span class="number">3</span><span class="params">ee1a3b3fd18:</span> Pushed</span><br><span class="line"><span class="number">8</span><span class="params">a225cfa6dea:</span> Pushed</span><br><span class="line"><span class="number">428</span><span class="params">c1ba11354:</span> Pushed</span><br><span class="line"><span class="params">b097f5edab7b:</span> Pushed</span><br><span class="line"><span class="number">27712</span><span class="params">caf4371:</span> Pushed</span><br><span class="line"><span class="number">8241</span><span class="params">afc74c6f:</span> Pushed</span><br><span class="line">v1.<span class="number">0.1</span>: <span class="params">digest:</span> sha256:a20629f62d73cff93bf73b31958878a1d76c2dd42e36ebb2cb6d0ac294a46da7 <span class="params">size:</span> <span class="number">2826</span></span><br></pre></td></tr></tbody></table></figure><p><img src="/2019/01/07/docker-harbor/15468535525128.jpg"></p><p>ä»¥ä¸ŠpushæˆåŠŸï¼›</p><p>æµ‹è¯•pull<br>é‚£ä¸ºäº†æµ‹è¯•pullå¹¶ä¸”èƒ½æˆåŠŸè¿è¡Œï¼Œæˆ‘è¿™é‡Œé€šè¿‡kuernetesè¿è¡Œä¸€ä¸ªDaemonSetï¼Œé•œåƒé‡‡ç”¨: <code>mynginx</code> ,å¹¶ä¸”è®¾ç½®é•œåƒpullç­–ç•¥ä¸º<code>Always</code>, ç„¶ååˆ›å»ºä¸€ä¸ªæœåŠ¡åœ¨é›†ç¾¤å†…éƒ¨é€šè¿‡ClusterIPèƒ½å¤Ÿè®¿é—®, yamlå¦‚ä¸‹:</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">&gt;&gt;</span> <span class="string">test.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mynginx-service</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">reg.for-k8s.com/myproject/mynginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span>  <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">daemonset.yaml</span></span><br><span class="line"><span class="string">service/mynginx-service</span> <span class="string">created</span></span><br><span class="line"><span class="string">daemonset.extensions/mynginx</span> <span class="string">create</span></span><br></pre></td></tr></tbody></table></figure><p>ç”±äºæˆ‘åˆšæ‰åˆ›å»ºä»“åº“çš„æ—¶å€™è®¾ç½®çš„ä»“åº“éšç§æ€§ä¸ºç§æœ‰çš„<br>éœ€è¦docker login ç™»å½•æˆåŠŸä¹‹åï¼Œk8s kubectl create å°±æ‹‰å–ä¸äº†é•œåƒï¼›<br>å¦‚æœè®¾ç½®ä¸ºå…¬å¼€ï¼Œé‚£ä¹ˆä¹…ä¸éœ€è¦é…ç½®è¿™ä¸€æ­¥éª¤ã€‚åªéœ€è¦docker login ç™»å½•æˆåŠŸä¹‹åï¼Œk8s kubectl create å°±å¯ä»¥æ‹‰å–é•œåƒ; ä½†æ˜¯æˆ‘ä¸æƒ³è®©å…¶ä¸ºå…¬å¼€çš„ï¼›æ‰€ä»¥è¿˜éœ€è¦é…ç½®å¦‚ä¸‹æ­¥éª¤ï¼š</p><p>é…ç½®ä¸€ä¸ªç§æœ‰ä»“åº“harborçš„secretï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create<span class="built_in"> secret </span>docker-registry registry-secret <span class="attribute">--namespace</span>=default \</span><br><span class="line"><span class="attribute">--docker-server</span>=https://reg.for-k8s.com <span class="attribute">--docker-username</span>=admin \</span><br><span class="line"><span class="attribute">--docker-password</span>=Harbor12345</span><br></pre></td></tr></tbody></table></figure><p>éƒ¨ç½²æ—¶æŒ‡å®šimagePullSecrets, ä¿®æ”¹åœ¨ä¸Šé¢çš„yamlä¸­æ·»åŠ è¿™ä¸ªé€‰é¡¹:</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">&gt;&gt;</span> <span class="string">test.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mynginx-service</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">reg.for-k8s.com/myproject/mynginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">registry-secret</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span>  <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">daemonset.yaml</span></span><br><span class="line"><span class="string">service/mynginx-service</span> <span class="string">created</span></span><br><span class="line"><span class="string">daemonset.extensions/mynginx</span> <span class="string">create</span></span><br></pre></td></tr></tbody></table></figure><p><img src="/2019/01/07/docker-harbor/15468562743522.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker-registry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CKA(Certified Kubernetes Adminsitrator)è®¤è¯è·å–å†ç¨‹</title>
      <link href="/2019/01/07/road-to-cka/"/>
      <url>/2019/01/07/road-to-cka/</url>
      
        <content type="html"><![CDATA[<p><em>my experience with cka exam preparation</em></p><hr><h1 id="What-is-CKA"><a href="#What-is-CKA" class="headerlink" title="What is CKA?"></a>What is CKA?</h1><p>CKAå…¨ç§°å°±æ˜¯<code>Certified Kubernetes Adminsitrator</code>ï¼Œæ˜¯ç”±CNCF(Cloud Native Computing Foundation äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š)æä¾›çš„è®¤è¯é¡¹ç›®ï¼Œè€ƒè¯•è´¹ç”¨ä¸º<code>300</code>ç¾é‡‘ï¼Œå¿…é¡»è¦åŒå¸è¡Œç”¨å¡ï¼Œè€ƒè¯•è¿‡ç¨‹ä¸º<code>3</code>ä¸ªå°æ—¶ã€‚<br>æˆ‘åŠç†çš„æ˜¯æ‹›è¡Œçš„MasterCardï¼Œç»™äº†20å—åŠ æ€¥ï¼›ç¼´è€ƒè¯•è´¹åˆ°è€ƒå®Œæ•´ä¸ªæµç¨‹æ–¹é¢è¿˜æ˜¯éå¸¸ç®€å•çš„ã€‚</p><div style="width: 40%; margin: auto">![](road-to-cka/WechatIMG319.jpeg)</div>å¦‚æœè€ƒè¯•ç¬¬ä¸€æ¬¡è€ƒè¯•ä¸é€šè¿‡ï¼Œè´¦å·å†…ä¼šç”Ÿæˆä¸€ä¸ª`Free Retake`ï¼Œåœ¨ä¸€å¹´ä¹‹å†…æœ‰ä¸€æ¬¡å…è´¹é‡è€ƒçš„æœºä¼šã€‚ <h1 id="Why-should-obtain-certification"><a href="#Why-should-obtain-certification" class="headerlink" title="Why should obtain certification"></a>Why should obtain certification</h1><p>å¾ˆæœ‰å¹¸åœ¨æ˜¥èŠ‚å‰(2019/01/06)å®Œæˆäº†2018ä¸‹åŠå¹´æ—¢å®šçš„ç›®æ ‡ï¼Œå°†CKAé¡ºåˆ©æ‹¿ä¸‹ã€‚<br>å¾ˆå·§åˆçš„æ˜¯åœ¨6å¹´å‰ä¹Ÿå°±æ˜¯2013å¹´1æœˆ5å·æˆ‘é€šè¿‡äº†<a href="https://blog.sctux.com/Guo_Maoqiu_RHCE.pdf">RHCE</a>è®¤è¯è€ƒè¯•(è™½ç„¶æˆ‘çš„RHCEè®¤è¯æ—©å·²è¿‡æœŸï¼Œä½†æ˜¯æˆ‘æ›´æƒ³è¯´çš„æ˜¯: <em><strong>ä¸‡å˜ä¸ç¦»å…¶å®—</strong></em> )<br><img src="/2019/01/07/road-to-cka/CKA.png"></p><p><img src="/2019/01/07/road-to-cka/verification.png"><br>å½“K8Så·²ç»è¿›å…¥åˆ°å„è¡Œå„ä¸šï¼Œé‚£ä¹ˆä¸€å¥—å…¬æ­£æƒå¨çš„ç®¡ç†å‘˜æµ‹è¯„ä½“ç³»å¿…ç„¶å°±å‘¼ä¹‹æ¬²å‡ºäº†ã€‚<br>ä¹Ÿè®¸ä½ ä¼šè¯´äº’è”ç½‘ä¼ä¸šä¸ç›¸ä¿¡è®¤è¯ï¼Œç¡®å®ä¸€å¼ çº¸å¹¶ä¸èƒ½è¯´æ˜ä»€ä¹ˆã€‚è¿™äº›è®¤è¯çš„æ„ä¹‰ä½•åœ¨ï¼Œæˆ–è€…æ€ä¹ˆæ‰èƒ½å‘åˆ«äººè¯æ˜ä½ ä¼šç”¨å‘¢ï¼Ÿç­”æ¡ˆè‡ªç„¶å°±æ˜¯è€ƒè¯äº†ã€‚RHCEä¹Ÿå¥½ã€CKAä¹Ÿå¥½å¯¹æˆ‘è€Œè¨€å…¶å®æ›´å¤šçš„æ˜¯ä¸€ç§é­ç­–ï¼Œè®©è‡ªå·±å¿ƒé‡Œæœ‰ä¸ªå°ç›®æ ‡ï¼ŒåŒæ—¶èƒ½å¤Ÿä»¥è¿ç»´äººå‘˜çš„èº«ä»½å»ç³»ç»Ÿçš„å­¦ä¹ ã€ä½¿ç”¨ä»–ä»¬ã€‚</p><p>ç»è¿‡æˆ‘ä¸ªäººçš„å­¦ä¹ ï¼Œå‚è€ƒè¿‡ç¨‹ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªè®¤è¯çš„æ„ä¹‰å’Œä»·å€¼å¦‚ä¸‹ï¼š</p><ol><li>ä»è€ƒè¯•å¤§çº²å¯ä»¥çœ‹å‡ºè€ƒè¯•å†…å®¹æ¶µç›–çš„çŸ¥è¯†ç‚¹å¾ˆå…¨é¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ éœ€è¦å­¦ä¹ æˆ–è€…äº†è§£çš„çŸ¥è¯†ç‚¹ä¹Ÿå°±å¾ˆå¤š;</li><li>å¯¹äºè®¡åˆ’æ„å»ºè‡ªå·±k8sé›†ç¾¤çš„ä¸ªäººå’Œä¼ä¸šï¼Œæœ‰CKAåœ¨ä½ çš„å›¢é˜Ÿé‡Œèƒ½è®©ä½ æ›´å¿«æ›´ç¨³çš„å¼€å§‹ä½ çš„å®è·µã€‚æ¯•ç«Ÿè¿™å¸®äººæ˜¯ä»å¾’æ‰‹æ­é›†ç¾¤å¼€å§‹çš„ã€‚</li><li>å‚åŠ è¿™ä¸ªè€ƒè¯•çš„æ—¶é—´éå¸¸ç´§å¼ ï¼Œå‚åŠ äººå¿…é¡»å¯¹k8så¤§éƒ¨åˆ†èµ„æºçš„yamlå’Œå‘½ä»¤çƒ‚ç†Ÿäºå¿ƒã€‚ä½ éšä¾¿æ‰¾ä¸ªckaæ¥ï¼Œè®©ä»–å¾’æ‰‹ç»™ä½ å†™ä¸€ä¸ªåº”ç”¨çš„ç¼–æ’å‡ºæ¥ï¼Œä»deploy åˆ°pvåˆ°serviceï¼Œä¹Ÿè®¸ä»–ä¸ªåˆ«ç»†èŠ‚å’Œè¯æ³•å¯èƒ½ä¼šå†™é”™ï¼Œå¤§ä½“å†™å‡ºæ¥æ˜¯ä¸€ç‚¹é—®é¢˜éƒ½æ²¡æœ‰çš„ï¼ŒæœŸé—´å®Œå…¨ä¸ç”¨å‚è€ƒæ–‡æ¡£ã€‚æˆ‘è¦è¯´çš„æ˜¯ckaçš„åŸºæœ¬æŠ€èƒ½éå¸¸è¿‡ç¡¬ã€‚</li><li>æˆªè‡³åˆ°ç°åœ¨ï¼Œæˆ‘æ²¡æœ‰è§è¿‡ä»»ä½•ç»„ç»‡å’Œä¸ªäººæä¾›ckaå¿…è¿‡æ‰‹å†Œï¼ˆä¹Ÿå°±æ˜¯ä¼ è¯´ä¸­çš„bibleï¼‰ã€‚è¿™ä¸ªè®¤è¯è¯ç”Ÿä¹Ÿå°±ä¸€ã€ä¸¤å¹´çš„æ—¶é—´ï¼Œ å› æ­¤ç°åœ¨é€šè¿‡çš„äººéƒ½æ˜¯è´§çœŸä»·å®è€ƒå‡ºæ¥çš„ï¼ˆç›¸å¯¹äºå…¶ä»–å…¬å¸çš„æŸcmï¼ŒæŸæŸcaç­‰ç­‰ï¼‰ï¼Œè¿™ä¸ªä»·å€¼ä¼šä½“ç°åœ¨è¯ä¹¦ç¼–å·ä¸Šã€‚å†è¿‡å‡ å¹´ï¼Œä»¥æˆ‘ä»¬ä¸­å›½äººçš„è€ƒè¯•èƒ½åŠ›æ¥è¯´ï¼Œä½ æ‡‚çš„â€¦</li><li>æœ¬è€ƒè¯•ä»æŠ¥åè€ƒè¯•åˆ°æ¥æ´½å‚è€ƒï¼Œå…¨ç¨‹è‹±æ–‡äº¤æµï¼Œèƒ½è€ƒè¿‡çš„äººè‹±æ–‡æ°´å¹³è¿˜ç®—è¯´å¾—è¿‡å»å§ã€‚</li></ol><h1 id="æˆ‘çš„å­¦ä¹ è¿‡ç¨‹ã€é€”å¾„"><a href="#æˆ‘çš„å­¦ä¹ è¿‡ç¨‹ã€é€”å¾„" class="headerlink" title="æˆ‘çš„å­¦ä¹ è¿‡ç¨‹ã€é€”å¾„:"></a>æˆ‘çš„å­¦ä¹ è¿‡ç¨‹ã€é€”å¾„:</h1><ul><li>å…¶å®æ—©åœ¨2015å¹´å°±åœ¨æ¥è§¦å®¹å™¨æŠ€æœ¯ï¼Œä»LXCåˆ°Dockerå†åˆ°ç°åœ¨çš„kubernetes, æ—¥å¸¸å·¥ä½œä¸­çš„ä¹Ÿå°½é‡æŠŠä¸€äº›åº”ç”¨åšæˆdockerå»è·‘ï¼›çœä¸‹äº†ä¸å°‘ç²¾åŠ›æ—¶é—´å»åšä¸€äº›é‡å¤å¤æ‚æ€§çš„å·¥ä½œï¼›æ¯”å¦‚ä»¥å‰è·‘ä¸ªgitLabçš„ç¯å¢ƒï¼Œäº¦æˆ–æ˜¯æƒ³è¦ä¸ªPythonåº”ç”¨è¿è¡Œçš„ç¯å¢ƒï¼Œé™¤äº†è¦æŠŠæœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œè¿˜éœ€è¦ä¸€äº›ç¹ççš„é…ç½®ï¼Œæœ‰äº†dockerä¹‹åï¼Œé€šè¿‡<code>dockerfile/docker-compose</code>å°±å¯ä»¥å¾ˆè½»æ¾çš„å®ç°ä¸€äº›åº”ç”¨è·‘åœ¨å®¹å™¨é‡Œé¢äº†ã€‚2018å¹´5æœˆä»½å¼€å§‹ç ”ç©¶å­¦ä¹ kubernetesç›¸å…³ä¸œè¥¿ï¼Œè™½ç„¶å­¦ä¹ å¾—ä¸æ˜¯å¾ˆç³»ç»Ÿï¼Œä½†æ˜¯è¿˜æ˜¯å®Œæˆäº†ä¸€ä¸ªå°å°çš„é¡¹ç›®ï¼Œæ„Ÿå…´è¶£çš„ç‚¹<a href="https://github.com/guomaoqiu/flask_kubernetes">è¿™é‡Œ</a> å¯ä»¥ä½œä¸ºå­¦ä¹ ç»ƒä¹ çš„é¡¹ç›®;æ—¢ç„¶å­¦äº†å°±è¦ç”¨ä¸Šï¼›ä¸ç„¶ä¹Ÿæ˜¯å¾’åŠ³ã€‚</li><li>K8s.ioé‡Œé¢tasksç›¸å…³çš„ä¸œè¥¿éƒ½éœ€è¦è‡ªå·±å®è·µä¸‹ï¼Œè¿˜æ˜¯æœ‰äº›æ—¥å¸¸æ²¡æ€ä¹ˆç”¨åˆ°çš„,æœ€å¥½æŠŠæ•´ä¸ªæ–‡æ¡£éƒ½çœ‹ä¸€éã€‚</li><li>å®‹å¤§ç¥çš„åšå®¢: <a href="https://jimmysong.io/kubernetes-handbook/">https://jimmysong.io/kubernetes-handbook/</a></li><li>å­¦ä¹ å®æ“ç¯å¢ƒåšæœ€å¥½æ˜¯é€šè¿‡äºŒè¿›åˆ¶çš„æ–¹å¼æ¥æ­å»ºï¼Œæ¯•ç«Ÿå¦‚æœä½ ä½¿ç”¨kubeadmæ¥æ­å»ºçš„è¯å¾ˆå¤šçš„äº‹æƒ…å®ƒå·²ç»å¸®ä½ å®Œæˆè®¾å®šäº†ï¼Œä¹Ÿå°±æ²¡ç†è§£ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšã€‚æ¯ä¸ªç»„ä»¶ç»“åˆèµ·æ¥ä¹‹åæ•´ä¸ªæ¶æ„åœ¨è„‘å­é‡Œé¢å°±ä¼šéå¸¸çš„æ¸…æ¥šï¼Œæ’é”™èµ·æ¥ä¹Ÿæ›´åŠ å®¹æ˜“ä¸€äº›ã€‚è€ƒè¯•ä¸éš¾ï¼Œåªè¦ç»è¿‡å¤§é‡çš„å®è·µç»ƒä¹ å°±å¯ä»¥å•¦~</li></ul><p><em><strong>æ³¨:</strong></em> è¿™æ¬¡CKAè€ƒè¯•ï¼Œæˆ‘æ²¡æœ‰å‚åŠ ä»»ä½•å›½å†…åŸ¹è®­ï¼Œä¸»è¦æ˜¯æ ¹æ®è€ƒè¯•å¤§çº²ã€å®˜æ–¹æ–‡æ¡£ä»¥åŠCNCFæ¨å‡ºçš„ä¸€å¥—<a href="https://www.edx.org/course/introduction-to-kubernetes">å…è´¹è¯¾ç¨‹</a>è¿›è¡Œè‡ªå­¦ã€‚</p><h1 id="è€ƒå‰æ³¨æ„äº‹é¡¹"><a href="#è€ƒå‰æ³¨æ„äº‹é¡¹" class="headerlink" title="è€ƒå‰æ³¨æ„äº‹é¡¹"></a>è€ƒå‰æ³¨æ„äº‹é¡¹</h1><ul><li>è€ƒè¯•å¹³å°æ˜¯ç”±CNCFå§”æ‰˜çš„ä¸€ä¸ªè®¡ç®—æœºæ–¹é¢éå¸¸ä¸“ä¸šçš„æœåŠ¡å•†<a href="https://www.examslocal.com/">PSI</a>æ¥è¿›è¡Œç›‘ç£è€ƒè¯•ï¼›</li><li>å®˜æ–¹è®¤è¯è¯ä»¶ï¼šéœ€è¦æœ‰ç…§ç‰‡å’ŒLatinå­—æ¯å†™çš„å…¨åï¼Œæˆ‘ç”¨çš„æ˜¯æŠ¤ç…§;</li><li>è€ƒè¯•ä¸­ä¸èƒ½å–æ°´ã€åƒä¸œè¥¿ï¼Œå¯ä»¥ç”³è¯·ä¼‘æ¯ï¼Œä½†æ˜¯ä¸æ¸…æ¥šèƒ½ä¸èƒ½ç¦»å¼€æ‘„åƒå¤´ç›‘è§†èŒƒå›´å†…ï¼Œæ²¡è¯·è¿‡ï¼Œåæ­£æˆ‘å…¨ç¨‹æ— å°¿ç‚¹ã€‚</li><li>è€ƒè¯•çš„ç½‘é¡µä¸€åŠæ˜¯è¯•é¢˜ã€ä¸€åŠæ˜¯GateOneçš„ç»ˆç«¯ç•Œé¢ï¼Œæœ€å¥½èƒ½æœ‰ä¸€å°macç”µè„‘ç„¶åå¤–æ¥æ˜¾ç¤ºå™¨ã€é”®ç›˜ï¼Œé¼ æ ‡ï¼Œmacç³»ç»Ÿæ¯”windowsæœ‰ä¼˜åŠ¿ï¼Œå†ä¸€ä¸ªå°±æ˜¯ç»ˆç«¯å°±æ˜¾å¾—ä¸æ˜¯å¾ˆå°äº†ï¼Œæ“ä½œä¹Ÿé¡ºæ‰‹; (å¦å¤–ä¸ºäº†æå‰ç†Ÿæ‚‰ä½¿ç”¨gateoneç»ˆç«¯æˆ‘è¿™é‡Œä¹Ÿåšäº†ä¸€ä¸ª<a href="https://github.com/guomaoqiu/kubectl-terminal">é•œåƒ</a>ï¼Œå…·ä½“é£Ÿç”¨æ–¹æ³•å‚è§README.md)</li><li>ä¸€ä¸ªæ²¡æœ‰å…¶ä»–äººçš„ç©ºæˆ¿é—´ï¼Œç©ºæ¡Œå­ï¼Œä¸èƒ½å¸¦æ‰‹æœºï¼Œä¸èƒ½æœ‰ä¹¦æœ¬ï¼Œç›‘è€ƒå®˜ä¼šè®©ä½ æ‹¿ç€ç”µè„‘å±•ç¤ºä½ å‘¨å›´çš„æ‰€æœ‰ç¯å¢ƒï¼Œæˆ‘çš„è€ƒè¯•æ˜¯é¢„çº¦åœ¨å‘¨æœ«ä¸‹åˆåœ¨å…¬å¸ä¸€ä¸ªä¼šè®®å®¤å®Œæˆçš„;</li><li>æŒ‰ç…§å®˜æ–¹è€ƒè¯•æµç¨‹æŒ‡å¯¼è¿˜éœ€è¦åšä¸€ä¸‹ç¡¬ä»¶è¦æ±‚æ€§çš„æµ‹è¯•: ä½¿ç”¨Chromeæµè§ˆå™¨è®¿é—®<a href="https://www.examslocal.com/ScheduleExam/Home/CompatibilityCheck">https://www.examslocal.com/ScheduleExam/Home/CompatibilityCheck</a> é€‰æ‹©â€Linux Foundationâ€ as the Exam Sponsor and â€œCKAâ€ as the Examæ ¹æ®æç¤ºå®‰è£…ä¸€ä¸ªchromeæ’ä»¶ï¼ˆå®æµ‹æœ‰é¡¹ç½‘é€Ÿçš„æ£€æŸ¥ï¼Œéœ€è¦æœ‰ä¸ªç¨³å®šçš„ç§‘å­¦ä¸Šç½‘å·¥å…·ï¼‰</li><li>180åˆ†é’Ÿï¼Œ24é“é¢˜(æ¶µç›–æ‰€æœ‰k8såŸºç¡€çŸ¥è¯†ç‚¹),å¹³å‡ä¸€é“é¢˜7.5åˆ†é’Ÿï¼Œæ—¶é—´æ˜¯éå¸¸ç´§çš„ï¼›ä¸€é“é¢˜åšå®Œè¦å»éªŒè¯ï¼Œæœ‰æŠŠæ¡æ²¡é—®é¢˜çš„å°±æœæ–­ä¸‹ä¸€é¢˜ï¼Œåƒä¸‡ä¸è¦çŠ¹è±«ï¼›æ‰“è„‘å£³çš„é‚£ç§é¢˜è®°ä½é¢˜å·ï¼Œåšå®Œç®€å•çš„åœ¨å›è¿‡å¤´æ¥æ•´ã€‚</li></ul><h1 id="è€ƒè¯•ç»“æŸæ³¨æ„äº‹é¡¹"><a href="#è€ƒè¯•ç»“æŸæ³¨æ„äº‹é¡¹" class="headerlink" title="è€ƒè¯•ç»“æŸæ³¨æ„äº‹é¡¹"></a>è€ƒè¯•ç»“æŸæ³¨æ„äº‹é¡¹</h1><p>åœ¨è€ƒè¯•ç»“æŸä¹‹åï¼Œ36ä¸ªå°æ—¶ä¹‹å†…ï¼ŒCNCFå°±ä¼šé€šè¿‡é‚®ä»¶å‘Šè¯‰ä½ è€ƒè¯•æˆç»©äº†ï¼Œå¦‚æœä½ çš„åˆ†æ•°å¤§äº74%ï¼Œé‚£ä¹ˆæ­å–œä½ é€šè¿‡äº†ï¼å¹¶ä¸”é™„ä»¶å°±ç›´æ¥ä¼šæœ‰ä½ çš„é€šè¿‡çš„è¯ä¹¦ã€‚å¦‚æœè€ƒè¯•ä¸é€šè¿‡ï¼Œä½ çš„è´¦å·ä¸Šå°±ä¼šç›´æ¥æœ‰ä¸€æ¬¡<code>Free Retake</code>è€ƒè¯•çš„æœºä¼šã€‚<br><img src="/2019/01/07/road-to-cka/score.png"></p><p>ğŸ˜¢ä¸¢äº†3åˆ†ï¼Œå®˜æ–¹ä¹Ÿä¸ä¼šå‘Šè¯‰ä½ åˆ°åº•é”™åœ¨å“ªé‡Œäº†ï¼›å°±åªæœ‰è¿™ä¹ˆä¸€ä¸ªæˆç»©è·Ÿè¯ä¹¦å‘è¿‡æ¥ã€‚</p><hr><p>ä»¥ä¸Šï¼Œå¸Œæœ›å¯ä»¥å¸®åˆ°ä½ ã€‚</p><p>ps: <em><del>_</del>è¯¥è€ƒè¯•ç­¾è®¢äº†ä¿å¯†åè®®ï¼ŒSo è€ƒè¯•åŸé¢˜æ— æ³•åˆ†äº«~~~_~~</em></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> CKA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨Bootstrap Tokenå®ŒæˆTLS Bootstrapping</title>
      <link href="/2018/12/30/kubernetes-bootstrapping/"/>
      <url>/2018/12/30/kubernetes-bootstrapping/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦è®°å½•ä¸€ä¸‹æ­å»ºä¸€ä¸ªkubeletæ­å»ºåˆ°åŠ å…¥é›†ç¾¤åˆ°æ‰‹åŠ¨ã€è‡ªåŠ¨(è¯ä¹¦è½®æ¢çš„)è¯ä¹¦è®¤è¯è¿‡ç¨‹, é‚£ä¹ˆæˆ‘çš„ç¯å¢ƒæ˜¯ç”¨çš„v1.12.4ç‰ˆæœ¬ï¼Œæœ‰ä¸€å°master,é™¤äº†masterä¸Šé¢çš„ä¸€äº›ç»„ä»¶å·²ç»æ­å»ºå®Œæ¯•ï¼Œä¸»è¦é‡ç‚¹æ˜¯åœ¨kubeletä¸Šé¢ï¼Œæ‰€ä»¥ç°åœ¨å°±æ˜¯masterå·²ç»å·¥ä½œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼ŒåŠ å…¥æ–°çš„<code>kubelet(workerèŠ‚ç‚¹)</code>éœ€è¦åšä¸€äº›ä»€ä¹ˆæ ·çš„æ“ä½œã€‚<br>ç„¶åéœ€è¦å®ç°çš„æ˜¯:</p><ul><li>é€šè¿‡bootstrap tokenä»¥åŠboostrap.kubeconfigæ¥å¼•å¯¼workerèŠ‚ç‚¹ç”³è¯·è¯ä¹¦</li><li>å¦‚æœç¬¬ä¸€æ­¥ç”³è¯·å‘å‡ºå»ä¹‹åï¼Œåœ¨æ‰‹åŠ¨åœ¨masterç«¯è¿›è¡Œæ‰‹åŠ¨æ‰¹å‡†è¯ä¹¦ç”³è¯·ï¼Œç„¶åå‘æ”¾kubeletè¯ä¹¦</li><li>å®ç°kubeletè¯ä¹¦çš„è‡ªåŠ¨æ‰¹å‡†</li><li>å®ç°kubeletè¯ä¹¦çš„è‡ªåŠ¨è½®æ¢æ“ä½œ<br><img src="/2018/12/30/kubernetes-bootstrapping/start.png"></li></ul><p><strong>ç®€å•ç†ä¸€ä¸‹TLS Bootstrappingçš„ä¸€ä¸ªå¼•å¯¼è¿‡ç¨‹</strong></p><ol><li>masterç«¯åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯å³ç”Ÿæˆ <code>apiserver.pem/apiserver-key.pem/apiserver.csr</code>;</li><li>åœ¨é›†ç¾¤å†…åˆ›å»ºç‰¹å®šçš„ Bootstrap Token Secretï¼Œè¯¥ Secret å°†æ›¿ä»£ä»¥å‰çš„ token.csv å†…ç½®ç”¨æˆ·å£°æ˜æ–‡ä»¶;</li><li>åœ¨é›†ç¾¤å†…åˆ›å»ºé¦–æ¬¡ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„ ClusterRole å³<code>system:node-bootstrapper</code>,å¹¶å°†ä¸Šé¢çš„bootstrap token secretè¿›è¡Œç»‘å®šå³ clusterrolebinding <code>kubelet-bootstrap</code>ï¼Œè¿™æ ·é€šè¿‡ç»‘å®šå°±èƒ½ä»¥è¿™ä¸ªå†…ç½®ç”¨æˆ·ç»„ä¿¡æ¯å»å‘èµ·CSRè¯·æ±‚å•¦ï¼›</li><li>ç”Ÿæˆç‰¹å®šçš„åŒ…å« <code>TLS Bootstrapping Token</code> çš„ <code>bootstrap.kubeconfig</code>;</li><li>è°ƒæ•´kubeleteå¯åŠ¨å‚æ•°ï¼ŒæŒ‡å®šå¼•å¯¼æ–‡ä»¶<code>bootstrap.kubeconfig</code>;</li><li>é‡è½½é…ç½®ã€é‡å¯æœåŠ¡ï¼Œmasterç«¯æ‰‹åŠ¨æ‰¹å‡†å®ŒæˆworkerèŠ‚ç‚¹çš„CSRè¯·æ±‚;</li><li>åç»­å¦‚æœæ²¡æœ‰é…ç½®è¯ä¹¦è½®æ¢çš„è¯ï¼Œå°±ä¼šä¸€ç›´ä½¿ç”¨ç”±controller-manageræ‰¹å‡†é¢å‘çš„è¯ä¹¦æ–‡ä»¶äº†ï¼Œæœ‰æ•ˆæœŸæ˜¯ä¸€å¹´ã€‚(è‡ªåŠ¨æ‰¹å‡†&amp;è¯ä¹¦è½®æ¢ä¸‹é¢å†è¯´)</li></ol><p>å½“ç„¶ä»¥æˆ‘çš„ç†è§£è¦è¦å®ç°è¯ä¹¦è½®æ¢é‚£ä¹ˆè‚¯å®šæ˜¯æ²¡æœ‰å¤–ç•Œå¹²é¢„çš„æƒ…å†µä¸‹è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œé‚£è¿™ä¸ªåŠŸèƒ½ä¹Ÿè‚¯å®šæ˜¯éœ€è¦è‡ªåŠ¨æ‰¹å‡†è¿™ä¸ªåŠŸèƒ½çš„ã€‚</p><p>é‚£ä¹ˆè‡ªåŠ¨æ‰¹å‡†éœ€è¦åšçš„ä¸€äº›äº‹æƒ…å´æ˜¯åœ¨æ‰‹åŠ¨æ‰¹å‡†çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›æ“ä½œ:</p><ol><li>åˆ›å»ºCSRè¯·æ±‚çš„ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„renew Kubelet client/server çš„ ClusterRoleï¼Œä»¥åŠå…¶ç›¸å…³å¯¹åº”çš„ ClusterRoleBindingï¼›å¹¶ç»‘å®šåˆ°å¯¹åº”çš„ç»„æˆ–ç”¨æˆ·</li><li>è°ƒæ•´ Controller Manager é…ç½®ï¼Œä»¥ä½¿å…¶èƒ½è‡ªåŠ¨ç­¾ç½²ç›¸å…³è¯ä¹¦å’Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ TLS Bootstrapping Token</li><li>å¯é€‰çš„: é›†ç¾¤æ­å»ºæˆåŠŸåç«‹å³æ¸…é™¤ Bootstrap Token Secretï¼Œæˆ–ç­‰å¾… Controller Manager å¾…å…¶è¿‡æœŸååˆ é™¤ï¼Œä»¥é˜²æ­¢è¢«æ¶æ„åˆ©ç”¨</li></ol><h1 id="äºŒã€æ‰‹åŠ¨æ‰¹å‡†"><a href="#äºŒã€æ‰‹åŠ¨æ‰¹å‡†" class="headerlink" title="äºŒã€æ‰‹åŠ¨æ‰¹å‡†"></a>äºŒã€æ‰‹åŠ¨æ‰¹å‡†</h1><h2 id="2-1-åˆ›å»ºAPI-Serverå’ŒKubelet-Clienté€šä¿¡å‡­è¯"><a href="#2-1-åˆ›å»ºAPI-Serverå’ŒKubelet-Clienté€šä¿¡å‡­è¯" class="headerlink" title="2.1 åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯"></a>2.1 åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯</h2><p>æˆ‘è¿™é‡Œå·²ç»æœ‰caæ ¹è¯ä¹¦æ–‡ä»¶äº†ï¼Œé‚£å°±ä»åˆ›å»ºapiserverè¯ä¹¦å¼€å§‹</p><figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> <span class="built_in">cat</span> &gt;&gt; apiserver<span class="literal">-csr</span>.json &lt;&lt; EOF</span><br><span class="line">{</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kube-apiserver"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"10.96.0.1"</span>,</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"192.168.56.201"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: {</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Hangzhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Hangzhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes-manual"</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘è¿™é‡Œå°±å•å°master,æ‰€ä»¥å°±å†™äº†ä¸ªè¿™ä¸€ä¸ªIPåœ°å€</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»º:</span></span><br><span class="line"><span class="variable">$cfssl</span> gencert \</span><br><span class="line">  -ca=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>ca.pem \</span><br><span class="line">  -ca-key=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>ca-key.pem \</span><br><span class="line">  -config=ca-config.json \</span><br><span class="line">  -profile=kubernetes \</span><br><span class="line">  apiserver-csr.json | cfssljson -bare <span class="variable">${PKI_DIR}</span>/apiserver</span><br><span class="line"></span><br><span class="line">ls <span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>apiserver*.pem</span><br><span class="line"><span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>apiserver-key.pem  <span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>apiserver.pem</span><br></pre></td></tr></tbody></table></figure><h2 id="2-2-åˆ›å»ºå¼•å¯¼é…ç½®æ–‡ä»¶-bootstrap-kubelet-kubeconfig"><a href="#2-2-åˆ›å»ºå¼•å¯¼é…ç½®æ–‡ä»¶-bootstrap-kubelet-kubeconfig" class="headerlink" title="2.2 åˆ›å»ºå¼•å¯¼é…ç½®æ–‡ä»¶ bootstrap-kubelet.kubeconfig"></a>2.2 åˆ›å»ºå¼•å¯¼é…ç½®æ–‡ä»¶ bootstrap-kubelet.kubeconfig</h2><h3 id="2-2-1-ç”Ÿæˆbootsrapâ€”token"><a href="#2-2-1-ç”Ÿæˆbootsrapâ€”token" class="headerlink" title="2.2.1 ç”Ÿæˆbootsrapâ€”token"></a>2.2.1 ç”Ÿæˆbootsrapâ€”token</h3><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">TOKEN_ID</span>=$(openssl rand 3 -hex)</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">TOKEN_SECRET</span>=$(openssl rand 8 -hex)</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">BOOTSTRAP_TOKEN</span>=<span class="variable">${TOKEN_ID}</span>.${TOKEN_SECRET}</span><br></pre></td></tr></tbody></table></figure><p>å…³äºè¿™ä¸ªtokençš„æ ¼å¼è¦æ±‚å‚è§<a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#token-format">è¿™é‡Œ</a></p><h3 id="2-2-2-åˆ›å»ºboostrap-token-secret"><a href="#2-2-2-åˆ›å»ºboostrap-token-secret" class="headerlink" title="2.2.2 åˆ›å»ºboostrap token secret"></a>2.2.2 åˆ›å»ºboostrap token secret</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> bootstrap-token-Secret.yml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Secret</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> bootstrap-token-{TOKEN_ID}</span><br><span class="line">  <span class="params">namespace:</span> kube-system</span><br><span class="line"><span class="params">type:</span> bootstrap.kubernetes.io<span class="symbol">/token</span></span><br><span class="line"><span class="params">stringData:</span></span><br><span class="line">  <span class="params">token-id:</span> {TOKEN_ID}</span><br><span class="line">  <span class="params">token-secret:</span> {TOKEN_SECRET}</span><br><span class="line">  <span class="params">usage-bootstrap-authentication:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="params">usage-bootstrap-signing:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="params">auth-extra-groups:</span> system:bootstrappers:default-node-token</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ä»¥ä¸Šå˜é‡èµ‹å€¼è¿›å»</span></span><br><span class="line">sed <span class="operator">-</span>ri <span class="string">"s#<span class="char escape_">\{</span>TOKEN_ID<span class="char escape_">\}</span>#<span class="subst">${TOKEN_ID}</span>#g"</span> bootstrap-token-Secret.yml</span><br><span class="line">sed <span class="operator">-</span>ri <span class="string">"/token-id/s#<span class="char escape_">\S</span>+<span class="char escape_">\$</span>#'&amp;'#"</span> resources<span class="symbol">/bootstrap-token-Secret.yml</span></span><br><span class="line">sed <span class="operator">-</span>ri <span class="string">"s#<span class="char escape_">\{</span>TOKEN_SECRET<span class="char escape_">\}</span>#<span class="subst">${TOKEN_SECRET}</span>#g"</span> resources<span class="symbol">/bootstrap-token-Secret.yml</span></span><br><span class="line">kubectl create <span class="operator">-</span>f resources<span class="symbol">/bootstrap-token-Secret.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¯¦æƒ…ï¼Œä¸€å®šè¦æ”¾åˆ°kube-systemè¿™ä¸ªnamespace</span></span><br><span class="line">$ kubectl describe secret  bootstrap-token-b8cf79 <span class="operator">-</span>n kube-system</span><br><span class="line"><span class="params">Name:</span>         bootstrap-token-b8cf79</span><br><span class="line"><span class="params">Namespace:</span>    kube-system</span><br><span class="line"><span class="params">Labels:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span></span><br><span class="line"><span class="params">Type:</span>         bootstrap.kubernetes.io<span class="symbol">/token</span></span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line"><span class="operator">==</span><span class="operator">==</span></span><br><span class="line"><span class="params">auth-extra-groups:</span>               <span class="number">39</span> bytes</span><br><span class="line"><span class="params">token-id:</span>                        <span class="number">6</span> bytes</span><br><span class="line"><span class="params">token-secret:</span>                    <span class="number">16</span> bytes</span><br><span class="line"><span class="params">usage-bootstrap-authentication:</span>  <span class="number">4</span> bytes</span><br><span class="line"><span class="params">usage-bootstrap-signing:</span>         <span class="number">4</span> bytes</span><br></pre></td></tr></tbody></table></figure><h3 id="2-2-2-åˆ›å»ºå¯åŠ¨å¼•å¯¼é…ç½®"><a href="#2-2-2-åˆ›å»ºå¯åŠ¨å¼•å¯¼é…ç½®" class="headerlink" title="2.2.2 åˆ›å»ºå¯åŠ¨å¼•å¯¼é…ç½®"></a>2.2.2 åˆ›å»ºå¯åŠ¨å¼•å¯¼é…ç½®</h3><figure class="highlight dsconfig"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bootstrap set cluster</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-cluster</span> <span class="string">kubernetes</span> \</span><br><span class="line">    <span class="built_in">--certificate-authority=/etc/kubernetes/pki/ca.pem</span> \</span><br><span class="line">    <span class="built_in">--embed-certs=true</span> \</span><br><span class="line">    <span class="built_in">--server=192.168.56.202</span> \</span><br><span class="line">    <span class="built_in">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bootstrap set credentials</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-credentials</span> <span class="string">tls-bootstrap-token-user</span> \</span><br><span class="line">    <span class="built_in">--token=${BOOTSTRAP_TOKEN}</span> \</span><br><span class="line">    <span class="built_in">--kubeconfig=/etc/kubernetes//bootstrap-kubelet.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bootstrap set context</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-context</span> <span class="string">tls-bootstrap-token-user</span>@<span class="string">kubernetes</span> \</span><br><span class="line">    <span class="built_in">--cluster=kubernetes</span> \</span><br><span class="line">    <span class="built_in">--user=tls-bootstrap-token-user</span> \</span><br><span class="line">    <span class="built_in">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bootstrap use default context</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="string">use-context</span> <span class="string">tls-bootstrap-token-user</span>@<span class="string">kubernetes</span> \</span><br><span class="line">    <span class="built_in">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span><br></pre></td></tr></tbody></table></figure><p>è¯¥æ–‡ä»¶ç”Ÿæˆä¹‹åéœ€è¦æ‹·è´è‡³workerèŠ‚ç‚¹ä¸Šé¢å»ï¼Œå¹¶ä¸”ä¿®æ”¹é…ç½®ï¼ŒæŒ‡å®šè¯¥å¼•å¯¼é…ç½®æ–‡ä»¶<br>è¿™ä¸ªæµç¨‹åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæœ‰æè¿°:<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#bootstrap-initialization">bootstrapåˆå§‹åŒ–è¿‡ç¨‹</a></p><h3 id="2-2-3-è°ƒæ•´workerèŠ‚ç‚¹kubeletå¯åŠ¨é…ç½®æ–‡ä»¶åŠ ä¸Šè¿™ä¸ªå¼•å¯¼æ–‡ä»¶-å‚æ•°"><a href="#2-2-3-è°ƒæ•´workerèŠ‚ç‚¹kubeletå¯åŠ¨é…ç½®æ–‡ä»¶åŠ ä¸Šè¿™ä¸ªå¼•å¯¼æ–‡ä»¶-å‚æ•°" class="headerlink" title="2.2.3 è°ƒæ•´workerèŠ‚ç‚¹kubeletå¯åŠ¨é…ç½®æ–‡ä»¶åŠ ä¸Šè¿™ä¸ªå¼•å¯¼æ–‡ä»¶(å‚æ•°)"></a>2.2.3 è°ƒæ•´workerèŠ‚ç‚¹kubeletå¯åŠ¨é…ç½®æ–‡ä»¶åŠ ä¸Šè¿™ä¸ªå¼•å¯¼æ–‡ä»¶(å‚æ•°)</h3><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/kubelet</span><br><span class="line">  <span class="attr">--kubeconfig</span>=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  <span class="attr">--network-plugin</span>=cni \</span><br><span class="line">  <span class="attr">--cni-conf-dir</span>=/etc/cni/net.d \</span><br><span class="line">  <span class="attr">--cni-bin-dir</span>=/opt/cni/bin \</span><br><span class="line">  <span class="attr">--logtostderr</span>=<span class="literal">false</span> \</span><br><span class="line">  <span class="attr">--log-dir</span>=/etc/kubernetes/log \</span><br><span class="line">  <span class="attr">--config</span>=/etc/kubernetes/kubelet-conf.yml \</span><br><span class="line">  <span class="attr">--node-labels</span>=node-role.kubernetes.io/master=<span class="string">''</span> \</span><br><span class="line">  <span class="attr">--pod-infra-container-image</span>=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:<span class="number">3.1</span> \</span><br><span class="line">  <span class="attr">--v</span>=<span class="number">2</span></span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ—¶å¦‚æœå¯åŠ¨kubeletæœåŠ¡çš„è¯åœ¨apiserverå°†ä¼šæŠ¥é”™ï¼š<br><img src="/2018/12/30/kubernetes-bootstrapping/forbidden.jpg"></p><p>è¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œkubelet é€šè¿‡ bootstrap.kubeconfig ä¸­çš„é¢„è®¾ç”¨æˆ· Token å£°æ˜äº†è‡ªå·±çš„èº«ä»½ï¼Œç„¶ååˆ›å»º CSR è¯·æ±‚ï¼›ä½†æ˜¯ä¸è¦å¿˜è®°è¿™ä¸ªç”¨æˆ·åœ¨æˆ‘ä»¬ä¸å¤„ç†çš„æƒ…å†µä¸‹ä»–æ²¡ä»»ä½•æƒé™çš„ï¼ŒåŒ…æ‹¬åˆ›å»º CSR è¯·æ±‚ï¼›æ‰€ä»¥éœ€è¦å¦‚ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ª ClusterRoleBindingï¼Œå°†é¢„è®¾ç”¨æˆ· kubelet-bootstrap ä¸å†…ç½®çš„ ClusterRole system:node-bootstrapper ç»‘å®šåˆ°ä¸€èµ·ï¼Œä½¿å…¶èƒ½å¤Ÿå‘èµ· CSR è¯·æ±‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> kubelet-bootstrap-clusterrolebinding.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> kubelet-bootstrap</span><br><span class="line"><span class="params">roleRef:</span></span><br><span class="line">  <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line">  <span class="params">kind:</span> ClusterRole</span><br><span class="line">  <span class="params">name:</span> system:node-bootstrapper</span><br><span class="line"><span class="params">subjects:</span></span><br><span class="line"><span class="operator">-</span> <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line">  <span class="params">kind:</span> Group</span><br><span class="line">  <span class="params">name:</span> system:bootstrappers:default-node-token</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>å°†ä¸Šé¢åˆ›å»ºåå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡æ‰‹åŠ¨æ‰¹å‡†ä¹‹åworkerèŠ‚ç‚¹å°±åŠ å…¥åˆ°é›†ç¾¤å½“ä¸­æ¥äº†<br><img src="/2018/12/30/kubernetes-bootstrapping/result.jpg"><br>è€Œä¸”åœ¨workerèŠ‚ç‚¹çš„/var/lib/kubelet/pkiç›®å½•ä¸‹å·²ç»è·å¾—controller-manageré¢å‘ä¸‹æ¥çš„è¯ä¹¦,å¹¶ä¸”è¿˜åˆ†å‘äº†ä¸€ä¸ªkubelet.kubeconfigçš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶è™½ç„¶é…ç½®ä¸­æŒ‡å®šäº†ï¼Œä½†è¿™ä¸ªä¹Ÿæ˜¯ç”±controller-manageråˆ†å‘ç»™workerèŠ‚ç‚¹çš„ã€‚</p><figure class="highlight tap"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n0 kubernetes]<span class="comment"># ll /var/lib/kubelet/pki/</span></span><br><span class="line">total 12</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 1293 </span>Dec<span class="number"> 30 </span>10:14 kubelet-client-2018-12-30-10-14-50.pem</span><br><span class="line">lrwxrwxrwx<span class="number"> 1 </span>root root  <span class="number"> 59 </span>Dec<span class="number"> 30 </span>10:14 kubelet-client-current.pem -&gt; /var/lib/kubelet/pki/kubelet-client-2018-12-30-10-14-50.pem</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 2153 </span>Dec<span class="number"> 30 </span>10:14 kubelet.crt</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 1679 </span>Dec<span class="number"> 30 </span>10:14 kubelet.key</span><br></pre></td></tr></tbody></table></figure><p>è¿˜æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œé›†ç¾¤å·²ç»å®Œæˆï¼Œåœ¨æˆ‘æ‰§è¡Œexecæƒ³è¿›å…¥ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™å´å‡ºç°äº†forbiddençš„é—®é¢˜:</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m1 resources]# kubectl exec -it kubectl-terminal-ubuntu /bin/bash</span><br><span class="line">error: unable <span class="keyword">to</span><span class="built_in"> upgrade </span>connection: Forbidden (<span class="attribute">user</span>=kube-apiserver, <span class="attribute">verb</span>=create, <span class="attribute">resource</span>=nodes, <span class="attribute">subresource</span>=proxy)</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ˜¯å› ä¸ºkube-apiserveruserå¹¶æ²¡æœ‰nodesçš„èµ„æºå­˜å–æƒé™,å±äºæ­£å¸¸ã€‚ç”±äº API æƒé™,æ•…éœ€è¦å»ºç«‹ä¸€ä¸ª RBAC Role æ¥è·å–å­˜å–æƒé™;</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> apiserver-to-kubelet-rbac.yml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> ClusterRole</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">annotations:</span></span><br><span class="line">    rbac.authorization.kubernetes.io<span class="operator">/</span><span class="params">autoupdate:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    kubernetes.io<span class="operator">/</span><span class="params">bootstrapping:</span> rbac-defaults</span><br><span class="line">  <span class="params">name:</span> system:kube-apiserver-to-kubelet</span><br><span class="line"><span class="params">rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">""</span></span><br><span class="line">    <span class="params">resources:</span></span><br><span class="line">      <span class="operator">-</span> nodes<span class="symbol">/proxy</span></span><br><span class="line">      <span class="operator">-</span> nodes<span class="symbol">/stats</span></span><br><span class="line">      <span class="operator">-</span> nodes<span class="symbol">/log</span></span><br><span class="line">      <span class="operator">-</span> nodes<span class="symbol">/spec</span></span><br><span class="line">      <span class="operator">-</span> nodes<span class="symbol">/metrics</span></span><br><span class="line">    <span class="params">verbs:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"*"</span></span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> system:kube-apiserver</span><br><span class="line">  <span class="params">namespace:</span> <span class="string">""</span></span><br><span class="line"><span class="params">roleRef:</span></span><br><span class="line">  <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line">  <span class="params">kind:</span> ClusterRole</span><br><span class="line">  <span class="params">name:</span> system:kube-apiserver-to-kubelet</span><br><span class="line"><span class="params">subjects:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line">    <span class="params">kind:</span> User</span><br><span class="line">    <span class="params">name:</span> kube-apiserver</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>åˆ›å»ºå¥½ä¹‹åå°±å¯ä»¥execå•¦~</p><p>ä»¥ä¸Šï¼ŒTLS Bootstrappingçš„æ‰‹åŠ¨æ‰¹å‡†å·²ç»å®Œæˆã€‚</p><h1 id="ä¸‰ã€è‡ªåŠ¨æ‰¹å‡†"><a href="#ä¸‰ã€è‡ªåŠ¨æ‰¹å‡†" class="headerlink" title="ä¸‰ã€è‡ªåŠ¨æ‰¹å‡†"></a>ä¸‰ã€è‡ªåŠ¨æ‰¹å‡†</h1><p>ä¸Šé¢å·²ç»å®Œæˆäº†æ‰‹åŠ¨æ‰¹å‡†çš„æ“ä½œï¼Œé‚£æ¥ä¸‹æ¥å°±æ˜¯å®ç°ä»¥ä¸‹è‡ªåŠ¨æ‰¹å‡†ä»¥åŠè¯ä¹¦è½®æ¢çš„å®ç°</p><p>ä¸Šé¢éœ€è¦çš„é…ç½®å…¶å®éƒ½å·®ä¸å¤šäº†ï¼Œåªéœ€è¦å†åšä¸€äº›é…ç½®å³å¯å®Œæˆï¼›</p><p>kubelet æ‰€å‘èµ·çš„ CSR è¯·æ±‚æ˜¯ç”± controller manager ç­¾ç½²çš„ï¼›å¦‚æœæƒ³è¦æ˜¯å®ç°è‡ªåŠ¨ç»­æœŸï¼Œå°±éœ€è¦è®© controller manager èƒ½å¤Ÿåœ¨ kubelet å‘èµ·è¯ä¹¦è¯·æ±‚çš„æ—¶å€™è‡ªåŠ¨å¸®åŠ©å…¶ç­¾ç½²è¯ä¹¦ï¼›é‚£ä¹ˆ controller manager ä¸å¯èƒ½å¯¹æ‰€æœ‰çš„ CSR è¯ä¹¦ç”³è¯·éƒ½è‡ªåŠ¨ç­¾ç½²ï¼Œè¿™æ—¶å€™å°±éœ€è¦é…ç½® RBAC è§„åˆ™ï¼Œä¿è¯ controller manager åªå¯¹ kubelet å‘èµ·çš„ç‰¹å®š CSR è¯·æ±‚è‡ªåŠ¨æ‰¹å‡†å³å¯ï¼›åœ¨ TLS bootstrapping å®˜æ–¹æ–‡æ¡£ä¸­ï¼ŒCSRæœ‰ä¸‰ç§è¯·æ±‚ç±»å‹:</p><ul><li>nodeclient: kubelet ä»¥ O=system:nodes å’Œ CN=system:node:(node name) å½¢å¼å‘èµ·çš„ CSR è¯·æ±‚</li><li>selfnodeclient: kubelet client renew è‡ªå·±çš„è¯ä¹¦å‘èµ·çš„ CSR è¯·æ±‚(ä¸ä¸Šä¸€ä¸ªè¯ä¹¦å°±æœ‰ç›¸åŒçš„ O å’Œ CN)</li><li>selfnodeserver: kubelet server renew è‡ªå·±çš„è¯ä¹¦å‘èµ·çš„ CSR è¯·æ±‚</li></ul><p>é€šä¿—ç‚¹è®²å°±æ˜¯:<br>nodeclient ç±»å‹çš„ CSR ä»…åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ä¼šäº§ç”Ÿï¼Œselfnodeclient ç±»å‹çš„ CSR è¯·æ±‚å®é™…ä¸Šå°±æ˜¯ kubelet renew è‡ªå·±ä½œä¸º client è·Ÿ apiserver é€šè®¯æ—¶ä½¿ç”¨çš„è¯ä¹¦äº§ç”Ÿçš„ï¼Œselfnodeserver ç±»å‹çš„ CSR è¯·æ±‚åˆ™æ˜¯ kubelet é¦–æ¬¡ç”³è¯·æˆ–åç»­ renew è‡ªå·±çš„ 10250 api ç«¯å£è¯ä¹¦æ—¶äº§ç”Ÿçš„</p><p>é‚£ä¹ˆé’ˆå¯¹ä»¥ä¸Š3ç§CSRè¯·æ±‚åˆ†åˆ«ç»™å‡ºäº†3ç§å¯¹åº”çš„ ClusterRoleï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a user requesting</span></span><br><span class="line"><span class="comment"># node client credentials.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:nodeclient</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">"certificates.k8s.io"</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">"certificatesigningrequests/nodeclient"</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">"create"</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node renewing its</span></span><br><span class="line"><span class="comment"># own client credentials.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">"certificates.k8s.io"</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">"certificatesigningrequests/selfnodeclient"</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">"create"</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span></span><br><span class="line"><span class="comment"># serving cert matching its client cert.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">"certificates.k8s.io"</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">"certificatesigningrequests/selfnodeserver"</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">"create"</span>]</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­<code>selfnodeclient</code>,<code>nodeclient</code> å·²ç»æ˜¯é›†ç¾¤å†…ç½®çš„äº†;</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get clusterrole</span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">system:certificates.k8s.io:certificatesigningrequests:nodeclient       28h</span></span><br><span class="line"><span class="code">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   28h</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åæ˜¯ä¸‰ä¸ª ClusterRole å¯¹åº”çš„ ä¸‰ä¸ªClusterRoleBindingï¼›éœ€è¦æ³¨æ„çš„æ˜¯ åœ¨ä½¿ç”¨ Bootstrap Token è¿›è¡Œå¼•å¯¼æ—¶ï¼ŒKubelet ç»„ä»¶ä½¿ç”¨ Token å‘èµ·çš„è¯·æ±‚å…¶ç”¨æˆ·åä¸º<code>system:bootstrap:&lt;token id&gt;</code>ï¼Œç”¨æˆ·ç»„ä¸º system:bootstrappersï¼›æ‰€ä»¥ æˆ‘ä»¬åœ¨åˆ›å»º ClusterRoleBinding æ—¶è¦ç»‘å®šåˆ°è¿™ä¸ªç”¨æˆ·æˆ–è€…ç»„ä¸Šï¼›è¿™é‡Œæˆ‘é€‰æ‹©å…¨éƒ¨ç»‘å®šåˆ°ç»„ä¸Šï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; kubelet-bootstrap-rbac.yml &lt;&lt; EOF</span><br><span class="line"><span class="comment"># å…è®¸ system:bootstrappers ç»„ç”¨æˆ·åˆ›å»º CSR è¯·æ±‚</span></span><br><span class="line"><span class="comment"># (è¿™ä¸€æ­¥æˆ‘åœ¨ä¸Šé¢å·²ç»åšè¿‡å•¦)</span></span><br><span class="line">kubectl create clusterrolebinding kubelet-bootstrap <span class="attribute">--clusterrole</span>=system:node-bootstrapper <span class="attribute">--group</span>=system:bootstrappers</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</span></span><br><span class="line">kubectl create clusterrolebinding node-client-auto-approve-csr <span class="attribute">--clusterrole</span>=system:certificates.k8s.io:certificatesigningrequests:nodeclient <span class="attribute">--group</span>=system:bootstrappers</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</span></span><br><span class="line">kubectl create clusterrolebinding node-client-auto-renew-crt <span class="attribute">--clusterrole</span>=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient <span class="attribute">--group</span>=system:nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet 10250 api ç«¯å£è¯ä¹¦çš„ CSR è¯·æ±‚</span></span><br><span class="line">kubectl create clusterrolebinding node-server-auto-renew-crt <span class="attribute">--clusterrole</span>=system:certificates.k8s.io:certificatesigningrequests:selfnodeserver <span class="attribute">--group</span>=system:nodes</span><br></pre></td></tr></tbody></table></figure><p>å³: kubelet workerèŠ‚ç‚¹è¯ä¹¦æ‰‹åŠ¨æˆ–è‡ªåŠ¨æ‰¹å‡†éœ€è¦ç”¨åˆ°çš„è§’è‰²ä»¥åŠè§’è‰²ç»‘å®šæœ‰:</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># ClusterRole</span><br><span class="line">$ kubectl get clusterrole</span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">system:certificates.k8s.io:certificatesigningrequests:nodeclient       2d</span></span><br><span class="line"><span class="code">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   2d</span></span><br><span class="line"><span class="code">system:certificates.k8s.io:certificatesigningrequests:selfnodeserver   5m</span></span><br><span class="line"><span class="code">system:node-bootstrapper                                               2d</span></span><br><span class="line"><span class="code">system:kube-apiserver-to-kubelet                                       17h</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code"># ClusterRoleBinding</span></span><br><span class="line"><span class="code">$ kubectl get clusterrolebinding | grep auto</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">node-client-auto-approve-csr                           16h</span></span><br><span class="line"><span class="code">node-client-auto-renew-crt                             16h</span></span><br><span class="line"><span class="code">node-server-auto-renew-crt                             16h</span></span><br><span class="line"><span class="code">system:kube-apiserver                                  17h</span></span><br><span class="line"><span class="code">kubelet-bootstrap                                      18h</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>åˆ›å»ºå¥½å¯¹åº”çš„è§’è‰²åŠè§’è‰²ç»‘å®šä¹‹åå°±å¯ä»¥ä¿®æ”¹è¿™ä¸ªè¯ä¹¦çš„æœ‰æ•ˆæœŸå•¦ï¼›åªè¦åœ¨<code>Description=Kubernetes Controller Manager </code>æœåŠ¡çš„å¯åŠ¨é…ç½®å‚æ•°ä¸­åŠ å…¥:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">--experimental-cluster-signing-duration</span>=<span class="number">10</span>m0s \</span><br><span class="line"><span class="attr">--feature-gates</span>=RotateKubeletClientCertificate=<span class="literal">true</span> \</span><br><span class="line"><span class="attr">--feature-gates</span>=RotateKubeletServerCertificate=<span class="literal">true</span> </span><br></pre></td></tr></tbody></table></figure><p>ä»¥åŠkubeletæœåŠ¡å¯åŠ¨é…ç½®å‚æ•°ä¸­åŠ å…¥:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">--feature-gates</span>=RotateKubeletClientCertificate=<span class="literal">true</span> \</span><br><span class="line"><span class="attr">--feature-gates</span>=RotateKubeletServerCertificate=<span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡æ–‡æ¡£äº†è§£åˆ°<code>--feature-gates</code> è¿™ä¸ªæ˜¯kubernetesä¸­ç‰¹æœ‰çš„ä¸€äº›åŠŸèƒ½ï¼Œæœ‰äº›åŠŸèƒ½æ˜¯å¤„äºå¼€å‘ç‰ˆæœ¬çš„ï¼Œå…·ä½“å¯ä»¥å‚çœ‹<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/">è¿™é‡Œ</a></p><p>ä»¥ä¸‹å°±æ˜¯kubeletè¿è¡Œä¸€æ®µæ—¶é—´åï¼Œé€šè¿‡åœ¨<code>controller-manager</code>è®¾ç½®çš„è¯ä¹¦æœ‰æ•ˆæœŸå¿«è¿‡æœŸçš„æ—¶å€™é€šè¿‡è‡ªåŠ¨ç”³è¯·å¹¶è‡ªåŠ¨æ‰¹å‡†çš„ç»“æœï¼›<br>å¯ä»¥çœ‹å‡ºæ¥<code>node-csr-ysGrNbyioCNnj3UUFiQGn5WwLGF1P6wJ4DTIib1IcqQ</code> è¿™ä¸ªCSRæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶çš„ç”¨æˆ·<code>system:bootstrap:fd2f4f</code>çš„è¯ä¹¦è¯·æ±‚ã€‚<br><img src="/2018/12/30/kubernetes-bootstrapping/result2.jpg"></p><p>å¹¶ä¸”åœ¨è¯ä¹¦è½®æ¢çš„è¿‡ç¨‹ä¹Ÿå¯ä»¥é€šè¿‡æ—¥å¿—å‘ç°</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Dec</span> <span class="number">31</span> <span class="number">04</span>:<span class="number">10</span>:<span class="number">06</span> k8s-n0 kubelet: I1231 <span class="number">17</span>:<span class="number">10</span>:<span class="number">06</span>.<span class="number">753064</span>   <span class="number">18294</span> transport.go:<span class="number">132</span>] certificate rotation detected, shutting down client connections to start using new credentials</span><br></pre></td></tr></tbody></table></figure><p>é‚£ä¹ˆä»¥ä¸Šå°±æ˜¯kubeletè¯ä¹¦çš„æ•´ä¸ªæ‰¹å‡†ä»¥åŠè¯ä¹¦è½®æ¢çš„è¿‡ç¨‹ã€‚</p><h1 id="å››ã€TLS-Bootstrappingæ€»ç»“"><a href="#å››ã€TLS-Bootstrappingæ€»ç»“" class="headerlink" title="å››ã€TLS Bootstrappingæ€»ç»“"></a>å››ã€TLS Bootstrappingæ€»ç»“</h1><p>æµç¨‹æ€»ç»“</p><ol><li><p>kubelet é¦–æ¬¡å¯åŠ¨é€šè¿‡åŠ è½½<code> bootstrap.kubeconfig</code> ä¸­çš„ç”¨æˆ· Token å’Œ apiserver CA è¯ä¹¦å‘èµ·é¦–æ¬¡ CSR è¯·æ±‚ï¼Œè¿™ä¸ª Token è¢«é¢„å…ˆå†…ç½®åœ¨ apiserver èŠ‚ç‚¹çš„ token.csv(æ–°ç‰ˆæœ¬ä¸­å·²ç»æ¨èä½¿ç”¨Bootstrap Token Secert) ä¸­ï¼Œå…¶èº«ä»½ä¸º <code>kubelet-bootstrap</code> ç”¨æˆ·å’Œ <code>system:bootstrappers</code> ç”¨æˆ·ç»„ï¼›æƒ³è¦é¦–æ¬¡ CSR è¯·æ±‚èƒ½æˆåŠŸ(æˆåŠŸæŒ‡çš„æ˜¯ä¸ä¼šè¢« apiserver 401 æ‹’ç»)ï¼Œåˆ™éœ€è¦å…ˆå°† <code>kubelet-bootstrap</code> ç”¨æˆ·å’Œ <code>system:node-bootstrapper</code> å†…ç½® ClusterRole ç»‘å®šï¼›</p></li><li><p>å¯¹äºé¦–æ¬¡ CSR è¯·æ±‚å¯ä»¥æ‰‹åŠ¨ç­¾å‘ï¼Œä¹Ÿå¯ä»¥å°† <code>system:bootstrappers</code> ç”¨æˆ·ç»„ä¸ <code>approve-node-client-csr</code> ClusterRole ç»‘å®šå®ç°è‡ªåŠ¨ç­¾å‘(1.8 ä¹‹å‰è¿™ä¸ª ClusterRole éœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼Œ1.8 å apiserver è‡ªåŠ¨åˆ›å»ºï¼Œå¹¶æ›´åä¸º <code>system:certificates.k8s.io:certificatesigningrequests:nodeclient</code>)</p></li><li><p>é»˜è®¤ç­¾ç½²çš„çš„è¯ä¹¦åªæœ‰ 1 å¹´æœ‰æ•ˆæœŸï¼Œå¦‚æœæƒ³è¦è°ƒæ•´è¯ä¹¦æœ‰æ•ˆæœŸå¯ä»¥é€šè¿‡è®¾ç½® kube-controller-manager çš„ <code>--experimental-cluster-signing-duration</code> å‚æ•°å®ç°ï¼Œè¯¥å‚æ•°é»˜è®¤å€¼ä¸º 8760h0m0s</p></li><li><p>å¯¹äºè¯ä¹¦è½®æ¢ï¼Œéœ€è¦é€šè¿‡åè°ƒä¸¤ä¸ªæ–¹é¢å®ç°ï¼›ç¬¬ä¸€ï¼Œæƒ³è¦ kubelet åœ¨è¯ä¹¦åˆ°æœŸåè‡ªåŠ¨å‘èµ·ç»­æœŸè¯·æ±‚ï¼Œåˆ™éœ€è¦åœ¨ kubelet å¯åŠ¨æ—¶å¢åŠ  <code>--feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true</code> æ¥å®ç°ï¼›ç¬¬äºŒï¼Œæƒ³è¦è®© controller manager è‡ªåŠ¨æ‰¹å‡†ç»­ç­¾çš„ CSR è¯·æ±‚éœ€è¦åœ¨ controller manager å¯åŠ¨æ—¶å¢åŠ  <code>--feature-gates=RotateKubeletServerCertificate=true</code> å‚æ•°ï¼Œå¹¶ç»‘å®šå¯¹åº”çš„ RBAC è§„åˆ™</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> TLS bootstrapping </tag>
            
            <tag> è¯ä¹¦æ‰‹åŠ¨ç­¾å‘ </tag>
            
            <tag> è¯ä¹¦è‡ªåŠ¨ç­¾å‘ </tag>
            
            <tag> è¯ä¹¦è½®æ¢(è‡ªåŠ¨ç»­æœŸ) </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç†è§£Kuberneteså®‰å…¨çš„æŒä¹…åŒ–ä¿å­˜é”®å€¼-Etcd</title>
      <link href="/2018/12/23/kubernetes-etcd-secret/"/>
      <url>/2018/12/23/kubernetes-etcd-secret/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>etcdæ˜¯CoreOSå›¢é˜Ÿäº2013å¹´6æœˆå‘èµ·çš„å¼€æºé¡¹ç›®ï¼Œå®ƒçš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªé«˜å¯ç”¨çš„åˆ†å¸ƒå¼é”®å€¼(key-value)æ•°æ®åº“ã€‚etcdå†…éƒ¨é‡‡ç”¨raftåè®®ä½œä¸ºä¸€è‡´æ€§ç®—æ³•ï¼ŒetcdåŸºäºGoè¯­è¨€å®ç°ã€‚</p><p>etcdä½œä¸ºæœåŠ¡å‘ç°ç³»ç»Ÿï¼Œæœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š</p><p>ç®€å•ï¼šå®‰è£…é…ç½®ç®€å•ï¼Œè€Œä¸”æä¾›äº†HTTP APIè¿›è¡Œäº¤äº’ï¼Œä½¿ç”¨ä¹Ÿå¾ˆç®€å•<br>å®‰å…¨ï¼šæ”¯æŒSSLè¯ä¹¦éªŒè¯<br>å¿«é€Ÿï¼šæ ¹æ®å®˜æ–¹æä¾›çš„benchmarkæ•°æ®ï¼Œå•å®ä¾‹æ”¯æŒæ¯ç§’2k+è¯»æ“ä½œ<br>å¯é ï¼šé‡‡ç”¨raftç®—æ³•ï¼Œå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®çš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§</p><p>etcdé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/coreos/etcd/">https://github.com/coreos/etcd/</a></p><h2 id="kubernetesä¸­çš„ä½¿ç”¨"><a href="#kubernetesä¸­çš„ä½¿ç”¨" class="headerlink" title="kubernetesä¸­çš„ä½¿ç”¨"></a>kubernetesä¸­çš„ä½¿ç”¨</h2><p>ç›®å‰etcdæ˜¯ä½œä¸ºkubernetesé›†ç¾¤å½“ä¸­çš„å­˜å‚¨åç«¯</p><p>åœ¨kuernetesä¸­etcdæ¶‰åŠåˆ°çš„å®‰å…¨ç›¸å…³çš„ä¸»è¦æœ‰:</p><ul><li>etcdæ”¯æŒå¤‡ä»½æ¢å¤æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®è¢«è¯¯åˆ å¯¼è‡´æ•°æ®ä¸¢å¤±</li><li>ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯å»ºè®®æ”¾åœ¨secretç±»å‹çš„èµ„æºä¸­ï¼Œè¯¥ç±»å‹èµ„æºæ˜¯åŠ å¯†å­˜å‚¨åœ¨etcdä¸­çš„</li><li>etcdæ”¯æŒhttps, kube-apiserverè®¿é—®etcdä½¿ç”¨httpsåè®®</li></ul><p><img src="/2018/12/23/kubernetes-etcd-secret/etcd.png"></p><p>åœ¨kubernetesä¸­çš„é…ç½®:</p><h3 id="Client-Server"><a href="#Client-Server" class="headerlink" title="Client -> Server"></a>Client -&gt; Server</h3><figure class="highlight nsis"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">client-transport-security:</span><br><span class="line">  <span class="comment"># é€šé“ä»¥TLSåè®®åŠ å¯†</span></span><br><span class="line">  ca-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-ca.pem'</span></span><br><span class="line">  cert-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd.pem'</span> </span><br><span class="line">  key-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-key.pem'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æœåŠ¡ç«¯ä¼šè®¤è¯å®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦å—ä¿¡ä»»CAç­¾å‘</span></span><br><span class="line">  client-cert-auth: <span class="literal">true</span></span><br><span class="line">  trusted-ca-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-ca.pem'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ˜¯å¦ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆè¯ä¹¦</span></span><br><span class="line">  <span class="literal">auto</span>-tls: <span class="literal">true</span> </span><br></pre></td></tr></tbody></table></figure><h3 id="Server-Server"><a href="#Server-Server" class="headerlink" title="Server -> Server"></a>Server -&gt; Server</h3><figure class="highlight nsis"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">peer-transport-security:</span><br><span class="line">  <span class="comment"># é€šé“ä»¥TLSåè®®åŠ å¯†</span></span><br><span class="line">  ca-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-ca.pem'</span></span><br><span class="line">  cert-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd.pem'</span></span><br><span class="line">  key-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-key.pem'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æœåŠ¡ç«¯ä¼šè®¤è¯å®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦å—ä¿¡ä»»CAç­¾å‘</span></span><br><span class="line">  peer-client-cert-auth: <span class="literal">true</span></span><br><span class="line">  trusted-ca-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-ca.pem'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ˜¯å¦ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆè¯ä¹¦</span></span><br><span class="line">  <span class="literal">auto</span>-tls: <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><h3 id="etcdçš„å¤‡ä»½"><a href="#etcdçš„å¤‡ä»½" class="headerlink" title="etcdçš„å¤‡ä»½"></a>etcdçš„å¤‡ä»½</h3><p>å¯¹äº API 3 å¤‡ä»½ä¸æ¢å¤æ–¹æ³•<br>å®˜æ–¹ v3 admin guide<br>åœ¨ä½¿ç”¨ API 3 æ—¶éœ€è¦ä½¿ç”¨ç¯å¢ƒå˜é‡ ETCDCTL_API æ˜ç¡®æŒ‡å®šã€‚<br>åœ¨å‘½ä»¤è¡Œè®¾ç½®ï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> <span class="attribute">ETCDCTL_API</span>=3</span><br></pre></td></tr></tbody></table></figure><p>å¤‡ä»½æ•°æ®ï¼š</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl <span class="attr">--endpoints</span>=<span class="selector-attr">[localhost:2379]</span> snapshot save snapshot<span class="selector-class">.db</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>æ¢å¤ï¼š</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl <span class="keyword">snapshot</span> restore <span class="keyword">snapshot</span>.db <span class="comment">--name m3 --data-dir=/home/etcd_data</span></span><br></pre></td></tr></tbody></table></figure><p>æ¢å¤åçš„æ–‡ä»¶éœ€è¦ä¿®æ”¹æƒé™ä¸º etcd:etcd<br>â€“name:é‡æ–°æŒ‡å®šä¸€ä¸ªæ•°æ®ç›®å½•ï¼Œå¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤ä¸º default.etcd<br>â€“data-dirï¼šæŒ‡å®šæ•°æ®ç›®å½•<br>å»ºè®®ä½¿ç”¨æ—¶ä¸æŒ‡å®š name ä½†æŒ‡å®š data-dirï¼Œå¹¶å°† data-dir å¯¹åº”äº etcd æœåŠ¡ä¸­é…ç½®çš„ data-dir</p><p>etcd é›†ç¾¤éƒ½æ˜¯è‡³å°‘ 3 å°æœºå™¨ï¼Œå®˜æ–¹ä¹Ÿè¯´æ˜äº†é›†ç¾¤å®¹é”™ä¸º (N-1)/2ï¼Œæ‰€ä»¥å¤‡ä»½æ•°æ®ä¸€èˆ¬éƒ½æ˜¯ç”¨ä¸åˆ°ï¼Œä½†æ˜¯é‰´ä¸Šæ¬¡ gitlab å‡ºç°çš„é—®é¢˜ï¼Œå¯¹äºå¤‡ä»½æ•°æ®ä¹Ÿè¦éå¸¸é‡è§†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> etcd cluster </tag>
            
            <tag> etcd secret </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç†è§£kubernetesä¸­çš„é™æ€Pod</title>
      <link href="/2018/12/22/kubernetes-static-pod/"/>
      <url>/2018/12/22/kubernetes-static-pod/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>ä»Šå„¿æ˜¯å†¬è‡³ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œå­¦ä¹ çš„è„šæ­¥è¿˜æ˜¯ä¸èƒ½åœä¸‹ï¼Œä»Šå¤©å­¦ä¹ å®è·µä¸€ä¸‹kubernetesä¸­çš„é™æ€podæ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“åœ¨å‰é¢Podçš„å£°æ˜å‘¨æœŸç®¡ç†éƒ½æ˜¯é€šè¿‡åƒDaemonSetã€StatefulSetã€Deploymentè¿™ç§æ–¹å¼åˆ›å»ºç®¡ç†çš„ï¼Œè€Œå®˜æ–¹æ–‡æ¡£ä»‹ç»äº†ä¸€ç§ç‰¹æ®Šçš„podå°±æ˜¯é™æ€Podï¼Œ</p><h2 id="ä»€ä¹ˆæ˜¯é™æ€Pod"><a href="#ä»€ä¹ˆæ˜¯é™æ€Pod" class="headerlink" title="ä»€ä¹ˆæ˜¯é™æ€Pod"></a>ä»€ä¹ˆæ˜¯é™æ€Pod</h2><p>é™æ€Podæ˜¯ç”±kubeletè¿›è¡Œç®¡ç†ï¼Œä»…å­˜åœ¨äºç‰¹å®šNodeä¸Šçš„Podã€‚å®ƒä»¬ä¸èƒ½é€šè¿‡API Serverè¿›è¡Œç®¡ç†ï¼Œæ— æ³•ä¸ReplicationControllerã€Deploymentæˆ–DaemonSetè¿›è¡Œå…³è”ï¼Œå¹¶ä¸”kubeletä¹Ÿæ— æ³•å¯¹å…¶å¥åº·æ£€æŸ¥ã€‚</p><h3 id="é™æ€Podçš„åˆ›å»º"><a href="#é™æ€Podçš„åˆ›å»º" class="headerlink" title="é™æ€Podçš„åˆ›å»º:"></a>é™æ€Podçš„åˆ›å»º:</h3><p>é™æ€podå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼åˆ›å»ºï¼šä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–HTTPã€‚</p><h4 id="é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º"><a href="#é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º" class="headerlink" title="é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º"></a>é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º</h4><p>é…ç½®æ–‡ä»¶åªæ˜¯ç‰¹å®šç›®å½•ä¸­jsonæˆ–yamlæ ¼å¼çš„æ ‡å‡†podå®šä¹‰ã€‚ä»–é€šè¿‡åœ¨kubeletå®ˆæŠ¤è¿›ç¨‹ä¸­æ·»åŠ é…ç½®å‚æ•°<code>--pod-manifest-path=&lt;the directory&gt;</code> æ¥è¿è¡Œé™æ€Podï¼Œkubeletç»å¸¸ä¼šå®ƒå®šæœŸæ‰«æç›®å½•ï¼›</p><p>ä¾‹å¦‚ï¼Œå¦‚ä½•å°†ä¸€ä¸ªç®€å•webæœåŠ¡ä½œä¸ºé™æ€podå¯åŠ¨</p><p>é€‰æ‹©è¿è¡Œé™æ€podçš„èŠ‚ç‚¹æœåŠ¡å™¨<br>ä¸ä¸€å®šæ˜¯nodeèŠ‚ç‚¹ï¼Œåªè¦æœ‰kubeletè¿›ç¨‹æ‰€åœ¨çš„èŠ‚ç‚¹éƒ½å¯ä»¥è¿è¡Œé™æ€pod</p><p>æˆ‘åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªæ”¾ç½®ä¸€ä¸ªWebæœåŠ¡å™¨podå®šä¹‰çš„æè¿°æ–‡ä»¶æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚/etc/kubelet.d/static-web.yaml</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir <span class="operator">/</span>etc<span class="operator">/</span>kubelet.d<span class="symbol">/</span></span><br><span class="line">$ cat <span class="operator">&lt;</span><span class="operator">&lt;</span>EOF <span class="operator">&gt;</span><span class="symbol">/etc/kubelet.d/static-web.yaml</span></span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> static-web</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">role:</span> myrole</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> web</span><br><span class="line">      <span class="params">image:</span> nginx</span><br><span class="line">      <span class="params">ports:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> web</span><br><span class="line">          <span class="params">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="params">protocol:</span> TCP</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ ls <span class="operator">/</span>etc<span class="operator">/</span>kubelet.d<span class="symbol">/</span></span><br><span class="line">static-web.yaml</span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡ä½¿ç”¨â€“pod-manifest-path=/etc/kubelet.d/å‚æ•°è¿è¡Œå®ƒï¼Œåœ¨èŠ‚ç‚¹ä¸Šé…ç½®æˆ‘çš„kubeletå®ˆæŠ¤ç¨‹åºä»¥ä½¿ç”¨æ­¤ç›®å½•ã€‚<br>æ¯”å¦‚æˆ‘è¿™é‡Œkubeletå¯åŠ¨å‚æ•°ä½äº/etc/systemd/system/kubelet.service.d/10-kubelet.conf, ä¿®æ”¹é…ç½®ï¼Œç„¶åå°†å‚æ•°åŠ å…¥åˆ°ç°æœ‰å‚æ•°é…ç½®é¡¹ä¸­(å®‰è£…æ–¹å¼ä¸å°½ç›¸åŒï¼Œä½†æ˜¯é“ç†ä¸€æ ·)</p><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">vim</span> /etc/systemd/<span class="built_in">system</span>/kubelet.service.d/<span class="number">10</span>-kubelet.<span class="keyword">conf</span></span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line">Environment=<span class="string">"KUBELET_EXTRA_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local --pod-manifest-path=/etc/kubelet.d/"</span></span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br></pre></td></tr></tbody></table></figure><p>ä¿å­˜é€€å‡ºï¼Œreloadä¸€ä¸‹systemd daeomon ,é‡å¯kubeletæœåŠ¡è¿›ç¨‹</p><figure class="highlight crystal"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>systemctl daemon-reload</span><br><span class="line"><span class="variable">$ </span>systemctl restart kubelet</span><br></pre></td></tr></tbody></table></figure><p>å‰é¢è¯´å•¦ï¼Œå½“kubeletå¯åŠ¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å¯åŠ¨åœ¨æŒ‡å®šçš„ç›®å½•â€“pod-manifest-path=æˆ–â€“manifest-url=å‚æ•°ä¸­å®šä¹‰çš„æ‰€æœ‰pod ï¼Œå³æˆ‘ä»¬çš„static-webã€‚<br>å†è¯¥èŠ‚ç‚¹ä¸Šæ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                READY     STATUS    RESTARTS   AGE       IP            <span class="keyword">NODE</span>    </span><br><span class="line"><span class="title">static-web-k8s-m1</span>   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">2m</span>        <span class="number">10.244</span>.<span class="number">2.32</span>   k8s-m1</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢ä¹Ÿæåˆ°äº†ï¼Œä»–ä¸å½’ä»»ä½•éƒ¨ç½²æ–¹å¼æ¥ç®¡ç†ï¼Œå³ä½¿æˆ‘ä»¬å°è¯•kubeletå‘½ä»¤å»åˆ é™¤</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod static-web-k8s-m1</span><br><span class="line">pod <span class="string">"static-web-k8s-m1"</span> deleted</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                READY     STATUS    RESTARTS   AGE       IP        <span class="keyword">NODE</span>      <span class="title">NOMINATED</span> <span class="keyword">NODE</span></span><br><span class="line"><span class="title">static-web-k8s-m1</span>   <span class="number">0</span>/<span class="number">1</span>       Pending   <span class="number">0</span>          <span class="number">2s</span>        <span class="tag">&lt;none&gt;</span>    k8s-m1    <span class="tag">&lt;none&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹å‡ºé™æ€podé€šè¿‡è¿™ç§æ–¹å¼æ˜¯æ²¡æ³•åˆ é™¤çš„</p><p>é‚£æˆ‘å¦‚ä½•å»åˆ é™¤æˆ–è€…è¯´æ˜¯åŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªpodå‘¢ï¼Ÿ<br>è¿™ç§æœºåˆ¶å·²ç»çŸ¥é“ï¼Œkubeletè¿›ç¨‹ä¼šå®šæœŸæ‰«æé…ç½®çš„ç›®å½•ï¼ˆ/etc/kubelet.dåœ¨æˆ‘çš„ç¤ºä¾‹ï¼‰ä»¥è¿›è¡Œæ›´æ”¹ï¼Œå¹¶åœ¨æ–‡ä»¶å‡ºç°/æ¶ˆå¤±åœ¨æ­¤ç›®å½•ä¸­æ—¶æ·»åŠ /åˆ é™¤podã€‚</p><h4 id="é€šè¿‡urlæ¥åˆ›å»º"><a href="#é€šè¿‡urlæ¥åˆ›å»º" class="headerlink" title="é€šè¿‡urlæ¥åˆ›å»º:"></a>é€šè¿‡urlæ¥åˆ›å»º:</h4><p>ä¾‹å¦‚ï¼Œæˆ‘åœ¨è¿™ä¸ª<a href="https://blog.sctux.com/kubernetes/yaml/static-pod.json">url</a>æ”¾ç½®äº†ä¸€ä¸ªpodåˆ›å»ºçš„æè¿°æ–‡ä»¶</p><p>é‚£ä¹ˆä¸Šé¢æåˆ°äº†å¦‚ä½•ä¿®æ”¹ï¼Ÿé€šè¿‡urlæ¥åˆ›å»ºçš„ï¼Ÿå°±æ˜¯kubeletå¯åŠ¨é…ç½®å‚æ•°ä¸­é…ç½®<code>--manifest-url</code>æŒ‡å‘å³å¯</p><p><img src="/2018/12/22/kubernetes-static-pod/static-pod-from-url.png" alt="static-pod-from-url"></p><p>ok ä»¥ä¸Šå°±æ˜¯å¦‚ä½•åˆ›å»ºé™æ€Podçš„å…·ä½“é£Ÿç”¨æ–¹æ³•ï¼Œé‚£ä»€ä¹ˆåœºæ™¯éœ€è¦ç”¨åˆ°å®ƒï¼Œè¿™ä¸ªæˆ‘ä¸ªäººè§‰å¾—è¿˜æ˜¯å› äººæˆ–å› ç¯å¢ƒè€Œå·²ï¼Œæ¯•ç«Ÿkuberneteså¼€å‘å‡ºäº†è¿™ä¸ªåŠŸèƒ½ï¼Œå°±è¯´æ˜æœ‰ç”¨æ­¦ä¹‹åœ°çš„ã€‚</p><p>åŒæ—¶åœ¨kubelet-conf.ymlå¯ä»¥æŒ‡å®šç›´æ¥æŒ‡å®šè¿™ä¸ªStaticPodçš„æè¿°æ–‡ä»¶å­˜æ”¾ç›®å½•:</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat kubelet-conf.yml</span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">staticPodPath: /etc/kubernetes/manifests</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>ä½†æ˜¯è¿˜æ˜¯éœ€è¦åœ¨å¯åŠ¨å‚æ•°ä¸­é…ç½® <code>--pod-manifest-path</code></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> Static Pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç†è§£kubernetesä¸­çš„Secret</title>
      <link href="/2018/12/20/kubernetes-secret/"/>
      <url>/2018/12/20/kubernetes-secret/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>Secretå¯¹è±¡ä¸ConfigMapå¯¹è±¡ç±»ä¼¼ï¼Œä½†å®ƒä¸»è¦ç”¨äºå­˜å‚¨ä»¥ä¸‹æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ï¼ŒOAuth tokenå’ŒSSH keyç­‰ç­‰ã€‚å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨secretä¸­ï¼Œå’Œç›´æ¥å­˜å‚¨åœ¨Podçš„å®šä¹‰ä¸­ï¼Œæˆ–Dockeré•œåƒå®šä¹‰ä¸­ç›¸æ¯”ï¼Œæ›´åŠ å®‰å…¨å’Œçµæ´»ã€‚</p><p>kuberntesä¸­å†…ç½®äº†ä¸‰ç§secretç±»å‹:</p><ul><li><code>Opaque</code>ï¼šä½¿ç”¨base64ç¼–ç å­˜å‚¨ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡base64 â€“decodeè§£ç è·å¾—åŸå§‹æ•°æ®ï¼Œå› æ­¤å®‰å…¨æ€§å¼±ã€‚</li><li><code>kubernetes.io/dockerconfigjson</code>ï¼šç”¨äºå­˜å‚¨docker registryçš„è®¤è¯ä¿¡æ¯ã€‚</li><li><code>kubernetes.io/service-account-token</code>ï¼šç”¨äºè¢« serviceaccount å¼•ç”¨ã€‚serviceaccout åˆ›å»ºæ—¶ Kubernetes ä¼šé»˜è®¤åˆ›å»ºå¯¹åº”çš„ secretã€‚Pod å¦‚æœä½¿ç”¨äº† serviceaccountï¼Œå¯¹åº”çš„ secret ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„ /run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­ã€‚(<a href="https://blog.sctux.com/2018/12/16/kubernetes-auth/">å‰é¢åšæ–‡</a>è®°å½•è¿‡å®è·µåçš„é£Ÿç”¨æ–¹æ³•)</li></ul><h1 id="Opaque-Secret"><a href="#Opaque-Secret" class="headerlink" title="Opaque Secret"></a>Opaque Secret</h1><p>Opaqueç±»å‹çš„Secretï¼Œå…¶valueä¸ºbase64ç¼–ç åçš„å€¼ã€‚</p><h2 id="åˆ›å»ºæ–¹å¼"><a href="#åˆ›å»ºæ–¹å¼" class="headerlink" title="åˆ›å»ºæ–¹å¼"></a>åˆ›å»ºæ–¹å¼</h2><h3 id="ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret"><a href="#ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret" class="headerlink" title="ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret"></a>ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="string">"admin"</span> &gt; ./username.txt</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="string">"1f2d1e2e67df"</span> &gt; ./password.txt</span></span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨kubectl create secretå‘½ä»¤åˆ›å»ºsecretï¼š</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º</span></span><br><span class="line">$ kubectl create secret generic db-user-passwd <span class="operator">-</span>-from-file<span class="operator">=</span><span class="symbol">./username.txt</span> <span class="operator">-</span>-from-file<span class="operator">=</span><span class="symbol">./password.txt</span></span><br><span class="line">secret <span class="string">"db-user-passwd"</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åˆ›å»ºç»“æœ</span></span><br><span class="line">$ kubectl get secrets db-user-passwd</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  password.<span class="params">txt:</span> MWYyZDFlMmU2N2Rm</span><br><span class="line">  username.<span class="params">txt:</span> YWRtaW4<span class="operator">=</span></span><br><span class="line"><span class="params">kind:</span> Secret</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="number">201</span>8-<span class="number">1</span>2-<span class="number">21</span>T08:<span class="number">58</span>:<span class="number">33</span>Z</span><br><span class="line">  <span class="params">name:</span> db-user-passwd</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line">  <span class="params">resourceVersion:</span> <span class="string">"57310"</span></span><br><span class="line">  <span class="params">selfLink:</span> <span class="symbol">/api/v1/namespaces/default/secrets/db-user-passwd</span></span><br><span class="line">  <span class="params">uid:</span> <span class="number">9848894</span>7-<span class="number">04</span>fe-<span class="number">11</span>e9-<span class="number">97</span>cd-<span class="number">00505621</span>dd5b</span><br><span class="line"><span class="params">type:</span> Opaque</span><br></pre></td></tr></tbody></table></figure><h3 id="ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºSecret"><a href="#ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºSecret" class="headerlink" title="ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºSecret"></a>ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºSecret</h3><p>é¦–å…ˆä½¿ç”¨base64å¯¹æ•°æ®è¿›è¡Œç¼–ç ï¼š</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="string">"admin"</span> | <span class="built_in">base64</span></span></span><br><span class="line">YWRtaW4=</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="string">"1f2d1e2e67df"</span> | <span class="built_in">base64</span></span></span><br><span class="line">MWYyZDFlMmU2N2Rm</span><br></pre></td></tr></tbody></table></figure><p>åˆ›å»ºä¸€ä¸ªç±»å‹ä¸ºSecretçš„æè¿°æ–‡ä»¶ï¼š</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> secret.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Secret</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> mysecret</span><br><span class="line"><span class="params">type:</span> Opaque</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  <span class="params">username:</span> YWRtaW4<span class="operator">=</span></span><br><span class="line">  <span class="params">password:</span> MWYyZDFlMmU2N2Rm</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f secret.yaml </span><br><span class="line">secret<span class="symbol">/mysecret</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åˆ›å»ºç»“æœ</span></span><br><span class="line">$ kubectl get secrets mysecret <span class="operator">-</span>o yaml</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  <span class="params">password:</span> MWYyZDFlMmU2N2Rm</span><br><span class="line">  <span class="params">username:</span> YWRtaW4<span class="operator">=</span></span><br><span class="line"><span class="params">kind:</span> Secret</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="number">201</span>8-<span class="number">1</span>2-<span class="number">21</span>T09:<span class="number">03</span>:<span class="number">52</span>Z</span><br><span class="line">  <span class="params">name:</span> mysecret</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line">  <span class="params">resourceVersion:</span> <span class="string">"57767"</span></span><br><span class="line">  <span class="params">selfLink:</span> <span class="symbol">/api/v1/namespaces/default/secrets/mysecret</span></span><br><span class="line">  <span class="params">uid:</span> <span class="number">564</span>bd4da-<span class="number">04</span>ff-<span class="number">11</span>e9-<span class="number">97</span>cd-<span class="number">00505621</span>dd5b</span><br><span class="line"><span class="params">type:</span> Opaque</span><br></pre></td></tr></tbody></table></figure><h2 id="é£Ÿç”¨æ–¹å¼"><a href="#é£Ÿç”¨æ–¹å¼" class="headerlink" title="é£Ÿç”¨æ–¹å¼"></a>é£Ÿç”¨æ–¹å¼</h2><p>åˆ›å»ºå¥½Secretä¹‹åï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼é£Ÿç”¨ï¼š</p><ul><li>ä»¥Volumeæ–¹å¼</li><li>ä»¥ç¯å¢ƒå˜é‡æ–¹å¼</li></ul><h3 id="å°†-Secret-æŒ‚è½½åˆ°-Volume-ä¸­"><a href="#å°†-Secret-æŒ‚è½½åˆ°-Volume-ä¸­" class="headerlink" title="å°† Secret æŒ‚è½½åˆ° Volume ä¸­"></a>å°† Secret æŒ‚è½½åˆ° Volume ä¸­</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> redis-pod.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> redis</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> redis</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">nodeName:</span> k8s-m1</span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> container-<span class="number">0</span></span><br><span class="line">    <span class="params">image:</span> redis</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> foo</span><br><span class="line">        <span class="params">mountPath:</span> <span class="symbol">/etc/foo</span></span><br><span class="line">        <span class="params">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> foo</span><br><span class="line">      <span class="params">secret:</span></span><br><span class="line">        <span class="params">secretName:</span> db-user-passwd</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ åˆ›å»º:</span><br><span class="line">$ kubectl create <span class="operator">-</span>f redis-pod.yaml</span><br><span class="line">pod<span class="symbol">/redis</span> created</span><br></pre></td></tr></tbody></table></figure><p>è¿›å…¥å®¹å™¨æ£€æŸ¥</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l /etc/foo/</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 19 Dec 21 09:14 password.txt -&gt; ..data/password.txt</span><br><span class="line">lrwxrwxrwx 1 root root 19 Dec 21 09:14 username.txt -&gt; ..data/username.txt</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/foo/username.txt</span> </span><br><span class="line">admin</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/foo/password.txt</span> </span><br><span class="line">1f2d1e2e67df </span><br></pre></td></tr></tbody></table></figure><p>ä¹Ÿå¯ä»¥åªæŒ‚è½½Secretä¸­ç‰¹å®šçš„keyï¼š</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> redis-pod2.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> redis2</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> redis</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">nodeName:</span> k8s-m1</span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> redis</span><br><span class="line">    <span class="params">image:</span> redis</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> foo</span><br><span class="line">        <span class="params">mountPath:</span> <span class="symbol">/etc/foo</span></span><br><span class="line">        <span class="params">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> foo</span><br><span class="line">      <span class="params">secret:</span></span><br><span class="line">        <span class="params">secretName:</span> mysecret</span><br><span class="line">        <span class="params">items:</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">key:</span> username</span><br><span class="line">            <span class="params">path:</span> my-group<span class="symbol">/my-username</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f redis-pod2.yaml </span><br><span class="line">pod<span class="symbol">/redis2</span> created</span><br></pre></td></tr></tbody></table></figure><p>è¿›å…¥å®¹å™¨æ£€æŸ¥</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it redis5 /bin/bash</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l /etc/foo/my-group/my-username</span> </span><br><span class="line">-rw-r--r-- 1 root root 5 Dec 21 10:26 /etc/foo/my-group/my-username</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/foo/my-group/my-username</span></span><br><span class="line">admin</span><br></pre></td></tr></tbody></table></figure><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼š</p><p>username å­˜å‚¨åœ¨/etc/foo/my-group/my-usernameä¸­<br>passwordæœªè¢«æŒ‚è½½<br><code>æ³¨æ„</code>: æŒ‡å®škeyçš„è¿™ç§æŒ‚è½½æ–¹å¼åªé€‚ç”¨äºæ˜¯é€šè¿‡ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºçš„Secret,ä»æ–‡ä»¶ä¸­åˆ›å»ºçš„é‚£ç§SecretæŒ‚è½½ä¼šæŠ¥é”™:</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ å½“æˆ‘æŒ‚è½½<span class="built_in"> Secret </span>db-user-passwd çš„æ—¶å€™podåˆ›å»ºäº‹ä»¶:</span><br><span class="line">Events:</span><br><span class="line"> <span class="built_in"> Type </span>    Reason       Age               <span class="keyword">From</span>             Message</span><br><span class="line">  ----     ------       ----              ----             -------</span><br><span class="line">  <span class="built_in">Warning</span>  FailedMount  5s (x5 over 12s)  kubelet, k8s-m1  MountVolume.SetUp failed <span class="keyword">for</span> volume <span class="string">"foo"</span> : references non-existent<span class="built_in"> secret </span>key</span><br></pre></td></tr></tbody></table></figure><p>å…·ä½“åŸå› ç›®å‰æ— è§£<del>,æœ‰çŸ¥é“çš„å¤§å“¥å¯ä»¥è¯„è®ºç•™è¨€å‘ŠçŸ¥ä¸€äºŒï¼Œè°¢è°¢</del></p><h3 id="å°†-Secret-å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸­"><a href="#å°†-Secret-å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸­" class="headerlink" title="å°† Secret å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸­"></a>å°† Secret å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸­</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> redis3.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> redis3</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> redis</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">nodeName:</span> k8s-m1</span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> redis</span><br><span class="line">    <span class="params">image:</span> redis</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">env:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> SECRET_USERNAME</span><br><span class="line">      <span class="params">valueFrom:</span></span><br><span class="line">        <span class="params">secretKeyRef:</span></span><br><span class="line">          <span class="params">name:</span> mysecret</span><br><span class="line">          <span class="params">key:</span> username</span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> SECRET_PASSWORD</span><br><span class="line">      <span class="params">valueFrom:</span></span><br><span class="line">        <span class="params">secretKeyRef:</span></span><br><span class="line">          <span class="params">name:</span> mysecret</span><br><span class="line">          <span class="params">key:</span> password</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥å®¹å™¨æŸ¥çœ‹ç»“æœ</span></span><br><span class="line">$ kubectl exec <span class="operator">-</span>it redis3 <span class="symbol">/bin/bash</span></span><br><span class="line">$ echo $SECRET_USERNAME</span><br><span class="line">admin</span><br><span class="line">$ echo $SECRET_PASSWORD</span><br><span class="line"><span class="number">1</span>f2d1e2e67df</span><br></pre></td></tr></tbody></table></figure><p>ok , é€šè¿‡ä¸åŒæ–¹å¼æŒ‚è½½è¿›å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥æ‹¿æ¥ç”¨å•¦ï¼Œå…·ä½“é€‰æ‹©å“ªç§æ–¹å¼æŒ‚è½½è¿˜æ˜¯éœ€è¦çœ‹å®é™…ç¯å¢ƒï¼›<br>å¥½å•¦ï¼Œä»¥ä¸Šå°±æ˜¯Secretçš„ç®€å•é£Ÿç”¨æ–¹æ³•ï¼Œæ›´å¤šå¯ä»¥çœ‹<a href="https://kubernetes.io/docs/concepts/configuration/secret/">å®˜æ–¹æ–‡æ¡£</a></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kuberntes </tag>
            
            <tag> secret </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kuberneteså®¹å™¨å­˜æ´»æ¢æµ‹&amp;åº”ç”¨è‡ªæ¢å¤</title>
      <link href="/2018/12/18/kubernetes-liveness/"/>
      <url>/2018/12/18/kubernetes-liveness/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>å½“ä½ ä½¿ç”¨kuberentesçš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰é‡åˆ°è¿‡Podåœ¨å¯åŠ¨åä¸€ä¼šå°±æŒ‚æ‰ç„¶ååˆé‡æ–°å¯åŠ¨è¿™æ ·çš„æ¶æ€§å¾ªç¯ï¼Ÿ<br>ä½ æœ‰æ²¡æœ‰æƒ³è¿‡kubernetesæ˜¯å¦‚ä½•æ£€æµ‹podæ˜¯å¦è¿˜å­˜æ´»ï¼Ÿ<br>è™½ç„¶å®¹å™¨å·²ç»å¯åŠ¨ï¼Œä½†æ˜¯kuberneteså¦‚ä½•çŸ¥é“å®¹å™¨çš„è¿›ç¨‹æ˜¯å¦å‡†å¤‡å¥½å¯¹å¤–æä¾›æœåŠ¡äº†å‘¢ï¼Ÿ</p><p>æœ¬åšæ–‡ä¸»è¦è®°å½•å®è·µå¦‚ä½•é…ç½®å®¹å™¨çš„å­˜æ´»å’Œå°±ç»ªæ¢é’ˆã€‚</p><p><strong>liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰</strong><br>ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå³Podæ˜¯å¦ä¸ºrunningçŠ¶æ€ï¼Œå¦‚æœLivenessProbeæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œåˆ™kubeletå°†killæ‰å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥æ˜¯å¦é‡å¯ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨ä¸åŒ…å«LivenessProbeæ¢é’ˆï¼Œåˆ™Kubeletè®¤ä¸ºå®¹å™¨çš„LivenessProbeæ¢é’ˆçš„è¿”å›å€¼æ°¸è¿œæˆåŠŸã€‚</p><p><strong>readiness probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰</strong><br>ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆï¼Œå³å®¹å™¨çš„Readyæ˜¯å¦ä¸ºTrueï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœReadinessProbeæ¢æµ‹å¤±è´¥ï¼Œåˆ™å®¹å™¨çš„Readyå°†ä¸ºFalseï¼Œæ§åˆ¶å™¨å°†æ­¤Podçš„Endpointä»å¯¹åº”çš„serviceçš„Endpointåˆ—è¡¨ä¸­ç§»é™¤ï¼Œä»æ­¤ä¸å†å°†ä»»ä½•è¯·æ±‚è°ƒåº¦æ­¤Podä¸Šï¼Œç›´åˆ°ä¸‹æ¬¡æ¢æµ‹æˆåŠŸã€‚</p><p><strong>æ¯ç±»æ¢é’ˆéƒ½æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹æ³•</strong></p><ul><li>execï¼šé€šè¿‡æ‰§è¡Œå‘½ä»¤æ¥æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œé’ˆå¯¹å¤æ‚æ£€æµ‹æˆ–æ— HTTPæ¥å£çš„æœåŠ¡ï¼Œå‘½ä»¤è¿”å›å€¼ä¸º0åˆ™è¡¨ç¤ºå®¹å™¨å¥åº·ã€‚</li><li>httpGetï¼šé€šè¿‡å‘é€httpè¯·æ±‚æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œè¿”å›200-399çŠ¶æ€ç åˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li><li>tcpSocketï¼šé€šè¿‡å®¹å™¨çš„IPå’ŒPortæ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li></ul><p>æ¯ç§æ–¹å¼éƒ½å¯ä»¥å®šä¹‰åœ¨readiness æˆ–è€…liveness ä¸­ã€‚æ¯”å¦‚å®šä¹‰readiness ä¸­http get å°±æ˜¯æ„æ€è¯´å¦‚æœæˆ‘å®šä¹‰çš„è¿™ä¸ªpathçš„http get è¯·æ±‚è¿”å›200-400ä»¥å¤–çš„http code å°±æŠŠæˆ‘ä»æ‰€æœ‰æœ‰æˆ‘çš„æœåŠ¡é‡Œé¢åˆ äº†å§ï¼Œå¦‚æœå®šä¹‰åœ¨livenessé‡Œé¢å°±æ˜¯æŠŠæˆ‘kill äº†ã€‚<br>æ³¨æ„ï¼Œlivenessä¸ä¼šé‡å¯podï¼Œpodæ˜¯å¦ä¼šé‡å¯ç”±ä½ çš„restart policy æ§åˆ¶ã€‚</p><p><strong>æ¢é’ˆæ¢æµ‹çš„ç»“æœæœ‰ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€</strong></p><ul><li>Successï¼šContaineré€šè¿‡äº†æ£€æŸ¥ã€‚</li><li>Failureï¼šContaineræœªé€šè¿‡æ£€æŸ¥ã€‚</li><li>Unknownï¼šæœªèƒ½æ‰§è¡Œæ£€æŸ¥ï¼Œå› æ­¤ä¸é‡‡å–ä»»ä½•æªæ–½ã€‚</li></ul><p><strong>é‡å¯ç­–ç•¥</strong></p><ul><li>Always: æ€»æ˜¯é‡å¯</li><li>OnFailure: å¦‚æœå¤±è´¥å°±é‡å¯</li><li>Never: æ°¸è¿œä¸é‡å¯</li></ul><h2 id="LivenessProbeæ¢é’ˆé…ç½®"><a href="#LivenessProbeæ¢é’ˆé…ç½®" class="headerlink" title="LivenessProbeæ¢é’ˆé…ç½®"></a>LivenessProbeæ¢é’ˆé…ç½®</h2><h3 id="ç¤ºä¾‹ä¸€-é€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ç¤ºä¾‹ä¸€-é€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ç¤ºä¾‹ä¸€: é€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ç¤ºä¾‹ä¸€: é€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹</h3><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">exec-liveness.yaml  </span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">labels</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">test</span><span class="punctuation">:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">liveness-exec</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">containers</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">name: liveness</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">k8s.gcr.io/busybox  </span></span><br><span class="line">    <span class="attribute">args</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span></span><br><span class="line">    <span class="attribute">livenessProbe</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">exec</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">      <span class="attribute">initialDelaySeconds</span><span class="punctuation">:</span> <span class="string">5</span></span><br><span class="line">      <span class="attribute">periodSeconds</span><span class="punctuation">:</span> <span class="string">5</span></span><br></pre></td></tr></tbody></table></figure><p>åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯¹å®¹å™¨æ‰§è¡ŒlivenessProbeæ£€æŸ¥ï¼ŒperiodSecondså­—æ®µæŒ‡å®škubeletæ¯5sæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œæ£€æŸ¥çš„å‘½ä»¤ä¸ºcat /tmp/healthyï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletåº”è¯¥åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥ä¹‹å‰ç­‰å¾…5ç§’ï¼Œ<br>å¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›0ï¼Œé‚£ä¹ˆkubeletå°±è®¤ä¸ºå®¹å™¨æ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸ºé0ï¼Œåˆ™Kubeletä¼šKillæ‰å®¹å™¨å¹¶æ ¹æ®é‡å¯ç­–ç•¥æ¥å†³å®šæ˜¯å¦éœ€è¦é‡å¯(kubernetesé»˜è®¤ä¸ºPODé…ç½®çš„é‡å¯ç­–ç•¥ä¸ºAlways)</p><p>å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/bin/</span>sh -c <span class="string">"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"</span></span><br></pre></td></tr></tbody></table></figure><p>å¯¹äºå®¹å™¨çš„å‰30ç§’ï¼Œæœ‰ä¸€ä¸ª/tmp/healthyæ–‡ä»¶ã€‚å› æ­¤ï¼Œåœ¨å‰30ç§’å†…ï¼Œè¯¥å‘½ä»¤cat /tmp/healthyè¿”å›æˆåŠŸä»£ç ã€‚30ç§’åï¼Œcat /tmp/healthyè¿”å›å¤±è´¥ä»£ç ã€‚</p><p>åœ¨30ç§’å†…ï¼ŒæŸ¥çœ‹Podäº‹ä»¶ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">describe</span> pod liveness<span class="operator">-</span><span class="keyword">exec</span></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age               <span class="keyword">From</span>               Message</span><br><span class="line">  <span class="comment">----     ------     ----              ----               -------</span></span><br><span class="line">  Normal   Scheduled  <span class="number">15</span>m               <span class="keyword">default</span><span class="operator">-</span>scheduler  Successfully assigned <span class="keyword">default</span><span class="operator">/</span>liveness<span class="operator">-</span><span class="keyword">exec</span> <span class="keyword">to</span> k8s<span class="operator">-</span>m3</span><br><span class="line">  Normal   Pulled     <span class="number">3</span>m (x3 <span class="keyword">over</span> <span class="number">5</span>m)   kubelet, k8s<span class="operator">-</span>m3    Successfully pulled image "k8s.gcr.io/busybox"</span><br><span class="line">  Normal   Created    <span class="number">3</span>m (x3 <span class="keyword">over</span> <span class="number">5</span>m)   kubelet, k8s<span class="operator">-</span>m3    Created container</span><br><span class="line">  Normal   Started    <span class="number">3</span>m (x3 <span class="keyword">over</span> <span class="number">5</span>m)   kubelet, k8s<span class="operator">-</span>m3    Started container</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>åœ¨30ç§’åï¼ŒæŸ¥çœ‹Podäº‹ä»¶ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">describe</span> pod liveness<span class="operator">-</span><span class="keyword">exec</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age              <span class="keyword">From</span>               Message</span><br><span class="line">  <span class="comment">----     ------     ----             ----               -------</span></span><br><span class="line">  Normal   Scheduled  <span class="number">16</span>m              <span class="keyword">default</span><span class="operator">-</span>scheduler  Successfully assigned <span class="keyword">default</span><span class="operator">/</span>liveness<span class="operator">-</span><span class="keyword">exec</span> <span class="keyword">to</span> k8s<span class="operator">-</span>m3</span><br><span class="line">  Normal   Pulled     <span class="number">5</span>m (x3 <span class="keyword">over</span> <span class="number">7</span>m)  kubelet, k8s<span class="operator">-</span>m3    Successfully pulled image "k8s.gcr.io/busybox"</span><br><span class="line">  Normal   Created    <span class="number">5</span>m (x3 <span class="keyword">over</span> <span class="number">7</span>m)  kubelet, k8s<span class="operator">-</span>m3    Created container</span><br><span class="line">  Normal   Started    <span class="number">5</span>m (x3 <span class="keyword">over</span> <span class="number">7</span>m)  kubelet, k8s<span class="operator">-</span>m3    Started container</span><br><span class="line">  Warning  Unhealthy  <span class="number">4</span>m (x9 <span class="keyword">over</span> <span class="number">7</span>m)  kubelet, k8s<span class="operator">-</span>m3    Liveness probe failed: cat: can<span class="string">'t open '</span><span class="operator">/</span>tmp<span class="operator">/</span>healthy<span class="string">': No such file or directory</span></span><br><span class="line"><span class="string">  Normal   Pulling    4m (x4 over 7m)  kubelet, k8s-m3    pulling image "k8s.gcr.io/busybox"</span></span><br><span class="line"><span class="string">  Normal   Killing    2m (x4 over 6m)  kubelet, k8s-m3    Killing container with id docker://liveness:Container failed liveness probe.. Container will be killed and recreated.</span></span><br></pre></td></tr></tbody></table></figure><p>å†ç­‰30ç§’ï¼Œç¡®è®¤Containerå·²é‡æ–°å¯åŠ¨, ä¸‹é¢è¾“å‡ºä¸­RESTARTSçš„æ¬¡æ•°å·²å¢åŠ ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">get</span> pod liveness<span class="operator">-</span><span class="keyword">exec</span></span><br><span class="line">NAME            READY     STATUS    RESTARTS   AGE</span><br><span class="line">liveness<span class="operator">-</span><span class="keyword">exec</span>   <span class="number">1</span><span class="operator">/</span><span class="number">1</span>       <span class="keyword">Running</span>   <span class="number">1</span>          <span class="number">1</span>m</span><br></pre></td></tr></tbody></table></figure><h3 id="ç¤ºä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ç¤ºä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ç¤ºä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ç¤ºä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">test:</span> liveness</span><br><span class="line">  <span class="params">name:</span> liveness-http</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> liveness</span><br><span class="line">    <span class="params">image:</span> k8s.gcr.io<span class="symbol">/liveness</span> <span class="comment"># å®˜æ–¹ç”¨æˆ·æµ‹è¯•çš„demoé•œåƒ</span></span><br><span class="line">    <span class="params">args:</span></span><br><span class="line">    <span class="operator">-</span> <span class="symbol">/server</span></span><br><span class="line">    <span class="params">livenessProbe:</span></span><br><span class="line">      <span class="params">httpGet:</span></span><br><span class="line">        <span class="params">path:</span> <span class="symbol">/healthz</span></span><br><span class="line">        <span class="params">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="params">httpHeaders:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> X-Custom-Header</span><br><span class="line">          <span class="params">value:</span> Awesome</span><br><span class="line">      <span class="params">initialDelaySeconds:</span> <span class="number">3</span> </span><br><span class="line">      <span class="params">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></tbody></table></figure><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨k8s.gcr.io/livenessé•œåƒï¼Œåˆ›å»ºå‡ºä¸€ä¸ªPodï¼Œå…¶ä¸­periodSecondså­—æ®µæŒ‡å®škubeletæ¯3ç§’æ‰§è¡Œä¸€æ¬¡æ¢æµ‹ï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletå»¶è¿Ÿç­‰å¾…3ç§’ï¼Œæ¢æµ‹æ–¹å¼ä¸ºå‘å®¹å™¨ä¸­è¿è¡Œçš„æœåŠ¡å‘é€HTTP GETè¯·æ±‚ï¼Œè¯·æ±‚8080ç«¯å£ä¸‹çš„/healthz, ä»»ä½•å¤§äºæˆ–ç­‰äº200ä¸”å°äº400çš„ä»£ç è¡¨ç¤ºæˆåŠŸã€‚ä»»ä½•å…¶ä»–ä»£ç è¡¨ç¤ºå¤±è´¥ã€‚</p><p>10ç§’åï¼ŒæŸ¥çœ‹Podäº‹ä»¶ä»¥éªŒè¯livenessæ¢æµ‹å¤±è´¥å¹¶ä¸”Containerå·²é‡æ–°å¯åŠ¨ï¼š</p><figure class="highlight fortran"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pod liveness-http</span><br><span class="line"><span class="keyword">NAME</span>            READY     <span class="keyword">STATUS</span>             RESTARTS   AGE</span><br><span class="line">liveness-http   <span class="number">1</span>/<span class="number">1</span>       RUNNING            <span class="number">1</span>          <span class="number">1</span>m</span><br></pre></td></tr></tbody></table></figure><p>httpGetæ¢æµ‹æ–¹å¼æœ‰å¦‚ä¸‹å¯é€‰çš„æ§åˆ¶å­—æ®µ</p><ul><li>hostï¼šè¦è¿æ¥çš„ä¸»æœºåï¼Œé»˜è®¤ä¸ºPod IPï¼Œå¯ä»¥åœ¨http request headä¸­è®¾ç½®hostå¤´éƒ¨ã€‚</li><li>scheme: ç”¨äºè¿æ¥hostçš„åè®®ï¼Œé»˜è®¤ä¸ºHTTPã€‚</li><li>pathï¼šhttpæœåŠ¡å™¨ä¸Šçš„è®¿é—®URIã€‚</li><li>httpHeadersï¼šè‡ªå®šä¹‰HTTPè¯·æ±‚headersï¼ŒHTTPå…è®¸é‡å¤headersã€‚</li><li>portï¼š å®¹å™¨ä¸Šè¦è®¿é—®ç«¯å£å·æˆ–åç§°ã€‚</li></ul><h3 id="ç¤ºä¾‹ä¸‰ï¼šé€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ç¤ºä¾‹ä¸‰ï¼šé€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ç¤ºä¾‹ä¸‰ï¼šé€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ç¤ºä¾‹ä¸‰ï¼šé€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹</h3><p>Kubeletå°†å°è¯•åœ¨æŒ‡å®šçš„ç«¯å£ä¸Šæ‰“å¼€å®¹å™¨ä¸Šçš„å¥—æ¥å­—ï¼Œå¦‚æœèƒ½å»ºç«‹è¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">goproxy</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">goproxy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">goproxy</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/goproxy:0.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">20</span></span><br></pre></td></tr></tbody></table></figure><p>TCPæ£€æŸ¥æ–¹å¼å’ŒHTTPæ£€æŸ¥æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œç¤ºä¾‹ä¸­ä¸¤ç§æ¢é’ˆéƒ½ä½¿ç”¨äº†ï¼Œåœ¨å®¹å™¨å¯åŠ¨5ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªreadinessProbeæ¢é’ˆï¼Œè¿™å°†è¿æ¥åˆ°å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœæ¢æµ‹æˆåŠŸï¼Œåˆ™è¯¥Podå°†è¢«æ ‡è¯†ä¸ºreadyï¼Œ10ç§’åï¼Œkubeletå°†è¿›è¡Œç¬¬äºŒæ¬¡è¿æ¥ã€‚<br>é™¤æ­¤ä¹‹åï¼Œæ­¤é…ç½®è¿˜åŒ…å«äº†livenessProbeæ¢é’ˆï¼Œåœ¨å®¹å™¨å¯åŠ¨15ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªlivenessProbeæ¢é’ˆï¼Œä»ç„¶å°è¯•è¿æ¥å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœè¿æ¥å¤±è´¥åˆ™é‡å¯å®¹å™¨ã€‚</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-port</span></span><br><span class="line">  <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">hostPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">liveness-port</span></span><br></pre></td></tr></tbody></table></figure><h2 id="ReadinessProbeæ¢é’ˆé…ç½®ï¼š"><a href="#ReadinessProbeæ¢é’ˆé…ç½®ï¼š" class="headerlink" title="ReadinessProbeæ¢é’ˆé…ç½®ï¼š"></a>ReadinessProbeæ¢é’ˆé…ç½®ï¼š</h2><p>ReadinessProbeæ¢é’ˆçš„ä½¿ç”¨åœºæ™¯livenessProbeç¨æœ‰ä¸åŒï¼Œæœ‰çš„æ—¶å€™åº”ç”¨ç¨‹åºå¯èƒ½æš‚æ—¶æ— æ³•æ¥å—è¯·æ±‚ï¼Œæ¯”å¦‚Podå·²ç»Runningäº†ï¼Œä½†æ˜¯å®¹å™¨å†…åº”ç”¨ç¨‹åºå°šæœªå¯åŠ¨æˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰ReadinessProbeï¼Œåˆ™Kubernetesè®¤ä¸ºå®ƒå¯ä»¥å¤„ç†è¯·æ±‚äº†ï¼Œç„¶è€Œæ­¤æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ç¨‹åºè¿˜æ²¡å¯åŠ¨æˆåŠŸæ˜¯ä¸èƒ½æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¸å¸Œæœ›kubernetesæŠŠè¯·æ±‚è°ƒåº¦ç»™å®ƒï¼Œåˆ™ä½¿ç”¨ReadinessProbeæ¢é’ˆã€‚<br>ReadinessProbeå’ŒlivenessProbeå¯ä»¥ä½¿ç”¨ç›¸åŒæ¢æµ‹æ–¹å¼ï¼Œåªæ˜¯å¯¹Podçš„å¤„ç½®æ–¹å¼ä¸åŒï¼ŒReadinessProbeæ˜¯å°†Pod IP:Portä»å¯¹åº”çš„EndPointåˆ—è¡¨ä¸­åˆ é™¤ï¼Œè€ŒlivenessProbeåˆ™Killå®¹å™¨å¹¶æ ¹æ®Podçš„é‡å¯ç­–ç•¥æ¥å†³å®šä½œå‡ºå¯¹åº”çš„æªæ–½ã€‚</p><p><strong>ReadinessProbe</strong>æ¢é’ˆæ¢æµ‹å®¹å™¨æ˜¯å¦å·²å‡†å¤‡å°±ç»ªï¼Œå¦‚æœæœªå‡†å¤‡å°±ç»ªåˆ™kubernetesä¸ä¼šå°†æµé‡è½¬å‘ç»™æ­¤Podã€‚</p><p>ReadinessProbeæ¢é’ˆä¸livenessProbeä¸€æ ·ä¹Ÿæ”¯æŒexecã€httpGetã€TCPçš„æ¢æµ‹æ–¹å¼ï¼Œé…ç½®æ–¹å¼ç›¸åŒï¼Œåªä¸è¿‡æ˜¯å°†livenessProbeå­—æ®µä¿®æ”¹ä¸ºReadinessProbeã€‚</p><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">readinessProbe</span><span class="punctuation">:</span></span><br><span class="line"> <span class="attribute">exec</span><span class="punctuation">:</span></span><br><span class="line">   <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line"> <span class="attribute">initialDelaySeconds</span><span class="punctuation">:</span> <span class="string">5</span></span><br><span class="line"> <span class="attribute">periodSeconds</span><span class="punctuation">:</span> <span class="string">5</span></span><br></pre></td></tr></tbody></table></figure><h3 id="ç¤ºä¾‹ä¸€-ReadinessProbeç¤ºä¾‹"><a href="#ç¤ºä¾‹ä¸€-ReadinessProbeç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹ä¸€: ReadinessProbeç¤ºä¾‹"></a>ç¤ºä¾‹ä¸€: ReadinessProbeç¤ºä¾‹</h3><p>ç°åœ¨æ¥çœ‹ä¸€ä¸ªåŠ å…¥ReadinessProbeæ¢é’ˆå’Œä¸€ä¸ªæ²¡æœ‰ReadinessProbeæ¢é’ˆçš„ç¤ºä¾‹ï¼š<br>è¯¥ç¤ºä¾‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªdeployï¼Œåä¸ºgogsï¼Œå¯åŠ¨çš„å®¹å™¨è¿è¡Œä¸€ä¸ªç±»ä¼¼äºgitlabçš„åº”ç”¨ç¨‹åºï¼Œç¨‹åºç›‘å¬ç«¯å£ä¸º3000ã€‚<br>è¿™é‡Œä¸ºäº†æ¨¡æ‹Ÿæ•ˆæœæˆ‘è¿™é‡ŒåŸé•œåƒåšäº†ä¸€ä¸‹ä¿®æ”¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†å»¶è¿Ÿä»–çš„å¯åŠ¨æ—¶é—´ä¸º40såå†å»å¯åŠ¨gogsçš„åº”ç”¨ç¨‹åºï¼Œæ­¤æ—¶å°±ä¼šå¼€å¯3000ç«¯å£ï¼Œ</p><p>(æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸€ä¸‹ï¼Œéå¸¸çˆ½çš„ä¸€ä¸ªè‡ªåŠ©gitwebå¹³å°<a href="https://gogs.io/">Gogs</a>)</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">         <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">k8s-m1</span></span><br></pre></td></tr></tbody></table></figure><div style="width: 50%; margin: auto">![Not add readinessProbe result](kubernetes-liveness/image1.png)</div>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œå½“æˆ‘åˆ›å»ºéƒ¨ç½²ä¹‹åï¼ŒPodå¯åŠ¨18sï¼Œè‡ªèº«çŠ¶æ€å·²Runningï¼Œå…¶READå­—æ®µï¼Œ1/1 è¡¨ç¤º1ä¸ªå®¹å™¨çŠ¶æ€å·²å‡†å¤‡å°±ç»ªäº†ï¼Œæ­¤æ—¶ï¼Œå¯¹äºkubernetesè€Œè¨€ï¼Œå®ƒå·²ç»å¯ä»¥æ¥æ”¶è¯·æ±‚äº†ï¼Œè€Œå®é™…ä¸Šæˆ‘åœ¨å»è®¿é—®çš„æ—¶å€™æœåŠ¡è¿˜æ— æ³•è®¿é—®ï¼Œå› ä¸ºGogoç¨‹åºè¿˜å°šå¯åŠ¨èµ·æ¥ï¼Œ40sä¹‹åæ–¹å¯æ­£å¸¸è®¿é—®ï¼Œæ‰€ä»¥é’ˆå¯¹äºæœåŠ¡å¯åŠ¨æ…¢æˆ–è€…å…¶ä»–åŸå› çš„æ­¤ç±»ç¨‹åºï¼Œå¿…é¡»é…ç½®ReadinessProbeã€‚<p>ä¸‹é¢æˆ‘åŠ å…¥readinessProbe</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">         <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">tcpSocket:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span> <span class="comment"># å¯åŠ¨å10ç§’å¼€å§‹æ¢æµ‹</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span>        <span class="comment"># æ¯5ç§’æ¢æµ‹ä¸€æ¬¡</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">k8s-m1</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><div style="width: 50%; margin: auto">![Add readinessProbe result](kubernetes-liveness/image1.png)</div>ä¸Šå›¾å¯ä»¥çœ‹å‡ºPodè™½ç„¶å·²å¤„äºRunnigçŠ¶æ€ï¼Œä½†æ˜¯ç”±äºç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æœªåˆ°ï¼Œæ‰€ä»¥READYå­—æ®µä¸º0/1ï¼Œå³å®¹å™¨çš„çŠ¶æ€ä¸ºæœªå‡†å¤‡å°±ç»ªï¼Œåœ¨æœªå‡†å¤‡å°±ç»ªçš„æƒ…å†µä¸‹ï¼Œå…¶Podå¯¹åº”çš„Serviceä¸‹çš„Endpointä¹Ÿä¸ºç©ºï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ä»»ä½•è¯·æ±‚è¢«è°ƒåº¦è¿›æ¥ã€‚å½“é€šè¿‡ç¬¬ä¸€æ¬¡æ¢æµ‹çš„æ£€æŸ¥é€šè¿‡åï¼Œå®¹å™¨çš„çŠ¶æ€è‡ªç„¶ä¼šè½¬ä¸ºREADçŠ¶æ€ã€‚æ­¤åæ ¹æ®æŒ‡å®šçš„é—´éš”æ—¶é—´10såå†æ¬¡æ¢æµ‹ï¼Œå¦‚æœä¸é€šè¿‡ï¼Œåˆ™kuberneteså°±ä¼šå°†Pod IPä»EndPointåˆ—è¡¨ä¸­ç§»é™¤ã€‚<h2 id="é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§"><a href="#é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§" class="headerlink" title="é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§"></a>é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§</h2><p>æ¢é’ˆ(Probe)æœ‰è®¸å¤šå¯é€‰å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æ›´åŠ ç²¾ç¡®çš„æ§åˆ¶Livenesså’ŒReadinessä¸¤ç§æ¢é’ˆçš„è¡Œä¸º(Probe)ï¼š</p><p><code>initialDelaySeconds</code>ï¼šPodå¯åŠ¨åå»¶è¿Ÿå¤šä¹…æ‰è¿›è¡Œæ£€æŸ¥ï¼Œå•ä½ï¼šç§’ã€‚<br><code>periodSeconds</code>ï¼šæ£€æŸ¥çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤ä¸º10ï¼Œå•ä½ï¼šç§’ã€‚<br><code>timeoutSeconds</code>ï¼šæ¢æµ‹çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º1ï¼Œå•ä½ï¼šç§’ã€‚<br><code>successThreshold</code>ï¼šæ¢æµ‹å¤±è´¥åè®¤ä¸ºæˆåŠŸçš„æœ€å°è¿æ¥æˆåŠŸæ¬¡æ•°ï¼Œé»˜è®¤ä¸º1ï¼Œåœ¨Livenessæ¢é’ˆä¸­å¿…é¡»ä¸º1ï¼Œæœ€å°å€¼ä¸º1ã€‚<br><code>failureThreshold</code>ï¼šæ¢æµ‹å¤±è´¥çš„é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•ä¸€å®šæ¬¡æ•°åå°†è®¤ä¸ºå¤±è´¥ï¼Œåœ¨readinessæ¢é’ˆä¸­ï¼ŒPodä¼šè¢«æ ‡è®°ä¸ºæœªå°±ç»ªï¼Œé»˜è®¤ä¸º3ï¼Œæœ€å°å€¼ä¸º1ã€‚</p><p>å‚è€ƒ:<br><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/</a></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> liveness probe </tag>
            
            <tag> readiness probe </tag>
            
            <tag> restartPolicy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç†è§£Kubernetesä¸­çš„è®¤è¯&amp;æˆæƒ&amp;å‡†å…¥æœºåˆ¶</title>
      <link href="/2018/12/16/kubernetes-auth/"/>
      <url>/2018/12/16/kubernetes-auth/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>é¦–å…ˆéœ€è¦äº†è§£è¿™ä¸‰ç§æœºåˆ¶çš„åŒºåˆ«ï¼š</p><ul><li>è®¤è¯(Authenticating)æ˜¯å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ï¼Œé€šä¿—ç‚¹å°±æ˜¯ç”¨æˆ·åå¯†ç éªŒè¯ï¼Œ</li><li>æˆæƒ(Authorization)æ˜¯å¯¹èµ„æºçš„æˆæƒï¼Œk8sä¸­çš„èµ„æºæ— éæ˜¯å®¹å™¨ï¼Œæœ€ç»ˆå…¶å®å°±æ˜¯å®¹å™¨çš„è®¡ç®—ï¼Œç½‘ç»œï¼Œå­˜å‚¨èµ„æºï¼Œå½“ä¸€ä¸ªè¯·æ±‚ç»è¿‡è®¤è¯åï¼Œéœ€è¦è®¿é—®æŸä¸€ä¸ªèµ„æºï¼ˆæ¯”å¦‚åˆ›å»ºä¸€ä¸ªpodï¼‰ï¼Œæˆæƒæ£€æŸ¥éƒ½ä¼šé€šè¿‡è®¿é—®ç­–ç•¥æ¯”è¾ƒè¯¥è¯·æ±‚ä¸Šä¸‹æ–‡çš„å±æ€§ï¼Œï¼ˆæ¯”å¦‚ç”¨æˆ·ï¼Œèµ„æºå’ŒNamespaceï¼‰ï¼Œæ ¹æ®æˆæƒè§„åˆ™åˆ¤å®šè¯¥èµ„æºï¼ˆæ¯”å¦‚æŸnamespaceä¸‹çš„podï¼‰æ˜¯å¦æ˜¯è¯¥å®¢æˆ·å¯è®¿é—®çš„ã€‚</li><li>å‡†å…¥(Admission Control)æœºåˆ¶æ˜¯ä¸€ç§åœ¨æ”¹å˜èµ„æºçš„æŒä¹…åŒ–ä¹‹å‰ï¼ˆæ¯”å¦‚æŸäº›èµ„æºçš„åˆ›å»ºæˆ–åˆ é™¤ï¼Œä¿®æ”¹ç­‰ä¹‹å‰ï¼‰çš„æœºåˆ¶ã€‚<br>åœ¨k8sä¸­ï¼Œè¿™ä¸‰ç§æœºåˆ¶å¦‚ä¸‹å›¾ï¼š<br><img src="/2018/12/16/kubernetes-auth/k8s-authorition.png" alt="k8s-authorition"><br>k8sçš„æ•´ä½“æ¶æ„ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡çš„æ¶æ„ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªGateWayï¼Œä¹Ÿå°±æ˜¯kube-apiserverè¿™ä¸ªç»„ä»¶ï¼ˆå¯¹å¤–æä¾›RESTæœåŠ¡ï¼‰ï¼Œç”±å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œk8sä¸­å®¢æˆ·ç«¯æœ‰ä¸¤ç±»ï¼Œä¸€ç§æ˜¯æ™®é€šç”¨æˆ·ï¼Œä¸€ç§æ˜¯é›†ç¾¤å†…çš„Podï¼Œè¿™ä¸¤ç§å®¢æˆ·ç«¯çš„è®¤è¯æœºåˆ¶ç•¥æœ‰ä¸åŒï¼Œåæ–‡ä¼šè¯¦è¿°ã€‚ä½†æ— è®ºæ˜¯å“ªä¸€ç§ï¼Œéƒ½éœ€è¦ä¾æ¬¡ç»è¿‡è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥è¿™ä¸‰ä¸ªæœºåˆ¶ã€‚<br><img src="/2018/12/16/kubernetes-auth/auththentication&amp;authorization.png" alt="æˆªå›¾æ¥è‡ªåä¸ºCCEäº‘è¯¾å ‚"></li></ul><h1 id="kubernetes-ä¸­çš„è®¤è¯æœºåˆ¶"><a href="#kubernetes-ä¸­çš„è®¤è¯æœºåˆ¶" class="headerlink" title="kubernetes ä¸­çš„è®¤è¯æœºåˆ¶"></a>kubernetes ä¸­çš„è®¤è¯æœºåˆ¶</h1><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œkubernetesè™½ç„¶æä¾›äº†å¤šç§è®¤è¯æœºåˆ¶ï¼Œä½†å¹¶æ²¡æœ‰æä¾›user å®ä½“ä¿¡æ¯çš„å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè´¦æˆ·ä½“ç³»éœ€è¦æˆ‘ä»¬è‡ªå·±å»åšç»´æŠ¤ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥æ¥å…¥ç¬¬ä¸‰æ–¹è´¦æˆ·ä½“ç³»ï¼ˆå¦‚è°·æ­Œè´¦æˆ·ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¼€æºçš„keystoneå»åšæ•´åˆã€‚kubernetes æ”¯æŒå¤šç§è®¤è¯æœºåˆ¶ï¼Œå¯ä»¥é…ç½®æˆå¤šä¸ªè®¤è¯ä½“åˆ¶å…±å­˜ï¼Œè¿™æ ·ï¼Œåªè¦æœ‰ä¸€ä¸ªè®¤è¯é€šè¿‡ï¼Œè¿™ä¸ªrequestå°±è®¤è¯é€šè¿‡äº†ã€‚ä¸‹é¢åˆ—ä¸¾çš„æ˜¯å®˜ç½‘å‡ ç§å¸¸è§è®¤è¯æœºåˆ¶ï¼š</p><ul><li>X509 Client Certs</li><li>Static Token File</li><li>Bootstrap Tokens</li><li>Static Password File</li><li>Service Account Tokens</li><li>OpenID Connect Tokens</li></ul><p>è¿™é‡Œæˆ‘ä¸»è¦è¿˜æ˜¯ç†è§£ä¸€ä¸‹å¸¸ç”¨è®¤è¯æ–¹å¼:</p><h2 id="X509-Client-Certs"><a href="#X509-Client-Certs" class="headerlink" title="X509 Client Certs"></a>X509 Client Certs</h2><p>ä¹Ÿå«ä½œåŒå‘æ•°å­—è¯ä¹¦è®¤è¯ï¼ŒHTTPSè¯ä¹¦è®¤è¯ï¼Œæ˜¯åŸºäºCAæ ¹è¯ä¹¦ç­¾åçš„åŒå‘æ•°å­—è¯ä¹¦è®¤è¯æ–¹å¼ï¼Œæ˜¯æ‰€æœ‰è®¤è¯æ–¹å¼ä¸­æœ€ä¸¥æ ¼çš„è®¤è¯ã€‚é»˜è®¤åœ¨kubeadmåˆ›å»ºçš„é›†ç¾¤ä¸­æ˜¯enabledçš„ï¼Œå¯ä»¥åœ¨master nodeä¸ŠæŸ¥çœ‹kube-apiserverçš„podé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/bin/kube-apiserver \</span><br><span class="line">      <span class="attribute">--v</span>=2  \</span><br><span class="line">      <span class="attribute">--logtostderr</span>=<span class="literal">true</span>  \</span><br><span class="line">      <span class="attribute">--allow-privileged</span>=<span class="literal">true</span>  \</span><br><span class="line">      <span class="attribute">--bind-address</span>=0.0.0.0  \</span><br><span class="line">      <span class="attribute">--secure-port</span>=6443  \</span><br><span class="line">      <span class="attribute">--insecure-port</span>=0  \</span><br><span class="line">      <span class="attribute">--advertise-address</span>=192.168.56.110 \</span><br><span class="line">      <span class="attribute">--service-cluster-ip-range</span>=10.96.0.0/12  \</span><br><span class="line">      <span class="attribute">--service-node-port-range</span>=30000-32767  \</span><br><span class="line">      <span class="attribute">--etcd-servers</span>=https://192.168.56.111:2379,https://192.168.56.112:2379,https://192.168.56.113:2379 \</span><br><span class="line">      <span class="attribute">--etcd-cafile</span>=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      <span class="attribute">--etcd-certfile</span>=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      <span class="attribute">--etcd-keyfile</span>=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      <span class="attribute">--client-ca-file</span>=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      <span class="attribute">--tls-cert-file</span>=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      <span class="attribute">--tls-private-key-file</span>=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      <span class="attribute">--kubelet-client-certificate</span>=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      <span class="attribute">--kubelet-client-key</span>=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br></pre></td></tr></tbody></table></figure><p>ç›¸å…³çš„ä¸‰ä¸ªå¯åŠ¨å‚æ•°ï¼š</p><ul><li>client-ca-file: æŒ‡å®šCAæ ¹è¯ä¹¦æ–‡ä»¶ä¸º/etc/kubernetes/pki/ca.pem</li><li>tls-private-key-file: æŒ‡å®šApiServerç§é’¥æ–‡ä»¶ä¸º/etc/kubernetes/pki/apiserver-key.pem</li><li>tls-cert-fileï¼šæŒ‡å®šApiServerè¯ä¹¦æ–‡ä»¶ä¸º/etc/kubernetes/pki/apiserver.pem</li></ul><p>è¯·æ±‚ä¸­éœ€è¦å¸¦æœ‰ç”±è¯¥è¯ä¹¦ç­¾åçš„è¯ä¹¦ï¼Œæ‰èƒ½è®¤è¯é€šè¿‡ï¼Œå®¢æˆ·ç«¯ç­¾ç½²çš„è¯ä¹¦é‡ŒåŒ…å«user,groupä¿¡æ¯ï¼Œå…·ä½“ä¸ºè¯ä¹¦çš„subject.CommonName(username)ä»¥åŠsubject.Organization(group)</p><div style="width: 50%; margin: auto">![x509](kubernetes-auth/x509.png)</div><h2 id="Service-Account-Tokens"><a href="#Service-Account-Tokens" class="headerlink" title="Service Account Tokens"></a>Service Account Tokens</h2><p>Service Account Token æ˜¯ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„è®¤è¯æœºåˆ¶ï¼Œé€‚ç”¨äºä¸Šæ–‡ä¸­æåˆ°çš„podå†…éƒ¨æœåŠ¡éœ€è¦è®¿é—®apiserverçš„è®¤è¯æƒ…å†µï¼Œé»˜è®¤enabledã€‚<br>è¿˜æ˜¯çœ‹ä¸Šæ–‡ä¸­apiserver çš„å¯åŠ¨é…ç½®å‚æ•°æœ‰â€“service-account-key-fileï¼Œå¦‚æœæ²¡æœ‰æŒ‡æ˜æ–‡ä»¶ï¼Œé»˜è®¤ä½¿ç”¨â€“tls-private-key-fileçš„å€¼ï¼Œå³API Serverçš„ç§é’¥ã€‚</p><div style="width: 50%; margin: auto">![ServiceAccountå·¥ä½œæµç¨‹](kubernetes-auth/sa.png) </div><p>é€šè¿‡æ§åˆ¶å™¨ServiceAccountControllerä¼šå»list,watch k8s apiserverå¯¹äºå‘½åç©ºé—´çš„åˆ›å»ºã€åˆ é™¤ï¼›<br>å°±ä¼šåœ¨æ–°åˆ›å»ºçš„åç§°ç©ºé—´ä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºâ€defaultâ€çš„service account;</p><p>TokenController æ ¹æ®åˆ›å»ºçš„ServiceAccountä¸‹é¢å…³è”ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰Tokençš„secretã€‚<br>Admission æ˜¯åœ¨é€šè¿‡è®¤è¯è¿›è¡Œé‰´æƒçš„ä¸€ä¸ªé˜¶æ®µï¼Œé‚£ä¹ˆä»–ä¼šé»˜è®¤ç»™å½“å‰åç§°ç©ºé—´ä¸‹çš„podæ‰“ä¸Šï¼Œå½“å‰åç§°ç©ºé—´çš„é‚£ä¸ªServiceAccountã€‚</p><p>service accoutæœ¬èº«æ˜¯ä½œä¸ºä¸€ç§èµ„æºåœ¨k8sé›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè·å–</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get sa <span class="operator">-</span>-all-namespaces</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                 SECRETS   AGE</span><br><span class="line">default       default                              <span class="number">1</span>         <span class="number">16</span>d</span><br><span class="line">kube-system   default                              <span class="number">1</span>         <span class="number">16</span>d</span><br><span class="line">kube-public   default                              <span class="number">1</span>         <span class="number">16</span>d</span><br><span class="line">kube-system   attachdetach-controller              <span class="number">1</span>         <span class="number">16</span>d</span><br><span class="line">kube-system   bootstrap-signer                     <span class="number">1</span>         <span class="number">16</span>d</span><br><span class="line">kube-system   calico-node                          <span class="number">1</span>         <span class="number">16</span></span><br><span class="line">...........</span><br><span class="line">...........</span><br><span class="line"></span><br><span class="line">$ kubectl describe serviceaccount<span class="symbol">/default</span> <span class="operator">-</span>n kube-system</span><br><span class="line"><span class="params">Name:</span>                default</span><br><span class="line"><span class="params">Namespace:</span>           kube-system</span><br><span class="line"><span class="params">Labels:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>         <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Image pull <span class="params">secrets:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Mountable <span class="params">secrets:</span>   default-token-q9s9l</span><br><span class="line"><span class="params">Tokens:</span>              default-token-q9s9l</span><br><span class="line"><span class="params">Events:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line">$ kubectl get secret default-token-q9s9l <span class="operator">-</span>o yaml <span class="operator">-</span>n kube-system</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  ca.<span class="params">crt:</span> LS0tLS1CRUdJ ...............ç•¥</span><br><span class="line">  <span class="params">namespace:</span> a3ViZS1zeXN0ZW0<span class="operator">=</span></span><br><span class="line">  <span class="params">token:</span> ZXlKaGJHY2lPaUpTVX- ...............ç•¥</span><br><span class="line"><span class="params">kind:</span> Secret</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">annotations:</span></span><br><span class="line">    kubernetes.io<span class="operator">/</span>service-account.<span class="params">name:</span> default</span><br><span class="line">    kubernetes.io<span class="operator">/</span>service-account.<span class="params">uid:</span> a5568634-f445-<span class="number">11</span>e8-b4c4-<span class="number">000</span>c295134cf</span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="number">201</span>8-<span class="number">1</span>1-<span class="number">30</span>T02:<span class="number">14</span>:<span class="number">19</span>Z</span><br><span class="line">  <span class="params">name:</span> default-token-q9s9l</span><br><span class="line">  <span class="params">namespace:</span> kube-system</span><br><span class="line">  <span class="params">resourceVersion:</span> <span class="string">"337"</span></span><br><span class="line">  <span class="params">selfLink:</span> <span class="symbol">/api/v1/namespaces/kube-system/secrets/default-token-q9s9l</span></span><br><span class="line">  <span class="params">uid:</span> a56521fd-f445-<span class="number">11</span>e8-aa44-<span class="number">000</span>c29fe5618</span><br><span class="line"><span class="params">type:</span> kubernetes.io<span class="symbol">/service-account-token</span></span><br><span class="line">[root@k8s-m1 kubelet]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°service-account-tokençš„secretèµ„æºåŒ…å«çš„æ•°æ®æœ‰ä¸‰éƒ¨åˆ†ï¼š</p><ul><li>ca.crtï¼Œè¿™æ˜¯API Serverçš„CAå…¬é’¥è¯ä¹¦ï¼Œç”¨äºPodä¸­çš„Processå¯¹API Serverçš„æœåŠ¡ç«¯æ•°å­—è¯ä¹¦è¿›è¡Œæ ¡éªŒæ—¶ä½¿ç”¨çš„ï¼›</li><li>namespaceï¼Œè¿™æ˜¯Secretæ‰€åœ¨namespaceçš„å€¼çš„base64ç¼–ç ï¼š# echo -n â€œkube-systemâ€|base64 =&gt; â€œa3ViZS1zeXN0ZW0=â€</li><li>tokenï¼šè¯¥tokenå°±æ˜¯ç”±service-account-key-fileçš„å€¼ç­¾ç½²(sign)ç”Ÿæˆã€‚</li></ul><h3 id="API-Serverçš„service-account-authentication-èº«ä»½éªŒè¯"><a href="#API-Serverçš„service-account-authentication-èº«ä»½éªŒè¯" class="headerlink" title="API Serverçš„service account authentication(èº«ä»½éªŒè¯)"></a>API Serverçš„service account authentication(èº«ä»½éªŒè¯)</h3><p>å‰é¢è¯´è¿‡ï¼Œservice accountä¸ºPodä¸­çš„Processæä¾›äº†ä¸€ç§èº«ä»½æ ‡è¯†ï¼Œåœ¨Kubernetesçš„èº«ä»½æ ¡éªŒ(authenticating)ç¯èŠ‚ï¼Œä»¥æŸä¸ªservice accountæä¾›èº«ä»½çš„Podçš„ç”¨æˆ·åä¸ºï¼š</p><figure class="highlight vbnet"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">system:</span>serviceaccount:(<span class="keyword">NAMESPACE</span>):(SERVICEACCOUNT)</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šé¢é‚£ä¸ªkube-system namespaceä¸‹çš„<code>default</code> service accountä¸ºä¾‹ï¼Œä½¿ç”¨å®ƒçš„Podçš„usernameå…¨ç§°ä¸ºï¼š</p><figure class="highlight hsp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">system</span>:serviceaccount:kube-<span class="keyword">system</span>:<span class="keyword">default</span></span><br></pre></td></tr></tbody></table></figure><h3 id="é»˜è®¤çš„service-account"><a href="#é»˜è®¤çš„service-account" class="headerlink" title="é»˜è®¤çš„service account"></a>é»˜è®¤çš„service account</h3><p>Kubernetesä¼šä¸ºæ¯ä¸ªclusterä¸­çš„namespaceè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„service accountèµ„æºï¼Œå¹¶å‘½åä¸ºâ€defaultâ€.</p><p>å¦‚æœPodä¸­æ²¡æœ‰æ˜¾å¼æŒ‡å®šspec.serviceAccountå­—æ®µå€¼(è‡ªå®šä¹‰Admission)ï¼Œé‚£ä¹ˆKubernetesä¼šé»˜è®¤å°†è¯¥namespaceä¸‹çš„default service accountè‡ªåŠ¨mountåˆ°åœ¨è¿™ä¸ªnamespaceä¸­åˆ›å»ºçš„Podé‡Œï¼Œé‚£è¿™ä¸ªæ“ä½œå°±æ˜¯é€šè¿‡ä¸Šé¢æ‰€è¯´çš„ServiceAccountAdmissionæ¥å®ç°çš„ã€‚<br>æˆ‘ä»¬ä»¥namespace â€œdefaultâ€ä¸ºä¾‹ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹å…¶ä¸­çš„ä¸€ä¸ªPodçš„ä¿¡æ¯ï¼š</p><figure class="highlight lasso"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pod nginx<span class="number">-64</span>f497f8fd<span class="params">-lkmdr</span></span><br><span class="line">Name:           nginx<span class="number">-64</span>f497f8fd<span class="params">-lkmdr</span></span><br><span class="line">Namespace:      default</span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line">Containers:</span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line">      Mounts:</span><br><span class="line">      /<span class="built_in">var</span>/run/secrets/kubernetes.io/serviceaccount from default<span class="params">-token</span><span class="params">-d5d8g</span> (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  <span class="keyword">Type</span>              Status</span><br><span class="line">  Initialized       <span class="literal">True</span></span><br><span class="line">  Ready             <span class="literal">False</span></span><br><span class="line">  ContainersReady   <span class="literal">False</span></span><br><span class="line">  PodScheduled      <span class="literal">True</span></span><br><span class="line">Volumes:</span><br><span class="line"> <span class="params">...</span><span class="params">...</span></span><br><span class="line"> <span class="params">...</span><span class="params">...</span></span><br><span class="line">Events:</span><br><span class="line">  <span class="keyword">Type</span>    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  <span class="number">27</span>s   default<span class="params">-scheduler</span>  Successfully assigned default/nginx<span class="number">-64</span>f497f8fd<span class="params">-lkmdr</span> <span class="keyword">to</span> k8s<span class="params">-m3</span></span><br><span class="line">  Normal  Pulling    <span class="number">17</span>s   kubelet, k8s<span class="params">-m3</span>    pulling image <span class="string">"nginx"</span></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œkuberneteså°†default namespaceä¸­çš„service account â€œdefaultâ€çš„service account tokenæŒ‚è½½(mount)åˆ°äº†Podä¸­å®¹å™¨çš„/var/run/secrets/kubernetes.io/serviceaccountè·¯å¾„ä¸‹ã€‚</p><p>æ·±å…¥å®¹å™¨å†…éƒ¨ï¼ŒæŸ¥çœ‹mountçš„serviceaccountè·¯å¾„ä¸‹çš„ç»“æ„ï¼š</p><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec nginx-64f497f8fd-lkmdr -- <span class="keyword">ls</span> /<span class="keyword">var</span>/<span class="keyword">run</span>/secrets/kubernetes.io/serviceaccount</span><br><span class="line"><span class="keyword">ca</span>.crt</span><br><span class="line">namespace</span><br><span class="line"><span class="keyword">token</span></span><br><span class="line"></span><br><span class="line"># è¿™ä¸‰ä¸ªæ–‡ä»¶ä¸ä¸Šé¢æåˆ°çš„service accountçš„<span class="keyword">token</span>ä¸­çš„æ•°æ®æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚</span><br></pre></td></tr></tbody></table></figure><h3 id="å¦‚ä½•åˆ›å»ºä¸€ä¸ªServiceAccount"><a href="#å¦‚ä½•åˆ›å»ºä¸€ä¸ªServiceAccount" class="headerlink" title="å¦‚ä½•åˆ›å»ºä¸€ä¸ªServiceAccount"></a>å¦‚ä½•åˆ›å»ºä¸€ä¸ªServiceAccount</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡å‘½ä»¤è¡Œç›´æ¥åˆ›å»º</span></span><br><span class="line">$ kubectl create sa myk8ssa</span><br><span class="line">serviceaccount<span class="symbol">/myk8ssa</span> created</span><br><span class="line">$ kubectl describe sa<span class="symbol">/myk8ssa</span></span><br><span class="line"><span class="params">Name:</span>                mysa</span><br><span class="line"><span class="params">Namespace:</span>           default</span><br><span class="line"><span class="params">Labels:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>         <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Image pull <span class="params">secrets:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Mountable <span class="params">secrets:</span>   mysa-token-kcwqm</span><br><span class="line"><span class="params">Tokens:</span>              mysa-token-kcwqm</span><br><span class="line"><span class="params">Events:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚ä½•ä½¿ç”¨ï¼Ÿä¸‹é¢æˆ‘åœ¨è®¨è®º</span></span><br></pre></td></tr></tbody></table></figure><h1 id="kubernetes-ä¸­çš„é‰´æƒæœºåˆ¶"><a href="#kubernetes-ä¸­çš„é‰´æƒæœºåˆ¶" class="headerlink" title="kubernetes ä¸­çš„é‰´æƒæœºåˆ¶"></a>kubernetes ä¸­çš„é‰´æƒæœºåˆ¶</h1><p>ç›®å‰ï¼Œk8s ä¸­ä¸€å…±æœ‰ 4 ç§é‰´æƒæƒé™æ¨¡å¼ï¼š</p><ul><li>Node: ä¸€ç§ç‰¹æ®Šç›®çš„çš„æˆæƒæ¨¡å¼ï¼Œä¸»è¦ç”¨æ¥è®© kubernetes éµä» node çš„ç¼–æ’è§„åˆ™ï¼Œå®é™…ä¸Šæ˜¯ RBAC çš„ä¸€éƒ¨åˆ†ï¼Œç›¸å½“äºåªå®šä¹‰äº† node è¿™ä¸ªè§’è‰²ä»¥åŠå®ƒçš„æƒé™ï¼›</li><li>ABAC: Attribute-based access controlï¼›</li><li>RBAC: Role-based access controlï¼›</li><li>Webhook: ä»¥ HTTP Callback çš„æ–¹å¼ï¼Œåˆ©ç”¨å¤–éƒ¨æˆæƒæ¥å£æ¥è¿›è¡Œæƒé™æ§åˆ¶ï¼›</li></ul><p>è¿™é‡Œæˆ‘ä¸»è¦å­¦ä¹ æ€»ç»“æœ€å¸¸ç”¨çš„é‰´æƒæ–¹å¼â€”<code>RBAC</code><br>RBACçš„é‰´æƒç­–ç•¥å¯ä»¥åˆ©ç”¨ kubectl æˆ–è€… Kubernetes API ç›´æ¥è¿›è¡Œé…ç½®ã€‚RBAC å¯ä»¥æˆæƒç»™ç”¨æˆ·ï¼Œè®©ç”¨æˆ·æœ‰æƒè¿›è¡Œæˆæƒç®¡ç†ï¼Œè¿™æ ·å°±å¯ä»¥æ— éœ€æ¥è§¦èŠ‚ç‚¹ï¼Œç›´æ¥è¿›è¡Œæˆæƒç®¡ç†ã€‚RBAC åœ¨ Kubernetes ä¸­è¢«æ˜ å°„ä¸º API èµ„æºå’Œæ“ä½œã€‚</p><div style="width: 50%; margin: auto">![RBAC](kubernetes-auth/RBAC.png)</div><p>éœ€è¦ç†è§£ RBAC ä¸€äº›åŸºç¡€çš„æ¦‚å¿µå’Œæ€è·¯ï¼ŒRBAC æ˜¯è®©ç”¨æˆ·èƒ½å¤Ÿè®¿é—® Kubernetes API èµ„æºçš„æˆæƒæ–¹å¼ã€‚</p><p><em><strong>role</strong></em><br>è§’è‰²æ˜¯ä¸€ç³»åˆ—æƒé™çš„é›†åˆï¼Œä¾‹å¦‚ä¸€ä¸ªè§’è‰²å¯ä»¥åŒ…å«è¯»å– Pod çš„æƒé™å’Œåˆ—å‡º Pod çš„æƒé™ï¼Œ ClusterRole è·Ÿ Role ç±»ä¼¼ï¼Œä½†æ˜¯å¯ä»¥åœ¨é›†ç¾¤ä¸­åˆ°å¤„ä½¿ç”¨ï¼ˆ Role æ˜¯ namespace ä¸€çº§çš„ï¼‰ã€‚<br><em><strong>role binding</strong></em><br>RoleBinding æŠŠè§’è‰²æ˜ å°„åˆ°ç”¨æˆ·ï¼Œä»è€Œè®©è¿™äº›ç”¨æˆ·ç»§æ‰¿è§’è‰²åœ¨ namespace ä¸­çš„æƒé™ã€‚ClusterRoleBinding è®©ç”¨æˆ·ç»§æ‰¿ ClusterRole åœ¨æ•´ä¸ªé›†ç¾¤ä¸­çš„æƒé™ã€‚</p><p>å¦å¤–è¿˜è¦è€ƒè™‘<code>cluster roles</code>å’Œ<code>cluster role binding</code>ã€‚cluster roleå’Œcluster role bindingæ–¹æ³•è·Ÿroleå’Œrole bindingä¸€æ ·ï¼Œå‡ºäº†å®ƒä»¬æœ‰æ›´å¹¿çš„scopeã€‚</p><p><em><strong>Kubernetesä¸­çš„RBAC</strong></em><br>RBAC ç°åœ¨è¢« Kubernetes æ·±åº¦é›†æˆï¼Œå¹¶ä½¿ç”¨ä»–ç»™ç³»ç»Ÿç»„ä»¶è¿›è¡Œæˆæƒã€‚System Roles ä¸€èˆ¬å…·æœ‰å‰ç¼€system:ï¼Œå¾ˆå®¹æ˜“è¯†åˆ«ï¼š</p><figure class="highlight x86asm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get clusterroles --namespace=kube-system</span><br><span class="line">NAME                                                                   AGE</span><br><span class="line">admin                                                                  <span class="number">16d</span></span><br><span class="line">anonymous-dashboard-proxy-role                                         <span class="number">16d</span></span><br><span class="line">calico-node                                                            <span class="number">16d</span></span><br><span class="line">calicoctl                                                              <span class="number">16d</span></span><br><span class="line">cluster-admin                                                          <span class="number">16d</span></span><br><span class="line">edit                                                                   <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>aggregate-to-admin                                              <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>aggregate-to-edit                                               <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>aggregate-to-view                                               <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>auth-delegator                                                  <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>aws-cloud-provider                                              <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>basic-user                                                      <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>certificates<span class="number">.</span>k8s<span class="number">.</span>io:certificatesigningrequests:nodeclient       <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>certificates<span class="number">.</span>k8s<span class="number">.</span>io:certificatesigningrequests:selfnodeclient   <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:attachdetach-controller                              <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:certificate-controller                               <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:clusterrole-aggregation-controller                   <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:cronjob-controller                                   <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:daemon-set-controller                                <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:deployment-controller                                <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:disruption-controller                                <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:endpoint-controller                                  <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:expand-controller                                    <span class="number">16d</span></span><br><span class="line">......ç•¥</span><br></pre></td></tr></tbody></table></figure><p>ç¤ºä¾‹ï¼š</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> role.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">kind:</span> Role</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line">  <span class="params">name:</span> pod-reader</span><br><span class="line"><span class="params">rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">""</span>] <span class="comment"># "" indicates the core API group</span></span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"pods"</span>] <span class="comment"># å¯ç”¨æ“ä½œèµ„æºå¯¹è±¡</span></span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"get"</span>, <span class="string">"watch"</span>, <span class="string">"list"</span>] <span class="comment"># å¯¹ä¸Šé¢å®šä¹‰èµ„æºæœ‰å“ªäº›æ“ä½œæƒé™</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> rolebinding.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">kind:</span> RoleBinding</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> pod-reader-binding</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">subjects:</span>  </span><br><span class="line"><span class="operator">-</span> <span class="params">kind:</span> ServiceAccount </span><br><span class="line">  <span class="params">name:</span> mysa  </span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">roleRef:</span></span><br><span class="line">    <span class="params">kind:</span> Role</span><br><span class="line">    <span class="params">name:</span> pod-reader</span><br><span class="line">    <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»º</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f role.yaml</span><br><span class="line">role.rbac.authorization.k8s.io<span class="symbol">/pod-reader</span> created</span><br><span class="line">$ kubectl create <span class="operator">-</span>f rolebinding.yaml</span><br><span class="line">rolebinding.rbac.authorization.k8s.io<span class="symbol">/pod-reader-binding</span> created</span><br><span class="line"></span><br><span class="line">[root@k8s-m1 ~]<span class="comment"># kubectl get role</span></span><br><span class="line">NAME         AGE</span><br><span class="line">pod-reader   <span class="number">36</span>s</span><br><span class="line">[root@k8s-m1 ~]<span class="comment"># kubectl describe role pod-reader</span></span><br><span class="line"><span class="params">Name:</span>         pod-reader</span><br><span class="line"><span class="params">Labels:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">PolicyRule:</span></span><br><span class="line">  Resources  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  <span class="operator">-</span>--------  <span class="operator">-</span>----------------  <span class="operator">-</span>-------------  <span class="operator">-</span>----</span><br><span class="line">  pods       []                 []              [get watch list]</span><br><span class="line">$ kubectl describe rolebinding pod-reader-binding</span><br><span class="line"><span class="params">Name:</span>         pod-reader-binding</span><br><span class="line"><span class="params">Labels:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Role:</span></span><br><span class="line">  <span class="params">Kind:</span>  Role</span><br><span class="line">  <span class="params">Name:</span>  pod-reader</span><br><span class="line"><span class="params">Subjects:</span></span><br><span class="line">  Kind            Name  Namespace</span><br><span class="line">  <span class="operator">-</span>---            <span class="operator">-</span>---  <span class="operator">-</span>--------</span><br><span class="line">  ServiceAccount  mysa  default</span><br><span class="line"> </span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢ï¼Œ</p><ol><li>æˆ‘å®šä¹‰äº†ä¸€ä¸ªpod-readerçš„role,å…¶ä¸­å®ƒçš„æƒé™å®šä¹‰å¦‚ä¸Šæ–¹å®šä¹‰çš„<code>get</code>,<code>watch</code>,<code>list</code>;</li><li>ç„¶åå®šä¹‰äº†ä¸€ä¸ªpod-reader-bindingçš„rolebinding<br>å‰é¢æåˆ°è¿‡ï¼›ç”¨æˆ·é€šè¿‡è®¤è¯ä¹‹åå°±æ˜¯é‰´æƒï¼Œé€šè¿‡SAçš„è®¤è¯æ–¹å¼ä¹‹åæ‹¿åˆ°userinfo,ç„¶åç»‘å®šåˆ°roleé‡Œé¢ï¼›é‚£ä¹ˆæ­¤æ—¶å¯¹åº”çš„ç”¨æˆ·æƒé™å°±æ˜¯roleé‡Œé¢å®šä¹‰çš„æƒé™ï¼Œsubjectsåº”ç”¨çš„å¯¹è±¡ç±»å‹ä¹Ÿå¯ä»¥æ˜¯User,Group;æ€»ä¹‹æ­¤æ—¶è¿™ä¸€æ­¥å°±æ˜¯è·å–åˆ°userinfoä¿¡æ¯ï¼Œç„¶åé€šè¿‡è§’è‰²ç»‘å®šã€‚ç›¸å¯¹åº”çš„æƒé™å°±ä¼šèµ‹äºˆè¯¥ç”¨æˆ·ã€‚é‚£ç”¨æˆ·ä»ä½•è€Œæ¥ï¼Ÿä¸‹é¢å°±éœ€è¦åˆ›å»ºä¸€ä¸ªç”¨æˆ·æ¥è®¿é—®æˆ‘ä»¬çš„é›†ç¾¤äº†ã€‚</li></ol><p>é‚£å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ServiceAccountæ¥ç™»å½•å¹¶ä¸”é€šè¿‡è‡ªå®šä¹‰çš„è¿™ä¸ªRBACæ¥é‰´æƒå‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°äº†kubeconfigæ–‡ä»¶ç”Ÿæˆçš„é—®é¢˜äº†</p><h2 id="åˆ›å»ºkubeconfig"><a href="#åˆ›å»ºkubeconfig" class="headerlink" title="åˆ›å»ºkubeconfig"></a>åˆ›å»ºkubeconfig</h2><h3 id="è·å–ä¸Šé¢å·²åˆ›å»ºçš„ServiceAccountçš„Seteråç§°"><a href="#è·å–ä¸Šé¢å·²åˆ›å»ºçš„ServiceAccountçš„Seteråç§°" class="headerlink" title="è·å–ä¸Šé¢å·²åˆ›å»ºçš„ServiceAccountçš„Seteråç§°"></a>è·å–ä¸Šé¢å·²åˆ›å»ºçš„ServiceAccountçš„Seteråç§°</h3><p>è¿™é‡Œæˆ‘æ˜¯åœ¨é»˜è®¤namespaceä¸‹é¢åˆ›å»ºçš„ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe sa<span class="symbol">/myk8ssa</span></span><br><span class="line"><span class="params">Name:</span>                myk8ssa</span><br><span class="line"><span class="params">Namespace:</span>           default</span><br><span class="line"><span class="params">Labels:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>         <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Image pull <span class="params">secrets:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Mountable <span class="params">secrets:</span>   myk8ssa-token-<span class="number">2</span>kntd</span><br><span class="line"><span class="params">Tokens:</span>              myk8ssa-token-<span class="number">2</span>kntd</span><br><span class="line"><span class="params">Events:</span>              <span class="symbol">&lt;none&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="è·å–secretä¸‹çš„tokenï¼Œå¹¶base64è§£ç è·å–tokenæ˜æ–‡"><a href="#è·å–secretä¸‹çš„tokenï¼Œå¹¶base64è§£ç è·å–tokenæ˜æ–‡" class="headerlink" title="è·å–secretä¸‹çš„tokenï¼Œå¹¶base64è§£ç è·å–tokenæ˜æ–‡"></a>è·å–secretä¸‹çš„tokenï¼Œå¹¶base64è§£ç è·å–tokenæ˜æ–‡</h3><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="attribute">token</span>=`kubectl <span class="built_in">get</span><span class="built_in"> secret </span>myk8ssa-token-2kntd -oyaml |grep token: | awk <span class="string">'{print $2}'</span> | xargs echo -n | base64 -d`</span><br><span class="line">$ echo <span class="variable">$token</span></span><br><span class="line">eyJhbGciOiJSUzI1<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>ç•¥</span><br></pre></td></tr></tbody></table></figure><h3 id="æ–°å¢ç”¨æˆ·guomaoqiu"><a href="#æ–°å¢ç”¨æˆ·guomaoqiu" class="headerlink" title="æ–°å¢ç”¨æˆ·guomaoqiu"></a>æ–°å¢ç”¨æˆ·guomaoqiu</h3><figure class="highlight dsconfig"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-cluster</span> <span class="string">my-k8s</span> <span class="built_in">--server=https://192.168.56.110:8443</span> \</span><br><span class="line"><span class="built_in">--certificate-authority=/etc/kubernetes/pki/ca.pem</span> \</span><br><span class="line"><span class="built_in">--embed-certs=true</span></span><br><span class="line"><span class="string">Cluster</span> <span class="string">"my-k8s"</span> <span class="string">set</span>.</span><br><span class="line"></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-credentials</span> <span class="string">guomaoqiu</span> <span class="built_in">--token=$token</span></span><br><span class="line"><span class="string">User</span> <span class="string">"guomaoqiu"</span> <span class="string">set</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-context</span> <span class="string">my-k8s</span> <span class="built_in">--cluster=kubernetes</span></span><br><span class="line"><span class="string">Context</span> <span class="string">"my-k8s"</span> <span class="string">created</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-context</span> <span class="string">my-k8s</span> <span class="built_in">--user=guomaoqiu</span></span><br><span class="line"><span class="string">Context</span> <span class="string">"my-k8s"</span> <span class="string">modified</span>.</span><br></pre></td></tr></tbody></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config get-contexts</span><br><span class="line">CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE</span><br><span class="line">          kubernetes-admin@kubernetes   kubernetes   kubernetes-admin</span><br><span class="line"><span class="operator">*</span>         my-k8s                        kubernetes   guomaoqiu</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å…¶è®¾ç½®ä¸ºå½“å‰é»˜è®¤ä¸Šä¸‹æ–‡:</span></span><br><span class="line">$ kubectl config use-context my-k8s</span><br><span class="line">Switched to context <span class="string">"my-k8s"</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–POD:</span></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                     READY     STATUS    RESTARTS   AGE</span><br><span class="line">nginx-<span class="number">64</span>f497f8fd-<span class="number">4</span>qdnt   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">10</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°è¯•åˆ é™¤POD:</span></span><br><span class="line">$ kubectl delete pod nginx-<span class="number">64</span>f497f8fd-<span class="number">4</span>qdnt</span><br><span class="line">Error from server (Forbidden): pods <span class="string">"nginx-64f497f8fd-4qdnt"</span> is <span class="params">forbidden:</span> User <span class="string">"system:serviceaccount:default:myk8ssa"</span> cannot delete pods <span class="keyword">in</span> the namespace <span class="string">"default"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯è§ï¼Œè¯¥ç”¨æˆ·çš„çš„æƒé™åªæœ‰å¯è¯»ï¼Œè€Œæ²¡æœ‰åˆ é™¤çš„æƒé™ï¼›</span></span><br><span class="line"><span class="comment"># è¯´æ˜é…ç½®æ˜¯æˆåŠŸäº†çš„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æµè§ˆä¸€ä¸‹å½“å‰æˆ‘ç¯å¢ƒä¸­æœ‰å“ªäº›kubeconfig?</span></span><br><span class="line">$ kubectl config view</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">clusters:</span></span><br><span class="line"><span class="operator">-</span> <span class="params">cluster:</span></span><br><span class="line">    <span class="params">certificate-authority-data:</span> REDACTED</span><br><span class="line">    <span class="params">server:</span> https:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">56.110</span>:<span class="number">8443</span></span><br><span class="line">  <span class="params">name:</span> kubernetes</span><br><span class="line"><span class="operator">-</span> <span class="params">cluster:</span></span><br><span class="line">    <span class="params">certificate-authority-data:</span> REDACTED</span><br><span class="line">    <span class="params">server:</span> https:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">56.110</span>:<span class="number">8443</span></span><br><span class="line">  <span class="params">name:</span> my-k8s</span><br><span class="line"><span class="params">contexts:</span></span><br><span class="line"><span class="operator">-</span> <span class="params">context:</span></span><br><span class="line">    <span class="params">cluster:</span> kubernetes</span><br><span class="line">    <span class="params">user:</span> kubernetes-admin</span><br><span class="line">  <span class="params">name:</span> kubernetes-admin@kubernetes</span><br><span class="line"><span class="operator">-</span> <span class="params">context:</span></span><br><span class="line">    <span class="params">cluster:</span> kubernetes</span><br><span class="line">    <span class="params">user:</span> guomaoqiu</span><br><span class="line">  <span class="params">name:</span> my-k8s</span><br><span class="line"><span class="params">current-context:</span> my-k8s  <span class="comment"># å½“å‰ç¯å¢ƒ</span></span><br><span class="line"><span class="params">kind:</span> Config</span><br><span class="line"><span class="params">preferences:</span> {}</span><br><span class="line"><span class="params">users:</span></span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> guomaoqiu</span><br><span class="line">  <span class="params">user:</span></span><br><span class="line">    token:......ç•¥</span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> kubernetes-admin</span><br><span class="line">  <span class="params">user:</span></span><br><span class="line">    <span class="params">client-certificate-data:</span> REDACTED</span><br><span class="line">    <span class="params">client-key-data:</span> REDACTED</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡namespaceæˆ‘ä»¬å¯ä»¥åšåˆ°ä¸åŒä¸šåŠ¡ä¹‹é—´çš„éš”ç¦»ï¼Œå¦‚æœå†åŠ ä¸Šå¦‚ä¸Šè¿™ç§æƒé™æ§åˆ¶å°†ä¼šæ›´åŠ ç»†åŒ–ã€ä»¥ä¸Šå®éªŒä¸»è¦æ˜¯åœ¨é»˜è®¤çš„namespaceä¸‹é¢æ“ä½œï¼Œé™¤æ­¤ä¹‹å¤–ä¹Ÿå¯ä»¥æ–°å»ºnamespaceç„¶åè¿›è¡ŒéªŒè¯æ“ä½œã€‚<code>kubeconfig</code>åˆ‡æ¢ä¸Šä¸‹æ–‡ä¹Ÿæ˜¯éå¸¸å®ç”¨çš„ä¸€ç§åŠŸèƒ½ã€‚<br>å¸¸ç”¨å‘½ä»¤ï¼š</p><figure class="highlight dsconfig"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> - ä½¿ç”¨<span class="string">kubectl</span>æ¥ç®¡ç†<span class="string">Kubernetes</span>é›†ç¾¤ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">set</span> - åœ¨<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªå•ç‹¬çš„å€¼ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-cluster</span> - åœ¨<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªé›†ç¾¤é¡¹ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-context</span> - åœ¨<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªç¯å¢ƒé¡¹ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-credentials</span> - åœ¨<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªç”¨æˆ·é¡¹ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">unset</span> - åœ¨<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ä¸­æ¸…é™¤ä¸€ä¸ªå•ç‹¬çš„å€¼ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">use-context</span> - ä½¿ç”¨<span class="string">kubeconfig</span>ä¸­çš„ä¸€ä¸ªç¯å¢ƒé¡¹ä½œä¸ºå½“å‰é…ç½®ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">view</span> - æ˜¾ç¤ºåˆå¹¶åçš„<span class="string">kubeconfig</span>è®¾ç½®ï¼Œæˆ–è€…ä¸€ä¸ªæŒ‡å®šçš„<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ã€‚</span><br></pre></td></tr></tbody></table></figure><h1 id="kubernetes-ä¸­çš„å‡†å…¥æœºåˆ¶"><a href="#kubernetes-ä¸­çš„å‡†å…¥æœºåˆ¶" class="headerlink" title="kubernetes ä¸­çš„å‡†å…¥æœºåˆ¶"></a>kubernetes ä¸­çš„å‡†å…¥æœºåˆ¶</h1><p>Kubernetesçš„Admission Controlå®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡†å…¥æ§åˆ¶å™¨(Admission Controller)æ’ä»¶åˆ—è¡¨ï¼Œå‘é€åˆ°APIServerçš„è¯·æ±‚éƒ½éœ€è¦ç»è¿‡è¿™ä¸ªåˆ—è¡¨ä¸­çš„æ¯ä¸ªå‡†å…¥æ§åˆ¶å™¨æ’ä»¶çš„æ£€æŸ¥ï¼Œå¦‚æœæŸä¸€ä¸ªæ§åˆ¶å™¨æ’ä»¶å‡†å…¥å¤±è´¥ï¼Œå°±å‡†å…¥å¤±è´¥ã€‚<br>æ›´å¤šå¯æŸ¥çœ‹: <a href="http://docs.kubernetes.org.cn/144.html">http://docs.kubernetes.org.cn/144.html</a><br>è¿™é‡Œæˆ‘ä»¬ä¸»è¦å­¦ä¹ <code>PodSecurityPolicy</code></p><h2 id="å®‰å…¨ä¸Šä¸‹æ–‡-Pod-SecurityContext"><a href="#å®‰å…¨ä¸Šä¸‹æ–‡-Pod-SecurityContext" class="headerlink" title="å®‰å…¨ä¸Šä¸‹æ–‡(Pod SecurityContext)"></a>å®‰å…¨ä¸Šä¸‹æ–‡(Pod SecurityContext)</h2><p>åˆ†ä¸ºPodçº§åˆ«å’Œå®¹å™¨çº§åˆ«ï¼Œå®¹å™¨çº§åˆ«çš„ä¼šè¦†ç›–Podçº§åˆ«çš„ç›¸åŒè®¾ç½®ã€‚<br>åœ¨æœ‰PodSecurityPolicyç­–ç•¥çš„æƒ…å†µä¸‹ï¼Œä¸¤è€…éœ€è¦é…åˆä½¿ç”¨;</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> pod-security-policy.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> test</span><br><span class="line">      <span class="params">emptyDir:</span> {}</span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> test-pod</span><br><span class="line">      <span class="params">image:</span> alpine</span><br><span class="line">      <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">      <span class="params">command:</span> ['sh', '-c', 'echo The app is running<span class="operator">!</span> <span class="operator">&amp;&amp;</span> sleep <span class="number">36000</span>']</span><br><span class="line">      <span class="params">volumeMounts:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> test</span><br><span class="line">          <span class="params">mountPath:</span> <span class="symbol">/data/test</span></span><br><span class="line">      <span class="params">securityContext:</span>    <span class="comment"># è®¾ç½®å®¹å™¨å®‰å…¨ä¸Šä¸‹æ–‡</span></span><br><span class="line">        <span class="params">readOnlyRootFilesystem:</span> <span class="literal">false</span>  <span class="comment"># å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æ˜¯åªè¯»</span></span><br><span class="line">        <span class="params">privileged:</span> <span class="literal">false</span> <span class="comment"># æ˜¯å¦ä¸ºç‰¹æƒå®¹å™¨</span></span><br><span class="line">        <span class="params">runAsUser:</span> <span class="number">1000</span>   <span class="comment"># è¿›ç¨‹è¿è¡Œç”¨æˆ·UID</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»º:</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f pod-security-policy.yaml</span><br><span class="line">pod<span class="symbol">/test-pod</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥å®¹å™¨éªŒè¯ï¼š</span></span><br><span class="line">$ kubectl exec <span class="operator">-</span>it test-pod sh</span><br><span class="line"><span class="symbol">/</span> $ id</span><br><span class="line">u<span class="attr">id</span><span class="operator">=</span><span class="number">1000</span> gid<span class="operator">=</span><span class="number">0</span>(root)</span><br><span class="line"><span class="symbol">/</span> $ ps <span class="operator">-</span>ef</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    <span class="number">1</span> <span class="number">1000</span>      <span class="number">0</span>:<span class="number">00</span> sleep <span class="number">36000</span></span><br><span class="line">    <span class="number">6</span> <span class="number">1000</span>      <span class="number">0</span>:<span class="number">00</span> sh</span><br><span class="line">   <span class="number">15</span> <span class="number">1000</span>      <span class="number">0</span>:<span class="number">00</span> sh</span><br><span class="line">   <span class="number">21</span> <span class="number">1000</span>      <span class="number">0</span>:<span class="number">00</span> ps <span class="operator">-</span>ef</span><br><span class="line"><span class="symbol">/</span> $ sysctl <span class="operator">-</span>w net.ipv4.tcp_recovery<span class="operator">=</span><span class="number">2</span></span><br><span class="line"><span class="params">sysctl:</span> error setting key 'net.ipv4.<span class="params">tcp_recovery':</span> Read-only file system</span><br><span class="line"><span class="symbol">/</span> $</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸Šæˆ‘è®¾ç½®é™åˆ¶äº†podæ˜¯å¦å¼€å¯ç‰¹æƒæ¨¡å¼ï¼Œå¹¶ä¸”è¿è¡Œç”¨æˆ·uidä¸º1000</span></span><br><span class="line"><span class="comment"># é‚£ä¹ˆå¦‚æœåœ¨podçº§åˆ«è®¾ç½®ä¸Šä¸‹æ–‡çš„è¯ï¼Œå®¹å™¨çº§åˆ«çš„ä¼šè¦†ç›–Podçº§åˆ«çš„ç›¸åŒè®¾ç½®(å·²éªŒè¯)</span></span><br></pre></td></tr></tbody></table></figure><p>å…¶ä»–æ›´å¤šå‚æ•°å‚è§: <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">https://kubernetes.io/docs/concepts/policy/pod-security-policy/</a></p><h1 id="è¿è¡Œæ€çš„å®‰å…¨æ§åˆ¶â€”ç½‘ç»œç­–ç•¥-NetworkPolicy"><a href="#è¿è¡Œæ€çš„å®‰å…¨æ§åˆ¶â€”ç½‘ç»œç­–ç•¥-NetworkPolicy" class="headerlink" title="è¿è¡Œæ€çš„å®‰å…¨æ§åˆ¶â€”ç½‘ç»œç­–ç•¥(NetworkPolicy)"></a>è¿è¡Œæ€çš„å®‰å…¨æ§åˆ¶â€”ç½‘ç»œç­–ç•¥(NetworkPolicy)</h1><p>Kubernetesè¦æ±‚é›†ç¾¤ä¸­æ‰€æœ‰podï¼Œæ— è®ºæ˜¯èŠ‚ç‚¹å†…è¿˜æ˜¯è·¨èŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥ç›´æ¥é€šä¿¡ï¼Œæˆ–è€…è¯´æ‰€æœ‰podå·¥ä½œåœ¨åŒä¸€è·¨èŠ‚ç‚¹ç½‘ç»œï¼Œæ­¤ç½‘ç»œä¸€èˆ¬æ˜¯äºŒå±‚è™šæ‹Ÿç½‘ç»œï¼Œç§°ä¸ºpodç½‘ç»œã€‚åœ¨å®‰è£…å¼•å¯¼kubernetesæ—¶ï¼Œç”±é€‰æ‹©å¹¶å®‰è£…çš„network pluginå®ç°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä¸­æ‰€æœ‰podä¹‹é—´ã€podä¸èŠ‚ç‚¹ä¹‹é—´å¯ä»¥äº’é€šã€‚</p><p>ç½‘ç»œä¸»è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯è¿é€šæ€§ï¼Œå®ä½“ä¹‹é—´èƒ½å¤Ÿé€šè¿‡ç½‘ç»œäº’é€šã€‚å¦ä¸€ä¸ªæ˜¯éš”ç¦»æ€§ï¼Œå‡ºäºå®‰å…¨ã€é™åˆ¶ç½‘ç»œæµé‡çš„ç›®çš„ï¼Œåˆè¦æ§åˆ¶å®ä½“ä¹‹é—´çš„è¿é€šæ€§ã€‚Network Policyç”¨æ¥å®ç°éš”ç¦»æ€§ï¼Œåªæœ‰åŒ¹é…è§„åˆ™çš„æµé‡æ‰èƒ½è¿›å…¥podï¼ŒåŒç†åªæœ‰åŒ¹é…è§„åˆ™çš„æµé‡æ‰å¯ä»¥ç¦»å¼€podã€‚</p><p>ä½†è¯·æ³¨æ„ï¼Œkubernetesæ”¯æŒçš„ç”¨ä»¥å®ç°podç½‘ç»œçš„network pluginæœ‰å¾ˆå¤šç§ï¼Œå¹¶ä¸æ˜¯å…¨éƒ¨éƒ½æ”¯æŒNetwork Policyï¼Œä¸ºkubernetesé€‰æ‹©network pluginæ—¶éœ€è¦è€ƒè™‘åˆ°è¿™ç‚¹ï¼Œæ˜¯å¦éœ€è¦éš”ç¦»ï¼Ÿå¯ç”¨network pluginåŠæ˜¯å¦æ”¯æŒNetwork Policyè¯·å‚è€ƒ<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/#networking-and-network-policy">è¿™é‡Œ</a>ã€‚</p><h2 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h2><p>Network Policyæ˜¯kubernetesä¸­çš„ä¸€ç§èµ„æºç±»å‹ï¼Œå®ƒä»å±äºæŸä¸ªnamespaceã€‚å…¶å†…å®¹ä»é€»è¾‘ä¸Šçœ‹åŒ…å«ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ï¼Œä¸€æ˜¯podé€‰æ‹©å™¨ï¼ŒåŸºäºæ ‡ç­¾é€‰æ‹©ç›¸åŒnamespaceä¸‹çš„podï¼Œå°†å…¶ä¸­å®šä¹‰çš„è§„åˆ™ä½œç”¨äºé€‰ä¸­çš„podã€‚å¦ä¸€ä¸ªå°±æ˜¯è§„åˆ™äº†ï¼Œå°±æ˜¯ç½‘ç»œæµé‡è¿›å‡ºpodçš„è§„åˆ™ï¼Œå…¶é‡‡ç”¨çš„æ˜¯ç™½åå•æ¨¡å¼ï¼Œç¬¦åˆè§„åˆ™çš„é€šè¿‡ï¼Œä¸ç¬¦åˆè§„åˆ™çš„æ‹’ç»ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> networking.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> NetworkPolicy</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-network-policy</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">podSelector:</span></span><br><span class="line">    <span class="params">matchLabels:</span>   <span class="comment"># è§„åˆ™é€‰æ‹©å™¨ï¼Œé€‰æ‹©åŒ¹é…çš„POD</span></span><br><span class="line">      <span class="params">role:</span> db</span><br><span class="line">  <span class="params">policyTypes:</span></span><br><span class="line">  <span class="operator">-</span> Ingress</span><br><span class="line">  <span class="operator">-</span> Egress</span><br><span class="line">  <span class="params">ingress:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">from:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">ipBlock:</span>     <span class="comment"># è¿œç«¯(è®¿é—®ç«¯)IPç™½åå•å¼€æ”¾</span></span><br><span class="line">        <span class="params">cidr:</span> <span class="number">172.17</span>.<span class="number">0.0</span><span class="symbol">/16</span></span><br><span class="line">        <span class="params">except:</span></span><br><span class="line">        <span class="operator">-</span> <span class="number">172.17</span>.<span class="number">1.0</span><span class="symbol">/24</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">namespaceSelector:</span>  <span class="comment"># è¿œç«¯(è®¿é—®ç«¯)namespacesç™½åå•å¼€æ”¾</span></span><br><span class="line">        <span class="params">matchLabels:</span></span><br><span class="line">          <span class="params">project:</span> myproject</span><br><span class="line">    <span class="operator">-</span> <span class="params">podSelector:</span>        <span class="comment"># è¿œç«¯(è®¿é—®ç«¯)Podç™½åå•å¼€æ”¾</span></span><br><span class="line">        <span class="params">matchLabels:</span></span><br><span class="line">          <span class="params">role:</span> frontend</span><br><span class="line">    <span class="params">ports:</span>     <span class="comment"># æœ¬ç«¯(è¢«è®¿é—®ç«¯)å…è®¸è¢«è®¿é—®çš„ç«¯å£å’Œåè®®</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">protocol:</span> TCP</span><br><span class="line">      <span class="params">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="params">egress:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">to:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">ipBlock:</span></span><br><span class="line">        <span class="params">cidr:</span> <span class="number">10.0</span>.<span class="number">0.0</span><span class="symbol">/24</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">protocol:</span> TCP</span><br></pre></td></tr></tbody></table></figure><p>å¯¹è±¡åˆ›å»ºæ–¹æ³•ä¸å…¶å®ƒå¦‚ReplicaSetç›¸åŒã€‚apiVersionã€kindã€metadataä¸å…¶å®ƒç±»å‹å¯¹è±¡å«ä¹‰ç›¸åŒï¼Œä¸è¯¦ç»†æè¿°ã€‚</p><ul><li><p>.spec.PodSelector<br>é¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯podé€‰æ‹©å™¨ï¼ŒåŸºäºæ ‡ç­¾é€‰æ‹©ä¸Network Policyå¤„äºåŒä¸€namespaceä¸‹çš„podï¼Œå¦‚æœpodè¢«é€‰ä¸­ï¼Œåˆ™å¯¹å…¶åº”ç”¨Network Policyä¸­å®šä¹‰çš„è§„åˆ™ã€‚æ­¤ä¸ºå¯é€‰å­—æ®µï¼Œå½“æ²¡æœ‰æ­¤å­—æ®µæ—¶ï¼Œè¡¨ç¤ºé€‰ä¸­æ‰€æœ‰podã€‚</p></li><li><p>.spec.PolicyTypes<br>Network Policyå®šä¹‰çš„è§„åˆ™å¯ä»¥åˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯å…¥podçš„Ingressè§„åˆ™ï¼Œä¸€ç§æ˜¯å‡ºpodçš„Egressè§„åˆ™ã€‚æœ¬å­—æ®µå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå¼€å…³ï¼Œå¦‚æœå…¶ä¸­åŒ…å«Ingressï¼Œåˆ™Ingresséƒ¨åˆ†å®šä¹‰çš„è§„åˆ™ç”Ÿæ•ˆï¼Œå¦‚æœæ˜¯Egressåˆ™Egresséƒ¨åˆ†å®šä¹‰çš„è§„åˆ™ç”Ÿæ•ˆï¼Œå¦‚æœéƒ½åŒ…å«åˆ™å…¨éƒ¨ç”Ÿæ•ˆã€‚å½“ç„¶æ­¤å­—æ®µä¹Ÿå¯é€‰ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œåˆ™é»˜è®¤Ingressç”Ÿæ•ˆï¼Œå¦‚æœEgresséƒ¨åˆ†æœ‰å®šä¹‰çš„è¯ï¼ŒEgressæ‰ç”Ÿæ•ˆã€‚æ€ä¹ˆç†è§£è¿™å¥è¯ï¼Œä¸‹æ–‡ä¼šæåˆ°ï¼Œæ²¡æœ‰æ˜ç¡®å®šä¹‰Ingressã€Egresséƒ¨åˆ†ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ç§è§„åˆ™ï¼Œé»˜è®¤è§„åˆ™è€Œéæ²¡æœ‰è§„åˆ™ã€‚</p></li><li><p>.spec.ingressä¸.spec.egress<br>å‰è€…å®šä¹‰å…¥podè§„åˆ™ï¼Œåè€…å®šä¹‰å‡ºpodè§„åˆ™ï¼Œè¯¦ç»†å‚è€ƒè¿™é‡Œï¼Œè¿™é‡Œåªè®²ä¸€ä¸‹é‡ç‚¹ã€‚ä¸Šä¾‹ä¸­ingressä¸egresséƒ½åªåŒ…å«ä¸€æ¡è§„åˆ™ï¼Œä¸¤è€…éƒ½æ˜¯æ•°ç»„ï¼Œå¯ä»¥åŒ…å«å¤šæ¡è§„åˆ™ã€‚å½“åŒ…å«å¤šæ¡æ—¶ï¼Œæ¡ç›®ä¹‹é—´çš„é€»è¾‘å…³ç³»æ˜¯â€œæˆ–â€ï¼Œåªè¦åŒ¹é…å…¶ä¸­ä¸€æ¡å°±å¯ä»¥ã€‚.spec.ingress[].from<br>ä¹Ÿæ˜¯æ•°ç»„ï¼Œæ•°ç»„æˆå‘˜å¯¹è®¿é—®podçš„å¤–éƒ¨sourceè¿›è¡Œæè¿°ï¼Œç¬¦åˆæ¡ä»¶çš„sourceæ‰å¯ä»¥è®¿é—®podï¼Œæœ‰å¤šç§æ–¹æ³•ï¼Œå¦‚ç¤ºä¾‹ä¸­çš„ipåœ°å€å—ã€åç§°ç©ºé—´ã€podæ ‡ç­¾ç­‰ï¼Œæ•°ç»„ä¸­çš„æˆå‘˜ä¹Ÿæ˜¯é€»è¾‘æˆ–çš„å…³ç³»ã€‚spec.ingress[].from.protsè¡¨ç¤ºå…è®¸é€šè¿‡çš„åè®®åŠç«¯å£å·ã€‚</p></li><li><p>.spec.egress.to å®šä¹‰çš„æ˜¯podæƒ³è¦è®¿é—®çš„å¤–éƒ¨destinationï¼Œå…¶å®ƒä¸ingressç›¸åŒã€‚</p></li></ul><h3 id="kubernetes-é»˜è®¤NetworkPolicy"><a href="#kubernetes-é»˜è®¤NetworkPolicy" class="headerlink" title="kubernetes é»˜è®¤NetworkPolicy:"></a>kubernetes é»˜è®¤NetworkPolicy:</h3><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#é»˜è®¤ç¦æ­¢æ‰€æœ‰å‡ºå£è¯·æ±‚</span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">default-deny</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">podSelector</span><span class="punctuation">:</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">policyTypes</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤ç¦æ­¢æ‰€æœ‰å…¥å£è¯·æ±‚</span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">default-deny</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">podSelector</span><span class="punctuation">:</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">policyTypes</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤å…è®¸æ‰€æœ‰å‡ºå£è¯·æ±‚</span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">allow-all</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">podSelector</span><span class="punctuation">:</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">egress</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">policyTypes</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤å…è®¸æ‰€æœ‰å…¥å£è¯·æ±‚</span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">allow-all</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">podSelector</span><span class="punctuation">:</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">egress</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">policyTypes</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br></pre></td></tr></tbody></table></figure><p>é»˜è®¤ç­–ç•¥ æ— éœ€è¯¦è§£ï¼Œä½†è¯·æ³¨æ„ï¼Œpodä¸æ‰€è¿è¡ŒèŠ‚ç‚¹ä¹‹é—´æµé‡ä¸å—Network Policyé™åˆ¶ã€‚</p><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªçœŸå®ç¤ºä¾‹å±•ç¤ºNetwork Policyæ™®é€šç”¨æ³•ã€‚</p><h4 id="ç”¨Deploymentåˆ›å»ºnginx-podå®ä¾‹å¹¶ç”¨serviceæš´éœ²"><a href="#ç”¨Deploymentåˆ›å»ºnginx-podå®ä¾‹å¹¶ç”¨serviceæš´éœ²" class="headerlink" title="ç”¨Deploymentåˆ›å»ºnginx podå®ä¾‹å¹¶ç”¨serviceæš´éœ²"></a>ç”¨Deploymentåˆ›å»ºnginx podå®ä¾‹å¹¶ç”¨serviceæš´éœ²</h4><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">run</span> nginx <span class="attribute">--image</span>=nginx <span class="attribute">--replicas</span>=3</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line">$ kubectl expose deployment nginx <span class="attribute">--port</span>=80</span><br><span class="line">service/nginx exposed</span><br></pre></td></tr></tbody></table></figure><h4 id="ç¡®è®¤åˆ›å»ºç»“æœ"><a href="#ç¡®è®¤åˆ›å»ºç»“æœ" class="headerlink" title="ç¡®è®¤åˆ›å»ºç»“æœ"></a>ç¡®è®¤åˆ›å»ºç»“æœ</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod,svc</span><br><span class="line">NAME                         READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod<span class="symbol">/nginx-64f497f8fd-9mfd7</span>   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">2</span>m</span><br><span class="line">pod<span class="symbol">/nginx-64f497f8fd-nss94</span>   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">2</span>m</span><br><span class="line">pod<span class="symbol">/nginx-64f497f8fd-zs926</span>   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">2</span>m</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service<span class="symbol">/kubernetes</span>   ClusterIP   <span class="number">10.96</span>.<span class="number">0.1</span>        <span class="symbol">&lt;none&gt;</span>        <span class="number">443</span><span class="symbol">/TCP</span>   <span class="number">3</span>d</span><br><span class="line">service<span class="symbol">/nginx</span>        ClusterIP   <span class="number">10.111</span>.<span class="number">254.191</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">80</span><span class="symbol">/TCP</span>    <span class="number">14</span>s</span><br></pre></td></tr></tbody></table></figure><h4 id="æµ‹è¯•nginxæœåŠ¡è¿é€šæ€§"><a href="#æµ‹è¯•nginxæœåŠ¡è¿é€šæ€§" class="headerlink" title="æµ‹è¯•nginxæœåŠ¡è¿é€šæ€§"></a>æµ‹è¯•nginxæœåŠ¡è¿é€šæ€§</h4><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$  kubectl run busybox <span class="params">--rm</span> -it <span class="params">--image=busybox</span> <span class="string">/bin/sh</span></span><br><span class="line">If you don't see a <span class="keyword">command</span> prompt, <span class="keyword">try</span> pressing enter.</span><br><span class="line">/ <span class="comment"># wget --spider --timeout=3 nginx</span></span><br><span class="line">Connecting to nginx <span class="params">(10.111.254.191:80)</span>  <span class="comment"># è¯´æ˜é€šçš„</span></span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><h4 id="é€šè¿‡åˆ›å»ºNetwork-Policyå¯¹è±¡æ·»åŠ éš”ç¦»æ€§"><a href="#é€šè¿‡åˆ›å»ºNetwork-Policyå¯¹è±¡æ·»åŠ éš”ç¦»æ€§" class="headerlink" title="é€šè¿‡åˆ›å»ºNetwork Policyå¯¹è±¡æ·»åŠ éš”ç¦»æ€§"></a>é€šè¿‡åˆ›å»ºNetwork Policyå¯¹è±¡æ·»åŠ éš”ç¦»æ€§</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> pod-network-policy.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">kind:</span> NetworkPolicy</span><br><span class="line"><span class="params">apiVersion:</span> networking.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> access-nginx</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">podSelector:</span></span><br><span class="line">    <span class="params">matchLabels:</span> <span class="comment"># é»˜è®¤è¯¥podå°±æœ‰run=appè¿™ä¸ªæ ‡ç­¾äº†ï¼Œæˆ‘è¿™é‡Œæ— éœ€åœ¨ä»æ–°å®šä¹‰</span></span><br><span class="line">      <span class="params">run:</span> nginx  </span><br><span class="line">  <span class="params">ingress:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">from:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">podSelector:</span></span><br><span class="line">        <span class="params">matchLabels:</span></span><br><span class="line">          <span class="params">access:</span> <span class="string">"true"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»º</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f pod-network-policy.yaml</span><br><span class="line">networkpolicy.networking.k8s.io<span class="symbol">/access-nginx</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å…·ä½“éš”ç¦»ç­–ç•¥</span></span><br><span class="line">$ kubectl describe networkpolicy access-nginx</span><br><span class="line"><span class="params">Name:</span>         access-nginx</span><br><span class="line"><span class="params">Namespace:</span>    default</span><br><span class="line">Created <span class="params">on:</span>   <span class="number">201</span>8-<span class="number">1</span>2-<span class="number">17</span> <span class="number">01</span>:<span class="number">16</span>:<span class="number">57</span> <span class="operator">-</span><span class="number">0500</span> EST</span><br><span class="line"><span class="params">Labels:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Spec:</span></span><br><span class="line">  <span class="params">PodSelector:</span>     run<span class="operator">=</span>nginx</span><br><span class="line">  Allowing ingress <span class="params">traffic:</span></span><br><span class="line">    To <span class="params">Port:</span> <span class="symbol">&lt;any&gt;</span> (traffic allowed to all ports)</span><br><span class="line">    <span class="params">From:</span></span><br><span class="line">      <span class="params">PodSelector:</span> access<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">  Allowing egress <span class="params">traffic:</span></span><br><span class="line">    <span class="symbol">&lt;none&gt;</span> (Selected pods are isolated for egress connectivity)</span><br><span class="line">  Policy <span class="params">Types:</span> Ingress</span><br></pre></td></tr></tbody></table></figure><h4 id="æµ‹è¯•éš”ç¦»æ€§"><a href="#æµ‹è¯•éš”ç¦»æ€§" class="headerlink" title="æµ‹è¯•éš”ç¦»æ€§"></a>æµ‹è¯•éš”ç¦»æ€§</h4><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run busybox <span class="params">--rm</span> -it <span class="params">--image=busybox</span> <span class="string">/bin/sh</span></span><br><span class="line">If you don't see a <span class="keyword">command</span> prompt, <span class="keyword">try</span> pressing enter.</span><br><span class="line">/ <span class="comment"># wget --spider --timeout=3 nginx</span></span><br><span class="line">Connecting to nginx <span class="params">(10.111.254.191:80)</span></span><br><span class="line">wget: download timed out <span class="comment"># å·²ç»è¶…æ—¶ï¼Œè¯´æ˜å·²ç»ä¸èƒ½è®¿é—®äº†</span></span><br></pre></td></tr></tbody></table></figure><h4 id="ä¸ºpodæ·»åŠ access-â€œtrueâ€æ ‡ç­¾åå†æ¬¡æµ‹è¯•è¿é€šæ€§"><a href="#ä¸ºpodæ·»åŠ access-â€œtrueâ€æ ‡ç­¾åå†æ¬¡æµ‹è¯•è¿é€šæ€§" class="headerlink" title="ä¸ºpodæ·»åŠ access: â€œtrueâ€æ ‡ç­¾åå†æ¬¡æµ‹è¯•è¿é€šæ€§"></a>ä¸ºpodæ·»åŠ access: â€œtrueâ€æ ‡ç­¾åå†æ¬¡æµ‹è¯•è¿é€šæ€§</h4><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run busybox <span class="params">--rm</span> -it <span class="params">--labels=</span><span class="string">"access=true"</span> <span class="params">--image=busybox</span> <span class="string">/bin/sh</span></span><br><span class="line">If you don't see a <span class="keyword">command</span> prompt, <span class="keyword">try</span> pressing enter.</span><br><span class="line">/ <span class="comment"># wget --spider --timeout=3 nginx</span></span><br><span class="line">Connecting to nginx <span class="params">(10.111.254.191:80)</span></span><br></pre></td></tr></tbody></table></figure><p>å‚è€ƒ:<br><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/</a><br><a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/docs/reference/access-authn-authz/rbac/</a><br><a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">https://kubernetes.io/docs/concepts/services-networking/network-policies/</a><br><a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/</a><br><a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">https://kubernetes.io/docs/concepts/policy/pod-security-policy/</a></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> ServiceAccount </tag>
            
            <tag> Kubeconfig </tag>
            
            <tag> RBAC </tag>
            
            <tag> Admission </tag>
            
            <tag> PodSecurityContext </tag>
            
            <tag> NetworkPolicy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç†è§£kubernetesä¸­çš„Storage</title>
      <link href="/2018/12/15/kubernetes-storage/"/>
      <url>/2018/12/15/kubernetes-storage/</url>
      
        <content type="html"><![CDATA[<h1 id="åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·"><a href="#åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·" class="headerlink" title="åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·"></a>åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·</h1><p>å®¹å™¨éƒ¨ç½²è¿‡ç¨‹ä¸­ä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§æ•°æ®:</p><ul><li>å¯åŠ¨æ—¶éœ€è¦çš„åˆå§‹æ•°æ®ï¼Œå¯ä»¥æ˜¯é…ç½®æ–‡ä»¶</li><li>å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®ï¼Œè¯¥ä¸´æ—¶æ•°æ®éœ€è¦å¤šä¸ªå®¹å™¨é—´å…±äº«</li><li>å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æŒä¹…åŒ–æ•°æ®</li></ul><p>ä»¥ä¸Šä¸‰ç§æ•°æ®éƒ½ä¸å¸Œæœ›åœ¨å®¹å™¨é‡å¯æ—¶å°±æ¶ˆå¤±ï¼Œå­˜å‚¨å·ç”±æ­¤è€Œæ¥ï¼Œå®ƒå¯ä»¥æ ¹æ®ä¸åŒåœºæ™¯æä¾›ä¸åŒç±»å‹çš„å­˜å‚¨èƒ½åŠ›ã€‚<br>å„ç±»å·:</p><div style="width: 50%; margin: auto">![æˆªå›¾æ¥æºåä¸ºäº‘cceè¯¾å ‚](kubernetes-storage/volume.png)</div><ul><li>spec.volumesï¼šé€šè¿‡æ­¤å­—æ®µæä¾›æŒ‡å®šçš„å­˜å‚¨å·</li><li>spec.containers.volumeMountsï¼šé€šè¿‡æ­¤å­—æ®µå°†å­˜å‚¨å·æŒ‚æ¥åˆ°å®¹å™¨ä¸­</li></ul><h1 id="ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•"><a href="#ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•" class="headerlink" title="ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•:"></a>ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•:</h1><h2 id="å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®"><a href="#å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®" class="headerlink" title="å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®"></a>å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®</h2><h3 id="1-ConfigMap"><a href="#1-ConfigMap" class="headerlink" title="1. ConfigMap"></a>1. ConfigMap</h3><p>ä¸Šå›¾ä¹Ÿè¯´äº†å®ƒæ˜¯åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä»¥æ¥çš„æ•°æ®æ¥æº</p><h4 id="ç¤ºä¾‹ï¼š"><a href="#ç¤ºä¾‹ï¼š" class="headerlink" title="ç¤ºä¾‹ï¼š"></a>ç¤ºä¾‹ï¼š</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.åˆ›å»ºconfigmapé¢„åˆ¶æ•°æ®å·</span></span><br><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> configmap.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  <span class="params">guomaoqiu:</span> hello-world</span><br><span class="line"><span class="params">kind:</span> ConfigMap</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test</span><br><span class="line">EOF</span><br><span class="line">$ kubectl create <span class="operator">-</span>f configmap.yaml</span><br><span class="line">configmap<span class="symbol">/test</span> created</span><br><span class="line"><span class="comment"># 2. åˆ›å»ºpodæ¥ä½¿ç”¨è¿™ä¸ªconfigmap</span></span><br><span class="line"><span class="comment"># è¿™é‡Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªnginx pod è®©ä»–å¯åŠ¨æ˜¯æŒ‚è½½è¿™ä¸ªæ•°æ®</span></span><br><span class="line">$ cat nginx-deployment.yaml</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">image:</span> nginx</span><br><span class="line">        <span class="params">name:</span> nginx</span><br><span class="line">        <span class="params">resources:</span> {}</span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> test</span><br><span class="line">          <span class="params">mountPath:</span> <span class="symbol">/tmp</span>  <span class="comment"># æŒ‚è½½ç‚¹</span></span><br><span class="line">      <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> test</span><br><span class="line">        <span class="params">configMap:</span> </span><br><span class="line">          <span class="params">name:</span> test       <span class="comment"># ConfigMap name</span></span><br><span class="line">          <span class="params">defaultMode:</span> <span class="number">420</span> <span class="comment"># æŒ‡å®šæŒ‚è½½åˆ°podæ–‡ä»¶çš„æƒé™</span></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æ£€æŸ¥æ•°æ®æ˜¯å¦æŒ‚è½½è¿›pod</span></span><br><span class="line">kubectl exec  nginx-<span class="number">7</span>d8bb9c4fc-bxxkt <span class="operator">-</span>- ls <span class="symbol">/tmp</span></span><br><span class="line">guomaoqiu</span><br><span class="line">kubectl exec  nginx-<span class="number">7</span>d8bb9c4fc-bxxkt <span class="operator">-</span>- cat <span class="symbol">/tmp/guomaoqiu</span></span><br><span class="line">hello-world                                                                                                                                                                                                                                 $</span><br><span class="line"><span class="comment"># ä»¥ä¸Šå¯ä»¥çœ‹åˆ°å°†configmapçš„keyä½œä¸ºäº†æ–‡ä»¶åï¼Œå°†valueä½œä¸ºäº†æ–‡ä»¶çš„å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment"># ä»–çš„ä½œç”¨ä¹Ÿå°±æ˜¯å…è®¸æ‚¨å°†é…ç½®æ–‡ä»¶ä»å®¹å™¨é•œåƒä¸­è§£è€¦ï¼Œä»è€Œå¢å¼ºå®¹å™¨åº”ç”¨çš„å¯ç§»æ¤æ€§</span></span><br><span class="line"><span class="comment"># æ›´å¤šå¯æŸ¥çœ‹: https://k8smeetup.github.io/docs/tasks/configure-pod-container/configmap/</span></span><br></pre></td></tr></tbody></table></figure><h3 id="2-Serect"><a href="#2-Serect" class="headerlink" title="2. Serect"></a>2. Serect</h3><p>Secret æ˜¯ä¸€ç§åŒ…å«å°‘é‡æ•æ„Ÿä¿¡æ¯ä¾‹å¦‚å¯†ç ã€token æˆ– key çš„å¯¹è±¡ã€‚è¿™æ ·çš„ä¿¡æ¯å¯èƒ½ä¼šè¢«æ”¾åœ¨ Pod spec ä¸­æˆ–è€…é•œåƒä¸­ï¼›å°†å…¶æ”¾åœ¨ä¸€ä¸ª secret å¯¹è±¡ä¸­å¯ä»¥æ›´å¥½åœ°æ§åˆ¶å®ƒçš„ç”¨é€”ï¼Œå¹¶é™ä½æ„å¤–æš´éœ²çš„é£é™©ã€‚</p><p>ç”¨æˆ·å¯ä»¥åˆ›å»º secretï¼ŒåŒæ—¶ç³»ç»Ÿä¹Ÿåˆ›å»ºäº†ä¸€äº› secretã€‚<br>è¦ä½¿ç”¨ secretï¼Œpod éœ€è¦å¼•ç”¨ secretã€‚Pod å¯ä»¥ç”¨ä¸¤ç§æ–¹å¼ä½¿ç”¨ secretï¼šä½œä¸º volume ä¸­çš„æ–‡ä»¶è¢«æŒ‚è½½åˆ° pod ä¸­çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨é‡Œï¼Œæˆ–è€…å½“ kubelet ä¸º pod æ‹‰å–é•œåƒæ—¶ä½¿ç”¨ã€‚</p><h4 id="ç¤ºä¾‹ï¼š-1"><a href="#ç¤ºä¾‹ï¼š-1" class="headerlink" title="ç¤ºä¾‹ï¼š"></a>ç¤ºä¾‹ï¼š</h4><p>å‡è®¾æœ‰äº› pod éœ€è¦è®¿é—®æ•°æ®åº“ã€‚è¿™äº› pod éœ€è¦ä½¿ç”¨çš„ç”¨æˆ·åå’Œå¯†ç åœ¨æ‚¨æœ¬åœ°æœºå™¨çš„ ./username.txt å’Œ ./password.txt æ–‡ä»¶é‡Œã€‚</p><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create files needed for rest of example.</span></span><br><span class="line"><span class="keyword">echo</span> -n <span class="string">"admin"</span> &gt; <span class="string">./username.txt</span></span><br><span class="line"><span class="keyword">echo</span> -n <span class="string">"1f2d1e2e67df"</span> &gt; <span class="string">./password.txt</span></span><br></pre></td></tr></tbody></table></figure><p>kubectl create secret å‘½ä»¤å°†è¿™äº›æ–‡ä»¶æ‰“åŒ…åˆ°ä¸€ä¸ª Secret ä¸­å¹¶åœ¨ API server ä¸­åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create secret generic db-user-pass <span class="operator">-</span>-from-file<span class="operator">=</span><span class="symbol">./username.txt</span> <span class="operator">-</span>-from-file<span class="operator">=</span><span class="symbol">./password.txt</span></span><br><span class="line">secret<span class="symbol">/db-user-pass</span> created</span><br><span class="line"></span><br><span class="line">$ kubectl describe secret db-user-pass</span><br><span class="line"><span class="params">Name:</span>         db-user-pass</span><br><span class="line"><span class="params">Namespace:</span>    default</span><br><span class="line"><span class="params">Labels:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">Type:</span>  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line"><span class="operator">==</span><span class="operator">==</span></span><br><span class="line">password.<span class="params">txt:</span>  <span class="number">12</span> bytes</span><br><span class="line">username.<span class="params">txt:</span>  <span class="number">5</span> bytes</span><br><span class="line"><span class="comment"># é»˜è®¤æƒ…å†µä¸‹ï¼Œget å’Œ describe å‘½ä»¤éƒ½ä¸ä¼šæ˜¾ç¤ºæ–‡ä»¶çš„å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment"># è¿™æ˜¯ä¸ºäº†é˜²æ­¢å°† secret ä¸­çš„å†…å®¹è¢«æ„å¤–æš´éœ²ç»™ä»ç»ˆç«¯æ—¥å¿—è®°å½•ä¸­åˆ»æ„å¯»æ‰¾å®ƒä»¬çš„äººã€‚</span></span><br></pre></td></tr></tbody></table></figure><p>åœ¨ Pod ä¸­ä½¿ç”¨ Secret æ–‡ä»¶<br>åœ¨æŒ‚è½½çš„ secret volume çš„å®¹å™¨å†…ï¼Œsecret key å°†ä½œä¸ºæ–‡ä»¶ï¼Œå¹¶ä¸” secret çš„å€¼ä½¿ç”¨ base-64 è§£ç å¹¶å­˜å‚¨åœ¨è¿™äº›æ–‡ä»¶ä¸­ã€‚è¿™æ˜¯åœ¨ä¸Šé¢çš„ç¤ºä¾‹å®¹å™¨å†…æ‰§è¡Œçš„å‘½ä»¤çš„ç»“æœï¼š</p><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> kubectl exec <span class="operator">-</span>it mypod <span class="regexp">/bin/</span>bash</span><br><span class="line">root<span class="meta">@mypod</span>:<span class="regexp">/# cat /</span>etc<span class="regexp">/foo/</span>username.txt</span><br><span class="line">admin</span><br><span class="line">root<span class="meta">@mypod</span>:<span class="regexp">/# cat /</span>etc<span class="regexp">/foo/</span>password.txt</span><br><span class="line">1f2d1e2e67df</span><br></pre></td></tr></tbody></table></figure><p>å®¹å™¨ä¸­çš„ç¨‹åºè´Ÿè´£ä»æ–‡ä»¶ä¸­è¯»å– secretã€‚<br>å…³äºsecretæŒ‚è½½ä½¿ç”¨æ–¹æ³• æ›´å¤šï¼š<a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-%E4%B8%8E-pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E8%81%94%E7%B3%BB">https://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-%E4%B8%8E-pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E8%81%94%E7%B3%BB</a></p><h2 id="ä¸´æ—¶æ•°æ®å­˜å‚¨"><a href="#ä¸´æ—¶æ•°æ®å­˜å‚¨" class="headerlink" title="ä¸´æ—¶æ•°æ®å­˜å‚¨"></a>ä¸´æ—¶æ•°æ®å­˜å‚¨</h2><h3 id="1-emptryDir"><a href="#1-emptryDir" class="headerlink" title="1. emptryDir"></a>1. emptryDir</h3><p>å½“ Pod è¢«åˆ†é…ç»™èŠ‚ç‚¹æ—¶ï¼Œé¦–å…ˆåˆ›å»º emptyDir å·ï¼Œå¹¶ä¸”åªè¦è¯¥ Pod åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œè¯¥å·å°±ä¼šå­˜åœ¨ã€‚æ­£å¦‚å·çš„åå­—æ‰€è¿°ï¼Œå®ƒæœ€åˆæ˜¯ç©ºçš„ã€‚Pod ä¸­çš„å®¹å™¨å¯ä»¥è¯»å–å’Œå†™å…¥ emptyDir å·ä¸­çš„ç›¸åŒæ–‡ä»¶ï¼Œå°½ç®¡è¯¥å·å¯ä»¥æŒ‚è½½åˆ°æ¯ä¸ªå®¹å™¨ä¸­çš„ç›¸åŒæˆ–ä¸åŒè·¯å¾„ä¸Šã€‚å½“å‡ºäºä»»ä½•åŸå› ä»èŠ‚ç‚¹ä¸­åˆ é™¤ Pod æ—¶ï¼ŒemptyDir ä¸­çš„æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚</p><p>æ³¨æ„ï¼šå®¹å™¨å´©æºƒä¸ä¼šä»èŠ‚ç‚¹ä¸­ç§»é™¤ podï¼Œå› æ­¤ emptyDir å·ä¸­çš„æ•°æ®åœ¨å®¹å™¨å´©æºƒæ—¶æ˜¯å®‰å…¨çš„ã€‚</p><p>ç¼ºçœæƒ…å†µä¸‹ï¼ŒEmptyDir æ˜¯ä½¿ç”¨ä¸»æœºç£ç›˜è¿›è¡Œå­˜å‚¨çš„ï¼Œä¹Ÿå¯ä»¥è®¾ç½®emptyDir.medium å­—æ®µçš„å€¼ä¸ºMemoryï¼Œæ¥æé«˜è¿è¡Œé€Ÿåº¦ï¼Œä½†æ˜¯è¿™ç§è®¾ç½®ï¼Œå¯¹è¯¥å·çš„å ç”¨ä¼šæ¶ˆè€—å®¹å™¨çš„å†…å­˜ä»½é¢ã€‚</p><p>emptyDir çš„ç”¨æ³•æœ‰ï¼š</p><ul><li>æš‚å­˜ç©ºé—´ï¼Œä¾‹å¦‚ç”¨äºåŸºäºç£ç›˜çš„åˆå¹¶æ’åº</li><li>ç”¨ä½œé•¿æ—¶é—´è®¡ç®—å´©æºƒæ¢å¤æ—¶çš„æ£€æŸ¥ç‚¹</li><li>WebæœåŠ¡å™¨å®¹å™¨æä¾›æ•°æ®æ—¶ï¼Œä¿å­˜å†…å®¹ç®¡ç†å™¨å®¹å™¨æå–çš„æ–‡ä»¶</li><li>å¯ä»¥åœ¨åŒä¸€ Pod å†…çš„ä¸åŒå®¹å™¨ä¹‹é—´å…±äº«å·¥ä½œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–‡ä»¶ã€‚</li></ul><h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-emptydir-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">image:</span> nginx</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">name:</span> test-emptydir-pod</span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/temp-data</span>      <span class="comment"># æŒ‚è½½ç‚¹</span></span><br><span class="line">      <span class="params">name:</span> temp-data</span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> temp-data</span><br><span class="line">    <span class="params">emptyDir:</span> {}</span><br></pre></td></tr></tbody></table></figure><p>åˆ›å»ºpod</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> kubectl create -f test-emptydir-pod.yaml</span><br><span class="line">pod/test-emptydir-pod created</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                READY     STATUS    RESTARTS   AGE       IP            <span class="keyword">NODE</span>      <span class="title">NOMINATED</span> <span class="keyword">NODE</span></span><br><span class="line"><span class="title">test-emptydir-pod</span>   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">18s</span>       <span class="number">10.244</span>.<span class="number">0.23</span>   k8s-m3    <span class="tag">&lt;none&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ—¶Emptydirå·²ç»åˆ›å»ºæˆåŠŸï¼Œåœ¨å®¿ä¸»æœºä¸Šçš„è®¿é—®è·¯å¾„ä¸º/var/lib/kubelet/pods/<pod uid="">/volumes/kubernetes.io~empty-dir/temp-data,å¦‚æœåœ¨æ­¤ç›®å½•ä¸­åˆ›å»ºåˆ é™¤æ–‡ä»¶ï¼Œéƒ½å°†å¯¹å®¹å™¨ä¸­çš„/dataç›®å½•æœ‰å½±å“ï¼Œå¦‚æœåˆ é™¤Podï¼Œæ–‡ä»¶å°†å…¨éƒ¨åˆ é™¤ï¼Œå³ä½¿æ˜¯åœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºçš„æ–‡ä»¶ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œåœ¨å®¿ä¸»æœºä¸Šåˆ é™¤å®¹å™¨åˆ™k8sä¼šå†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œæ­¤æ—¶æ–‡ä»¶ä»ç„¶å­˜åœ¨ã€‚</pod></p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å– pod uid</span></span><br><span class="line"><span class="attribute">kubectl</span> get pod test-emptydir-pod -o yaml | grep -n uid</span><br><span class="line"><span class="attribute">11</span>:  uid: <span class="number">3328</span>c9e1-ff8f-<span class="number">11</span>e8-b6d6-<span class="number">00505621</span>dd5b</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½•åˆ°èŠ‚ç‚¹k8s-m3 æŸ¥çœ‹</span></span><br><span class="line"> <span class="attribute">ll</span> /var/lib/kubelet/pods/<span class="number">3328</span>c9e1-ff8f-<span class="number">11</span>e8-b6d6-<span class="number">00505621</span>dd5b/volumes/kubernetes.io~empty-dir/</span><br><span class="line"><span class="attribute">total</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">drwxrwxrwx</span> <span class="number">2</span> root root <span class="number">6</span> Dec <span class="number">14</span> <span class="number">05</span>:<span class="number">58</span> temp-data</span><br></pre></td></tr></tbody></table></figure><h3 id="2-hostPath"><a href="#2-hostPath" class="headerlink" title="2. hostPath"></a>2. hostPath</h3><p>hostPath volumeæ˜ å°„nodeæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æˆ–è€…ç›®å½•åˆ°podé‡Œã€‚å¤§å¤šæ•°Podéƒ½ä¸éœ€è¦è¿™ä¸ªåŠŸèƒ½ï¼Œä½†å¯¹äºä¸€äº›ç‰¹å®šçš„åœºæ™¯ï¼Œè¯¥ç‰¹æ€§è¿˜æ˜¯å¾ˆæœ‰ä½œç”¨çš„ã€‚è¿™äº›åœºæ™¯åŒ…æ‹¬ï¼š </p><ul><li>è¿è¡Œçš„å®¹å™¨éœ€è¦è®¿é—®Dockerå†…éƒ¨ç»“æ„ï¼šä½¿ç”¨hostPathæ˜ å°„/var/lib/docker </li><li>åœ¨å®¹å™¨ä¸­è¿è¡ŒcAdvisorï¼Œä½¿ç”¨hostPathæ˜ å°„/dev/cgroups</li></ul><p>ä¸è¿‡ï¼Œä½¿ç”¨è¿™ç§volumeè¦å°å¿ƒï¼Œå› ä¸ºï¼š </p><ul><li>é…ç½®ç›¸åŒçš„podï¼ˆå¦‚é€šè¿‡podTemplateåˆ›å»ºï¼‰ï¼Œå¯èƒ½åœ¨ä¸åŒçš„Nodeä¸Šè¡¨ç°ä¸åŒï¼Œå› ä¸ºä¸åŒèŠ‚ç‚¹ä¸Šæ˜ å°„çš„æ–‡ä»¶å†…å®¹ä¸åŒ </li><li>å½“Kuberneteså¢åŠ äº†èµ„æºæ•æ„Ÿçš„è°ƒåº¦ç¨‹åºï¼ŒhostPathä½¿ç”¨çš„èµ„æºä¸ä¼šè¢«è®¡ç®—åœ¨å†… </li><li>å®¿ä¸»æœºä¸‹åˆ›å»ºçš„ç›®å½•åªæœ‰rootæœ‰å†™æƒé™ã€‚ä½ éœ€è¦è®©ä½ çš„ç¨‹åºè¿è¡Œåœ¨privileged containerä¸Šï¼Œæˆ–è€…ä¿®æ”¹å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶æƒé™ã€‚</li></ul><p>ã€€</p><h4 id="ç¤ºä¾‹ï¼š-2"><a href="#ç¤ºä¾‹ï¼š-2" class="headerlink" title="ç¤ºä¾‹ï¼š"></a>ç¤ºä¾‹ï¼š</h4><p>å‡è®¾æˆ‘ä»¬åœ¨åˆ›å»ºdockeré•œåƒçš„æ—¶å€™å¿˜è®°äº†æ›´æ”¹å®¹å™¨ä¸­çš„æ—¶åŒºæ–‡ä»¶ï¼›è¿™æ—¶å€™æƒ³æŠŠå®¿ä¸»æœºçš„/usr/share/zoneinfo/Asia/ShanghaiæŒ‚åˆ°podä¸­çš„å®¹å™¨å†…(è¿™é‡Œä¸ºäº†å­¦ä¹ æŒ‚è½½æ–¹å¼ï¼Œæš‚ä¸”ä¸è°ˆä¸åŒç³»ç»Ÿæˆ–ä¸åŒå®¿ä¸»æœºçš„ä¸€äº›é…ç½®æˆ–è·¯å¾„)</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-emptydir-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">image:</span> nginx</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">name:</span> test-emptydir-pod</span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> container-time</span><br><span class="line">      <span class="params">mountPath:</span> <span class="symbol">/etc/localtime</span>  <span class="comment"># æŒ‚è½½ç‚¹ï¼Œcontainerå¯åŠ¨åç›´æ¥æŒ‚è½½è¦†ç›–æ­¤æ–‡ä»¶</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> container-time</span><br><span class="line">    <span class="params">hostPath:</span> </span><br><span class="line">      <span class="params">path:</span> <span class="symbol">/usr/share/zoneinfo/Asia/Shanghai</span>  <span class="comment"># æŒ‚è½½æ—¶åŒºæ–‡ä»¶åˆ°containerä¸­</span></span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡åˆ›å»ºpodåç™»å½•æ£€æŸ¥æ—¶åŒºæ­£å¸¸.</p><h1 id="äºŒã€æŒä¹…å­˜å‚¨å·çš„ç”¨æ³•"><a href="#äºŒã€æŒä¹…å­˜å‚¨å·çš„ç”¨æ³•" class="headerlink" title="äºŒã€æŒä¹…å­˜å‚¨å·çš„ç”¨æ³•:"></a>äºŒã€æŒä¹…å­˜å‚¨å·çš„ç”¨æ³•:</h1><p>å­¦ä¹ æŒä¹…åŒ–å­˜å‚¨ä¹‹å‰éœ€è¦å­¦ä¹ ä¸€ä¸‹ä»¥ä¸‹æ¦‚å¿µï¼š<br>Volume æä¾›äº†éå¸¸å¥½çš„æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆï¼Œä¸è¿‡åœ¨å¯ç®¡ç†æ€§ä¸Šè¿˜æœ‰ä¸è¶³ã€‚<br>æ‹¿å‰é¢ AWS EBS çš„ä¾‹å­æ¥è¯´ï¼Œè¦ä½¿ç”¨ Volumeï¼ŒPod å¿…é¡»äº‹å…ˆçŸ¥é“å¦‚ä¸‹ä¿¡æ¯ï¼š</p><ul><li>å½“å‰ Volume æ¥è‡ª AWS EBSã€‚</li><li>EBS Volume å·²ç»æå‰åˆ›å»ºï¼Œå¹¶ä¸”çŸ¥é“ç¡®åˆ‡çš„ volume-idã€‚</li></ul><p>Pod é€šå¸¸æ˜¯ç”±åº”ç”¨çš„å¼€å‘äººå‘˜ç»´æŠ¤ï¼Œè€Œ Volume åˆ™é€šå¸¸æ˜¯ç”±å­˜å‚¨ç³»ç»Ÿçš„ç®¡ç†å‘˜ç»´æŠ¤ã€‚å¼€å‘äººå‘˜è¦è·å¾—ä¸Šé¢çš„ä¿¡æ¯ï¼š</p><ul><li>è¦ä¹ˆè¯¢é—®ç®¡ç†å‘˜ã€‚</li><li>è¦ä¹ˆè‡ªå·±å°±æ˜¯ç®¡ç†å‘˜ã€‚</li></ul><p>è¿™æ ·å°±å¸¦æ¥ä¸€ä¸ªç®¡ç†ä¸Šçš„é—®é¢˜ï¼šåº”ç”¨å¼€å‘äººå‘˜å’Œç³»ç»Ÿç®¡ç†å‘˜çš„èŒè´£è€¦åˆåœ¨ä¸€èµ·äº†ã€‚å¦‚æœç³»ç»Ÿè§„æ¨¡è¾ƒå°æˆ–è€…å¯¹äºå¼€å‘ç¯å¢ƒè¿™æ ·çš„æƒ…å†µè¿˜å¯ä»¥æ¥å—ã€‚ä½†å½“é›†ç¾¤è§„æ¨¡å˜å¤§ï¼Œç‰¹åˆ«æ˜¯å¯¹äºç”Ÿæˆç¯å¢ƒï¼Œè€ƒè™‘åˆ°æ•ˆç‡å’Œå®‰å…¨æ€§ï¼Œè¿™å°±æˆäº†å¿…é¡»è¦è§£å†³çš„é—®é¢˜ã€‚</p><p>Kubernetes ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯ PersistentVolume å’Œ PersistentVolumeClaimã€‚</p><p>PersistentVolume (PV) æ˜¯å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿä¸­çš„ä¸€å—å­˜å‚¨ç©ºé—´ï¼Œç”±ç®¡ç†å‘˜åˆ›å»ºå’Œç»´æŠ¤ã€‚ä¸ Volume ä¸€æ ·ï¼ŒPV å…·æœ‰æŒä¹…æ€§ï¼Œç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äº Podã€‚</p><p>PersistentVolumeClaim (PVC) æ˜¯å¯¹ PV çš„ç”³è¯· (Claim)ã€‚PVC é€šå¸¸ç”±æ™®é€šç”¨æˆ·åˆ›å»ºå’Œç»´æŠ¤ã€‚éœ€è¦ä¸º Pod åˆ†é…å­˜å‚¨èµ„æºæ—¶ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»ºä¸€ä¸ª PVCï¼ŒæŒ‡æ˜å­˜å‚¨èµ„æºçš„å®¹é‡å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼ˆæ¯”å¦‚åªè¯»ï¼‰ç­‰ä¿¡æ¯ï¼ŒKubernetes ä¼šæŸ¥æ‰¾å¹¶æä¾›æ»¡è¶³æ¡ä»¶çš„ PVã€‚</p><p>æœ‰äº† PersistentVolumeClaimï¼Œç”¨æˆ·åªéœ€è¦å‘Šè¯‰ Kubernetes éœ€è¦ä»€ä¹ˆæ ·çš„å­˜å‚¨èµ„æºï¼Œè€Œä¸å¿…å…³å¿ƒçœŸæ­£çš„ç©ºé—´ä»å“ªé‡Œåˆ†é…ï¼Œå¦‚ä½•è®¿é—®ç­‰åº•å±‚ç»†èŠ‚ä¿¡æ¯ã€‚è¿™äº› Storage Provider çš„åº•å±‚ä¿¡æ¯äº¤ç»™ç®¡ç†å‘˜æ¥å¤„ç†ï¼Œåªæœ‰ç®¡ç†å‘˜æ‰åº”è¯¥å…³å¿ƒåˆ›å»º PersistentVolume çš„ç»†èŠ‚ä¿¡æ¯ã€‚</p><p>Kubernetes æ”¯æŒå¤šç§ç±»å‹çš„ PersistentVolumeï¼Œæ¯”å¦‚ AWS EBSã€Cephã€NFS ç­‰ï¼Œå®Œæ•´åˆ—è¡¨è¯·å‚è€ƒ <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes</a></p><p>ä¸»è¦åŒ…æ‹¬:<code>NFS</code>/<code>GlusterFS</code>/<code>CephFS</code>/<code>AWS</code>/<code>GCE</code>ç­‰ç­‰<br>ä½œä¸ºä¸€ä¸ªå®¹å™¨é›†ç¾¤ï¼Œæ”¯æŒç½‘ç»œå­˜å‚¨è‡ªç„¶æ˜¯é‡ä¸­ä¹‹é‡äº†,Kubernetesæ”¯æŒä¸ºæ•°ä¼—å¤šçš„äº‘æä¾›å•†å’Œç½‘ç»œå­˜å‚¨æ–¹æ¡ˆã€‚<br>ä¸åŒå…¬å¸é€‰æ‹©çš„æ–¹æ¡ˆä¹Ÿæ˜¯ä¸ç›¸åŒã€‚</p><p>ä¸‹èŠ‚æˆ‘ç”¨ NFS æ¥ä½“ä¼šå®ƒå­˜å‚¨çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><h2 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h2><h3 id="NFSçš„æ­å»º"><a href="#NFSçš„æ­å»º" class="headerlink" title="NFSçš„æ­å»º"></a>NFSçš„æ­å»º</h3><h4 id="1-åœ¨NFSå­˜å‚¨çš„æœåŠ¡å™¨åˆ›å»ºå­˜å‚¨ç›®å½•"><a href="#1-åœ¨NFSå­˜å‚¨çš„æœåŠ¡å™¨åˆ›å»ºå­˜å‚¨ç›®å½•" class="headerlink" title="1. åœ¨NFSå­˜å‚¨çš„æœåŠ¡å™¨åˆ›å»ºå­˜å‚¨ç›®å½•:"></a>1. åœ¨NFSå­˜å‚¨çš„æœåŠ¡å™¨åˆ›å»ºå­˜å‚¨ç›®å½•:</h4><figure class="highlight autohotkey"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># è¿™é‡Œå…ˆåˆ›å»ºä¸‰ä¸ªå…±äº«ç›®å½•ç¨åä¼šç”¨åˆ°.</span><br><span class="line">$ mkdir /{nfs_dat<span class="built_in">a_1</span>,nfs_dat<span class="built_in">a_2</span>,nfs_dat<span class="built_in">a_3</span>}</span><br></pre></td></tr></tbody></table></figure><h4 id="2-å®‰è£…nfs"><a href="#2-å®‰è£…nfs" class="headerlink" title="2. å®‰è£…nfs:"></a>2. å®‰è£…nfs:</h4><figure class="highlight cmake"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y <span class="keyword">install</span> nfs-utils rpcbind</span><br></pre></td></tr></tbody></table></figure><h4 id="3-å†™å…¥é…ç½®"><a href="#3-å†™å…¥é…ç½®" class="headerlink" title="3. å†™å…¥é…ç½®"></a>3. å†™å…¥é…ç½®</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"/nfs_data_1 *(rw,sync,no_subtree_check,no_root_squash)"</span> &gt; /etc/exports</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/nfs_data_2 *(rw,sync,no_subtree_check,no_root_squash)"</span> &gt;&gt; /etc/exports</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/nfs_data_3 *(rw,sync,no_subtree_check,no_root_squash)"</span> &gt;&gt; /etc/exports</span><br></pre></td></tr></tbody></table></figure><h4 id="4-é‡å¯nfsæœåŠ¡éªŒè¯"><a href="#4-é‡å¯nfsæœåŠ¡éªŒè¯" class="headerlink" title="4. é‡å¯nfsæœåŠ¡éªŒè¯"></a>4. é‡å¯nfsæœåŠ¡éªŒè¯</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart nfs-server</span><br><span class="line">showmount -e 192.168.56.113  <span class="comment"># NFS Server</span></span><br><span class="line">Export list <span class="keyword">for</span> 192.168.56.113:</span><br><span class="line">/nfs_data_3 *</span><br><span class="line">/nfs_data_2 *</span><br><span class="line">/nfs_data_1 *</span><br><span class="line"></span><br><span class="line"><span class="comment"># nfså®‰è£…å¹¶ä¸”å…±äº«ç›®å½•å·²ç»åˆ›å»ºå®Œæ¯•</span></span><br></pre></td></tr></tbody></table></figure><h3 id="NFSä½œä¸ºæ™®é€šå­˜å‚¨å·"><a href="#NFSä½œä¸ºæ™®é€šå­˜å‚¨å·" class="headerlink" title="NFSä½œä¸ºæ™®é€šå­˜å‚¨å·"></a>NFSä½œä¸ºæ™®é€šå­˜å‚¨å·</h3><p>åœ¨Kubernetesä¸­ï¼Œå¯ä»¥é€šè¿‡nfsç±»å‹çš„å­˜å‚¨å·å°†ç°æœ‰çš„NFSï¼ˆç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼‰åˆ°çš„æŒ‚æ¥åˆ°Podä¸­ã€‚åœ¨ç§»é™¤Podæ—¶ï¼ŒNFSå­˜å‚¨å·ä¸­çš„å†…å®¹è¢«ä¸ä¼šè¢«åˆ é™¤ï¼Œåªæ˜¯å°†å­˜å‚¨å·å¸è½½è€Œå·²ã€‚è¿™æ„å‘³ç€åœ¨NFSå­˜å‚¨å·æ€»å¯ä»¥é¢„å…ˆå¡«å……æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨Podä¹‹é—´å…±äº«æ•°æ®ã€‚NFSå¯ä»¥è¢«åŒæ—¶æŒ‚æ¥åˆ°å¤šä¸ªPodä¸­ï¼Œå¹¶èƒ½åŒæ—¶è¿›è¡Œå†™å…¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨ä½¿ç”¨nfså­˜å‚¨å·ä¹‹å‰ï¼Œå¿…é¡»å·²æ­£ç¡®éƒ¨ç½²å’Œè¿è¡ŒNFSæœåŠ¡å™¨ï¼Œå¹¶å·²ç»è®¾ç½®äº†å…±äº«ç›®å½•ã€‚</p><h4 id="åˆ›å»ºä¸€ä¸ªpodï¼Œè®©å…¶æŒ‚è½½ä¸Šé¢åˆ›å»ºçš„å…±äº«ç›®å½•"><a href="#åˆ›å»ºä¸€ä¸ªpodï¼Œè®©å…¶æŒ‚è½½ä¸Šé¢åˆ›å»ºçš„å…±äº«ç›®å½•" class="headerlink" title="åˆ›å»ºä¸€ä¸ªpodï¼Œè®©å…¶æŒ‚è½½ä¸Šé¢åˆ›å»ºçš„å…±äº«ç›®å½•"></a>åˆ›å»ºä¸€ä¸ªpodï¼Œè®©å…¶æŒ‚è½½ä¸Šé¢åˆ›å»ºçš„å…±äº«ç›®å½•</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> nfs-busybox <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nfs-busybox-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> nfs-busybox-pod</span><br><span class="line">    <span class="params">image:</span> busybox</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">command:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"/bin/sh"</span></span><br><span class="line">    <span class="params">args:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"-c"</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> nfs-busybox-storage</span><br><span class="line">        <span class="params">mountPath:</span> <span class="string">"/mnt"</span></span><br><span class="line">  <span class="params">restartPolicy:</span> <span class="string">"Never"</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> nfs-busybox-storage</span><br><span class="line">      <span class="params">nfs:</span></span><br><span class="line">        <span class="params">path:</span> <span class="symbol">/nfs_data_1</span>       <span class="comment"># NFS å…±äº«ç›®å½•</span></span><br><span class="line">        <span class="params">server:</span> <span class="number">192.168</span>.<span class="number">56.113</span>  <span class="comment"># NFS Server</span></span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>å¯åŠ¨PODï¼Œä¸€ä¼šå„¿PODå°±æ˜¯completedçŠ¶æ€ï¼Œè¯´æ˜æ‰§è¡Œå®Œæ¯•ã€‚</p><figure class="highlight processing"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f <span class="built_in">nfs</span>-busybox.<span class="property">yaml</span></span><br><span class="line">pod/<span class="built_in">nfs</span>-busybox-pod created</span><br><span class="line">$ kubectl <span class="built_in">get</span> pods</span><br><span class="line">NAME              READY     STATUS      RESTARTS   AGE</span><br><span class="line"><span class="built_in">nfs</span>-busybox-pod   <span class="number">0</span>/<span class="number">1</span>       Completed   <span class="number">0</span>          <span class="number">7</span>s</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å»NFS Serverå…±äº«ç›®å½•æŸ¥çœ‹æœ‰æ²¡æœ‰SUCCESSæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /nfs_data_1/</span><br><span class="line">SUCCESS</span><br></pre></td></tr></tbody></table></figure><p>è¯´æ˜å½“NFSä½œä¸ºæ™®é€šå­˜å‚¨å·æ—¶æˆ‘ä»¬æŒ‚è½½åˆ°podå®¹å™¨ä¸­äº§ç”Ÿæ•°æ®å°†ä¼šä¿å­˜åˆ°è¿™ä¸ªå­˜å‚¨å·å½“ä¸­ï¼Œå¹¶ä¸”åˆ é™¤podä¸ä¼šå½±å“æ•°æ®ã€‚</p><hr><h3 id="å¦‚ä½•åŸºäºNFSæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ï¼Ÿ"><a href="#å¦‚ä½•åŸºäºNFSæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ï¼Ÿ" class="headerlink" title="å¦‚ä½•åŸºäºNFSæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ï¼Ÿ"></a>å¦‚ä½•åŸºäºNFSæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ï¼Ÿ</h3><p>Provisioning: PVçš„é¢„åˆ¶åˆ›å»ºæœ‰ä¸¤ç§æ¨¡å¼ï¼š<code>é™æ€</code>å’Œ<code>åŠ¨æ€</code>ä¾›ç»™æ¨¡å¼ï¼Œä»–ä»¬çš„å«ä¹‰æ˜¯ï¼š</p><p><code>é™æ€ä¾›ç»™æ¨¡å¼</code>: éœ€è¦å…ˆæ‰‹åŠ¨åˆ›å»ºPV, ç„¶åé€šè¿‡ PVC ç”³è¯· PV å¹¶åœ¨ Pod ä¸­ä½¿ç”¨ï¼Œè¿™ç§æ–¹å¼å«åšé™æ€ä¾›ç»™ï¼ˆStatic Provisionï¼‰ã€‚<br><code>åŠ¨æ€ä¾›ç»™æ¨¡å¼</code>: åªéœ€è¦åˆ›å»ºPVCï¼Œç³»ç»Ÿæ ¹æ®PVCåˆ›å»ºPV, å¦‚æœæ²¡æœ‰æ»¡è¶³ PVC æ¡ä»¶çš„ PVï¼Œä¼šåŠ¨æ€åˆ›å»º PVã€‚ç›¸æ¯”é™æ€ä¾›ç»™ï¼ŒåŠ¨æ€ä¾›ç»™(Dynamical Provisionï¼‰æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ï¼šä¸éœ€è¦æå‰åˆ›å»º PVï¼Œå‡å°‘äº†ç®¡ç†å‘˜çš„å·¥ä½œé‡ï¼Œæ•ˆç‡é«˜.</p><p>åŠ¨æ€ä¾›ç»™æ˜¯é€šè¿‡ StorageClass å®ç°çš„ï¼ŒStorageClass å®šä¹‰äº†å¦‚ä½•åˆ›å»º PVã€‚<br><img src="/2018/12/15/kubernetes-storage/k8s-pvc.png" alt="k8s-pv"></p><p>ä¸‹é¢å°±åˆ†åˆ«å®è·µè¿™ä¸¤ç§æ¨¡å¼çš„åˆ›å»ºè·Ÿä½¿ç”¨:</p><h3 id="NFSä½œä¸ºé™æ€ä¾›ç»™æ¨¡å¼æŒä¹…åŒ–å­˜å‚¨å·"><a href="#NFSä½œä¸ºé™æ€ä¾›ç»™æ¨¡å¼æŒä¹…åŒ–å­˜å‚¨å·" class="headerlink" title="NFSä½œä¸ºé™æ€ä¾›ç»™æ¨¡å¼æŒä¹…åŒ–å­˜å‚¨å·"></a>NFSä½œä¸ºé™æ€ä¾›ç»™æ¨¡å¼æŒä¹…åŒ–å­˜å‚¨å·</h3><figure class="highlight brainfuck"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">æ‰‹åŠ¨åˆ›å»ºPV</span><span class="literal">---</span>&gt;<span class="comment">æ‰‹åŠ¨åˆ›å»ºPVC</span><span class="literal">---</span>&gt;<span class="comment">PODæŒ‚è½½ä½¿ç”¨</span></span><br></pre></td></tr></tbody></table></figure><h4 id="1-åˆ›å»ºPV"><a href="#1-åˆ›å»ºPV" class="headerlink" title="1. åˆ›å»ºPV"></a>1. åˆ›å»ºPV</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> nfs-test-pv.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> PersistentVolume</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nfs-test-pv</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> nfs-test-pv</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">capacity:</span></span><br><span class="line">    <span class="params">storage:</span> <span class="number">5</span>Gi   <span class="comment"># æŒ‡å®šPVå®¹é‡ä¸º5G</span></span><br><span class="line">  <span class="params">accessModes:</span></span><br><span class="line">    <span class="operator">-</span> ReadWriteOnce <span class="comment">#  æŒ‡å®šè®¿é—®æ¨¡å¼ä¸º ReadWriteOnce</span></span><br><span class="line">  <span class="params">persistentVolumeReclaimPolicy:</span> Recycle <span class="comment"># æŒ‡å®šå½“ PV çš„å›æ”¶ç­–ç•¥ä¸º Recycle</span></span><br><span class="line">  <span class="params">storageClassName:</span> nfs   <span class="comment"># å®š PV çš„ class ä¸º nfsã€‚ç›¸å½“äºä¸º PV è®¾ç½®äº†ä¸€ä¸ªåˆ†ç±»ï¼ŒPVC å¯ä»¥æŒ‡å®š class ç”³è¯·ç›¸åº” class çš„ PVã€‚</span></span><br><span class="line">  <span class="params">nfs:</span></span><br><span class="line">    <span class="params">path:</span> <span class="symbol">/nfs_data_2</span> <span class="comment"># æŒ‡å®š PV åœ¨ NFS æœåŠ¡å™¨ä¸Šå¯¹åº”çš„ç›®å½•</span></span><br><span class="line">    <span class="params">server:</span> <span class="number">192.168</span>.<span class="number">56.113</span> <span class="comment"># NFS Serveråœ°å€</span></span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p><img src="/2018/12/15/kubernetes-storage/create_pv.png" alt="create_pv"></p><p>STATUS ä¸º Availableï¼Œè¡¨ç¤º nfs-test-pv å°±ç»ªï¼Œå¯ä»¥è¢« PVC ç”³è¯·ã€‚<br>æ¥ä¸‹æ¥åˆ›å»º PVC nfs-test-pv-claimï¼š</p><h4 id="2-åˆ›å»ºPVC"><a href="#2-åˆ›å»ºPVC" class="headerlink" title="2. åˆ›å»ºPVC"></a>2. åˆ›å»ºPVC</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> nfs-test-pv-claim.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> PersistentVolumeClaim</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nfs-test-pv-claim</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">accessModes:</span> <span class="comment"># å­˜å‚¨è®¿é—®æ¨¡å¼ï¼Œæ­¤èƒ½åŠ›ä¾èµ–å­˜å‚¨å‚å•†èƒ½åŠ›</span></span><br><span class="line">    <span class="operator">-</span> ReadWriteOnce</span><br><span class="line">  <span class="params">resources:</span></span><br><span class="line">    <span class="params">requests:</span></span><br><span class="line">      <span class="params">storage:</span> <span class="number">2</span>Gi <span class="comment"># è¯·æ±‚è·å¾—çš„pvcå­˜å‚¨å¤§å°</span></span><br><span class="line">  <span class="params">storageClassName:</span> nfs </span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p><img src="/2018/12/15/kubernetes-storage/create_pvc.png" alt="create_pvc"></p><p>ä» kubectl get pvc å’Œ kubectl get pv çš„è¾“å‡ºå¯ä»¥çœ‹åˆ° nfs-test-pv-claim å·²ç» Bound åˆ° nfs-test-pvï¼Œç”³è¯·æˆåŠŸã€‚<br>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨ Pod ä¸­ä½¿ç”¨å­˜å‚¨äº†ï¼š</p><h4 id="3-åˆ›å»ºPod"><a href="#3-åˆ›å»ºPod" class="headerlink" title="3. åˆ›å»ºPod"></a>3. åˆ›å»ºPod</h4><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cat &gt;&gt; nfs-test-pod.yaml &lt;&lt; EOF</span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string"> nfs-test-pod</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">containers</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">name:  nfs-test-pod</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attribute">args</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 30000</span></span><br><span class="line">    <span class="attribute">volumeMounts</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mountPath: "/nfs-data"</span></span><br><span class="line">      <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">nfs-data</span></span><br><span class="line">  <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">name: nfs-data</span></span><br><span class="line">      <span class="attribute">persistentVolumeClaim</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">claimName</span><span class="punctuation">:</span> <span class="string"> nfs-test-pv-claim</span></span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>ä¸ä½¿ç”¨æ™®é€š Volume çš„æ ¼å¼ç±»ä¼¼ï¼Œåœ¨ volumes ä¸­é€šè¿‡ persistentVolumeClaim æŒ‡å®šä½¿ç”¨ nfs-test-pv-claim ç”³è¯·çš„ Volumeã€‚<br><img src="/2018/12/15/kubernetes-storage/create_pod.png" alt="create_pod"><br>éªŒè¯ PV æ˜¯å¦å¯ç”¨ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> nfs-test-pod <span class="built_in">touch</span> /nfs-data/SUCCESS</span><br></pre></td></tr></tbody></table></figure><div style="width: 50%; margin: auto">![create_result](kubernetes-storage/create_result.png)</div><p>å¯è§ï¼Œåœ¨ Pod ä¸­åˆ›å»ºçš„æ–‡ä»¶ /nfs-data/SUCCESS ç¡®å®å·²ç»ä¿å­˜åˆ°äº† NFS æœåŠ¡å™¨ç›®å½• /nfs_data_2/ä¸­ã€‚<br>å¦‚æœä¸å†éœ€è¦ä½¿ç”¨ PVï¼Œå¯ç”¨åˆ é™¤ PVC å›æ”¶ PV:</p><h4 id="4-å›æ”¶PVC"><a href="#4-å›æ”¶PVC" class="headerlink" title="4. å›æ”¶PVC"></a>4. å›æ”¶PVC</h4><p><strong>æŒä¹…åŒ–å·å£°æ˜çš„ä¿æŠ¤</strong><br>PVC ä¿æŠ¤çš„ç›®çš„æ˜¯ç¡®ä¿ç”± pod æ­£åœ¨ä½¿ç”¨çš„ PVC ä¸ä¼šä»ç³»ç»Ÿä¸­ç§»é™¤ï¼Œå› ä¸ºå¦‚æœè¢«ç§»é™¤çš„è¯å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚<br>æ³¨æ„ï¼šå½“ pod çŠ¶æ€ä¸º Pending å¹¶ä¸” pod å·²ç»åˆ†é…ç»™èŠ‚ç‚¹æˆ– pod ä¸º Running çŠ¶æ€æ—¶ï¼ŒPVC å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚<br>å½“å¯ç”¨<a href="https://k8smeetup.github.io/docs/tasks/administer-cluster/pvc-protection/#lichuqiang">PVCä¿æŠ¤</a>åŠŸèƒ½æ—¶ï¼Œå¦‚æœç”¨æˆ·åˆ é™¤äº†ä¸€ä¸ª pod æ­£åœ¨ä½¿ç”¨çš„ PVCï¼Œåˆ™è¯¥ PVC ä¸ä¼šè¢«ç«‹å³åˆ é™¤ã€‚PVC çš„åˆ é™¤å°†è¢«æ¨è¿Ÿï¼Œç›´åˆ° PVC ä¸å†è¢«ä»»ä½• pod ä½¿ç”¨ã€‚<br>æ‚¨å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ç›´æ¥åˆ é™¤ä¸Šé¢PODæ­£åœ¨ä½¿ç”¨çš„PVCæ—¶å‘½ä»¤ç›´æ¥hangä½äº†ï¼Œæ­¤æ—¶è™½ç„¶ä¸º Teminatiingï¼Œä½†PVC å—åˆ°ä¿æŠ¤ï¼Œ<code>Finalizers</code> åˆ—è¡¨ä¸­åŒ…å« kubernetes.io/pvc-protectionï¼š</p><figure class="highlight maxima"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">delete</span> pvc nfs-test-<span class="built_in">pv</span>-claim</span><br></pre></td></tr></tbody></table></figure><p><img src="/2018/12/15/kubernetes-storage/pvc_delete_status.png" alt="pvc_delete_status"><br>ç­‰å¾… pod çŠ¶æ€å˜ä¸º Terminatedï¼ˆåˆ é™¤ pod æˆ–è€…ç­‰åˆ°å®ƒç»“æŸï¼‰ï¼Œç„¶åæ£€æŸ¥ï¼Œç¡®è®¤ PVC è¢«ç§»é™¤ã€‚</p><p>åä¹‹ï¼Œå¦‚æœä¸€ä¸ªPVCæ²¡æœ‰è¢«podä½¿ç”¨åˆ™å¯ä»¥ç›´æ¥åˆ é™¤ã€‚</p><p>ç”¨æˆ·ç”¨å®Œ volume åï¼Œå¯ä»¥ä»å…è®¸å›æ”¶èµ„æºçš„ API ä¸­åˆ é™¤ PVC å¯¹è±¡ã€‚PersistentVolume çš„å›æ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤åœ¨å­˜å‚¨å·å£°æ˜é‡Šæ”¾ååº”å¦‚ä½•å¤„ç†è¯¥å·ã€‚ç›®å‰ï¼Œvolume çš„å¤„ç†ç­–ç•¥æœ‰:</p><ul><li>Retainï¼Œä¸æ¸…ç†, ä¿ç•™ Volumeï¼ˆéœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼‰</li><li>Recycleï¼Œåˆ é™¤æ•°æ®ï¼Œå³ rm -rf /thevolume/*ï¼ˆåªæœ‰ NFS å’Œ HostPath æ”¯æŒï¼‰</li><li>Deleteï¼Œåˆ é™¤å­˜å‚¨èµ„æºï¼Œæ¯”å¦‚åˆ é™¤ AWS EBS å·ï¼ˆåªæœ‰ AWS EBS, GCE PD, Azure Disk å’Œ Cinder æ”¯æŒï¼‰</li></ul><p>OK ä»¥ä¸Šæ˜¯NFSåˆ›å»ºé™æ€æ¨¡å¼åˆ›å»ºPVC,ä»¥åŠPVCè·ŸPODç”Ÿå‘½å‘¨æœŸçš„ä¸€äº›å®è·µï¼Œä¸‹é¢å®è·µåŠ¨æ€æ¨¡å¼</p><h3 id="NFSä½œä¸ºåŠ¨æ€æŒä¹…åŒ–å­˜å‚¨å·"><a href="#NFSä½œä¸ºåŠ¨æ€æŒä¹…åŒ–å­˜å‚¨å·" class="headerlink" title="NFSä½œä¸ºåŠ¨æ€æŒä¹…åŒ–å­˜å‚¨å·"></a>NFSä½œä¸ºåŠ¨æ€æŒä¹…åŒ–å­˜å‚¨å·</h3><p>åˆ©ç”¨NFS client provisioneråŠ¨æ€æä¾›Kubernetesåç«¯å­˜å‚¨å·</p><p>æƒ³è¦åŠ¨æ€ç”ŸæˆPVï¼Œéœ€è¦è¿è¡Œä¸€ä¸ªNFS-ProvisioneræœåŠ¡ï¼Œå°†å·²é…ç½®å¥½çš„NFSç³»ç»Ÿç›¸å…³å‚æ•°å½•å…¥ï¼Œå¹¶å‘ç”¨æˆ·æä¾›åˆ›å»ºPVçš„æœåŠ¡ã€‚å®˜æ–¹æ¨èä½¿ç”¨Deploymentè¿è¡Œä¸€ä¸ªreplicaæ¥å®ç°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨Daemonsetç­‰å…¶ä»–æ–¹å¼ï¼Œè¿™äº›éƒ½åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æä¾›äº†ã€‚</p><p>å‰ææ¡ä»¶æ˜¯æœ‰å·²ç»å®‰è£…å¥½çš„NFSæœåŠ¡å™¨ï¼Œå¹¶ä¸”NFSæœåŠ¡å™¨ä¸Kubernetesçš„SlaveèŠ‚ç‚¹éƒ½èƒ½ç½‘ç»œè¿é€šã€‚ æ‰€æœ‰ä¸‹æ–‡ç”¨åˆ°çš„æ–‡ä»¶æ¥è‡ªäº<code>git clone https://github.com/kubernetes-incubator/external-storage.git</code> çš„nfs-clientç›®å½•</p><p>nfs-client-provisioner æ˜¯ä¸€ä¸ªKubernetesçš„ç®€æ˜“NFSçš„å¤–éƒ¨provisionerï¼Œæœ¬èº«ä¸æä¾›NFSï¼Œéœ€è¦ç°æœ‰çš„NFSæœåŠ¡å™¨æä¾›å­˜å‚¨</p><ul><li>PVä»¥ <code>${namespace}-${pvcName}-${pvName}</code>çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li><li>PVå›æ”¶çš„æ—¶å€™ä»¥ <code>archieved-${namespace}-${pvcName}-${pvName}</code> çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li></ul><h4 id="1-è·å–nfs-client-provisioneré…ç½®æ–‡ä»¶"><a href="#1-è·å–nfs-client-provisioneré…ç½®æ–‡ä»¶" class="headerlink" title="1. è·å–nfs-client-provisioneré…ç½®æ–‡ä»¶"></a>1. è·å–nfs-client-provisioneré…ç½®æ–‡ä»¶</h4><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/kubernetes-incubator/external-storage.git</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="2-å®‰è£…éƒ¨ç½²"><a href="#2-å®‰è£…éƒ¨ç½²" class="headerlink" title="2. å®‰è£…éƒ¨ç½²:"></a>2. å®‰è£…éƒ¨ç½²:</h4><h5 id="1-ä¿®æ”¹deploymentæ–‡ä»¶å¹¶éƒ¨ç½²-deploy-deployment-yaml"><a href="#1-ä¿®æ”¹deploymentæ–‡ä»¶å¹¶éƒ¨ç½²-deploy-deployment-yaml" class="headerlink" title="1. ä¿®æ”¹deploymentæ–‡ä»¶å¹¶éƒ¨ç½² deploy/deployment.yaml"></a>1. ä¿®æ”¹deploymentæ–‡ä»¶å¹¶éƒ¨ç½² deploy/deployment.yaml</h5><p>éœ€è¦ä¿®æ”¹çš„åœ°æ–¹åªæœ‰NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ192.168.56.113ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/nfs_data_3ï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½•</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">deploy/deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.113</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfs_data_3</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.113</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs_data_3</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">deploy/deployment.yaml</span> <span class="comment"># æ‰§è¡Œéƒ¨ç½²</span></span><br><span class="line"><span class="string">serviceaccount/nfs-client-provisioner</span> <span class="string">created</span></span><br><span class="line"><span class="string">deployment.extensions/nfs-client-provisioner</span> <span class="string">created</span></span><br></pre></td></tr></tbody></table></figure><h5 id="2-ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²-deploy-class-yaml"><a href="#2-ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²-deploy-class-yaml" class="headerlink" title="2. ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½² deploy/class.yaml"></a>2. ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½² deploy/class.yaml</h5><p>æ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat deploy<span class="symbol">/class.yaml</span></span><br><span class="line"><span class="params">apiVersion:</span> storage.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> StorageClass</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> managed-nfs-storage</span><br><span class="line"><span class="params">provisioner:</span> fuseim.pri<span class="symbol">/ifs</span> <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line"><span class="params">parameters:</span></span><br><span class="line">  <span class="params">archiveOnDelete:</span> <span class="string">"false"</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># æ‰§è¡Œéƒ¨ç½² </span></span><br><span class="line">kubectl apply <span class="operator">-</span>f deploy<span class="symbol">/class.yaml</span></span><br><span class="line">storageclass.storage.k8s.io<span class="symbol">/managed-nfs-storage</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹StorageClass</span></span><br><span class="line">kubectl get sc</span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri<span class="symbol">/ifs</span>   <span class="number">16</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è¿™ä¸ªmanaged-nfs-storageåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯</span></span><br><span class="line">kubectl patch storageclass managed-nfs-storage <span class="operator">-</span>p '{<span class="string">"metadata"</span>: {<span class="string">"annotations"</span>:{<span class="string">"storageclass.kubernetes.io/is-default-class"</span>:<span class="string">"true"</span>}}}'</span><br><span class="line">$ kubectl get sc</span><br><span class="line">NAME                            PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage (default)   fuseim.pri<span class="symbol">/ifs</span>   <span class="number">19</span>m</span><br></pre></td></tr></tbody></table></figure><h5 id="3-æˆæƒ"><a href="#3-æˆæƒ" class="headerlink" title="3. æˆæƒ"></a>3. æˆæƒ</h5><p>å¦‚æœæ‚¨çš„é›†ç¾¤å¯ç”¨äº†RBACï¼Œæˆ–è€…æ‚¨æ­£åœ¨è¿è¡ŒOpenShiftï¼Œåˆ™å¿…é¡»æˆæƒprovisionerã€‚ å¦‚æœä½ åœ¨éé»˜è®¤çš„â€œdefaultâ€åç§°ç©ºé—´/é¡¹ç›®ä¹‹å¤–éƒ¨ç½²ï¼Œå¯ä»¥ç¼–è¾‘deploy/rbac.yamlæˆ–ç¼–è¾‘`oadm policyâ€œæŒ‡ä»¤ã€‚</p><p><em>å¦‚æœå¯ç”¨äº†RBAC</em><br>éœ€è¦æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤æ¥æˆæƒã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">cat deploy<span class="symbol">/rbac.yaml</span></span><br><span class="line"><span class="params">kind:</span> ClusterRole</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nfs-client-provisioner-runner</span><br><span class="line"><span class="params">rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"persistentvolumes"</span>]</span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"storageclasses"</span>]</span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"events"</span>]</span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> run-nfs-client-provisioner</span><br><span class="line"><span class="params">subjects:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">kind:</span> ServiceAccount</span><br><span class="line">    <span class="params">name:</span> nfs-client-provisioner</span><br><span class="line">    <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">roleRef:</span></span><br><span class="line">  <span class="params">kind:</span> ClusterRole</span><br><span class="line">  <span class="params">name:</span> nfs-client-provisioner-runner</span><br><span class="line">  <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">kind:</span> Role</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> leader-locking-nfs-client-provisioner</span><br><span class="line"><span class="params">rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"endpoints"</span>]</span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">kind:</span> RoleBinding</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> leader-locking-nfs-client-provisioner</span><br><span class="line"><span class="params">subjects:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">kind:</span> ServiceAccount</span><br><span class="line">    <span class="params">name:</span> nfs-client-provisioner</span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">roleRef:</span></span><br><span class="line">  <span class="params">kind:</span> Role</span><br><span class="line">  <span class="params">name:</span> leader-locking-nfs-client-provisioner</span><br><span class="line">  <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">kubectl create <span class="operator">-</span>f deploy<span class="symbol">/rbac.yaml</span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io<span class="symbol">/nfs-client-provisioner-runner</span> created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io<span class="symbol">/run-nfs-client-provisioner</span> created</span><br><span class="line">role.rbac.authorization.k8s.io<span class="symbol">/leader-locking-nfs-client-provisioner</span> created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io<span class="symbol">/leader-locking-nfs-client-provisioner</span> created</span><br></pre></td></tr></tbody></table></figure><h5 id="4-æ‰§è¡Œéƒ¨ç½²"><a href="#4-æ‰§è¡Œéƒ¨ç½²" class="headerlink" title="4. æ‰§è¡Œéƒ¨ç½²:"></a>4. æ‰§è¡Œéƒ¨ç½²:</h5><h6 id="æµ‹è¯•åˆ›å»ºPVC"><a href="#æµ‹è¯•åˆ›å»ºPVC" class="headerlink" title="æµ‹è¯•åˆ›å»ºPVC"></a>æµ‹è¯•åˆ›å»ºPVC</h6><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat deploy<span class="symbol">/test-claim.yaml</span></span><br><span class="line"><span class="params">kind:</span> PersistentVolumeClaim</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-claim</span><br><span class="line">  <span class="params">annotations:</span></span><br><span class="line">    volume.beta.kubernetes.io<span class="operator">/</span><span class="params">storage-class:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">accessModes:</span></span><br><span class="line">    <span class="operator">-</span> ReadWriteMany</span><br><span class="line">  <span class="params">resources:</span></span><br><span class="line">    <span class="params">requests:</span></span><br><span class="line">      <span class="params">storage:</span> <span class="number">1</span>Mi</span><br><span class="line"></span><br><span class="line">$ kubectl create <span class="operator">-</span>f deploy<span class="symbol">/test-claim.yaml</span></span><br><span class="line">persistentvolumeclaim<span class="symbol">/test-claim</span> created</span><br><span class="line"></span><br><span class="line">$ kubectl get pv,pvc</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                STORAGECLASS          REASON    AGE</span><br><span class="line">persistentvolume<span class="symbol">/pvc-137f0450-0048-11e9-af7a-00505621dd5b</span>   <span class="number">1</span>Mi        RWX            Delete           Bound     default<span class="symbol">/test-claim</span>   managed-nfs-storage             <span class="number">9</span>m</span><br><span class="line"></span><br><span class="line">NAME                               STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">persistentvolumeclaim<span class="symbol">/test-claim</span>   Bound     pvc-<span class="number">137</span>f0450-<span class="number">004</span>8-<span class="number">11</span>e9-af7a-<span class="number">00505621</span>dd5b   <span class="number">1</span>Mi        RWX            managed-nfs-storage   <span class="number">9</span>m</span><br><span class="line"><span class="comment"># ä»¥ä¸Šå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„pvcå·²ç»ç”³è¯·æˆåŠŸï¼Œç­‰å¾…PODæŒ‚è½½ä½¿ç”¨</span></span><br></pre></td></tr></tbody></table></figure><h6 id="æµ‹è¯•åˆ›å»ºPOD"><a href="#æµ‹è¯•åˆ›å»ºPOD" class="headerlink" title="æµ‹è¯•åˆ›å»ºPOD"></a>æµ‹è¯•åˆ›å»ºPOD</h6><p>PODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat deploy<span class="symbol">/test-pod.yaml</span></span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> test-pod</span><br><span class="line">    <span class="params">image:</span> gcr.io<span class="operator">/</span>google_containers<span class="operator">/</span>busybox:<span class="number">1.24</span></span><br><span class="line">    <span class="params">command:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"/bin/sh"</span></span><br><span class="line">    <span class="params">args:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"-c"</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> nfs-pvc</span><br><span class="line">        <span class="params">mountPath:</span> <span class="string">"/mnt"</span></span><br><span class="line">  <span class="params">restartPolicy:</span> <span class="string">"Never"</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> nfs-pvc</span><br><span class="line">      <span class="params">persistentVolumeClaim:</span></span><br><span class="line">        <span class="params">claimName:</span> test-claim</span><br><span class="line">        </span><br><span class="line">kubectl create <span class="operator">-</span>f deploy<span class="symbol">/test-pod.yaml</span></span><br><span class="line">pod<span class="symbol">/test-pod</span> created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨PODï¼Œä¸€ä¼šå„¿PODå°±æ˜¯completedçŠ¶æ€ï¼Œè¯´æ˜æ‰§è¡Œå®Œæ¯•ã€‚</span></span><br><span class="line">kubectl get pod | grep test-pod</span><br><span class="line">NAME                                      READY     STATUS      RESTARTS   AGE</span><br><span class="line">test-pod                                  <span class="number">0</span><span class="symbol">/1</span>       Completed   <span class="number">0</span>          <span class="number">18</span>s</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h6 id="åœ¨NFSæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ä¸‹çš„å·å­ç›®å½•ä¸­æ£€æŸ¥åˆ›å»ºçš„NFS-PVå·ä¸‹æ˜¯å¦æœ‰â€SUCCESSâ€-æ–‡ä»¶ã€‚"><a href="#åœ¨NFSæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ä¸‹çš„å·å­ç›®å½•ä¸­æ£€æŸ¥åˆ›å»ºçš„NFS-PVå·ä¸‹æ˜¯å¦æœ‰â€SUCCESSâ€-æ–‡ä»¶ã€‚" class="headerlink" title="åœ¨NFSæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ä¸‹çš„å·å­ç›®å½•ä¸­æ£€æŸ¥åˆ›å»ºçš„NFS PVå·ä¸‹æ˜¯å¦æœ‰â€SUCCESSâ€ æ–‡ä»¶ã€‚"></a>åœ¨NFSæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ä¸‹çš„å·å­ç›®å½•ä¸­æ£€æŸ¥åˆ›å»ºçš„NFS PVå·ä¸‹æ˜¯å¦æœ‰â€SUCCESSâ€ æ–‡ä»¶ã€‚</h6><p><img src="/2018/12/15/kubernetes-storage/SUCCESS.png" alt="SUCCESS"><br>ä»¥ä¸Šï¼Œè¯´æ˜æˆ‘ä»¬éƒ¨ç½²æ­£å¸¸ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡åŠ¨æ€åˆ†é…NFSçš„æŒä¹…å…±äº«å·</p><p><strong>å‚è€ƒ</strong><br><a href="https://k8smeetup.github.io/docs/concepts/storage/volumes/">https://k8smeetup.github.io/docs/concepts/storage/volumes/</a><br><a href="https://k8smeetup.github.io/docs/concepts/storage/persistent-volumes/#%E5%9B%9E%E6%94%B6-1">https://k8smeetup.github.io/docs/concepts/storage/persistent-volumes/#å›æ”¶-1</a><br><a href="https://k8smeetup.github.io/docs/tasks/administer-cluster/pvc-protection/#lichuqiang">https://k8smeetup.github.io/docs/tasks/administer-cluster/pvc-protection/#lichuqiang</a><br><a href="https://jimmysong.io/kubernetes-handbook/practice/using-nfs-for-persistent-storage.html">https://jimmysong.io/kubernetes-handbook/practice/using-nfs-for-persistent-storage.html</a></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernets </tag>
            
            <tag> æŒä¹…åŒ–å­˜å‚¨ </tag>
            
            <tag> Storage </tag>
            
            <tag> NFS PVé™æ€ä¾›ç»™ </tag>
            
            <tag> NFS PVåŠ¨æ€ä¾›ç»™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç†è§£kubernetesä¸­çš„æœ‰çŠ¶æ€æœåŠ¡StatefulSet</title>
      <link href="/2018/12/14/kubernetes-statefulset/"/>
      <url>/2018/12/14/kubernetes-statefulset/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>StatefulSet æ˜¯ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜ï¼ˆå¯¹åº” Deployments å’Œ ReplicaSets æ˜¯ä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡ï¼‰ï¼Œå…¶åº”ç”¨åœºæ™¯åŒ…æ‹¬</p><ul><li>ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå³ Pod é‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäº PVC æ¥å®ç°</li><li>ç¨³å®šçš„ç½‘ç»œæ ‡å¿—ï¼Œå³ Pod é‡æ–°è°ƒåº¦åå…¶ PodName å’Œ HostName ä¸å˜ï¼ŒåŸºäº Headless Serviceï¼ˆå³æ²¡æœ‰ Cluster IP çš„ Serviceï¼‰æ¥å®ç°</li><li>æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼Œå³ Pod æ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‰©å±•çš„æ—¶å€™è¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡ä¾åºè¿›è¡Œï¼ˆå³ä» 0 åˆ° N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ª Pod è¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„ Pod å¿…é¡»éƒ½æ˜¯ Running å’Œ Ready çŠ¶æ€ï¼‰ï¼ŒåŸºäº init containers æ¥å®ç°</li><li>æœ‰åºæ”¶ç¼©ï¼Œæœ‰åºåˆ é™¤ï¼ˆå³ä» N-1 åˆ° 0ï¼‰</li></ul><p>ä»ä¸Šé¢çš„åº”ç”¨åœºæ™¯å¯ä»¥å‘ç°ï¼ŒStatefulSet ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ul><li>ç”¨äºå®šä¹‰ç½‘ç»œæ ‡å¿—ï¼ˆDNS domainï¼‰çš„ Headless Service</li><li>ç”¨äºåˆ›å»º PersistentVolumes çš„ volumeClaimTemplates</li><li>å®šä¹‰å…·ä½“åº”ç”¨çš„ StatefulSet</li></ul><p>StatefulSet ä¸­æ¯ä¸ª Pod çš„ DNS æ ¼å¼ä¸º statefulSetName-{0..N-1}.serviceName.namespace.svc.cluster.localï¼Œå…¶ä¸­</p><ul><li>serviceName ä¸º Headless Service çš„åå­—</li><li>0..N-1 ä¸º Pod æ‰€åœ¨çš„åºå·ï¼Œä» 0 å¼€å§‹åˆ° N-1</li><li>statefulSetName ä¸º StatefulSet çš„åå­—</li><li>namespace ä¸ºæœåŠ¡æ‰€åœ¨çš„ namespaceï¼ŒHeadless Service å’Œ StatefulSet å¿…é¡»åœ¨ç›¸åŒçš„ namespace</li><li>.cluster.local ä¸º Cluster Domain</li></ul><h2 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h2><ul><li>ç»™å®š Pod çš„å­˜å‚¨å¿…é¡»ç”± PersistentVolume Provisioner æ ¹æ®è¯·æ±‚çš„ storage class è¿›è¡Œé…ç½®ï¼Œæˆ–ç”±ç®¡ç†å‘˜é¢„å…ˆé…ç½®ã€‚</li><li>åˆ é™¤æˆ– scale StatefulSet å°†ä¸ä¼šåˆ é™¤ä¸ StatefulSet ç›¸å…³è”çš„ volumeã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œè¿™é€šå¸¸æ¯”è‡ªåŠ¨æ¸…é™¤æ‰€æœ‰ç›¸å…³ StatefulSet èµ„æºæ›´æœ‰ä»·å€¼ã€‚</li><li>StatefulSets ç›®å‰è¦æ±‚ Headless Service è´Ÿè´£ Pod çš„ç½‘ç»œèº«ä»½ã€‚ æ‚¨æœ‰è´£ä»»åˆ›å»ºæ­¤æœåŠ¡ã€‚</li></ul><h1 id="éƒ¨ç½²StatefulsetæœåŠ¡"><a href="#éƒ¨ç½²StatefulsetæœåŠ¡" class="headerlink" title="éƒ¨ç½²StatefulsetæœåŠ¡"></a>éƒ¨ç½²StatefulsetæœåŠ¡</h1><p>é¦–å…ˆæˆ‘ä»¬ä¸‹é¢ä½¿ç”¨çš„æ˜¯ç”¨å‰é¢<a href="https://blog.sctux.com/2018/12/15/kubernetes-storage/#NFS%E4%BD%9C%E4%B8%BA%E5%8A%A8%E6%80%81%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%E5%8D%B7">åšæ–‡</a>ä¸­ä½¿ç”¨åˆ°çš„NFSåšåŠ¨æ€ä¾›ç»™PVCä½œä¸ºæŒä¹…åŒ–å­˜å‚¨ã€‚é‚£ä¹ˆä»–çš„åˆ›å»ºæ­¥éª¤è¿™é‡Œä¸åœ¨èµ˜è¿°ï¼Œæˆ‘ä»¬åœ¨ç¼–æ’yamlæ–‡ä»¶ä¸­ç”³è¯·å³å¯ã€‚</p><h2 id="è·å–åŠ¨æ€å·ä¿¡æ¯"><a href="#è·å–åŠ¨æ€å·ä¿¡æ¯" class="headerlink" title="è·å–åŠ¨æ€å·ä¿¡æ¯"></a>è·å–åŠ¨æ€å·ä¿¡æ¯</h2><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe storageclass managed-nfs-storage</span><br><span class="line"><span class="params">Name:</span>                  managed-nfs-storage</span><br><span class="line"><span class="params">IsDefaultClass:</span>        No</span><br><span class="line"><span class="params">Annotations:</span>           <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Provisioner:</span>           fuseim.pri<span class="symbol">/ifs</span></span><br><span class="line"><span class="params">Parameters:</span>            archiveOnDelete<span class="operator">=</span><span class="literal">false</span></span><br><span class="line"><span class="params">AllowVolumeExpansion:</span>  <span class="symbol">&lt;unset&gt;</span></span><br><span class="line"><span class="params">MountOptions:</span>          <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">ReclaimPolicy:</span>         Delete</span><br><span class="line"><span class="params">VolumeBindingMode:</span>     Immediate</span><br><span class="line"><span class="params">Events:</span>                <span class="symbol">&lt;none&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="ç¼–å†™service"><a href="#ç¼–å†™service" class="headerlink" title="ç¼–å†™service"></a>ç¼–å†™service</h2><p>ä¸€ä¸ªåä¸º nginx çš„ headless serviceï¼Œç”¨äºæ§åˆ¶ç½‘ç»œåŸŸã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> statefulset_service.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nginx</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> nginx</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">ports:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="params">name:</span> web</span><br><span class="line">  <span class="params">clusterIP:</span> None</span><br><span class="line">  <span class="params">selector:</span></span><br><span class="line">    <span class="params">app:</span> nginx</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»º</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f statefulset_service.yaml</span><br><span class="line">service<span class="symbol">/nginx</span> created</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="ç¼–å†™statefulset-yaml"><a href="#ç¼–å†™statefulset-yaml" class="headerlink" title="ç¼–å†™statefulset yaml"></a>ç¼–å†™statefulset yaml</h2><ul><li>ä¸€ä¸ªåä¸º web çš„ StatefulSetï¼Œå®ƒçš„ Spec ä¸­æŒ‡å®šåœ¨æœ‰ 2 ä¸ªè¿è¡Œ nginx å®¹å™¨çš„ Podã€‚</li><li><code>volumeClaimTemplates</code> ä½¿ç”¨ PersistentVolume Provisioner æä¾›çš„ <code>PersistentVolumes</code> ä½œä¸ºç¨³å®šå­˜å‚¨ã€‚</li></ul><p>volumeClaimTemplates: è¡¨ç¤ºä¸€ç±»PVCçš„æ¨¡æ¿ï¼Œç³»ç»Ÿä¼šæ ¹æ®Statefulseté…ç½®çš„replicasæ•°é‡ï¼Œåˆ›å»ºç›¸åº”æ•°é‡çš„PVCã€‚è¿™äº›PVCé™¤äº†åå­—ä¸ä¸€æ ·ä¹‹å¤–å…¶ä»–é…ç½®éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>ä¸‹é¢storageClassNameé…ç½®ä¸ºæˆ‘ä¹‹å‰é€šè¿‡NFSåˆ›å»ºçš„ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> statefulset.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> apps<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> StatefulSet</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> web</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">serviceName:</span> <span class="string">"nginx"</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">        <span class="params">app:</span> nginx</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> nginx</span><br><span class="line">        <span class="params">image:</span> nginx</span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="params">name:</span> web</span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> www-disk</span><br><span class="line">          <span class="params">mountPath:</span> <span class="symbol">/usr/share/nginx/html</span></span><br><span class="line">  <span class="params">volumeClaimTemplates:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">metadata:</span></span><br><span class="line">      <span class="params">name:</span> www-disk</span><br><span class="line">      <span class="params">annotations:</span></span><br><span class="line">        volume.beta.kubernetes.io<span class="operator">/</span><span class="params">storage-class:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">accessModes:</span> [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      <span class="params">storageClassName:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line">      <span class="params">resources:</span></span><br><span class="line">        <span class="params">requests:</span></span><br><span class="line">          <span class="params">storage:</span> <span class="number">1</span>Gi</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><h2 id="éªŒè¯æœåŠ¡ä¼¸ç¼©æ€§"><a href="#éªŒè¯æœåŠ¡ä¼¸ç¼©æ€§" class="headerlink" title="éªŒè¯æœåŠ¡ä¼¸ç¼©æ€§"></a>éªŒè¯æœåŠ¡ä¼¸ç¼©æ€§</h2><h3 id="åˆ›å»ºStatefulsetæœåŠ¡ï¼š"><a href="#åˆ›å»ºStatefulsetæœåŠ¡ï¼š" class="headerlink" title="åˆ›å»ºStatefulsetæœåŠ¡ï¼š"></a>åˆ›å»ºStatefulsetæœåŠ¡ï¼š</h3><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># æ‰§è¡Œåˆ›å»º</span><br><span class="line">$ kubectl create -f statefulset.yaml</span><br><span class="line">statefulset.apps/web created</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner<span class="string">-6</span>c6997c674-z7m9r   1/1       Running   0          18m</span><br><span class="line">pod/web<span class="string">-0</span>                                     1/1       Running   0          13m</span><br><span class="line">pod/web<span class="string">-1</span>                                     1/1       Running   0          12m</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME                                   STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-0</span>   Bound     pvc-a440540e<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   13m</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-1</span>   Bound     pvc-af5c7006<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   12m</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="æ‰©å®¹æœåŠ¡åˆ°3ä¸ªPodï¼Œæ˜¾ç¤ºä¼šåˆ›å»ºæ–°çš„äº‘ç›˜å·ï¼š"><a href="#æ‰©å®¹æœåŠ¡åˆ°3ä¸ªPodï¼Œæ˜¾ç¤ºä¼šåˆ›å»ºæ–°çš„äº‘ç›˜å·ï¼š" class="headerlink" title="æ‰©å®¹æœåŠ¡åˆ°3ä¸ªPodï¼Œæ˜¾ç¤ºä¼šåˆ›å»ºæ–°çš„äº‘ç›˜å·ï¼š"></a>æ‰©å®¹æœåŠ¡åˆ°3ä¸ªPodï¼Œæ˜¾ç¤ºä¼šåˆ›å»ºæ–°çš„äº‘ç›˜å·ï¼š</h3><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale sts web --replicas=3</span><br><span class="line">statefulset.apps/web scaled</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner<span class="string">-6</span>c6997c674-z7m9r   1/1       Running   0          19m</span><br><span class="line">web<span class="string">-0</span>                                     1/1       Running   0          14m</span><br><span class="line">web<span class="string">-1</span>                                     1/1       Running   0          14m</span><br><span class="line">web<span class="string">-2</span>                                     1/1       Running   0          40s</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME             STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">www-disk-web<span class="string">-0</span>   Bound     pvc-a440540e<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   14m</span><br><span class="line">www-disk-web<span class="string">-1</span>   Bound     pvc-af5c7006<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   14m</span><br><span class="line">www-disk-web<span class="string">-2</span>   Bound     pvc<span class="string">-97</span>afce59<span class="string">-01</span>df<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   38s</span><br></pre></td></tr></tbody></table></figure><h3 id="ç¼©å®¹æœåŠ¡åˆ°1ä¸ªPodï¼Œæ˜¾ç¤ºpvc-pvå¹¶ä¸ä¼šä¸€åŒåˆ é™¤ï¼š"><a href="#ç¼©å®¹æœåŠ¡åˆ°1ä¸ªPodï¼Œæ˜¾ç¤ºpvc-pvå¹¶ä¸ä¼šä¸€åŒåˆ é™¤ï¼š" class="headerlink" title="ç¼©å®¹æœåŠ¡åˆ°1ä¸ªPodï¼Œæ˜¾ç¤ºpvc/pvå¹¶ä¸ä¼šä¸€åŒåˆ é™¤ï¼š"></a>ç¼©å®¹æœåŠ¡åˆ°1ä¸ªPodï¼Œæ˜¾ç¤ºpvc/pvå¹¶ä¸ä¼šä¸€åŒåˆ é™¤ï¼š</h3><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale sts web --replicas=1</span><br><span class="line">statefulset.apps/web scaled</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner<span class="string">-6</span>c6997c674-z7m9r   1/1       Running   0          21m</span><br><span class="line">web<span class="string">-0</span>                                     1/1       Running   0          16m</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME             STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">www-disk-web<span class="string">-0</span>   Bound     pvc-a440540e<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   16m</span><br><span class="line">www-disk-web<span class="string">-1</span>   Bound     pvc-af5c7006<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   16m</span><br><span class="line">www-disk-web<span class="string">-2</span>   Bound     pvc<span class="string">-97</span>afce59<span class="string">-01</span>df<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   2m</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="å†æ¬¡æ‰©å®¹åˆ°3ä¸ªPodï¼Œæ–°çš„podä¼šå¤ç”¨åŸæ¥çš„PVC-PVï¼š"><a href="#å†æ¬¡æ‰©å®¹åˆ°3ä¸ªPodï¼Œæ–°çš„podä¼šå¤ç”¨åŸæ¥çš„PVC-PVï¼š" class="headerlink" title="å†æ¬¡æ‰©å®¹åˆ°3ä¸ªPodï¼Œæ–°çš„podä¼šå¤ç”¨åŸæ¥çš„PVC/PVï¼š"></a>å†æ¬¡æ‰©å®¹åˆ°3ä¸ªPodï¼Œæ–°çš„podä¼šå¤ç”¨åŸæ¥çš„PVC/PVï¼š</h3><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale sts web --replicas=3</span><br><span class="line">statefulset.apps/web scaled</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner<span class="string">-6</span>c6997c674-z7m9r   1/1       Running   1          46m</span><br><span class="line">pod/web<span class="string">-0</span>                                     1/1       Running   0          3m</span><br><span class="line">pod/web<span class="string">-1</span>                                     1/1       Running   0          1m</span><br><span class="line">pod/web<span class="string">-2</span>                                     1/1       Running   0          18s</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME                                   STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-0</span>   Bound     pvc-a440540e<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   41m</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-1</span>   Bound     pvc-af5c7006<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   40m</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-2</span>   Bound     pvc<span class="string">-97</span>afce59<span class="string">-01</span>df<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   27m</span><br></pre></td></tr></tbody></table></figure><h3 id="åˆ é™¤ä¸€ä¸ªpod-web0å‰ï¼ŒPodå¼•ç”¨PVCï¼šwww-disk-web-0"><a href="#åˆ é™¤ä¸€ä¸ªpod-web0å‰ï¼ŒPodå¼•ç”¨PVCï¼šwww-disk-web-0" class="headerlink" title="åˆ é™¤ä¸€ä¸ªpod/web0å‰ï¼ŒPodå¼•ç”¨PVCï¼šwww-disk-web-0"></a>åˆ é™¤ä¸€ä¸ªpod/web0å‰ï¼ŒPodå¼•ç”¨PVCï¼šwww-disk-web-0</h3><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kubectl</span> describe pod/web-<span class="number">0</span> | grep ClaimName</span><br><span class="line">    <span class="attribute">ClaimName</span>:  www-disk-web-<span class="number">0</span></span><br></pre></td></tr></tbody></table></figure><h3 id="åˆ é™¤Podåï¼Œé‡æ–°åˆ›å»ºçš„Podåå­—ä¸åˆ é™¤çš„ä¸€è‡´ï¼Œä¸”ä½¿ç”¨åŒä¸€ä¸ªPVCï¼š"><a href="#åˆ é™¤Podåï¼Œé‡æ–°åˆ›å»ºçš„Podåå­—ä¸åˆ é™¤çš„ä¸€è‡´ï¼Œä¸”ä½¿ç”¨åŒä¸€ä¸ªPVCï¼š" class="headerlink" title="åˆ é™¤Podåï¼Œé‡æ–°åˆ›å»ºçš„Podåå­—ä¸åˆ é™¤çš„ä¸€è‡´ï¼Œä¸”ä½¿ç”¨åŒä¸€ä¸ªPVCï¼š"></a>åˆ é™¤Podåï¼Œé‡æ–°åˆ›å»ºçš„Podåå­—ä¸åˆ é™¤çš„ä¸€è‡´ï¼Œä¸”ä½¿ç”¨åŒä¸€ä¸ªPVCï¼š</h3><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod/web<span class="string">-0</span></span><br><span class="line">pod "web<span class="string">-0</span>" deleted</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner<span class="string">-6</span>c6997c674-z7m9r   1/1       Running   1          49m</span><br><span class="line">pod/web<span class="string">-0</span>                                     1/1       Running   0          10s</span><br><span class="line">pod/web<span class="string">-1</span>                                     1/1       Running   0          4m</span><br><span class="line">pod/web<span class="string">-2</span>                                     1/1       Running   0          3m</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod/web<span class="string">-0</span> | grep ClaimName</span><br><span class="line">    ClaimName:  www-disk-web<span class="string">-0</span></span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME                                   STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-0</span>   Bound     pvc-a440540e<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   44m</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-1</span>   Bound     pvc-af5c7006<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   43m</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-2</span>   Bound     pvc<span class="string">-97</span>afce59<span class="string">-01</span>df<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   30m</span><br></pre></td></tr></tbody></table></figure><h2 id="éªŒè¯æœåŠ¡é«˜å¯ç”¨æ€§"><a href="#éªŒè¯æœåŠ¡é«˜å¯ç”¨æ€§" class="headerlink" title="éªŒè¯æœåŠ¡é«˜å¯ç”¨æ€§"></a>éªŒè¯æœåŠ¡é«˜å¯ç”¨æ€§</h2><h3 id="å…±äº«æŒä¹…å·ä¸­æ–°å»ºæ–‡ä»¶"><a href="#å…±äº«æŒä¹…å·ä¸­æ–°å»ºæ–‡ä»¶" class="headerlink" title="å…±äº«æŒä¹…å·ä¸­æ–°å»ºæ–‡ä»¶"></a>å…±äº«æŒä¹…å·ä¸­æ–°å»ºæ–‡ä»¶</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> web-1 <span class="built_in">ls</span> /usr/share/nginx/html</span></span><br><span class="line">statefulset</span><br></pre></td></tr></tbody></table></figure><h3 id="åˆ é™¤Podï¼ŒéªŒè¯æ•°æ®æŒä¹…æ€§ï¼š"><a href="#åˆ é™¤Podï¼ŒéªŒè¯æ•°æ®æŒä¹…æ€§ï¼š" class="headerlink" title="åˆ é™¤Podï¼ŒéªŒè¯æ•°æ®æŒä¹…æ€§ï¼š"></a>åˆ é™¤Podï¼ŒéªŒè¯æ•°æ®æŒä¹…æ€§ï¼š</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete pod web-1</span></span><br><span class="line">pod "web-1" deleted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¾…æ–°çš„podåˆ›å»ºä¹‹åå†æ¬¡æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿˜åœ¨</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> web-1 <span class="built_in">ls</span> /usr/share/nginx/html</span></span><br><span class="line">statefulset</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»¥ä¸Šè¯´æ˜åˆ é™¤podå¯¹pvcæ²¡æœ‰ä»»ä½•çš„å½±å“ï¼Œæˆ‘ä»¬çš„æ•°æ®è¿˜æ˜¯ä¿å­˜ç€çš„ã€‚</span></span><br></pre></td></tr></tbody></table></figure><h3 id="æ•°æ®ä¿å­˜"><a href="#æ•°æ®ä¿å­˜" class="headerlink" title="æ•°æ®ä¿å­˜:"></a>æ•°æ®ä¿å­˜:</h3><p>ä¸Šé¢ä¹Ÿè¯´å•¦, åˆ é™¤æˆ– scale StatefulSet å°†ä¸ä¼šåˆ é™¤ä¸ StatefulSet ç›¸å…³è”çš„ volumeã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œè¿™é€šå¸¸æ¯”è‡ªåŠ¨æ¸…é™¤æ‰€æœ‰ç›¸å…³ StatefulSet èµ„æºæ›´æœ‰ä»·å€¼ã€‚</p><p>æ‰€ä»¥æˆ‘åˆ°NFS Serverä¸Šé¢checkä¸€ä¸‹:<br><img src="/2018/12/14/kubernetes-statefulset/nfs.png"></p><p>å¯è§ æˆ‘ä»¬åœ¨pod/web-1ä¸Šåˆ›å»ºçš„æ–‡ä»¶è¿˜æ˜¯ä¿å­˜ç€çš„ã€‚</p><h3 id="é™„"><a href="#é™„" class="headerlink" title="é™„:"></a>é™„:</h3><p>è¯¥yamlä¸ºåä¸ºäº‘é‚£è¾¹çš„PVç”³è¯·ï¼Œä»¥åŠStatefulSetåº”ç”¨çš„åˆ›å»º</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># PVCå­˜å‚¨ç”³è¯·</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-evs-auto-example</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">volume.beta.kubernetes.io/storage-class:</span> <span class="string">sata</span></span><br><span class="line">    <span class="attr">volume.beta.kubernetes.io/storage-provisioner:</span> <span class="string">flexvolume-huawei.com/fuxivol</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">failure-domain.beta.kubernetes.io/region:</span> <span class="string">cn-north-1</span></span><br><span class="line">    <span class="attr">failure-domain.beta.kubernetes.io/zone:</span> <span class="string">cn-north-1a</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># StatefulSetåº”ç”¨åˆ›å»º</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cce21days-app11-guomaoqiu</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">cce21days-app11-guomaoqiu</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span>  </span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">cce21days-app11-guomaoqiu</span></span><br><span class="line">      <span class="attr">failure-domain.beta.kubernetes.io/region:</span> <span class="string">cn-north-1</span></span><br><span class="line">      <span class="attr">failure-domain.beta.kubernetes.io/zone:</span> <span class="string">cn-north-1a</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">cce21days-app11-guomaoqiu</span></span><br><span class="line">        <span class="attr">failure-domain.beta.kubernetes.io/region:</span> <span class="string">cn-north-1</span></span><br><span class="line">        <span class="attr">failure-domain.beta.kubernetes.io/zone:</span> <span class="string">cn-north-1a</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> {}</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="number">100.125</span><span class="number">.0</span><span class="number">.198</span><span class="string">:20202/guomaoqiu/tank:1.0.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">container-0</span></span><br><span class="line">        <span class="attr">resources:</span> {}</span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">pvc-evs-example</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> {}</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pvc-evs-example</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">pvc-evs-auto-example</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> StatefulSet </tag>
            
            <tag> æœ‰çŠ¶æ€ </tag>
            
            <tag> æŒä¹…åŒ–å­˜å‚¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç®¡ç†Kubernetesæ—¥å¿—</title>
      <link href="/2018/12/13/kubernetes-logs/"/>
      <url>/2018/12/13/kubernetes-logs/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>æ—¥å¿—æ˜¯æˆ‘ä»¬åœ¨è¿ç»´éƒ¨ç½²å½“ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªä¸œè¥¿ï¼Œå¯¹äºæˆ‘ä¸ªäººå·¥ä½œç»éªŒè€Œè¨€ï¼Œä¸€èˆ¬å‡ºç°é—®é¢˜ï¼Œç¬¬ä¸€æ­¥äº‹æƒ…å°±æ˜¯æŸ¥çœ‹æ—¥å¿—ï¼Œå…¶æ¬¡æ˜¯æœåŠ¡å™¨èµ„æºæŸ¥çœ‹è¿™æ ·å»å®šä½é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨kubernetsé›†ç¾¤å½“ä¸­å‘¢ï¼Œæˆ‘ä¸»è¦ç»™å…¶åˆ†äº†ä¸¤ç§ç±»å‹:</p><ul><li>kubernetesç»„ä»¶æ—¥å¿—</li><li>è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—</li></ul><h2 id="kubernetesç»„ä»¶æ—¥å¿—"><a href="#kubernetesç»„ä»¶æ—¥å¿—" class="headerlink" title="kubernetesç»„ä»¶æ—¥å¿—"></a>kubernetesç»„ä»¶æ—¥å¿—</h2><p>æˆ‘ä»¬çŸ¥é“åœ¨kubernetesé›†ç¾¤æ˜¯æœ‰å¤šä¸ªç»„ä»¶ç»„æˆï¼ŒååŒä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªè¿è¡Œå®¹å™¨çš„ç¯å¢ƒã€‚å½“è¿è¡Œå½“ä¸­å‡ºç°é—®é¢˜ï¼Œä¹Ÿæ˜¯éœ€è¦æŸ¥çœ‹å¯¹åº”ç»„ä»¶çš„æ—¥å¿—ï¼Œè¿›è¡Œé—®é¢˜æ’æŸ¥ã€å¤„ç†ã€‚é‚£ä¹ˆå¸¸è§çš„æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight arcade"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/kube-apiserver.<span class="built_in">log</span></span><br><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/kube-proxy.<span class="built_in">log</span></span><br><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/kube-controller-manager.<span class="built_in">log</span></span><br><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/kube-scheduler.<span class="built_in">log</span></span><br><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/kubelet.<span class="built_in">log</span></span><br></pre></td></tr></tbody></table></figure><p>å½“ç„¶æ ¹æ®æ­å»ºé›†ç¾¤çš„æ–¹å¼ä¸åŒï¼Œæˆ‘ä»¬é…ç½®çš„æ—¥å¿—ç›®å½•ä¹Ÿä¸å°½ç›¸åŒï¼Œæ‰€ä»¥åªæ˜¯åˆ—ä¸¾ä¸€ä¸‹ï¼›<br>å¦‚æœç»„ä»¶çš„å®‰è£…æ–¹å¼ç”±systemdæ¥ç®¡ç†çš„è¯ æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ’é”™</p><figure class="highlight fortran"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u kubelet</span><br><span class="line">æˆ–</span><br><span class="line">systemctl <span class="keyword">status</span> kubelet -l</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœä½¿ç”¨çš„æ˜¯kuernetesæ’ä»¶å¼æ–¹å¼éƒ¨ç½²çš„ç»„ä»¶åˆ™ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -f <span class="tag">&lt;<span class="name">ç»„ä»¶åç§°</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—"><a href="#è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—" class="headerlink" title="è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—"></a>è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—</h2><p>è¿è¡Œäºkubernetesä¸Šçš„ï¼Œæ¯”å¦‚ä¸€ä¸ªnginxå®¹å™¨ï¼›æˆ‘ä»¬å¦‚ä½•æŸ¥çœ‹è¿™ä¸ªåº”ç”¨çš„æ—¥å¿—å‘¢ï¼Ÿ</p><h3 id="ä»å®¹å™¨æ ‡å‡†è¾“å‡ºæˆªè·"><a href="#ä»å®¹å™¨æ ‡å‡†è¾“å‡ºæˆªè·" class="headerlink" title="ä»å®¹å™¨æ ‡å‡†è¾“å‡ºæˆªè·"></a>ä»å®¹å™¨æ ‡å‡†è¾“å‡ºæˆªè·</h3><p>ç”¨æ³•ç±»ä¼¼äºdocker</p><figure class="highlight dust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">kubectl logs -f </span><span class="template-variable">{POD_NAME}</span><span class="language-xml"> -c </span><span class="template-variable">{Container_NAME}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="è¿›å…¥å®¹å™¨è¿›è¡ŒæŸ¥çœ‹"><a href="#è¿›å…¥å®¹å™¨è¿›è¡ŒæŸ¥çœ‹" class="headerlink" title="è¿›å…¥å®¹å™¨è¿›è¡ŒæŸ¥çœ‹"></a>è¿›å…¥å®¹å™¨è¿›è¡ŒæŸ¥çœ‹</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it {POD_NAME} -c {Container_NAME} /bin/sh</span><br><span class="line">docker <span class="built_in">exec</span> -it {Container_NAME} /bin/sh</span><br></pre></td></tr></tbody></table></figure><h3 id="å°†æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°ä¸»æœºç›®å½•"><a href="#å°†æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°ä¸»æœºç›®å½•" class="headerlink" title="å°†æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°ä¸»æœºç›®å½•"></a>å°†æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°ä¸»æœºç›®å½•</h3><p>æ¯”å¦‚æˆ‘è¦æŠŠnginxçš„æ—¥å¿—æŒ‚è½½åˆ°è¿è¡Œäºè¯¥PODçš„å®¿ä¸»æœºçš„æŸä¸ªç›®å½•</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–å†™yamlæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># è¿™é‡Œæˆ‘ä»¬çŸ¥é“æ‰‹å†™ä¸€ä¸ªyamlæ˜¯å¾ˆçƒ¦çš„ï¼Œè€Œä¸”é‚£ä¹ˆå¤šå…³é”®è¯ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“è®°ä½ï¼Œ</span></span><br><span class="line"><span class="comment"># é‚£ä¹ˆæ­¤æ—¶å°±éœ€è¦åœ¨ç°æœ‰ç¯å¢ƒä¸­æ‰¾ä¸€ä¸ªpodç„¶åæŠŠä»–çš„yamlå¯¼å‡ºå†åšä¿®æ”¹</span></span><br><span class="line"><span class="comment"># å¦‚æœç¯å¢ƒä¸­è¿˜æ˜¯æ²¡æœ‰podï¼Œé‚£å°±ç›´æ¥runä¸€ä¸ª</span></span><br><span class="line"></span><br><span class="line">$ kubectl get pod nginx-<span class="number">67</span>ccc95d8c-fd5nk <span class="operator">-</span>o yaml <span class="operator">-</span>-export <span class="operator">&gt;</span> nginx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ä¸€äº›ä¸å¿…è¦çš„å­—æ®µ</span></span><br><span class="line">$ vim nginx.yaml </span><br><span class="line"></span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nginx</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">run:</span> nginx</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">image:</span> nginx:latest</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">name:</span> nginx</span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/var/log/nginx</span>  <span class="comment"># nginxåº”ç”¨é»˜è®¤æ—¥å¿—ç›®å½•</span></span><br><span class="line">      <span class="params">name:</span> nginx-log-volume     </span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> nginx-log-volume</span><br><span class="line">    <span class="params">hostPath:</span></span><br><span class="line">      <span class="params">path:</span> <span class="symbol">/var/k8s/log</span>         <span class="comment"># å®¿ä¸»æœºç›®å½•</span></span><br><span class="line">      </span><br><span class="line">$ kubectl create <span class="operator">-</span>f nginx.yaml</span><br><span class="line">pod <span class="string">"nginx"</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å®¿ä¸»æœºï¼Œè¿™æ ·å®¹å™¨çš„æ—¥å¿—ç›®å½•æˆ‘å°±æŒ‚åˆ°äº†å®¿ä¸»</span></span><br><span class="line"><span class="comment"># è€Œä¸ç”¨åœ¨è¿›å…¥å®¹å™¨ä¸­æŸ¥çœ‹äº†</span></span><br><span class="line">$ ll <span class="operator">/</span>var<span class="operator">/</span>k8s<span class="operator">/</span>log<span class="symbol">/</span> </span><br><span class="line">total <span class="number">0</span></span><br><span class="line"><span class="operator">-</span>rw-r----- <span class="number">1</span> root root <span class="number">0</span> Dec <span class="number">18</span> <span class="number">15</span>:<span class="number">17</span> access.log</span><br><span class="line"><span class="operator">-</span>rw-r----- <span class="number">1</span> root root <span class="number">0</span> Dec <span class="number">18</span> <span class="number">15</span>:<span class="number">17</span> error.log</span><br></pre></td></tr></tbody></table></figure><p>æ³¨æ„ç‚¹: å†™yamlçš„æ—¶å€™ä¸€å®šè¦å…»æˆå¯¼å‡ºç°æœ‰èµ„æºç±»å‹çš„yamlçš„ä¹ æƒ¯å†å»ä¿®æ”¹ï¼›è¿™æ ·èƒ½é¿å…æ‰‹åŠ¨ç¼–å†™æ—¶æ ¼å¼çš„ä¸€äº›é—®é¢˜ï¼Œå¦‚æœå…³é”®å­—è®°ä¸ä½é‚£å°±ä¸€å®šè¦ç”¨<code>kubectl explain</code>è·å–èµ„æºæ–‡æ¡£</p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> log </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç†è§£kubernetesä¸­Podè®¿é—®æ–¹å¼</title>
      <link href="/2018/12/12/kubernetes_pod_access/"/>
      <url>/2018/12/12/kubernetes_pod_access/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>Podçš„IPæ˜¯åœ¨docker0ç½‘æ®µåŠ¨æ€åˆ†é…çš„ï¼Œå½“å‘ç”Ÿé‡å¯ï¼Œæ‰©å®¹ç­‰æ“ä½œæ—¶ï¼ŒIPåœ°å€ä¼šéšä¹‹å˜åŒ–ã€‚å½“æŸä¸ªPod(frontend)éœ€è¦å»è®¿é—®å…¶ä¾èµ–çš„å¦å¤–ä¸€ç»„Pod(backend)æ—¶ï¼Œå¦‚æœbackendçš„IPå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¦‚ä½•ä¿è¯frontedåˆ°backendçš„æ­£å¸¸é€šä¿¡å˜çš„éå¸¸é‡è¦ã€‚ç”±æ­¤ï¼Œå¼•å‡ºäº†Serviceçš„æ¦‚å¿µã€‚<br>è¿™é‡Œdocker0æ˜¯ä¸€ä¸ªç½‘æ¡¥ï¼Œdocker daemonå¯åŠ¨containeræ—¶ä¼šæ ¹æ®docker0çš„ç½‘æ®µæ¥åˆ’ç²‰containerçš„IPåœ°å€Dockerç½‘ç»œ<br>åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯¹Serviceçš„è®¿é—®å¯èƒ½ä¼šæœ‰ä¸¤ç§æ¥æºï¼šKubernetesé›†ç¾¤å†…éƒ¨çš„ç¨‹åºï¼ˆPodï¼‰å’ŒKubernetesé›†ç¾¤å¤–éƒ¨ï¼Œä¸ºäº†æ»¡è¶³ä¸Šè¿°çš„åœºæ™¯ï¼ŒKubernetes serviceæœ‰ä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š</p><ul><li>ClusterIP:æä¾›ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„è™šæ‹ŸIPä»¥ä¾›Podè®¿é—®ã€‚</li><li>NodePort:åœ¨æ¯ä¸ªNodeä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£ä»¥ä¾›å¤–éƒ¨è®¿é—®ã€‚</li><li>LoadBalancer:é€šè¿‡å¤–éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨æ¥è®¿é—®ã€‚</li></ul><p>é‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œé€šè¿‡ä¸‹é¢çš„ç¤ºä¾‹æ¥ç†è§£ã€‚(åˆ›å»ºæ–¹å¼å¯ä»¥æ˜¯é€šè¿‡yamlæ–‡ä»¶æˆ–è€…æ˜¯å‘½ä»¤è¡Œæ–¹å¼ï¼Œè¿™é‡Œä¸ºäº†ç†è§£æˆ‘å…ˆç”¨å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºï¼Œå¦‚æœä¸åˆé€‚çš„åœ°æ–¹æˆ‘ä»¬é€šè¿‡<code>kubectl edit (RESOURCE/NAME | -f FILENAME) [options]</code>è¿™ç§æ–¹å¼å…ˆä¿®æ”¹)</p><p>å…¶æ¬¡ï¼Œè¿˜éœ€è¦ç†è§£<code>NodePort</code>,<code>TargetPort</code>ä»¥åŠ<code>port</code>ä»–ä»¬çš„åŒºåˆ«:<br><strong>NodePort</strong><br>å¤–éƒ¨æœºå™¨å¯è®¿é—®çš„ç«¯å£ã€‚<br>æ¯”å¦‚ä¸€ä¸ªWebåº”ç”¨éœ€è¦è¢«å…¶ä»–ç”¨æˆ·è®¿é—®ï¼Œé‚£ä¹ˆéœ€è¦é…ç½®type=NodePortï¼Œè€Œä¸”é…ç½®nodePort=30001ï¼Œé‚£ä¹ˆå…¶ä»–æœºå™¨å°±å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®scheme://node:30001è®¿é—®åˆ°è¯¥æœåŠ¡ï¼Œä¾‹å¦‚<a href="http://node:30001ã€‚">http://node:30001ã€‚</a><br>ä¾‹å¦‚MySQLæ•°æ®åº“å¯èƒ½ä¸éœ€è¦è¢«å¤–ç•Œè®¿é—®ï¼Œåªéœ€è¢«å†…éƒ¨æœåŠ¡è®¿é—®ï¼Œé‚£ä¹ˆä¸å¿…è®¾ç½®NodePort</p><p><strong>TargetPort</strong><br>å®¹å™¨çš„ç«¯å£ï¼ˆæœ€æ ¹æœ¬çš„ç«¯å£å…¥å£ï¼‰ï¼Œä¸åˆ¶ä½œå®¹å™¨æ—¶æš´éœ²çš„ç«¯å£ä¸€è‡´ï¼ˆDockerFileä¸­EXPOSEï¼‰ï¼Œä¾‹å¦‚docker.ioå®˜æ–¹çš„nginxæš´éœ²çš„æ˜¯80ç«¯å£ã€‚<br>docker.ioå®˜æ–¹çš„nginxå®¹å™¨çš„DockerFileå‚è€ƒ<a href="https://github.com/nginxinc/docker-nginx">https://github.com/nginxinc/docker-nginx</a></p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line"> <span class="params">name:</span> nginx-service</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line"> <span class="params">type:</span> NodePort         <span class="comment"># æœ‰é…ç½®NodePortï¼Œå¤–éƒ¨æµé‡å¯è®¿é—®k8sä¸­çš„æœåŠ¡</span></span><br><span class="line"> <span class="params">ports:</span></span><br><span class="line"> <span class="operator">-</span> <span class="params">port:</span> <span class="number">30080</span>          <span class="comment"># æœåŠ¡è®¿é—®ç«¯å£</span></span><br><span class="line">   <span class="params">targetPort:</span> <span class="number">80</span>       <span class="comment"># å®¹å™¨ç«¯å£</span></span><br><span class="line">   <span class="params">nodePort:</span> <span class="number">30001</span>      <span class="comment"># NodePort</span></span><br><span class="line"> <span class="params">selector:</span></span><br><span class="line">  <span class="params">name:</span> nginx-pod</span><br></pre></td></tr></tbody></table></figure><p>ã€€</p><p><strong>port</strong><br>ã€€kubernetesä¸­çš„æœåŠ¡ä¹‹é—´è®¿é—®çš„ç«¯å£ï¼Œå°½ç®¡mysqlå®¹å™¨æš´éœ²äº†3306ç«¯å£ï¼ˆå‚è€ƒ<a href="">https://github.com/docker-library/mysql/</a>çš„DockerFileï¼‰ï¼Œä½†æ˜¯é›†ç¾¤å†…å…¶ä»–å®¹å™¨éœ€è¦é€šè¿‡33306ç«¯å£è®¿é—®è¯¥æœåŠ¡ï¼Œå¤–éƒ¨æœºå™¨ä¸èƒ½è®¿é—®mysqlæœåŠ¡ï¼Œå› ä¸ºä»–æ²¡æœ‰é…ç½®NodePortç±»å‹</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">mysql-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">ports:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">33306</span></span><br><span class="line">   <span class="attr">targetPort:</span> <span class="number">3306</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pod</span></span><br></pre></td></tr></tbody></table></figure><h1 id="ä¸€ã€Create-service-type-ClusterIP"><a href="#ä¸€ã€Create-service-type-ClusterIP" class="headerlink" title="ä¸€ã€Create service (type: ClusterIP)"></a>ä¸€ã€Create service (type: ClusterIP)</h1><p>æ­¤æ¨¡å¼ä¼šæä¾›ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„è™šæ‹ŸIPï¼ˆä¸Podä¸åœ¨åŒä¸€ç½‘æ®µ)ï¼Œä»¥ä¾›é›†ç¾¤å†…éƒ¨çš„podä¹‹é—´é€šä¿¡ä½¿ç”¨ã€‚<br>ClusterIPä¹Ÿæ˜¯Kubernetes serviceçš„é»˜è®¤ç±»å‹ã€‚</p><p>ä¸ºäº†å®ç°å›¾ä¸Šçš„åŠŸèƒ½ä¸»è¦éœ€è¦ä»¥ä¸‹å‡ ä¸ªç»„ä»¶çš„ååŒå·¥ä½œ</p><p>apiserver ç”¨æˆ·é€šè¿‡kubectlå‘½ä»¤å‘apiserverå‘é€åˆ›å»ºserviceçš„å‘½ä»¤ï¼Œapiserveræ¥æ”¶åˆ°è¯·æ±‚ä»¥åå°†æ•°æ®å­˜å‚¨åˆ°etcdä¸­ã€‚</p><p>kube-proxy kubernetesçš„æ¯ä¸ªèŠ‚ç‚¹ä¸­éƒ½æœ‰ä¸€ä¸ªå«åškube-proxyçš„è¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹è´Ÿè´£æ„ŸçŸ¥serviceï¼Œpodçš„å˜åŒ–ï¼Œå¹¶å°†å˜åŒ–çš„ä¿¡æ¯å†™å…¥æœ¬åœ°çš„iptablesä¸­ã€‚</p><p>iptables ä½¿ç”¨NATç­‰æŠ€æœ¯å°†virtualIPçš„æµé‡è½¬è‡³endpointä¸­ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å®é™…å‘å¸ƒä¸€ä¸ªServiceï¼Œèƒ½å¤Ÿæ›´æ¸…æ™°çš„äº†è§£åˆ°Serviceæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><h3 id="1-é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºservice-ç±»å‹ä¸ºclusterip"><a href="#1-é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºservice-ç±»å‹ä¸ºclusterip" class="headerlink" title="1. é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºservice,ç±»å‹ä¸ºclusterip"></a>1. é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºservice,ç±»å‹ä¸ºclusterip</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create service clusterip my-svc-cp <span class="operator">-</span>-tcp<span class="operator">=</span><span class="number">8080</span>:<span class="number">80</span></span><br><span class="line"></span><br><span class="line">$ kubectl describe service<span class="symbol">/my-svc-cp</span></span><br><span class="line"><span class="params">Name:</span>              my-svc-cp</span><br><span class="line"><span class="params">Namespace:</span>         default</span><br><span class="line"><span class="params">Labels:</span>            app<span class="operator">=</span>my-svc-cp</span><br><span class="line"><span class="params">Annotations:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Selector:</span>          app<span class="operator">=</span>my-svc-cp</span><br><span class="line"><span class="params">Type:</span>              ClusterIP          <span class="comment"># ç±»å‹</span></span><br><span class="line"><span class="params">IP:</span>                <span class="number">10.247</span>.<span class="number">52.210</span></span><br><span class="line"><span class="params">Port:</span>              <span class="number">8</span>0-<span class="number">8080</span>  <span class="number">8080</span><span class="symbol">/TCP</span>  <span class="comment"># æ˜ å°„åˆ°é›†ç¾¤çš„ç«¯å£</span></span><br><span class="line"><span class="params">TargetPort:</span>        <span class="number">80</span><span class="symbol">/TCP</span>             <span class="comment"># ç›®æ ‡podæš´éœ²ç«¯å£</span></span><br><span class="line"><span class="params">Endpoints:</span>         <span class="symbol">&lt;none&gt;</span>             <span class="comment"># æ­¤æ—¶è¿˜æ²¡æœ‰åç«¯å®¹å™¨</span></span><br><span class="line">Session <span class="params">Affinity:</span>  None</span><br><span class="line"><span class="params">Events:</span>            <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">$ kubectl get svc <span class="operator">-</span>o wide</span><br><span class="line">my-svc-cp      ClusterIP   <span class="number">10.247</span>.<span class="number">52.210</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">80</span><span class="symbol">/TCP</span>    <span class="number">6</span>s        app<span class="operator">=</span>my-svc-cp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸Šæˆ‘åˆ›å»ºäº†ä¸€ä¸ªsvc, é‚£ä¹ˆä»–æ˜¯ä¸ºpodæœåŠ¡çš„,</span></span><br><span class="line"><span class="comment"># é‚£ä¹ˆ podè·Ÿserviceæ˜¯é€šè¿‡`selector label`æ¥åšå…³è”çš„, æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å¯¹è¿™ä¸ªsvcåšä¸‹è°ƒæ•´</span></span><br><span class="line"></span><br><span class="line">$ kubectl edit svc my-svc-cp</span><br><span class="line"><span class="comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span></span><br><span class="line"><span class="comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span></span><br><span class="line"><span class="comment"># reopened with the relevant failures.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="number">201</span>8-<span class="number">1</span>2-<span class="number">12</span>T17:<span class="number">41</span>:<span class="number">54</span>Z</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> my-svc-cp</span><br><span class="line">  <span class="params">name:</span> my-svc-cp</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line">  <span class="params">resourceVersion:</span> <span class="string">"32742"</span></span><br><span class="line">  <span class="params">selfLink:</span> <span class="symbol">/api/v1/namespaces/default/services/my-svc-cp</span></span><br><span class="line">  <span class="params">uid:</span> <span class="number">372</span>f6f2c-fe35-<span class="number">11</span>e8-b967-fa163e874e90</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">clusterIP:</span> <span class="number">10.247</span>.<span class="number">52.210</span></span><br><span class="line">  <span class="params">ports:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> <span class="number">8</span>0-<span class="number">8080</span></span><br><span class="line">    <span class="params">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="params">protocol:</span> TCP</span><br><span class="line">    <span class="params">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="params">selector:</span></span><br><span class="line">    <span class="params">app:</span> my-svc-cp-pod  <span class="comment"># è¿™é‡Œæˆ‘ä¿®æ”¹äº†selector ï¼Œéœ€è¦ä¸pod nameä¸ä¹‹å¯¹åº”èµ·æ¥</span></span><br><span class="line">  <span class="params">sessionAffinity:</span> None</span><br><span class="line">  <span class="params">type:</span> ClusterIP</span><br><span class="line"><span class="params">status:</span></span><br><span class="line">  <span class="params">loadBalancer:</span> {}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># :wq ä¿å­˜é€€å‡º</span></span><br><span class="line"><span class="comment"># kubectl describe service/my-svc-cp æŸ¥çœ‹ä¿®æ”¹æ˜¯å¦æˆåŠŸ</span></span><br></pre></td></tr></tbody></table></figure><h2 id="2-åˆ›å»ºpod"><a href="#2-åˆ›å»ºpod" class="headerlink" title="2.åˆ›å»ºpod"></a>2.åˆ›å»ºpod</h2><p>æ³¨æ„<code>selector label</code></p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">$ vim my-svc-cp-pod.yaml</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> my-svc-cp-pod</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> my-svc-cp-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">image:</span> nginx:latest</span><br><span class="line">    <span class="params">imagePullPolicy:</span> Always</span><br><span class="line">    <span class="params">name:</span> nginx</span><br><span class="line">  <span class="comment"># æ³¨æ„è¿™é‡Œçš„äº²å’Œæ€§æ˜¯ä¸ºäº†å°†podè°ƒåº¦è‡³æœ‰å¤–ç½‘çš„nodeèŠ‚ç‚¹ä¾¿äºpullé•œåƒ</span></span><br><span class="line">  <span class="params">affinity:</span></span><br><span class="line">    <span class="params">nodeAffinity:</span></span><br><span class="line">      <span class="params">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="params">nodeSelectorTerms:</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">matchExpressions:</span></span><br><span class="line">              <span class="operator">-</span> <span class="params">key:</span> kubernetes.io<span class="symbol">/hostname</span></span><br><span class="line">                <span class="params">operator:</span> In</span><br><span class="line">                <span class="params">values:</span></span><br><span class="line">                  <span class="operator">-</span> <span class="number">192.168</span>.<span class="number">253.183</span></span><br><span class="line">  <span class="params">restartPolicy:</span> Always</span><br><span class="line">  <span class="params">schedulerName:</span> default-scheduler</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œ:</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f my-svc-cp-pod.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl get pods,svc,endpoints,deployment <span class="operator">-</span>o wide</span><br><span class="line">NAME               READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">po<span class="symbol">/my-svc-cp-pod</span>   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">36</span>m       <span class="number">172.16</span>.<span class="number">0.36</span>   <span class="number">192.168</span>.<span class="number">253.183</span></span><br><span class="line"></span><br><span class="line">NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   SELECTOR</span><br><span class="line">svc<span class="symbol">/kubernetes</span>   ClusterIP   <span class="number">10.247</span>.<span class="number">0.1</span>      <span class="symbol">&lt;none&gt;</span>        <span class="number">443</span><span class="symbol">/TCP</span>    <span class="number">1</span>h    <span class="symbol">&lt;none&gt;</span></span><br><span class="line">svc<span class="symbol">/my-svc-cp</span>    ClusterIP   <span class="number">10.247</span>.<span class="number">52.210</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">8080</span><span class="symbol">/TCP</span>   <span class="number">3</span>m    app<span class="operator">=</span>my-svc-cp-pod</span><br><span class="line"></span><br><span class="line">NAME            ENDPOINTS                                                      AGE</span><br><span class="line">ep<span class="symbol">/kubernetes</span>   <span class="number">192.168</span>.<span class="number">103.50</span>:<span class="number">5444</span>,<span class="number">192.168</span>.<span class="number">174.46</span>:<span class="number">5444</span>,<span class="number">192.168</span>.<span class="number">236.124</span>:<span class="number">5444</span>   <span class="number">1</span>h</span><br><span class="line">ep<span class="symbol">/my-svc-cp</span>    <span class="number">172.16</span>.<span class="number">0.36</span>:<span class="number">80</span>                                                 <span class="number">3</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†æ¬¡æŸ¥çœ‹serviceæ˜¯å¦å…³è”åˆ°äº†pod</span></span><br><span class="line">$ kubectl describe ep<span class="symbol">/my-svc-cp</span></span><br><span class="line"><span class="params">Name:</span>         my-svc-cp</span><br><span class="line"><span class="params">Namespace:</span>    default</span><br><span class="line"><span class="params">Labels:</span>       app<span class="operator">=</span>my-svc-cp</span><br><span class="line"><span class="params">Annotations:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Subsets:</span></span><br><span class="line">  <span class="params">Addresses:</span>          <span class="number">172.16</span>.<span class="number">0.36</span> <span class="comment"># å¯è§endpointsä¸­å·²ç»æœ‰äº†åç«¯çš„é‚£ä¸ªpod</span></span><br><span class="line">  <span class="params">NotReadyAddresses:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line">  <span class="params">Ports:</span></span><br><span class="line">    Name     Port  Protocol</span><br><span class="line">    <span class="operator">-</span>---     <span class="operator">-</span>---  <span class="operator">-</span>-------</span><br><span class="line">    <span class="number">8</span>0-<span class="number">8080</span>  <span class="number">80</span>    TCP</span><br><span class="line"></span><br><span class="line"><span class="params">Events:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤å†…éƒ¨é€šè¿‡Cluster IPè®¿é—®nginxæœåŠ¡</span></span><br><span class="line"><span class="comment"># æŒ‡å®šäº†ç«¯å£æ˜ å°„åˆ°Cluster IP</span></span><br><span class="line">$ curl <span class="operator">-</span>I <span class="number">10.247</span>.<span class="number">52.210</span>:<span class="number">8080</span></span><br><span class="line">HTTP<span class="symbol">/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="params">Server:</span> nginx<span class="symbol">/1.15.5</span></span><br><span class="line"><span class="params">Date:</span> Wed, <span class="number">12</span> Dec <span class="number">2018</span> <span class="number">17</span>:<span class="number">48</span>:<span class="number">56</span> GMT</span><br><span class="line"><span class="params">Content-Type:</span> text<span class="symbol">/html</span></span><br><span class="line"><span class="params">Content-Length:</span> <span class="number">612</span></span><br><span class="line"><span class="params">Last-Modified:</span> Tue, <span class="number">02</span> Oct <span class="number">2018</span> <span class="number">14</span>:<span class="number">49</span>:<span class="number">27</span> GMT</span><br><span class="line"><span class="params">Connection:</span> keep-alive</span><br><span class="line"><span class="params">ETag:</span> <span class="string">"5bb38577-264"</span></span><br><span class="line"><span class="params">Accept-Ranges:</span> bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤å†…éƒ¨é€šè¿‡POD IPè®¿é—®nginxæœåŠ¡</span></span><br><span class="line"><span class="comment"># å› ä¸ºpodæš´éœ²çš„æ˜¯80 é»˜è®¤ä¸ç”¨åŠ ç«¯å£</span></span><br><span class="line">$ curl <span class="operator">-</span>I <span class="number">172.16</span>.<span class="number">0.36</span></span><br><span class="line">HTTP<span class="symbol">/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="params">Server:</span> nginx<span class="symbol">/1.15.5</span></span><br><span class="line"><span class="params">Date:</span> Wed, <span class="number">12</span> Dec <span class="number">2018</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">52</span> GMT</span><br><span class="line"><span class="params">Content-Type:</span> text<span class="symbol">/html</span></span><br><span class="line"><span class="params">Content-Length:</span> <span class="number">612</span></span><br><span class="line"><span class="params">Last-Modified:</span> Tue, <span class="number">02</span> Oct <span class="number">2018</span> <span class="number">14</span>:<span class="number">49</span>:<span class="number">27</span> GMT</span><br><span class="line"><span class="params">Connection:</span> keep-alive</span><br><span class="line"><span class="params">ETag:</span> <span class="string">"5bb38577-264"</span></span><br><span class="line"><span class="params">Accept-Ranges:</span> bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡è¿™ç§æ–¹å¼ä¹Ÿåªæ˜¯é›†ç¾¤å†…éƒ¨èƒ½å¤Ÿè®¿é—®åˆ°ï¼Œå¦‚æœé›†ç¾¤å¤–éƒ¨è¦è®¿é—®æˆ‘ä»¬çš„podåˆè¯¥å¦‚ä½•åšå‘¢ï¼Ÿ</span></span><br><span class="line"><span class="comment"># ä¸‹é¢ç»§ç»­</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h1 id="äºŒã€Create-service-type-NodePort"><a href="#äºŒã€Create-service-type-NodePort" class="headerlink" title="äºŒã€Create service (type: NodePort)"></a>äºŒã€Create service (type: NodePort)</h1><h2 id="1-é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºservice-ç±»å‹ä¸ºnodeport"><a href="#1-é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºservice-ç±»å‹ä¸ºnodeport" class="headerlink" title="1.é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºservice,ç±»å‹ä¸ºnodeport"></a>1.é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºservice,ç±»å‹ä¸ºnodeport</h2><p>Cluster service çš„ IP åœ°å€æ˜¯è™šæ‹Ÿçš„ï¼Œå› æ­¤ï¼Œåªèƒ½ä»nodeèŠ‚ç‚¹ä¸Šä½¿ç”¨è¯¥IP åœ°å€è®¿é—®åº”ç”¨ã€‚ä¸ºäº†ä»é›†ç¾¤å¤–è®¿é—®åº”ç”¨ï¼ŒK8S æä¾›äº†ä½¿ç”¨ node èŠ‚ç‚¹çš„IP åœ°å€è®¿é—®åº”ç”¨çš„æ–¹å¼ã€‚</p><p>åŸºæœ¬ä¸Šï¼ŒNodePort æœåŠ¡ä¸æ™®é€šçš„ â€œClusterIPâ€ æœåŠ¡ YAML å®šä¹‰æœ‰ä¸¤ç‚¹åŒºåˆ«ã€‚ é¦–å…ˆï¼Œtype æ˜¯ â€œNodePortâ€ã€‚è¿˜æœ‰ä¸€ä¸ªç§°ä¸º nodePort çš„é™„åŠ ç«¯å£ï¼ŒæŒ‡å®šåœ¨èŠ‚ç‚¹ä¸Šæ‰“å¼€å“ªä¸ªç«¯å£ã€‚ å¦‚æœä½ ä¸æŒ‡å®šè¿™ä¸ªç«¯å£ï¼Œå®ƒä¼šé€‰æ‹©ä¸€ä¸ªéšæœºç«¯å£ã€‚</p><p>ä¸‹å›¾ä¸­æ˜¯ 32591. è¯¥ç«¯å£å·çš„èŒƒå›´æ˜¯ kube-apiserver çš„å¯åŠ¨å‚æ•° â€“service-node-port-rangeæŒ‡å®šçš„ï¼Œåœ¨å½“å‰æµ‹è¯•ç¯å¢ƒä¸­å…¶å€¼æ˜¯ 30000-32767ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create service nodeport my-svc-np <span class="operator">-</span>-tcp<span class="operator">=</span><span class="number">8080</span>:<span class="number">80</span></span><br><span class="line"></span><br><span class="line">[root@linux-node1 ~]<span class="comment"># kubectl describe service my-svc-np</span></span><br><span class="line"><span class="params">Name:</span>                     my-svc-np</span><br><span class="line"><span class="params">Namespace:</span>                default</span><br><span class="line"><span class="params">Labels:</span>                   app<span class="operator">=</span>my-svc-np</span><br><span class="line"><span class="params">Annotations:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Selector:</span>                 app<span class="operator">=</span>my-svc-np</span><br><span class="line"><span class="params">Type:</span>                     NodePort            <span class="comment"># ç±»å‹</span></span><br><span class="line"><span class="params">IP:</span>                       <span class="number">10.103</span>.<span class="number">115.169</span>      <span class="comment"># åˆ†é…çš„ClusterIP</span></span><br><span class="line"><span class="params">Port:</span>                     <span class="number">808</span>0-<span class="number">80</span>  <span class="number">8080</span><span class="symbol">/TCP</span>   <span class="comment"># å®¹å™¨æ˜ å°„åˆ°nodeèŠ‚ç‚¹çš„ç«¯å£</span></span><br><span class="line"><span class="params">TargetPort:</span>               <span class="number">80</span><span class="symbol">/TCP</span>              <span class="comment"># å®¹å™¨å°†è¦æš´éœ²çš„ç«¯å£</span></span><br><span class="line"><span class="params">NodePort:</span>                 <span class="number">808</span>0-<span class="number">80</span>  <span class="number">32591</span><span class="symbol">/TCP</span>  <span class="comment"># é™„åŠ ç«¯å£</span></span><br><span class="line"><span class="params">Endpoints:</span>                <span class="symbol">&lt;none&gt;</span>        <span class="comment"># æ­¤æ—¶åç«¯æ²¡æœ‰pod</span></span><br><span class="line">Session <span class="params">Affinity:</span>         None</span><br><span class="line">External Traffic <span class="params">Policy:</span>  Cluster</span><br><span class="line"><span class="params">Events:</span>                   <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ‰äº†svcæˆ‘ä»¬å°±éœ€è¦åˆ›å»ºä¸€ä¸ªæˆ–è€…ä¸€ç»„podæ¥è·Ÿè¿™ä¸ªsvcå»ºç«‹è¿æ¥</span></span><br><span class="line"><span class="comment"># åƒå‰é¢ä¸€æ ·æˆ‘ä»¬éœ€è¦æ›´æ”¹è¿™ä¸ªsvcçš„é€‰æ‹©å™¨ï¼š</span></span><br><span class="line">$ kubectl edit svc my-svc-np</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">  <span class="params">externalTrafficPolicy:</span> Cluster</span><br><span class="line">  <span class="params">ports:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> <span class="number">808</span>0-<span class="number">80</span></span><br><span class="line">    <span class="params">nodePort:</span> <span class="number">32591</span></span><br><span class="line">    <span class="params">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="params">protocol:</span> TCP</span><br><span class="line">    <span class="params">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="params">selector:</span></span><br><span class="line">    <span class="params">app:</span> my-svc-np-pod  <span class="comment"># ä¸å³å°†åˆ›å»ºçš„podå¯¹åº”ä¸Š</span></span><br><span class="line">  <span class="params">sessionAffinity:</span> None</span><br><span class="line">  <span class="params">type:</span> NodePort</span><br><span class="line"><span class="params">status:</span></span><br><span class="line">  <span class="params">loadBalancer:</span> {}</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="comment"># :wqä¿å­˜é€€å‡º</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="2-åˆ›å»ºpodä¸ä¹‹å»ºç«‹å…³ç³»"><a href="#2-åˆ›å»ºpodä¸ä¹‹å»ºç«‹å…³ç³»" class="headerlink" title="2.åˆ›å»ºpodä¸ä¹‹å»ºç«‹å…³ç³»"></a>2.åˆ›å»ºpodä¸ä¹‹å»ºç«‹å…³ç³»</h2><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æˆ‘è¿™é‡Œé€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºä¸€ä¸ªdeploymentçš„3ä¸ªå‰¯æœ¬çš„nginx pod</span></span><br><span class="line"><span class="comment"># 1. é¦–å…ˆé€šè¿‡å‘½ä»¤è¡Œç”Ÿæˆyamlæ–‡ä»¶</span></span><br><span class="line">$ kubectl run nginx-deployment <span class="operator">-</span>-image<span class="operator">=</span>nginx <span class="operator">-</span>-replicas<span class="operator">=</span><span class="number">3</span> <span class="operator">-</span>-dry-run <span class="operator">-</span>o yaml <span class="operator">&gt;</span> nginx-deployment.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. è¿›è¡Œè°ƒæ•´</span></span><br><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> nginx-deployment.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> apps<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> Deployment</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">run:</span> nginx-deployment</span><br><span class="line">  <span class="params">name:</span> nginx-deployment</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="params">selector:</span></span><br><span class="line">    <span class="params">matchLabels:</span></span><br><span class="line">      <span class="params">app:</span> my-svc-np-pod    <span class="comment"># æ­¤å¤„ä¿®æ”¹ä¸ºsvc selectorç›¸åŒ</span></span><br><span class="line">  <span class="params">strategy:</span> {}</span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">        <span class="params">app:</span> my-svc-np-pod    <span class="comment"># æ­¤å¤„ä¿®æ”¹ä¸ºsvc selectorç›¸åŒ</span></span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">image:</span> nginx</span><br><span class="line">        <span class="params">name:</span> nginx-deployment</span><br><span class="line">        <span class="params">resources:</span> {}</span><br><span class="line"><span class="params">status:</span> {}</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># 3. æ‰§è¡Œ</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f nginx-deployment.yaml</span><br><span class="line">deployment.apps<span class="symbol">/nginx-deployment</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æŸ¥çœ‹çŠ¶æ€:</span></span><br><span class="line">$ kubectl get pod <span class="operator">-</span>o wide</span><br><span class="line">NAME                                READY     STATUS    RESTARTS   AGE    IP            NODE      NOMINATED NODE</span><br><span class="line">nginx-deployment-<span class="number">6794</span>c779fb-<span class="number">8</span>x92g   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">4</span>m     <span class="number">10.244</span>.<span class="number">1.19</span>   k8s-m2    <span class="symbol">&lt;none&gt;</span></span><br><span class="line">nginx-deployment-<span class="number">6794</span>c779fb-rf8qj   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">4</span>m     <span class="number">10.244</span>.<span class="number">0.19</span>   k8s-m3    <span class="symbol">&lt;none&gt;</span></span><br><span class="line">nginx-deployment-<span class="number">6794</span>c779fb-tdscx   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">4</span>m     <span class="number">10.244</span>.<span class="number">2.35</span>   k8s-m1    <span class="symbol">&lt;none&gt;</span></span><br><span class="line">$ kubectl describe svc my-svc-np</span><br><span class="line"><span class="params">Name:</span>                     my-svc-np</span><br><span class="line"><span class="params">Namespace:</span>                default</span><br><span class="line"><span class="params">Labels:</span>                   app<span class="operator">=</span>my-svc-np</span><br><span class="line"><span class="params">Annotations:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Selector:</span>                 app<span class="operator">=</span>my-svc-np-pod</span><br><span class="line"><span class="params">Type:</span>                     NodePort</span><br><span class="line"><span class="params">IP:</span>                       <span class="number">10.103</span>.<span class="number">115.169</span></span><br><span class="line"><span class="params">Port:</span>                     <span class="number">808</span>0-<span class="number">80</span>  <span class="number">8080</span><span class="symbol">/TCP</span></span><br><span class="line"><span class="params">TargetPort:</span>               <span class="number">80</span><span class="symbol">/TCP</span></span><br><span class="line"><span class="params">NodePort:</span>                 <span class="number">808</span>0-<span class="number">80</span>  <span class="number">32591</span><span class="symbol">/TCP</span></span><br><span class="line"><span class="params">Endpoints:</span>                <span class="number">10.244</span>.<span class="number">0.19</span>:<span class="number">80</span>,<span class="number">10.244</span>.<span class="number">1.19</span>:<span class="number">80</span>,<span class="number">10.244</span>.<span class="number">2.35</span>:<span class="number">80</span>   <span class="comment"># å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ä¸‰ä¸ªendpoint</span></span><br><span class="line">Session <span class="params">Affinity:</span>         None</span><br><span class="line">External Traffic <span class="params">Policy:</span>  Cluster</span><br><span class="line"><span class="params">Events:</span>                   <span class="symbol">&lt;none&gt;</span></span><br><span class="line">$ kubectl get svc my-svc-np</span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">my-svc-np    NodePort    <span class="number">10.103</span>.<span class="number">115.169</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">8080</span>:<span class="number">32591</span><span class="symbol">/TCP</span>   <span class="number">42</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.å¦‚ä½•è®¿é—®?</span></span><br><span class="line"><span class="comment"># a.é›†ç¾¤å†…éƒ¨è®¿é—®pod ip</span></span><br><span class="line">$ curl <span class="operator">-</span>I <span class="number">10.244</span>.<span class="number">0.19</span></span><br><span class="line">HTTP<span class="symbol">/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="params">Server:</span> nginx<span class="symbol">/1.15.7</span></span><br><span class="line"><span class="params">Date:</span> Thu, <span class="number">13</span> Dec <span class="number">2018</span> <span class="number">08</span>:<span class="number">43</span>:<span class="number">25</span> GMT</span><br><span class="line"><span class="params">Content-Type:</span> text<span class="symbol">/html</span></span><br><span class="line"><span class="params">Content-Length:</span> <span class="number">612</span></span><br><span class="line"><span class="params">Last-Modified:</span> Tue, <span class="number">27</span> Nov <span class="number">2018</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">56</span> GMT</span><br><span class="line"><span class="params">Connection:</span> keep-alive</span><br><span class="line"><span class="params">ETag:</span> <span class="string">"5bfd393c-264"</span></span><br><span class="line"><span class="params">Accept-Ranges:</span> bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># b.é›†ç¾¤å†…éƒ¨clusterip+ç«¯å£</span></span><br><span class="line">$ curl <span class="operator">-</span>I <span class="number">10.103</span>.<span class="number">115.169</span>:<span class="number">8080</span></span><br><span class="line">HTTP<span class="symbol">/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="params">Server:</span> nginx<span class="symbol">/1.15.7</span></span><br><span class="line"><span class="params">Date:</span> Thu, <span class="number">13</span> Dec <span class="number">2018</span> <span class="number">08</span>:<span class="number">42</span>:<span class="number">53</span> GMT</span><br><span class="line"><span class="params">Content-Type:</span> text<span class="symbol">/html</span></span><br><span class="line"><span class="params">Content-Length:</span> <span class="number">612</span></span><br><span class="line"><span class="params">Last-Modified:</span> Tue, <span class="number">27</span> Nov <span class="number">2018</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">56</span> GMT</span><br><span class="line"><span class="params">Connection:</span> keep-alive</span><br><span class="line"><span class="params">ETag:</span> <span class="string">"5bfd393c-264"</span></span><br><span class="line"><span class="params">Accept-Ranges:</span> bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># c.é›†ç¾¤å¤–éƒ¨è®¿é—®nodeip+é™„åŠ ç«¯å£</span></span><br><span class="line">curl <span class="operator">-</span>I <span class="number">192.168</span>.<span class="number">56.111</span>:<span class="number">32591</span></span><br><span class="line">HTTP<span class="symbol">/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="params">Server:</span> nginx<span class="symbol">/1.15.7</span></span><br><span class="line"><span class="params">Date:</span> Thu, <span class="number">13</span> Dec <span class="number">2018</span> <span class="number">08</span>:<span class="number">45</span>:<span class="number">39</span> GMT</span><br><span class="line"><span class="params">Content-Type:</span> text<span class="symbol">/html</span></span><br><span class="line"><span class="params">Content-Length:</span> <span class="number">612</span></span><br><span class="line"><span class="params">Last-Modified:</span> Tue, <span class="number">27</span> Nov <span class="number">2018</span> <span class="number">12</span>:<span class="number">31</span>:<span class="number">56</span> GMT</span><br><span class="line"><span class="params">Connection:</span> keep-alive</span><br><span class="line"><span class="params">ETag:</span> <span class="string">"5bfd393c-264"</span></span><br><span class="line"><span class="params">Accept-Ranges:</span> bytes</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šå°±æ˜¯nodeportç½‘ç»œç±»å‹çš„ç®€å•å®ç°</p><h1 id="ä¸‰ã€Create-service-type-HeadlessClusterIP"><a href="#ä¸‰ã€Create-service-type-HeadlessClusterIP" class="headerlink" title="ä¸‰ã€Create service (type: HeadlessClusterIP)"></a>ä¸‰ã€Create service (type: HeadlessClusterIP)</h1><p>æ‰€è°“çš„HeadlessClusterIP å°±æ˜¯æˆ‘ä»¬åœ¨åˆ›å»ºè¿™ç§ç½‘ç»œç±»å‹çš„æ—¶å€™å°† spec.clusterIP è®¾ç½®æˆ None,è¿™æ ·k8så°±ä¸ä¼šç»™serviceåˆ†é…clusterIpäº†ã€‚ä½†æŒ‡å®šäº†selectorï¼Œé‚£ä¹ˆendpoints controllerè¿˜æ˜¯ä¼šåˆ›å»ºEndpointsçš„ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„DNSè®°å½•ç›´æ¥æŒ‡å‘è¿™ä¸ªserviceæè¿°çš„åç«¯podã€‚å¦åˆ™ï¼Œä¸ä¼šåˆ›å»ºEndpointsè®°å½•ã€‚è¿™ç§ClusterIPï¼Œkube-proxy å¹¶ä¸å¤„ç†æ­¤ç±»æœåŠ¡ï¼Œå› ä¸ºæ²¡æœ‰load balancingæˆ– proxy ä»£ç†è®¾ç½®ï¼Œåœ¨è®¿é—®æœåŠ¡çš„æ—¶å€™å›è¿”å›åç«¯çš„å…¨éƒ¨çš„Pods IPåœ°å€ï¼Œä¸»è¦ç”¨äºå¼€å‘è€…è‡ªå·±æ ¹æ®podsè¿›è¡Œè´Ÿè½½å‡è¡¡å™¨çš„å¼€å‘(è®¾ç½®äº†selector)ã€‚</p><p>ä¸‹é¢é€šè¿‡å®è·µç†è§£</p><h2 id="1-é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºsvc-ç±»å‹ä¸ºheadlessCluserIP"><a href="#1-é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºsvc-ç±»å‹ä¸ºheadlessCluserIP" class="headerlink" title="1.é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºsvc,ç±»å‹ä¸ºheadlessCluserIP"></a>1.é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºsvc,ç±»å‹ä¸ºheadlessCluserIP</h2><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create svc clusterip my-svc-headless <span class="operator">-</span>-clusterip<span class="operator">=</span><span class="string">"None"</span> <span class="operator">-</span>-tcp<span class="operator">=</span><span class="number">8080</span>:<span class="number">80</span></span><br><span class="line">service<span class="symbol">/my-svc-headless</span> created</span><br><span class="line"></span><br><span class="line">$ kubectl describe svc my-svc-headless</span><br><span class="line"><span class="params">Name:</span>              my-svc-headless</span><br><span class="line"><span class="params">Namespace:</span>         default</span><br><span class="line"><span class="params">Labels:</span>            app<span class="operator">=</span>my-svc-headless</span><br><span class="line"><span class="params">Annotations:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Selector:</span>          app<span class="operator">=</span>my-svc-headless</span><br><span class="line"><span class="params">Type:</span>              ClusterIP</span><br><span class="line"><span class="params">IP:</span>                None</span><br><span class="line">Session <span class="params">Affinity:</span>  None</span><br><span class="line"><span class="params">Events:</span>            <span class="symbol">&lt;none&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="2-åˆ›å»ºpodä¸ä¹‹å…³è”ï¼š"><a href="#2-åˆ›å»ºpodä¸ä¹‹å…³è”ï¼š" class="headerlink" title="2. åˆ›å»ºpodä¸ä¹‹å…³è”ï¼š"></a>2. åˆ›å»ºpodä¸ä¹‹å…³è”ï¼š</h2><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">$ cat nginx-deployment.yaml</span><br><span class="line"><span class="params">apiVersion:</span> apps<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> Deployment</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">run:</span> nginx-deployment</span><br><span class="line">  <span class="params">name:</span> nginx-deployment</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="params">selector:</span></span><br><span class="line">    <span class="params">matchLabels:</span></span><br><span class="line">      <span class="params">app:</span> my-svc-headless <span class="comment"># å¯¹åº”åˆ°svc</span></span><br><span class="line">  <span class="params">strategy:</span> {}</span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">        <span class="params">app:</span> my-svc-headless <span class="comment"># å¯¹åº”åˆ°svc</span></span><br><span class="line"></span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">image:</span> nginx</span><br><span class="line">        <span class="params">name:</span> nginx-deployment</span><br><span class="line">        <span class="params">resources:</span> {}</span><br><span class="line"><span class="params">status:</span> {}</span><br><span class="line"></span><br><span class="line">$ kubectl create <span class="operator">-</span>f nginx-deployment.yaml</span><br><span class="line">deployment.apps<span class="symbol">/nginx-deployment</span> created</span><br><span class="line"></span><br><span class="line">$ [root@k8s-m1 ~]<span class="comment"># kubectl get pod -o wide </span></span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   IP            NODE      NOMINATED NODE</span><br><span class="line">nginx-deployment-<span class="number">54</span>bfc79477-b78c6   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">40</span>s   <span class="number">10.244</span>.<span class="number">1.21</span>   k8s-m2    <span class="symbol">&lt;none&gt;</span></span><br><span class="line">nginx-deployment-<span class="number">54</span>bfc79477-dvp2t   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">40</span>s   <span class="number">10.244</span>.<span class="number">0.22</span>   k8s-m3    <span class="symbol">&lt;none&gt;</span></span><br><span class="line">nginx-deployment-<span class="number">54</span>bfc79477-x6v7s   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">40</span>s   <span class="number">10.244</span>.<span class="number">2.38</span>   k8s-m1    <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl describe svc my-svc-headless</span><br><span class="line"><span class="params">Name:</span>              my-svc-headless</span><br><span class="line"><span class="params">Namespace:</span>         default</span><br><span class="line"><span class="params">Labels:</span>            app<span class="operator">=</span>my-svc-headless</span><br><span class="line"><span class="params">Annotations:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Selector:</span>          app<span class="operator">=</span>my-svc-headless</span><br><span class="line"><span class="params">Type:</span>              ClusterIP</span><br><span class="line"><span class="params">IP:</span>                None</span><br><span class="line"><span class="params">Port:</span>              <span class="number">808</span>0-<span class="number">80</span>  <span class="number">8080</span><span class="symbol">/TCP</span></span><br><span class="line"><span class="params">TargetPort:</span>        <span class="number">80</span><span class="symbol">/TCP</span></span><br><span class="line"><span class="params">Endpoints:</span>         <span class="number">10.244</span>.<span class="number">0.20</span>:<span class="number">80</span>,<span class="number">10.244</span>.<span class="number">1.20</span>:<span class="number">80</span>,<span class="number">10.244</span>.<span class="number">2.36</span>:<span class="number">80</span></span><br><span class="line">Session <span class="params">Affinity:</span>  None</span><br><span class="line"><span class="params">Events:</span>            <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸Šå¯ä»¥çœ‹å‡ºåç«¯çš„podåˆ—è¡¨å·²ç»åŠ åˆ°è¯¥svc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ‘ä»¬çœ‹é€šè¿‡å†…éƒ¨åŸŸåæ˜¯å¦èƒ½å¤Ÿè§£æè®¿é—®åˆ°pod</span></span><br><span class="line"><span class="comment"># 1.æˆ‘ä»¬å…ˆè·å–åˆ°dnsæœåŠ¡çš„IP</span></span><br><span class="line"><span class="comment">#kubectl get svc -n kube-system | grep dns</span></span><br><span class="line">kube-dns               ClusterIP   <span class="number">10.96</span>.<span class="number">0.10</span>    <span class="symbol">&lt;none&gt;</span>    <span class="number">53</span><span class="operator">/</span>UDP,<span class="number">53</span><span class="symbol">/TCP</span>   <span class="number">13</span>d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.ç™»å½•åˆ°pod å†…éƒ¨è·å–dnsåŸŸ</span></span><br><span class="line">$ kubectl exec <span class="operator">-</span>it nginx-deployment-<span class="number">54</span>bfc79477-b78c6 <span class="operator">-</span>- cat <span class="symbol">/etc/resolv.conf</span></span><br><span class="line">nameserver <span class="number">10.96</span>.<span class="number">0.10</span></span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:<span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æŒ‡å®šdnsæœåŠ¡å™¨å¹¶æŸ¥è¯¢è¯¥åŸŸåï¼š`nginx-deployment.default.svc.cluster.local`</span></span><br><span class="line">$ dig @<span class="number">10.96</span>.<span class="number">0.10</span> my-svc-headless.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">; <span class="operator">&lt;</span><span class="operator">&lt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span> DiG <span class="number">9.9</span>.<span class="number">4</span><span class="operator">-</span>RedHat-<span class="number">9.9</span>.<span class="number">4</span><span class="operator">-</span><span class="number">72</span>.el7 <span class="operator">&lt;</span><span class="operator">&lt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span> @<span class="number">10.96</span>.<span class="number">0.10</span> my-svc-headless.default.svc.cluster.local</span><br><span class="line">; (<span class="number">1</span> server found)</span><br><span class="line">;; global <span class="params">options:</span> <span class="operator">+</span>cmd</span><br><span class="line">;; Got <span class="params">answer:</span></span><br><span class="line">;; <span class="operator">-&gt;</span><span class="operator">&gt;</span>HEADER<span class="operator">&lt;</span><span class="operator">&lt;</span><span class="operator">-</span> <span class="params">opcode:</span> QUERY, <span class="params">status:</span> NOERROR, <span class="params">id:</span> <span class="number">41743</span></span><br><span class="line">;; <span class="params">flags:</span> qr aa rd ra; <span class="params">QUERY:</span> <span class="number">1</span>, <span class="params">ANSWER:</span> <span class="number">3</span>, <span class="params">AUTHORITY:</span> <span class="number">0</span>, <span class="params">ADDITIONAL:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">;; QUESTION <span class="params">SECTION:</span></span><br><span class="line">;my-svc-headless.default.svc.cluster.local. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER <span class="params">SECTION:</span></span><br><span class="line">my-svc-headless.default.svc.cluster.local. <span class="number">30</span> IN A <span class="number">10.244</span>.<span class="number">0.22</span></span><br><span class="line">my-svc-headless.default.svc.cluster.local. <span class="number">30</span> IN A <span class="number">10.244</span>.<span class="number">1.21</span></span><br><span class="line">my-svc-headless.default.svc.cluster.local. <span class="number">30</span> IN A <span class="number">10.244</span>.<span class="number">2.38</span></span><br><span class="line"></span><br><span class="line">;; Query <span class="params">time:</span> <span class="number">29</span> msec</span><br><span class="line">;; <span class="params">SERVER:</span> <span class="number">10.96</span>.<span class="number">0.10</span><span class="comment">#53(10.96.0.10)</span></span><br><span class="line">;; <span class="params">WHEN:</span> Thu Dec <span class="number">13</span> <span class="number">04</span>:<span class="number">37</span>:<span class="number">13</span> EST <span class="number">2018</span></span><br><span class="line">;; MSG SIZE  <span class="params">rcvd:</span> <span class="number">107</span></span><br></pre></td></tr></tbody></table></figure><h5 id="ç”±ä¸Šå¯è§-dnsæœåŠ¡ä¸ºserviceå’Œpodç”Ÿæˆä¸åŒæ ¼å¼çš„DNSè®°å½•"><a href="#ç”±ä¸Šå¯è§-dnsæœåŠ¡ä¸ºserviceå’Œpodç”Ÿæˆä¸åŒæ ¼å¼çš„DNSè®°å½•" class="headerlink" title="ç”±ä¸Šå¯è§ dnsæœåŠ¡ä¸ºserviceå’Œpodç”Ÿæˆä¸åŒæ ¼å¼çš„DNSè®°å½•"></a>ç”±ä¸Šå¯è§ dnsæœåŠ¡ä¸ºserviceå’Œpodç”Ÿæˆä¸åŒæ ¼å¼çš„DNSè®°å½•</h5><h6 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h6><ul><li><p>Aè®°å½•ï¼šç”Ÿæˆmy-svc.my-namespace.svc.cluster.localåŸŸåï¼Œè§£ææˆ IP åœ°å€ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š<br> 1.æ™®é€š Serviceï¼šè§£ææˆ ClusterIP<br> 2.Headless Serviceï¼šè§£æä¸ºæŒ‡å®š Podçš„IPåˆ—è¡¨(ä¸Šè¿°ç¤ºä¾‹å°±æ˜¯headless)</p></li><li><p>SRVè®°å½•ï¼šä¸ºå‘½åçš„ç«¯å£ï¼ˆæ™®é€š Service æˆ– Headless Serviceï¼‰ç”Ÿæˆ<code>_my-port-name._my-port-protocol.my-svc.my-namespace.svc.cluster.local</code>çš„åŸŸå</p></li></ul><h6 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h6><ul><li>Aè®°å½•ï¼šç”ŸæˆåŸŸå <code>pod-ip.my-namespace.pod.cluster.local</code></li></ul><p>ä¸Šè¿°ç¤ºä¾‹ä¸ªäººç†è§£æ˜¯ è¿™ç§æ— å¤´ClusterIPç±»å‹ åœ¨å…¶é›†ç¾¤å†…éƒ¨ç›´æ¥å¯ä»¥é€šè¿‡è¯¥åŸŸåå»è®¿é—®podï¼Œ<br>å¹¶ä¸”è¯¥åŸŸåä¹Ÿèµ·åˆ°äº†é€šè¿‡dnsåšè´Ÿè½½çš„èƒ½åŠ›ã€‚</p><p>å…¶ä»–è®¿é—®æ³•æ–¹å¼å¯æŸ¥é˜…å®˜ç½‘å­¦ä¹ ,æ­¤ç¯‡åšæ–‡ä¸»è¦æ˜¯å†æ¬¡å­¦ä¹ å·©å›ºä¸€ä¸‹çŸ¥è¯†~<br>è¯¸å¦‚ingressè¿™ç§è®¿é—®æ–¹å¼ä¹‹å‰ä¹Ÿåœ¨å­¦ä¹ å®è·µè¿‡ç¨‹ä¸­å·²ç»å®ç°è¿‡äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥<a href="https://github.com/guomaoqiu/flask_kubernetes">æ’©æˆ‘</a></p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
            <tag> ClusterIP </tag>
            
            <tag> NodePort </tag>
            
            <tag> TargetPort </tag>
            
            <tag> Port </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetesä¸­deploymentå‡çº§å›æ»š</title>
      <link href="/2018/12/10/kubernetes-deployment-rollingupdate/"/>
      <url>/2018/12/10/kubernetes-deployment-rollingupdate/</url>
      
        <content type="html"><![CDATA[<p>åœ¨kubernetesä¸­ä½¿ç”¨deploymentç®¡ç†rsæ—¶ï¼Œå¯ä»¥åˆ©ç”¨deploymentæ»šåŠ¨å‡çº§çš„ç‰¹æ€§ï¼Œè¾¾åˆ°æœåŠ¡é›¶åœæ­¢å‡çº§çš„ç›®çš„</p><h5 id="å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªdeploymen"><a href="#å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªdeploymen" class="headerlink" title="å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªdeploymen"></a>å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªdeploymen</h5><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">run</span> nginx <span class="attribute">--image</span>=nginx</span><br></pre></td></tr></tbody></table></figure><h5 id="å¤šå‰¯æœ¬deployment"><a href="#å¤šå‰¯æœ¬deployment" class="headerlink" title="å¤šå‰¯æœ¬deployment"></a>å¤šå‰¯æœ¬deployment</h5><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">run</span> nginx <span class="attribute">--image</span>=nginx <span class="attribute">--replicas</span>=2 --record</span><br></pre></td></tr></tbody></table></figure><h5 id="æ»šåŠ¨å‡çº§-ï¼ˆå¯ä»¥åŠ ä¸Šâ€“recordå‚æ•°å¯ä»¥è®°å½•å‘½ä»¤ï¼‰"><a href="#æ»šåŠ¨å‡çº§-ï¼ˆå¯ä»¥åŠ ä¸Šâ€“recordå‚æ•°å¯ä»¥è®°å½•å‘½ä»¤ï¼‰" class="headerlink" title="æ»šåŠ¨å‡çº§ ï¼ˆå¯ä»¥åŠ ä¸Šâ€“recordå‚æ•°å¯ä»¥è®°å½•å‘½ä»¤ï¼‰"></a>æ»šåŠ¨å‡çº§ ï¼ˆå¯ä»¥åŠ ä¸Šâ€“recordå‚æ•°å¯ä»¥è®°å½•å‘½ä»¤ï¼‰</h5><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kubectl</span> set image deploy/nginx nginx=nginx:<span class="number">1</span>.<span class="number">9</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ»šåŠ¨ç­–ç•¥:</span></span><br><span class="line"><span class="attribute">kubectl</span> edit deployment nginx</span><br><span class="line">  <span class="attribute">strategy</span>:</span><br><span class="line">    <span class="attribute">rollingUpdate</span>:</span><br><span class="line">      <span class="attribute">maxSurge</span>: <span class="number">1</span> # å‡çº§è¿‡ç¨‹ä¸­å¯ä»¥æ¯”é¢„è®¾çš„ pod çš„æ•°é‡å¤šå‡ºçš„ä¸ªæ•°ï¼Œé»˜è®¤å€¼æ˜¯<span class="number">25</span>%</span><br><span class="line">      <span class="attribute">maxUnavailable</span>: <span class="number">1</span> # æœ€å¤šæœ‰å‡ ä¸ª pod å¤„äºæ— æ³•å·¥ä½œçš„çŠ¶æ€ï¼Œé»˜è®¤å€¼æ˜¯<span class="number">25</span>%</span><br></pre></td></tr></tbody></table></figure><h5 id="æ»šåŠ¨å‡çº§çŠ¶æ€æŸ¥çœ‹"><a href="#æ»šåŠ¨å‡çº§çŠ¶æ€æŸ¥çœ‹" class="headerlink" title="æ»šåŠ¨å‡çº§çŠ¶æ€æŸ¥çœ‹"></a>æ»šåŠ¨å‡çº§çŠ¶æ€æŸ¥çœ‹</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deploy/nginx </span><br></pre></td></tr></tbody></table></figure><h5 id="æŸ¥çœ‹å‡çº§å†å²"><a href="#æŸ¥çœ‹å‡çº§å†å²" class="headerlink" title="æŸ¥çœ‹å‡çº§å†å²"></a>æŸ¥çœ‹å‡çº§å†å²</h5><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout <span class="keyword">history</span> <span class="keyword">deploy</span>/nginx</span><br><span class="line"><span class="comment"># æŸ¥çœ‹å•ä¸ªrevision çš„è¯¦ç»†ä¿¡æ¯ï¼š</span></span><br><span class="line">kubectl rollout <span class="keyword">history</span> <span class="keyword">deploy</span>/nginx <span class="params">--revision=2</span></span><br></pre></td></tr></tbody></table></figure><h5 id="èµ„æºè°ƒæ•´"><a href="#èµ„æºè°ƒæ•´" class="headerlink" title="èµ„æºè°ƒæ•´:"></a>èµ„æºè°ƒæ•´:</h5><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kubectl set resources deploy<span class="symbol">/nginx</span> <span class="operator">-</span>c<span class="operator">=</span>nginx  <span class="operator">-</span>-limits<span class="operator">=</span>cpu<span class="operator">=</span><span class="number">100</span>m,memory<span class="operator">=</span><span class="number">200</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶åœ¨æŸ¥çœ‹å†å²çŠ¶æ€:</span></span><br><span class="line">$ kubectl rollout history deploy<span class="symbol">/nginx</span></span><br><span class="line">deployments <span class="string">"nginx"</span></span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line"><span class="number">1</span>         <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="number">2</span>         <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="number">3</span>         <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹revision 3 çš„å†…å®¹,å¯ä»¥çœ‹å‡ºåˆšæ‰è°ƒæ•´äº†podçš„èµ„æºè®°å½•äº†åˆ°äº†å‡çº§å†å²å½“ä¸­</span></span><br><span class="line">$ kubectl rollout history deploy<span class="symbol">/nginx</span> <span class="operator">-</span>-revision<span class="operator">=</span><span class="number">3</span></span><br><span class="line">eployments <span class="string">"nginx"</span> <span class="keyword">with</span> revision <span class="comment">#3</span></span><br><span class="line">Pod <span class="params">Template:</span></span><br><span class="line">  <span class="params">Labels:</span>       pod-template-hash<span class="operator">=</span><span class="number">440294079</span></span><br><span class="line">        <span class="attr">run</span><span class="operator">=</span>nginx</span><br><span class="line">  <span class="params">Containers:</span></span><br><span class="line">   <span class="params">nginx:</span></span><br><span class="line">    <span class="params">Image:</span>      nginx:<span class="number">1.9</span>.<span class="number">1</span></span><br><span class="line">    <span class="params">Port:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line">    <span class="params">Limits:</span></span><br><span class="line">      <span class="params">cpu:</span>      <span class="number">100</span>m</span><br><span class="line">      <span class="params">memory:</span>   <span class="number">200</span>m</span><br><span class="line">    <span class="params">Environment:</span>        <span class="symbol">&lt;none&gt;</span></span><br><span class="line">    <span class="params">Mounts:</span>     <span class="symbol">&lt;none&gt;</span></span><br><span class="line">  <span class="params">Volumes:</span>      <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="å›æ»šæ“ä½œ"><a href="#å›æ»šæ“ä½œ" class="headerlink" title="å›æ»šæ“ä½œ:"></a>å›æ»šæ“ä½œ:</h5><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å›æ»šåˆ°ç¬¬äºŒä¸ªç‰ˆæœ¬å»</span></span><br><span class="line">$ kubectl rollout undo <span class="keyword">deploy</span> nginx <span class="params">--to-revision=2</span></span><br><span class="line">deployment <span class="string">"nginx"</span> </span><br></pre></td></tr></tbody></table></figure><h5 id="åº”ç”¨å¼¹æ€§ä¼¸ç¼©"><a href="#åº”ç”¨å¼¹æ€§ä¼¸ç¼©" class="headerlink" title="åº”ç”¨å¼¹æ€§ä¼¸ç¼©:"></a>åº”ç”¨å¼¹æ€§ä¼¸ç¼©:</h5><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale <span class="keyword">deploy</span> nginx <span class="params">--replicas=10</span></span><br><span class="line">deployment <span class="string">"nginx"</span> scaled</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœé›†ç¾¤ä¸­å¯¹æ¥äº†heapsterï¼Œå’ŒHPAè”åŠ¨åï¼Œå¯ä»¥é€šè¿‡<code>autoscale</code>è‡ªåŠ¨å¼¹æ€§ä¼¸ç¼©</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl autoscale deployment nginx <span class="attribute">--min</span>=10 <span class="attribute">--max</span>=15 <span class="attribute">--cpu-percent</span>=80</span><br></pre></td></tr></tbody></table></figure><h5 id="æš‚åœå’Œæ¢å¤Deployment"><a href="#æš‚åœå’Œæ¢å¤Deployment" class="headerlink" title="æš‚åœå’Œæ¢å¤Deployment"></a>æš‚åœå’Œæ¢å¤Deployment</h5><p>æ‚¨å¯ä»¥åœ¨å‘å‡ºä¸€æ¬¡æˆ–å¤šæ¬¡æ›´æ–°å‰æš‚åœä¸€ä¸ª Deploymentï¼Œç„¶åå†æ¢å¤å®ƒã€‚è¿™æ ·æ‚¨å°±èƒ½å¤šæ¬¡æš‚åœå’Œæ¢å¤ Deploymentï¼Œåœ¨æ­¤æœŸé—´è¿›è¡Œä¸€äº›æ›´æ–°ï¼Œä¿®å¤å·¥ä½œï¼Œè€Œä¸ä¼šå‘å‡ºä¸å¿…è¦çš„ rolloutã€‚</p><p>ä¾‹å¦‚ä½¿ç”¨åˆšåˆšåˆ›å»º Deploymentï¼š</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">get</span> deploy nginx</span><br><span class="line"><span class="type">NAME</span>      DESIRED   <span class="keyword">CURRENT</span>   UP-<span class="keyword">TO</span>-<span class="type">DATE</span>   AVAILABLE   AGE</span><br><span class="line">nginx     <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>            <span class="number">3</span>           <span class="number">27</span>s</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æš‚åœ Deploymentï¼š</p><figure class="highlight autohotkey"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout <span class="keyword">pause</span> deployment/nginx</span><br><span class="line">deployment <span class="string">"nginx"</span> paused</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åæ›´æ–° Deplymentä¸­çš„é•œåƒï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">set</span> image deploy/nginx <span class="attribute">nginx</span>=nginx:1.9.1</span><br><span class="line">deployment <span class="string">"nginx-deployment"</span> image updated</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>æ‚¨å¯ä»¥è¿›è¡Œä»»æ„å¤šæ¬¡æ›´æ–°ï¼Œä¾‹å¦‚æ›´æ–°ä½¿ç”¨çš„èµ„æºï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">set</span> resources deployment nginx <span class="attribute">-c</span>=nginx <span class="attribute">--limits</span>=cpu=200m,memory=256Mi</span><br><span class="line">deployment <span class="string">"nginx"</span><span class="built_in"> resource </span>requirements updated</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="Deployment-æš‚åœå‰çš„åˆå§‹çŠ¶æ€å°†ç»§ç»­å®ƒçš„åŠŸèƒ½ï¼Œè€Œä¸ä¼šå¯¹-Deployment-çš„æ›´æ–°äº§ç”Ÿä»»ä½•å½±å“ï¼Œåªè¦-Deploymentæ˜¯æš‚åœçš„ã€‚"><a href="#Deployment-æš‚åœå‰çš„åˆå§‹çŠ¶æ€å°†ç»§ç»­å®ƒçš„åŠŸèƒ½ï¼Œè€Œä¸ä¼šå¯¹-Deployment-çš„æ›´æ–°äº§ç”Ÿä»»ä½•å½±å“ï¼Œåªè¦-Deploymentæ˜¯æš‚åœçš„ã€‚" class="headerlink" title="Deployment æš‚åœå‰çš„åˆå§‹çŠ¶æ€å°†ç»§ç»­å®ƒçš„åŠŸèƒ½ï¼Œè€Œä¸ä¼šå¯¹ Deployment çš„æ›´æ–°äº§ç”Ÿä»»ä½•å½±å“ï¼Œåªè¦ Deploymentæ˜¯æš‚åœçš„ã€‚"></a>Deployment æš‚åœå‰çš„åˆå§‹çŠ¶æ€å°†ç»§ç»­å®ƒçš„åŠŸèƒ½ï¼Œè€Œä¸ä¼šå¯¹ Deployment çš„æ›´æ–°äº§ç”Ÿä»»ä½•å½±å“ï¼Œåªè¦ Deploymentæ˜¯æš‚åœçš„ã€‚</h5><p>é‚£ä¹ˆæ–°çš„æ›´æ–°æˆ–è€…æ”¹åŠ¨çš„ç»“æœå°†æ˜¯åœ¨æš‚åœæœŸé—´æ‰€æœ‰åšçš„æ“ä½œéƒ½æ˜¯é¡ºåºç”Ÿæ•ˆå–ç›¸åŒæ“ä½œçš„æœ€åä¸€æ­¥ï¼Œ<br>æ¯”å¦‚,æš‚åœåæˆ‘åšäº†ä»¥ä¸‹æ“ä½œ:<br>1.æ›´æ–°äº†ç‰ˆæœ¬: 1.9.1<br>2.æ›´æ–°äº†èµ„æº: memory=222Mi<br>3.åˆæ›´æ–°äº†ç‰ˆæœ¬: 1.9.3<br>4.åˆè°ƒæ•´äº†èµ„æº: memory=211Mi</p><p>æœ€åï¼Œæ¢å¤è¿™ä¸ª Deploymentï¼Œè§‚å¯Ÿå®Œæˆæ›´æ–°çš„ ReplicaSet å·²ç»åˆ›å»ºå‡ºæ¥äº†ï¼š</p><p><img src="/2018/12/10/kubernetes-deployment-rollingupdate/rolling.jpg"><br>æ³¨æ„ï¼š åœ¨æ¢å¤ Deployment ä¹‹å‰æ‚¨æ— æ³•å›é€€ä¸€ä¸ªå·²ç»æš‚åœçš„ Deploymentã€‚</p>]]></content>
      
      
      <categories>
          
          <category> kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> deployment </tag>
            
            <tag> rolling </tag>
            
            <tag> update </tag>
            
            <tag> pausing </tag>
            
            <tag> resuming </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s Yamlç¼–å†™å°æŠ€å·§</title>
      <link href="/2018/12/09/k8s-yaml-bian-xie-xiao-ji-qiao/"/>
      <url>/2018/12/09/k8s-yaml-bian-xie-xiao-ji-qiao/</url>
      
        <content type="html"><![CDATA[<span id="more"></span><p>å­¦ä¹ ä½¿ç”¨k8sçš„ç«¥é‹éƒ½çŸ¥é“æˆ‘ä»¬åœ¨éƒ¨ç½²podçš„æ—¶å€™æœ‰æ—¶å€™éœ€è¦æ‰‹åŠ¨å»ç¼–å†™ä¸€äº›yamlæ–‡ä»¶ï¼›æ¯”å¦‚æˆ‘éœ€è¦ç¼–å†™deployment,é‚£é™¤äº†åœ¨å…¶ä»–åœ°æ–¹ç²˜è´´æ‹·è´å¤–æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„</p><h3 id="1-ç”¨runå‘½ä»¤ç”Ÿæˆï¼Œç„¶åä½œä¸ºæ¨¡æ¿è¿›è¡Œç¼–è¾‘ã€‚"><a href="#1-ç”¨runå‘½ä»¤ç”Ÿæˆï¼Œç„¶åä½œä¸ºæ¨¡æ¿è¿›è¡Œç¼–è¾‘ã€‚" class="headerlink" title="1.ç”¨runå‘½ä»¤ç”Ÿæˆï¼Œç„¶åä½œä¸ºæ¨¡æ¿è¿›è¡Œç¼–è¾‘ã€‚"></a>1.ç”¨runå‘½ä»¤ç”Ÿæˆï¼Œç„¶åä½œä¸ºæ¨¡æ¿è¿›è¡Œç¼–è¾‘ã€‚</h3><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">run</span> <span class="attribute">--image</span>=nginx my-deploy -o yaml --dry-<span class="built_in">run</span> &gt; my-deploy.yaml </span><br><span class="line">```   </span><br><span class="line"></span><br><span class="line"><span class="comment">### 2.ç”¨getå‘½ä»¤å¯¼å‡ºï¼Œç„¶åä½œä¸ºæ¨¡æ¿è¿›è¡Œç¼–è¾‘ã€‚</span></span><br><span class="line">```  </span><br><span class="line"><span class="comment"># æ³¨æ„: --export æ˜¯ä¸ºäº†å»é™¤å½“å‰æ­£åœ¨è¿è¡Œçš„è¿™ä¸ªdeploymentç”Ÿæˆçš„ä¸€äº›çŠ¶æ€ï¼Œæˆ‘ä»¬ç”¨ä¸åˆ°å°±è¿‡æ»¤æ‰</span></span><br><span class="line">kubectl <span class="built_in">get</span> deployment/nginx <span class="attribute">-o</span>=yaml --<span class="built_in">export</span>  &gt; new.yaml</span><br><span class="line">```      </span><br><span class="line"></span><br><span class="line"><span class="comment">### 3.Podäº²å’Œæ€§ä¸‹é¢å­—æ®µçš„æ‹¼å†™å¿˜è®°äº†</span></span><br></pre></td></tr></tbody></table></figure><p>kubectl explain pod.spec.affinity.podAffinity</p><pre><code>ç¤ºä¾‹:---æˆ‘æƒ³ç”Ÿæˆä¸€ä¸ªæœ‰ä¸‰ä¸ªå‰¯æœ¬çš„redis podçš„yamlï¼Œç„¶åæˆ‘æƒ³æŠŠè¿™ä¸‰ä¸ªpod é€šè¿‡nodeäº²å’Œæ€§è°ƒåº¦åˆ°åŒä¸€ä¸ªnodeèŠ‚ç‚¹ä¸Šé¢ï¼›### 1\. æˆ‘è¿™é‡Œç”¨kubectl runæ¥ç”Ÿæˆ:    kubectl run redis --image=redis --replicas=3 --dry-run -o yaml &gt; redis_node_affinity.yaml    ### 2\. æ‰‹å†™äº²å’Œæ€§ç­–ç•¥ï¼šé¢ é—®é¢˜æ¥äº†äº²å’Œæ€§ç­–ç•¥çš„å­—æ®µæˆ‘è®°ä¸ä½å•Šï¼Œæ€ä¹ˆåŠï¼Ÿé‚£å°±éœ€è¦é€šè¿‡  `kubectl explain RESOURCE [options]`æ¥è·å–èµ„æºæ–‡æ¡£æ€ä¹ˆç”¨?  æ¯”å¦‚æˆ‘è¿™é‡Œæ˜¯è¦ä¸ºpodåšnodeçš„äº²å’Œæ€§ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯è¿™ä¸ªapiæ¥å£ä¸‹é¢çš„é…ç½®æ–‡æ¡£:æƒ³çœ‹podçš„èµ„æºæ–‡æ¡£:    [root@k8s-m1 ~]# kubectl explain pod.spec.affinity    KIND:     Pod    VERSION:  v1        RESOURCE: affinity &lt;Object&gt;        DESCRIPTION:         If specified, the pod's scheduling constraints             Affinity is a group of affinity scheduling rules.        FIELDS:       nodeAffinity &lt;Object&gt;         Describes node affinity scheduling rules for the pod.           podAffinity  &lt;Object&gt;         Describes pod affinity scheduling rules (e.g. co-locate this pod in the         same node, zone, etc. as some other pod(s)).           podAntiAffinity  &lt;Object&gt;         Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod         in the same node, zone, etc. as some other pod(s)).        [root@k8s-m1 ~]#    ä¸Šé¢æˆ‘ä»¬é€šè¿‡ `pod.spec.affinity` å®šä½åˆ°äº†`nodeAffinity` æ–‡æ¡£, è¿™äº›å­—æ®µä¹Ÿæ˜¯yamlç§ä½¿ç”¨çš„å­—æ®µï¼Œéšåæˆ‘é€šè¿‡ä¸€å±‚ä¸€å±‚çš„å®šä½å°±å¤§ä½“ä¸ŠçŸ¥é“è¿™äº›å­—æ®µåœ¨yamlä¸­æ˜¯æ€ä¹ˆä½¿ç”¨çš„å•¦~    [root@k8s-m1 ~]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms.matchExpressions    æœ€åå¿«é€Ÿç”Ÿæˆå¹¶ä¸”ç¼–è¾‘çš„deployment yamlå°±å†™å¥½äº†ã€‚    apiVersion: apps/v1beta1    kind: Deployment    metadata:      creationTimestamp: null      labels:        run: redis      name: redis    spec:      replicas: 3      selector:        matchLabels:          run: redis      strategy: {}      template:        metadata:          creationTimestamp: null          labels:            run: redis        spec:          containers:          - image: redis            name: redis            resources: {}          # ä»¥ä¸‹å†…å®¹å°±æ˜¯æˆ‘é€šè¿‡explainå‚æ•°æ¥æŸ¥è¯¢åˆ°çš„æˆ‘æƒ³è¦çš„å­—æ®µå†™çš„          affinity:            nodeAffinity:              requiredDuringSchedulingIgnoredDuringExecution:                 nodeSelectorTerms:                   - matchExpressions:                       - key: kubernetes.io/hostname                         operator: In                         values:                           - k8s-m1    status: {}    ![](https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/12/15443718852925.jpg)ï¿¼  è¿˜æ˜¯éå¸¸å¿«é€Ÿé«˜æ•ˆçš„ã€‚</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sé›†ç¾¤ä¸­pauseå®¹å™¨æ˜¯å¹²å˜›çš„~</title>
      <link href="/2018/12/07/k8s-ji-qun-zhongpause-rong-qi-shi-gan-ma-de/"/>
      <url>/2018/12/07/k8s-ji-qun-zhongpause-rong-qi-shi-gan-ma-de/</url>
      
        <content type="html"><![CDATA[<p>å½“æˆ‘ä»¬åœ¨æ£€æŸ¥k8sé›†ç¾¤çŠ¶æ€çš„æ—¶å€™ä¼šå‘ç°æœ‰å¾ˆå¤š <code>pause</code> å®¹å™¨è¿è¡ŒäºæœåŠ¡å™¨ä¸Šé¢ï¼Œç„¶åæ¯æ¬¡å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œéƒ½ä¼šä¼´éšä¸€ä¸ªpauseå®¹å™¨çš„å¯åŠ¨ã€‚é‚£å®ƒç©¶ç«Ÿæ˜¯å¹²å•¥å­çš„ï¼Ÿ</p><p>Pauseå®¹å™¨ï¼Œåˆå«Infraå®¹å™¨ï¼Œä¸‹é¢é€šè¿‡å®éªŒæ¥ç†è§£å®ƒã€‚</p><p>æˆ‘ä»¬çŸ¥é“åœ¨æ­å»ºk8sé›†ç¾¤çš„æ—¶å€™ï¼Œkubeletçš„é…ç½®ä¸­æœ‰è¿™æ ·ä¸€ä¸ªå‚æ•°ï¼š</p><pre><code>[root@linux-node1 cfg]# more /usr/lib/systemd/system/kubelet.serviceÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·  --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1 \Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·</code></pre><p>æˆ‘è¿™é‡Œæ˜¯ç›´æ¥å°†è¿™äº›é…ç½®å‚æ•°é€šè¿‡å¯åŠ¨è„šæœ¬æ¥è¡¥å……è¿›å»çš„ã€‚<br>Pauseå®¹å™¨ï¼Œæ˜¯å¯ä»¥è‡ªå·±æ¥å®šä¹‰ï¼Œå®˜æ–¹ä½¿ç”¨çš„<code>gcr.io/google_containers/pause-amd64:3.0</code>å®¹å™¨çš„ä»£ç è§Githubï¼Œä½¿ç”¨Cè¯­è¨€ç¼–å†™ã€‚</p><h2 id="Pauseå®¹å™¨çš„ä½œç”¨"><a href="#Pauseå®¹å™¨çš„ä½œç”¨" class="headerlink" title="Pauseå®¹å™¨çš„ä½œç”¨"></a>Pauseå®¹å™¨çš„ä½œç”¨</h2><p>æˆ‘ä»¬æ£€æŸ¥nodèŠ‚ç‚¹çš„æ—¶å€™ä¼šå‘ç°æ¯ä¸ªnodeä¸Šéƒ½è¿è¡Œäº†å¾ˆå¤šçš„pauseå®¹å™¨ï¼Œä¾‹å¦‚å¦‚ä¸‹ã€‚</p><pre><code>[root@linux-node1 cfg]# docker psÂ·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·CONTAINER ID        IMAGE                                    COMMAND                  CREATED             STATUS              PORTS               NAMESa007c18b8dc0        568c4670fa80                             "nginx -g 'daemon ofâ€¦"   42 hours ago        Up 42 hours                             k8s_nginx_nginx-pod-7d9f9876cc-75sf7_default_a688bb46-f872-11e8-ae6b-000c29c6d12b_19866c08d1f4b        568c4670fa80                             "nginx -g 'daemon ofâ€¦"   42 hours ago        Up 42 hours                             k8s_nginx_nginx-pod-7d9f9876cc-wpv4h_default_a6a899c0-f872-11e8-ae6b-000c29c6d12b_1aafef6727026        mirrorgooglecontainers/pause-amd64:3.0   "/pause"                 42 hours ago        Up 42 hours                             k8s_POD_flask-app-6f5b6cc447-kbxks_flask-app-extions-stage_374b8aa0-f873-11e8-ae6b-000c29c6d12b_1c4f48f90b27f        mirrorgooglecontainers/pause-amd64:3.0   "/pause"                 42 hours ago        Up 42 hours                             k8s_POD_flask-app-6f5b6cc447-f9wjn_flask-app-extions-stage_373be9db-f873-11e8-ae6b-000c29c6d12b_19f452e6961f6        mirrorgooglecontainers/pause-amd64:3.0   "/pause"                 42 hours ago        Up 42 hours                             k8s_POD_nginx-pod-7d9f9876cc-ccx94_default_a6a8c440-f872-11e8-ae6b-000c29c6d12b_17e68043469d1        mirrorgooglecontainers/pause-amd64:3.0   "/pause"                 42 hours ago        Up 42 hours                             k8s_POD_nginx-pod-7d9f9876cc-sskpk_default_a6ac43bd-f872-11e8-ae6b-000c29c6d12b_1Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·</code></pre><p>kubernetesä¸­çš„pauseå®¹å™¨ä¸»è¦ä¸ºæ¯ä¸ªä¸šåŠ¡å®¹å™¨æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li>åœ¨podä¸­æ‹…ä»»Linuxå‘½åç©ºé—´å…±äº«çš„åŸºç¡€ï¼›</li><li>å¯ç”¨pidå‘½åç©ºé—´ï¼Œå¼€å¯initè¿›ç¨‹ã€‚</li></ul><p>åœ¨<a href="https://www.ianlewis.org/en/almighty-pause-container">The Almighty Pause Container</a>è¿™ç¯‡æ–‡ç« ä¸­åšå‡ºäº†è¯¦ç»†çš„è¯´æ˜ï¼Œpauseå®¹å™¨çš„ä½œç”¨å¯ä»¥ä»è¿™ä¸ªä¾‹å­ä¸­çœ‹å‡ºï¼Œé¦–å…ˆè§ä¸‹å›¾ï¼š<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/12/15441701986547.png">ï¿¼</p><h5 id="1-æˆ‘ä»¬é¦–å…ˆåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªpauseå®¹å™¨ã€‚"><a href="#1-æˆ‘ä»¬é¦–å…ˆåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªpauseå®¹å™¨ã€‚" class="headerlink" title="1.æˆ‘ä»¬é¦–å…ˆåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªpauseå®¹å™¨ã€‚"></a>1.æˆ‘ä»¬é¦–å…ˆåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªpauseå®¹å™¨ã€‚</h5><pre><code>[root@k8s-node1 ~]# docker run -d --name pause -p 8880:80 registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.138d2aa8366d5aa6fe4c57aa0d879de4b5259c67c83d17428dd4d9f8937205c02[root@k8s-node1 ~]# docker ps | grep pause38d2aa8366d5        registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1   "/pause"                 14 seconds ago      Up 13 seconds       0.0.0.0:8880-&gt;80/tcp   pause</code></pre><h5 id="2-ç„¶åå†è¿è¡Œä¸€ä¸ªnginxå®¹å™¨ï¼Œnginxå°†ä¸ºlocalhost-2368åˆ›å»ºä¸€ä¸ªä»£ç†ã€‚"><a href="#2-ç„¶åå†è¿è¡Œä¸€ä¸ªnginxå®¹å™¨ï¼Œnginxå°†ä¸ºlocalhost-2368åˆ›å»ºä¸€ä¸ªä»£ç†ã€‚" class="headerlink" title="2.ç„¶åå†è¿è¡Œä¸€ä¸ªnginxå®¹å™¨ï¼Œnginxå°†ä¸ºlocalhost:2368åˆ›å»ºä¸€ä¸ªä»£ç†ã€‚"></a>2.ç„¶åå†è¿è¡Œä¸€ä¸ªnginxå®¹å™¨ï¼Œnginxå°†ä¸ºlocalhost:2368åˆ›å»ºä¸€ä¸ªä»£ç†ã€‚</h5><pre><code>[root@k8s-node1 ~]# cat &lt;&lt;EOF &gt;&gt; nginx.conferror_log stderr;events { worker_connections  1024; }http {    access_log /dev/stdout combined;    server {        listen 80 default_server;        server_name example.com www.example.com;        location / {            proxy_pass http://127.0.0.1:2368;        }    }}EOF[root@k8s-node1 ~]# docker run -d --name nginx -v `pwd`/nginx.conf:/etc/nginx/nginx.conf --net=container:pause --ipc=container:pause --pid=container:pause nginxfa078473c01e040db795004ad16db525dea8a113893d3052cc6ab1c5e117ba10</code></pre><h5 id="3-ç„¶åå†ä¸ºghoståˆ›å»ºä¸€ä¸ªåº”ç”¨å®¹å™¨ï¼Œè¿™æ˜¯ä¸€æ¬¾åšå®¢è½¯ä»¶ã€‚"><a href="#3-ç„¶åå†ä¸ºghoståˆ›å»ºä¸€ä¸ªåº”ç”¨å®¹å™¨ï¼Œè¿™æ˜¯ä¸€æ¬¾åšå®¢è½¯ä»¶ã€‚" class="headerlink" title="3.ç„¶åå†ä¸ºghoståˆ›å»ºä¸€ä¸ªåº”ç”¨å®¹å™¨ï¼Œè¿™æ˜¯ä¸€æ¬¾åšå®¢è½¯ä»¶ã€‚"></a>3.ç„¶åå†ä¸ºghoståˆ›å»ºä¸€ä¸ªåº”ç”¨å®¹å™¨ï¼Œè¿™æ˜¯ä¸€æ¬¾åšå®¢è½¯ä»¶ã€‚</h5><pre><code>[root@linux-node2 ~]# docker run -d --name ghost --net=container:pause --ipc=container:pause --pid=container:pause ghost# æŸ¥çœ‹ç»“æœï¼š[root@k8s-node1 ~]# docker ps | grep -E "pause|nginx|ghost"9b796efd95a5        ghost                                                                 "docker-entrypoint..."   47 seconds ago       Up 46 seconds                              ghostfa078473c01e        nginx                                                                 "nginx -g 'daemon ..."   About a minute ago   Up About a minute                          nginx38d2aa8366d5        registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1   "/pause"                 3 minutes ago        Up 3 minutes        0.0.0.0:8880-&gt;80/tcp   pause[root@k8s-node1 ~]## ç°åœ¨è®¿é—®http://119.3.198.128:8880/å°±å¯ä»¥çœ‹åˆ°ghoståšå®¢çš„ç•Œé¢äº†å—# è¿™é‡Œæˆ‘ç›´æ¥curl ç„¶åæµè§ˆå™¨è®¿é—®ä¹Ÿæ˜¯æ­£å¸¸çš„[root@k8s-node1 ~]# curl -I http://119.3.198.128:8880/HTTP/1.1 200 OKServer: nginx/1.15.5Date: Fri, 07 Dec 2018 08:35:49 GMTContent-Type: text/html; charset=utf-8Content-Length: 17381Connection: keep-aliveX-Powered-By: ExpressCache-Control: public, max-age=0ETag: W/"43e5-ELHSnbaoapp3YOyz+PU502oJo5E"Vary: Accept-Encoding[root@k8s-node1 ~]#</code></pre><h2 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ:"></a>è§£æ:</h2><ol><li>pause å®¹å™¨å°†å†…éƒ¨çš„80ç«¯å£æ˜ å°„åˆ°äº†å®¿ä¸»æœºçš„8880ç«¯å£;</li><li>pauseå®¹å™¨åœ¨å®¿ä¸»æœºä¸Šè®¾ç½®å¥½äº†ç½‘ç»œnamespaceåï¼Œnginxå®¹å™¨åŠ å…¥åˆ°è¯¥ç½‘ç»œnamespaceä¸­;</li><li>nginxå®¹å™¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®šäº†â€“net=container:pause;</li><li>ghostå®¹å™¨å¯åŠ¨çš„æ—¶å€™åŒæ ·åŠ å…¥åˆ°äº†è¯¥ç½‘ç»œnamespaceä¸­;</li><li>è¿™æ ·ä¸‰ä¸ªå®¹å™¨å°±å…±äº«äº†ç½‘ç»œï¼Œäº’ç›¸ä¹‹é—´å°±å¯ä»¥ä½¿ç”¨localhostç›´æ¥é€šä¿¡ï¼Œ</li><li>â€“ipc=contianer:pause â€“pid=container:pauseå°±æ˜¯ä¸‰ä¸ªå®¹å™¨å¤„äºåŒä¸€ä¸ªnamespaceä¸­ï¼Œinitè¿›ç¨‹ä¸ºpause;</li></ol><p>æˆ‘ä»¬åˆ°ghostå®¹å™¨ä¸­æŸ¥çœ‹ä¸€ä¸‹:</p><pre><code>[root@k8s-node1 ~]# docker exec -it ghost /bin/bashroot@38d2aa8366d5:/var/lib/ghost# ps auxUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMANDroot         1  0.0  0.0   1012     4 ?        Ss   08:27   0:00 /pauseroot         5  0.0  0.0  32472  3168 ?        Ss   08:29   0:00 nginx: master process nginx -g daemon off;systemd+     9  0.0  0.0  32932  1812 ?        S    08:29   0:00 nginx: worker processnode        10  0.5  2.1 1262748 84688 ?       Ssl  08:30   0:03 node current/index.jsroot        83  0.2  0.0  20240  1912 pts/0    Ss   08:41   0:00 /bin/bashroot        87  0.0  0.0  17496  1148 pts/0    R+   08:41   0:00 ps auxroot@38d2aa8366d5:/var/lib/ghost#</code></pre><p>åœ¨ghostå®¹å™¨ä¸­åŒæ—¶å¯ä»¥çœ‹åˆ°pauseå’Œnginxå®¹å™¨çš„è¿›ç¨‹ï¼Œå¹¶ä¸”pauseå®¹å™¨çš„PIDæ˜¯1ã€‚è€Œåœ¨kubernetesä¸­å®¹å™¨çš„PID=1çš„è¿›ç¨‹å³ä¸ºå®¹å™¨æœ¬èº«çš„ä¸šåŠ¡è¿›ç¨‹ã€‚</p><h2 id="å…¶ä»–æ¦‚å¿µï¼š"><a href="#å…¶ä»–æ¦‚å¿µï¼š" class="headerlink" title="å…¶ä»–æ¦‚å¿µï¼š"></a>å…¶ä»–æ¦‚å¿µï¼š</h2><ul><li>PIDå‘½åç©ºé—´ï¼šPodä¸­çš„ä¸åŒåº”ç”¨ç¨‹åºå¯ä»¥çœ‹åˆ°å…¶ä»–åº”ç”¨ç¨‹åºçš„è¿›ç¨‹IDï¼›</li><li>ç½‘ç»œå‘½åç©ºé—´ï¼šPodä¸­çš„å¤šä¸ªå®¹å™¨èƒ½å¤Ÿè®¿é—®åŒä¸€ä¸ªIPå’Œç«¯å£èŒƒå›´ï¼›</li><li>IPCå‘½åç©ºé—´ï¼šPodä¸­çš„å¤šä¸ªå®¹å™¨èƒ½å¤Ÿä½¿ç”¨SystemV IPCæˆ–POSIXæ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œé€šä¿¡ï¼›</li><li>UTSå‘½åç©ºé—´ï¼šPodä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªä¸»æœºåï¼›Volumesï¼ˆå…±äº«å­˜å‚¨å·ï¼‰ï¼š</li><li>Podä¸­çš„å„ä¸ªå®¹å™¨å¯ä»¥è®¿é—®åœ¨Podçº§åˆ«å®šä¹‰çš„Volumesï¼›</li></ul>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç†è§£Kubernetesçš„äº²å’Œæ€§è°ƒåº¦</title>
      <link href="/2018/12/04/li-jiekubernetes-de-qin-he-xing-diao-du/"/>
      <url>/2018/12/04/li-jiekubernetes-de-qin-he-xing-diao-du/</url>
      
        <content type="html"><![CDATA[<p><code>NodeNameã€nodeSelectorã€nodeAffinityã€podAffinityã€Taintsä»¥åŠTolerationsç”¨æ³•</code></p><h2 id="1-NodeName"><a href="#1-NodeName" class="headerlink" title="1. NodeName"></a>1. NodeName</h2><p>Pod.spec.nodeNameç”¨äºå¼ºåˆ¶çº¦æŸå°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Šï¼Œè¿™é‡Œè¯´æ˜¯â€œè°ƒåº¦â€ï¼Œä½†å…¶å®æŒ‡å®šäº†nodeNameçš„Podä¼šç›´æ¥è·³è¿‡Schedulerçš„è°ƒåº¦é€»è¾‘ï¼Œç›´æ¥å†™å…¥PodListåˆ—è¡¨ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯<code>å¼ºåˆ¶åŒ¹é…</code>ã€‚<br>ä¾‹å­ï¼š<br>æˆ‘çš„é¢„æœŸæ˜¯å°†è¯¥podè¿è¡ŒäºèŠ‚ç‚¹åç§°ä¸º 192.168.56.11 è¿™ä¸ªèŠ‚ç‚¹ï¼š</p><h6 id="1-1-ä¾‹å¦‚-test-nodename-yaml"><a href="#1-1-ä¾‹å¦‚-test-nodename-yaml" class="headerlink" title="1.1 ä¾‹å¦‚(test-nodename.yaml)"></a>1.1 ä¾‹å¦‚(test-nodename.yaml)</h6><pre><code>apiVersion: v1kind: Podmetadata:  labels:    app: with-nodename-busybox-pod  name: with-nodenamespec:  nodeName: 192.168.56.11 #é€šè¿‡è¿™é‡ŒæŒ‡å®š  containers:  - command:    - sleep    - "3600"    image: busybox    imagePullPolicy: IfNotPresent    name: test-busybox</code></pre><h6 id="1-2-æŸ¥çœ‹åˆ›å»ºäº‹ä»¶ã€ä¸é¢„æœŸç›¸ç¬¦"><a href="#1-2-æŸ¥çœ‹åˆ›å»ºäº‹ä»¶ã€ä¸é¢„æœŸç›¸ç¬¦" class="headerlink" title="1.2 æŸ¥çœ‹åˆ›å»ºäº‹ä»¶ã€ä¸é¢„æœŸç›¸ç¬¦:"></a>1.2 æŸ¥çœ‹åˆ›å»ºäº‹ä»¶ã€ä¸é¢„æœŸç›¸ç¬¦:</h6><pre><code>Events:  Type    Reason                 Age   From                    Message  ----    ------                 ----  ----                    -------  Normal  Scheduled              3m    default-scheduler       Successfully assigned with-pod-affinity to 192.168.56.11  Normal  SuccessfulMountVolume  3m    kubelet, 192.168.56.11  MountVolume.SetUp succeeded for volume "default-token-5htws"  Normal  Pulling                3m    kubelet, 192.168.56.11  pulling image "nginx"  Normal  Pulled                 1m    kubelet, 192.168.56.11  Successfully pulled image "nginx"  Normal  Created                1m    kubelet, 192.168.56.11  Created container  Normal  Started                1m    kubelet, 192.168.56.11  Started container</code></pre><h2 id="2-NodeSelector"><a href="#2-NodeSelector" class="headerlink" title="2. NodeSelector"></a>2. NodeSelector</h2><p>Pod.spec.nodeSelectoræ˜¯é€šè¿‡kubernetesçš„label-selectoræœºåˆ¶è¿›è¡ŒèŠ‚ç‚¹é€‰æ‹©ï¼Œç”±schedulerè°ƒåº¦ç­–ç•¥MatchNodeSelectorè¿›è¡ŒlabelåŒ¹é…ï¼Œè°ƒåº¦podåˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯<code>å¼ºåˆ¶çº¦æŸ</code>ã€‚ä½¿ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨çš„æ­¥éª¤ä¸ºï¼š</p><h6 id="2-1-Nodeæ·»åŠ labelæ ‡è®°-æ ‡è®°è§„åˆ™ï¼š"><a href="#2-1-Nodeæ·»åŠ labelæ ‡è®°-æ ‡è®°è§„åˆ™ï¼š" class="headerlink" title="2.1 Nodeæ·»åŠ labelæ ‡è®°,æ ‡è®°è§„åˆ™ï¼š"></a>2.1 Nodeæ·»åŠ labelæ ‡è®°,æ ‡è®°è§„åˆ™ï¼š</h6><pre><code>kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;=&lt;label-value&gt;kubectl label nodes 192.168.56.14 server_type=game_server</code></pre><h6 id="2-2-ç¡®è®¤æ ‡è®°"><a href="#2-2-ç¡®è®¤æ ‡è®°" class="headerlink" title="2.2 ç¡®è®¤æ ‡è®°"></a>2.2 ç¡®è®¤æ ‡è®°</h6><pre><code>[root@linux-node1 ~]# kubectl get nodes 192.168.56.14 --show-labelsNAME            STATUS    ROLES     AGE       VERSION   LABELS192.168.56.14   Ready     node      82d       v1.10.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=192.168.56.14,node-role.kubernetes.io/node=true,server_type=game_server</code></pre><h6 id="2-3-ä¾‹å¦‚-test-nodeselector-yaml"><a href="#2-3-ä¾‹å¦‚-test-nodeselector-yaml" class="headerlink" title="2.3 ä¾‹å¦‚(test-nodeselector.yaml)"></a>2.3 ä¾‹å¦‚(test-nodeselector.yaml)</h6><pre><code>apiVersion: v1kind: Podmetadata:  labels:    app: with-nodeselector-busybox-pod  name: with-node-selectorspec:  containers:  - command:    - sleep    - "3600"    image: busybox    imagePullPolicy: IfNotPresent    name: test-busybox  # é€šè¿‡èŠ‚ç‚¹æ ‡ç­¾è¿›è¡Œé¢„è®¾è¯¥podå°†ä¼šè¿è¡Œäºæœ‰æ­¤æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šé¢ï¼Œ  # å¦‚æœå¤šä¸ªèŠ‚ç‚¹æ‹¥æœ‰æ­¤æ ‡ç­¾ï¼Œè°ƒåº¦å™¨å°†ä¼šæ‹©ä¼˜è¿›è¡Œè°ƒåº¦  nodeSelector:    server_type: game_server</code></pre><h5 id="2-4-æŸ¥çœ‹åˆ›å»ºäº‹ä»¶"><a href="#2-4-æŸ¥çœ‹åˆ›å»ºäº‹ä»¶" class="headerlink" title="2.4 æŸ¥çœ‹åˆ›å»ºäº‹ä»¶:"></a>2.4 æŸ¥çœ‹åˆ›å»ºäº‹ä»¶:</h5><pre><code>Events:  Type    Reason                 Age   From                    Message  ----    ------                 ----  ----                    -------  Normal  Scheduled              16s   default-scheduler       Successfully assigned with-node-selector to 192.168.56.14  Normal  SuccessfulMountVolume  16s   kubelet, 192.168.56.14  MountVolume.SetUp succeeded for volume "default-token-5htws"  Normal  Pulling                11s   kubelet, 192.168.56.14  pulling image "busybox"</code></pre><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥æ„Ÿå—åˆ°nodeSelectorçš„æ–¹å¼æ¯”è¾ƒç›´è§‚ï¼Œä½†æ˜¯è¿˜å¤Ÿçµæ´»ï¼Œæ§åˆ¶ç²’åº¦åå¤§ï¼Œä¸‹é¢æˆ‘ä»¬å†çœ‹å¦å¤–ä¸€ç§æ›´åŠ çµæ´»çš„æ–¹å¼ï¼š<code>nodeAffinity</code>ã€‚</p><h2 id="3-NodeAffinity"><a href="#3-NodeAffinity" class="headerlink" title="3. NodeAffinity"></a>3. NodeAffinity</h2><p><code>nodeAffinity</code>å°±æ˜¯èŠ‚ç‚¹äº²å’Œæ€§ï¼Œç›¸å¯¹åº”çš„æ˜¯<code>Anti-Affinity</code>ï¼Œå°±æ˜¯åäº²å’Œæ€§ï¼Œè¿™ç§æ–¹æ³•æ¯”ä¸Šé¢çš„nodeSelectoræ›´åŠ çµæ´»ï¼Œå®ƒå¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„é€»è¾‘ç»„åˆäº†ï¼Œä¸åªæ˜¯ç®€å•çš„ç›¸ç­‰åŒ¹é…ã€‚<br>è°ƒåº¦å¯ä»¥åˆ†æˆè½¯ç­–ç•¥å’Œç¡¬ç­–ç•¥ä¸¤ç§æ–¹å¼ï¼Œè½¯ç­–ç•¥å°±æ˜¯å¦‚æœä½ æ²¡æœ‰æ»¡è¶³è°ƒåº¦è¦æ±‚çš„èŠ‚ç‚¹çš„è¯ï¼ŒPOD å°±ä¼šå¿½ç•¥è¿™æ¡è§„åˆ™ï¼Œç»§ç»­å®Œæˆè°ƒåº¦è¿‡ç¨‹ã€‚ <code>nodeAffinity</code>å°±æœ‰ä¸¤ä¸Šé¢ä¸¤ç§ç­–ç•¥ï¼š</p><pre><code># è½¯ç­–ç•¥:(æ»¡è¶³æ¡ä»¶æœ€å¥½äº†ï¼Œæ²¡æœ‰çš„è¯ä¹Ÿæ— æ‰€è°“äº†çš„ç­–ç•¥)preferredDuringSchedulingIgnoredDuringExecution# ç¡¬ç­–ç•¥:(ä½ å¿…é¡»æ»¡è¶³æˆ‘çš„è¦æ±‚ï¼Œä¸ç„¶æˆ‘å°±ä¸å¹²)requiredDuringSchedulingIgnoredDuringExecution</code></pre><h6 id="3-1-ä¾‹å¦‚-test-node-affinity-yaml"><a href="#3-1-ä¾‹å¦‚-test-node-affinity-yaml" class="headerlink" title="3.1 ä¾‹å¦‚(test-node-affinity.yaml)"></a>3.1 ä¾‹å¦‚(test-node-affinity.yaml)</h6><pre><code>apiVersion: v1kind: Podmetadata:  name: with-node-affinity  labels:    app: node-affinity-podspec:  containers:  - name: with-node-affinity    image: nginx    imagePullPolicy: IfNotPresent  affinity:    nodeAffinity:      # ç¡¬æ€§ç­–ç•¥      requiredDuringSchedulingIgnoredDuringExecution:        nodeSelectorTerms:        - matchExpressions:          - key: kubernetes.io/hostname            operator: NotIn            values:            - 192.168.56.11            - 192.168.56.12      # è½¯æ€§ç­–ç•¥      preferredDuringSchedulingIgnoredDuringExecution:      - weight: 1        preference:          matchExpressions:          - key: server_type            operator: In            values:              - game_server</code></pre><p>ä¸Šé¢çš„Podæˆ‘ä»¬è¿›è¡Œä¸€ä¸‹è§£è¯»:<br>1ã€è¯¥pod é€šè¿‡ç¡¬æ€§ç­–ç•¥çº¦æŸåå°†ç¦æ­¢è°ƒåº¦åˆ°èŠ‚ç‚¹11ï¼Œ12ä¸Šé¢å»<br>2ã€æ’é™¤èŠ‚ç‚¹11ï¼Œ12åï¼Œé€‰æ‹©å…¶ä»–èŠ‚ç‚¹å«æœ‰labelä¸º<code>server_type:game_server</code>çš„èŠ‚ç‚¹è¿è¡Œ<br>3ã€å¦‚æœå…¶ä»–èŠ‚ç‚¹ä¹Ÿæ²¡æœ‰å«æœ‰label <code>server_type:game_server</code>, é‚£ä¹ˆå°†ä¼šè°ƒåº¦åˆ°ä»»æ„èŠ‚ç‚¹è¿è¡Œ<br>åŒæ ·çš„æˆ‘ä»¬å¯ä»¥ä½¿ç”¨descirbeå‘½ä»¤æŸ¥çœ‹å…·ä½“çš„è°ƒåº¦æƒ…å†µæ˜¯å¦æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚è¿™é‡Œçš„åŒ¹é…é€»è¾‘æ˜¯ label çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ï¼Œç°åœ¨Kubernetesæä¾›çš„æ“ä½œç¬¦æœ‰ä¸‹é¢çš„å‡ ç§ï¼š</p><ul><li>Inï¼šlabel çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­</li><li>NotInï¼šlabel çš„å€¼ä¸åœ¨æŸä¸ªåˆ—è¡¨ä¸­</li><li>Gtï¼šlabel çš„å€¼å¤§äºæŸä¸ªå€¼</li><li>Ltï¼šlabel çš„å€¼å°äºæŸä¸ªå€¼</li><li>Existsï¼šæŸä¸ª label å­˜åœ¨</li><li>DoesNotExistï¼šæŸä¸ª label ä¸å­˜åœ¨</li></ul><p>å¦‚æœ<code>nodeSelectorTerms</code>ä¸‹é¢æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œæ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥äº†ï¼›å¦‚æœ<code>matchExpressions</code>æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œåˆ™å¿…é¡»åŒæ—¶æ»¡è¶³è¿™äº›æ¡ä»¶æ‰èƒ½æ­£å¸¸è°ƒåº¦ PODã€‚</p><h2 id="4-PodAffinity"><a href="#4-PodAffinity" class="headerlink" title="4. PodAffinity"></a>4. PodAffinity</h2><p>ä¸Šé¢ä¸‰ç§æ–¹å¼éƒ½æ˜¯è®©PODå»é€‰æ‹©èŠ‚ç‚¹çš„ï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½å¤Ÿæ ¹æ® POD ä¹‹é—´çš„å…³ç³»è¿›è¡Œè°ƒåº¦ï¼ŒKubernetesåœ¨1.4ç‰ˆæœ¬å¼•å…¥çš„podAffinityæ¦‚å¿µå°±å¯ä»¥å®ç°æˆ‘ä»¬è¿™ä¸ªéœ€æ±‚ã€‚</p><p>å’Œ<code>nodeAffinity</code>ç±»ä¼¼ï¼Œ<code>podAffinity</code>ä¹Ÿæœ‰<code>requiredDuringSchedulingIgnoredDuringExecution(ç¡¬æ€§ç­–ç•¥)</code>å’Œ <code>preferredDuringSchedulingIgnoredDuringExecution(è½¯æ€§ç­–ç•¥)</code>ä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å¦‚æœè¦ä½¿ç”¨äº’æ–¥æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>podAntiAffinity</code>å­—æ®µã€‚ å¦‚ä¸‹ä¾‹å­ï¼Œæˆ‘ä»¬å¸Œæœ›ã€with-pod-affinityã€‘å’Œã€with-nodename-busybox-podã€‘èƒ½å¤Ÿå°±è¿‘éƒ¨ç½²ï¼Œè€Œä¸å¸Œæœ›å’Œã€node-affinity-podã€‘éƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸‹é¢ï¼š</p><h6 id="4-1-ä¾‹å¦‚-test-pod-affinity-yaml"><a href="#4-1-ä¾‹å¦‚-test-pod-affinity-yaml" class="headerlink" title="4.1 ä¾‹å¦‚(test-pod-affinity.yaml)"></a>4.1 ä¾‹å¦‚(test-pod-affinity.yaml)</h6><pre><code>apiVersion: v1kind: Podmetadata:  name: with-pod-affinity  labels:    app: pod-affinity-podspec:  containers:  - name: with-pod-affinity    image: nginx  affinity:    podAffinity:      requiredDuringSchedulingIgnoredDuringExecution:      - labelSelector:          matchExpressions:          - key: app            operator: In            values:            - with-nodename-busybox-pod        topologyKey: kubernetes.io/hostname    podAntiAffinity:      preferredDuringSchedulingIgnoredDuringExecution:      - weight: 1        podAffinityTerm:          labelSelector:            matchExpressions:            - key: app              operator: In              values:              - node-affinity-pod          topologyKey: kubernetes.io/hostname</code></pre><p>ä¸Šé¢çš„podæˆ‘ä»¬è§£è¯»ä¸€ä¸‹:<br>1ã€POD éœ€è¦è°ƒåº¦åˆ°æŸä¸ªæŒ‡å®šçš„ä¸»æœºä¸Šï¼Œè‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†è¿™æ ·çš„ PODï¼šè¿™ä¸ª POD æœ‰ä¸€ä¸ª<code>app=busybox-pod</code>çš„ labelã€‚<br>2ã€<code>podAntiAffinity</code>åˆ™æ˜¯å¸Œæœ›æœ€å¥½ä¸è¦è°ƒåº¦åˆ°è¿™æ ·çš„èŠ‚ç‚¹ï¼šè¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†æŸä¸ª PODï¼Œè€Œè¿™ä¸ª POD æœ‰app=node-affinity-podçš„ labelã€‚<br>3ã€æ ¹æ®å‰é¢ä¸¤ä¸ª POD çš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥é¢„è§ä¸Šé¢è¿™ä¸ª POD åº”è¯¥ä¼šè¢«è°ƒåº¦åˆ°192.168.56.11çš„èŠ‚ç‚¹ä¸Šï¼Œå› ä¸ºå‰é¢å®è·µçš„æ—¶å€™ã€with-nodename-busybox-podã€‘è¢«è°ƒåº¦åˆ°äº†192.168.56.11èŠ‚ç‚¹ï¼Œè€Œã€node-affinity-podã€‘è¢«è°ƒåº¦åˆ°äº†192.168.56.11ä»¥ä¸ºçš„èŠ‚ç‚¹ï¼Œæ­£å¥½æ»¡è¶³ä¸Šé¢çš„éœ€æ±‚ã€‚<br>é€šè¿‡describeæŸ¥çœ‹ï¼š</p><pre><code>Events:  Type    Reason                 Age   From                    Message  ----    ------                 ----  ----                    -------  Normal  Scheduled              53m   default-scheduler       Successfully assigned with-pod-affinity to 192.168.56.11  Normal  SuccessfulMountVolume  52m   kubelet, 192.168.56.11  MountVolume.SetUp succeeded for volume "default-token-5htws"  Normal  Pulling                52m   kubelet, 192.168.56.11  pulling image "nginx"  Normal  Pulled                 51m   kubelet, 192.168.56.11  Successfully pulled image "nginx"  Normal  Created                51m   kubelet, 192.168.56.11  Created container  Normal  Started                51m   kubelet, 192.168.56.11  Started container</code></pre><p>åœ¨labelSelectorå’Œ topologyKeyçš„åŒçº§ï¼Œè¿˜å¯ä»¥å®šä¹‰ namespaces åˆ—è¡¨ï¼Œè¡¨ç¤ºåŒ¹é…å“ªäº› namespace é‡Œé¢çš„ podï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šåŒ¹é…å®šä¹‰çš„ pod æ‰€åœ¨çš„ namespaceï¼›å¦‚æœå®šä¹‰äº†è¿™ä¸ªå­—æ®µï¼Œä½†æ˜¯å®ƒçš„å€¼ä¸ºç©ºï¼Œåˆ™åŒ¹é…æ‰€æœ‰çš„ namespacesã€‚</p><p>soï¼Œä»¥ä¸Šæˆ‘ä»¬åˆ›å»ºçš„å››ä¸ªä¾‹å­ç»“æœä¸ºä¸‹:</p><pre><code>[root@linux-node1 affinity_study]# kubectl get pods -o wideNAME                          READY     STATUS    RESTARTS   AGE       IP           NODEwith-node-affinity            1/1       Running   2          10h       10.2.70.16   192.168.56.14with-node-selector            1/1       Running   0          8m        10.2.70.15   192.168.56.14with-nodename                 1/1       Running   1          11h       10.2.88.9    192.168.56.11with-pod-affinity             1/1       Running   0          10h       10.2.88.10   192.168.56.11</code></pre><h2 id="5-æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰"><a href="#5-æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰" class="headerlink" title="5. æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰"></a>5. æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰</h2><p>å¯¹äºnodeAffinityæ— è®ºæ˜¯ç¡¬ç­–ç•¥è¿˜æ˜¯è½¯ç­–ç•¥æ–¹å¼ï¼Œéƒ½æ˜¯è°ƒåº¦ POD åˆ°é¢„æœŸèŠ‚ç‚¹ä¸Šï¼Œè€ŒTaintsæ°å¥½ä¸ä¹‹ç›¸åï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º Taints ï¼Œé™¤é POD ä¹Ÿè¢«æ ‡è¯†ä¸ºå¯ä»¥å®¹å¿æ±¡ç‚¹èŠ‚ç‚¹ï¼Œå¦åˆ™è¯¥ Taints èŠ‚ç‚¹ä¸ä¼šè¢«è°ƒåº¦podã€‚</p><p>æ¯”å¦‚ç”¨æˆ·å¸Œæœ›æŠŠ Master èŠ‚ç‚¹ä¿ç•™ç»™ Kubernetes ç³»ç»Ÿç»„ä»¶ä½¿ç”¨ï¼Œæˆ–è€…æŠŠä¸€ç»„å…·æœ‰ç‰¹æ®Šèµ„æºé¢„ç•™ç»™æŸäº› PODï¼Œåˆ™æ±¡ç‚¹å°±å¾ˆæœ‰ç”¨äº†ï¼ŒPOD ä¸ä¼šå†è¢«è°ƒåº¦åˆ° taint æ ‡è®°è¿‡çš„èŠ‚ç‚¹ã€‚taint æ ‡è®°èŠ‚ç‚¹ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><h6 id="5-1-è®¾ç½®æ±¡ç‚¹"><a href="#5-1-è®¾ç½®æ±¡ç‚¹" class="headerlink" title="5.1 è®¾ç½®æ±¡ç‚¹"></a>5.1 è®¾ç½®æ±¡ç‚¹</h6><pre><code> kubectl taint node [node] key=value[effect]         å…¶ä¸­[effect] å¯å–å€¼ï¼š [ NoSchedule | PreferNoSchedule | NoExecute ]       NoSchedule ï¼šä¸€å®šä¸èƒ½è¢«è°ƒåº¦ã€‚POD ä¸ä¼šè¢«è°ƒåº¦åˆ°æ ‡è®°ä¸º taints èŠ‚ç‚¹ã€‚       PreferNoScheduleï¼šå°½é‡ä¸è¦è°ƒåº¦ã€‚NoSchedule çš„è½¯ç­–ç•¥ç‰ˆæœ¬ã€‚       NoExecuteï¼šä¸ä»…ä¸ä¼šè°ƒåº¦ï¼Œè¿˜ä¼šé©±é€Nodeä¸Šå·²æœ‰çš„Podã€‚  ç¤ºä¾‹ï¼škubectl taint node 192.168.56.11 key1=value1:NoSchedule</code></pre><h6 id="5-2-å»é™¤æ±¡ç‚¹"><a href="#5-2-å»é™¤æ±¡ç‚¹" class="headerlink" title="5.2 å»é™¤æ±¡ç‚¹"></a>5.2 å»é™¤æ±¡ç‚¹</h6><pre><code>#æ¯”å¦‚è®¾ç½®æ±¡ç‚¹ï¼š    kubectl taint nodes 192.168.56.11 key1=value1:NoSchedule    kubectl taint nodes 192.168.56.11 key2=value2:NoExecute    kubectl taint nodes 192.168.56.11 key3=value3:PreferNoSchedule #å»é™¤æŒ‡å®škeyåŠå…¶effectï¼š    kubectl taint nodes 192.168.56.11 key:[effect]-    #(è¿™é‡Œçš„keyä¸ç”¨æŒ‡å®švalue)                 #å»é™¤æŒ‡å®škeyæ‰€æœ‰çš„effect:      kubectl taint nodes 192.168.56.11 key-  #ç¤ºä¾‹ï¼š     kubectl taint node 192.168.56.11 key1:NoSchedule-     kubectl taint node 192.168.56.11 key2:NoExecute-     kubectl taint node 192.168.56.11 key3:PreferNoSchedule-     kubectl taint node 192.168.56.11 key3- (å»é™¤æŒ‡å®škeyçš„æ‰€æœ‰effct)</code></pre><h6 id="5-3-å®è·µ"><a href="#5-3-å®è·µ" class="headerlink" title="5.3 å®è·µ"></a>5.3 å®è·µ</h6><h6 id="5-3-1-ç»™èŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹"><a href="#5-3-1-ç»™èŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹" class="headerlink" title="# 5.3.1 ç»™èŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹"></a># 5.3.1 ç»™èŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹</h6><p>é¦–å…ˆæˆ‘çš„ç¯å¢ƒä¸­è¿˜æ²¡æœ‰è®¾ç½®æ±¡ç‚¹ï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ä¾‹å­(nginx-deployment.yaml):</p><pre><code>apiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-pod  labels:    app: nginx-podspec:  replicas: 10 # è¿™é‡Œä¸ºäº†å®è·µæ•ˆæœç‰¹æ„è®¾å®šäº†10ä¸ªå‰¯æœ¬  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      containers:      - name: nginx        image: nginx:latest        imagePullPolicy: IfNotPresent        ports:        - containerPort: 80        # éƒ¨ç½²ç»“æœ:[root@linux-node1 ~]# kubectl get pods -o wide | grep nginxnginx-pod-7d9f9876cc-95fj2   1/1       Running   0          1m        10.2.70.26   192.168.56.14nginx-pod-7d9f9876cc-jclvf   1/1       Running   0          1m        10.2.44.28   192.168.56.13nginx-pod-7d9f9876cc-k2m6x   1/1       Running   0          1m        10.2.44.31   192.168.56.13nginx-pod-7d9f9876cc-l74hf   1/1       Running   0          1m        10.2.88.15   192.168.56.11nginx-pod-7d9f9876cc-n8g6c   1/1       Running   0          1m        10.2.44.29   192.168.56.13nginx-pod-7d9f9876cc-p2cft   1/1       Running   0          1m        10.2.88.14   192.168.56.11nginx-pod-7d9f9876cc-p7hvt   1/1       Running   0          1m        10.2.69.25   192.168.56.12nginx-pod-7d9f9876cc-rjj97   1/1       Running   0          1m        10.2.70.27   192.168.56.14nginx-pod-7d9f9876cc-t2wlw   1/1       Running   0          1m        10.2.69.26   192.168.56.12nginx-pod-7d9f9876cc-whkx9   1/1       Running   0          1m        10.2.44.30   192.168.56.13</code></pre><p>ä»¥ä¸Šä¾‹å­å¯ä»¥çœ‹å‡ºåœ¨æˆ‘çš„ç¯å¢ƒä¸­å·²ç»åˆ†é…åˆ°äº†æ¯ä¸ªèŠ‚ç‚¹åŒ…æ‹¬æˆ‘ä»¬æ¥ä¸‹æ¥å‡†å¤‡è®¾ç½®æ±¡ç‚¹çš„èŠ‚ç‚¹192.168.56.11ã€‚</p><p>ä¸‹é¢æˆ‘æŠŠmasterèŠ‚ç‚¹192.168.56.11 è®¾ç½®æ±¡ç‚¹(è¿™é‡Œæˆ‘ç”¨çš„effectæ˜¯NoSchedule)</p><pre><code>[root@linux-node1 affinity_study]# kubectl taint nodes 192.168.56.11 server_type=k8s_system:NoSchedulenode "192.168.56.11" tainted# ç„¶åéƒ¨ç½²ä¸‹é¢è¿™ä¸ªè®¾ç½®ä¾‹å­:apiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-pod-taints  labels:    app: nginx-pod-taintsspec:  replicas: 10 # è¿™é‡Œä¸ºäº†å®è·µæ•ˆæœç‰¹æ„è®¾å®šäº†10ä¸ªå‰¯æœ¬  selector:    matchLabels:      app: nginx-taints  template:    metadata:      labels:        app: nginx-taints    spec:      containers:      - name: nginx-taints        image: nginx:latest        imagePullPolicy: IfNotPresent        ports:        - containerPort: 80# éƒ¨ç½²ç»“æœ:[root@linux-node1 ~]# kubectl get pods -o wide | grep nginx-pod-taintsnginx-pod-taints-57757d7677-5h6nj   1/1       Running   0          2m        10.2.69.31   192.168.56.12nginx-pod-taints-57757d7677-dkd8h   1/1       Running   0          2m        10.2.70.34   192.168.56.14nginx-pod-taints-57757d7677-f2vdn   1/1       Running   0          2m        10.2.44.38   192.168.56.13nginx-pod-taints-57757d7677-fnx2n   1/1       Running   0          2m        10.2.44.36   192.168.56.13nginx-pod-taints-57757d7677-gsc5g   1/1       Running   0          2m        10.2.70.32   192.168.56.14nginx-pod-taints-57757d7677-kjl89   1/1       Running   0          2m        10.2.44.35   192.168.56.13nginx-pod-taints-57757d7677-mqx27   1/1       Running   0          2m        10.2.70.33   192.168.56.14nginx-pod-taints-57757d7677-skdd4   1/1       Running   0          2m        10.2.69.32   192.168.56.12nginx-pod-taints-57757d7677-spwfh   1/1       Running   0          2m        10.2.69.30   192.168.56.12nginx-pod-taints-57757d7677-tpcm8   1/1       Running   0          2m        10.2.44.37   192.168.56.13</code></pre><p>ä»¥ä¸Šä¾‹å­å¯ä»¥çœ‹å‡ºæˆ‘ä»¬å°†masterèŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹ä¹‹åè°ƒåº¦å™¨å¹¶æ²¡æœ‰æŠŠpodè°ƒåº¦åˆ°masterèŠ‚ç‚¹ä¸Šã€‚<br>è¿™é‡Œæˆ‘é€‰æ‹©çš„effectæ˜¯NoScheduleï¼Œä¹Ÿå°±æ˜¯ä¸€å®šä¸è¦è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚</p><h6 id="5-3-2-ç»™éƒ¨ç½²é…ç½®è®¾ç½®å®¹å¿æ€§"><a href="#5-3-2-ç»™éƒ¨ç½²é…ç½®è®¾ç½®å®¹å¿æ€§" class="headerlink" title="# 5.3.2 ç»™éƒ¨ç½²é…ç½®è®¾ç½®å®¹å¿æ€§"></a># 5.3.2 ç»™éƒ¨ç½²é…ç½®è®¾ç½®å®¹å¿æ€§</h6><p>é¦–å…ˆ æˆ‘ä»¬ä¸Šé¢è®¾ç½®äº†æ±¡ç‚¹<br>å³:</p><pre><code>  taints:  - effect: NoSchedule    key: server_type    value: k8s_system</code></pre><p>ç„¶åæˆ‘ä»¬éƒ¨ç½²ä»¥ä¸‹ä¾‹å­(test-tolertations.yaml)</p><pre><code>apiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-pod-taints-tolerations  labels:    app: nginx-pod-taints-tolerationsspec:  replicas: 10 # è¿™é‡Œä¸ºäº†å®è·µæ•ˆæœç‰¹æ„è®¾å®šäº†10ä¸ªå‰¯æœ¬  selector:    matchLabels:      app: nginx-taints-tolerations  template:    metadata:      labels:        app: nginx-taints-tolerations    spec:      # è®¾ç½®å®¹å¿æ€§      tolerations:      - key: "server_type"        operator: "Equal"        value: "k8s_system"        effect: "NoSchedule"      containers:      - name: nginx-taints-tolerations        image: nginx:latest        imagePullPolicy: IfNotPresent        ports:        - containerPort: 80# éƒ¨ç½²ç»“æœ:[root@linux-node1 affinity_study]# kubectl get pods -o wide  | grep nginx-pod-taints-tolerationsnginx-pod-taints-tolerations-5b4988bd4-2pk46   1/1       Running   0          29m       10.2.69.33   192.168.56.12nginx-pod-taints-tolerations-5b4988bd4-854xx   1/1       Running   0          29m       10.2.70.35   192.168.56.14nginx-pod-taints-tolerations-5b4988bd4-88xrt   1/1       Running   0          29m       10.2.69.34   192.168.56.12nginx-pod-taints-tolerations-5b4988bd4-8czpg   1/1       Running   0          29m       10.2.88.17   192.168.56.11nginx-pod-taints-tolerations-5b4988bd4-czdss   1/1       Running   0          21m       10.2.44.41   192.168.56.13nginx-pod-taints-tolerations-5b4988bd4-dj6mw   1/1       Running   0          29m       10.2.88.16   192.168.56.11nginx-pod-taints-tolerations-5b4988bd4-g4ltd   1/1       Running   0          29m       10.2.44.39   192.168.56.13nginx-pod-taints-tolerations-5b4988bd4-npthj   1/1       Running   0          29m       10.2.44.40   192.168.56.13nginx-pod-taints-tolerations-5b4988bd4-ptlqg   1/1       Running   0          29m       10.2.88.18   192.168.56.11nginx-pod-taints-tolerations-5b4988bd4-t9gs6   1/1       Running   0          29m       10.2.69.35   192.168.56.12</code></pre><p>ä»¥ä¸Šå®è·µæˆ‘ä»¬è§£è¯»ä¸€ä¸‹:<br>1. åœ¨èŠ‚ç‚¹master 192.168.56.11ä¸Šé¢è®¾ç½®äº†æ±¡ç‚¹ï¼›ä½†æœŸæœ›è¯¥èŠ‚ç‚¹èƒ½å®¹å¿è°ƒåº¦;<br>2. äºæ˜¯é€šè¿‡è®¾ç½®tolerationsæ¥å®ç°ï¼Œå…¶ä¸­Podè¦å®¹å¿çš„æœ‰æ±¡ç‚¹çš„Nodeçš„keyæ˜¯server_type Equal k8s_system,æ•ˆæœæ˜¯NoSchedule.<br>3. é€šè¿‡è®¾ç½®å®¹å¿æœºåˆ¶ç»“æœä¸é¢„æœŸç›¸ç¬¦ã€‚</p><p>å¯¹äºtolerationså±æ€§çš„å†™æ³•ï¼š</p><pre><code>å…¶ä¸­çš„keyã€valueã€effect ä¸Nodeçš„Taintè®¾ç½®éœ€ä¿æŒä¸€è‡´ï¼Œ è¿˜æœ‰ä»¥ä¸‹å‡ ç‚¹è¯´æ˜ï¼š     1ã€å¦‚æœoperatorçš„å€¼æ˜¯Existsï¼Œåˆ™valueå±æ€§å¯çœç•¥ã€‚     2ã€å¦‚æœoperatorçš„å€¼æ˜¯Equalï¼Œåˆ™è¡¨ç¤ºå…¶keyä¸valueä¹‹é—´çš„å…³ç³»æ˜¯equal(ç­‰äº)ã€‚     3ã€å¦‚æœä¸æŒ‡å®šoperatorå±æ€§ï¼Œåˆ™é»˜è®¤å€¼ä¸ºEqualã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªç‰¹æ®Šå€¼ï¼š     1ã€ç©ºçš„key å¦‚æœå†é…åˆExists å°±èƒ½åŒ¹é…æ‰€æœ‰çš„keyä¸value ï¼Œä¹Ÿæ˜¯æ˜¯èƒ½å®¹å¿æ‰€æœ‰nodeçš„æ‰€æœ‰Taintsã€‚     2ã€ç©ºçš„effect åŒ¹é…æ‰€æœ‰çš„effectã€‚</code></pre><h6 id="5-3-3-å…¶ä»–"><a href="#5-3-3-å…¶ä»–" class="headerlink" title="# 5.3.3 å…¶ä»–"></a># 5.3.3 å…¶ä»–</h6><p>ä¸€ä¸ªnodeä¸Šå¯ä»¥æœ‰å¤šä¸ªæ±¡ç‚¹ï¼š</p><pre><code>[root@linux-node1 affinity_study]# kubectl describe node/192.168.56.11................Taints:             server_type=k8s_system:NoSchedule                    test=wahaha:PreferNoSchedule................</code></pre><p>å¦‚æœæŒ‰ç…§æˆ‘ä¸Šé¢çš„ä¾‹å­æ¥çš„è¯ç»“æœå°†ä¸ä¼šæœ‰ä»»ä½•podè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œå› ä¸ºä¸Šè¿°æˆ‘åªå®¹å¿äº†ä¸€ä¸ªæ±¡ç‚¹ï¼›æ‰€ä»¥å¯ä»¥æ–°åŠ ä¸€ä¸ªæ±¡ç‚¹å®¹å¿:</p><pre><code>[root@linux-node1 affinity_study]# more test-tolertations.yaml................          tolerations:      - key: "server_type"        operator: "Equal"        value: "k8s_system"        effect: "NoSchedule"      - key: "test"        operator: "Equal"        value: "wahaha"        effect: "PreferNoSchedule"................</code></pre><p>é‡æ–°éƒ¨ç½²åç»“æœä¹Ÿå¯ä»¥é¢„è§ åªè¦ä¸¤ä¸ªå®¹å¿æ»¡è¶³å°±å¯ä»¥è°ƒåº¦è¿‡å»å•¦~</p><p>è®¾ç½®å®¹å¿çš„æ•ˆæœï¼š</p><ul><li>å¦‚æœåœ¨è®¾ç½®nodeçš„Taints(æ±¡ç‚¹)ä¹‹å‰ï¼Œå°±å·²ç»è¿è¡Œäº†ä¸€äº›Podï¼Œé‚£ä¹ˆè¿™äº›Podæ˜¯å¦è¿˜èƒ½ç»§ç»­åœ¨æ­¤Nodeä¸Šè¿è¡Œï¼Ÿ è¿™å°±è¦çœ‹è®¾ç½®Taintsæ±¡ç‚¹æ—¶çš„effect(æ•ˆæœ)äº†ã€‚</li><li>å¦‚æœeffectçš„å€¼æ˜¯NoScheduleæˆ–PreferNoScheduleï¼Œé‚£ä¹ˆå·²è¿è¡Œçš„Podä»ç„¶å¯ä»¥è¿è¡Œï¼Œåªæ˜¯æ–°Pod(å¦‚æœæ²¡æœ‰å®¹å¿)ä¸ä¼šå†å¾€ä¸Šè°ƒåº¦ã€‚</li><li>å¦‚æœ pod ä¸èƒ½å¿å—effect å€¼ä¸º NoExecute çš„ taintï¼Œé‚£ä¹ˆ pod å°†é©¬ä¸Šè¢«é©±é€</li><li>å¦‚æœ pod èƒ½å¤Ÿå¿å—effect å€¼ä¸º NoExecute çš„ taintï¼Œä½†æ˜¯åœ¨ toleration å®šä¹‰ä¸­æ²¡æœ‰æŒ‡å®š tolerationSecondsï¼Œåˆ™ pod è¿˜ä¼šä¸€ç›´åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</li><li>å¦‚æœ pod èƒ½å¤Ÿå¿å—effect å€¼ä¸º NoExecute çš„ taintï¼Œè€Œä¸”æŒ‡å®šäº† tolerationSecondsï¼Œåˆ™ pod è¿˜èƒ½åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šç»§ç»­è¿è¡Œè¿™ä¸ªæŒ‡å®šçš„æ—¶é—´é•¿åº¦ã€‚ è™½ç„¶æ˜¯ç«‹åˆ»è¢«é©±é€ï¼Œä½†æ˜¯K8Sä¸ºäº†å½°æ˜¾äººæ€§åŒ–ï¼Œåˆç»™å…·æœ‰NoExecuteæ•ˆæœçš„æ±¡ç‚¹ï¼Œ åœ¨å®¹å¿å±æ€§ä¸­æœ‰ä¸€ä¸ªå¯é€‰çš„tolerationSecondså­—æ®µï¼Œç”¨æ¥è®¾ç½®è¿™äº›Podè¿˜å¯ä»¥åœ¨è¿™ä¸ªNodeä¹‹ä¸Šè¿è¡Œå¤šä¹…ï¼Œç»™å®ƒä»¬ä¸€ç‚¹å®½é™çš„æ—¶é—´ï¼Œåˆ°æ—¶é—´æ‰é©±é€ã€‚</li></ul><p>ä¸åŒçš„éƒ¨ç½²å¯åŠ¨æ–¹å¼ï¼š</p><ul><li><p>å¦‚æœæ˜¯ä»¥Podæ¥å¯åŠ¨çš„ï¼Œé‚£ä¹ˆPodè¢«é©±é€åï¼Œ å°†ä¸ä¼šå†è¢«è¿è¡Œï¼Œå°±ç­‰äºæŠŠå®ƒåˆ é™¤äº†ã€‚</p></li><li><p>å¦‚æœæ˜¯deployment/rcï¼Œé‚£ä¹ˆåˆ é™¤çš„podä¼šå†å…¶å®ƒèŠ‚ç‚¹è¿è¡Œã€‚</p></li><li><p>å¦‚æœæ˜¯DaemonSetåœ¨æ­¤Nodeä¸Šå¯åŠ¨çš„Podï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šå†è¢«è¿è¡Œï¼Œç›´åˆ°Nodeä¸Šçš„NoExecuteæ±¡è¢«å»é™¤æˆ–è€…Podå®¹å¿ã€‚</p><p>#è®¾ç½®Podçš„å®½é™æ—¶é—´<br>spec:<br>  tolerations: #è®¾ç½®å®¹å¿æ€§</p><ul><li>key: â€œtestâ€<br>operator: â€œEqualâ€ #å¦‚æœæ“ä½œç¬¦ä¸ºExistsï¼Œé‚£ä¹ˆvalueå±æ€§å¯çœç•¥<br>value: â€œ16â€<br>effect: â€œwahahaâ€<br>tolerationSeconds: 180 <h1 id="å¦‚æœè¿è¡Œæ­¤Podçš„Nodeï¼Œè¢«è®¾ç½®äº†å…·æœ‰NoExecuteæ•ˆæœçš„Taint-æ±¡ç‚¹-ï¼Œè¿™ä¸ªPodå°†åœ¨å­˜æ´»180såæ‰è¢«é©±é€ã€‚"><a href="#å¦‚æœè¿è¡Œæ­¤Podçš„Nodeï¼Œè¢«è®¾ç½®äº†å…·æœ‰NoExecuteæ•ˆæœçš„Taint-æ±¡ç‚¹-ï¼Œè¿™ä¸ªPodå°†åœ¨å­˜æ´»180såæ‰è¢«é©±é€ã€‚" class="headerlink" title="å¦‚æœè¿è¡Œæ­¤Podçš„Nodeï¼Œè¢«è®¾ç½®äº†å…·æœ‰NoExecuteæ•ˆæœçš„Taint(æ±¡ç‚¹)ï¼Œè¿™ä¸ªPodå°†åœ¨å­˜æ´»180såæ‰è¢«é©±é€ã€‚"></a>å¦‚æœè¿è¡Œæ­¤Podçš„Nodeï¼Œè¢«è®¾ç½®äº†å…·æœ‰NoExecuteæ•ˆæœçš„Taint(æ±¡ç‚¹)ï¼Œè¿™ä¸ªPodå°†åœ¨å­˜æ´»180såæ‰è¢«é©±é€ã€‚</h1><h1 id="å¦‚æœæ²¡æœ‰è®¾ç½®tolerationSecondså­—æ®µï¼Œå°†æ°¸ä¹…è¿è¡Œã€‚"><a href="#å¦‚æœæ²¡æœ‰è®¾ç½®tolerationSecondså­—æ®µï¼Œå°†æ°¸ä¹…è¿è¡Œã€‚" class="headerlink" title="å¦‚æœæ²¡æœ‰è®¾ç½®tolerationSecondså­—æ®µï¼Œå°†æ°¸ä¹…è¿è¡Œã€‚"></a>å¦‚æœæ²¡æœ‰è®¾ç½®tolerationSecondså­—æ®µï¼Œå°†æ°¸ä¹…è¿è¡Œã€‚</h1></li></ul></li></ul><p>é€šè¿‡å¯¹Taintså’ŒTolerationsçš„äº†è§£ï¼Œå¯ä»¥çŸ¥é“ï¼Œé€šè¿‡å®ƒä»¬å¯ä»¥è®©æŸäº›ç‰¹å®šåº”ç”¨ï¼Œç‹¬å ä¸€ä¸ªNodeï¼Œç»™ç‰¹å®šçš„Nodeè®¾ç½®ä¸€ä¸ªTaintï¼Œåªè®©æŸäº›ç‰¹å®šçš„åº”ç”¨æ¥å®¹å¿è¿™äº›æ±¡ç‚¹ï¼Œå®¹å¿åå°±æœ‰å¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°æ­¤ç‰¹å®šNodeï¼Œä½†æ˜¯ä¹Ÿä¸ä¸€å®šä¼šè°ƒåº¦ç»™æ­¤ç‰¹å®šNodeï¼Œè®¾ç½®å®¹å¿å¹¶ä¸é˜»æ­¢è°ƒåº¦å™¨è°ƒåº¦ç»™å…¶å®ƒNodeï¼Œé‚£ä¹ˆå¦‚ä½•è®©ç‰¹å®šåº”ç”¨çš„Nodeï¼Œåªèƒ½è¢«è°ƒåº¦åˆ°æ­¤ç‰¹å®šçš„Nodeå‘¢ï¼Œè¿™å°±è¦ç»“åˆNodeAffinityèŠ‚ç‚¹äº²å’Œæ€§ï¼Œç»™Nodeæ‰“ä¸ªæ ‡ç­¾ï¼Œç„¶ååœ¨Podå±æ€§é‡Œè®¾ç½®NodeAffinityåˆ°Nodeã€‚å¦‚æ­¤å°±èƒ½è¾¾åˆ°è¦æ±‚äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubernetesè°ƒåº¦ä¹‹NodeSelector</title>
      <link href="/2018/12/03/kubernetes-diao-du-zhinodeselector-trashed/"/>
      <url>/2018/12/03/kubernetes-diao-du-zhinodeselector-trashed/</url>
      
        <content type="html"><![CDATA[<h2 id="1-NodeName"><a href="#1-NodeName" class="headerlink" title="1 NodeName"></a>1 NodeName</h2><p>Pod.spec.nodeNameç”¨äºå¼ºåˆ¶çº¦æŸå°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Šï¼Œè¿™é‡Œè¯´æ˜¯â€œè°ƒåº¦â€ï¼Œä½†å…¶å®æŒ‡å®šäº†nodeNameçš„Podä¼šç›´æ¥è·³è¿‡Schedulerçš„è°ƒåº¦é€»è¾‘ï¼Œç›´æ¥å†™å…¥PodListåˆ—è¡¨ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯<code>å¼ºåˆ¶åŒ¹é…</code>ã€‚<br>ä¾‹å­ï¼š</p><pre><code>apiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-test  labels:    app: nginxspec:  replicas: 3  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      nodeName: 192.168.56.13 # æŒ‡å®špodè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹      containers:      - name: nginx        image: nginx:latest        imagePullPolicy: IfNotPresent # é•œåƒæ‹‰å–ç­–ç•¥        ports:        - containerPort: 80</code></pre><h2 id="2-NodeSelector"><a href="#2-NodeSelector" class="headerlink" title="2 NodeSelector"></a>2 NodeSelector</h2><p>Pod.spec.nodeSelectoræ˜¯é€šè¿‡kubernetesçš„label-selectoræœºåˆ¶è¿›è¡ŒèŠ‚ç‚¹é€‰æ‹©ï¼Œç”±schedulerè°ƒåº¦ç­–ç•¥MatchNodeSelectorè¿›è¡ŒlabelåŒ¹é…ï¼Œè°ƒåº¦podåˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯<code>å¼ºåˆ¶çº¦æŸ</code>ã€‚å¯ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨çš„æ­¥éª¤ä¸ºï¼š</p><p>Nodeæ·»åŠ labelæ ‡è®°</p><h4 id="æ ‡è®°è§„åˆ™ï¼š"><a href="#æ ‡è®°è§„åˆ™ï¼š" class="headerlink" title="æ ‡è®°è§„åˆ™ï¼š"></a>æ ‡è®°è§„åˆ™ï¼š</h4><pre><code>kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;=&lt;label-value&gt;kubectl label nodes 192.168.56.13 server_type=game_server</code></pre><h4 id="ç¡®è®¤æ ‡è®°"><a href="#ç¡®è®¤æ ‡è®°" class="headerlink" title="ç¡®è®¤æ ‡è®°"></a>ç¡®è®¤æ ‡è®°</h4><pre><code>[root@linux-node1 ~]#  kubectl get nodes 192.168.56.14 --show-labelsNAME            STATUS    ROLES     AGE       VERSION   LABELS192.168.56.14   Ready     &lt;none&gt;    81d       v1.10.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=192.168.56.14,server_type=game_serverPodå®šä¹‰ä¸­æ·»åŠ nodeSelectorapiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-test  labels:    app: nginxspec:  replicas: 3  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      containers:      - name: nginx        image: nginx:latest        imagePullPolicy: IfNotPresent        ports:        - containerPort: 80      nodeSelector:         server_type: game_server #æŒ‡å®šè°ƒåº¦èŠ‚ç‚¹ä¸ºå¸¦æœ‰labelæ ‡è®°ä¸ºserver_type=game_server</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus å®è·µ</title>
      <link href="/2018/11/16/prometheus-e5-ae-9e-e8-b7-b5/"/>
      <url>/2018/11/16/prometheus-e5-ae-9e-e8-b7-b5/</url>
      
        <content type="html"><![CDATA[<h1 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h1><p>Serverç«¯å®‰è£… <code>prometheus</code> / <code>alertmanager</code> / <code>node_expoter</code></p><h2 id="ä¸€ã€å®‰è£…prometheus-server"><a href="#ä¸€ã€å®‰è£…prometheus-server" class="headerlink" title="ä¸€ã€å®‰è£…prometheus server"></a>ä¸€ã€å®‰è£…prometheus server</h2><h3 id="0-è·å–è½¯ä»¶åŒ…-ç•¥-ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#0-è·å–è½¯ä»¶åŒ…-ç•¥-ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="0.è·å–è½¯ä»¶åŒ…(ç•¥)ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶"></a>0.è·å–è½¯ä»¶åŒ…(ç•¥)ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶</h3><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tar</span> -xf ./packages/alertmanager-<span class="number">0</span>.<span class="number">15</span>.<span class="number">3</span>.linux-amd64.tar.gz</span><br><span class="line"><span class="attribute">mv</span> alertmanager-<span class="number">0</span>.<span class="number">15</span>.<span class="number">3</span>.linux-amd64/alertmanager /usr/local/sbin/</span><br></pre></td></tr></tbody></table></figure><h3 id="1-åˆ›å»ºè¿è¡Œç”¨æˆ·"><a href="#1-åˆ›å»ºè¿è¡Œç”¨æˆ·" class="headerlink" title="1.åˆ›å»ºè¿è¡Œç”¨æˆ·"></a>1.åˆ›å»ºè¿è¡Œç”¨æˆ·</h3><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adduser -M -s <span class="regexp">/sbin/</span>nologin prometheus</span><br></pre></td></tr></tbody></table></figure><h3 id="2-åˆ›å»ºç”¨æˆ·æ‰€æœ‰è€…ç›®å½•"><a href="#2-åˆ›å»ºç”¨æˆ·æ‰€æœ‰è€…ç›®å½•" class="headerlink" title="2.åˆ›å»ºç”¨æˆ·æ‰€æœ‰è€…ç›®å½•"></a>2.åˆ›å»ºç”¨æˆ·æ‰€æœ‰è€…ç›®å½•</h3><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºprometheus serverè¿è¡Œçš„ç›®å½•ä¸»è¦å­˜æ”¾é…ç½®æ–‡ä»¶</span></span><br><span class="line">mdkir <span class="regexp">/usr/</span>local<span class="regexp">/share/</span>prometheus/prometheus_server -p</span><br><span class="line">chown -R prometheus:prometheus  <span class="regexp">/usr/</span>local<span class="regexp">/share/</span>prometheus</span><br><span class="line"><span class="comment"># åˆ›å»ºprometheus serveræ•°æ®å­˜å‚¨ç›®å½•</span></span><br><span class="line">mkdir <span class="regexp">/var/</span>lib<span class="regexp">/prometheus/</span>data</span><br><span class="line">chown -R prometheus:prometheus  <span class="regexp">/var/</span>lib<span class="regexp">/prometheus/</span>data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºprometheus alertmanagerè¿è¡Œçš„ç›®å½•ä¸»è¦å­˜æ”¾é…ç½®æ–‡ä»¶</span></span><br><span class="line">mdkir <span class="regexp">/usr/</span>local<span class="regexp">/share/</span>prometheus/prometheus_alertmanager</span><br><span class="line"><span class="comment"># åˆ›å»ºprometheus alertmanageræ•°æ®å­˜å‚¨ç›®å½•</span></span><br><span class="line">mkdir <span class="regexp">/var/</span>lib<span class="regexp">/alertmanager/</span>data -p</span><br><span class="line">chown -R prometheus:prometheus  <span class="regexp">/var/</span>lib<span class="regexp">/alertmanager/</span>data</span><br></pre></td></tr></tbody></table></figure><h3 id="3-åˆ›å»ºprometheus-server-systemdæ–‡ä»¶"><a href="#3-åˆ›å»ºprometheus-server-systemdæ–‡ä»¶" class="headerlink" title="3.åˆ›å»ºprometheus server systemdæ–‡ä»¶"></a>3.åˆ›å»ºprometheus server systemdæ–‡ä»¶</h3><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cp</span> ./<span class="keyword">conf</span>/systemd_conf/prometheus.service /etc/systemd/<span class="built_in">system</span>/</span><br><span class="line"></span><br><span class="line"># æœåŠ¡æ“ä½œ</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start prometheus</span><br><span class="line">systemctl enable prometheus</span><br><span class="line">systemctl status prometheus</span><br><span class="line"></span><br><span class="line"># ä¿è¯ç«¯å£ä»¥åŠè¿›ç¨‹</span><br><span class="line"><span class="keyword">ps</span> aux | <span class="keyword">grep</span> prometheus | <span class="keyword">grep</span> -v <span class="keyword">grep</span>  &amp;&amp; ss -tunl | <span class="keyword">grep</span> <span class="number">9090</span> | <span class="keyword">grep</span> -v <span class="keyword">grep</span></span><br></pre></td></tr></tbody></table></figure><h3 id="4-è®¿é—®"><a href="#4-è®¿é—®" class="headerlink" title="4.è®¿é—®:"></a>4.è®¿é—®:</h3><figure class="highlight dts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//xxxxxxx:9090</span></span><br></pre></td></tr></tbody></table></figure><h2 id="äºŒã€å®‰è£…prometheus-AlertManager"><a href="#äºŒã€å®‰è£…prometheus-AlertManager" class="headerlink" title="äºŒã€å®‰è£…prometheus AlertManager"></a>äºŒã€å®‰è£…prometheus AlertManager</h2><h3 id="0-è·å–è½¯ä»¶åŒ…-ç•¥-ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶-1"><a href="#0-è·å–è½¯ä»¶åŒ…-ç•¥-ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶-1" class="headerlink" title="0.è·å–è½¯ä»¶åŒ…(ç•¥)ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶"></a>0.è·å–è½¯ä»¶åŒ…(ç•¥)ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶</h3><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tar</span> -xf ./packages/prometheus-<span class="number">2</span>.<span class="number">4</span>.<span class="number">2</span>.linux-amd64.tar.gz</span><br><span class="line"><span class="attribute">mv</span> prometheus-<span class="number">2</span>.<span class="number">4</span>.<span class="number">2</span>.linux-amd64/prometheus /usr/local/sbin/</span><br></pre></td></tr></tbody></table></figure><h3 id="1-åˆ›å»ºprometheus-alertmanager-systemdæ–‡ä»¶"><a href="#1-åˆ›å»ºprometheus-alertmanager-systemdæ–‡ä»¶" class="headerlink" title="1.åˆ›å»ºprometheus alertmanager systemdæ–‡ä»¶"></a>1.åˆ›å»ºprometheus alertmanager systemdæ–‡ä»¶</h3><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cp</span> ./<span class="keyword">conf</span>/systemd_conf/alertmanager.service /etc/systemd/<span class="built_in">system</span>/</span><br><span class="line"></span><br><span class="line"># æœåŠ¡æ“ä½œ</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start alertmanager</span><br><span class="line">systemctl enable alertmanager</span><br><span class="line">systemctl status alertmanager</span><br><span class="line"># ä¿è¯ç«¯å£ä»¥åŠè¿›ç¨‹</span><br><span class="line"><span class="keyword">ps</span> aux | <span class="keyword">grep</span> alertmanager | <span class="keyword">grep</span> -v <span class="keyword">grep</span>  &amp;&amp; ss -tunl | <span class="keyword">grep</span> <span class="number">9093</span> | <span class="keyword">grep</span> -v <span class="keyword">grep</span></span><br></pre></td></tr></tbody></table></figure><h3 id="2-å°†alertmanagerè·Ÿprometheus-serverç»“åˆ"><a href="#2-å°†alertmanagerè·Ÿprometheus-serverç»“åˆ" class="headerlink" title="2.å°†alertmanagerè·Ÿprometheus serverç»“åˆ"></a>2.å°†alertmanagerè·Ÿprometheus serverç»“åˆ</h3><p>ä¿®æ”¹prometheus serveré…ç½®:</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="symbol">/usr/local/share/prometheus/prometheus_server/prometheus.yml</span></span><br><span class="line"><span class="comment"># Alertmanager configuration</span></span><br><span class="line"><span class="params">alerting:</span></span><br><span class="line">  <span class="params">alertmanagers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">static_configs:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">targets:</span> ['localhost:<span class="number">9093</span>']</span><br></pre></td></tr></tbody></table></figure><h3 id="3-è®¿é—®"><a href="#3-è®¿é—®" class="headerlink" title="3.è®¿é—®:"></a>3.è®¿é—®:</h3><figure class="highlight dts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//xxxxxxx:9093</span></span><br></pre></td></tr></tbody></table></figure><h2 id="ä¸‰ã€å®‰è£…Node-Exporteræ”¶é›†ä¸»æœºä¿¡æ¯"><a href="#ä¸‰ã€å®‰è£…Node-Exporteræ”¶é›†ä¸»æœºä¿¡æ¯" class="headerlink" title="ä¸‰ã€å®‰è£…Node Exporteræ”¶é›†ä¸»æœºä¿¡æ¯"></a>ä¸‰ã€å®‰è£…Node Exporteræ”¶é›†ä¸»æœºä¿¡æ¯</h2><p>æ•°æ®æ”¶é›†çš„ä»»åŠ¡ç”±ä¸åŒçš„ exporter æ¥å®Œæˆï¼Œå¦‚æœè¦æ”¶é›† linux ä¸»æœºçš„ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ node exporterã€‚ç„¶åç”± Prometheus Server ä» node exporter ä¸Šæ‹‰å–ä¿¡æ¯ã€‚</p><h3 id="0-è·å–è½¯ä»¶åŒ…-ç•¥-ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶-2"><a href="#0-è·å–è½¯ä»¶åŒ…-ç•¥-ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶-2" class="headerlink" title="0.è·å–è½¯ä»¶åŒ…(ç•¥)ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶"></a>0.è·å–è½¯ä»¶åŒ…(ç•¥)ã€è§£å‹å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶</h3><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tar</span> -xf ./packages/node_exporter-<span class="number">0</span>.<span class="number">17</span>.<span class="number">0</span>-rc.<span class="number">0</span>.linux-amd64.tar.gz</span><br><span class="line"><span class="attribute">mv</span> node_exporter-<span class="number">0</span>.<span class="number">17</span>.<span class="number">0</span>-rc.<span class="number">0</span>.linux-amd64/node_exporter /usr/local/sbin/</span><br></pre></td></tr></tbody></table></figure><h3 id="1-æŠŠ-node-exporter-ä¹Ÿé…ç½®æˆé€šè¿‡-systemd-ç®¡ç†-åˆ›å»ºæ–‡ä»¶-etc-systemd-system-node-exporter-service"><a href="#1-æŠŠ-node-exporter-ä¹Ÿé…ç½®æˆé€šè¿‡-systemd-ç®¡ç†-åˆ›å»ºæ–‡ä»¶-etc-systemd-system-node-exporter-service" class="headerlink" title="1.æŠŠ node exporter ä¹Ÿé…ç½®æˆé€šè¿‡ systemd ç®¡ç†, åˆ›å»ºæ–‡ä»¶ /etc/systemd/system/node-exporter.service"></a>1.æŠŠ node exporter ä¹Ÿé…ç½®æˆé€šè¿‡ systemd ç®¡ç†, åˆ›å»ºæ–‡ä»¶ /etc/systemd/system/node-exporter.service</h3><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cp ./conf/systemd_conf/node_exporter.service  /etc/systemd/system/<span class="keyword">node</span><span class="title">-exporter</span>.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æœåŠ¡æ“ä½œ</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable <span class="keyword">node</span><span class="title">-exporter</span></span><br><span class="line">systemctl <span class="literal">start</span> <span class="keyword">node</span><span class="title">-exporter</span></span><br><span class="line">systemctl status <span class="keyword">node</span><span class="title">-exporter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿è¯ç«¯å£ä»¥åŠè¿›ç¨‹</span></span><br><span class="line">ps aux | grep node_exporter | grep -v grep  &amp;&amp; ss -tunl | grep <span class="number">9100</span> | grep -v grep</span><br></pre></td></tr></tbody></table></figure><p>Prometheus Server å¯ä»¥ä»ä¸åŒçš„ exporter ä¸Šæ‹‰å–æ•°æ®ï¼Œå¯¹äºä¸Šé¢çš„ node exporter æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Prometheus çš„static_configs æ¥æ‹‰å– node exporter çš„æ•°æ®ã€‚<code>conf/prometheus_server_conf/prometheus/prometheus.yml</code>ä¸­å·²ç»å®šä¹‰å¥½äº†</p><figure class="highlight 1c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">-</span> job_name<span class="punctuation">:</span> 'node'</span><br><span class="line">  static_configs<span class="punctuation">:</span></span><br><span class="line">  <span class="punctuation">-</span> targets<span class="punctuation">:</span> ['66.112.211.12:<span class="number">9100</span>']</span><br></pre></td></tr></tbody></table></figure><p>é‡å¯å„æœåŠ¡ï¼›é‡å¯å prometheus æœåŠ¡ä¼šæ¯éš” 15s ä» node exporter ä¸Šæ‹‰å–ä¸€æ¬¡æ•°æ®ã€‚<br>Prometheus Server æä¾›äº†ç®€æ˜“çš„ WebUI å¯ä»¥è¿›æ•°æ®æŸ¥è¯¢å¹¶å±•ç¤ºï¼Œå®ƒé»˜è®¤ç›‘å¬çš„ç«¯å£ä¸º 9090ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡ç®€å•çš„æŸ¥è¯¢æ¥éªŒè¯æœ¬æ–‡å®‰è£…é…ç½®çš„ç³»ç»Ÿã€‚</p><p><img src="/2018/11/16/prometheus-e5-ae-9e-e8-b7-b5/media/15423532371020/15423600125042.jpg"></p><p>å…³äºå„é¡¹æŒ‡æ ‡çš„è§„åˆ™è¿˜éœ€è¦é€šè¿‡ç¼–å†™ruleæ¡ç›®æ¥å®ç°ï¼›è¿™é‡Œç®€å•å®ç°äº†wechatè·Ÿemailçš„æŠ¥è­¦é…ç½®ï¼Œå…·ä½“å¯çœ‹è§„åˆ™é…ç½®æ–‡ä»¶<code>conf/prometheus_server_conf/prometheus/rules/hoststas-alert.rules</code>ä»¥åŠæŠ¥è­¦è§¦å‘é…ç½®æ–‡ä»¶<code>alertmanager_conf/alertmanager.yml</code>ï¼›</p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> monitor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flask RestApi åç«¯å¼€å‘é¡¹ç›®è¯´æ˜</title>
      <link href="/2018/10/17/flask-restapi-hou-duan-kai-fa-xiang-mu-shuo-ming/"/>
      <url>/2018/10/17/flask-restapi-hou-duan-kai-fa-xiang-mu-shuo-ming/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘ä¸€ç›´åœ¨åšçš„ä¸€ä¸ªé¡¹ç›®å°±æ˜¯æ‰“ç®—å°†ä¹‹å‰çš„MVCé£æ ¼çš„åå°,é‡æ„ä¸ºå‰åç«¯åˆ†ç¦»å¼,ç”±äºä¸ªäººå¯¹äºFlaskæ¡†æ¶ç†Ÿæ‚‰ç¨‹åº¦æ¯”èµ·Djangoæ¥æ›´ç†Ÿæ‚‰ä¸€äº›ï¼Œæ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©ä»–ä½œä¸ºå¼€å‘æ¡†æ¶æ¥è¿›è¡Œåç«¯çš„å¼€å‘ï¼Œç›®å‰å‘¢æ‰“ç®—çš„æ˜¯æŠŠåŸºç¡€çš„å¹³å°åŠŸèƒ½åšå‡ºæ¥ä½œä¸ºä¸€ä¸ªæ¨¡æ¿ï¼Œç„¶åé€šè¿‡è¿™ä¸ªæ¨¡æ¿å†å»ç»“åˆä¸šåŠ¡æ–¹é¢çš„å¼€å‘ã€‚å‰ç«¯æ–¹é¢æš‚æ—¶æœªå¼€å§‹ï¼Œç›®å‰åç«¯å¼€å‘è¿›åº¦:</p><hr><p>åŠŸèƒ½</p><p>å®Œæˆåº¦</p><p>methods</p><p>api</p><p>å¤‡æ³¨</p><p>ç”¨æˆ·æ³¨å†Œ</p><p>ğŸš€%100</p><p>POST</p><p>/auth/register</p><p>null</p><p>ç”¨æˆ·ç™»å½•</p><p>ğŸš€%100</p><p>POST</p><p>/auth/login</p><p>null</p><p>ç”¨æˆ·ç™»å‡º</p><p>ğŸš€%100</p><p>POST</p><p>/auth/logout</p><p>null</p><p>é‚®ä»¶ç¡®è®¤</p><p>ğŸš€%100</p><p>POST</p><p>/auth/confirm/{confirm_token}</p><p>null</p><p>Tokenåˆ·æ–°</p><p>ğŸš€%100</p><p>GET</p><p>/auth/refresh_token</p><p>null</p><p>ç”¨æˆ·è·å–</p><p>ğŸš€%100</p><p>GET</p><p>/user/</p><p>null</p><p>ç”¨æˆ·åˆ é™¤</p><p>ğŸš€%100</p><p>POST</p><p>/user/{email}</p><p>null</p><p>ç”¨æˆ·ç¦ç”¨/å¯ç”¨</p><p>ğŸš€%0</p><p>POST</p><p>null</p><p>ä»»åŠ¡æ·»åŠ </p><p>ğŸš€%0</p><p>POST</p><p>null</p><p>ä»»åŠ¡è·å–</p><p>ğŸš€%0</p><p>GET</p><p>null</p><p>ä»»åŠ¡åˆ é™¤</p><p>ğŸš€%0</p><p>POST</p><p>null</p><p>ä»»åŠ¡ä¿®æ”¹</p><p>ğŸš€%0</p><p>PUT</p><p>null</p><p>APIæ·»åŠ </p><p>ğŸš€%0</p><p>POST</p><p>ç¬¬ä¸‰æ–¹(ex:saltapi,zabbixapi)</p><p>APIè·å–</p><p>ğŸš€%0</p><p>GET</p><p>ç¬¬ä¸‰æ–¹(ex:saltapi,zabbixapi)</p><p>APIåˆ é™¤</p><p>ğŸš€%0</p><p>POST</p><p>ç¬¬ä¸‰æ–¹(ex:saltapi,zabbixapi)</p><p>APIä¿®æ”¹</p><p>ğŸš€%0</p><p>PUT</p><p>ç¬¬ä¸‰æ–¹(ex:saltapi,zabbixapi)</p><p>è®¾è®¡æ€è·¯:<br>1.ç”¨æˆ·æƒé™ç®¡ç†é€šè¿‡è§’è‰²ç®¡ç†ï¼Œåˆ†ä¸ºuser,admin,saä¸‰ç§è§’è‰²<br>2.é‡‡ç”¨äº†jwt tokenè®¤è¯æœºåˆ¶ï¼Œè®¿é—®èµ„æºå¿…é¡»æºå¸¦access_tokenä»¥éªŒè¯å…¶è®¿é—®èµ„æºçš„æƒé™<br>â€¦â€¦</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> All </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡Consul-Templateå®ç°åŠ¨æ€é…ç½®æœåŠ¡</title>
      <link href="/2018/08/06/tong-guoconsultemplate-shi-xian-dong-tai-pei-zhi-f/"/>
      <url>/2018/08/06/tong-guoconsultemplate-shi-xian-dong-tai-pei-zhi-f/</url>
      
        <content type="html"><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯:"></a>èƒŒæ™¯:</h4><p>å…¬å¸çš„æµ‹è¯•ã€é¢„å‘å¸ƒç¯å¢ƒçš„é…ç½®ä¿®æ”¹åœ¨å‰æœŸéƒ½æ˜¯é€šè¿‡æ‰‹å·¥ç™»å½•åˆ°æœåŠ¡å™¨ä¸Šå»vimé…ç½®æ–‡ä»¶çš„ï¼Œè¿™æ ·ä¸€æ¥å°±ä¼šäº§ç”Ÿä¸€å®šçš„å®‰å…¨æˆ–è€…è¯¯æ“ä½œä»¥åŠé¢‘ç¹çš„æ“ä½œçœŸçš„æ˜¯æœ‰äº›æ¶å¿ƒçš„ï¼›å»å¹´åœ¨æ­¤åŸºç¡€ä¸Šä¹Ÿä¸ºè¿è¥/æµ‹è¯•ä½¿ç”¨Flask å†™äº†ä¸€ä¸ªå¹³å°è®©ä»–ä»¬è‡ªå·±ç”¨ï¼›ä½†æ˜¯ç”±äºä¸€äº›ä¸å®šå› ç´ ï¼Œä¸èƒ½å¤Ÿæ»¡è¶³è¿™æ–¹é¢çš„éœ€æ±‚ï¼›ä½†æ˜¯æœ¬äººè¿˜æ˜¯åšæŒä»¥è‡ªåŠ¨åŒ–çš„ç†å¿µæ¥æ“ä½œï¼›æ‰€ä»¥å­¦ä¹ äº†è§£äº†ä¸€ä¸‹è‡ªåŠ¨é…ç½®çš„ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚Consulï¼Œå½“ç„¶ä»–çš„åŸç†åŠŸèƒ½ç½‘ä¸Šæœ‰å¾ˆå¤šï¼›ä¹Ÿæ²¡æœ‰å¿…è¦åœ¨è¿™é‡Œå†ä¸€æ¬¡è¯´äº†ï¼›ä¸»è¦è®°å½•ä¸€ä¸‹å¯¹äºè¿™ä¸ªéœ€æ±‚çš„ä¸€ä¸ªæƒ³æ³•åˆ°å®ç°çš„è¿‡ç¨‹ã€‚â€å¦ˆå¦ˆå†ä¹Ÿä¸æ‹…å¿ƒæˆ‘vimé”™é…ç½®å•¦~~~ğŸ˜â€</p><hr><p>è¿™æ˜¯å‰æœŸä¸ºè¿è¥äººå‘˜ä½¿ç”¨Flaskå¼€å‘çš„ä¸€ä¸ªå¹³å°,ä¸»è¦æ—¥å¸¸æ¶‰åŠåˆ°çš„æ“ä½œ(æµ‹è¯•/é¢„å‘å¸ƒç¯å¢ƒ)<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/08/15335443893508.jpg">ï¿¼</p><p>ä¸‹é¢æ˜¯é’ˆå¯¹ä»¥ä¸Šä¸€äº›æ“ä½œè§„åˆ’çš„ä¸€ä¸ªæ‹“æ‰‘å›¾:<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/08/15337809989270.jpg">ï¿¼</p><p>è¿™é‡Œæˆ‘ä¸»è¦ä½¿ç”¨åˆ°äº†consulçš„k/vå­˜å‚¨ä»¥åŠconsul-templateåŠ¨æ€çš„é…ç½®ç³»ç»Ÿ</p><ol><li>æ“ä½œäººå‘˜é€šè¿‡Opsplatformæ“ä½œåï¼Œé€šè¿‡è°ƒç”¨consul-http-apiå°†æœ€æ–°çš„key/value putåˆ°consul-datacenter;</li><li>å®¢æˆ·ç«¯æœåŠ¡å™¨æ·»åŠ å¯¹åº”çš„æ¨¡æ¿æ–‡ä»¶ï¼Œé€šè¿‡consul-templateå‘½ä»¤å¯åŠ¨ç›‘æ§æ¨¡æ¿æ–‡ä»¶</li><li>å½“æœ‰æ–°çš„key/value putåˆ°consul-datacenteræ—¶ï¼Œconsul-templateæ ¹æ®æ¨¡æ¿æ–‡ä»¶æ›¿æ¢æ‰é‡Œé¢çš„kv</li><li>åœ¨å¯åŠ¨ç›‘æ§æ¨¡æ¿æ–‡ä»¶æ—¶ä¹Ÿå¯ä»¥å¢åŠ åç»­çš„æ“ä½œï¼Œä¾‹å¦‚: <img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/08/15335448934622.jpg">ï¿¼ å®¢æˆ·ç«¯è¿æ¥åˆ°consul-http-apiï¼ŒæŒ‡å®šæ¨¡æ¿æ–‡ä»¶ä»¥åŠè¾“å‡ºæ–‡ä»¶ï¼Œç„¶åæŒ‡å®šæ¨¡æ¿æ–‡ä»¶æ›¿æ¢æˆåŠŸåæ‰§è¡Œå…¶ä»–å‘½ä»¤ä¾‹å¦‚ä¸Šå›¾ä¸­çš„<code>date</code>å‘½ä»¤â€¦ æ•´ä¸ªè¿‡ç¨‹æ— éœ€äººå‘˜æ“ä½œã€‚</li></ol><hr><p>å½“ç„¶è¿™é‡Œåªæ˜¯ç”¨åˆ°äº†consulçš„å†°å±±ä¸€è§’ï¼Œä¹Ÿæ˜¯ä½œä¸ºä¸€ä¸ªæ–¹å‘å»å®ç°å„ç§éœ€æ±‚~</p><p>é€šè¿‡reqeustsæ¥æ“ä½œkey/value<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/08/15335452141233.jpg">ï¿¼</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> consul </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å•è½¦å˜æ‘©æ‰˜</title>
      <link href="/2018/07/30/dan-che-bian-mo-tuo/"/>
      <url>/2018/07/30/dan-che-bian-mo-tuo/</url>
      
        <content type="html"><![CDATA[<p>å¥½å‡ ä¸ªåŸºå‹ååº”æˆ‘è¿™åšå®¢è®¿é—®å¾ˆæ…¢ï¼Œæˆ‘ä¹Ÿæ²¡åŠæ³•ï¼Œç¬¬ä¸€æœåŠ¡å™¨æ˜¯å›½å¤–ï¼›å…¶æ¬¡ä¼˜åŒ–æ–¹é¢ä¹Ÿåšäº†ï¼Œè¿˜æ˜¯æ…¢ï¼›å®åœ¨æ²¡è¾™å°±åŠ ä¸Šäº†ä¸€å±‚php redisç¼“å­˜ï¼Œä¸ç”¨æ¯æ¬¡éƒ½åˆ°æ•°æ®åº“å»æ‹‰å–æ•°æ®å•¦,ç¬é—´å•è½¦å˜æ‘©æ‰˜ğŸ˜</p><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/77EG3HO8KT8H-LS89Y-UH.gif">ï¿¼</p><p>ç¼“å­˜å‘½ä¸­ç‡ä¹Ÿè¾¾åˆ°äº† <code>89%</code></p><pre><code>[root@sctux ~]# redis-cli info | grep keyspace_keyspace_hits:18311keyspace_misses:214518311 / (18311 + 2145) = 89%</code></pre>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç³»ç»Ÿè¿ç»´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes Sessionäº²å’Œæ€§è®¾ç½®</title>
      <link href="/2018/07/15/kubernetes-session-bao-chi-deng-she-zhi/"/>
      <url>/2018/07/15/kubernetes-session-bao-chi-deng-she-zhi/</url>
      
        <content type="html"><![CDATA[<p>å½“æˆ‘ä»¬åœ¨éƒ¨ç½²äº†å¤šä¸ªpodï¼Œä»¥åŠä¸€ä¸ªServiceåï¼Œå°±å¯ä»¥åœ¨é›†ç¾¤å†…éƒ¨é€šè¿‡ServiceIPè®¿é—®podæä¾›çš„æœåŠ¡äº†ï¼›<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15317143688914.jpg">ï¿¼<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15317151806742.jpg">ï¿¼</p><h3 id="å½“ä¸è®¾ç½®sessionä¿æŒæ—¶ï¼Œserviceå‘åå°podè½¬å‘è§„åˆ™æ˜¯è½®è¯¢"><a href="#å½“ä¸è®¾ç½®sessionä¿æŒæ—¶ï¼Œserviceå‘åå°podè½¬å‘è§„åˆ™æ˜¯è½®è¯¢" class="headerlink" title="å½“ä¸è®¾ç½®sessionä¿æŒæ—¶ï¼Œserviceå‘åå°podè½¬å‘è§„åˆ™æ˜¯è½®è¯¢:"></a>å½“ä¸è®¾ç½®sessionä¿æŒæ—¶ï¼Œserviceå‘åå°podè½¬å‘è§„åˆ™æ˜¯è½®è¯¢:</h3><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15317146734082.jpg">ï¿¼<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15317146968972.jpg">ï¿¼<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15317147222424.jpg">ï¿¼<br>ä»¥ä¸Šæˆ‘é€šè¿‡ç‚¹å‡»é¡µé¢è¯·æ±‚ï¼Œå¯ä»¥å°±çœ‹å‡ºserviceå°†æˆ‘çš„è¯·æ±‚åˆ†å‘åˆ°äº†åé¢çš„ä¸‰ä¸ªpod;</p><h3 id="k8sä¼šæ ¹æ®è®¿é—®çš„ipæ¥æŠŠè¯·æ±‚è½¬å‘ç»™ä»–ä»¥å‰è®¿é—®è¿‡çš„podï¼Œè¿™æ ·sessionå°±ä¿æŒä½äº†ã€‚"><a href="#k8sä¼šæ ¹æ®è®¿é—®çš„ipæ¥æŠŠè¯·æ±‚è½¬å‘ç»™ä»–ä»¥å‰è®¿é—®è¿‡çš„podï¼Œè¿™æ ·sessionå°±ä¿æŒä½äº†ã€‚" class="headerlink" title="k8sä¼šæ ¹æ®è®¿é—®çš„ipæ¥æŠŠè¯·æ±‚è½¬å‘ç»™ä»–ä»¥å‰è®¿é—®è¿‡çš„podï¼Œè¿™æ ·sessionå°±ä¿æŒä½äº†ã€‚"></a>k8sä¼šæ ¹æ®è®¿é—®çš„ipæ¥æŠŠè¯·æ±‚è½¬å‘ç»™ä»–ä»¥å‰è®¿é—®è¿‡çš„podï¼Œè¿™æ ·sessionå°±ä¿æŒä½äº†ã€‚</h3><p>æŸ¥çœ‹åˆ›å»ºserviceæ—¶çš„yamlæ–‡ä»¶å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯ è¯¥é¡¹æ˜¯ä¸ºNoneçš„<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15317149817174.jpg">ï¿¼</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•å°†podä¸­çš„containeræ—¶åŒºæ›´æ”¹ä¸ºåŒä¸€æ—¶åŒºçš„åŸå¸‚æˆ–UTCæ—¶åŒºåç§»</title>
      <link href="/2018/07/14/ru-he-jiangpod-zhong-decontainer-shi-qu-geng-gai-w/"/>
      <url>/2018/07/14/ru-he-jiangpod-zhong-decontainer-shi-qu-geng-gai-w/</url>
      
        <content type="html"><![CDATA[<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜:"></a>é—®é¢˜:</h2><p>åœ¨åˆ›å»ºpod containeråå‘ç°é‡Œé¢çš„æ—¶åŒºæ˜¯UTC,å¯¹äºå›½å†…ä¹ æƒ¯è¿˜æ˜¯CSTæ—¶åŒºæ¯”è¾ƒæ˜“è¯»ï¼›é‚£å¦‚ä½•è§£å†³è¿™ç§é—®é¢˜å˜›ï¼Ÿæš‚æ—¶æƒ³åˆ°çš„ä¸¤ç§åŠæ³•:</p><pre><code>[root@linux-node1 ~]# kubectl exec flask-app-nginx-66b56f556c-zb84s date -n flask-app-extions-stageMon Jul 14 07:32:52 UTC 2018[root@linux-node1 ~]# dateMon Jul 14 15:32:52 CST 2018</code></pre><ul><li>ç›´æ¥ä¿®æ”¹é•œåƒçš„æ—¶é—´è®¾ç½®ï¼Œå¥½å¤„æ˜¯åº”ç”¨éƒ¨ç½²æ—¶æ— éœ€ç‰¹æ®Šè®¾ç½®ï¼Œä½†æ˜¯éœ€è¦æ‰‹åŠ¨ä»æ–°æ„å»ºDockeré•œåƒ</li><li>éƒ¨ç½²åº”ç”¨æ—¶ï¼Œå•ç‹¬è¯»å–ä¸»æœºçš„â€/etc/localtimeâ€,æ— éœ€ä¿®æ”¹é•œåƒï¼Œä½†æ˜¯æ¯ä¸ªåº”ç”¨éƒ½è¦å•ç‹¬è®¾ç½®ã€‚</li></ul><h2 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³:"></a>è§£å†³:</h2><p>ä¸ºäº†å¿«é€Ÿï¼Œç®€å•çš„è§£å†³æ­¤é—®é¢˜ï¼Œå…ˆä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼›yamlæ–‡ä»¶ä¸­æ˜ å°„ä¸»æœºçš„â€/etc/localtimeâ€æ–‡ä»¶, æ·»åŠ yamlé…ç½®:</p><pre><code>............    spec:      containers:      - name: nginx        image: nginx:latest        imagePullPolicy: IfNotPresent        ports:        - containerPort: 80        volumeMounts:          - name: nginx-conf            mountPath: "/etc/nginx/nginx.conf"            subPath: nginx.conf          - name: host-time            mountPath: /etc/localtime      volumes:      - name: nginx-conf        configMap:          name: nginx-conf      - name: host-time        hostPath:          path: /usr/share/zoneinfo/Asia/Shanghai............   [root@linux-node1 flask_app_nginx]# kubectl apply -f flask_app_nginx_deploy.yaml [root@linux-node1 flask_app_nginx]# kubectl exec flask-app-nginx-f4d9759b4-xq4rk date -n flask-app-extions-stageMon Jul 14 15:50:29 CST 2018[root@linux-node1 flask_app_nginx]# dateMon Jul 14 15:50:29 CST 2018      # ä»¥ä¸Šï¼Œå°±å®Œæˆäº†pod containerçš„æ—¶åŒºä¿®æ”¹é—®é¢˜...</code></pre><p>å…¶å®è¿˜æœ‰ä¸€ç§æ–¹æ³•å°±æ˜¯å°† <code>/usr/share/zoneinfo/Asia/Shanghai</code> è¿™ä¸ªæ–‡ä»¶åšæˆä¹‹å‰æˆ‘æŒ‚è½½nginxé…ç½®æ–‡ä»¶é‚£æ ·é€šè¿‡ConfigMapçš„å½¢å¼æŒ‚è½½.</p>]]></content>
      
      
      <categories>
          
          <category> è™šæ‹ŸåŒ–&amp;amp;äº‘è®¡ç®—&amp;amp;å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How to Change Ingress-Nginx Nginx&#39;s Configurationï¼Ÿ</title>
      <link href="/2018/07/03/how-to-change-ingressnginx-nginxs-configuration/"/>
      <url>/2018/07/03/how-to-change-ingressnginx-nginxs-configuration/</url>
      
        <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>ä»Šå¤©è®¿é—®äº†ä¸€ä¸‹ä¹‹å‰æ­å»ºçš„é‚£å¥—k8såº”ç”¨ï¼Œå½“æˆ‘å®¢æˆ·ç«¯é€šè¿‡åŸŸåè®¿é—®(ingress-nginxé€šè¿‡åŸŸåè½¬å‘è¯·æ±‚åˆ°åç«¯)æ—¶ï¼Œå‡ºç°äº†504çš„æƒ…å†µï¼›ç¬¬ä¸€æƒ³åˆ°çš„å°±æ˜¯å½“åç«¯ä¸€ç›´æ²¡è¿”å›æ—¶ï¼›proxyè¶…æ—¶äº†ï¼›</p><pre><code>192.168.56.1 - [192.168.56.1] - - [03/Jul/2018:09:16:54 +0000] "GET / HTTP/1.1" 504 586 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36" 412 10.002 [flask-app-extions-stage-flask-app-nginx-80] 10.2.17.5:80 0 10.003 504 497fe6db73abcd3ed749fdc646870432# å“åº”10.003ç§’å°±æŠ¥504ğŸ˜¢</code></pre><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15306117528798.jpg">ï¿¼<br>é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œ,ingress-nginxä»£ç†ç”¨æˆ·è¯·æ±‚åˆ°flask-app-nginx SVC<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15306121028954.jpg">ï¿¼</p><p>è€Œä¸”åç«¯åœ¨é›†ç¾¤å†…éƒ¨ç›´æ¥è®¿é—®åº”ç”¨çš„ClusterIPæ˜¯æ²¡æœ‰é—®é¢˜ï¼›<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15306118758212.jpg">ï¿¼</p><p>é‚£è§£å†³åŠæ³•å°±æ˜¯ä¿®æ”¹ingress-nginx çš„nginxé…ç½®ï¼›å‰é¢å®éªŒä¸­æˆ‘ä½¿ç”¨äº†configmapæ¥æŒ‚nginxé…ç½®ï¼Œingerss-nginxçš„é…ç½®ä¹Ÿæ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåªæ˜¯è¯´å®ç°çš„æ–¹å¼ä¸ä¸€æ ·ï¼›ä»–æ˜¯åœ¨åˆ›å»ºäº†ingressä¹‹åæ ¹æ®è§„åˆ™ç”Ÿæˆçš„nginxé…ç½®ï¼›<br>è¿›å…¥podå®¹å™¨ä¸­å‘ç°é»˜è®¤çš„nginxé…ç½®å‚æ•°ä¸º:</p><pre><code>            proxy_connect_timeout                   5s;            proxy_send_timeout                      60s;            proxy_read_timeout                      60s;</code></pre><p>è¿™ä¸ªæ—¶é—´è¿˜æ˜¯è›®çŸ­çš„ï¼Œæ‰€ä»¥æˆ‘éœ€è¦ä¿®æ”¹å®ƒï¼Œé‚£å’‹ä¸ªä¿®æ”¹å˜›ï¼Ÿä¸å¯èƒ½vi nginx.conf ç„¶åä¿å­˜ï¼Œå†ä»æ–°reload podï¼Ÿ è¿™æ ·èƒ½è§£å†³ï¼Œä½†æ˜¯ä¸åˆç†ï¼Œäºæ˜¯å®˜ç½‘æä¾›ç»™äº†è¿™ç§æ–¹å¼:<br><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/</a><br>ä¹Ÿå°±æ˜¯åœ¨å®˜æ–¹æä¾›çš„configmap.yamlä¸­ æ·»åŠ è¦†ç›–åŸæœ‰é»˜è®¤å€¼</p><pre><code>[root@linux-node1 ingress-nginx]# more configmap.yamlkind: ConfigMapapiVersion: v1metadata:  name: nginx-configuration  namespace: ingress-nginx  labels:    app: ingress-nginxdata:  proxy-connect-timeout: "30"  proxy-read-timeout: "120"  proxy-send-timeout: "120"</code></pre><p>ç„¶åapplyä¸€ä¸‹</p><pre><code>kubectl apply -f configmap.yaml </code></pre><p>åœ¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤çš„æ—¶å€™podä¼šå»é‡æ–°åŠ è½½é…ç½®configmapçš„ä¿¡æ¯<br>é€šè¿‡podçš„æ—¥å¿—å¯ä»¥çœ‹åˆ°:</p><pre><code>[root@linux-node1 ~]# kubectl logs -f pod/nginx-ingress-controller-t9jh9 -n ingress-nginxI0703 10:21:24.014062       5 event.go:218] Event(v1.ObjectReference{Kind:"ConfigMap", Namespace:"ingress-nginx", Name:"nginx-configuration", UID:"df01bd6b-79f4-11e8-95a2-000c29c6d12b", APIVersion:"v1", ResourceVersion:"1013650", FieldPath:""}): type: 'Normal' reason: 'UPDATE' ConfigMap ingress-nginx/nginx-configurationI0703 10:21:24.015721       5 controller.go:169] Configuration changes detected, backend reload required.I0703 10:21:24.539971       5 controller.go:179] Backend successfully reloaded.</code></pre><p>å†ä¸€æ¬¡è¿›å…¥å®¹å™¨æŸ¥çœ‹nginxçš„é…ç½®å‚æ•°æ˜¯å¦æ”¹å˜:</p><pre><code>            proxy_connect_timeout                   30s;            proxy_send_timeout                      120s;            proxy_read_timeout                      120s;</code></pre><p>å¯ä»¥çœ‹åˆ°åŸæ¥é»˜è®¤çš„é…ç½®å‚æ•°å€¼å·²ç»ä¿®æ”¹æˆåŠŸï¼›<br>å®¢æˆ·ç«¯å†æ¬¡è®¿é—®å°±ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜äº†ï¼š<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15306159339443.jpg">ï¿¼</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
          <category> è™šæ‹ŸåŒ–&amp;amp;äº‘è®¡ç®—&amp;amp;å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŠå›è«æƒœé‡‘ç¼•è¡£ï¼ŒåŠå›æƒœå–å°‘å¹´æ—¶ã€‚</title>
      <link href="/2018/07/02/e5-8a-9d-e5-90-9b-e8-8e-ab-e6-83-9c-e9-87-91-e7-bc-95-e8-a1-a3-ef-bc-8c-e5-8a-9d-e5-90-9b-e6-83-9c-e5-8f-96-e5-b0-91-e5-b9-b4-e6-97-b6-e3-80-82-trashed/"/>
      <url>/2018/07/02/e5-8a-9d-e5-90-9b-e8-8e-ab-e6-83-9c-e9-87-91-e7-bc-95-e8-a1-a3-ef-bc-8c-e5-8a-9d-e5-90-9b-e6-83-9c-e5-8f-96-e5-b0-91-e5-b9-b4-e6-97-b6-e3-80-82-trashed/</url>
      
        <content type="html"><![CDATA[<p>äººç”ŸçŸ­çŸ­å‡ åå¹´ã€å·¥ä½œã€å­¦ä¹ (ä¸“ä¸šæŠ€èƒ½çŸ¥è¯†)ä¹Ÿè®¸å°±å äº†æˆ‘ä»¬ç”Ÿå‘½ä¸­çš„å¤§éƒ¨åˆ†çš„æ—¶é—´ã€ä¹Ÿæ˜¯æˆ‘ä»¬ç”Ÿå­˜ä¸‹æ¥çš„åŸºç¡€ã€‚ä½†æ˜¯èƒ½ä¸èƒ½åœ¨è¿™åŸºç¡€ä¹‹ä¸Šæ‰¾ç‚¹ç¼éš™å­¦ä¹ ã€å°è¯•ä¸€äº›ä¸ä¸€æ ·çš„ä¸œè¥¿å‘¢ï¼Œè¿™ä¸ªè¿˜æ˜¯çœ‹ä¸ªäººå§~~~æˆ‘ä¸ªäººå€’æ˜¯ç°åœ¨é™¤äº†å·¥ä½œã€å­¦ä¹ è¿˜æ˜¯éœ€è¦åŸ¹å…»ä¸€ç‚¹å…¶ä»–çš„å…´è¶£çˆ±å¥½ï¼Œä»å„ä¸ªæ–¹é¢ä¸æ–­ä¸°å¯Œã€å®Œå–„è‡ªå·±ã€‚ å›æƒ³èµ·å¹´å¹¼æ—¶çˆ¶äº²ç”¨æœ€ä¸¥å‰çš„æ–¹å¼é€¼ç€æˆ‘ç»ƒå­—ï¼Œå½“æ—¶æ ¹æœ¬ä¸æ‡‚ä¸ºä»€ä¹ˆéè¦é€¼ç€æˆ‘ç»ƒä¹ ï¼Œç°åœ¨å›æƒ³èµ·æ¥æˆ‘åªèƒ½æ‰“å¿ƒåº•çš„æ„Ÿæ¿€çˆ¶äº²è®©æˆ‘æœ‰äº†è¿™ä¸ªä¹ æƒ¯æˆ–è€…è¯´æ˜¯åŸ¹å…»äº†æˆ‘è¿™ä¸ªå…´è¶£çˆ±å¥½ã€‚ä»¥è‡³äºèƒ½å†™å‡ºè¿˜ç®—æ‹¿å¾—å‡ºæ‰‹çš„å­—ä½“ã€‚ åŠå›è«æƒœé‡‘ç¼•è¡£ï¼ŒåŠå›æƒœå–å°‘å¹´æ—¶ã€‚ èŠ±å¼€å ªæŠ˜ç›´é¡»æŠ˜ï¼Œè«å¾…èŠ±å¼€ç©ºæŠ˜æã€‚ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/IMG_4953.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/IMG_4953.jpg"></a></p>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>10-K8sé›†ç¾¤æ­å»º---æ–°å¢NodeèŠ‚ç‚¹</title>
      <link href="/2018/06/29/10k8s-ji-qun-da-jianxin-zengnode-jie-dian/"/>
      <url>/2018/06/29/10k8s-ji-qun-da-jianxin-zengnode-jie-dian/</url>
      
        <content type="html"><![CDATA[<p>ä»€ä¹ˆï¼Ÿèµ„æºä¸å¤Ÿç”¨äº†ï¼Ÿ æ€¼æœåŠ¡å™¨é…ç½®å•Š(å‘ä¸Šæ‰©å±•)ï¼Œæ€¼æœºå™¨å•Š(æ¨ªå‘æ‰©å±•)ï¼  </p><p>(æ³¨: è¯¥èŠ‚ç‚¹æ·»åŠ æ˜¯åŸºäºä¹‹å‰k8sé›†ç¾¤æ­å»ºçš„ç¯å¢ƒè¿›è¡Œ)<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15304316863865.jpg"></p><h2 id="1-ç³»ç»Ÿåˆå§‹åŒ–"><a href="#1-ç³»ç»Ÿåˆå§‹åŒ–" class="headerlink" title="1.ç³»ç»Ÿåˆå§‹åŒ–:"></a>1.ç³»ç»Ÿåˆå§‹åŒ–:</h2><p>a. ä¸»æœºåé…ç½®</p><pre><code>node4:echo "linux-node4.example.com" &gt; /etc/hostname</code></pre><p>b. è®¾ç½®/etc/hostsä¿è¯ä¸»æœºåèƒ½å¤Ÿè§£æ</p><pre><code>node4:echo "192.168.56.14 linux-node4 linux-node4.example.com" &gt;&gt; /etc/hosts</code></pre><p>c. å…³é—­SELinuxåŠé˜²ç«å¢™</p><pre><code>node4:systemctl disable firewalld; systemctl stop firewalld sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</code></pre><p>d. ç¯å¢ƒå˜é‡é…ç½®(åç»­k8sç›¸å…³å‘½ä»¤éƒ½ä¼šæ”¾åˆ°/opt/kubernetes/binç›®å½•ä¸‹)</p><pre><code>echo "PATH=$PATH:$HOME/bin:/opt/kubernetes/bin" &gt;&gt;  ~/.bash_profilesource ~/.bash_profile</code></pre><h2 id="4-å®‰è£…Docker"><a href="#4-å®‰è£…Docker" class="headerlink" title="4.å®‰è£…Docker"></a>4.å®‰è£…Docker</h2><p>aï¼šä½¿ç”¨å›½å†…Dockeræº</p><pre><code>[root@linux-node4 ~]# cd /etc/yum.repos.d/[root@linux-node4 yum.repos.d]# wget \https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></pre><p>bï¼šDockerå®‰è£…ï¼š</p><pre><code>[root@linux-node4 ~]# yum install -y docker-ce</code></pre><p>cï¼šå¯åŠ¨åå°è¿›ç¨‹ï¼š</p><pre><code>[root@linux-node4 ~]# systemctl enable docker[root@linux-node4 ~]# systemctl start docker</code></pre><h2 id="5-å‡†å¤‡éƒ¨ç½²ç›®å½•"><a href="#5-å‡†å¤‡éƒ¨ç½²ç›®å½•" class="headerlink" title="5.å‡†å¤‡éƒ¨ç½²ç›®å½•"></a>5.å‡†å¤‡éƒ¨ç½²ç›®å½•</h2><pre><code>[root@linux-node4 ~]#  mkdir -p /opt/kubernetes/{cfg,bin,ssl,log}# ç›®å½•ç»“æ„, æ‰€æœ‰æ–‡ä»¶å‡å­˜æ”¾åœ¨/opt/kubernetesç›®å½•ä¸‹ï¼š[root@linux-node4 ~]# tree -L 1 /opt/kubernetes//opt/kubernetes/â”œâ”€â”€ bin   #äºŒè¿›åˆ¶æ–‡ä»¶â”œâ”€â”€ cfg   #é…ç½®æ–‡ä»¶â”œâ”€â”€ log   #æ—¥å¿—æ–‡ä»¶â””â”€â”€ ssl   #è¯ä¹¦æ–‡ä»¶</code></pre><h2 id="6-åšå¥½masterèŠ‚ç‚¹è·Ÿå…¶ä»–nodeèŠ‚ç‚¹çš„sshäº’ä¿¡-ä¾¿äºæ­å»º"><a href="#6-åšå¥½masterèŠ‚ç‚¹è·Ÿå…¶ä»–nodeèŠ‚ç‚¹çš„sshäº’ä¿¡-ä¾¿äºæ­å»º" class="headerlink" title="6.åšå¥½masterèŠ‚ç‚¹è·Ÿå…¶ä»–nodeèŠ‚ç‚¹çš„sshäº’ä¿¡,ä¾¿äºæ­å»º"></a>6.åšå¥½masterèŠ‚ç‚¹è·Ÿå…¶ä»–nodeèŠ‚ç‚¹çš„sshäº’ä¿¡,ä¾¿äºæ­å»º</h2><pre><code>[root@linux-node1 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.56.14</code></pre><h2 id="7-æ‹·è´é…ç½®-from-master"><a href="#7-æ‹·è´é…ç½®-from-master" class="headerlink" title="7.æ‹·è´é…ç½®(from master)"></a>7.æ‹·è´é…ç½®(from master)</h2><h3 id="1-æ‹·è´CFSSL"><a href="#1-æ‹·è´CFSSL" class="headerlink" title="1.æ‹·è´CFSSL"></a>1.æ‹·è´CFSSL</h3><pre><code>[root@linux-node1 ~]# scp /opt/kubernetes/bin/cfssl* 192.168.56.14:/opt/kubernetes/bin</code></pre><h3 id="2-åˆ†å‘è¯ä¹¦"><a href="#2-åˆ†å‘è¯ä¹¦" class="headerlink" title="2.åˆ†å‘è¯ä¹¦"></a>2.åˆ†å‘è¯ä¹¦</h3><pre><code>[root@linux-node1 ssl]# scp ca.csr ca.pem ca-key.pem ca-config.json 192.168.56.14:/opt/kubernetes/ssl</code></pre><h3 id="3-æ‹·è´kubernetes-è¯ä¹¦å’Œç§é’¥"><a href="#3-æ‹·è´kubernetes-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="3.æ‹·è´kubernetes è¯ä¹¦å’Œç§é’¥"></a>3.æ‹·è´kubernetes è¯ä¹¦å’Œç§é’¥</h3><pre><code>[root@linux-node1 ssl]# scp /opt/kubernetes/ssl/kubernetes*.pem 192.168.56.14:/opt/kubernetes/ssl/</code></pre><h3 id="4-æ‹·è´kubeletï¼Œkube-proxyè½¯ä»¶åŒ…"><a href="#4-æ‹·è´kubeletï¼Œkube-proxyè½¯ä»¶åŒ…" class="headerlink" title="4.æ‹·è´kubeletï¼Œkube-proxyè½¯ä»¶åŒ…"></a>4.æ‹·è´kubeletï¼Œkube-proxyè½¯ä»¶åŒ…</h3><pre><code>[root@linux-node1 ~]# cd /usr/local/src/kubernetes/server/bin/[root@linux-node1 bin]# scp kubelet kube-proxy 192.168.56.14:/opt/kubernetes/bin/</code></pre><h3 id="5-æ‹·è´è§’è‰²ç»‘å®šæ–‡ä»¶"><a href="#5-æ‹·è´è§’è‰²ç»‘å®šæ–‡ä»¶" class="headerlink" title="5.æ‹·è´è§’è‰²ç»‘å®šæ–‡ä»¶"></a>5.æ‹·è´è§’è‰²ç»‘å®šæ–‡ä»¶</h3><pre><code>[root@linux-node1 ~]# scp /opt/kubernetes/cfg/bootstrap.kubeconfig 192.168.56.14:/opt/kubernetes/cfg</code></pre><h3 id="6-æ‹·è´CNIæ”¯æŒé…ç½®"><a href="#6-æ‹·è´CNIæ”¯æŒé…ç½®" class="headerlink" title="6.æ‹·è´CNIæ”¯æŒé…ç½®"></a>6.æ‹·è´CNIæ”¯æŒé…ç½®</h3><pre><code>[root@linux-node1 ~]# ssh linux-node4 "mkdir /etc/cni/net.d -p"[root@linux-node1 ~]# scp /etc/cni/net.d/10-default.conf linux-node4:/etc/cni/net.d/</code></pre><h3 id="7-åˆ›å»ºkubeletæ‰€éœ€ç›®å½•"><a href="#7-åˆ›å»ºkubeletæ‰€éœ€ç›®å½•" class="headerlink" title="7.åˆ›å»ºkubeletæ‰€éœ€ç›®å½•"></a>7.åˆ›å»ºkubeletæ‰€éœ€ç›®å½•</h3><pre><code>[root@linux-node1 ~]# ssh linux-node4 "mkdir /var/lib/kubelet"</code></pre><h3 id="8-æ‹·è´Flannelç½‘ç»œè¯ä¹¦"><a href="#8-æ‹·è´Flannelç½‘ç»œè¯ä¹¦" class="headerlink" title="8.æ‹·è´Flannelç½‘ç»œè¯ä¹¦"></a>8.æ‹·è´Flannelç½‘ç»œè¯ä¹¦</h3><pre><code>[root@linux-node1 ~]# scp  /opt/kubernetes/ssl/flanneld*.pem 192.168.56.14:/opt/kubernetes/ssl/</code></pre><h3 id="9-å¤åˆ¶flannerç›¸å…³è½¯ä»¶åŒ…"><a href="#9-å¤åˆ¶flannerç›¸å…³è½¯ä»¶åŒ…" class="headerlink" title="9.å¤åˆ¶flannerç›¸å…³è½¯ä»¶åŒ…"></a>9.å¤åˆ¶flannerç›¸å…³è½¯ä»¶åŒ…</h3><pre><code>[root@linux-node1 ~]# ssh linux-node4 "mkdir /opt/kubernetes/bin/cni"[root@linux-node1 ~]# scp /opt/kubernetes/bin/cni/* 192.168.56.14:/opt/kubernetes/bin/cni/[root@linux-node1 ~]# scp /usr/lib/systemd/system/flannel.service 192.168.56.14:/usr/lib/systemd/system/[root@linux-node1 ~]# scp /opt/kubernetes/cfg/flannel 192.168.56.14:/opt/kubernetes/cfg/[root@linux-node1 ~]# cd /usr/local/src[root@linux-node1 src]# scp flanneld mk-docker-opts.sh 192.168.56.14:/opt/kubernetes/bin/[root@linux-node1 src]# cd /usr/local/src/kubernetes/cluster/centos/node/bin/[root@linux-node1 bin]# scp remove-docker0.sh 192.168.56.14:/opt/kubernetes/bin/# docker æœåŠ¡è„šæœ¬[root@linux-node1 bin]# scp /usr/lib/systemd/system/docker.service 192.168.56.14:/usr/lib/systemd/system/</code></pre><h3 id="10-æ‹·è´kubeletç³»ç»ŸæœåŠ¡é…ç½®"><a href="#10-æ‹·è´kubeletç³»ç»ŸæœåŠ¡é…ç½®" class="headerlink" title="10.æ‹·è´kubeletç³»ç»ŸæœåŠ¡é…ç½®"></a>10.æ‹·è´kubeletç³»ç»ŸæœåŠ¡é…ç½®</h3><pre><code>[root@linux-node1 ~]# scp /usr/lib/systemd/system/kubelet.service 192.168.56.14:/usr/lib/systemd/system/[root@linux-node1 ~]# ssh linux-node4 "systemctl daemon-reload"[root@linux-node1 ~]# ssh linux-node4 "systemctl enable kubelet"[root@linux-node1 ~]# ssh linux-node4 "systemctl start kubelet"[root@linux-node1 ~]# ssh linux-node4 "systemctl status kubelet"# ç„¶ååœ¨node1èŠ‚ç‚¹æŸ¥çœ‹TLSè¯ä¹¦è¯·æ±‚ï¼Œé€šè¿‡ä»¥ä¸‹å°±è¡Œäº†ï¼Œå¦‚æœç»“æœä¸ºç©ºï¼Œå°±éœ€è¦æŸ¥çœ‹kubeletçš„æ—¥å¿—å•¦ï¼Œåæ­£æˆ‘åœ¨è¿™é‡Œå°±è·³è¿›äº†ä¸€å›è‡ªå·±æŒ–çš„å‘o(â•¥ï¹â•¥)o[root@linux-node1 ~]# kubectl get csr[root@linux-node1 ~]# kubectl get csr|grep 'Pending' | awk 'NR&gt;0{print $1}'| xargs kubectl certificate[root@linux-node1 ~]# kubectl get nodesNAME            STATUS    ROLES     AGE       VERSION192.168.56.11   Ready     master    1d        v1.10.1192.168.56.12   Ready     node      31d       v1.10.1192.168.56.13   Ready     node      31d       v1.10.1192.168.56.14   Ready     node      1d        v1.10.1# ä»¥ä¸Šï¼Œæ–°çš„è®¡ç®—èŠ‚ç‚¹192.168.56.14å·²ç»æˆåŠŸæ·»åŠ </code></pre><h3 id="11-é…ç½®kube-proxyä½¿ç”¨LVS"><a href="#11-é…ç½®kube-proxyä½¿ç”¨LVS" class="headerlink" title="11.é…ç½®kube-proxyä½¿ç”¨LVS"></a>11.é…ç½®kube-proxyä½¿ç”¨LVS</h3><pre><code>[root@linux-node4 ~]# yum install -y ipvsadm ipset conntrack</code></pre><h3 id="12-åˆ†å‘kube-proxyè¯ä¹¦"><a href="#12-åˆ†å‘kube-proxyè¯ä¹¦" class="headerlink" title="12.åˆ†å‘kube-proxyè¯ä¹¦"></a>12.åˆ†å‘kube-proxyè¯ä¹¦</h3><pre><code>[root@linux-node1 ssl]# scp kube-proxy*.pem 192.168.56.14:/opt/kubernetes/ssl/</code></pre><h3 id="13-åˆ†å‘kubeconfigé…ç½®æ–‡ä»¶"><a href="#13-åˆ†å‘kubeconfigé…ç½®æ–‡ä»¶" class="headerlink" title="13.åˆ†å‘kubeconfigé…ç½®æ–‡ä»¶"></a>13.åˆ†å‘kubeconfigé…ç½®æ–‡ä»¶</h3><pre><code>[root@linux-node1 ssl]# scp ../cfg/kube-proxy.kubeconfig 192.168.56.14:/opt/kubernetes/cfg/</code></pre><h3 id="14-å®‰è£…nfs-å› ä¸ºnodeèŠ‚ç‚¹ä½œä¸ºå®¢æˆ·ç«¯ä¹Ÿéœ€è¦å®‰è£…nfså®¢æˆ·ç«¯å·¥å…·"><a href="#14-å®‰è£…nfs-å› ä¸ºnodeèŠ‚ç‚¹ä½œä¸ºå®¢æˆ·ç«¯ä¹Ÿéœ€è¦å®‰è£…nfså®¢æˆ·ç«¯å·¥å…·" class="headerlink" title="14.å®‰è£…nfs(å› ä¸ºnodeèŠ‚ç‚¹ä½œä¸ºå®¢æˆ·ç«¯ä¹Ÿéœ€è¦å®‰è£…nfså®¢æˆ·ç«¯å·¥å…·)"></a>14.å®‰è£…nfs(å› ä¸ºnodeèŠ‚ç‚¹ä½œä¸ºå®¢æˆ·ç«¯ä¹Ÿéœ€è¦å®‰è£…nfså®¢æˆ·ç«¯å·¥å…·)</h3><pre><code>[root@linux-node1 ssl]# ssh linux-node4 "yum -y install nfs-utils rpcbind"</code></pre><h3 id="15-åˆ›å»ºå·¥ä½œç›®å½•"><a href="#15-åˆ›å»ºå·¥ä½œç›®å½•" class="headerlink" title="15.åˆ›å»ºå·¥ä½œç›®å½•"></a>15.åˆ›å»ºå·¥ä½œç›®å½•</h3><pre><code>[root@linux-node1 ~]# ssh linux-node4 "mkdir /var/lib/kube-proxy"</code></pre><h3 id="16-æ‹·è´æœåŠ¡é…ç½®æ–‡ä»¶"><a href="#16-æ‹·è´æœåŠ¡é…ç½®æ–‡ä»¶" class="headerlink" title="16.æ‹·è´æœåŠ¡é…ç½®æ–‡ä»¶"></a>16.æ‹·è´æœåŠ¡é…ç½®æ–‡ä»¶</h3><pre><code>[root@linux-node1 ~]# cp /usr/lib/systemd/system/kube-proxy.service 192.168.56.14:/usr/lib/systemd/system/kube-proxy.service# æ³¨æ„éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶çš„IP[root@linux-node1 ~]# ssh linux-node4 "systemctl daemon-reload"[root@linux-node1 ~]# ssh linux-node4 "systemctl enable kube-proxy"[root@linux-node1 ~]# ssh linux-node4 "systemctl start kube-proxy"[root@linux-node1 ~]# ssh linux-node4 "systemctl status kube-proxy"</code></pre><h2 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h2><p>æˆ‘ä»¬å…ˆæ¥Scaling flask-app podåˆ°20ä¸ª, ç„¶åçœ‹Kubenertes Scheduleræ˜¯å¦èƒ½æŠŠè¯·æ±‚è°ƒåº¦åˆ°æ–°çš„èŠ‚ç‚¹ä¸Šé¢</p><pre><code>[root@linux-node1 ~]# kubectl scale --replicas=20 deployment.extensions/flask-app -n flask-app-extions-stagedeployment.extensions "flask-app" scaled</code></pre><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15304308410933.jpg"><br>ä¸Šå›¾å¯ä»¥çœ‹åˆ° Scalingçš„podå·²ç»ç”±Kubenertes Schedulerè°ƒåº¦åˆ°å„ä¸ªnodeè¿è¡Œï¼Œå¹¶ä¸”çŠ¶æ€å·²ç»æ˜¯Running</p><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15304310244907.jpg"></p><p>ä»¥ä¸Šï¼Œå¯ä»¥çœ‹åˆ°æˆ‘æ–°æ·»åŠ çš„èŠ‚ç‚¹å·²ç»æˆåŠŸåŠ åˆ°äº†é›†ç¾¤å½“ä¸­ï¼Œè€Œä¸”è¿è¡Œç»“æœä¹Ÿæ˜¯æˆ‘é¢„æœŸçš„ï¼›å”¯ä¸€ä¸è¶³çš„åœ°æ–¹æ˜¯è¿™ä¸ªæ­¥éª¤å¦‚æœåæœŸåœ¨å·¥ä½œä¸­ç”¨åˆ°çš„è¯æ˜¯ä¸å¤ªæ–¹ä¾¿ç»´æŠ¤çš„,ä½†æ˜¯æ‰‹åŠ¨è¿™æ ·ä¼šçŸ¥é“ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦ç”¨åˆ°å“ªäº›ä¸œè¥¿ï¼Œéœ€è¦æ€ä¹ˆé…ç½®ï¼Œä¹Ÿç®—æ˜¯å¯¹k8sçš„è¿è¡Œæœºåˆ¶æœ‰æ›´æ·±ç‚¹çš„è®¤çŸ¥ã€‚<br>åç»­æœ‰æ—¶é—´è¿˜æ˜¯æä¸€ä¸‹ç”¨SaltStackæ¥éƒ¨ç½²å§~ğŸºğŸºğŸº</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python App on Kubernets Cluster</title>
      <link href="/2018/06/27/flask_kubenertes/"/>
      <url>/2018/06/27/flask_kubenertes/</url>
      
        <content type="html"><![CDATA[<h2 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h2><p>æ­¤æ¬¡éƒ¨ç½²æ˜¯åœ¨å‰é¢åšæ–‡ä¸­æ­å»ºçš„K8Sé›†ç¾¤åŸºç¡€ä¹‹ä¸Šè¿›è¡Œçš„ï¼Œæ¶‰åŠä½¿ç”¨åˆ°çš„å®¹å™¨å·²ç»æ¨åˆ°Dockerhub<br>ä»£ç ã€æ–‡ä»¶ï¼š<a href="https://github.com/guomaoqiu/flask_kubernetes">https://github.com/guomaoqiu/flask_kubernetes</a></p><h2 id="é…ç½®æ¸…å•"><a href="#é…ç½®æ¸…å•" class="headerlink" title="é…ç½®æ¸…å•"></a>é…ç½®æ¸…å•</h2><p><img src="https://github.com/guomaoqiu/flask_kubernetes/blob/master/screenshots/1536823892.jpg?raw=true"></p><h2 id="é€»è¾‘æµç¨‹å›¾"><a href="#é€»è¾‘æµç¨‹å›¾" class="headerlink" title="é€»è¾‘æµç¨‹å›¾"></a>é€»è¾‘æµç¨‹å›¾</h2><p><img src="https://github.com/guomaoqiu/flask_kubernetes/blob/master/screenshots/15302459587264.jpg?raw=true"></p><h2 id="åˆå§‹é…ç½®"><a href="#åˆå§‹é…ç½®" class="headerlink" title="åˆå§‹é…ç½®"></a>åˆå§‹é…ç½®</h2><h5 id="1-åˆ›å»ºä¸€ä¸ªnamespace-ä¾›æ­¤æ¬¡éƒ¨ç½²ä½¿ç”¨"><a href="#1-åˆ›å»ºä¸€ä¸ªnamespace-ä¾›æ­¤æ¬¡éƒ¨ç½²ä½¿ç”¨" class="headerlink" title="1.åˆ›å»ºä¸€ä¸ªnamespace ä¾›æ­¤æ¬¡éƒ¨ç½²ä½¿ç”¨"></a>1.åˆ›å»ºä¸€ä¸ªnamespace ä¾›æ­¤æ¬¡éƒ¨ç½²ä½¿ç”¨</h5><figure class="highlight coffeescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]<span class="comment"># kubectl create namespace flask-app-extions-stage</span></span><br><span class="line">[root@linux-node1 ~]<span class="comment"># kubectl get ns</span></span><br><span class="line">NAME                      STATUS    AGE</span><br><span class="line"><span class="keyword">default</span>                   Active    <span class="number">29</span>d</span><br><span class="line">flask-app-extions-stage   Active    <span class="number">1</span>m</span><br><span class="line">kube-public               Active    <span class="number">29</span>d</span><br><span class="line">kube-system               Active    <span class="number">29</span>d</span><br></pre></td></tr></tbody></table></figure><h5 id="1-åˆ›å»ºç”¨NFSå­˜å‚¨ç›®å½•"><a href="#1-åˆ›å»ºç”¨NFSå­˜å‚¨ç›®å½•" class="headerlink" title="1. åˆ›å»ºç”¨NFSå­˜å‚¨ç›®å½•"></a>1. åˆ›å»ºç”¨NFSå­˜å‚¨ç›®å½•</h5><figure class="highlight haskell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># ç”¨äºflask-appä»£ç å­˜æ”¾ç›®å½•ï¼Œå½“podå¯åŠ¨æ—¶é€šè¿‡NFSçš„æ–¹å¼æŒ‚è½½è¿›å»</span></span><br><span class="line">[root@linux-node1 ~]# mkdir /<span class="class"><span class="keyword">data</span>/flask-app-<span class="keyword">data</span></span></span><br><span class="line"><span class="meta"># ç”¨äºflaskçš„mysqlæ•°æ®å­˜æ”¾ç›®å½•ï¼Œå½“podå¯åŠ¨æ—¶é€šè¿‡NFSæŒ‚è½½è¿›å»</span></span><br><span class="line">[root@linux-node1 ~]# mkdir /<span class="class"><span class="keyword">data</span>/flask-app-db</span></span><br></pre></td></tr></tbody></table></figure><h5 id="2-å®‰è£…NFS-Server-ç•¥"><a href="#2-å®‰è£…NFS-Server-ç•¥" class="headerlink" title="2. å®‰è£…NFS Server(ç•¥)"></a>2. å®‰è£…NFS Server(ç•¥)</h5><h5 id="3-å†™å…¥é…ç½®"><a href="#3-å†™å…¥é…ç½®" class="headerlink" title="3. å†™å…¥é…ç½®"></a>3. å†™å…¥é…ç½®</h5><figure class="highlight autoit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@linux</span>-node1 ~]<span class="meta"># echo <span class="string">"/data/flask-app-db *(rw,sync,no_subtree_check,no_root_squash)"</span> &gt; /etc/exports</span></span><br><span class="line">[root<span class="symbol">@linux</span>-node1 ~]<span class="meta"># echo <span class="string">"/data/flask-app-data *(rw,sync,no_subtree_check,no_root_squash)"</span> &gt;&gt; /etc/exports</span></span><br></pre></td></tr></tbody></table></figure><h5 id="4-é‡å¯éªŒè¯"><a href="#4-é‡å¯éªŒè¯" class="headerlink" title="4.é‡å¯éªŒè¯"></a>4.é‡å¯éªŒè¯</h5><figure class="highlight crystal"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@linux</span>-node1 ~]<span class="comment"># systemctl restart nfs-server</span></span><br><span class="line">[root<span class="variable">@linux</span>-node1 ~]<span class="comment"># exportfs</span></span><br><span class="line"><span class="comment"># mysql data</span></span><br><span class="line"><span class="regexp">/data/flask</span>-app-db</span><br><span class="line"><span class="comment"># flask app code</span></span><br><span class="line"><span class="regexp">/data/flask</span>-app-data</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h5 id="5-åˆ›å»ºflask-appä½¿ç”¨çš„pvåŠpvc"><a href="#5-åˆ›å»ºflask-appä½¿ç”¨çš„pvåŠpvc" class="headerlink" title="5.åˆ›å»ºflask-appä½¿ç”¨çš„pvåŠpvc"></a>5.åˆ›å»ºflask-appä½¿ç”¨çš„pvåŠpvc</h5><figure class="highlight autoit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@linux</span>-node1 ~]<span class="meta"># kubectl create -f flask_kubernetes/flask-app/flask_app_data_pv.yaml</span></span><br><span class="line">persistentvolume <span class="string">"flask-app-data-pv"</span> created</span><br><span class="line">[root<span class="symbol">@linux</span>-node1 ~]<span class="meta"># kubectl create -f flask_kubernetes/flask-app/flask_app_data_pvc.yaml</span></span><br><span class="line">persistentvolumeclaim <span class="string">"flask-app-data-pv-claim"</span> created</span><br></pre></td></tr></tbody></table></figure><h5 id="6-åˆ›å»ºflask-app-dbä½¿ç”¨çš„pvåŠpvc"><a href="#6-åˆ›å»ºflask-app-dbä½¿ç”¨çš„pvåŠpvc" class="headerlink" title="6.åˆ›å»ºflask-app-dbä½¿ç”¨çš„pvåŠpvc"></a>6.åˆ›å»ºflask-app-dbä½¿ç”¨çš„pvåŠpvc</h5><figure class="highlight excel"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# kubectl create -f flask_kubernetes/flask_app_db/flask_app_db_pv.yaml</span><br><span class="line">persistentvolume <span class="string">"flask-app-db-pv"</span> created</span><br><span class="line">[root@linux-node1 ~]# kubectl create -f flask_kubernetes/flask_app_db/flask_app_db_pvc.yaml</span><br><span class="line">persistentvolumeclaim <span class="string">"flask-app-db-pv-claim"</span> created</span><br><span class="line">[root@linux-node1 ~]# kubectl get <span class="built_in">pv</span> -<span class="built_in">n</span> flask-app-extions-stage</span><br><span class="line">NAME                CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                                             STORAGECLASS   REASON    AGE</span><br><span class="line">flask-app-data-<span class="built_in">pv</span>   <span class="number">5</span>Gi        RWO            Recycle          Bound     flask-app-extions-stage/flask-app-data-<span class="built_in">pv</span>-claim                            <span class="number">5</span>m</span><br><span class="line">flask-app-<span class="built_in">db</span>-<span class="built_in">pv</span>     <span class="number">5</span>Gi        RWO            Recycle          Bound     flask-app-extions-stage/flask-app-<span class="built_in">db</span>-<span class="built_in">pv</span>-claim                              <span class="number">26</span>s</span><br><span class="line">[root@linux-node1 ~]# kubectl get pvc -<span class="built_in">n</span> flask-app-extions-stage</span><br><span class="line">NAME                      STATUS    VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">flask-app-data-<span class="built_in">pv</span>-claim   Bound     flask-app-data-<span class="built_in">pv</span>   <span class="number">5</span>Gi        RWO                           <span class="number">4</span>m</span><br><span class="line">flask-app-<span class="built_in">db</span>-<span class="built_in">pv</span>-claim     Bound     flask-app-<span class="built_in">db</span>-<span class="built_in">pv</span>     <span class="number">5</span>Gi        RWO                           <span class="number">28</span>s</span><br><span class="line">[root@linux-node1 ~]#</span><br></pre></td></tr></tbody></table></figure><h2 id="éƒ¨ç½²-flask-app-db"><a href="#éƒ¨ç½²-flask-app-db" class="headerlink" title="éƒ¨ç½² flask-app-db"></a>éƒ¨ç½² flask-app-db</h2><p>è¿è¡Œflaskäº¤äº’æ•°æ®çš„æ•°æ®åº“ä½¿ç”¨çš„æ˜¯mysqlï¼Œä¸Šé¢æˆ‘å·²ç»åˆ›å»ºäº†ç”¨äºåŸºäºNFSå­˜å‚¨mysqlæ•°æ®çš„æŒä¹…å­˜å‚¨ç›®å½• /data/flask-app-db</p><h4 id="1-åˆ›å»ºé…ç½®-MySQL-å¯†ç çš„-Secret"><a href="#1-åˆ›å»ºé…ç½®-MySQL-å¯†ç çš„-Secret" class="headerlink" title="1. åˆ›å»ºé…ç½® MySQL å¯†ç çš„ Secret"></a>1. åˆ›å»ºé…ç½® MySQL å¯†ç çš„ Secret</h4><figure class="highlight fortran"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# kubectl create secret <span class="keyword">generic</span> mysql-<span class="keyword">pass</span> --from-literal=password=YOUR_PASSWORD</span><br><span class="line">[root@linux-node1 ~]# kubectl  get secret -n flask-app-extions-stage</span><br><span class="line"><span class="keyword">NAME</span>                  <span class="keyword">TYPE</span>                                  <span class="keyword">DATA</span>      AGE</span><br><span class="line"><span class="keyword">default</span>-token-fr2sg   kubernetes.io/service-account-token   <span class="number">3</span>         <span class="number">47</span>m</span><br><span class="line">mysql-<span class="keyword">pass</span>            Opaque                                <span class="number">1</span>         <span class="number">14</span>s</span><br></pre></td></tr></tbody></table></figure><h4 id="2-éƒ¨ç½²-MySQLï¼š"><a href="#2-éƒ¨ç½²-MySQLï¼š" class="headerlink" title="2. éƒ¨ç½² MySQLï¼š"></a>2. éƒ¨ç½² MySQLï¼š</h4><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# kubectl <span class="keyword">create</span> -f flask_kubernetes/flask_app_db/flask_app_db_deploy.yaml</span><br><span class="line">deployment.apps "flask-app-db" created</span><br><span class="line">[root@linux-node1 ~]# kubectl <span class="keyword">create</span> -f flask_kubernetes/flask_app_db/flask_app_db_service.yaml</span><br><span class="line">service "flask-app-db" created</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹çŠ¶æ€</span><br><span class="line"><span class="type">NAME</span>                                   READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">pod/flask-app-db<span class="number">-6</span>f55458666-h2dk7      <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">1</span>          <span class="number">22</span>h       <span class="number">10.2</span><span class="number">.15</span><span class="number">.108</span>   <span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span></span><br><span class="line"><span class="type">NAME</span>                      <span class="keyword">TYPE</span>        <span class="keyword">CLUSTER</span>-IP     <span class="keyword">EXTERNAL</span>-IP   PORT(S)          AGE       SELECTOR</span><br><span class="line">service/flask-app-db      NodePort    <span class="number">10.1</span><span class="number">.68</span><span class="number">.29</span>     &lt;<span class="keyword">none</span>&gt;        <span class="number">3306</span>:<span class="number">30006</span>/TCP   <span class="number">22</span>h       app=flask-app-db</span><br><span class="line"><span class="type">NAME</span>                                    DESIRED   <span class="keyword">CURRENT</span>   UP-<span class="keyword">TO</span>-<span class="type">DATE</span>   AVAILABLE   AGE       CONTAINERS   IMAGES                         SELECTOR</span><br><span class="line">deployment.extensions/flask-app-db      <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>            <span class="number">1</span>           <span class="number">22</span>h       mysql        mysql:<span class="number">5.6</span>                      app=flask-app-db,tier=mysql</span><br><span class="line"></span><br><span class="line"># ä»¥ä¸Šå¯ä»¥çŸ¥é“è¯¥podè¿è¡Œåœ¨èŠ‚ç‚¹<span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span>ä¸Šé¢ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯NodePortæ–¹å¼ï¼Œç„¶åæ˜ å°„äº†ä¸€ä¸ª<span class="number">30006</span>ç«¯å£å‡ºæ¥åˆ°èŠ‚ç‚¹ä¸Šé¢</span><br><span class="line"></span><br><span class="line"># å¯ä»¥å°è¯•ç™»é™†æµ‹è¯•</span><br><span class="line">[root@linux-node1 flask_app_db]# mysql -uroot -pdevopsdemo -h192<span class="number">.168</span><span class="number">.56</span><span class="number">.12</span> -P <span class="number">30006</span></span><br><span class="line">Welcome <span class="keyword">to</span> the MariaDB monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL <span class="keyword">connection</span> id <span class="keyword">is</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">Server</span> <span class="keyword">version</span>: <span class="number">5.6</span><span class="number">.40</span> MySQL Community <span class="keyword">Server</span> (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle, MariaDB Corporation Ab <span class="keyword">and</span> others.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> <span class="keyword">input</span> <span class="keyword">statement</span>.</span><br><span class="line"></span><br><span class="line">MySQL [(<span class="keyword">none</span>)]&gt; <span class="keyword">show</span> databases;</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| <span class="keyword">Database</span>           |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(<span class="keyword">none</span>)]&gt;</span><br><span class="line"></span><br><span class="line"># é¡ºä¾¿æˆ‘ä»¬åœ¨è¿™é‡Œæ‰‹åŠ¨åˆ›å»ºä¸€ä¸‹flask-appéœ€è¦ç”¨åˆ°çš„æ•°æ®åº“ devopsdemo, å› ä¸ºåœ¨flask-appåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­éœ€è¦å»åˆå§‹åŒ–æ•°æ®åº“å¹¶åˆ›å»ºæ•°æ®è¡¨ã€‚</span><br><span class="line">MySQL [(<span class="keyword">none</span>)]&gt; <span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> devopsdemo;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="keyword">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">#æ•°æ®åº“ç›®å½•,å¯ä»¥çœ‹åˆ°mysqlæ•°æ®å·²ç»é€šè¿‡nfsçš„æ–¹å¼å­˜å‚¨åˆ°äº†æˆ‘ä»¬nfs <span class="keyword">server</span>æ‰€åœ¨ä¸»æœºæ˜ å°„å‡ºå»çš„ç›®å½•</span><br><span class="line">[root@linux-node1 ~]# tree /data/flask-app-db/ -L <span class="number">1</span></span><br><span class="line">/data/flask-app-db/</span><br><span class="line">â”œâ”€â”€ auto.cnf</span><br><span class="line">â”œâ”€â”€ devopsdemo</span><br><span class="line">â”œâ”€â”€ ibdata1</span><br><span class="line">â”œâ”€â”€ ib_logfile0</span><br><span class="line">â”œâ”€â”€ ib_logfile1</span><br><span class="line">â”œâ”€â”€ mysql</span><br><span class="line">â””â”€â”€ performance_schema</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> directories, <span class="number">4</span> files</span><br></pre></td></tr></tbody></table></figure><h2 id="éƒ¨ç½²flask-app"><a href="#éƒ¨ç½²flask-app" class="headerlink" title="éƒ¨ç½²flask-app"></a>éƒ¨ç½²flask-app</h2><h4 id="1-å°†flaskç¨‹åºä»£ç æ”¾åˆ°-data-flask-app-data"><a href="#1-å°†flaskç¨‹åºä»£ç æ”¾åˆ°-data-flask-app-data" class="headerlink" title="1.å°†flaskç¨‹åºä»£ç æ”¾åˆ°/data/flask-app-data/"></a>1.å°†flaskç¨‹åºä»£ç æ”¾åˆ°/data/flask-app-data/</h4><figure class="highlight haskell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# cp -rf flask_app_code/* /<span class="class"><span class="keyword">data</span>/flask-app-<span class="keyword">data</span>/</span></span><br><span class="line">[root@linux-node1 ~]# tree /<span class="class"><span class="keyword">data</span>/flask-app-<span class="keyword">data</span>/ -<span class="type">L</span> 1</span></span><br><span class="line">/<span class="class"><span class="keyword">data</span>/flask-app-<span class="keyword">data</span>/</span></span><br><span class="line">â”œâ”€â”€ app</span><br><span class="line">â”œâ”€â”€ config.py</span><br><span class="line">â”œâ”€â”€ flask_uwsgi.ini</span><br><span class="line">â”œâ”€â”€ <span class="type">LICENSE</span></span><br><span class="line">â”œâ”€â”€ manage.py</span><br><span class="line">â”œâ”€â”€ <span class="type">README</span>.md</span><br><span class="line">â”œâ”€â”€ requirements.txt</span><br><span class="line">â”œâ”€â”€ screenshots</span><br><span class="line">â”œâ”€â”€ supervisord.conf</span><br><span class="line">â””â”€â”€ tests</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> directories, <span class="number">9</span> files</span><br></pre></td></tr></tbody></table></figure><h4 id="2-ä¿®æ”¹flaskç¨‹åºè¿æ¥æ•°æ®åº“çš„é…ç½®ä¿¡æ¯"><a href="#2-ä¿®æ”¹flaskç¨‹åºè¿æ¥æ•°æ®åº“çš„é…ç½®ä¿¡æ¯" class="headerlink" title="2. ä¿®æ”¹flaskç¨‹åºè¿æ¥æ•°æ®åº“çš„é…ç½®ä¿¡æ¯"></a>2. ä¿®æ”¹flaskç¨‹åºè¿æ¥æ•°æ®åº“çš„é…ç½®ä¿¡æ¯</h4><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# vim /data/flask-app-data/config.py</span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">    db_host = 'flask-app-db' # åœ¨podå¯åŠ¨è¿‡ç¨‹ä¸­ä¼šå»åŠ è½½k8sçš„ç¯å¢ƒå˜é‡ï¼›è¿™ä¸ªflask-app-db å°±æ˜¯mysqlçš„svc</span></span><br><span class="line"><span class="code">    db_user = 'root'         # é»˜è®¤ä¸ºroot</span></span><br><span class="line"><span class="code">    db_pass = "devopsdemo"   # æ•°æ®åº“å¯†ç </span></span><br><span class="line"><span class="code">    db_name = 'devopsdemo'   # æ•°æ®åº“åç§°</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><h4 id="3-éƒ¨ç½²flask-app"><a href="#3-éƒ¨ç½²flask-app" class="headerlink" title="3. éƒ¨ç½²flask-app"></a>3. éƒ¨ç½²flask-app</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]<span class="comment"># kubectl create -f flask_kubernetes/flask_app/flask_app_deployment.yaml</span></span><br><span class="line">deployment.apps <span class="string">"flask-app"</span> created</span><br><span class="line">[root@linux-node1 ~]<span class="comment"># kubectl create -f flask_kubernetes/flask_app/flask_app_service.yaml</span></span><br><span class="line">service <span class="string">"flask-app"</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹çŠ¶æ€:</span></span><br><span class="line">[root@linux-node1 ~]<span class="comment"># kubectl get pod,svc,deployment,rc -o wide   -n flask-app-extions-stage</span></span><br><span class="line">NAME                                   READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">pod<span class="symbol">/flask-app-65646687ff-4gg7g</span>         <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">17</span>h       <span class="number">10.2</span>.<span class="number">42.125</span>   <span class="number">192.168</span>.<span class="number">56.13</span></span><br><span class="line">pod<span class="symbol">/flask-app-65646687ff-7d5g6</span>         <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">17</span>h       <span class="number">10.2</span>.<span class="number">42.124</span>   <span class="number">192.168</span>.<span class="number">56.13</span></span><br><span class="line">pod<span class="symbol">/flask-app-65646687ff-xkq6k</span>         <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">17</span>h       <span class="number">10.2</span>.<span class="number">42.123</span>   <span class="number">192.168</span>.<span class="number">56.13</span></span><br><span class="line">pod<span class="symbol">/flask-app-db-6f55458666-h2dk7</span>      <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">1</span>          <span class="number">22</span>h       <span class="number">10.2</span>.<span class="number">15.108</span>   <span class="number">192.168</span>.<span class="number">56.12</span></span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE       SELECTOR</span><br><span class="line">service<span class="symbol">/flask-app</span>         ClusterIP   <span class="number">10.1</span>.<span class="number">173.169</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">3032</span><span class="symbol">/TCP</span>         <span class="number">22</span>h       app<span class="operator">=</span>flask-app</span><br><span class="line">service<span class="symbol">/flask-app-db</span>      NodePort    <span class="number">10.1</span>.<span class="number">68.29</span>     <span class="symbol">&lt;none&gt;</span>        <span class="number">3306</span>:<span class="number">30006</span><span class="symbol">/TCP</span>   <span class="number">22</span>h       app<span class="operator">=</span>flask-app-db</span><br><span class="line"></span><br><span class="line">NAME                                    DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES                         SELECTOR</span><br><span class="line">deployment.extensions<span class="symbol">/flask-app</span>         <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>            <span class="number">3</span>           <span class="number">22</span>h       flask-app    guomaoqiu<span class="operator">/</span>python27baseenv:v2   app<span class="operator">=</span>flask-app,tier<span class="operator">=</span>frontend</span><br><span class="line">deployment.extensions<span class="symbol">/flask-app-db</span>      <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>            <span class="number">1</span>           <span class="number">22</span>h       mysql        mysql:<span class="number">5.6</span>                      app<span class="operator">=</span>flask-app-db,tier<span class="operator">=</span>mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸Šå¯çŸ¥ æˆ‘çš„flask-appè¿è¡Œäº†ä¸‰ä¸ªå‰¯æœ¬ï¼›</span></span><br><span class="line"><span class="comment"># å¹¶ä¸”é‡‡ç”¨çš„æ˜¯ClusterIP Type,3032æ˜¯flask+supervisor+uwsgi ä¹‹å uwsgsi æš´éœ²å‡ºæ¥çš„äºŒç«¯å£</span></span><br><span class="line"><span class="comment"># æ­¤æ—¶æˆ‘ä»¬è®¿é—®æ˜¯æ²¡æœ‰ç”¨çš„ï¼›å› ä¸ºuwgsiéœ€è¦ç»“åˆç”¨åˆ°Nginxæ¥è®¿é—®ï¼›äºæ˜¯æˆ‘ä¸‹é¢å°†ä¼šéƒ¨ç½²nginx ---&gt; uwgsi(flask-app)</span></span><br></pre></td></tr></tbody></table></figure><hr><h2 id="éƒ¨ç½²flask-app-nginx"><a href="#éƒ¨ç½²flask-app-nginx" class="headerlink" title="éƒ¨ç½²flask-app-nginx"></a>éƒ¨ç½²flask-app-nginx</h2><p>å› ä¸ºè¿™ä¸ªnginxçš„é…ç½®æˆ‘è¿™é‡Œéœ€è¦ä¿®æ”¹åšä¸€äº›å®šåˆ¶æ–¹é¢çš„é…ç½®ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªå°†å•ä¸ªé…ç½®æ–‡ä»¶æŒ‚è½½åˆ°podé‡Œé¢çš„éœ€æ±‚ï¼›äºæ˜¯è¿™é‡Œä½¿ç”¨åˆ°äº†k8sçš„ConfigMapåŠŸèƒ½</p><h4 id="1-æ‰¾åˆ°éœ€è¦æŒ‚è½½è¿›podçš„nginxé…ç½®æ–‡ä»¶"><a href="#1-æ‰¾åˆ°éœ€è¦æŒ‚è½½è¿›podçš„nginxé…ç½®æ–‡ä»¶" class="headerlink" title="1. æ‰¾åˆ°éœ€è¦æŒ‚è½½è¿›podçš„nginxé…ç½®æ–‡ä»¶:"></a>1. æ‰¾åˆ°éœ€è¦æŒ‚è½½è¿›podçš„nginxé…ç½®æ–‡ä»¶:</h4><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# kubectl create  configmap nginx-<span class="keyword">conf</span> --from-<span class="keyword">file</span>=/root/flask_kubernetes/flask_app_nginx/nginx.<span class="keyword">conf</span> -<span class="keyword">n</span>  flask-<span class="keyword">app</span>-extions-stage</span><br><span class="line">[root@linux-node1 ~]# kubectl get configmap -<span class="keyword">n</span> flask-<span class="keyword">app</span>-extions-stage</span><br><span class="line">NAME         DATA      AGE</span><br><span class="line">nginx-<span class="keyword">conf</span>   1         11s</span><br><span class="line"># é€šè¿‡<span class="keyword">describe</span>å°±å¯ä»¥çœ‹åˆ°è¿™ä¸ª<span class="keyword">conf</span>çš„è¯¦ç»†å†…å®¹ï¼Œå…¶å®å°±åœ¨æˆ‘ä»¬nginx.<span class="keyword">conf</span>é…ç½®æ–‡ä»¶çš„åŸºç¡€ä¸ŠåŠ ä¸Šäº†k8sä¸€äº›ç‰¹æœ‰çš„å±æ€§å€¼</span><br><span class="line">[root@linux-node1 ~]# kubectl <span class="keyword">describe</span> configmap/nginx-<span class="keyword">conf</span> -<span class="keyword">n</span> flask-<span class="keyword">app</span>-extions-stage</span><br></pre></td></tr></tbody></table></figure><h4 id="2-éƒ¨ç½²flask-app-nginx"><a href="#2-éƒ¨ç½²flask-app-nginx" class="headerlink" title="2.éƒ¨ç½²flask-app-nginx"></a>2.éƒ¨ç½²flask-app-nginx</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 flask_app_nginx]<span class="comment"># kubectl create -f flask_app_nginx_deploy.yaml</span></span><br><span class="line">deployment.apps <span class="string">"flask-app-nginx"</span> created</span><br><span class="line">[root@linux-node1 flask_app_nginx]<span class="comment"># kubectl create -f flask_app_nginx_service.yaml</span></span><br><span class="line">service <span class="string">"flask-app-nginx"</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹çŠ¶æ€ï¼š</span></span><br><span class="line">[root@linux-node1 ~]<span class="comment"># kubectl get pod,svc,deployment,rc -o wide   -n flask-app-extions-stage</span></span><br><span class="line">NAME                                   READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">pod<span class="symbol">/flask-app-65646687ff-4gg7g</span>         <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">17</span>h       <span class="number">10.2</span>.<span class="number">42.125</span>   <span class="number">192.168</span>.<span class="number">56.13</span></span><br><span class="line">pod<span class="symbol">/flask-app-65646687ff-7d5g6</span>         <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">17</span>h       <span class="number">10.2</span>.<span class="number">42.124</span>   <span class="number">192.168</span>.<span class="number">56.13</span></span><br><span class="line">pod<span class="symbol">/flask-app-65646687ff-xkq6k</span>         <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">17</span>h       <span class="number">10.2</span>.<span class="number">42.123</span>   <span class="number">192.168</span>.<span class="number">56.13</span></span><br><span class="line">pod<span class="symbol">/flask-app-db-6f55458666-h2dk7</span>      <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">1</span>          <span class="number">22</span>h       <span class="number">10.2</span>.<span class="number">15.108</span>   <span class="number">192.168</span>.<span class="number">56.12</span></span><br><span class="line">pod<span class="symbol">/flask-app-nginx-657fd4c57c-p6qdx</span>   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">12</span>         <span class="number">18</span>h       <span class="number">10.2</span>.<span class="number">42.119</span>   <span class="number">192.168</span>.<span class="number">56.13</span></span><br><span class="line">pod<span class="symbol">/flask-app-nginx-657fd4c57c-v4qsp</span>   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">12</span>         <span class="number">18</span>h       <span class="number">10.2</span>.<span class="number">42.117</span>   <span class="number">192.168</span>.<span class="number">56.13</span></span><br><span class="line">pod<span class="symbol">/flask-app-nginx-657fd4c57c-xtpmm</span>   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">12</span>         <span class="number">18</span>h       <span class="number">10.2</span>.<span class="number">42.118</span>   <span class="number">192.168</span>.<span class="number">56.13</span></span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE       SELECTOR</span><br><span class="line">service<span class="symbol">/flask-app</span>         ClusterIP   <span class="number">10.1</span>.<span class="number">173.169</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">3032</span><span class="symbol">/TCP</span>         <span class="number">22</span>h       app<span class="operator">=</span>flask-app</span><br><span class="line">service<span class="symbol">/flask-app-db</span>      NodePort    <span class="number">10.1</span>.<span class="number">68.29</span>     <span class="symbol">&lt;none&gt;</span>        <span class="number">3306</span>:<span class="number">30006</span><span class="symbol">/TCP</span>   <span class="number">22</span>h       app<span class="operator">=</span>flask-app-db</span><br><span class="line">service<span class="symbol">/flask-app-nginx</span>   ClusterIP   <span class="number">10.1</span>.<span class="number">193.82</span>    <span class="symbol">&lt;none&gt;</span>        <span class="number">80</span><span class="symbol">/TCP</span>           <span class="number">21</span>h       app<span class="operator">=</span>flask-app-nginx</span><br><span class="line"></span><br><span class="line">NAME                                    DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES                         SELECTOR</span><br><span class="line">deployment.extensions<span class="symbol">/flask-app</span>         <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>            <span class="number">3</span>           <span class="number">22</span>h       flask-app    guomaoqiu<span class="operator">/</span>python27baseenv:v2   app<span class="operator">=</span>flask-app,tier<span class="operator">=</span>frontend</span><br><span class="line">deployment.extensions<span class="symbol">/flask-app-db</span>      <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>            <span class="number">1</span>           <span class="number">22</span>h       mysql        mysql:<span class="number">5.6</span>                      app<span class="operator">=</span>flask-app-db,tier<span class="operator">=</span>mysql</span><br><span class="line">deployment.extensions<span class="symbol">/flask-app-nginx</span>   <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>            <span class="number">3</span>           <span class="number">21</span>h       nginx        nginx:latest                   app<span class="operator">=</span>flask-app-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸Š è¿è¡Œäº†ä¸‰ä¸ªflak-app-nginx ,é‡‡ç”¨çš„æ˜¯ClusterIP Type</span></span><br><span class="line"><span class="comment"># è®¿é—®éªŒè¯,ç›´æ¥è®¿é—®çš„æ˜¯flask-app-nginx çš„VIP(ClusterIP)</span></span><br><span class="line">[root@linux-node1 ~]<span class="comment"># curl -I 10.1.193.82/auth/login</span></span><br><span class="line">HTTP<span class="symbol">/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="params">Server:</span> nginx<span class="symbol">/1.15.0</span></span><br><span class="line"><span class="params">Date:</span> Wed, <span class="number">27</span> Jun <span class="number">2018</span> <span class="number">04</span>:<span class="number">35</span>:<span class="number">12</span> GMT</span><br><span class="line"><span class="params">Content-Type:</span> text<span class="symbol">/html</span>; <span class="attr">charset</span><span class="operator">=</span>utf-<span class="number">8</span></span><br><span class="line"><span class="params">Content-Length:</span> <span class="number">4026</span></span><br><span class="line"><span class="params">Connection:</span> keep-alive</span><br><span class="line"><span class="params">Set-Cookie:</span> session<span class="operator">=</span>eyJjc3JmX3Rva2VuIjp7IiBiIjoiT0RrNVpXUmpZV014T1daalkyUmlOamRsWXpBNVpqUTVZMk0wTkRnMU9ERm1NVFUzTURrME5BPT0ifX0.DhSlgA.Biu7EYC7qfj4x8--HlR8VUZFUgk; HttpOnly; <span class="attr">Path</span><span class="operator">=</span><span class="operator">/</span></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šè¯´æ˜æˆ‘ä»¬èƒ½å¤ŸæˆåŠŸçš„è®¿é—®åˆ°æˆ‘ä»¬çš„flask-appæœåŠ¡å•¦,åœ¨ç”¨linux ç»ˆç«¯ä¸‹çš„w3m <a href="http://10.1.193.82/auth/login">http://10.1.193.82/auth/login</a> è®¿é—®ä¸€ä¸‹å‘¢ï¼Œè¯´æ˜ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼›é‚£åç«¯uwgsi or flask-app or flask-nginxçš„è®¿é—®æ—¥å¿—æ­¤æ—¶æ¯‹åº¸ç½®ç–‘æ˜¯å·²ç»æœ‰äº†çš„ã€‚</p><p><img src="https://github.com/guomaoqiu/flask_kubernetes/blob/master/screenshots/15300742642956.jpg?raw=true"></p><p>é‚£é—®é¢˜æ¥äº†ï¼›æ­¤æ—¶æˆ‘åªæ˜¯åœ¨é›†ç¾¤å†…éƒ¨èƒ½å¤Ÿè®¿é—®ï¼Œé‚£å¦‚ä½•åœ¨å¤–é¢è®¿é—®å‘¢ï¼Ÿé‚£å°±ä¸»è¦å°†flask_nginx_service.yamlä¸­çš„Typeè¯¥ä¸ºnodePort,ç„¶åä»æ–°éƒ¨ç½²ä¸€ä¸‹flask_app_nginx_services</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]<span class="comment"># more /root/flask_kubernetes/flask_app_nginx/flask_app_nginx_service.yaml</span></span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> flask-app-nginx</span><br><span class="line">  <span class="params">namespace:</span> flask-app-extions-stage</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">type:</span> NodePort</span><br><span class="line">  <span class="params">selector:</span></span><br><span class="line">    <span class="params">app:</span> flask-app-nginx</span><br><span class="line">  <span class="params">ports:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">protocol:</span> TCP</span><br><span class="line">    <span class="params">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="params">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="params">nodePort:</span> <span class="number">30001</span></span><br><span class="line">  <span class="params">selector:</span></span><br><span class="line">    <span class="params">app:</span> flask-app-nginx</span><br><span class="line"></span><br><span class="line">[root@linux-node1 ~]<span class="comment"># kubectl describe svc/flask-app-nginx -n flask-app-extions-stage</span></span><br><span class="line"><span class="params">Name:</span>              flask-app-nginx</span><br><span class="line"><span class="params">Namespace:</span>         flask-app-extions-stage</span><br><span class="line"><span class="params">Labels:</span>            <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Selector:</span>          app<span class="operator">=</span>flask-app-nginx</span><br><span class="line"><span class="params">Type:</span>              ClusterIP</span><br><span class="line"><span class="params">IP:</span>                <span class="number">10.1</span>.<span class="number">193.82</span></span><br><span class="line"><span class="params">Port:</span>              <span class="symbol">&lt;unset&gt;</span>  <span class="number">80</span><span class="symbol">/TCP</span></span><br><span class="line"><span class="params">TargetPort:</span>        <span class="number">80</span><span class="symbol">/TCP</span></span><br><span class="line"><span class="params">Endpoints:</span>         <span class="number">10.2</span>.<span class="number">42.117</span>:<span class="number">80</span>,<span class="number">10.2</span>.<span class="number">42.118</span>:<span class="number">80</span>,<span class="number">10.2</span>.<span class="number">42.119</span>:<span class="number">80</span></span><br><span class="line">Session <span class="params">Affinity:</span>  None</span><br><span class="line"><span class="params">Events:</span>            <span class="symbol">&lt;none&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ—¶å¦‚æœæ˜¯å¤–ç½‘è®¿é—®å°±åº”è¯¥æ˜¯NodeIP+nodePortå•¦ï¼š</p><p><img src="https://github.com/guomaoqiu/flask_kubernetes/blob/master/screenshots/15302385275244.jpg?raw=true"></p><p>ä½†æ˜¯è¿™ç§æ–¹å¼å¹¶ä¸æ˜¯å¾ˆç†æƒ³ï¼›æœ¬æ¥å°±æ˜¯è¦è®©ä»–ç›´æ¥è®¿é—®80 portçš„ï¼Œäºæ˜¯é‡‡ç”¨å¦å¤–ä¸€ç§æš´éœ²ç«¯å£çš„æ–¹å¼â€”â€”Ingress</p><p>ï¼ˆè¿™é‡Œæˆ‘è¿˜æ˜¯æŠŠflask-app-nginxçš„serviceæ”¹å›äº†ClusterIP)</p><hr><h2 id="éƒ¨ç½²-Ingress-Nginx"><a href="#éƒ¨ç½²-Ingress-Nginx" class="headerlink" title="éƒ¨ç½² Ingress-Nginx"></a>éƒ¨ç½² Ingress-Nginx</h2><p>Ingress ä½¿ç”¨å¼€æºçš„åå‘ä»£ç†è´Ÿè½½å‡è¡¡å™¨æ¥å®ç°å¯¹å¤–æš´æ¼æœåŠ¡ï¼Œæ¯”å¦‚ Nginxã€Apacheã€Haproxyç­‰ã€‚Nginx Ingress ä¸€èˆ¬æœ‰ä¸‰ä¸ªç»„ä»¶ç»„æˆï¼š</p><ul><li>Nginx åå‘ä»£ç†è´Ÿè½½å‡è¡¡å™¨</li><li>Ingress Controller å¯ä»¥ç†è§£ä¸ºæ§åˆ¶å™¨ï¼Œå®ƒé€šè¿‡ä¸æ–­çš„è·Ÿ Kubernetes API äº¤äº’ï¼Œå®æ—¶è·å–åç«¯ Serviceã€Pod ç­‰çš„å˜åŒ–ï¼Œæ¯”å¦‚æ–°å¢ã€åˆ é™¤ç­‰ï¼Œç„¶åç»“åˆ Ingress å®šä¹‰çš„è§„åˆ™ç”Ÿæˆé…ç½®ï¼Œç„¶ååŠ¨æ€æ›´æ–°ä¸Šè¾¹çš„ Nginx è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶åˆ·æ–°ä½¿é…ç½®ç”Ÿæ•ˆï¼Œæ¥è¾¾åˆ°æœåŠ¡è‡ªåŠ¨å‘ç°çš„ä½œç”¨ã€‚</li><li>Ingress åˆ™æ˜¯å®šä¹‰è§„åˆ™ï¼Œé€šè¿‡å®ƒå®šä¹‰æŸä¸ªåŸŸåçš„è¯·æ±‚è¿‡æ¥ä¹‹åè½¬å‘åˆ°é›†ç¾¤ä¸­æŒ‡å®šçš„ Serviceã€‚å®ƒå¯ä»¥é€šè¿‡ Yaml æ–‡ä»¶å®šä¹‰ï¼Œå¯ä»¥ç»™ä¸€ä¸ªæˆ–å¤šä¸ª Service å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ª Ingress è§„åˆ™ã€‚</li></ul><h4 id="1-è·å–å®˜æ–¹æä¾›çš„yaml"><a href="#1-è·å–å®˜æ–¹æä¾›çš„yaml" class="headerlink" title="1.è·å–å®˜æ–¹æä¾›çš„yaml"></a>1.è·å–å®˜æ–¹æä¾›çš„yaml</h4><figure class="highlight profile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# cd flask_8s &amp;&amp;  git clone https://github.com/kubernetes/ingress-nginx.git</span><br><span class="line">[root@linux-node1 ~]# tree flask_8s/ingress-nginx/</span><br><span class="line">flask_8s/ingress-nginx/</span><br><span class="line">â”œâ”€â”€ configmap.yaml               :æä¾›configmapå¯ä»¥åœ¨çº¿æ›´è¡Œnginxçš„é…ç½®</span><br><span class="line">â”œâ”€â”€ default-backend.yaml         :æä¾›ä¸€ä¸ªç¼ºçœçš„åå°é”™è¯¯é¡µé¢ <span class="number">404</span></span><br><span class="line">â”œâ”€â”€ mandatory.yaml               :è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†è¿™ä¸ªç›®å½•ä¸‹é¢æ‰€æœ‰yamlçš„å†…å®¹ï¼Œå¯ä»¥ä¸ç”¨</span><br><span class="line">â”œâ”€â”€ namespace.yaml               :åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ ingress-nginx</span><br><span class="line">â”œâ”€â”€ rbac.yaml :åˆ›å»ºå¯¹åº”çš„role rolebinding ç”¨äºrbac</span><br><span class="line">â”œâ”€â”€ tcp-services-configmap.yaml  :ä¿®æ”¹L4è´Ÿè½½å‡è¡¡é…ç½®çš„configmap</span><br><span class="line">â”œâ”€â”€ udp-services-configmap.yaml  :ä¿®æ”¹L4è´Ÿè½½å‡è¡¡é…ç½®çš„configmap</span><br><span class="line">â””â”€â”€ with-rbac.yaml               :æœ‰åº”ç”¨rbacçš„nginx-ingress-controllerç»„ä»¶   </span><br><span class="line"></span><br><span class="line"><span class="number">0</span> directories, <span class="number">8</span> files</span><br></pre></td></tr></tbody></table></figure><h4 id="2-ä¿®æ”¹å®˜æ–¹çš„é…ç½®"><a href="#2-ä¿®æ”¹å®˜æ–¹çš„é…ç½®" class="headerlink" title="2.ä¿®æ”¹å®˜æ–¹çš„é…ç½®"></a>2.ä¿®æ”¹å®˜æ–¹çš„é…ç½®</h4><ol><li>kind: DaemonSetï¼šå®˜æ–¹åŸå§‹æ–‡ä»¶ä½¿ç”¨çš„æ˜¯deploymentï¼Œreplicate ä¸º 1ï¼Œè¿™æ ·å°†ä¼šåœ¨æŸä¸€å°èŠ‚ç‚¹ä¸Šå¯åŠ¨å¯¹åº”çš„nginx-ingress-controller podã€‚å¤–éƒ¨æµé‡è®¿é—®è‡³è¯¥èŠ‚ç‚¹ï¼Œç”±è¯¥èŠ‚ç‚¹è´Ÿè½½åˆ†æ‹…è‡³å†…éƒ¨çš„serviceã€‚æµ‹è¯•ç¯å¢ƒè€ƒè™‘é˜²æ­¢å•ç‚¹æ•…éšœï¼Œæ”¹ä¸ºDaemonSetç„¶ååˆ æ‰replicate ï¼Œé…åˆäº²å’Œæ€§éƒ¨ç½²åœ¨åˆ¶å®šèŠ‚ç‚¹ä¸Šå¯åŠ¨nginx-ingress-controller podï¼Œç¡®ä¿æœ‰å¤šä¸ªèŠ‚ç‚¹å¯åŠ¨nginx-ingress-controller podï¼Œåç»­å°†è¿™äº›èŠ‚ç‚¹åŠ å…¥åˆ°å¤–éƒ¨ç¡¬ä»¶è´Ÿè½½å‡è¡¡ç»„å®ç°é«˜å¯ç”¨æ€§ã€‚</li><li>hostNetwork: trueï¼šæ·»åŠ è¯¥å­—æ®µï¼Œæš´éœ²nginx-ingress-controller podçš„æœåŠ¡ç«¯å£ï¼ˆ80ï¼‰</li><li>nodeSelector: å¢åŠ äº²å’Œæ€§éƒ¨ç½²ï¼Œæœ‰custom/ingress-controller-ready æ ‡ç­¾çš„èŠ‚ç‚¹æ‰ä¼šéƒ¨ç½²è¯¥DaemonSet</li></ol><h4 id="3-ä¸ºéœ€è¦éƒ¨ç½²nginx-ingress-controllerçš„èŠ‚ç‚¹è®¾ç½®lable"><a href="#3-ä¸ºéœ€è¦éƒ¨ç½²nginx-ingress-controllerçš„èŠ‚ç‚¹è®¾ç½®lable" class="headerlink" title="3.ä¸ºéœ€è¦éƒ¨ç½²nginx-ingress-controllerçš„èŠ‚ç‚¹è®¾ç½®lable"></a>3.ä¸ºéœ€è¦éƒ¨ç½²nginx-ingress-controllerçš„èŠ‚ç‚¹è®¾ç½®lable</h4><figure class="highlight moonscript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# kubectl label nodes <span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span> custom/ingress-controller-ready=<span class="literal">true</span></span><br><span class="line">[root@linux-node1 ~]# kubectl label nodes <span class="number">192.168</span><span class="number">.56</span><span class="number">.13</span> custom/ingress-controller-ready=<span class="literal">true</span></span><br><span class="line">[root@linux-node1 ~]# kubectl get nodes <span class="comment">--show-labels</span></span><br><span class="line">NAME            STATUS    ROLES     AGE       VERSION   LABELS</span><br><span class="line"><span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span>   Ready     &lt;none&gt;    <span class="number">28</span>d       v1<span class="number">.10</span><span class="number">.1</span>   beta.kubernetes.<span class="built_in">io</span>/arch=amd64,beta.kubernetes.<span class="built_in">io</span>/<span class="built_in">os</span>=linux,custom/ingress-controller-ready=<span class="literal">true</span>,kubernetes.<span class="built_in">io</span>/hostname=<span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.56</span><span class="number">.13</span>   Ready     &lt;none&gt;    <span class="number">27</span>d       v1<span class="number">.10</span><span class="number">.1</span>   beta.kubernetes.<span class="built_in">io</span>/arch=amd64,beta.kubernetes.<span class="built_in">io</span>/<span class="built_in">os</span>=linux,custom/ingress-controller-ready=<span class="literal">true</span>,kubernetes.<span class="built_in">io</span>/hostname=<span class="number">192.168</span><span class="number">.56</span><span class="number">.13</span></span><br><span class="line"></span><br><span class="line"># ä»¥ä¸Šï¼Œå› ä¸ºæˆ‘è¿™é‡Œå°±ä¸¤ä¸ªè®¡ç®—èŠ‚ç‚¹ï¼›æ‰€ä»¥éƒ½æ‰“ä¸Šcustom/ingress-controller-ready=<span class="literal">true</span>è¿™ä¸ªæ ‡ç­¾</span><br></pre></td></tr></tbody></table></figure><h4 id="4-æ‰§è¡Œåˆ›å»ºyamlæ–‡ä»¶"><a href="#4-æ‰§è¡Œåˆ›å»ºyamlæ–‡ä»¶" class="headerlink" title="4.æ‰§è¡Œåˆ›å»ºyamlæ–‡ä»¶:"></a>4.æ‰§è¡Œåˆ›å»ºyamlæ–‡ä»¶:</h4><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@linux</span><span class="operator">-</span>node1 <span class="operator">~</span>]# kubectl <span class="keyword">create</span> <span class="operator">-</span>f namespace.yaml</span><br><span class="line">[root<span class="variable">@linux</span><span class="operator">-</span>node1 <span class="operator">~</span>]# kubectl <span class="keyword">create</span> <span class="operator">-</span>f <span class="keyword">default</span><span class="operator">-</span>backend.yaml</span><br><span class="line">[root<span class="variable">@linux</span><span class="operator">-</span>node1 <span class="operator">~</span>]# kubectl <span class="keyword">create</span> <span class="operator">-</span>f configmap.yaml</span><br><span class="line">[root<span class="variable">@linux</span><span class="operator">-</span>node1 <span class="operator">~</span>]# kubectl <span class="keyword">create</span> <span class="operator">-</span>f tcp<span class="operator">-</span>services<span class="operator">-</span>configmap.yaml</span><br><span class="line">[root<span class="variable">@linux</span><span class="operator">-</span>node1 <span class="operator">~</span>]# kubectl <span class="keyword">create</span> <span class="operator">-</span>f udp<span class="operator">-</span>services<span class="operator">-</span>configmap.yaml</span><br><span class="line">[root<span class="variable">@linux</span><span class="operator">-</span>node1 <span class="operator">~</span>]# kubectl <span class="keyword">create</span> <span class="operator">-</span>f rbac.yaml</span><br><span class="line">[root<span class="variable">@linux</span><span class="operator">-</span>node1 <span class="operator">~</span>]# kubectl <span class="keyword">create</span> <span class="operator">-</span>f <span class="keyword">with</span><span class="operator">-</span>rbac.yaml</span><br></pre></td></tr></tbody></table></figure><h4 id="5-æŸ¥çœ‹åˆ›å»ºçŠ¶æ€ï¼š"><a href="#5-æŸ¥çœ‹åˆ›å»ºçŠ¶æ€ï¼š" class="headerlink" title="5.æŸ¥çœ‹åˆ›å»ºçŠ¶æ€ï¼š"></a>5.æŸ¥çœ‹åˆ›å»ºçŠ¶æ€ï¼š</h4><p>åˆ›å»ºè¿‡ç¨‹ä¼šå»æ‹‰é•œåƒæ¯”è¾ƒæ…¢ï¼Œå¯èƒ½ä¼šä¸æˆåŠŸï¼Œå‰é¢è¯´è¿‡é‚£éƒ½æ˜¯å› ä¸º`%#@%ï¿¥#@Â·çš„åŸå› ï¼Œ<br>æ‰€ä»¥è¿˜æ˜¯è®°å¾—ç»™dockerä¸€æŠŠæ¢¯å­ã€‚</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ~]# kubectl <span class="keyword">get</span> pod,svc,deployment,rc -o wide   -n ingress-nginx</span><br><span class="line"><span class="type">NAME</span>                                       READY     STATUS    RESTARTS   AGE       IP              NODE</span><br><span class="line">pod/<span class="keyword">default</span>-http-backend<span class="number">-5</span>c6d95c48-dwl56   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">16</span>h       <span class="number">10.2</span><span class="number">.42</span><span class="number">.130</span>     <span class="number">192.168</span><span class="number">.56</span><span class="number">.13</span></span><br><span class="line">pod/nginx-ingress-controller<span class="number">-55</span>trv         <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">15</span>h       <span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span>   <span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span></span><br><span class="line">pod/nginx-ingress-controller<span class="number">-58</span>nf4         <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">15</span>h       <span class="number">192.168</span><span class="number">.56</span><span class="number">.13</span>   <span class="number">192.168</span><span class="number">.56</span><span class="number">.13</span></span><br><span class="line"></span><br><span class="line"><span class="type">NAME</span>                           <span class="keyword">TYPE</span>        <span class="keyword">CLUSTER</span>-IP    <span class="keyword">EXTERNAL</span>-IP   PORT(S)   AGE       SELECTOR</span><br><span class="line">service/<span class="keyword">default</span>-http-backend   ClusterIP   <span class="number">10.1</span><span class="number">.89</span><span class="number">.141</span>   &lt;<span class="keyword">none</span>&gt;        <span class="number">80</span>/TCP    <span class="number">16</span>h       app=<span class="keyword">default</span>-http-backend</span><br><span class="line"></span><br><span class="line"><span class="type">NAME</span>                                         DESIRED   <span class="keyword">CURRENT</span>   UP-<span class="keyword">TO</span>-<span class="type">DATE</span>   AVAILABLE   AGE       CONTAINERS             IMAGES                                        SELECTOR</span><br><span class="line">deployment.extensions/<span class="keyword">default</span>-http-backend   <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>            <span class="number">1</span>           <span class="number">16</span>h       <span class="keyword">default</span>-http-backend   gcr.io/google_containers/defaultbackend:<span class="number">1.4</span>   app=<span class="keyword">default</span>-http-backend</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ä»¥ä¸Šå¯ä»¥çœ‹åˆ°nginx-ingress-controllerå·²ç»æˆåŠŸè¿è¡Œåœ¨äº†è¿™ä¸¤ä¸ªæ‰“äº†æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šé¢</span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ—¶åªæ˜¯æŠŠingressç»™æ­å»ºå¥½ï¼Œå¦‚æœè¦ç”¨å¾—æ ¹æ®å®é™…æƒ…å†µå†™è½¬å‘è§„åˆ™äº†ï¼Œå½“å‰æˆ‘ä»¬çš„ç›®çš„æ˜¯é€šè¿‡å®ƒå®šä¹‰æŸä¸ªåŸŸåçš„è¯·æ±‚è¿‡æ¥ä¹‹åè½¬å‘åˆ°é›†ç¾¤ä¸­æŒ‡å®šçš„ Serviceï¼Œå³æ­¤æ¬¡éƒ¨ç½²çš„ <code>flask-app-nginx</code></p><h4 id="6-åˆ›å»ºè§„åˆ™ï¼š"><a href="#6-åˆ›å»ºè§„åˆ™ï¼š" class="headerlink" title="6.åˆ›å»ºè§„åˆ™ï¼š"></a>6.åˆ›å»ºè§„åˆ™ï¼š</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ingress-nginx]<span class="comment"># cat &gt; test.ingress.yaml &lt; EOF</span></span><br><span class="line"><span class="params">apiVersion:</span> extensions<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> Ingress</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-ingress</span><br><span class="line">    <span class="params">namespace:</span> flask-app-extions-stage</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">host:</span> test.flaskapp.ingress</span><br><span class="line">    <span class="params">http:</span></span><br><span class="line">      <span class="params">paths:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">path:</span> <span class="symbol">/</span></span><br><span class="line">        <span class="params">backend:</span></span><br><span class="line">          <span class="params">serviceName:</span> flask-app-nginx</span><br><span class="line">          <span class="params">servicePort:</span> <span class="number">80</span></span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># host: å¯¹åº”çš„åŸŸå </span></span><br><span class="line"><span class="comment"># path: urlä¸Šä¸‹æ–‡ </span></span><br><span class="line"><span class="comment"># backend:åå‘è½¬å‘ åˆ°å¯¹åº”çš„ serviceName: servicePort:</span></span><br><span class="line"></span><br><span class="line">[root@linux-node1 ingress-nginx]<span class="comment"># kubectl apply -f test-ingress.yaml</span></span><br><span class="line">[root@linux-node1 ingress-nginx]<span class="comment"># kubectl get ingress -n flask-app-extions-stage</span></span><br><span class="line">NAME           HOSTS                   ADDRESS   PORTS     AGE</span><br><span class="line">test-ingress   test.flaskapp.ingress             <span class="number">80</span>        <span class="number">15</span>h</span><br><span class="line">[root@linux-node1 ingress-nginx]<span class="comment"># kubectl describe ingress/test-ingress -n flask-app-extions-stage</span></span><br><span class="line"><span class="params">Name:</span>             test-ingress</span><br><span class="line"><span class="params">Namespace:</span>        flask-app-extions-stage</span><br><span class="line"><span class="params">Address:</span></span><br><span class="line">Default <span class="params">backend:</span>  default-http-backend:<span class="number">80</span> (<span class="symbol">&lt;none&gt;</span>)</span><br><span class="line"><span class="params">Rules:</span></span><br><span class="line">  Host                   Path  Backends</span><br><span class="line">  <span class="operator">-</span>---                   <span class="operator">-</span>---  <span class="operator">-</span>-------</span><br><span class="line">  test.flaskapp.ingress</span><br><span class="line">                         <span class="symbol">/</span>   flask-app-nginx:<span class="number">80</span> (<span class="symbol">&lt;none&gt;</span>)</span><br><span class="line"><span class="params">Annotations:</span></span><br><span class="line"><span class="params">Events:</span></span><br><span class="line">  Type    Reason  Age   From                      Message</span><br><span class="line">  <span class="operator">-</span>---    <span class="operator">-</span>-----  <span class="operator">-</span>---  <span class="operator">-</span>---                      <span class="operator">-</span>------</span><br><span class="line">  Normal  CREATE  <span class="number">15</span>h   nginx-ingress-controller  Ingress flask-app-extions-stage<span class="symbol">/test-ingress</span></span><br><span class="line">  Normal  CREATE  <span class="number">15</span>h   nginx-ingress-controller  Ingress flask-app-extions-stage<span class="symbol">/test-ingress</span></span><br><span class="line">  Normal  CREATE  <span class="number">15</span>h   nginx-ingress-controller  Ingress flask-app-extions-stage<span class="symbol">/test-ingress</span></span><br><span class="line">  Normal  CREATE  <span class="number">15</span>h   nginx-ingress-controller  Ingress flask-app-extions-stage<span class="operator">/</span>test-ingress</span><br></pre></td></tr></tbody></table></figure><h4 id="7-æµ‹è¯•ï¼š"><a href="#7-æµ‹è¯•ï¼š" class="headerlink" title="7.æµ‹è¯•ï¼š"></a>7.æµ‹è¯•ï¼š</h4><p>æ—¢ç„¶æ˜¯é€šè¿‡åŸŸåè®¿é—®ï¼Œé‚£è¿™é‡Œæˆ‘å°±åœ¨node1ä¸Šé¢ç›´æ¥ä¿®æ”¹hostsçš„æ–¹å¼ç„¶åè®¿é—®</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@linux-node1</span> <span class="string">~</span>]<span class="comment"># echo "192.168.56.12 test.flaskapp.ingress" &gt;&gt; /etc/hosts</span></span><br><span class="line">[<span class="string">root@linux-node1</span> <span class="string">~</span>]<span class="comment"># echo "192.168.56.13 test.flaskapp.ingress" &gt;&gt; /etc/hosts</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@linux-node1</span> <span class="string">ingress-nginx</span>]<span class="comment"># curl -I test.flaskapp.ingress/auth/login</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">nginx/1.13.12</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Thu,</span> <span class="number">28</span> <span class="string">Jun</span> <span class="number">2018 02:59:16 </span><span class="string">GMT</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html;</span> <span class="string">charset=utf-8</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">4030</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"><span class="attr">Set-Cookie:</span> <span class="string">session=eyJjc3JmX3Rva2VuIjp7IiBiIjoiTXpGbFlUWmlOelV4WXpabVlqTXlNVFJpWTJVMk1HWTVObVV5TURRd09HSTNPVFV4WXprd01RPT0ifX0.DhXghA.3HHbX3fvShem9KlkINr8jDGwcSc;</span> <span class="string">HttpOnly;</span> <span class="string">Path=/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…æŒ‡å®šæ¨¡æ‹Ÿçš„åŸŸå:</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@linux-node1</span> <span class="string">ingress-nginx</span>]<span class="comment"># curl -vI http://192.168.56.12/auth/login -H 'host: test.flaskapp.ingress'</span></span><br><span class="line"><span class="string">*</span> <span class="string">About</span> <span class="string">to</span> <span class="string">connect()</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span> <span class="string">port</span> <span class="number">80</span> <span class="string">(#0)</span></span><br><span class="line"><span class="string">*</span>   <span class="string">Trying</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span><span class="string">...</span></span><br><span class="line"><span class="string">*</span> <span class="string">Connected</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.12</span> <span class="string">(192.168.56.12)</span> <span class="string">port</span> <span class="number">80</span> <span class="string">(#0)</span></span><br><span class="line"><span class="string">&gt;</span> <span class="string">HEAD</span> <span class="string">/auth/login</span> <span class="string">HTTP/1.1</span></span><br><span class="line"><span class="string">&gt;</span> <span class="attr">User-Agent:</span> <span class="string">curl/7.29.0</span></span><br><span class="line"><span class="string">&gt;</span> <span class="attr">Accept:</span> <span class="string">*/*</span></span><br><span class="line"><span class="string">&gt;</span> <span class="attr">host:</span> <span class="string">test.flaskapp.ingress</span></span><br><span class="line"><span class="string">&gt;</span></span><br><span class="line"><span class="string">&lt;</span> <span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="string">HTTP/1.1</span> <span class="number">200</span> <span class="string">OK</span></span><br><span class="line"><span class="string">&lt;</span> <span class="attr">Server:</span> <span class="string">nginx/1.13.12</span></span><br><span class="line"><span class="attr">Server:</span> <span class="string">nginx/1.13.12</span></span><br><span class="line"><span class="string">&lt;</span> <span class="attr">Date:</span> <span class="string">Thu,</span> <span class="number">28</span> <span class="string">Jun</span> <span class="number">2018 03:00:21 </span><span class="string">GMT</span></span><br><span class="line"><span class="attr">Date:</span> <span class="string">Thu,</span> <span class="number">28</span> <span class="string">Jun</span> <span class="number">2018 03:00:21 </span><span class="string">GMT</span></span><br><span class="line"><span class="string">&lt;</span> <span class="attr">Content-Type:</span> <span class="string">text/html;</span> <span class="string">charset=utf-8</span></span><br><span class="line"><span class="attr">Content-Type:</span> <span class="string">text/html;</span> <span class="string">charset=utf-8</span></span><br><span class="line"><span class="string">&lt;</span> <span class="attr">Content-Length:</span> <span class="number">4030</span></span><br><span class="line"><span class="attr">Content-Length:</span> <span class="number">4030</span></span><br><span class="line"><span class="string">&lt;</span> <span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">keep-alive</span></span><br><span class="line"><span class="string">&lt;</span> <span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"><span class="attr">Vary:</span> <span class="string">Accept-Encoding</span></span><br><span class="line"><span class="string">&lt;</span> <span class="attr">Set-Cookie:</span> <span class="string">session=eyJjc3JmX3Rva2VuIjp7IiBiIjoiT1RNMVpUWTBZV1V6TkdWaU5EazBZMkl5TmpZMFl6VTNPVFF3TVdaa09UVXpNall3T1RRNE1RPT0ifX0.DhXgxQ.BnjwR-swXvmD-kUGhtlvhpHuUIY;</span> <span class="string">HttpOnly;</span> <span class="string">Path=/</span></span><br><span class="line"><span class="attr">Set-Cookie:</span> <span class="string">session=eyJjc3JmX3Rva2VuIjp7IiBiIjoiT1RNMVpUWTBZV1V6TkdWaU5EazBZMkl5TmpZMFl6VTNPVFF3TVdaa09UVXpNall3T1RRNE1RPT0ifX0.DhXgxQ.BnjwR-swXvmD-kUGhtlvhpHuUIY;</span> <span class="string">HttpOnly;</span> <span class="string">Path=/</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;</span></span><br><span class="line"><span class="string">*</span> <span class="string">Connection</span> <span class="comment">#0 to host 192.168.56.12 left intact</span></span><br></pre></td></tr></tbody></table></figure><p>åœ¨å¤–éƒ¨å¦‚æœè¦è®¿é—®ä¹Ÿéœ€è¦ç»‘å®šåŸŸååˆ°nodeèŠ‚ç‚¹ï¼Œç„¶åè®¿é—®<br><img src="https://github.com/guomaoqiu/flask_kubernetes/blob/master/screenshots/15302383360947.jpg?raw=true"></p><p>okè‡³æ­¤è¯¥é¡¹ç›®å°±éƒ¨ç½²å¾—å·®ä¸å¤šäº†ï¼Œä¸Šé¢flask-appç™»å½•ï¼Œæ³¨å†Œæ­£å¸¸ï¼<br><img src="https://github.com/guomaoqiu/flask_kubernetes/blob/master/screenshots/15302375026023.jpg?raw=true"><br>é‚£podå¦‚ä½•åšåˆ°ä¼¸ç¼©å‘¢ï¼›æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°±è¡Œäº†</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># ç›®å‰æˆ‘çš„flask-appæ˜¯è¿è¡Œäº†<span class="number">3</span>ä¸ªï¼Œæ€¼<span class="number">20</span>ä¸ªflask-appåº”ç”¨</span><br><span class="line">[root@linux-node1 ~]# kubectl <span class="keyword">get</span> deploy/flask-app -n flask-app-extions-stage</span><br><span class="line"><span class="type">NAME</span>        DESIRED   <span class="keyword">CURRENT</span>   UP-<span class="keyword">TO</span>-<span class="type">DATE</span>   AVAILABLE   AGE</span><br><span class="line">flask-app   <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>            <span class="number">3</span>           <span class="number">23</span>h</span><br><span class="line">[root@linux-node1 ~]# kubectl scale <span class="comment">--replicas=20 deployment.extensions/flask-app -n flask-app-extions-stage</span></span><br><span class="line">deployment.extensions "flask-app" scaled</span><br><span class="line">[root@linux-node1 ~]# kubectl <span class="keyword">get</span> deploy/flask-app -n flask-app-extions-stage</span><br><span class="line"><span class="type">NAME</span>        DESIRED   <span class="keyword">CURRENT</span>   UP-<span class="keyword">TO</span>-<span class="type">DATE</span>   AVAILABLE   AGE</span><br><span class="line">flask-app   <span class="number">20</span>        <span class="number">20</span>        <span class="number">20</span>           <span class="number">20</span>          <span class="number">23</span>h</span><br><span class="line"># æ‰€ä»¥å‰¯æœ¬æ•°å°±æ˜¯é deplomentä¸­çš„ replicas æˆ–è€… å‘½ä»¤è¡Œçš„scale <span class="comment">--replicasæ¥æ§åˆ¶</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><hr><h3 id="éƒ¨ç½²æ€»ç»“ï¼š"><a href="#éƒ¨ç½²æ€»ç»“ï¼š" class="headerlink" title="éƒ¨ç½²æ€»ç»“ï¼š"></a>éƒ¨ç½²æ€»ç»“ï¼š</h3><p>å‘:<br>åœ¨ä¸Šé¢æˆ‘éƒ¨ç½²å¥½ingress-nginxåï¼Œé€šè¿‡è®¿é—®å“ªä¸€æ­¥æŠ¥é”™äº†ï¼›äºæ˜¯å»æŸ¥äº† pod/nginx-ingress-controller-58nf4 çš„æ—¥å¿—ï¼Œé”™è¯¯æ—¥å¿—åˆ·å±å•Š<br><img src="https://github.com/guomaoqiu/flask_kubernetes/blob/master/screenshots/15301582604316.jpg?raw=true"></p><p>å®˜æ–¹æ–‡æ¡£ä¸å®Œæ•´å•Šï¼Œå°‘äº†åˆ›å»ºingress-servicesçš„å†…å®¹ï¼›<br>è§£å†³åŠæ³•ï¼š</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ingress-nginx]<span class="comment"># cat &gt; ingress-nginx-services.yaml &lt; EOF</span></span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> ingress-nginx</span><br><span class="line">  <span class="params">namespace:</span> ingress-nginx</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">type:</span> NodePort</span><br><span class="line">  <span class="params">ports:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> http</span><br><span class="line">    <span class="params">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="params">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="params">protocol:</span> TCP</span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> https</span><br><span class="line">    <span class="params">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="params">targetPort:</span> <span class="number">443</span></span><br><span class="line">    <span class="params">protocol:</span> TCP</span><br><span class="line">  <span class="params">selector:</span></span><br><span class="line">    <span class="params">app:</span> ingress-nginx</span><br><span class="line">EOF</span><br><span class="line">[root@linux-node1 ingress-nginx]<span class="comment"># kubectl create -f ingress-nginx-services.yaml</span></span><br></pre></td></tr></tbody></table></figure><p>éƒ¨ç½²é‡åˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹ï¼š</p><ul><li>K8S deploymentçš„yamlæ–‡ä»¶ç¼–å†™ï¼›</li><li>K8S æŒä¹…åŒ–å­˜å‚¨NFSæ–¹å¼ï¼›é…ç½®ç®¡ç†ConfigMap;</li><li>K8S é›†ç¾¤ä¸­å„ç§ç«¯å£/IPç±»å‹çš„å·¥ä½œæ¨¡å¼ä»¥åŠæœåŠ¡æš´éœ²æ–¹å¼ï¼›</li></ul><p>by the way: å¯èƒ½çœ‹åˆ°æˆ‘åˆ›å»ºçš„podç­‰èµ„æºçš„AGEå·²ç»æ˜¯è¿‡å»åå‡ ä¸ªå°æ—¶ï¼Œè¿™ä¸ªæ²¡å…³ç³»çš„ï¼›å‰é¢åˆ›å»ºäº†ä¹‹åç¬”è®°å°±åœé¡¿äº†ä¸€ä¸‹ã€‚åç»­æ‰ç»§ç»­å†™çš„ğŸºğŸºğŸº</p>]]></content>
      
      
      <categories>
          
          <category> kubernets </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernets </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker éƒ¨ç½²</title>
      <link href="/2018/06/18/nginx-uwsgi-flask-supervisord-redis-mysql-docker-e9-83-a8-e7-bd-b2-2/"/>
      <url>/2018/06/18/nginx-uwsgi-flask-supervisord-redis-mysql-docker-e9-83-a8-e7-bd-b2-2/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰ä½¿ç”¨Flaskå¼€å‘äº†ä¸¤ä¸‰ä¸ªå…¬å¸æˆ–ä¸ªäººä½¿ç”¨çš„å¹³å°ï¼›åœ¨æ­å»ºè¿‡ç¨‹å½“ä¸­å¦‚æœæ¢äº†ç¯å¢ƒçš„è¯æ¯”è¾ƒéº»çƒ¦ï¼›è¿™æ¬¡å°è¯•æ”¾åˆ°dockeré‡Œé¢å»è·‘ï¼›ä¸‹é¢æ˜¯æ­å»ºçš„ä¸€ä¸ªè¿‡ç¨‹ä»¥åŠå¯¹äºå­¦ä¹ çš„ä¸€ä¸ªè®°å½•ï¼Œæ­¤æ¬¡webæ¡†æ¶è¿˜æ˜¯ä½¿ç”¨çš„ä¹‹å‰ç”¨Flaskå†™çš„ä¸€ä¸ªåŸºç¡€åå°ã€‚</p><h2 id="éƒ¨ç½²æ¶æ„"><a href="#éƒ¨ç½²æ¶æ„" class="headerlink" title="éƒ¨ç½²æ¶æ„:"></a>éƒ¨ç½²æ¶æ„:</h2><pre><code>.â”œâ”€â”€ README.mdâ”œâ”€â”€ docker-compose.yaml              # ä½¿ç”¨docker-composeæ¥ç¼–æ’éƒ¨ç½²â”œâ”€â”€ flask_app                        # ç”¨äºè·‘Flaskåº”ç”¨çš„å®¹å™¨â”‚&nbsp;&nbsp; â”œâ”€â”€ Dockerfileâ”‚&nbsp;&nbsp; â””â”€â”€ wait_for_db_complete.shâ”œâ”€â”€ flask_app_code                   # åç«¯é¡¹ç›®åº”ç”¨ä»£ç ç›®â”‚&nbsp;&nbsp; â”œâ”€â”€ LICENSEâ”‚&nbsp;&nbsp; â”œâ”€â”€ README.mdâ”‚&nbsp;&nbsp; â”œâ”€â”€ appâ”‚&nbsp;&nbsp; â”œâ”€â”€ config.pyâ”‚&nbsp;&nbsp; â”œâ”€â”€ manage.pyâ”‚&nbsp;&nbsp; â”œâ”€â”€ requirements.txtâ”‚&nbsp;&nbsp; â”œâ”€â”€ screenshotsâ”‚&nbsp;&nbsp; â””â”€â”€ testsâ”œâ”€â”€ nginx                            # Nginxç”¨äºå‰ç«¯æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„å®¹å™¨â”‚&nbsp;&nbsp; â””â”€â”€ nginx.confâ”œâ”€â”€ python27_baseenv                 # åŸºç¡€Pythonç¯å¢ƒé•œåƒâ”‚&nbsp;&nbsp; â”œâ”€â”€ Dockerfileâ”‚&nbsp;&nbsp; â””â”€â”€ README.mdâ”œâ”€â”€ supervisor                       # ç”¨äºç®¡ç†uwsgiæœåŠ¡è¿›ç¨‹â”‚&nbsp;&nbsp; â””â”€â”€ supervisord.confâ””â”€â”€ uwsgi                            # é€šè¿‡uWsgiæ¥ä¸ºNginx-Flaskç‰µçº¿æ­æ¡¥    â””â”€â”€ flask_uwsgi.ini</code></pre><h2 id="è®¿é—®æµç¨‹"><a href="#è®¿é—®æµç¨‹" class="headerlink" title="è®¿é—®æµç¨‹:"></a>è®¿é—®æµç¨‹:</h2><p><img src="https://raw.githubusercontent.com/guomaoqiu/Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker/master/flask_app_code/screenshots/261529307197_.pic_hd.jpg"></p><ul><li>Nginx WebæœåŠ¡å™¨å±‚ä½œä¸ºå‰ç«¯æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼›</li><li>uWSGIå±‚ä½œä¸ºWebæœåŠ¡å™¨å±‚ä¸Webæ¡†æ¶å±‚Flaskçš„ä¸€æ¡çº½å¸¦ï¼Œå°†WebæœåŠ¡å™¨å±‚ä¸Webæ¡†æ¶è¿æ¥èµ·æ¥</li><li>åç«¯Webæ¡†æ¶ä¸æ•°æ®å±‚MySQLæˆ–Redisäº¤äº’</li></ul><h3 id="ç®€å•ç†è§£èµ·æ¥å°±æ˜¯é…±ç´«çš„"><a href="#ç®€å•ç†è§£èµ·æ¥å°±æ˜¯é…±ç´«çš„" class="headerlink" title="ç®€å•ç†è§£èµ·æ¥å°±æ˜¯é…±ç´«çš„:"></a>ç®€å•ç†è§£èµ·æ¥å°±æ˜¯é…±ç´«çš„:</h3><ol><li>Nginxï¼šHeyï¼ŒWSGIï¼Œæˆ‘åˆšæ”¶åˆ°äº†ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘éœ€è¦ä½ ä½œäº›å‡†å¤‡ï¼Œç„¶åç”±Flaskæ¥å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚</li><li>WSGIï¼šOKï¼ŒNginxã€‚æˆ‘ä¼šè®¾ç½®å¥½ç¯å¢ƒå˜é‡ï¼Œç„¶åå°†è¿™ä¸ªè¯·æ±‚ä¼ é€’ç»™Flaskå¤„ç†ã€‚</li><li>Flaskï¼šThanks WSGIï¼ç»™æˆ‘ä¸€äº›æ—¶é—´ï¼Œæˆ‘å°†ä¼šæŠŠè¯·æ±‚çš„å“åº”è¿”å›ç»™ä½ ã€‚</li><li>WSGIï¼šAlrightï¼Œé‚£æˆ‘ç­‰ä½ ã€‚</li><li>Flaskï¼šOkayï¼Œæˆ‘å®Œæˆäº†ï¼Œè¿™é‡Œæ˜¯è¯·æ±‚çš„å“åº”ç»“æœï¼Œè¯·æ±‚æŠŠç»“æœä¼ é€’ç»™Nginxã€‚ WSGIï¼šGood jobï¼</li><li>Nginxï¼Œè¿™é‡Œæ˜¯å“åº”ç»“æœï¼Œå·²ç»æŒ‰ç…§è¦æ±‚ç»™ä½ ä¼ é€’å›æ¥äº†ã€‚</li><li>Nginxï¼šCoolï¼Œæˆ‘æ”¶åˆ°äº†ï¼Œæˆ‘æŠŠå“åº”ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¤§å®¶åˆä½œæ„‰å¿«~</li></ol><h2 id="æ­å»ºæ€è·¯"><a href="#æ­å»ºæ€è·¯" class="headerlink" title="æ­å»ºæ€è·¯:"></a>æ­å»ºæ€è·¯:</h2><ul><li>Nginx å•ç‹¬ä¸€ä¸ªå®¹å™¨</li><li>uWSGI+Flask å•ç‹¬ä¸€ä¸ªå®¹å™¨ï¼Œå…¶ä¸­uWSGIè¿›ç¨‹ç”±Supervisoræ¥ç®¡ç†</li><li>MySQL å•ç‹¬ä¸€ä¸ªå®¹å™¨ï¼Œæ•°æ®ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœº</li><li>Redis å•ç‹¬ä¸€ä¸ªå®¹å™¨</li></ul><p>å„ä¸ªå®¹å™¨ä¹‹é—´çš„å…³è”é€šè¿‡docker-composeç¼–æ’æ¥å®ç°</p><h2 id="éƒ¨ç½²æ­¥éª¤ï¼š"><a href="#éƒ¨ç½²æ­¥éª¤ï¼š" class="headerlink" title="éƒ¨ç½²æ­¥éª¤ï¼š"></a>éƒ¨ç½²æ­¥éª¤ï¼š</h2><p>ä¸»è¦è¿˜æ˜¯é€šè¿‡ç¼–å†™Dockerfileæ¥å®šåˆ¶ç‰¹å®šçš„è¿è¡Œç¯å¢ƒé•œåƒ</p><h5 id="0-å®‰è£…dockerç¯å¢ƒ"><a href="#0-å®‰è£…dockerç¯å¢ƒ" class="headerlink" title="0.å®‰è£…dockerç¯å¢ƒ"></a>0.å®‰è£…dockerç¯å¢ƒ</h5><pre><code>cd /etc/yum.repos.d/wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repoyum install -y docker-ce docker-composesystemctl start docker</code></pre><h5 id="1-æ„å»ºpythonåŸºç¡€è¿è¡Œç¯å¢ƒé•œåƒï¼ŒåŸºäºalpineé•œåƒ"><a href="#1-æ„å»ºpythonåŸºç¡€è¿è¡Œç¯å¢ƒé•œåƒï¼ŒåŸºäºalpineé•œåƒ" class="headerlink" title="1.æ„å»ºpythonåŸºç¡€è¿è¡Œç¯å¢ƒé•œåƒï¼ŒåŸºäºalpineé•œåƒ"></a>1.æ„å»ºpythonåŸºç¡€è¿è¡Œç¯å¢ƒé•œåƒï¼ŒåŸºäºalpineé•œåƒ</h5><pre><code>cd Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Dockerdocker build -f python27_baseenv/Dockerfile . -t python27_baseenv</code></pre><h5 id="2-æ„å»ºFlaskåº”ç”¨æ¡†æ¶è¿è¡Œæ‰€éœ€ä¾èµ–åŒ…é•œåƒ"><a href="#2-æ„å»ºFlaskåº”ç”¨æ¡†æ¶è¿è¡Œæ‰€éœ€ä¾èµ–åŒ…é•œåƒ" class="headerlink" title="2.æ„å»ºFlaskåº”ç”¨æ¡†æ¶è¿è¡Œæ‰€éœ€ä¾èµ–åŒ…é•œåƒ"></a>2.æ„å»ºFlaskåº”ç”¨æ¡†æ¶è¿è¡Œæ‰€éœ€ä¾èµ–åŒ…é•œåƒ</h5><pre><code>cd Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Dockerdocker build -f flask_app/Dockerfile . -t flask_app</code></pre><h5 id="4-Nginxé•œåƒä½¿ç”¨é»˜è®¤ï¼Œé…ç½®æ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼Œè¿™é‡Œé€šè¿‡æŒ‚è½½æ–¹å¼"><a href="#4-Nginxé•œåƒä½¿ç”¨é»˜è®¤ï¼Œé…ç½®æ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼Œè¿™é‡Œé€šè¿‡æŒ‚è½½æ–¹å¼" class="headerlink" title="4.Nginxé•œåƒä½¿ç”¨é»˜è®¤ï¼Œé…ç½®æ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼Œè¿™é‡Œé€šè¿‡æŒ‚è½½æ–¹å¼"></a>4.Nginxé•œåƒä½¿ç”¨é»˜è®¤ï¼Œé…ç½®æ–‡ä»¶éœ€è¦ä¿®æ”¹ï¼Œè¿™é‡Œé€šè¿‡æŒ‚è½½æ–¹å¼</h5><h5 id="5-Redisé•œåƒä½¿ç”¨é»˜è®¤çš„"><a href="#5-Redisé•œåƒä½¿ç”¨é»˜è®¤çš„" class="headerlink" title="5.Redisé•œåƒä½¿ç”¨é»˜è®¤çš„"></a>5.Redisé•œåƒä½¿ç”¨é»˜è®¤çš„</h5><h5 id="6-æ‰§è¡Œdocker-compose"><a href="#6-æ‰§è¡Œdocker-compose" class="headerlink" title="6.æ‰§è¡Œdocker-compose"></a>6.æ‰§è¡Œdocker-compose</h5><pre><code>cd Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Dockerdocker-compose up</code></pre><h4 id="è¿è¡ŒçŠ¶æ€"><a href="#è¿è¡ŒçŠ¶æ€" class="headerlink" title="è¿è¡ŒçŠ¶æ€"></a>è¿è¡ŒçŠ¶æ€</h4><p><img src="https://raw.githubusercontent.com/guomaoqiu/Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker/master/flask_app_code/screenshots/status.jpeg"></p><h4 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•"></a>ç™»å½•</h4><p><img src="https://raw.githubusercontent.com/guomaoqiu/Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker/master/flask_app_code/screenshots/login.jpeg"></p><h4 id="ç”¨æˆ·æ³¨å†Œ"><a href="#ç”¨æˆ·æ³¨å†Œ" class="headerlink" title="ç”¨æˆ·æ³¨å†Œ"></a>ç”¨æˆ·æ³¨å†Œ</h4><p><img src="https://raw.githubusercontent.com/guomaoqiu/Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker/master/flask_app_code/screenshots/login_unconfiremd.jpeg"><br><img src="https://raw.githubusercontent.com/guomaoqiu/Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker/master/flask_app_code/screenshots/email.jpeg"><br><img src="https://raw.githubusercontent.com/guomaoqiu/Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker/master/flask_app_code/screenshots/login_ok.jpeg"><br><img src="https://raw.githubusercontent.com/guomaoqiu/Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker/master/flask_app_code/screenshots/db.jpeg"></p><h4 id="Flaskåº”ç”¨çš„è®¿é—®ã€ç™»å½•ã€æ³¨å†Œè¿‡ç¨‹æ—¥å¿—"><a href="#Flaskåº”ç”¨çš„è®¿é—®ã€ç™»å½•ã€æ³¨å†Œè¿‡ç¨‹æ—¥å¿—" class="headerlink" title="Flaskåº”ç”¨çš„è®¿é—®ã€ç™»å½•ã€æ³¨å†Œè¿‡ç¨‹æ—¥å¿—"></a>Flaskåº”ç”¨çš„è®¿é—®ã€ç™»å½•ã€æ³¨å†Œè¿‡ç¨‹æ—¥å¿—</h4><h5 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h5><p><img src="https://raw.githubusercontent.com/guomaoqiu/Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker/master/flask_app_code/screenshots/nginxlog.jpeg"></p><h5 id="uWSGI"><a href="#uWSGI" class="headerlink" title="uWSGI"></a>uWSGI</h5><p><img src="https://raw.githubusercontent.com/guomaoqiu/Nginx-uWsgi-Flask-Supervisord-Redis-MySQL-Docker/master/flask_app_code/screenshots/uwsgilog.jpeg"></p><h2 id="éƒ¨ç½²æ€»ç»“"><a href="#éƒ¨ç½²æ€»ç»“" class="headerlink" title="éƒ¨ç½²æ€»ç»“:"></a>éƒ¨ç½²æ€»ç»“:</h2><p>éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼Œæ„Ÿè§‰åœ¨å®¿ä¸»æœºä¸­éƒ¨ç½²è¿˜æ˜¯æ²¡å¤šå¤§çš„åŒºåˆ«ï¼Œå·®åˆ«å¯èƒ½æ˜¯åœ¨æ•ˆç‡ä¸Šé¢ã€‚å®¿ä¸»æœºä¸­ä¸èƒ½å½±å“ç³»ç»Ÿè‡ªå¸¦çš„ä¸€äº›ä¸œè¥¿ï¼Œæ¯”å¦‚pythonçš„ç‰ˆæœ¬ï¼Œè¿™æ—¶å€™å¯èƒ½å°±éœ€è¦ç”¨åˆ°virtualenv, å¦‚æœæœåŠ¡å™¨è¿ç§»äº†é‚£æ•´ä¸ªç¯å¢ƒå°±éœ€è¦é‡æ–°æ­å»ºï¼Œè¿˜æ˜¯ä¸å¤ªæ–¹ä¾¿ã€‚</p><p>æ­¤æ¬¡éƒ¨ç½²å‘¢ä¸»è¦ç›®çš„è¿˜æ˜¯ä»¥è¿™ä¸ªä¸ºä¸€ä¸ªå®è·µç›®æ ‡å»å­¦ä¹ dockerçš„composeæ–‡ä»¶ç¼–å†™ï¼Œå†æŠŠå„ä¸ªå·¥å…·ç»“åˆåœ¨ä¸€èµ·è·‘åœ¨dockerä¸­å®ç°ä¹‹å‰åœ¨å®¿ä¸»æœºä¸­çš„ä¸œè¥¿ï¼›å…¶å®æŠŠæ•´ä¸ªæµç¨‹æ¢³ç†æ¸…æ¥šåç¼–å†™yamlæ–‡ä»¶ä¹Ÿå¾ˆå¿«çš„ã€‚åç»­å°è¯•æ”¾åˆ°k8sé›†ç¾¤ä¸­è·‘ğŸºğŸºğŸº</p><p>åœ¨æˆ‘çš„VPSä¸Šé¢è·‘èµ·æ¥äº†â€¦ <a href="http://blog.sctux.com:8090/">http://blog.sctux.com:8090</a></p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>09-K8sé›†ç¾¤æ­å»º---ç›‘æ§å±•ç¤ºç•Œé¢å®‰è£…</title>
      <link href="/2018/06/08/09k8s-ji-qun-da-jianjian-kong-zhan-shi-jie-mian-an/"/>
      <url>/2018/06/08/09k8s-ji-qun-da-jianjian-kong-zhan-shi-jie-mian-an/</url>
      
        <content type="html"><![CDATA[<h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p>Heapsteræä¾›äº†æ•´ä¸ªé›†ç¾¤çš„èµ„æºç›‘æ§ï¼Œå¹¶æ”¯æŒæŒä¹…åŒ–æ•°æ®å­˜å‚¨åˆ°InfluxDBã€Google Cloud Monitoringæˆ–è€…å…¶ä»–çš„å­˜å‚¨åç«¯ã€‚<br>Heapsterä»kubeletæä¾›çš„APIé‡‡é›†èŠ‚ç‚¹å’Œå®¹å™¨çš„èµ„æºå ç”¨ã€‚å¦å¤–ï¼ŒHeapsterçš„ /metrics APIæä¾›äº†Prometheusæ ¼å¼çš„æ•°æ®ã€‚<br>InfluxDBæ˜¯ä¸€ä¸ªå¼€æºåˆ†å¸ƒå¼æ—¶åºã€äº‹ä»¶å’ŒæŒ‡æ ‡æ•°æ®åº“ï¼›è€ŒGrafanaåˆ™æ˜¯InfluxDBçš„ dashboardï¼Œæä¾›äº†å¼ºå¤§çš„å›¾è¡¨å±•ç¤ºåŠŸèƒ½ã€‚å®ƒä»¬å¸¸è¢«ç»„åˆä½¿ç”¨å±•ç¤ºå›¾è¡¨åŒ–çš„ç›‘æ§æ•°æ®ï¼Œä¹Ÿå¯ä»¥å°†Zabbixä½œä¸ºæ•°æ®æºï¼Œè¿›è¡Œzabbixçš„ç›‘æ§æ•°æ®å±•ç¤ºã€‚<br>Heapsterã€InfluxDBå’ŒGrafanaå‡ä»¥Podçš„å½¢å¼å¯åŠ¨å’Œè¿è¡Œï¼Œå…¶ä¸­Heapsteréœ€è¦ä¸Kubernetes Masterè¿›è¡Œå®‰å…¨è¿æ¥ã€‚</p><h2 id="2-å®‰è£…é…ç½®Heapsterã€InfluxDBå’ŒGrafana"><a href="#2-å®‰è£…é…ç½®Heapsterã€InfluxDBå’ŒGrafana" class="headerlink" title="2. å®‰è£…é…ç½®Heapsterã€InfluxDBå’ŒGrafana"></a>2. å®‰è£…é…ç½®Heapsterã€InfluxDBå’ŒGrafana</h2><p><a href="https://github.com/kubernetes/heapster/releases">åˆ°Heapsterè·å–å®‰è£…åŒ…:</a></p><pre><code>[root@linux-node1 tmp]# wget https://github.com/kubernetes/heapster/archive/v1.5.3.tar.gz[root@linux-node1 tmp]# tar -xf v1.5.3.tar.gz &amp;&amp; cd heapster-1.5.3/deploy/kube-config/influxdb/[root@linux-node1 kube-config]# ll influxdb/total 12-rw-rw-r-- 1 root root 2290 May  1 05:13 grafana.yaml-rw-rw-r-- 1 root root 1114 May  1 05:13 heapster.yaml-rw-rw-r-- 1 root root  974 May  1 05:13 influxdb.yaml[root@linux-node1 kube-config]# ll rbac/total 4-rw-rw-r-- 1 root root 264 May  1 05:13 heapster-rbac.yaml[root@linux-node1 kube-config]## ä»¥ä¸Šæ˜¯æ‰€éœ€è¦ç”¨åˆ°çš„æ–‡ä»¶</code></pre><h2 id="3-é…ç½®Docker-Socks5ä»£ç†-ä¸ºä¸‹è½½æ‰€éœ€é•œåƒåšå‡†å¤‡"><a href="#3-é…ç½®Docker-Socks5ä»£ç†-ä¸ºä¸‹è½½æ‰€éœ€é•œåƒåšå‡†å¤‡" class="headerlink" title="3. é…ç½®Docker Socks5ä»£ç†(ä¸ºä¸‹è½½æ‰€éœ€é•œåƒåšå‡†å¤‡)"></a>3. é…ç½®Docker Socks5ä»£ç†(ä¸ºä¸‹è½½æ‰€éœ€é•œåƒåšå‡†å¤‡)</h2><p>ç”±äºæŸå›½çš„ &amp;@#ï¿¥%&amp;ï¿¥&amp;&amp;*R#ï¿¥â€¦â€¦ ä½ æ‡‚çš„. å¯¼è‡´ä¸€äº›é•œåƒæ— æ³•pull æˆ‘è¿™è¾¹åˆ©ç”¨è‡ªå·±æ­å»ºçš„æ¢¯å­æ¥è¿›è¡Œä»£ç†</p><pre><code>[root@linux-node1 kube-config]# grep "gcr.io" influxdb/heapster.yaml        image: gcr.io/google_containers/heapster-amd64:v1.5.3[root@linux-node1 kube-config]## ä¿®æ”¹dockeræœåŠ¡æ–‡ä»¶é…ç½®, åœ¨[Service]éƒ¨åˆ†æ·»åŠ ä½ è‡ªå·±çš„ssæœåŠ¡å™¨åœ°å€[root@linux-node1 kube-config]# vim /usr/lib/systemd/system/docker.service............[Service]Environment="ALL_PROXY=socks5://192.168.56.1:1080"............</code></pre><p>å°†å…¶å¤åˆ¶åˆ°å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶é‡è½½ã€é‡å¯DockeræœåŠ¡, ç›´æ¥pullä¸€ä¸‹éªŒè¯å³å¯</p><pre><code>[root@linux-node1 kube-config]# docker pull gcr.io/google_containers/heapster-amd64:v1.5.3</code></pre><h2 id="4-å…³é”®ç‚¹è¯´æ˜"><a href="#4-å…³é”®ç‚¹è¯´æ˜" class="headerlink" title="4. å…³é”®ç‚¹è¯´æ˜:"></a>4. å…³é”®ç‚¹è¯´æ˜:</h2><pre><code>[root@linux-node1 kube-config]# more influxdb/heapster.yaml............     - /heapster        - --source=kubernetes:https://kubernetes.default        - --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086............</code></pre><ul><li>sourceï¼šé…ç½®é‡‡é›†æºï¼Œä¸ºMaster URLåœ°å€ï¼šâ€“source=kubernetes:<a href="https://kubernetes.default/">https://kubernetes.default</a></li><li>sinkï¼šé…ç½®åç«¯å­˜å‚¨ç³»ç»Ÿï¼Œä½¿ç”¨InfluxDBç³»ç»Ÿï¼šâ€“sink=influxdb:<a href="http://monitoring-influxdb:8086/">http://monitoring-influxdb:8086</a></li></ul><p>è¿™é‡Œä¿æŒé»˜è®¤å³å¯</p><p>ã€æ³¨æ„ã€‘ï¼šURLä¸­çš„ä¸»æœºååœ°å€ä½¿ç”¨çš„æ˜¯InfluxDBçš„Serviceåå­—ï¼Œè¿™éœ€è¦DNSæœåŠ¡æ­£å¸¸å·¥ä½œï¼Œå¦‚æœæ²¡æœ‰é…ç½®DNSæœåŠ¡ï¼Œåˆ™ä¹Ÿå¯ä»¥ä½¿ç”¨Serviceçš„ClusterIPåœ°å€ã€‚<br>å¦å¤–ï¼ŒInfluxDBæœåŠ¡çš„åç§°æ²¡æœ‰åŠ ä¸Šå‘½åç©ºé—´ï¼Œæ˜¯å› ä¸ºHeapsteræœåŠ¡ä¸InfluxDBæœåŠ¡å±äºç›¸åŒçš„å‘½åç©ºé—´kube-systemã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šå‘½åç©ºé—´çš„å…¨æœåŠ¡åï¼Œä¾‹å¦‚ï¼š<code>http://monitoring-influxdb.kube-system:8086</code></p><h4 id="ä¿®æ”¹-grafana-yamlæ–‡ä»¶"><a href="#ä¿®æ”¹-grafana-yamlæ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ grafana.yamlæ–‡ä»¶"></a>ä¿®æ”¹ grafana.yamlæ–‡ä»¶</h4><pre><code>[root@linux-node1 kube-config]# vim influxdb/grafana.yaml............apiVersion: v1kind: Servicemetadata:  labels:    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)    # If you are NOT using this as an addon, you should comment out this line.    kubernetes.io/cluster-service: 'true'    kubernetes.io/name: monitoring-grafana  name: monitoring-grafana  namespace: kube-systemspec:  # In a production setup, we recommend accessing Grafana through an external Loadbalancer  # or through a public IP.  # type: LoadBalancer  # You could also use NodePort to expose the service at a randomly-generated port  type: NodePort # å»æ‰æ³¨é‡Šå³å¯  ports:  - port: 80    targetPort: 3000  selector:    k8s-app: grafana............</code></pre><ul><li>å®šä¹‰ç«¯å£ç±»å‹ä¸º NodePortï¼Œå°†Grafanaæš´éœ²åœ¨å®¿ä¸»æœºNodeçš„ç«¯å£ä¸Šï¼Œä»¥ä¾¿åç»­æµè§ˆå™¨è®¿é—® grafana çš„ admin UI ç•Œé¢</li></ul><h2 id="5-æ‰§è¡Œ"><a href="#5-æ‰§è¡Œ" class="headerlink" title="5. æ‰§è¡Œ"></a>5. æ‰§è¡Œ</h2><pre><code>[root@linux-node1 kube-config]# kubectl create -f influxdb/ &amp;&amp; kubectl create -f rbac/deployment.extensions "monitoring-grafana" createdservice "monitoring-grafana" createdserviceaccount "heapster" createddeployment.extensions "heapster" createdservice "heapster" createddeployment.extensions "monitoring-influxdb" createdservice "monitoring-influxdb" createdclusterrolebinding.rbac.authorization.k8s.io "heapster" created</code></pre><h4 id="æ£€æŸ¥æ‰§è¡Œç»“æœ"><a href="#æ£€æŸ¥æ‰§è¡Œç»“æœ" class="headerlink" title="æ£€æŸ¥æ‰§è¡Œç»“æœ"></a>æ£€æŸ¥æ‰§è¡Œç»“æœ</h4><h5 id="1-æ£€æŸ¥Deployment"><a href="#1-æ£€æŸ¥Deployment" class="headerlink" title="1. æ£€æŸ¥Deployment"></a>1. æ£€æŸ¥Deployment</h5><pre><code>[root@linux-node1 kube-config]# kubectl get deployments -n kube-system -o wide | grep -E 'heapster|monitoring'heapster               1         1         1            1           11s       heapster               gcr.io/google_containers/heapster-amd64:v1.5.3             k8s-app=heapster,task=monitoringmonitoring-grafana     1         1         1            1           11s       grafana                gcr.io/google_containers/heapster-grafana-amd64:v4.4.3     k8s-app=grafana,task=monitoringmonitoring-influxdb    1         1         1            1           11s       influxdb               gcr.io/google_containers/heapster-influxdb-amd64:v1.3.3    k8s-app=influxdb,task=monitoring</code></pre><h5 id="2-æ£€æŸ¥POD"><a href="#2-æ£€æŸ¥POD" class="headerlink" title="2. æ£€æŸ¥POD"></a>2. æ£€æŸ¥POD</h5><pre><code>[root@linux-node1 kube-config]# kubectl get pods -n kube-system -o wide | grep -E 'heapster|monitoring'heapster-589b7db6c9-pwrks               1/1       Running   0          32s       10.2.97.77   192.168.56.13monitoring-grafana-d8c8d486c-l9dhx      1/1       Running   0          33s       10.2.97.76   192.168.56.13monitoring-influxdb-54bd58b4c9-q489p    1/1       Running   0          33s       10.2.70.76   192.168.56.12</code></pre><h5 id="3-æ£€æŸ¥Service"><a href="#3-æ£€æŸ¥Service" class="headerlink" title="3. æ£€æŸ¥Service"></a>3. æ£€æŸ¥Service</h5><pre><code>[root@linux-node1 kube-config]# kubectl get service -n kube-system -o wide | grep -E 'heapster|monitoring'heapster               ClusterIP   10.1.102.233   &lt;none&gt;        80/TCP          50s       k8s-app=heapstermonitoring-grafana     NodePort    10.1.18.167    &lt;none&gt;        80:21240/TCP    50s       k8s-app=grafanamonitoring-influxdb    ClusterIP   10.1.244.92    &lt;none&gt;        8086/TCP        50s       k8s-app=influxdb</code></pre><h5 id="4-æ£€æŸ¥-kubernets-dashboard-ç•Œé¢ï¼Œçœ‹æ˜¯æ˜¾ç¤ºå„-Nodesã€Pods-çš„-CPUã€å†…å­˜ã€è´Ÿè½½ç­‰åˆ©ç”¨ç‡æ›²çº¿å›¾"><a href="#4-æ£€æŸ¥-kubernets-dashboard-ç•Œé¢ï¼Œçœ‹æ˜¯æ˜¾ç¤ºå„-Nodesã€Pods-çš„-CPUã€å†…å­˜ã€è´Ÿè½½ç­‰åˆ©ç”¨ç‡æ›²çº¿å›¾" class="headerlink" title="4. æ£€æŸ¥ kubernets dashboard ç•Œé¢ï¼Œçœ‹æ˜¯æ˜¾ç¤ºå„ Nodesã€Pods çš„ CPUã€å†…å­˜ã€è´Ÿè½½ç­‰åˆ©ç”¨ç‡æ›²çº¿å›¾"></a>4. æ£€æŸ¥ kubernets dashboard ç•Œé¢ï¼Œçœ‹æ˜¯æ˜¾ç¤ºå„ Nodesã€Pods çš„ CPUã€å†…å­˜ã€è´Ÿè½½ç­‰åˆ©ç”¨ç‡æ›²çº¿å›¾</h5><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/06/15284524671834.jpg"></p><h5 id="5-Grafanaçš„è®¿é—®"><a href="#5-Grafanaçš„è®¿é—®" class="headerlink" title="5. Grafanaçš„è®¿é—®:"></a>5. Grafanaçš„è®¿é—®:</h5><p>ä¸Šé¢æˆ‘ä»¬ä¸æ˜¯ä¿®æ”¹äº†å®˜æ–¹æä¾›çš„é‚£ä¸ªgrafana.yamlä¸­çš„é‚£ä¸ªNodePortå˜›ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¿é—®å°±æ˜¯<br><a href="http://NodeIP:NodePort">http://NodeIP:NodePort</a><br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15319972498850.jpg"><br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/07/15319972699157.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>08-K8sé›†ç¾¤æ­å»º---CoreDNSåˆ›å»º&amp;DashBoard</title>
      <link href="/2018/06/03/08k8s-ji-qun-da-jiancoredns-chuang-jiandashboard/"/>
      <url>/2018/06/03/08k8s-ji-qun-da-jiancoredns-chuang-jiandashboard/</url>
      
        <content type="html"><![CDATA[<p>ç”±äºk8sé›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°éƒ½æ˜¯é€šè¿‡DNSæ¥å‘ç°å¹¶å®ç°çš„ï¼Œæ‰€ä»¥éœ€è¦ä¾èµ–DNSæœåŠ¡</p><h2 id="1-åˆ›å»ºcoredns-yamlæ–‡ä»¶"><a href="#1-åˆ›å»ºcoredns-yamlæ–‡ä»¶" class="headerlink" title="1.åˆ›å»ºcoredns.yamlæ–‡ä»¶:"></a>1.åˆ›å»ºcoredns.yamlæ–‡ä»¶:</h2><pre><code>[root@linux-node1 ~]# cat &gt; coredns.yaml &lt;&lt; EOFapiVersion: v1kind: ServiceAccountmetadata:  name: coredns  namespace: kube-system  labels:      kubernetes.io/cluster-service: "true"      addonmanager.kubernetes.io/mode: Reconcile---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata:  labels:    kubernetes.io/bootstrapping: rbac-defaults    addonmanager.kubernetes.io/mode: Reconcile  name: system:corednsrules:- apiGroups:  - ""  resources:  - endpoints  - services  - pods  - namespaces  verbs:  - list  - watch---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata:  annotations:    rbac.authorization.kubernetes.io/autoupdate: "true"  labels:    kubernetes.io/bootstrapping: rbac-defaults    addonmanager.kubernetes.io/mode: EnsureExists  name: system:corednsroleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: system:corednssubjects:- kind: ServiceAccount  name: coredns  namespace: kube-system---apiVersion: v1kind: ConfigMapmetadata:  name: coredns  namespace: kube-system  labels:      addonmanager.kubernetes.io/mode: EnsureExistsdata:  Corefile: |    .:53 {        errors        health        kubernetes cluster.local. in-addr.arpa ip6.arpa {            pods insecure            upstream            fallthrough in-addr.arpa ip6.arpa        }        prometheus :9153        proxy . /etc/resolv.conf        cache 30    }---apiVersion: extensions/v1beta1kind: Deploymentmetadata:  name: coredns  namespace: kube-system  labels:    k8s-app: coredns    kubernetes.io/cluster-service: "true"    addonmanager.kubernetes.io/mode: Reconcile    kubernetes.io/name: "CoreDNS"spec:  replicas: 2  strategy:    type: RollingUpdate    rollingUpdate:      maxUnavailable: 1  selector:    matchLabels:      k8s-app: coredns  template:    metadata:      labels:        k8s-app: coredns    spec:      serviceAccountName: coredns      tolerations:        - key: node-role.kubernetes.io/master          effect: NoSchedule        - key: "CriticalAddonsOnly"          operator: "Exists"      containers:      - name: coredns        image: coredns/coredns:1.0.6        imagePullPolicy: IfNotPresent        resources:          limits:            memory: 170Mi          requests:            cpu: 100m            memory: 70Mi        args: [ "-conf", "/etc/coredns/Corefile" ]        volumeMounts:        - name: config-volume          mountPath: /etc/coredns        ports:        - containerPort: 53          name: dns          protocol: UDP        - containerPort: 53          name: dns-tcp          protocol: TCP        livenessProbe:          httpGet:            path: /health            port: 8080            scheme: HTTP          initialDelaySeconds: 60          timeoutSeconds: 5          successThreshold: 1          failureThreshold: 5      dnsPolicy: Default      volumes:        - name: config-volume          configMap:            name: coredns            items:            - key: Corefile              path: Corefile---apiVersion: v1kind: Servicemetadata:  name: coredns  namespace: kube-system  labels:    k8s-app: coredns    kubernetes.io/cluster-service: "true"    addonmanager.kubernetes.io/mode: Reconcile    kubernetes.io/name: "CoreDNS"spec:  selector:    k8s-app: coredns  clusterIP: 10.1.0.2  #!!!!!!!å…³é”®ç‚¹!!!!!!!  ports:  - name: dns    port: 53    protocol: UDP  - name: dns-tcp    port: 53    protocol: TCP    EOF# æ³¨æ„ cluster ip éœ€è¦è·Ÿservice ipæ˜¯åœ¨ä¸€ä¸ªç½‘æ®µ</code></pre><h3 id="2-è¿è¡Œåˆ›å»º"><a href="#2-è¿è¡Œåˆ›å»º" class="headerlink" title="2.è¿è¡Œåˆ›å»º:"></a>2.è¿è¡Œåˆ›å»º:</h3><pre><code>[root@linux-node1 ~]# kubectl create -f coredns.yamldeployment.extensions "coredns" createdError from server (AlreadyExists): error when creating "coredns.yaml": serviceaccounts "coredns" already existsError from server (AlreadyExists): error when creating "coredns.yaml": clusterroles.rbac.authorization.k8s.io "system:coredns" already existsError from server (AlreadyExists): error when creating "coredns.yaml": clusterrolebindings.rbac.authorization.k8s.io "system:coredns" already existsError from server (AlreadyExists): error when creating "coredns.yaml": configmaps "coredns" already existsError from server (Invalid): error when creating "coredns.yaml": Service "coredns" is invalid: spec.clusterIP: Invalid value: "10.1.0.2": provided IP is already allocated# å¿½ç•¥ä»¥ä¸Šé”™è¯¯ï¼Œç”±äºæˆ‘å·²ç»å®‰è£…è¿‡äº†ã€‚</code></pre><h3 id="3-æŸ¥çœ‹åˆ›å»ºç»“æœ"><a href="#3-æŸ¥çœ‹åˆ›å»ºç»“æœ" class="headerlink" title="3.æŸ¥çœ‹åˆ›å»ºç»“æœ:"></a>3.æŸ¥çœ‹åˆ›å»ºç»“æœ:</h3><pre><code># æ³¨æ„: ä¸k8sç›¸å…³çš„ç»„ä»¶æˆ–è€…æœåŠ¡éƒ½æ˜¯åœ¨kube-systemè¿™ä¸ªå‘½åç©ºé—´ æ‰€ä»¥è¿™é‡Œ -n æŒ‡å®šäº†å‘½åç©ºé—´ä¸ºkube-system[root@linux-node1 ~]# kubectl get deployment -n kube-systemNAME                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGEcoredns                2         2         2            2           12m# æŸ¥çœ‹service[root@linux-node1 ~]# kubectl get service -n kube-systemNAME                   TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGEcoredns                ClusterIP   10.1.0.2      &lt;none&gt;        53/UDP,53/TCP   32m# é€šè¿‡LVSæŸ¥çœ‹è¿™ä¸ªclusterçš„ä¿¡æ¯[root@linux-node2 ~]# ipvsadm -Ln | grep -v ":80"IP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConnTCP  10.1.0.1:443 rr persistent 10800  -&gt; 192.168.56.11:6443           Masq    1      2          0  TCP  10.1.0.2:53 rr  -&gt; 10.2.70.216:53               Masq    1      0          0  -&gt; 10.2.97.209:53               Masq    1      0          0UDP  10.1.0.2:53 rr  -&gt; 10.2.70.216:53               Masq    1      0          0  -&gt; 10.2.97.209:53               Masq    1      0          0  # å¯ä»¥çœ‹åˆ°é€šè¿‡LVSè½¬å‘äº†ä¸¤ä¸ªPod, æŸ¥çœ‹pod:[root@linux-node1 ~]# kubectl get pod -n kube-system -o wideNAME                                    READY     STATUS    RESTARTS   AGE       IP            NODEcoredns-77c989547b-55kjb                1/1       Running   0          19m       10.2.97.209   192.168.56.13coredns-77c989547b-qvfw4                1/1       Running   0          19m       10.2.70.216   192.168.56.12</code></pre><h3 id="4-éªŒè¯åˆ›å»ºç»“æœ"><a href="#4-éªŒè¯åˆ›å»ºç»“æœ" class="headerlink" title="4. éªŒè¯åˆ›å»ºç»“æœ:"></a>4. éªŒè¯åˆ›å»ºç»“æœ:</h3><p>å¯åŠ¨ä¸€ä¸ªå®¹å™¨</p><pre><code># å¯ä»¥çœ‹å‡ºæ¥å·²ç»è·å–åˆ°äº†dnsæœåŠ¡çš„VIPåœ°å€[root@linux-node1 ~]# kubectl exec -it nginx-deployment-75d56bb955-b4z4k /bin/sh# cat /etc/resolv.confnameserver 10.1.0.2 search default.svc.cluster.localping . svc.cluster.local. cluster.local. example.comoptions ndots:5</code></pre><p>æ¢³ç†ä¸»è¦å†…å®¹ï¼š</p><ul><li>åœ¨k8sé›†ç¾¤ä¸­ï¼ŒæœåŠ¡æ˜¯è¿è¡Œåœ¨Podä¸­çš„ï¼ŒPodçš„å‘ç°å’Œå‰¯æœ¬é—´è´Ÿè½½å‡è¡¡æ˜¯æˆ‘ä»¬é¢ä¸´çš„é—®é¢˜ã€‚</li><li>é€šè¿‡Serviceå¯ä»¥è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œä½†è®¿é—®Serviceä¹Ÿéœ€è¦å¯¹åº”çš„IPï¼Œå› æ­¤åˆå¼•å…¥äº†Serviceå‘ç°çš„é—®é¢˜ã€‚</li><li>å¾—ç›Šäºcorednsæ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŸŸåæ¥è®¿é—®é›†ç¾¤å†…çš„Serviceï¼Œè§£å†³äº†Serviceå‘ç°çš„é—®é¢˜ã€‚</li><li>ä¸ºäº†è®©Podä¸­çš„å®¹å™¨å¯ä»¥ä½¿ç”¨corednsæ¥è§£æåŸŸåï¼Œk8sä¼šä¿®æ”¹å®¹å™¨çš„/etc/resolv.confé…ç½®ã€‚</li></ul><p>æœ‰äº†ä»¥ä¸Šæœºåˆ¶çš„ä¿è¯ï¼Œå°±å¯ä»¥åœ¨Podä¸­é€šè¿‡Serviceåç§°å’Œnamespaceéå¸¸æ–¹ä¾¿åœ°è®¿é—®å¯¹åº”çš„æœåŠ¡äº†ã€‚</p><h2 id="DashBoard"><a href="#DashBoard" class="headerlink" title="DashBoard"></a>DashBoard</h2><h3 id="éƒ¨ç½²dashboard"><a href="#éƒ¨ç½²dashboard" class="headerlink" title="éƒ¨ç½²dashboard"></a>éƒ¨ç½²dashboard</h3><pre><code>[root@linux-node1 ~]# kubectl create -f dashboard/# æŸ¥çœ‹é›†ç¾¤è¯¦æƒ…[root@linux-node1 ~]# kubectl cluster-infoKubernetes master is running at https://192.168.56.11:6443CoreDNS is running at https://192.168.56.11:6443/api/v1/namespaces/kube-system/services/coredns:dns/proxykubernetes-dashboard is running at https://192.168.56.11:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxyTo further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.[root@linux-node1 src]# kubectl get services kubernetes-dashboard -n kube-systemNAME                   TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGEkubernetes-dashboard   NodePort   10.1.27.148   &lt;none&gt;        443:28966/TCP   3d</code></pre><h3 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•:"></a>ç™»å½•:</h3><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/06/long.jpeg">ï¿¼</p><p>è·å–ç™»å½•ä»¤ç‰Œ:</p><pre><code>[root@linux-node1 src]# kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')# å¤åˆ¶ tokençš„å†…å®¹éƒ¨åˆ† è¾“å…¥ ç™»å½•</code></pre><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/06/15280837316773.jpg">ï¿¼</p>]]></content>
      
      
      <categories>
          
          <category> è™šæ‹ŸåŒ–&amp;amp;äº‘è®¡ç®—&amp;amp;å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>07-K8sé›†ç¾¤æ­å»º---åˆ›å»ºK8såº”ç”¨</title>
      <link href="/2018/06/03/07k8s-ji-qun-da-jianchuang-jiank8s-ying-yong/"/>
      <url>/2018/06/03/07k8s-ji-qun-da-jianchuang-jiank8s-ying-yong/</url>
      
        <content type="html"><![CDATA[<h3 id="1-åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„deployment"><a href="#1-åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„deployment" class="headerlink" title="1.åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„deployment"></a>1.åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„deployment</h3><pre><code>[root@linux-node1 ~]# kubectl run net-test --image=alpine --replicas=3 sleep 360000</code></pre><h3 id="2-æŸ¥çœ‹åˆ›å»ºæƒ…å†µ"><a href="#2-æŸ¥çœ‹åˆ›å»ºæƒ…å†µ" class="headerlink" title="2.æŸ¥çœ‹åˆ›å»ºæƒ…å†µ"></a>2.æŸ¥çœ‹åˆ›å»ºæƒ…å†µ</h3><pre><code>[root@linux-node1 ~]# kubectl get pods -o wideNAME                        READY     STATUS    RESTARTS   AGE       IP            NODEnet-test-5767cb94df-6crmr   1/1       Running   0          17s       10.2.97.176   192.168.56.13net-test-5767cb94df-9mpmb   1/1       Running   0          17s       10.2.70.187   192.168.56.12net-test-5767cb94df-x8l44   1/1       Running   0          17s       10.2.97.175   192.168.56.13# ä½¿ç”¨kubectlåˆ›å»ºäº†ä¸€ä¸ªåä¸ºnet-test çš„deployment, é•œåƒæ˜¯alpine å‰¯æœ¬æ•°ä¸º3ï¼Œ[root@linux-node1 ~]# kubectl get deploymentsNAME       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGEnet-test   3         3         3            3           7m</code></pre><h3 id="3-æµ‹è¯•è”é€šæ€§"><a href="#3-æµ‹è¯•è”é€šæ€§" class="headerlink" title="3.æµ‹è¯•è”é€šæ€§"></a>3.æµ‹è¯•è”é€šæ€§</h3><pre><code>ping 10.2.97.176</code></pre><h2 id="é€šè¿‡yamlæ–‡ä»¶éƒ¨ç½²åº”ç”¨"><a href="#é€šè¿‡yamlæ–‡ä»¶éƒ¨ç½²åº”ç”¨" class="headerlink" title="é€šè¿‡yamlæ–‡ä»¶éƒ¨ç½²åº”ç”¨"></a>é€šè¿‡yamlæ–‡ä»¶éƒ¨ç½²åº”ç”¨</h2><h3 id="1-ç¼–å†™ä¸€ä¸ªnginx-deployment-yamlæ–‡ä»¶"><a href="#1-ç¼–å†™ä¸€ä¸ªnginx-deployment-yamlæ–‡ä»¶" class="headerlink" title="1.ç¼–å†™ä¸€ä¸ªnginx-deployment.yamlæ–‡ä»¶:"></a>1.ç¼–å†™ä¸€ä¸ªnginx-deployment.yamlæ–‡ä»¶:</h3><pre><code>[root@linux-node1 ~]# cat &gt;  nginx-deployment.yaml  &lt;&lt; EOFapiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-deployment  labels:    app: nginxspec:  replicas: 3  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      containers:      - name: nginx        image: nginx:1.10.3        ports:        - containerPort: 80   EOF</code></pre><h3 id="2-æ‰§è¡Œåˆ›å»º"><a href="#2-æ‰§è¡Œåˆ›å»º" class="headerlink" title="2.æ‰§è¡Œåˆ›å»º:"></a>2.æ‰§è¡Œåˆ›å»º:</h3><pre><code>[root@linux-node1 ~]# kubectl create -f nginx-deployment.yamldeployment.apps "nginx-deployment" created# æŸ¥çœ‹deployment[root@linux-node1 ~]# kubectl get deployment/nginx-deploymentNAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGEnginx-deployment   10        10        10           10          1m# æŸ¥çœ‹deployment è¯¦æƒ…[root@linux-node1 ~]# kubectl describe deployment/nginx-deploymentName:                   nginx-deploymentNamespace:              defaultCreationTimestamp:      Thu, 31 May 2018 20:20:17 +0800Labels:                 app=nginxAnnotations:            deployment.kubernetes.io/revision=1Selector:               app=nginxReplicas:               10 desired | 10 updated | 10 total | 10 available | 0 unavailableStrategyType:           RollingUpdateMinReadySeconds:        0RollingUpdateStrategy:  25% max unavailable, 25% max surgePod Template:  Labels:  app=nginx  Containers:   nginx:    Image:        nginx:1.10.3    Port:         80/TCP    Host Port:    0/TCP    Environment:  &lt;none&gt;    Mounts:       &lt;none&gt;  Volumes:        &lt;none&gt;Conditions:  Type           Status  Reason  ----           ------  ------  Progressing    True    NewReplicaSetAvailable  Available      True    MinimumReplicasAvailableOldReplicaSets:  &lt;none&gt;NewReplicaSet:   nginx-deployment-75d56bb955 (10/10 replicas created)Events:  Type    Reason             Age               From                   Message  ----    ------             ----              ----                   -------  Normal  ScalingReplicaSet  5m                deployment-controller  Scaled up replica set nginx-deployment-75d56bb955 to 3  Normal  ScalingReplicaSet  1m (x2 over 3m)   deployment-controller  Scaled down replica set nginx-deployment-75d56bb955 to 3  Normal  ScalingReplicaSet  57s (x3 over 5m)  deployment-controller  Scaled up replica set nginx-deployment-75d56bb955 to 10  # æŸ¥çœ‹pod ,å¯ä»¥çœ‹å‡ºæŒ‰ç…§æˆ‘ä»¬çš„æè¿°æ–‡ä»¶é‡Œé¢çš„å‰¯æœ¬æ•°å·²ç»æœ‰10ä¸ªPODé€šè¿‡Scheduleåˆ°äº†ä¸åŒçš„nodeèŠ‚ç‚¹ä¸Šé¢[root@linux-node1 ~]# kubectl get pod -o wideNAME                                READY     STATUS    RESTARTS   AGE       IP            NODEnet-test-5767cb94df-6crmr           1/1       Running   0          40m       10.2.97.178   192.168.56.13net-test-5767cb94df-9mpmb           1/1       Running   0          40m       10.2.70.187   192.168.56.12net-test-5767cb94df-x8l44           1/1       Running   0          40m       10.2.97.177   192.168.56.13nginx-deployment-75d56bb955-255w2   1/1       Running   0          3m        10.2.70.196   192.168.56.12nginx-deployment-75d56bb955-5ckvs   1/1       Running   0          8m        10.2.70.188   192.168.56.12nginx-deployment-75d56bb955-7dq87   1/1       Running   0          3m        10.2.70.198   192.168.56.12nginx-deployment-75d56bb955-8vl7p   1/1       Running   0          3m        10.2.97.191   192.168.56.13nginx-deployment-75d56bb955-9f9ms   1/1       Running   0          3m        10.2.97.189   192.168.56.13nginx-deployment-75d56bb955-9g9bk   1/1       Running   0          3m        10.2.97.188   192.168.56.13nginx-deployment-75d56bb955-9kz2r   1/1       Running   0          3m        10.2.70.197   192.168.56.12nginx-deployment-75d56bb955-s78gs   1/1       Running   0          8m        10.2.70.189   192.168.56.12nginx-deployment-75d56bb955-v8n5v   1/1       Running   0          3m        10.2.97.190   192.168.56.13nginx-deployment-75d56bb955-zfb4m   1/1       Running   0          8m        10.2.97.179   192.168.56.13# æŸ¥çœ‹æŸä¸ªpodè¯¦æƒ…[root@linux-node1 ~]# kubectl describe pod/nginx-deployment-75d56bb955-255w2Name:           nginx-deployment-75d56bb955-255w2Namespace:      defaultNode:           192.168.56.12/192.168.56.12Start Time:     Thu, 31 May 2018 20:24:31 +0800Labels:         app=nginx                pod-template-hash=3181266511Annotations:    &lt;none&gt;Status:         RunningIP:             10.2.70.196Controlled By:  ReplicaSet/nginx-deployment-75d56bb955Containers:  nginx:    Container ID:   docker://48ad80730efd6d744ac6d31b34778eb8e75b0f4c6698e1c1fc8f6046a6a77b2b    Image:          nginx:1.10.3    Image ID:       docker-pullable://nginx@sha256:6202beb06ea61f44179e02ca965e8e13b961d12640101fca213efbfd145d7575    Port:           80/TCP    Host Port:      0/TCP    State:          Running      Started:      Thu, 31 May 2018 20:24:33 +0800    Ready:          True    Restart Count:  0    Environment:    &lt;none&gt;    Mounts:      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5htws (ro)Conditions:  Type           Status  Initialized    True  Ready          True  PodScheduled   TrueVolumes:  default-token-5htws:    Type:        Secret (a volume populated by a Secret)    SecretName:  default-token-5htws    Optional:    falseQoS Class:       BestEffortNode-Selectors:  &lt;none&gt;Tolerations:     &lt;none&gt;Events:  Type    Reason                 Age   From                    Message  ----    ------                 ----  ----                    -------  Normal  SuccessfulMountVolume  3m    kubelet, 192.168.56.12  MountVolume.SetUp succeeded for volume "default-token-5htws"  Normal  Pulled                 3m    kubelet, 192.168.56.12  Container image "nginx:1.10.3" already present on machine  Normal  Created                3m    kubelet, 192.168.56.12  Created container  Normal  Started                3m    kubelet, 192.168.56.12  Started container  Normal  Scheduled              2m    default-scheduler       Successfully assigned nginx-deployment-75d56bb955-255w2 to 192.168.56.12# è®¿é—®Nginx pod[root@linux-node1 ~]# curl -I http://10.2.70.196HTTP/1.1 200 OKServer: nginx/1.10.3Date: Thu, 31 May 2018 12:30:45 GMTContent-Type: text/htmlContent-Length: 612Last-Modified: Tue, 31 Jan 2017 15:01:11 GMTConnection: keep-aliveETag: "5890a6b7-264"Accept-Ranges: byte# æ›´æ–°deployment[root@linux-node1 ~]# kubectl set image  deployment/nginx-deployment nginx=nginx:1.12.2 --recorddeployment.apps "nginx-deployment" image updated# å¯ä»¥çœ‹åˆ°æ›´æ–°å·²ç»æˆåŠŸ(æ»šåŠ¨æ›´æ–°)[root@linux-node1 ~]# kubectl get deployment/nginx-deployment -o wideNAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES         SELECTORnginx-deployment   10        10        10           10          17m       nginx        nginx:1.12.2   app=nginx[root@linux-node1 ~]# curl -I 10.2.97.192HTTP/1.1 200 OKServer: nginx/1.12.2   # ç‰ˆæœ¬å·²ç»æ›´æ–°æˆåŠŸDate: Thu, 31 May 2018 12:35:54 GMTContent-Type: text/htmlContent-Length: 612Last-Modified: Tue, 11 Jul 2017 13:29:18 GMTConnection: keep-aliveETag: "5964d2ae-264"Accept-Ranges: bytes# æŸ¥çœ‹deploymentæ›´æ–°å†å²[root@linux-node1 ~]# kubectl rollout history deployment/nginx-deploymentdeployments "nginx-deployment"REVISION  CHANGE-CAUSE1         &lt;none&gt; # ç”¨äºåœ¨ä¹‹å‰åœ¨åˆ›å»ºåˆ›å»ºnginx deploymentçš„æ—¶å€™ æœªåŠ å‚æ•° --record æ‰€ä»¥è¿™ä¸ªä¿¡æ¯ä¸ºnone2         kubectl set image deployment/nginx-deployment nginx=nginx:1.12.2 --record=true# æŸ¥çœ‹ç‰ˆæœ¬è¯¦æƒ…(--revison=VERSION_NUM)[root@linux-node1 ~]# kubectl rollout history deployment/nginx-deployment --revision=1deployments "nginx-deployment" with revision #1Pod Template:  Labels:   app=nginx    pod-template-hash=3181266511  Containers:   nginx:    Image:  nginx:1.10.3    Port:   80/TCP    Host Port:  0/TCP    Environment:    &lt;none&gt;    Mounts: &lt;none&gt;  Volumes:  &lt;none&gt;   # ç‰ˆæœ¬å›æ»šè‡³ä¸Šä¸€ä¸ªç‰ˆæœ¬:[root@linux-node1 ~]# kubectl rollout undo deployment/nginx-deploymentdeployment.apps "nginx-deployment"[root@linux-node1 ~]# kubectl get deployment/nginx-deployment -o wideNAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES         SELECTORnginx-deployment   10        10        10           10          26m       nginx        nginx:1.10.3   app=nginx# æ‰©å®¹podæ•°é‡[root@linux-node1 ~]# kubectl scale --replicas=20 deployment nginx-deploymentdeployment.extensions "nginx-deployment" scaled[root@linux-node1 ~]# kubectl get deployment/nginx-deployment -o wideNAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES         SELECTORnginx-deployment   20        20        20           20          28m       nginx        nginx:1.10.3   app=nginx</code></pre><p>é‚£é—®é¢˜æ¥äº†:</p><ol><li>æ¯æ¬¡æ”¶åˆ°è·å–podIPå¤ªæ‰¯äº†ï¼Œæ€»ä¸èƒ½æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨æ”¹ç¨‹åºæˆ–è€…é…ç½®æ‰èƒ½è®¿é—®æœåŠ¡å§ï¼Œè¦æ€ä¹ˆæå‰çŸ¥é“podIPå‘¢ï¼Ÿ</li><li>Podåœ¨è¿è¡Œä¸­å¯èƒ½ä¼šé‡å»ºï¼ŒIPå˜äº†æ€ä¹ˆè§£ï¼Ÿ</li><li>å¦‚ä½•åœ¨å¤šä¸ªPodä¸­å®ç°è´Ÿè½½å‡è¡¡å˜ï¼Ÿ</li></ol><p>è¿™äº›é—®é¢˜ä½¿ç”¨k8s Serviceå°±å¯ä»¥è§£å†³ã€‚</p><p>Serviceå¯ä»¥å°†pod IPå°è£…èµ·æ¥ï¼Œå³ä½¿Podå‘ç”Ÿé‡å»ºï¼Œä¾ç„¶å¯ä»¥é€šè¿‡Serviceæ¥è®¿é—®Podæä¾›çš„æœåŠ¡ã€‚æ­¤å¤–ï¼ŒServiceè¿˜è§£å†³äº†è´Ÿè½½å‡è¡¡çš„é—®é¢˜ï¼Œå¤§å®¶å¯ä»¥å¤šè®¿é—®å‡ æ¬¡Serviceï¼Œç„¶åé€šè¿‡kubectl logs æ¥æŸ¥çœ‹Nginx Podçš„è®¿é—®æ—¥å¿—æ¥ç¡®è®¤</p><h3 id="åˆ›å»ºä¸€ä¸ªå¯¹äºnginx-deploymentçš„ä¸€ä¸ªservice"><a href="#åˆ›å»ºä¸€ä¸ªå¯¹äºnginx-deploymentçš„ä¸€ä¸ªservice" class="headerlink" title="åˆ›å»ºä¸€ä¸ªå¯¹äºnginx deploymentçš„ä¸€ä¸ªservice"></a>åˆ›å»ºä¸€ä¸ªå¯¹äºnginx deploymentçš„ä¸€ä¸ªservice</h3><h4 id="1-ç¼–å†™nginx-service-yamlæ–‡ä»¶"><a href="#1-ç¼–å†™nginx-service-yamlæ–‡ä»¶" class="headerlink" title="1.ç¼–å†™nginx-service.yamlæ–‡ä»¶"></a>1.ç¼–å†™nginx-service.yamlæ–‡ä»¶</h4><pre><code>[root@linux-node1 ~]# cat &gt; nginx-service.yaml &lt;&lt; EOFkind: Service apiVersion: v1metadata:  name: nginx-servicespec:  selector:    app: nginx  ports:  - protocol: TCP    port: 80    targetPort: 80EOF</code></pre><h4 id="2-æ‰§è¡Œåˆ›å»ºæ“ä½œ"><a href="#2-æ‰§è¡Œåˆ›å»ºæ“ä½œ" class="headerlink" title="2.æ‰§è¡Œåˆ›å»ºæ“ä½œ:"></a>2.æ‰§è¡Œåˆ›å»ºæ“ä½œ:</h4><pre><code>[root@linux-node1 ~]# kubectl create -f nginx-service.yamlservice "nginx-service" created[root@linux-node1 ~]# kubectl get service -o wideNAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE       SELECTORkubernetes      ClusterIP   10.1.0.1       &lt;none&gt;        443/TCP   3d        &lt;none&gt;nginx-service   ClusterIP   10.1.146.223   &lt;none&gt;        80/TCP    30s       app=nginx# è®¿é—®VIP[root@linux-node1 ~]# curl -I http://10.1.146.223HTTP/1.1 200 OKServer: nginx/1.10.3Date: Thu, 31 May 2018 12:54:54 GMTContent-Type: text/htmlContent-Length: 612Last-Modified: Tue, 31 Jan 2017 15:01:11 GMTConnection: keep-aliveETag: "5890a6b7-264"Accept-Ranges: bytes# åœ¨èŠ‚ç‚¹2ä¸ŠæŸ¥çœ‹LVSï¼Œé€šè¿‡k8så°è£…LVSæ¥å®ç°äº†è´Ÿè½½å‡è¡¡[root@linux-node2 ~]# ipvsadm -LnIP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConnTCP  10.1.0.1:443 rr persistent 10800  -&gt; 192.168.56.11:6443           Masq    1      1          0TCP  10.1.146.223:80 rr  -&gt; 10.2.70.204:80               Masq    1      0          0  -&gt; 10.2.70.205:80               Masq    1      0          1  -&gt; 10.2.70.206:80               Masq    1      0          0  -&gt; 10.2.70.207:80               Masq    1      0          0  -&gt; 10.2.70.208:80               Masq    1      0          0  -&gt; 10.2.70.209:80               Masq    1      0          0  -&gt; 10.2.70.210:80               Masq    1      0          0  -&gt; 10.2.70.211:80               Masq    1      0          0  -&gt; 10.2.70.212:80               Masq    1      0          0  -&gt; 10.2.70.213:80               Masq    1      0          0  -&gt; 10.2.97.197:80               Masq    1      0          0  -&gt; 10.2.97.198:80               Masq    1      0          0  -&gt; 10.2.97.199:80               Masq    1      0          1  -&gt; 10.2.97.200:80               Masq    1      0          0  -&gt; 10.2.97.201:80               Masq    1      0          0  -&gt; 10.2.97.202:80               Masq    1      0          1  -&gt; 10.2.97.203:80               Masq    1      0          1  -&gt; 10.2.97.204:80               Masq    1      0          0  -&gt; 10.2.97.205:80               Masq    1      0          0</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>06-K8sé›†ç¾¤æ­å»º---Flannelç½‘ç»œéƒ¨ç½²</title>
      <link href="/2018/06/02/06k8s-ji-qun-da-jianflannel-wang-luo-bu-shu/"/>
      <url>/2018/06/02/06k8s-ji-qun-da-jianflannel-wang-luo-bu-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="1-ä¸ºFlannelç”Ÿæˆè¯ä¹¦"><a href="#1-ä¸ºFlannelç”Ÿæˆè¯ä¹¦" class="headerlink" title="1.ä¸ºFlannelç”Ÿæˆè¯ä¹¦"></a>1.ä¸ºFlannelç”Ÿæˆè¯ä¹¦</h3><pre><code>[root@linux-node1 ~]# vim flanneld-csr.json{  "CN": "flanneld",  "hosts": [],  "key": {    "algo": "rsa",    "size": 2048  },  "names": [    {      "C": "CN",      "ST": "BeiJing",      "L": "BeiJing",      "O": "k8s",      "OU": "System"    }  ]}</code></pre><h3 id="2-ç”Ÿæˆè¯ä¹¦"><a href="#2-ç”Ÿæˆè¯ä¹¦" class="headerlink" title="2.ç”Ÿæˆè¯ä¹¦"></a>2.ç”Ÿæˆè¯ä¹¦</h3><pre><code>[root@linux-node1 ~]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \   -ca-key=/opt/kubernetes/ssl/ca-key.pem \   -config=/opt/kubernetes/ssl/ca-config.json \   -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld</code></pre><h3 id="3-åˆ†å‘è¯ä¹¦"><a href="#3-åˆ†å‘è¯ä¹¦" class="headerlink" title="3.åˆ†å‘è¯ä¹¦"></a>3.åˆ†å‘è¯ä¹¦</h3><pre><code>[root@linux-node1 ~]# cp flanneld*.pem /opt/kubernetes/ssl/[root@linux-node1 ~]# scp flanneld*.pem 192.168.56.12:/opt/kubernetes/ssl/[root@linux-node1 ~]# scp flanneld*.pem 192.168.56.13:/opt/kubernetes/ssl/</code></pre><h3 id="4-ä¸‹è½½Flannelè½¯ä»¶åŒ…"><a href="#4-ä¸‹è½½Flannelè½¯ä»¶åŒ…" class="headerlink" title="4.ä¸‹è½½Flannelè½¯ä»¶åŒ…"></a>4.ä¸‹è½½Flannelè½¯ä»¶åŒ…</h3><pre><code>[root@linux-node1 ~]# cd /usr/local/src# wget https://github.com/coreos/flannel/releases/download/v0.10.0/flannel-v0.10.0-linux-amd64.tar.gz[root@linux-node1 src]# tar zxf flannel-v0.10.0-linux-amd64.tar.gz[root@linux-node1 src]# cp flanneld mk-docker-opts.sh /opt/kubernetes/bin/å¤åˆ¶åˆ°linux-node2èŠ‚ç‚¹[root@linux-node1 src]# scp flanneld mk-docker-opts.sh 192.168.56.12:/opt/kubernetes/bin/[root@linux-node1 src]# scp flanneld mk-docker-opts.sh 192.168.56.13:/opt/kubernetes/bin/å¤åˆ¶å¯¹åº”è„šæœ¬åˆ°/opt/kubernetes/binç›®å½•ä¸‹ã€‚[root@linux-node1 ~]# cd /usr/local/src/kubernetes/cluster/centos/node/bin/[root@linux-node1 bin]# cp remove-docker0.sh /opt/kubernetes/bin/[root@linux-node1 bin]# scp remove-docker0.sh 192.168.56.12:/opt/kubernetes/bin/[root@linux-node1 bin]# scp remove-docker0.sh 192.168.56.13:/opt/kubernetes/bin/</code></pre><h3 id="5-é…ç½®Flannel"><a href="#5-é…ç½®Flannel" class="headerlink" title="5.é…ç½®Flannel"></a>5.é…ç½®Flannel</h3><pre><code>[root@linux-node1 ~]# vim /opt/kubernetes/cfg/flannelFLANNEL_ETCD="-etcd-endpoints=https://192.168.56.11:2379,https://192.168.56.12:2379,https://192.168.56.13:2379"FLANNEL_ETCD_KEY="-etcd-prefix=/kubernetes/network"FLANNEL_ETCD_CAFILE="--etcd-cafile=/opt/kubernetes/ssl/ca.pem"FLANNEL_ETCD_CERTFILE="--etcd-certfile=/opt/kubernetes/ssl/flanneld.pem"FLANNEL_ETCD_KEYFILE="--etcd-keyfile=/opt/kubernetes/ssl/flanneld-key.pem"å¤åˆ¶é…ç½®åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Š[root@linux-node1 ~]# scp /opt/kubernetes/cfg/flannel 192.168.56.12:/opt/kubernetes/cfg/[root@linux-node1 ~]# scp /opt/kubernetes/cfg/flannel 192.168.56.13:/opt/kubernetes/cfg/</code></pre><h3 id="6-è®¾ç½®Flannelç³»ç»ŸæœåŠ¡"><a href="#6-è®¾ç½®Flannelç³»ç»ŸæœåŠ¡" class="headerlink" title="6.è®¾ç½®Flannelç³»ç»ŸæœåŠ¡"></a>6.è®¾ç½®Flannelç³»ç»ŸæœåŠ¡</h3><pre><code>[root@linux-node1 ~]# vim /usr/lib/systemd/system/flannel.service[Unit]Description=Flanneld overlay address etcd agentAfter=network.targetBefore=docker.service[Service]EnvironmentFile=-/opt/kubernetes/cfg/flannelExecStartPre=/opt/kubernetes/bin/remove-docker0.shExecStart=/opt/kubernetes/bin/flanneld --ip-masq ${FLANNEL_ETCD} ${FLANNEL_ETCD_KEY} ${FLANNEL_ETCD_CAFILE} ${FLANNEL_ETCD_CERTFILE} ${FLANNEL_ETCD_KEYFILE}ExecStartPost=/opt/kubernetes/bin/mk-docker-opts.sh -d /run/flannel/dockerType=notify[Install]WantedBy=multi-user.targetRequiredBy=docker.serviceå¤åˆ¶ç³»ç»ŸæœåŠ¡è„šæœ¬åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Š# scp /usr/lib/systemd/system/flannel.service 192.168.56.12:/usr/lib/systemd/system/# scp /usr/lib/systemd/system/flannel.service 192.168.56.13:/usr/lib/systemd/system/</code></pre><h2 id="Flannel-CNIé›†æˆ"><a href="#Flannel-CNIé›†æˆ" class="headerlink" title="Flannel CNIé›†æˆ"></a>Flannel CNIé›†æˆ</h2><h3 id="1-ä¸‹è½½CNIæ’ä»¶"><a href="#1-ä¸‹è½½CNIæ’ä»¶" class="headerlink" title="1.ä¸‹è½½CNIæ’ä»¶"></a>1.ä¸‹è½½CNIæ’ä»¶</h3><pre><code>https://github.com/containernetworking/plugins/releaseswget https://github.com/containernetworking/plugins/releases/download/v0.7.1/cni-plugins-amd64-v0.7.1.tgz[root@linux-node1 ~]# mkdir /opt/kubernetes/bin/cni[root@linux-node1 src]# tar zxf cni-plugins-amd64-v0.7.1.tgz -C /opt/kubernetes/bin/cni# scp -r /opt/kubernetes/bin/cni/* 192.168.56.12:/opt/kubernetes/bin/cni/# scp -r /opt/kubernetes/bin/cni/* 192.168.56.13:/opt/kubernetes/bin/cni/</code></pre><h3 id="2-åˆ›å»ºEtcdçš„key"><a href="#2-åˆ›å»ºEtcdçš„key" class="headerlink" title="2.åˆ›å»ºEtcdçš„key"></a>2.åˆ›å»ºEtcdçš„key</h3><pre><code>/opt/kubernetes/bin/etcdctl --ca-file /opt/kubernetes/ssl/ca.pem --cert-file /opt/kubernetes/ssl/flanneld.pem --key-file /opt/kubernetes/ssl/flanneld-key.pem \      --no-sync -C https://192.168.56.11:2379,https://192.168.56.12:2379,https://192.168.56.13:2379 \mk /kubernetes/network/config '{ "Network": "10.2.0.0/16", "Backend": { "Type": "vxlan", "VNI": 1 }}' &gt;/dev/null 2&gt;&amp;1</code></pre><h3 id="3-å¯åŠ¨flannel"><a href="#3-å¯åŠ¨flannel" class="headerlink" title="3.å¯åŠ¨flannel"></a>3.å¯åŠ¨flannel</h3><pre><code>[root@linux-node1 ~]# systemctl daemon-reload[root@linux-node1 ~]# systemctl enable flannel[root@linux-node1 ~]# chmod +x /opt/kubernetes/bin/*[root@linux-node1 ~]# systemctl start flannel</code></pre><h3 id="4-æŸ¥çœ‹æœåŠ¡çŠ¶æ€"><a href="#4-æŸ¥çœ‹æœåŠ¡çŠ¶æ€" class="headerlink" title="4.æŸ¥çœ‹æœåŠ¡çŠ¶æ€"></a>4.æŸ¥çœ‹æœåŠ¡çŠ¶æ€</h3><pre><code>[root@linux-node1 ~]# systemctl status flannel</code></pre><h2 id="é…ç½®Dockerä½¿ç”¨Flannel"><a href="#é…ç½®Dockerä½¿ç”¨Flannel" class="headerlink" title="é…ç½®Dockerä½¿ç”¨Flannel"></a>é…ç½®Dockerä½¿ç”¨Flannel</h2><pre><code>[root@linux-node1 ~]# vim /usr/lib/systemd/system/docker.service[Unit] #åœ¨Unitä¸‹é¢ä¿®æ”¹Afterå’Œå¢åŠ RequiresAfter=network-online.target firewalld.service flannel.serviceWants=network-online.targetRequires=flannel.service[Service] #å¢åŠ EnvironmentFile=-/run/flannel/dockerType=notEnvironmentFile=-/run/flannel/dockerExecStart=/usr/bin/dockerd $DOCKER_OPTS</code></pre><h3 id="1-å°†é…ç½®å¤åˆ¶åˆ°å¦å¤–çš„èŠ‚ç‚¹"><a href="#1-å°†é…ç½®å¤åˆ¶åˆ°å¦å¤–çš„èŠ‚ç‚¹" class="headerlink" title="1.å°†é…ç½®å¤åˆ¶åˆ°å¦å¤–çš„èŠ‚ç‚¹"></a>1.å°†é…ç½®å¤åˆ¶åˆ°å¦å¤–çš„èŠ‚ç‚¹</h3><pre><code>[root@linux-node1 ~]# scp /usr/lib/systemd/system/docker.service 192.168.56.12:/usr/lib/systemd/system/[root@linux-node1 ~]# scp /usr/lib/systemd/system/docker.service 192.168.56.13:/usr/lib/systemd/system/</code></pre><h3 id="2-é‡å¯Docker"><a href="#2-é‡å¯Docker" class="headerlink" title="2.é‡å¯Docker"></a>2.é‡å¯Docker</h3><pre><code>[root@linux-node1 ~]# systemctl daemon-reload[root@linux-node1 ~]# systemctl restart docker# æ­¤æ—¶å°±å¯ä»¥çœ‹åˆ°docker0ç½‘å¡çš„IP è·Ÿflaneelæ˜¯ä¸€ä¸ªç½‘æ®µçš„äº†ï¼š[root@linux-node2 ~]# ip a | egrep "flannel|docker0"6: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN    inet 10.2.70.0/32 scope global flannel.17: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1400 qdisc noqueue state DOWN    inet 10.2.70.1/24 brd 10.2.70.255 scope global docker0</code></pre>]]></content>
      
      
      <categories>
          
          <category> è™šæ‹ŸåŒ–&amp;amp;äº‘è®¡ç®—&amp;amp;å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>05-K8sé›†ç¾¤æ­å»º---NodeèŠ‚ç‚¹éƒ¨ç½²</title>
      <link href="/2018/06/02/05k8s-ji-qun-da-jiannode-jie-dian-bu-shu/"/>
      <url>/2018/06/02/05k8s-ji-qun-da-jiannode-jie-dian-bu-shu/</url>
      
        <content type="html"><![CDATA[<h2 id="éƒ¨ç½²kubelet"><a href="#éƒ¨ç½²kubelet" class="headerlink" title="éƒ¨ç½²kubelet"></a>éƒ¨ç½²kubelet</h2><h3 id="1-è½¯ä»¶åŒ…å‡†å¤‡"><a href="#1-è½¯ä»¶åŒ…å‡†å¤‡" class="headerlink" title="1.è½¯ä»¶åŒ…å‡†å¤‡"></a>1.è½¯ä»¶åŒ…å‡†å¤‡</h3><pre><code>[root@linux-node1 ~]# cd /usr/local/src/kubernetes/server/bin/[root@linux-node1 bin]# cp kubelet kube-proxy /opt/kubernetes/bin/[root@linux-node1 bin]# scp kubelet kube-proxy 192.168.56.12:/opt/kubernetes/bin/[root@linux-node1 bin]# scp kubelet kube-proxy 192.168.56.13:/opt/kubernetes/bin/</code></pre><h3 id="2-åˆ›å»ºè§’è‰²ç»‘å®š"><a href="#2-åˆ›å»ºè§’è‰²ç»‘å®š" class="headerlink" title="2.åˆ›å»ºè§’è‰²ç»‘å®š"></a>2.åˆ›å»ºè§’è‰²ç»‘å®š</h3><p>kubelet å¯åŠ¨æ—¶å‘ kube-apiserver å‘é€ TLS bootstrapping è¯·æ±‚ï¼Œéœ€è¦å…ˆå°† bootstrap token æ–‡ä»¶ä¸­çš„ kubelet-bootstrap ç”¨æˆ·èµ‹äºˆ system:node-bootstrapper cluster è§’è‰²(role)ï¼Œ ç„¶å kubelet æ‰èƒ½æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚(certificate signing requests):</p><pre><code>[root@linux-node1 ~]# cd /usr/local/src/ssl[root@linux-node1 ~]# kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrapclusterrolebinding "kubelet-bootstrap" created</code></pre><p><code>--user=kubelet-bootstrap</code> æ˜¯åœ¨ /opt/kubernetes/ssl/bootstrap-token.csv æ–‡ä»¶ä¸­æŒ‡å®šçš„ç”¨æˆ·åï¼ŒåŒæ—¶ä¹Ÿå†™å…¥äº†bootstrap.kubeconfig æ–‡ä»¶ï¼›</p><h3 id="3-åˆ›å»º-kubelet-bootstrapping-kubeconfig-æ–‡ä»¶-è®¾ç½®é›†ç¾¤å‚æ•°"><a href="#3-åˆ›å»º-kubelet-bootstrapping-kubeconfig-æ–‡ä»¶-è®¾ç½®é›†ç¾¤å‚æ•°" class="headerlink" title="3.åˆ›å»º kubelet bootstrapping kubeconfig æ–‡ä»¶ è®¾ç½®é›†ç¾¤å‚æ•°"></a>3.åˆ›å»º kubelet bootstrapping kubeconfig æ–‡ä»¶ è®¾ç½®é›†ç¾¤å‚æ•°</h3><pre><code>[root@linux-node1 ~]# kubectl config set-cluster kubernetes \   --certificate-authority=/opt/kubernetes/ssl/ca.pem \   --embed-certs=true \   --server=https://192.168.56.11:6443 \   --kubeconfig=bootstrap.kubeconfigCluster "kubernetes" set.# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°[root@linux-node1 ~]# kubectl config set-credentials kubelet-bootstrap \   --token=ad6d5bb607a186796d8861557df0d17f \   --kubeconfig=bootstrap.kubeconfig   User "kubelet-bootstrap" set.# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°[root@linux-node1 ~]# kubectl config set-context default \   --cluster=kubernetes \   --user=kubelet-bootstrap \   --kubeconfig=bootstrap.kubeconfigContext "default" created.#é€‰æ‹©é»˜è®¤ä¸Šä¸‹æ–‡[root@linux-node1 ~]# kubectl config use-context default --kubeconfig=bootstrap.kubeconfigSwitched to context "default".[root@linux-node1 kubernetes]# cp bootstrap.kubeconfig /opt/kubernetes/cfg[root@linux-node1 kubernetes]# scp bootstrap.kubeconfig 192.168.56.12:/opt/kubernetes/cfg[root@linux-node1 kubernetes]# scp bootstrap.kubeconfig 192.168.56.13:/opt/kubernetes/cfg</code></pre><h3 id="4-é…ç½®CNIæ”¯æŒ"><a href="#4-é…ç½®CNIæ”¯æŒ" class="headerlink" title="4.é…ç½®CNIæ”¯æŒ"></a>4.é…ç½®CNIæ”¯æŒ</h3><pre><code>[root@linux-node2 ~]# mkdir -p /etc/cni/net.d[root@linux-node2 ~]# vim /etc/cni/net.d/10-default.conf{        "name": "flannel",        "type": "flannel",        "delegate": {            "bridge": "docker0",            "isDefaultGateway": true,            "mtu": 1400        }}</code></pre><h3 id="5-åˆ›å»ºkubeletæ‰€éœ€ç›®å½•"><a href="#5-åˆ›å»ºkubeletæ‰€éœ€ç›®å½•" class="headerlink" title="5.åˆ›å»ºkubeletæ‰€éœ€ç›®å½•"></a>5.åˆ›å»ºkubeletæ‰€éœ€ç›®å½•</h3><pre><code>[root@linux-node2 ~]# mkdir /var/lib/kubelet</code></pre><h3 id="6-åˆ›å»ºkubeletç³»ç»ŸæœåŠ¡"><a href="#6-åˆ›å»ºkubeletç³»ç»ŸæœåŠ¡" class="headerlink" title="6.åˆ›å»ºkubeletç³»ç»ŸæœåŠ¡"></a>6.åˆ›å»ºkubeletç³»ç»ŸæœåŠ¡</h3><pre><code>[root@k8s-node2 ~]# cat &gt; /usr/lib/systemd/system/kubelet.service  &lt;&lt; EOF[Unit]Description=Kubernetes KubeletDocumentation=https://github.com/GoogleCloudPlatform/kubernetesAfter=docker.serviceRequires=docker.service[Service]WorkingDirectory=/var/lib/kubeletExecStart=/opt/kubernetes/bin/kubelet \  --address=192.168.56.12 \  --hostname-override=192.168.56.12 \  --pod-infra-container-image=mirrorgooglecontainers/pause-amd64:3.0 \  --experimental-bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \  --kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \  --cert-dir=/opt/kubernetes/ssl \  --network-plugin=cni \  --cni-conf-dir=/etc/cni/net.d \  --cni-bin-dir=/opt/kubernetes/bin/cni \  --cluster-dns=10.1.0.2 \  --cluster-domain=cluster.local. \  --hairpin-mode hairpin-veth \  --allow-privileged=true \  --fail-swap-on=false \  --logtostderr=true \  --v=2 \  --logtostderr=false \  --log-dir=/opt/kubernetes/logRestart=on-failureRestartSec=5[Install]WantedBy=multi-user.targetEOF</code></pre><h3 id="7-å¯åŠ¨å¹¶æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š"><a href="#7-å¯åŠ¨å¹¶æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š" class="headerlink" title="7.å¯åŠ¨å¹¶æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š"></a>7.å¯åŠ¨å¹¶æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š</h3><pre><code>[root@linux-node2 ~]# systemctl daemon-reload[root@linux-node2 ~]# systemctl enable kubelet[root@linux-node2 ~]# systemctl start kubelet[root@linux-node2 kubernetes]# systemctl status kubelet</code></pre><h3 id="8-æŸ¥çœ‹csrè¯·æ±‚-æ³¨æ„æ˜¯åœ¨linux-node1ä¸Šæ‰§è¡Œã€‚"><a href="#8-æŸ¥çœ‹csrè¯·æ±‚-æ³¨æ„æ˜¯åœ¨linux-node1ä¸Šæ‰§è¡Œã€‚" class="headerlink" title="8.æŸ¥çœ‹csrè¯·æ±‚ æ³¨æ„æ˜¯åœ¨linux-node1ä¸Šæ‰§è¡Œã€‚"></a>8.æŸ¥çœ‹csrè¯·æ±‚ æ³¨æ„æ˜¯åœ¨linux-node1ä¸Šæ‰§è¡Œã€‚</h3><pre><code>[root@linux-node1 ~]# kubectl get csrNAME                                                   AGE       REQUESTOR           CONDITIONnode-csr-0_w5F1FM_la_SeGiu3Y5xELRpYUjjT2icIFk9gO9KOU   1m        kubelet-bootstrap   Pending</code></pre><h3 id="9-æ‰¹å‡†kubelet-çš„-TLS-è¯ä¹¦è¯·æ±‚"><a href="#9-æ‰¹å‡†kubelet-çš„-TLS-è¯ä¹¦è¯·æ±‚" class="headerlink" title="9.æ‰¹å‡†kubelet çš„ TLS è¯ä¹¦è¯·æ±‚"></a>9.æ‰¹å‡†kubelet çš„ TLS è¯ä¹¦è¯·æ±‚</h3><pre><code>[root@linux-node1 ~]# kubectl get csr|grep 'Pending' | awk 'NR&gt;0{print $1}'| xargs kubectl certificate approve#æ‰§è¡Œå®Œæ¯•åï¼ŒæŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€å·²ç»æ˜¯Readyçš„çŠ¶æ€äº†[root@linux-node1 ssl]# kubectl get nodesNAME            STATUS    ROLES     AGE       VERSION192.168.56.12   Ready     &lt;none&gt;    2m        v1.10.1</code></pre><h2 id="éƒ¨ç½²Kubernetes-Proxy"><a href="#éƒ¨ç½²Kubernetes-Proxy" class="headerlink" title="éƒ¨ç½²Kubernetes Proxy"></a>éƒ¨ç½²Kubernetes Proxy</h2><h3 id="1-é…ç½®kube-proxyä½¿ç”¨LVS"><a href="#1-é…ç½®kube-proxyä½¿ç”¨LVS" class="headerlink" title="1.é…ç½®kube-proxyä½¿ç”¨LVS"></a>1.é…ç½®kube-proxyä½¿ç”¨LVS</h3><pre><code>[root@linux-node2 ~]# yum install -y ipvsadm ipset conntrack</code></pre><h3 id="2-åˆ›å»º-kube-proxy-è¯ä¹¦è¯·æ±‚"><a href="#2-åˆ›å»º-kube-proxy-è¯ä¹¦è¯·æ±‚" class="headerlink" title="2.åˆ›å»º kube-proxy è¯ä¹¦è¯·æ±‚"></a>2.åˆ›å»º kube-proxy è¯ä¹¦è¯·æ±‚</h3><pre><code>[root@linux-node1 ~]# cd /usr/local/src/ssl/[root@linux-node1 ~]# cat &gt; kube-proxy-csr.json &lt;&lt; EOF{  "CN": "system:kube-proxy",  "hosts": [],  "key": {    "algo": "rsa",    "size": 2048  },  "names": [    {      "C": "CN",      "ST": "BeiJing",      "L": "BeiJing",      "O": "k8s",      "OU": "System"    }  ]}EOF</code></pre><h3 id="3-ç”Ÿæˆè¯ä¹¦"><a href="#3-ç”Ÿæˆè¯ä¹¦" class="headerlink" title="3.ç”Ÿæˆè¯ä¹¦"></a>3.ç”Ÿæˆè¯ä¹¦</h3><pre><code>[root@linux-node1~]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \   -ca-key=/opt/kubernetes/ssl/ca-key.pem \   -config=/opt/kubernetes/ssl/ca-config.json \   -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</code></pre><h3 id="4-åˆ†å‘è¯ä¹¦åˆ°æ‰€æœ‰NodeèŠ‚ç‚¹"><a href="#4-åˆ†å‘è¯ä¹¦åˆ°æ‰€æœ‰NodeèŠ‚ç‚¹" class="headerlink" title="4.åˆ†å‘è¯ä¹¦åˆ°æ‰€æœ‰NodeèŠ‚ç‚¹"></a>4.åˆ†å‘è¯ä¹¦åˆ°æ‰€æœ‰NodeèŠ‚ç‚¹</h3><pre><code>[root@linux-node1 ssl]# cp kube-proxy*.pem /opt/kubernetes/ssl/[root@linux-node1 ssl]# scp kube-proxy*.pem 192.168.56.12:/opt/kubernetes/ssl/[root@linux-node1 ssl]# scp kube-proxy*.pem 192.168.56.12:/opt/kubernetes/ssl/</code></pre><h3 id="5-åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶"><a href="#5-åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶" class="headerlink" title="5.åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶"></a>5.åˆ›å»ºkube-proxyé…ç½®æ–‡ä»¶</h3><pre><code># è®¾ç½®é›†ç¾¤å‚æ•°[root@linux-node1 ssl]# kubectl config set-cluster kubernetes \   --certificate-authority=/opt/kubernetes/ssl/ca.pem \   --embed-certs=true \   --server=https://192.168.56.11:6443 \   --kubeconfig=kube-proxy.kubeconfigCluster "kubernetes" set.# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°[root@linux-node1 ssl]# kubectl config set-credentials kube-proxy \   --client-certificate=/opt/kubernetes/ssl/kube-proxy.pem \   --client-key=/opt/kubernetes/ssl/kube-proxy-key.pem \   --embed-certs=true \   --kubeconfig=kube-proxy.kubeconfigUser "kube-proxy" set.# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°[root@linux-node1 ssl]# kubectl config set-context default \   --cluster=kubernetes \   --user=kube-proxy \   --kubeconfig=kube-proxy.kubeconfigContext "default" created.# è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡[root@linux-node1 ssl]# kubectl config use-context default --kubeconfig=kube-proxy.kubeconfigSwitched to context "default".</code></pre><h3 id="6-åˆ†å‘kubeconfigé…ç½®æ–‡ä»¶"><a href="#6-åˆ†å‘kubeconfigé…ç½®æ–‡ä»¶" class="headerlink" title="6.åˆ†å‘kubeconfigé…ç½®æ–‡ä»¶"></a>6.åˆ†å‘kubeconfigé…ç½®æ–‡ä»¶</h3><pre><code>[root@linux-node1 ssl]# cp kube-proxy.kubeconfig /opt/kubernetes/cfg/[root@linux-node1 ssl]# scp kube-proxy.kubeconfig 192.168.56.12:/opt/kubernetes/cfg/[root@linux-node1 ssl]# scp kube-proxy.kubeconfig 192.168.56.13:/opt/kubernetes/cfg/</code></pre><h3 id="7-åˆ›å»ºkube-proxyç³»ç»ŸæœåŠ¡"><a href="#7-åˆ›å»ºkube-proxyç³»ç»ŸæœåŠ¡" class="headerlink" title="7.åˆ›å»ºkube-proxyç³»ç»ŸæœåŠ¡"></a>7.åˆ›å»ºkube-proxyç³»ç»ŸæœåŠ¡</h3><pre><code>[root@linux-node2 bin]# mkdir /var/lib/kube-proxy[root@k8s-node2 ~]# vim /usr/lib/systemd/system/kube-proxy.service[Unit]Description=Kubernetes Kube-Proxy ServerDocumentation=https://github.com/GoogleCloudPlatform/kubernetesAfter=network.target[Service]WorkingDirectory=/var/lib/kube-proxyExecStart=/opt/kubernetes/bin/kube-proxy \  --bind-address=192.168.56.12 \  --hostname-override=192.168.56.12 \  --kubeconfig=/opt/kubernetes/cfg/kube-proxy.kubeconfig \  --masquerade-all \  --feature-gates=SupportIPVSProxyMode=true \  --proxy-mode=ipvs \  --ipvs-min-sync-period=5s \  --ipvs-sync-period=5s \  --ipvs-scheduler=rr \  --logtostderr=true \  --v=2 \  --logtostderr=false \  --log-dir=/opt/kubernetes/logRestart=on-failureRestartSec=5LimitNOFILE=65536[Install]WantedBy=multi-user.target</code></pre><h3 id="8-å¯åŠ¨Kubernetes-Proxyå¹¶æŸ¥çœ‹çŠ¶æ€"><a href="#8-å¯åŠ¨Kubernetes-Proxyå¹¶æŸ¥çœ‹çŠ¶æ€" class="headerlink" title="8.å¯åŠ¨Kubernetes Proxyå¹¶æŸ¥çœ‹çŠ¶æ€:"></a>8.å¯åŠ¨Kubernetes Proxyå¹¶æŸ¥çœ‹çŠ¶æ€:</h3><pre><code>systemctl status kube-proxy[root@linux-node2 ~]# systemctl daemon-reload[root@linux-node2 ~]# systemctl enable kube-proxy[root@linux-node2 ~]# systemctl start kube-proxy[root@linux-node2 ~]# systemctl status kube-proxy#æ£€æŸ¥LVSçŠ¶æ€[root@linux-node2 ~]# ipvsadm -L -nIP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConnTCP  10.1.0.1:443 rr persistent 10800  -&gt; 192.168.56.11:6443           Masq    1      0          0        </code></pre><h3 id="9-éªŒè¯nodeèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸éƒ¨ç½²-node3æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤å¯åŠ¨æœåŠ¡å³å¯1ï¼Œ7ï¼Œ8"><a href="#9-éªŒè¯nodeèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸éƒ¨ç½²-node3æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤å¯åŠ¨æœåŠ¡å³å¯1ï¼Œ7ï¼Œ8" class="headerlink" title="9.éªŒè¯nodeèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸éƒ¨ç½²(node3æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤å¯åŠ¨æœåŠ¡å³å¯1ï¼Œ7ï¼Œ8)"></a>9.éªŒè¯nodeèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸éƒ¨ç½²(node3æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤å¯åŠ¨æœåŠ¡å³å¯1ï¼Œ7ï¼Œ8)</h3><pre><code>[root@linux-node1 ssl]# kubectl get nodesNAME            STATUS    ROLES     AGE       VERSION192.168.56.12   Ready     &lt;none&gt;    12m       v1.10.1192.168.56.13   Ready     &lt;none&gt;    2d        v1.10.1</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>04-K8sé›†ç¾¤æ­å»º---MasterèŠ‚ç‚¹éƒ¨ç½²</title>
      <link href="/2018/06/02/04k8s-ji-qun-da-jianmaster-jie-dian-bu-shu/"/>
      <url>/2018/06/02/04k8s-ji-qun-da-jianmaster-jie-dian-bu-shu/</url>
      
        <content type="html"><![CDATA[<p>masterèŠ‚ç‚¹æ¶‰åŠæœåŠ¡ç»„ä»¶<code>ApiServer</code> , <code>Scheduler</code> , <code>ControllerManager</code>, <code>kubectl</code></p><h2 id="1-è½¯ä»¶åŒ…å‡†å¤‡"><a href="#1-è½¯ä»¶åŒ…å‡†å¤‡" class="headerlink" title="1.è½¯ä»¶åŒ…å‡†å¤‡:"></a>1.è½¯ä»¶åŒ…å‡†å¤‡:</h2><pre><code>[root@linux-node1 ~]# cd /usr/local/src/kubernetes[root@linux-node1 kubernetes]# cp server/bin/kube-apiserver /opt/kubernetes/bin/[root@linux-node1 kubernetes]# cp server/bin/kube-controller-manager /opt/kubernetes/bin/[root@linux-node1 kubernetes]# cp server/bin/kube-scheduler /opt/kubernetes/bin/</code></pre><h2 id="2-åˆ›å»ºç”ŸæˆCSRçš„-JSON-é…ç½®æ–‡ä»¶"><a href="#2-åˆ›å»ºç”ŸæˆCSRçš„-JSON-é…ç½®æ–‡ä»¶" class="headerlink" title="2.åˆ›å»ºç”ŸæˆCSRçš„ JSON é…ç½®æ–‡ä»¶:"></a>2.åˆ›å»ºç”ŸæˆCSRçš„ JSON é…ç½®æ–‡ä»¶:</h2><pre><code>[root@linux-node1 src]# cat &gt; kubernetes-csr.json &lt;&lt; EOF{  "CN": "kubernetes",  "hosts": [    "127.0.0.1",    "192.168.56.11",    "10.1.0.1",    "kubernetes",    "kubernetes.default",    "kubernetes.default.svc",    "kubernetes.default.svc.cluster",    "kubernetes.default.svc.cluster.local"  ],  "key": {    "algo": "rsa",    "size": 2048  },  "names": [    {      "C": "CN",      "ST": "BeiJing",      "L": "BeiJing",      "O": "k8s",      "OU": "System"    }  ]}EOF</code></pre><h2 id="3-ç”Ÿæˆ-kubernetes-è¯ä¹¦å’Œç§é’¥"><a href="#3-ç”Ÿæˆ-kubernetes-è¯ä¹¦å’Œç§é’¥" class="headerlink" title="3.ç”Ÿæˆ kubernetes è¯ä¹¦å’Œç§é’¥:"></a>3.ç”Ÿæˆ kubernetes è¯ä¹¦å’Œç§é’¥:</h2><pre><code>[root@linux-node1 src]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \   -ca-key=/opt/kubernetes/ssl/ca-key.pem \   -config=/opt/kubernetes/ssl/ca-config.json \   -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes[root@linux-node1 src]# cp kubernetes*.pem /opt/kubernetes/ssl/[root@linux-node1 ~]# scp kubernetes*.pem 192.168.56.12:/opt/kubernetes/ssl/[root@linux-node1 ~]# scp kubernetes*.pem 192.168.56.13:/opt/kubernetes/ssl/</code></pre><h2 id="4-åˆ›å»º-kube-apiserver-ä½¿ç”¨çš„å®¢æˆ·ç«¯-token-æ–‡ä»¶"><a href="#4-åˆ›å»º-kube-apiserver-ä½¿ç”¨çš„å®¢æˆ·ç«¯-token-æ–‡ä»¶" class="headerlink" title="4.åˆ›å»º kube-apiserver ä½¿ç”¨çš„å®¢æˆ·ç«¯ token æ–‡ä»¶"></a>4.åˆ›å»º kube-apiserver ä½¿ç”¨çš„å®¢æˆ·ç«¯ token æ–‡ä»¶</h2><pre><code>[root@linux-node1 ~]#  head -c 16 /dev/urandom | od -An -t x | tr -d ' 'ad6d5bb607a186796d8861557df0d17f [root@linux-node1 ~]# vim /opt/kubernetes/ssl/ bootstrap-token.csvad6d5bb607a186796d8861557df0d17f,kubelet-bootstrap,10001,"system:kubelet-bootstrap"</code></pre><h2 id="5-åˆ›å»ºåŸºç¡€ç”¨æˆ·å-å¯†ç è®¤è¯é…ç½®"><a href="#5-åˆ›å»ºåŸºç¡€ç”¨æˆ·å-å¯†ç è®¤è¯é…ç½®" class="headerlink" title="5.åˆ›å»ºåŸºç¡€ç”¨æˆ·å/å¯†ç è®¤è¯é…ç½®"></a>5.åˆ›å»ºåŸºç¡€ç”¨æˆ·å/å¯†ç è®¤è¯é…ç½®</h2><pre><code>[root@linux-node1 ~]# vim /opt/kubernetes/ssl/basic-auth.csvadmin,admin,1readonly,readonly,2</code></pre><h2 id="6-éƒ¨ç½²K8S-ApiServeræœåŠ¡"><a href="#6-éƒ¨ç½²K8S-ApiServeræœåŠ¡" class="headerlink" title="6.éƒ¨ç½²K8S ApiServeræœåŠ¡"></a>6.éƒ¨ç½²K8S ApiServeræœåŠ¡</h2><h3 id="a-å°†ApiServeré…ç½®ä¸ºç³»ç»ŸæœåŠ¡"><a href="#a-å°†ApiServeré…ç½®ä¸ºç³»ç»ŸæœåŠ¡" class="headerlink" title="a.å°†ApiServeré…ç½®ä¸ºç³»ç»ŸæœåŠ¡"></a>a.å°†ApiServeré…ç½®ä¸ºç³»ç»ŸæœåŠ¡</h3><pre><code>[root@linux-node1 ~]# vim /usr/lib/systemd/system/kube-apiserver.service[Unit]Description=Kubernetes API ServerDocumentation=https://github.com/GoogleCloudPlatform/kubernetesAfter=network.target[Service]ExecStart=/opt/kubernetes/bin/kube-apiserver \  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction \  --bind-address=192.168.56.11 \  --insecure-bind-address=127.0.0.1 \  --authorization-mode=Node,RBAC \  --runtime-config=rbac.authorization.k8s.io/v1 \  --kubelet-https=true \  --anonymous-auth=false \  --basic-auth-file=/opt/kubernetes/ssl/basic-auth.csv \  --enable-bootstrap-token-auth \  --token-auth-file=/opt/kubernetes/ssl/bootstrap-token.csv \  --service-cluster-ip-range=10.1.0.0/16 \  --service-node-port-range=20000-40000 \  --tls-cert-file=/opt/kubernetes/ssl/kubernetes.pem \  --tls-private-key-file=/opt/kubernetes/ssl/kubernetes-key.pem \  --client-ca-file=/opt/kubernetes/ssl/ca.pem \  --service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \  --etcd-cafile=/opt/kubernetes/ssl/ca.pem \  --etcd-certfile=/opt/kubernetes/ssl/kubernetes.pem \  --etcd-keyfile=/opt/kubernetes/ssl/kubernetes-key.pem \  --etcd-servers=https://192.168.56.11:2379,https://192.168.56.12:2379,https://192.168.56.13:2379 \  --enable-swagger-ui=true \  --allow-privileged=true \  --audit-log-maxage=30 \  --audit-log-maxbackup=3 \  --audit-log-maxsize=100 \  --audit-log-path=/opt/kubernetes/log/api-audit.log \  --event-ttl=1h \  --v=2 \  --logtostderr=false \  --log-dir=/opt/kubernetes/logRestart=on-failureRestartSec=5Type=notifyLimitNOFILE=65536[Install]WantedBy=multi-user.target</code></pre><h3 id="b-å¯åŠ¨API-ServeræœåŠ¡"><a href="#b-å¯åŠ¨API-ServeræœåŠ¡" class="headerlink" title="b.å¯åŠ¨API ServeræœåŠ¡"></a>b.å¯åŠ¨API ServeræœåŠ¡</h3><pre><code>[root@linux-node1 ~]# systemctl daemon-reload[root@linux-node1 ~]# systemctl enable kube-apiserver[root@linux-node1 ~]# systemctl start kube-apiserver#æŸ¥çœ‹API ServeræœåŠ¡çŠ¶æ€[root@linux-node1 ~]# systemctl status kube-apiserver</code></pre><h2 id="7-éƒ¨ç½²K8S-ControllerManageræœåŠ¡"><a href="#7-éƒ¨ç½²K8S-ControllerManageræœåŠ¡" class="headerlink" title="7.éƒ¨ç½²K8S ControllerManageræœåŠ¡"></a>7.éƒ¨ç½²K8S ControllerManageræœåŠ¡</h2><h3 id="a-å°†ControllerManageré…ç½®ä¸ºç³»ç»ŸæœåŠ¡"><a href="#a-å°†ControllerManageré…ç½®ä¸ºç³»ç»ŸæœåŠ¡" class="headerlink" title="a.å°†ControllerManageré…ç½®ä¸ºç³»ç»ŸæœåŠ¡"></a>a.å°†ControllerManageré…ç½®ä¸ºç³»ç»ŸæœåŠ¡</h3><pre><code>[root@linux-node1 ~]# vim /usr/lib/systemd/system/kube-controller-manager.service[Unit]Description=Kubernetes Controller ManagerDocumentation=https://github.com/GoogleCloudPlatform/kubernetes[Service]ExecStart=/opt/kubernetes/bin/kube-controller-manager \  --address=127.0.0.1 \  --master=http://127.0.0.1:8080 \  --allocate-node-cidrs=true \  --service-cluster-ip-range=10.1.0.0/16 \  --cluster-cidr=10.2.0.0/16 \  --cluster-name=kubernetes \  --cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \  --cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem \  --service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \  --root-ca-file=/opt/kubernetes/ssl/ca.pem \  --leader-elect=true \  --v=2 \  --logtostderr=false \  --log-dir=/opt/kubernetes/logRestart=on-failureRestartSec=5[Install]WantedBy=multi-user.target</code></pre><h3 id="b-å¯åŠ¨ControllerManageræœåŠ¡"><a href="#b-å¯åŠ¨ControllerManageræœåŠ¡" class="headerlink" title="b.å¯åŠ¨ControllerManageræœåŠ¡"></a>b.å¯åŠ¨ControllerManageræœåŠ¡</h3><pre><code>[root@linux-node1 ~]# systemctl daemon-reload[root@linux-node1 scripts]# systemctl enable kube-controller-manager[root@linux-node1 scripts]# systemctl start kube-controller-manager# æŸ¥çœ‹ControllerManageræœåŠ¡çŠ¶æ€[root@linux-node1 scripts]# systemctl status kube-controller-manager</code></pre><h2 id="éƒ¨ç½²K8S-ScheduleræœåŠ¡"><a href="#éƒ¨ç½²K8S-ScheduleræœåŠ¡" class="headerlink" title="éƒ¨ç½²K8S ScheduleræœåŠ¡"></a>éƒ¨ç½²K8S ScheduleræœåŠ¡</h2><h3 id="a-å°†Scheduleré…ç½®ä¸ºç³»ç»ŸæœåŠ¡"><a href="#a-å°†Scheduleré…ç½®ä¸ºç³»ç»ŸæœåŠ¡" class="headerlink" title="a.å°†Scheduleré…ç½®ä¸ºç³»ç»ŸæœåŠ¡"></a>a.å°†Scheduleré…ç½®ä¸ºç³»ç»ŸæœåŠ¡</h3><pre><code>[root@linux-node1 ~]# vim /usr/lib/systemd/system/kube-scheduler.service[Unit]Description=Kubernetes SchedulerDocumentation=https://github.com/GoogleCloudPlatform/kubernetes[Service]ExecStart=/opt/kubernetes/bin/kube-scheduler \  --address=127.0.0.1 \  --master=http://127.0.0.1:8080 \  --leader-elect=true \  --v=2 \  --logtostderr=false \  --log-dir=/opt/kubernetes/logRestart=on-failureRestartSec=5[Install]WantedBy=multi-user.target</code></pre><h3 id="b-å¯åŠ¨ScheduleræœåŠ¡"><a href="#b-å¯åŠ¨ScheduleræœåŠ¡" class="headerlink" title="b.å¯åŠ¨ScheduleræœåŠ¡"></a>b.å¯åŠ¨ScheduleræœåŠ¡</h3><pre><code>[root@linux-node1 ~]# systemctl daemon-reload[root@linux-node1 scripts]# systemctl enable kube-scheduler[root@linux-node1 scripts]# systemctl start kube-scheduler# æŸ¥çœ‹ScheduleræœåŠ¡çŠ¶æ€[root@linux-node1 scripts]# systemctl status kube-scheduler</code></pre><h2 id="éƒ¨ç½²kubectl-å‘½ä»¤è¡Œå·¥å…·"><a href="#éƒ¨ç½²kubectl-å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="éƒ¨ç½²kubectl å‘½ä»¤è¡Œå·¥å…·"></a>éƒ¨ç½²kubectl å‘½ä»¤è¡Œå·¥å…·</h2><h3 id="1-å‡†å¤‡äºŒè¿›åˆ¶å‘½ä»¤åŒ…"><a href="#1-å‡†å¤‡äºŒè¿›åˆ¶å‘½ä»¤åŒ…" class="headerlink" title="1.å‡†å¤‡äºŒè¿›åˆ¶å‘½ä»¤åŒ…"></a>1.å‡†å¤‡äºŒè¿›åˆ¶å‘½ä»¤åŒ…</h3><pre><code>[root@linux-node1 ~]# cd /usr/local/src/kubernetes/client/bin[root@linux-node1 bin]# cp kubectl /opt/kubernetes/bin/</code></pre><h3 id="2-åˆ›å»º-admin-è¯ä¹¦ç­¾åè¯·æ±‚fds"><a href="#2-åˆ›å»º-admin-è¯ä¹¦ç­¾åè¯·æ±‚fds" class="headerlink" title="2.åˆ›å»º admin è¯ä¹¦ç­¾åè¯·æ±‚fds"></a>2.åˆ›å»º admin è¯ä¹¦ç­¾åè¯·æ±‚fds</h3><pre><code>[root@linux-node1 ~]# cd /usr/local/src/ssl/[root@linux-node1 ssl]# vim admin-csr.json{  "CN": "admin",  "hosts": [],  "key": {    "algo": "rsa",    "size": 2048  },  "names": [    {      "C": "CN",      "ST": "BeiJing",      "L": "BeiJing",      "O": "system:masters",      "OU": "System"    }  ]}</code></pre><h3 id="3-ç”Ÿæˆ-admin-è¯ä¹¦å’Œç§é’¥ï¼š"><a href="#3-ç”Ÿæˆ-admin-è¯ä¹¦å’Œç§é’¥ï¼š" class="headerlink" title="3.ç”Ÿæˆ admin è¯ä¹¦å’Œç§é’¥ï¼š"></a>3.ç”Ÿæˆ admin è¯ä¹¦å’Œç§é’¥ï¼š</h3><pre><code>[root@linux-node1 ssl]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \   -ca-key=/opt/kubernetes/ssl/ca-key.pem \   -config=/opt/kubernetes/ssl/ca-config.json \   -profile=kubernetes admin-csr.json | cfssljson -bare admin[root@linux-node1 ssl]# ls -l admin*-rw-r--r-- 1 root root 1009 Mar  5 12:29 admin.csr-rw-r--r-- 1 root root  229 Mar  5 12:28 admin-csr.json-rw------- 1 root root 1675 Mar  5 12:29 admin-key.pem-rw-r--r-- 1 root root 1399 Mar  5 12:29 admin.pem[root@linux-node1 src]# mv admin*.pem /opt/kubernetes/ssl/</code></pre><h3 id="4-è®¾ç½®é›†ç¾¤å‚æ•°"><a href="#4-è®¾ç½®é›†ç¾¤å‚æ•°" class="headerlink" title="4.è®¾ç½®é›†ç¾¤å‚æ•°"></a>4.è®¾ç½®é›†ç¾¤å‚æ•°</h3><pre><code>[root@linux-node1 src]# kubectl config set-cluster kubernetes \   --certificate-authority=/opt/kubernetes/ssl/ca.pem \   --embed-certs=true \   --server=https://192.168.56.11:6443Cluster "kubernetes" set.</code></pre><h3 id="5-è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°"><a href="#5-è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°" class="headerlink" title="5.è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°"></a>5.è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</h3><pre><code>[root@linux-node1 src]# kubectl config set-credentials admin \   --client-certificate=/opt/kubernetes/ssl/admin.pem \   --embed-certs=true \   --client-key=/opt/kubernetes/ssl/admin-key.pemUser "admin" set.</code></pre><h3 id="6-è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°"><a href="#6-è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°" class="headerlink" title="6.è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°"></a>6.è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</h3><pre><code>[root@linux-node1 src]# kubectl config set-context kubernetes \   --cluster=kubernetes \   --user=adminContext "kubernetes" created.</code></pre><h3 id="7-è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡"><a href="#7-è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡" class="headerlink" title="7.è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡"></a>7.è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</h3><pre><code>[root@linux-node1 src]# kubectl config use-context kubernetesSwitched to context "kubernetes".</code></pre><h3 id="8-ä½¿ç”¨kubectlå·¥å…·"><a href="#8-ä½¿ç”¨kubectlå·¥å…·" class="headerlink" title="8.ä½¿ç”¨kubectlå·¥å…·"></a>8.ä½¿ç”¨kubectlå·¥å…·</h3><pre><code>[root@linux-node1 ~]# kubectl get csNAME                 STATUS    MESSAGE             ERRORcontroller-manager   Healthy   ok                  scheduler            Healthy   ok                  etcd-1               Healthy   {"health":"true"}   etcd-2               Healthy   {"health":"true"}   etcd-0               Healthy   {"health":"true"} </code></pre><p>è‡³æ­¤ k8sMasterç«¯ä»¥åŠetcdé›†ç¾¤å·²ç»æ­å»ºå®Œæ¯•</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>03-K8sé›†ç¾¤æ­å»º---éƒ¨ç½²ETCDé›†ç¾¤</title>
      <link href="/2018/06/02/03k8s-ji-qun-da-jian-sanbu-shuetcd-ji-qun/"/>
      <url>/2018/06/02/03k8s-ji-qun-da-jian-sanbu-shuetcd-ji-qun/</url>
      
        <content type="html"><![CDATA[<h2 id="0-è§£å‹å®‰è£…åˆ†å‘etcdäºŒè¿›åˆ¶åŒ…"><a href="#0-è§£å‹å®‰è£…åˆ†å‘etcdäºŒè¿›åˆ¶åŒ…" class="headerlink" title="0.è§£å‹å®‰è£…åˆ†å‘etcdäºŒè¿›åˆ¶åŒ…:"></a>0.è§£å‹å®‰è£…åˆ†å‘etcdäºŒè¿›åˆ¶åŒ…:</h2><pre><code>[root@linux-node1 src]# tar zxf etcd-v3.2.18-linux-amd64.tar.gz[root@linux-node1 src]# cd etcd-v3.2.18-linux-amd64[root@linux-node1 etcd-v3.2.18-linux-amd64]# chmod +x etcdctl [root@linux-node1 etcd-v3.2.18-linux-amd64]# cp etcd etcdctl /opt/kubernetes/bin/ [root@linux-node1 etcd-v3.2.18-linux-amd64]# scp etcd etcdctl 192.168.56.12:/opt/kubernetes/bin/[root@linux-node1 etcd-v3.2.18-linux-amd64]# scp etcd etcdctl 192.168.56.13:/opt/kubernetes/bin/</code></pre><h2 id="1-åˆ›å»º-etcd-è¯ä¹¦ç­¾åè¯·æ±‚ï¼š"><a href="#1-åˆ›å»º-etcd-è¯ä¹¦ç­¾åè¯·æ±‚ï¼š" class="headerlink" title="1.åˆ›å»º etcd è¯ä¹¦ç­¾åè¯·æ±‚ï¼š"></a>1.åˆ›å»º etcd è¯ä¹¦ç­¾åè¯·æ±‚ï¼š</h2><pre><code>[root@linux-node1 ~]# cat &gt; etcd-csr.json &lt;&lt; EOF{  "CN": "etcd",  "hosts": [    "127.0.0.1","192.168.56.11","192.168.56.12","192.168.56.13"  ],  "key": {    "algo": "rsa",    "size": 2048  },  "names": [    {      "C": "CN",      "ST": "BeiJing",      "L": "BeiJing",      "O": "k8s",      "OU": "System"    }  ]}EOF</code></pre><h2 id="2-ç”Ÿæˆ-etcd-è¯ä¹¦å’Œç§é’¥ï¼š"><a href="#2-ç”Ÿæˆ-etcd-è¯ä¹¦å’Œç§é’¥ï¼š" class="headerlink" title="2.ç”Ÿæˆ etcd è¯ä¹¦å’Œç§é’¥ï¼š"></a>2.ç”Ÿæˆ etcd è¯ä¹¦å’Œç§é’¥ï¼š</h2><pre><code>[root@linux-node1 ~]# cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem \  -ca-key=/opt/kubernetes/ssl/ca-key.pem \  -config=/opt/kubernetes/ssl/ca-config.json \  -profile=kubernetes etcd-csr.json | cfssljson -bare etcd# ä¼šç”Ÿæˆä»¥ä¸‹è¯ä¹¦æ–‡ä»¶[root@linux-node1 ssl]# ll etc*-rw-r--r-- 1 root root 1062 May 28 15:39 etcd.csr-rw-r--r-- 1 root root  287 May 28 15:38 etcd-csr.json-rw------- 1 root root 1679 May 28 15:39 etcd-key.pem-rw-r--r-- 1 root root 1436 May 28 15:39 etcd.pem</code></pre><h2 id="3-å°†è¯ä¹¦ç§»åŠ¨åˆ°-opt-kubernetes-sslç›®å½•ä¸‹"><a href="#3-å°†è¯ä¹¦ç§»åŠ¨åˆ°-opt-kubernetes-sslç›®å½•ä¸‹" class="headerlink" title="3.å°†è¯ä¹¦ç§»åŠ¨åˆ°/opt/kubernetes/sslç›®å½•ä¸‹:"></a>3.å°†è¯ä¹¦ç§»åŠ¨åˆ°/opt/kubernetes/sslç›®å½•ä¸‹:</h2><pre><code>[root@linux-node1 ~]# cp etcd*.pem /opt/kubernetes/ssl[root@linux-node1 ~]# scp etcd*.pem 192.168.56.12:/opt/kubernetes/ssl[root@linux-node1 ~]# scp etcd*.pem 192.168.56.13:/opt/kubernetes/ssl[root@linux-node1 ~]# rm -f etcd.csr etcd-csr.json</code></pre><h2 id="4-å¢åŠ etcdé…ç½®æ–‡ä»¶"><a href="#4-å¢åŠ etcdé…ç½®æ–‡ä»¶" class="headerlink" title="4.å¢åŠ etcdé…ç½®æ–‡ä»¶:"></a>4.å¢åŠ etcdé…ç½®æ–‡ä»¶:</h2><pre><code>!!!!! æ³¨æ„è¿™é‡Œéœ€è¦ä¿®æ”¹ç›¸å…³å¯¹åº”æœåŠ¡å™¨çš„IPåœ°å€ !!!!![root@linux-node1 ~]# vim /opt/kubernetes/cfg/etcd.conf#[member]ETCD_NAME="etcd-node1" # ä¿®æ”¹èŠ‚ç‚¹å¯¹åº”åç§°ETCD_DATA_DIR="/var/lib/etcd/default.etcd"#ETCD_SNAPSHOT_COUNTER="10000"#ETCD_HEARTBEAT_INTERVAL="100"#ETCD_ELECTION_TIMEOUT="1000"ETCD_LISTEN_PEER_URLS="https://192.168.56.11:2380" # ä¿®æ”¹å¯¹åº”æœåŠ¡å™¨IPETCD_LISTEN_CLIENT_URLS="https://192.168.56.11:2379,https://127.0.0.1:2379"#ETCD_MAX_SNAPSHOTS="5"#ETCD_MAX_WALS="5"#ETCD_CORS=""#[cluster]ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.56.11:2380" # ä¿®æ”¹å¯¹åº”æœåŠ¡å™¨IP# if you use different ETCD_NAME (e.g. test),# set ETCD_INITIAL_CLUSTER value for this name, i.e. "test=http://..."ETCD_INITIAL_CLUSTER="etcd-node1=https://192.168.56.11:2380,etcd-node2=https://192.168.56.12:2380,etcd-node3=https://192.168.56.13:2380"ETCD_INITIAL_CLUSTER_STATE="new"ETCD_INITIAL_CLUSTER_TOKEN="k8s-etcd-cluster"ETCD_ADVERTISE_CLIENT_URLS="https://192.168.56.11:2379" # ä¿®æ”¹å¯¹åº”æœåŠ¡å™¨IP#[security]CLIENT_CERT_AUTH="true"ETCD_CA_FILE="/opt/kubernetes/ssl/ca.pem"ETCD_CERT_FILE="/opt/kubernetes/ssl/etcd.pem"ETCD_KEY_FILE="/opt/kubernetes/ssl/etcd-key.pem"PEER_CLIENT_CERT_AUTH="true"ETCD_PEER_CA_FILE="/opt/kubernetes/ssl/ca.pem"ETCD_PEER_CERT_FILE="/opt/kubernetes/ssl/etcd.pem"ETCD_PEER_KEY_FILE="/opt/kubernetes/ssl/etcd-key.pem"</code></pre><h2 id="5-å¢åŠ etcdç³»ç»ŸæœåŠ¡"><a href="#5-å¢åŠ etcdç³»ç»ŸæœåŠ¡" class="headerlink" title="5.å¢åŠ etcdç³»ç»ŸæœåŠ¡"></a>5.å¢åŠ etcdç³»ç»ŸæœåŠ¡</h2><pre><code>[root@linux-node1 ~]# cat  &gt; /etc/systemd/system/etcd.service &lt;&lt; EOF[Unit]Description=Etcd ServerAfter=network.target[Service]Type=simpleWorkingDirectory=/var/lib/etcdEnvironmentFile=-/opt/kubernetes/cfg/etcd.conf# set GOMAXPROCS to number of processorsExecStart=/bin/bash -c "GOMAXPROCS=$(nproc) /opt/kubernetes/bin/etcd"Type=notify[Install]WantedBy=multi-user.targetEOF</code></pre><h2 id="6-é‡æ–°åŠ è½½ç³»ç»ŸæœåŠ¡"><a href="#6-é‡æ–°åŠ è½½ç³»ç»ŸæœåŠ¡" class="headerlink" title="6.é‡æ–°åŠ è½½ç³»ç»ŸæœåŠ¡"></a>6.é‡æ–°åŠ è½½ç³»ç»ŸæœåŠ¡</h2><pre><code>[root@linux-node1 ~]# systemctl daemon-reload[root@linux-node1 ~]# systemctl enable etcd[root@linux-node1 ~]# scp /opt/kubernetes/cfg/etcd.conf 192.168.56.12:/opt/kubernetes/cfg/[root@linux-node1 ~]# scp /etc/systemd/system/etcd.service 192.168.56.12:/etc/systemd/system/[root@linux-node1 ~]# scp /opt/kubernetes/cfg/etcd.conf 192.168.56.13:/opt/kubernetes/cfg/[root@linux-node1 ~]# scp /etc/systemd/system/etcd.service 192.168.56.13:/etc/systemd/system/#åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šåˆ›å»ºetcdå­˜å‚¨ç›®å½•å¹¶å¯åŠ¨etcd(æ³¨æ„è¿™é‡Œéœ€è¦ä¸‰å°å°½é‡åŒæ—¶å¯åŠ¨)[root@linux-node1 ~]# mkdir /var/lib/etcd[root@linux-node1 ~]# systemctl start etcd[root@linux-node1 ~]# systemctl status etcd# å…¶ä»–èŠ‚ç‚¹é‡å¤ä»¥ä¸Šæ“ä½œï¼Œç›´åˆ°æ‰€æœ‰æœºå™¨çš„ etcd æœåŠ¡éƒ½å·²å¯åŠ¨ã€‚</code></pre><h2 id="7-éªŒè¯ETCDé›†ç¾¤"><a href="#7-éªŒè¯ETCDé›†ç¾¤" class="headerlink" title="7.éªŒè¯ETCDé›†ç¾¤"></a>7.éªŒè¯ETCDé›†ç¾¤</h2><pre><code>[root@linux-node1 ssl]# etcdctl --endpoints=https://192.168.56.11:2379 \&gt;   --ca-file=/opt/kubernetes/ssl/ca.pem \&gt;   --cert-file=/opt/kubernetes/ssl/etcd.pem \&gt;   --key-file=/opt/kubernetes/ssl/etcd-key.pem cluster-healthmember 6566e06d7343e1bb is healthy: got healthy result from https://192.168.56.11:2379member 435fb0a8da627a4c is healthy: got healthy result from https://192.168.56.12:2379member ce7b884e428b6c8c is healthy: got healthy result from https://192.168.56.13:2379cluster is healthy  # é›†ç¾¤å¯ç”¨</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>02-K8sé›†ç¾¤æ­å»º---CAè¯ä¹¦ç”Ÿæˆ</title>
      <link href="/2018/06/01/02k8s-ji-qun-da-jianca-zheng-shu-sheng-cheng/"/>
      <url>/2018/06/01/02k8s-ji-qun-da-jianca-zheng-shu-sheng-cheng/</url>
      
        <content type="html"><![CDATA[<p>kubernetes ç³»ç»Ÿçš„å„ç»„ä»¶éœ€è¦ä½¿ç”¨ TLS è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†ï¼Œä½¿ç”¨ CloudFlare çš„ PKI å·¥å…·é›† cfssl æ¥ç”Ÿæˆ Certificate Authority (CA) å’Œå…¶å®ƒè¯ä¹¦ï¼›</p><p>ä½¿ç”¨è¯ä¹¦çš„ç»„ä»¶å¦‚ä¸‹ï¼š</p><ul><li>etcdï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼›</li><li>kube-apiserverï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼›</li><li>kubeletï¼šä½¿ç”¨ ca.pemï¼›</li><li>kube-proxyï¼šä½¿ç”¨ ca.pemã€kube-proxy-key.pemã€kube-proxy.pemï¼›</li><li>kubectlï¼šä½¿ç”¨ ca.pemã€admin-key.pemã€admin.pemï¼›</li><li>kube-controllerã€kube-scheduler å½“å‰éœ€è¦å’Œ kube-apiserver éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šä¸”ä½¿ç”¨éå®‰å…¨ç«¯å£é€šä¿¡ï¼Œæ•…ä¸éœ€è¦è¯ä¹¦ã€‚</li><li>(åé¢çš„æ“ä½œæˆ‘ä»¬åšåˆ°å“ªä¸€æ­¥å†å»åšå¯¹åº”ç»„å»ºçš„è¯ä¹¦ï¼Œä»¥å…å‡ºç°å·®é”™</li></ul><h2 id="1-å®‰è£…-CFSSL-äºŒè¿›åˆ¶æ–¹å¼"><a href="#1-å®‰è£…-CFSSL-äºŒè¿›åˆ¶æ–¹å¼" class="headerlink" title="1. å®‰è£… CFSSL(äºŒè¿›åˆ¶æ–¹å¼)"></a>1. å®‰è£… CFSSL(äºŒè¿›åˆ¶æ–¹å¼)</h2><pre><code>[root@linux-node1 ~]# cd /usr/local/src[root@linux-node1 src]# mv cfssl-certinfo_linux-amd64 /opt/kubernetes/bin/cfssl-certinfo[root@linux-node1 src]# mv cfssljson_linux-amd64  /opt/kubernetes/bin/cfssljson[root@linux-node1 src]# mv cfssl_linux-amd64  /opt/kubernetes/bin/cfssl[root@linux-node1 src]# chmod +x  /opt/kubernetes/bin/cf*å¤åˆ¶cfsslå‘½ä»¤æ–‡ä»¶åˆ°node2å’Œnode3èŠ‚ç‚¹ã€‚å¦‚æœå®é™…ä¸­å¤šä¸ªèŠ‚ç‚¹ï¼Œå°±éƒ½éœ€è¦åŒæ­¥å¤åˆ¶ã€‚[root@linux-node1 ~]# scp /opt/kubernetes/bin/cfssl* 192.168.56.12: /opt/kubernetes/bin[root@linux-node1 ~]# scp /opt/kubernetes/bin/cfssl* 192.168.56.13: /opt/kubernetes/bin</code></pre><h2 id="2-åˆå§‹åŒ–cfssl"><a href="#2-åˆå§‹åŒ–cfssl" class="headerlink" title="2.åˆå§‹åŒ–cfssl"></a>2.åˆå§‹åŒ–cfssl</h2><pre><code>[root@linux-node1 src]# mkdir ssl &amp;&amp; cd ssl[root@linux-node1 ssl]# cfssl print-defaults config &gt; config.json[root@linux-node1 ssl]# cfssl print-defaults csr &gt; csr.json</code></pre><h2 id="3-åˆ›å»ºç”¨æ¥ç”Ÿæˆ-CA-æ–‡ä»¶çš„-JSON-é…ç½®æ–‡ä»¶"><a href="#3-åˆ›å»ºç”¨æ¥ç”Ÿæˆ-CA-æ–‡ä»¶çš„-JSON-é…ç½®æ–‡ä»¶" class="headerlink" title="3.åˆ›å»ºç”¨æ¥ç”Ÿæˆ CA æ–‡ä»¶çš„ JSON é…ç½®æ–‡ä»¶"></a>3.åˆ›å»ºç”¨æ¥ç”Ÿæˆ CA æ–‡ä»¶çš„ JSON é…ç½®æ–‡ä»¶</h2><pre><code>[root@linux-node1 ssl]# cat &gt; ca-config.json &lt;&lt;EOF{  "signing": {    "default": {      "expiry": "8760h"    },    "profiles": {      "kubernetes": {        "usages": [            "signing",            "key encipherment",            "server auth",            "client auth"        ],        "expiry": "8760h"      }    }  }}EOF</code></pre><h2 id="åˆ›å»ºç”¨æ¥ç”Ÿæˆ-CA-è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰çš„-JSON-é…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºç”¨æ¥ç”Ÿæˆ-CA-è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰çš„-JSON-é…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºç”¨æ¥ç”Ÿæˆ CA è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰çš„ JSON é…ç½®æ–‡ä»¶"></a>åˆ›å»ºç”¨æ¥ç”Ÿæˆ CA è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰çš„ JSON é…ç½®æ–‡ä»¶</h2><pre><code>[root@linux-node1 ssl]# cat &gt; ca-csr.json &lt;&lt;EOF{  "CN": "kubernetes",  "key": {    "algo": "rsa",    "size": 2048  },  "names": [    {      "C": "CN",      "ST": "BeiJing",      "L": "BeiJing",      "O": "k8s",      "OU": "System"    }  ]}EOF</code></pre><h2 id="5-ç”ŸæˆCAè¯ä¹¦ï¼ˆca-pemï¼‰å’Œå¯†é’¥ï¼ˆca-key-pemï¼‰"><a href="#5-ç”ŸæˆCAè¯ä¹¦ï¼ˆca-pemï¼‰å’Œå¯†é’¥ï¼ˆca-key-pemï¼‰" class="headerlink" title="5.ç”ŸæˆCAè¯ä¹¦ï¼ˆca.pemï¼‰å’Œå¯†é’¥ï¼ˆca-key.pemï¼‰"></a>5.ç”ŸæˆCAè¯ä¹¦ï¼ˆca.pemï¼‰å’Œå¯†é’¥ï¼ˆca-key.pemï¼‰</h2><pre><code>[root@linux-node1 ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca[root@linux-node1 ssl]# ls -l ca*-rw-r--r-- 1 root root  290 May 28 15:25 ca-config.json-rw-r--r-- 1 root root 1001 May 28 15:30 ca.csr-rw-r--r-- 1 root root  208 May 28 15:30 ca-csr.json-rw------- 1 root root 1675 May 28 15:30 ca-key.pem-rw-r--r-- 1 root root 1359 May 28 15:30 ca.pem</code></pre><h2 id="6-åˆ†å‘è¯ä¹¦"><a href="#6-åˆ†å‘è¯ä¹¦" class="headerlink" title="6.åˆ†å‘è¯ä¹¦"></a>6.åˆ†å‘è¯ä¹¦</h2><pre><code>[root@ linux-node1 ssl]# cp ca.csr ca.pem ca-key.pem ca-config.json /opt/kubernetes/sslscpè¯ä¹¦åˆ°node2å’Œnode3èŠ‚ç‚¹[root@ linux-node1 ssl]# scp ca.csr ca.pem ca-key.pem ca-config.json 192.168.56.12:/opt/kubernetes/ssl [root@ linux-node1 ssl]# scp ca.csr ca.pem ca-key.pem ca-config.json 192.168.56.13:/opt/kubernetes/ssl</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>01-K8sé›†ç¾¤æ­å»º---ç³»ç»Ÿåˆå§‹åŒ–é…ç½®</title>
      <link href="/2018/05/30/01k8s-ji-qun-da-jian-yixi-tong-chu-shi-hua-pei-zhi/"/>
      <url>/2018/05/30/01k8s-ji-qun-da-jian-yixi-tong-chu-shi-hua-pei-zhi/</url>
      
        <content type="html"><![CDATA[<h2 id="1-æ¶æ„è¯´æ˜"><a href="#1-æ¶æ„è¯´æ˜" class="headerlink" title="1.æ¶æ„è¯´æ˜:"></a>1.æ¶æ„è¯´æ˜:</h2><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/06/15278627011918.jpg">ï¿¼</p><h2 id="2-ç‰ˆæœ¬ä¿¡æ¯"><a href="#2-ç‰ˆæœ¬ä¿¡æ¯" class="headerlink" title="2.ç‰ˆæœ¬ä¿¡æ¯:"></a>2.ç‰ˆæœ¬ä¿¡æ¯:</h2><ul><li>ç³»ç»Ÿç‰ˆæœ¬CentOS7.x</li><li>Kubernets: v1.10</li><li>Etcd: v3.3.1</li><li>Docker: 18.03.1-ce</li><li>Flannel: v1.10</li><li>CNI-Plugins: v0.7.0 å»ºè®®éƒ¨ç½²èŠ‚ç‚¹ï¼šæœ€å°‘ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œè¯·é…ç½®å¥½ä¸»æœºåè§£æï¼ˆå¿…å¤‡ï¼‰</li></ul><h2 id="3-ç³»ç»Ÿåˆå§‹åŒ–-ä¸‰å°æœåŠ¡å™¨åˆ†åˆ«æ‰§è¡Œå³å¯ï¼Œä»¥node1ä¸ºä¾‹"><a href="#3-ç³»ç»Ÿåˆå§‹åŒ–-ä¸‰å°æœåŠ¡å™¨åˆ†åˆ«æ‰§è¡Œå³å¯ï¼Œä»¥node1ä¸ºä¾‹" class="headerlink" title="3.ç³»ç»Ÿåˆå§‹åŒ–(ä¸‰å°æœåŠ¡å™¨åˆ†åˆ«æ‰§è¡Œå³å¯ï¼Œä»¥node1ä¸ºä¾‹):"></a>3.ç³»ç»Ÿåˆå§‹åŒ–(ä¸‰å°æœåŠ¡å™¨åˆ†åˆ«æ‰§è¡Œå³å¯ï¼Œä»¥node1ä¸ºä¾‹):</h2><p>a. ä¸»æœºåé…ç½®</p><pre><code>node1:echo "linux-node1.example.com" &gt; /etc/hostname</code></pre><p>b. è®¾ç½®/etc/hostsä¿è¯ä¸»æœºåèƒ½å¤Ÿè§£æ</p><pre><code>node1:echo "192.168.56.11 linux-node1 linux-node1.example.com" &gt;&gt; /etc/hosts</code></pre><p>c. å…³é—­SELinuxåŠé˜²ç«å¢™</p><pre><code>node1:systemctl disable firewalld; systemctl stop firewalld sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</code></pre><p>d. ç¯å¢ƒå˜é‡é…ç½®(åç»­k8sç›¸å…³å‘½ä»¤éƒ½ä¼šæ”¾åˆ°/opt/kubernetes/binç›®å½•ä¸‹)</p><pre><code>PATH=$PATH:$HOME/bin:/opt/kubernetes/binsource ~/.bash_profile</code></pre><h2 id="4-å®‰è£…Docker"><a href="#4-å®‰è£…Docker" class="headerlink" title="4.å®‰è£…Docker"></a>4.å®‰è£…Docker</h2><p>aï¼šä½¿ç”¨å›½å†…Dockeræº</p><pre><code>[root@linux-node1 ~]# cd /etc/yum.repos.d/[root@linux-node1 yum.repos.d]# wget \https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></pre><p>bï¼šDockerå®‰è£…ï¼š</p><pre><code>[root@linux-node1 ~]# yum install -y docker-ce</code></pre><p>cï¼šå¯åŠ¨åå°è¿›ç¨‹ï¼š</p><pre><code>[root@linux-node1 ~]# systemctl start docker</code></pre><h2 id="5-å‡†å¤‡éƒ¨ç½²ç›®å½•"><a href="#5-å‡†å¤‡éƒ¨ç½²ç›®å½•" class="headerlink" title="5.å‡†å¤‡éƒ¨ç½²ç›®å½•"></a>5.å‡†å¤‡éƒ¨ç½²ç›®å½•</h2><pre><code>[root@linux-node1 ~]#  mkdir -p /opt/kubernetes/{cfg,bin,ssl,log}# ç›®å½•ç»“æ„, æ‰€æœ‰æ–‡ä»¶å‡å­˜æ”¾åœ¨/opt/kubernetesç›®å½•ä¸‹ï¼š[root@linux-node1 ~]# tree -L 1 /opt/kubernetes//opt/kubernetes/â”œâ”€â”€ bin   #äºŒè¿›åˆ¶æ–‡ä»¶â”œâ”€â”€ cfg   #é…ç½®æ–‡ä»¶â”œâ”€â”€ log   #æ—¥å¿—æ–‡ä»¶â””â”€â”€ ssl   #è¯ä¹¦æ–‡ä»¶</code></pre><h2 id="6-å‡†å¤‡è½¯ä»¶åŒ…"><a href="#6-å‡†å¤‡è½¯ä»¶åŒ…" class="headerlink" title="6.å‡†å¤‡è½¯ä»¶åŒ…"></a>6.å‡†å¤‡è½¯ä»¶åŒ…</h2><p>ç™¾åº¦ç½‘ç›˜ä¸‹è½½åœ°å€ï¼š<br><a href="https://pan.baidu.com/s/1bQo7PEfKJAAhk4KzQgLrMQ">https://pan.baidu.com/s/1bQo7PEfKJAAhk4KzQgLrMQ</a> å¯†ç :gm3k</p><h2 id="7-è§£å‹è½¯ä»¶åŒ…"><a href="#7-è§£å‹è½¯ä»¶åŒ…" class="headerlink" title="7.è§£å‹è½¯ä»¶åŒ…"></a>7.è§£å‹è½¯ä»¶åŒ…</h2><pre><code>[root@linux-node1 ~]# cd /tmp/ &amp;&amp; unzip k8s-v1.10.1-manual.zip &amp;&amp; mv k8s-v1.10.1-manual/k8s-v1.10.1/* /usr/local/src/[root@linux-node1 ~]# cd /usr/local/src[root@linux-node1 ~]# tar zxf kubernetes.tar.gz [root@linux-node1 ~]# tar zxf kubernetes-server-linux-amd64.tar.gz [root@linux-node1 ~]# tar zxf kubernetes-client-linux-amd64.tar.gz[root@linux-node1 ~]# tar zxf kubernetes-node-linux-amd64.tar.gz</code></pre><h2 id="8-åšå¥½masterèŠ‚ç‚¹è·Ÿå…¶ä»–nodeèŠ‚ç‚¹çš„sshäº’ä¿¡-ä¾¿äºæ­å»º"><a href="#8-åšå¥½masterèŠ‚ç‚¹è·Ÿå…¶ä»–nodeèŠ‚ç‚¹çš„sshäº’ä¿¡-ä¾¿äºæ­å»º" class="headerlink" title="8.åšå¥½masterèŠ‚ç‚¹è·Ÿå…¶ä»–nodeèŠ‚ç‚¹çš„sshäº’ä¿¡,ä¾¿äºæ­å»º"></a>8.åšå¥½masterèŠ‚ç‚¹è·Ÿå…¶ä»–nodeèŠ‚ç‚¹çš„sshäº’ä¿¡,ä¾¿äºæ­å»º</h2><pre><code>[root@linux-node1 ~]# ssh-key -t rsa ""..................[root@linux-node1 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.56.11[root@linux-node1 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.56.12</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8sé›†ç¾¤æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•å®ç°Mysqlæ•°æ®åº“å·®å¼‚åŒ–å¯¹æ¯”</title>
      <link href="/2018/03/18/ru-he-shi-xianmysql-shu-ju-ku-cha-yi-hua-dui-bi/"/>
      <url>/2018/03/18/ru-he-shi-xianmysql-shu-ju-ku-cha-yi-hua-dui-bi/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å›¢é˜Ÿå¼€å‘ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šå­˜åœ¨æµ‹è¯•ã€é¢„å‘å¸ƒã€æ­£å¼ç¯å¢ƒæˆ–å¤šç‰ˆæœ¬è¿›è¡Œå¼€å‘ï¼›ä»£ç çš„ç®¡ç†ä¸€èˆ¬ä¹Ÿæœ‰git/svnç­‰ç­‰å·¥å…·ï¼›</p><p>ä½†æ˜¯åœ¨mysqlçš„ç®¡ç†å°±æœ‰äº›éº»çƒ¦äº†ï¼Œå¯¹äºä¸€äº›æ­£è§„åŒ–çš„å¤§å‚å›¢é˜Ÿï¼Œå¯¹æ•°æ®åº“çš„æ¯ä¸€æ¬¡è¡¨ç»“æ„éƒ½æœ‰è¯¦ç»†çš„è®°å½•ï¼Œè¿™æ ·åœ¨æ‰§è¡Œå˜æ›´/å‡çº§çš„æ—¶å€™åªéœ€è¦æ‰§è¡Œç›´æ¥æ‰§è¡Œå˜æ›´è¿‡çš„SQLå³å¯ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¹Ÿä¼šå‡ºç°è®°å½•ä¸å®Œæ•´æˆ–è€…é—æ¼é€ æˆæµ‹è¯•/é¢„å‘å¸ƒ/æ­£å¼ç¯å¢ƒçš„ä¸ä¸€è‡´ã€‚</p><p>è¿™æ—¶å€™å°±éœ€è¦äººå·¥å»æŸ¥æ‰¾ä¸¤ä¸ªæ•°æ®åº“æ•°æ®è¡¨ä¸­çš„ä¸åŒï¼›çœ‹å“ªé‡Œå°‘ä»€ä¹ˆï¼Œå“ªé‡Œå¤šäº†ä»€ä¹ˆï¼Œä½†æ˜¯å¦‚æœäººå·¥å»æ¯æ¬¡desc/selectæ˜¯å¾ˆè´¹æ—¶è´¹åŠ›çš„äº‹æƒ…ï¼›é‚£ä¹ˆè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°mysqlçš„ç›¸å…³å·¥å…·ï¼›ä¾‹å¦‚<a href="https://dev.mysql.com/doc/mysql-utilities/1.6/en/mysqldiff.html">mysqldiff</a></p><h5 id="ä¾‹å¦‚"><a href="#ä¾‹å¦‚" class="headerlink" title="ä¾‹å¦‚:"></a>ä¾‹å¦‚:</h5><p>è¿™é‡Œæœ‰ä¸ª<code>db1</code>è·Ÿ<code>db2</code> æ•°æ®åº“ï¼Œå„è‡ªé‡Œé¢æœ‰ä¸¤å¼ è¡¨<code>student_1</code>,<code>student2</code>,è¿™é‡Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢çš„ç»“æ„ç”¨è‚‰çœ¼æ˜¯å¯ä»¥çœ‹å‡ºæ¥çš„ï¼›</p><pre><code>MariaDB [(none)]&gt; use db1;Database changedMariaDB [db1]&gt; show tables;+---------------+| Tables_in_db1 |+---------------+| student_1     |+---------------+1 row in set (0.00 sec)MariaDB [db1]&gt; desc student_1;+-------------+-------------+------+-----+---------+-------+| Field       | Type        | Null | Key | Default | Extra |+-------------+-------------+------+-----+---------+-------+| studentNo   | char(10)    | NO   | PRI | NULL    |       || studentName | varchar(20) | NO   |     | NULL    |       || sex         | char(2)     | YES  |     | NULL    |       || birthday    | date        | YES  |     | NULL    |       || native      | varchar(20) | YES  |     | NULL    |       || nation      | varchar(20) | YES  |     | NULL    |       || classNo     | char(6)     | YES  |     | NULL    |       |+-------------+-------------+------+-----+---------+-------+7 rows in set (0.01 sec)MariaDB [db1]&gt; use db2;Database changedMariaDB [db2]&gt; desc student_2;+-------------+-------------+------+-----+---------+-------+| Field       | Type        | Null | Key | Default | Extra |+-------------+-------------+------+-----+---------+-------+| studentNo   | char(10)    | NO   | PRI | NULL    |       || studentName | varchar(20) | NO   |     | NULL    |       || sex         | char(2)     | YES  |     | NULL    |       || birthday    | date        | YES  |     | NULL    |       || native      | varchar(40) | YES  |     | NULL    |       || nation      | varchar(20) | YES  |     | NULL    |       |+-------------+-------------+------+-----+---------+-------+6 rows in set (0.00 sec)MariaDB [db2]&gt;</code></pre><h5 id="å¦‚æœä½¿ç”¨mysqldiffå·¥å…·è¾“å‡ºå°†ä¼šæ˜¯è¿™æ ·çš„"><a href="#å¦‚æœä½¿ç”¨mysqldiffå·¥å…·è¾“å‡ºå°†ä¼šæ˜¯è¿™æ ·çš„" class="headerlink" title="å¦‚æœä½¿ç”¨mysqldiffå·¥å…·è¾“å‡ºå°†ä¼šæ˜¯è¿™æ ·çš„:"></a>å¦‚æœä½¿ç”¨mysqldiffå·¥å…·è¾“å‡ºå°†ä¼šæ˜¯è¿™æ ·çš„:</h5><pre><code>mysqldiff --server1=root:123.com@127.0.0.1:3306 --server2=root:123.com@127.0.0.1:3306   db1.student_1:db2.student_2;# WARNING: Using a password on the command line interface can be insecure.# server1 on 127.0.0.1: ... connected.# server2 on 127.0.0.1: ... connected.# Comparing db1.student_1 to db2.student_2                         [FAIL]# Object definitions differ. (--changes-for=server1)#--- db1.student_1+++ db2.student_2@@ -1,10 +1,9 @@-CREATE TABLE `student_1` (+CREATE TABLE `student_2` (   `studentNo` char(10) NOT NULL,   `studentName` varchar(20) NOT NULL,   `sex` char(2) DEFAULT NULL,   `birthday` date DEFAULT NULL,-  `native` varchar(20) DEFAULT NULL,+  `native` varchar(40) DEFAULT NULL,   `nation` varchar(20) DEFAULT NULL,-  `classNo` char(6) DEFAULT NULL,   UNIQUE KEY `studentNo` (`studentNo`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8# Compare failed. One or more differences found.</code></pre><p>ä»ä»¥ä¸Šè¾“å‡ºå¯ä»¥çœ‹å‡ºæ¥, <code>db2</code>çš„<code>student_2</code>ç›¸å¯¹äº<code>db1</code>çš„<code>student_1</code>ç»“æ„<br>1.å­—æ®µ<code>native</code>çš„vacharç±»å‹é™åˆ¶ä¸åŒï¼›è¡¨<code>student_2</code>æ˜¯40,è¡¨<code>student_1</code>æ˜¯40ï¼›<br>2.è¡¨<code>student_2</code>ç¼ºå°‘å­—æ®µ<code>classNo</code></p><p>è¿™æ ·ä¸€æ¥å°±èƒ½å¾ˆå¿«é€Ÿçš„è¾“å‡ºä¸¤ä¸ªåº“ä¸­è¡¨ç»“æ„çš„å·®å¼‚ï¼›ç„¶åçœ‹ä»¥é‚£ä¸ªåº“ä¸ºæ ‡æ†è¿›è¡ŒAlertæ“ä½œå°±è¡Œäº†<br>ä¸‹é¢æ˜¯æˆ‘æ”¹æ­£åå†æ¬¡æ‰§è¡Œmysqldiffå·¥å…·å‘½ä»¤çš„ç»“æœè¾“å‡º:</p><pre><code>mysqldiff --server1=root:123.com@127.0.0.1:3306 --server2=root:123.com@127.0.0.1:3306   db1.student_1:db2.student_2;# WARNING: Using a password on the command line interface can be insecure.# server1 on 127.0.0.1: ... connected.# server2 on 127.0.0.1: ... connected.# Comparing db1.student_1 to db2.student_2                         [PASS]# WARNING: The tables structure is the same, but the columns order is different. Use --change-for to take the order into account.# Success. All objects are the same.</code></pre><p>æ„æ€å°±æ˜¯è¯´æ£€æµ‹é€šè¿‡ï¼Œçœ‹èµ·æ¥æ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>So, ç®€å•ä½¿ç”¨æ–¹æ³•å°±æ˜¯é…±ç´«çš„äº†ï¼›å…¶å®è¿˜æœ‰æ›´å¤šçš„é€‰é¡¹å°±è¡Œæ“ä½œçš„ï¼›ä½†æ˜¯ç›®å‰æš‚æ—¶æ²¡æœ‰ç”¨åˆ°ï¼›éœ€è¦çš„è¯æ‰¾manå°±å¥½äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç³»ç»Ÿè¿ç»´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•åˆ©ç”¨Git Webhook è¿›è¡Œéƒ¨ç½²</title>
      <link href="/2018/03/08/ru-he-li-yonggit-webhook-jin-xing-bu-shu/"/>
      <url>/2018/03/08/ru-he-li-yonggit-webhook-jin-xing-bu-shu/</url>
      
        <content type="html"><![CDATA[<p>ä½œä¸ºä¸€åâ€ä¼ªç å†œâ€è¿ç»´å·¥ç¨‹å¸ˆ,åœ¨æ¥è§¦äº†å¼€å‘æ–¹é¢çš„çŸ¥è¯†åï¼›ä¹Ÿåœ¨å†™é¡¹ç›®æ—¶ä¸€ç›´ä½¿ç”¨git,å¯æ˜¯å¼€å‘ã€è°ƒè¯•ã€éƒ¨ç½²éƒ½æ˜¯åœ¨æœ¬åœ°è¿›è¡Œçš„ï¼›åœ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨æ—¶ä¹Ÿæ˜¯é€šè¿‡æ‰‹å·¥å»è·å–ä»“åº“çš„ä»£ç ï¼›<br>1.å¼€å‘å®Œä»£ç æäº¤åˆ°è¿œç¨‹ä»“åº“;<br>2.ç™»å½•è¿œç¨‹æœåŠ¡å™¨,å¹¶åˆ‡åˆ°ä»£ç ç›®å½•è¿›è¡Œgit pull;<br>3.é‡å¯supervisoråº”ç”¨(æˆ‘è¿™è¾¹å¼€å‘çš„python webåº”ç”¨æ˜¯supervisorè¿›è¡Œç®¡ç†);</p><p>å½“ç„¶å¦‚æœåªæ˜¯ä¸€æ¬¡æ€§éƒ¨ç½²ä¸Šå»å°±ä¸å†ä¿®æ”¹çš„è¯å¹¶æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯è¦æ˜¯é¡¹ç›®æŒç»­æ€§ä¿®æ”¹è¿­ä»£çš„è¯ï¼Œå°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œå°±åœ¨ä¸æ–­çš„é‡å¤ç€ä¸Šé¢çš„æ­¥éª¤ã€‚ä½œä¸ºä¸€ä¸ªâ€ä¼ªç å†œâ€ï¼Œæ€ä¹ˆå…è®¸ä¸æ–­çš„é‡å¤åŒæ ·çš„å·¥ä½œï¼Œäºæ˜¯git webhooksé—ªäº®ç™»åœºï¼›å¤§å®¶å¯¹äºé’©å­å¹¶ä¸é™Œç”Ÿï¼ŒåŒæ ·çš„ç‰ˆæœ¬æ§åˆ¶SVNä¹Ÿæœ‰é’©å­è¿™ä¸ªåŠŸèƒ½ï¼›åªæ˜¯ä¸ªäººæ›´åŠ çš„å€¾å‘äºä½¿ç”¨git; ç„¶ågitä¹Ÿå‚¬ç”Ÿå‡ºæ¥äº†å¾ˆå¤šï¼›æ¯”å¦‚ä½¿ç”¨æœ€å¹¿æ³›çš„æ˜¯GitHubï¼Œå†å…¶æ¬¡å°±æ˜¯Gitlab,æœ€åå°±æ˜¯æˆ‘è¿™è¾¹æ˜¯ç”¨çš„Gogs;ä»–ä»¬éƒ½æœ‰åŒæ ·çš„åŠŸèƒ½ï¼›åªæ˜¯è¯´çœ‹éœ€æ±‚è·Ÿä¹ æƒ¯; gogsæœ‰ä¸ªdockerç‰ˆæœ¬ï¼›èƒ½åœ¨2åˆ†é’Ÿä¹‹å†…å°±å¯ä»¥è·‘èµ·æ¥éå¸¸è½»å·§æ–¹ä¾¿ï¼›æ„Ÿå…´è¶£çš„è¯·ç‚¹å‡»è¿™é‡Œ<a href="https://gogs.io/">Gogs</a></p><h2 id="git-webhookè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²"><a href="#git-webhookè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²" class="headerlink" title="git webhookè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²"></a>git webhookè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²</h2><p>å¦‚ä½•å®ç° Git webhookè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²ï¼Œå…¶å®åŸç†å¾ˆç®€å•ï¼Œå¦‚å›¾æ‰€ç¤º:<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/03/15204907260564.jpg">ï¿¼</p><p>1.æœ¬åœ°ä»£ç å¼€å‘å®Œæ¯•æäº¤åˆ°è¿œç¨‹ä»“åº“;<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/03/15204935021288.jpg">ï¿¼</p><p>2.é€šè¿‡ POST è¯·æ±‚å°†è®¢é˜…äº‹ä»¶ä¿¡æ¯å‘é€è‡³å‘æŒ‡å®š URL åœ°å€;<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/03/15204937008543.jpg">ï¿¼</p><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/03/15204935532769.jpg">ï¿¼</p><p>3.æŒ‡å®šçš„urlæ˜¯ä½¿ç”¨Flaskå†™çš„ä¸€ä¸ªåº”ç”¨,è§¦å‘è¿™ä¸ªURLå°±ä¼šè¿›è¡Œè¿œç¨‹ä»“åº“çš„ä»£ç clone/pull<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/03/15204936075814.jpg">ï¿¼<br>4.æ‹‰å–ä»£ç å®Œæ¯•å,é‡å¯æœåŠ¡</p><h2 id="Flask-webåº”ç”¨ä»£ç "><a href="#Flask-webåº”ç”¨ä»£ç " class="headerlink" title="Flask webåº”ç”¨ä»£ç :"></a>Flask webåº”ç”¨ä»£ç :</h2><pre><code># -*- coding:utf-8 -*-# ä¾èµ–åŒ…: pip install flask gitpythonfrom flask import Flask, request, jsonify,abortimport git, os# è¿œç¨‹æœåŠ¡å™¨ä»£ç åœ°å€code_dir = "./code"# è¿œç¨‹ä»“åº“åœ°å€git_url = "git@192.168.1.105:guomaoqiu/devopscode.git"#ç™½åå•allow_ip=["192.168.1.105"]app = Flask(__name__)#é‡å¯æœåŠ¡restart_services = os.system("supervisorctl -c /etc/supervisord.conf restart devops &amp;&amp; supervisorctl -c /etc/supervisord.conf restart celery")@app.route('/pullcode', methods=['POST'])def pullcode():    # åªå…è®¸æŒ‡å®šæœåŠ¡å™¨å‘Flaskåº”ç”¨å‘èµ·POSTè¯·æ±‚ï¼Œå¦åˆ™ç›´æ¥è¿”å›403    if request.headers.get('X-Forwarded-For', request.remote_addr) not in allow_ip:        return abort(403)    if request.method == 'POST':        if os.path.isdir(code_dir):            local_repo = git.Repo(code_dir)            try:                print local_repo.git.pull()                # é‡æ–°åŠ è½½ä»£ç ã€é‡å¯æœåŠ¡                restart_services                return jsonify({"result":True,"message":"pull success"})            except Exception,e:                return jsonify({"result":False,"message": "pull faild".format(e)})        else:            try:                print git.Repo.clone_from(url=git_url, to_path=code_dir)                # é‡æ–°åŠ è½½ä»£ç ã€é‡å¯æœåŠ¡                restart_services                return jsonify({"result":True,"message":"clone success"})            except Exception, e:                return jsonify({"result":False,"message": "clone faild".format(e)})if __name__ == '__main__':    app.run(host='192.168.1.29', port=5003)</code></pre><p>å¦‚æœå…¶ä»–åœ°å€å‘èµ·POSTè¯·æ±‚é‚£ä¹ˆå°±ç›´æ¥è¿”å›403,è¿™æ ·å°±é¿å…äº†å…¶ä»–äººä¹±æ¥çš„æƒ…å†µ:<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2018/03/15204939019299.jpg">ï¿¼</p><p>æ€»ç»“èµ·æ¥ä¹Ÿå°±æ˜¯:<br>æœ¬åœ°ä»“åº“æ¨é€ä»£ç åˆ°è¿œç¨‹ä»“åº“åï¼Œä¸€æ—¦æœ¬åœ°ä»“åº“å˜æ›´æäº¤å°±ä¼šè§¦å‘webhookå‘é€postè¯·æ±‚ï¼Œé©±åŠ¨è‡ªåŠ¨éƒ¨ç½²ã€é‡å¯æœåŠ¡ç­‰ã€‚<br>è¿™æ ·ä¸€æ¥åªéœ€è¦æœ¬åœ°å¼€å‘å¥½ä»£ç æäº¤åç›´æ¥è®¿é—®æœåŠ¡å™¨å°±å¯ä»¥éªŒè¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºäº†;</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è‡ªåŠ¨åŒ–è¿ç»´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•ä½¿ç”¨Celery(èŠ¹èœ)å¼‚æ­¥ç¥å™¨æ‰§è¡Œåå°ä»»åŠ¡</title>
      <link href="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/"/>
      <url>/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/</url>
      
        <content type="html"><![CDATA[<p>å…³äºå¼‚æ­¥çš„çŸ¥è¯†ç½‘ä¸Šå¾ˆå¤šï¼Œè¿™é‡Œå°±ç›´æ¥ä¸Šä»£ç ï¼Œç›®å‰ç»“åˆFlaskè¿™ä¸ªPythonæ¡†æ¶å®ç°åå°ä»»åŠ¡çš„æ‰§è¡Œæ“ä½œï¼›</p><h3 id="1-éœ€è¦äº†è§£çš„çŸ¥è¯†ç‚¹"><a href="#1-éœ€è¦äº†è§£çš„çŸ¥è¯†ç‚¹" class="headerlink" title="1.éœ€è¦äº†è§£çš„çŸ¥è¯†ç‚¹:"></a>1.éœ€è¦äº†è§£çš„çŸ¥è¯†ç‚¹:</h3><ul><li>äº†è§£ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹æˆ–è€…å‘å¸ƒè®¢é˜…æ¨¡å¼æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—</li><li>äº†è§£å¼‚æ­¥ã€åŒæ­¥ä¹‹é—´çš„å·®åˆ«</li></ul><h3 id="2-å®ç°è¿‡ç¨‹"><a href="#2-å®ç°è¿‡ç¨‹" class="headerlink" title="2.å®ç°è¿‡ç¨‹"></a>2.å®ç°è¿‡ç¨‹</h3><h4 id="1-ç›®å½•ç»“æ„"><a href="#1-ç›®å½•ç»“æ„" class="headerlink" title="(1)ç›®å½•ç»“æ„"></a>(1)ç›®å½•ç»“æ„</h4><pre><code>â”œâ”€â”€ LICENSEâ”œâ”€â”€ README.mdâ”œâ”€â”€ app                     // Flask APPåº”ç”¨â”‚&nbsp;&nbsp; â”œâ”€â”€ __init__.py â”‚&nbsp;&nbsp; â”œâ”€â”€ authâ”‚&nbsp;&nbsp; â”œâ”€â”€ email.pyâ”‚&nbsp;&nbsp; â”œâ”€â”€ mainâ”‚&nbsp;&nbsp; â”œâ”€â”€ models.pyâ”‚&nbsp;&nbsp; â”œâ”€â”€ saltâ”‚&nbsp;&nbsp; â”œâ”€â”€ staticâ”‚&nbsp;&nbsp; â””â”€â”€ templatesâ”œâ”€â”€ config.py               // é€šç”¨é…ç½®â”œâ”€â”€ config.pycâ”œâ”€â”€ manager.pyâ”œâ”€â”€ migrationsâ”‚&nbsp;&nbsp; â”œâ”€â”€ READMEâ”‚&nbsp;&nbsp; â”œâ”€â”€ alembic.iniâ”‚&nbsp;&nbsp; â”œâ”€â”€ env.pyâ”‚&nbsp;&nbsp; â””â”€â”€ versionsâ””â”€â”€ requirements.txt</code></pre><h4 id="2-æŒ‡å®šbroker-backend-æ­¤å¤„ä½¿ç”¨redis"><a href="#2-æŒ‡å®šbroker-backend-æ­¤å¤„ä½¿ç”¨redis" class="headerlink" title="(2)æŒ‡å®šbroker/backend(æ­¤å¤„ä½¿ç”¨redis)"></a>(2)æŒ‡å®šbroker/backend(æ­¤å¤„ä½¿ç”¨redis)</h4><p>vim app/__init__.py</p><pre><code>// éƒ¨åˆ†ä»£ç from celery import Celeryapp = Flask(__name__)broker = 'redis://127.0.0.1:6379'backend = 'redis://127.0.0.1:6379/0'celery = Celery(app.name, broker=broker, backend=backend)// éƒ¨åˆ†ä»£ç </code></pre><p>ä»¥ä¸Šå¼•å…¥äº†Celery,æŒ‡å®šäº†Celeryçš„ç”Ÿäº§æ¶ˆè´¹ç«¯éƒ½ä¸ºæˆ‘ä»¬çš„redis</p><h4 id="3-è¿™é‡Œæˆ‘å°†ä»»åŠ¡å†™åˆ°äº†è§†å›¾å‡½æ•°ä¸­"><a href="#3-è¿™é‡Œæˆ‘å°†ä»»åŠ¡å†™åˆ°äº†è§†å›¾å‡½æ•°ä¸­" class="headerlink" title="(3)è¿™é‡Œæˆ‘å°†ä»»åŠ¡å†™åˆ°äº†è§†å›¾å‡½æ•°ä¸­"></a>(3)è¿™é‡Œæˆ‘å°†ä»»åŠ¡å†™åˆ°äº†è§†å›¾å‡½æ•°ä¸­</h4><p>vim app/main/views.py</p><ul><li><p>(1 åˆ›å»ºä¸€ä¸ªä»»åŠ¡å‡½æ•°, å¹¶ä¸”å°†è¿™ä¸ªä»»åŠ¡ç»‘å®šä¸Šäº†celeryçš„æ ‡è®°</p><h3 id="éƒ¨åˆ†ä»£ç "><a href="#éƒ¨åˆ†ä»£ç " class="headerlink" title="éƒ¨åˆ†ä»£ç "></a>éƒ¨åˆ†ä»£ç </h3><p>@celery.task(bind=True)<br>def update_cbt_resource(self):<br>â€˜â€™â€™<br>@summary: åˆ›å»ºä¸€ä¸ªéœ€è¦åå°å»æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæˆ‘è¿™é‡Œåªæ˜¯ä¸¾ä¸ªæ —å­<br>â€˜â€™â€™<br>result=commands.getoutput(â€œsleep 20 &amp;&amp; echo â€˜okâ€™â€)<br>return result</p></li><li><p>(2 åˆ›å»ºä¸€ä¸ªæ‰§è¡Œä»»åŠ¡è¯·æ±‚å‡½æ•°</p><h3 id="éƒ¨åˆ†ä»£ç -1"><a href="#éƒ¨åˆ†ä»£ç -1" class="headerlink" title="éƒ¨åˆ†ä»£ç "></a>éƒ¨åˆ†ä»£ç </h3><p>@main.route(â€˜/execute_task/<update_env>â€˜, methods=[â€˜GETâ€™, â€˜POSTâ€™])<br>def execute_task(update_env):<br>â€œâ€â€<br>@summary: è¯·æ±‚å‡½æ•°å…¥å£<br>â€œâ€â€<br># è¿™é‡Œç”¨æœ€ç¬¨çš„åŠæ³•æ‰§è¡Œäº†åœ¨æˆ‘ä»¬webä¸­ç‚¹å‡»æ‰§è¡Œä»»åŠ¡ä¹‹å‰å»æ£€æŸ¥celeryè¿™ä¸ªæœåŠ¡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ä¼šæç¤ºç”¨æˆ·<br>result = commands.getoutput(â€œps -ef | grep celery | grep -v grepâ€)<br>if not result:<br>    return jsonify({â€œresultâ€:False,â€messageâ€:uâ€™æœªå‘ç°Celeryè¿›ç¨‹ï¼Œè¯·æ£€æŸ¥è¯¥æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨â€™})<br><br> # å°†å‰é¢å†™çš„ä»»åŠ¡å‡½æ•°ç›´æ¥è°ƒç”¨apply_asyncå±æ€§<br>task = update_cbt_resource.apply_async()<br><br> # è¿™é‡Œå°±å¯ä»¥è·å–åˆ°è¿™ä¸ªä»»åŠ¡ä¸€å¼€å§‹æ‰§è¡Œå°±è¿”å›çš„ä¸€äº›å±æ€§<br> # æ¯”å¦‚ä»»åŠ¡ID, ä»»åŠ¡çŠ¶æ€<br>data = {<br>    â€œtask_idâ€: task.id,<br>    â€œtask_statusâ€: task.status<br>}<br><br># å°†ä»¥ä¸Šçš„ä¿¡æ¯ä½œä¸ºè¿™è¯·æ±‚å‡½æ•°çš„è¿”å›<br>result = {â€œresultâ€:True,â€dataâ€:data,â€messageâ€:uâ€™æ‰§è¡Œå¼€å§‹â€™}<br>return jsonify(result)</update_env></p></li><li><p>(3 åˆ›å»ºä¸€ä¸ªä»»åŠ¡çŠ¶æ€æŸ¥è¯¢çš„å‡½æ•°</p></li></ul><p>ä¸€èˆ¬ä»»åŠ¡è§¦å‘ä¹‹åæˆ‘ä»¬æƒ³è¦çŸ¥é“è¿™ä¸ªä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œæ˜¯å¤„äºå“ªä¸ªé˜¶æ®µçš„ï¼Œå„ä¸ªçŠ¶æ€å·²ç»åœ¨å®˜ç½‘è¯¦ç»†è¯´æ˜äº†ï¼›æœ‰å…´è¶£çš„ç›´æ¥çœ‹<a href="http://docs.celeryproject.org/en/master/userguide/tasks.html?highlight=built-in-states">å®˜ç½‘</a></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### éƒ¨åˆ†çš„ä»£ç </span></span><br><span class="line"><span class="meta">@main.route(<span class="params"><span class="string">'/task_result'</span>, methods=[<span class="string">'GET'</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_result</span>():</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    @summary: ä»»åŠ¡çš„çŠ¶æ€æ˜¯é€šè¿‡task_idæ¥è·å–,åœ¨è§¦å‘äº†ä»»åŠ¡ä¹‹å,é€šè¿‡å‰ç«¯jsè½®è¯¢è¯·æ±‚è¿™ä¸ªå‡½æ•°ï¼Œå°±å¯ä»¥å¾—åˆ°è¯¥ä»»åŠ¡çš„å½“å‰æ‰§è¡ŒçŠ¶æ€</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># ç‚¹å‡»æ‰§è¡ŒæŒ‰é’®å‰ç«¯ä¼šä¼ ä¸€ä¸ªtask_idåˆ°åç«¯,è¿™é‡Œä½¿ç”¨formçš„æ–¹å¼è·å–åˆ°task_id</span></span><br><span class="line">    task_id = json.loads(request.form.get(<span class="string">'data'</span>))[<span class="string">'task_id'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># AsyncResultï¼Œå®ƒçš„ä½œç”¨æ˜¯è¢«ç”¨æ¥æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æˆ–è·å–ä»»åŠ¡ç»“æœï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œå®ƒä¼šè¿”å›å¼‚å¸¸ä¿¡æ¯æˆ–è€…è°ƒç”¨æ ˆã€‚</span></span><br><span class="line">    the_task = update_cbt_resource.AsyncResult(task_id)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"ä»»åŠ¡ï¼š{0} å½“å‰çš„ state ä¸ºï¼š{1}"</span>.<span class="built_in">format</span>(task_id, the_task.state))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰§the_task.state</span></span><br><span class="line">    <span class="keyword">if</span>  the_task.state  == <span class="string">'PROGRESS'</span>:</span><br><span class="line">        <span class="built_in">print</span> the_task.info.get(<span class="string">'i'</span>, <span class="number">0</span>)</span><br><span class="line">        result = {<span class="string">'state'</span>: <span class="string">'progress'</span>,<span class="string">"result_data"</span>:the_task.result}</span><br><span class="line">    <span class="keyword">elif</span>  the_task.state  == <span class="string">'SUCCESS'</span>:</span><br><span class="line">        result = {<span class="string">'state'</span>: <span class="string">"success"</span>, <span class="string">"result_data"</span>:the_task.result}</span><br><span class="line">    <span class="keyword">elif</span>  the_task.state  == <span class="string">'PENDING'</span>:</span><br><span class="line">        result = {<span class="string">'state'</span>: <span class="string">'waitting'</span>,<span class="string">"result_data"</span>:the_task.result}</span><br><span class="line">    <span class="keyword">elif</span>  the_task.state  == <span class="string">'REVOKED'</span>:</span><br><span class="line">        result = { <span class="string">'state'</span>: <span class="string">'revoke'</span>, <span class="string">"result_data"</span>:the_task.result}</span><br><span class="line">        <span class="built_in">print</span> the_task.result</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result = {<span class="string">'state'</span>: the_task.state,<span class="string">'progress'</span>:<span class="number">0</span>,<span class="string">"result_data"</span>:the_task.result}</span><br><span class="line">    <span class="keyword">return</span> jsonify(result)</span><br></pre></td></tr></tbody></table></figure><ul><li><p>(4 å°è¯•åœ¨å‰ç«¯é¡µé¢ç‚¹å‡»æ‰§è¡Œä»»åŠ¡<br><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115172368997.jpg">ï¿¼<br>Oops! è¿™å°±æ˜¯ä¸Šé¢è¿›è¡Œceleryè¿›ç¨‹åˆ¤æ–­ä¹‹åå¾—åˆ°çš„æç¤ºä¿¡æ¯ï¼Œé‚£ä¸‹é¢å°±æŠŠceleryå¯åŠ¨èµ·æ¥å§~~~</p></li><li><p>(5 å¯åŠ¨CeleyæœåŠ¡</p><p>celery worker -A manager.celery -l debug</p><h3 id="æˆ‘è¿™é‡Œæ˜¯æœ¬åœ°ä½¿ç”¨çš„virtualenvç¯å¢ƒ"><a href="#æˆ‘è¿™é‡Œæ˜¯æœ¬åœ°ä½¿ç”¨çš„virtualenvç¯å¢ƒ" class="headerlink" title="æˆ‘è¿™é‡Œæ˜¯æœ¬åœ°ä½¿ç”¨çš„virtualenvç¯å¢ƒ~~~"></a>æˆ‘è¿™é‡Œæ˜¯æœ¬åœ°ä½¿ç”¨çš„virtualenvç¯å¢ƒ~~~</h3></li></ul><p><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115170661909.jpg">ï¿¼<br>ok, ç°åœ¨å¯åŠ¨äº†celeryæœåŠ¡ä¹‹åæˆ‘ä»¬åœ¨å‰å°æ‰§è¡Œä¸€ä¸‹:<br><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115174358505.jpg">ï¿¼<br>é€šè¿‡ç‚¹å‡»æ‰§è¡Œåæˆ‘ä»¬çœ‹æ—¥å¿—ï¼š<br><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115175046963.jpg">ï¿¼</p><p>ä»»åŠ¡æ‰§è¡Œå®Œæ¯•äº†ï¼›<br><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115178118958.jpg">ï¿¼</p><p>å†çœ‹çœ‹Flaskçš„æ—¥å¿—,è¿™å°±æ˜¯é€šè¿‡jsè½®è¯¢è¯·æ±‚è¿™ä¸ªtask_resulå‡½æ•°çš„ç»“æœ<br><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115175573963.jpg">ï¿¼<br>å†æ¥çœ‹çœ‹redisä¸­çš„å†…å®¹,è¿™å°±å°†ç»“æœä¿å­˜åˆ°äº†backendä¸­<br><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115176602486.jpg">ï¿¼</p><h4 id="4-å¦‚ä½•æ’¤é”€ä¸€ä¸ªä»»åŠ¡å‘¢"><a href="#4-å¦‚ä½•æ’¤é”€ä¸€ä¸ªä»»åŠ¡å‘¢" class="headerlink" title="(4)å¦‚ä½•æ’¤é”€ä¸€ä¸ªä»»åŠ¡å‘¢?"></a>(4)å¦‚ä½•æ’¤é”€ä¸€ä¸ªä»»åŠ¡å‘¢?</h4><p>è¿˜æ˜¯é€šè¿‡task_idæ¥å®ç°ã€‚è§†å›¾å‡½æ•°ä¸­ç¼–å†™ä¸€ä¸ªä»»åŠ¡çš„å‡½æ•°</p><pre><code>### éƒ¨åˆ†ä»£ç @main.route('/cancel_task/', methods=['GET', 'POST'])@login_requireddef cancel_task():     # é€šè¿‡å‰ç«¯çš„å–æ¶ˆæŒ‰é’®æ¥è·å–åˆ°è¿™ä¸ªä»»åŠ¡çš„id    task_id = json.loads(request.form.get('data'))['task_id']    try:        celery.control.revoke(task_id, terminate=True, signal='SIGKILL')        return Response(json.dumps({'result':True,"message": "å–æ¶ˆä»»åŠ¡å®Œæˆ" }))    except Exception,e:        return Response(json.dumps({'result': True, "message": u'å–æ¶ˆä»»åŠ¡å¤±è´¥.{0}'.format(e)}))</code></pre><p>æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹:<br><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115182402670.jpg">ï¿¼<br><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115182685942.jpg">ï¿¼<br><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115213514662.jpg">ï¿¼</p><p><img src="/2017/11/24/ru-he-shi-yongcelery-qin-cai-yi-bu-shen-qi-zhi-xin/15115182945362.jpg">ï¿¼<br>éœ€è¦æ³¨æ„çš„æ˜¯,åœ¨ä¸Šé¢è§†å›¾å‡½æ•°ä¸­çš„è¿™æ®µä»£ç å…¶å®æœ‰ä¹Ÿå¯ä»¥æ’¤é”€</p><pre><code>task = update_cbt_resource.apply_async()task.revoke() </code></pre><p>ä½†æ˜¯è¿™ç§æ–¹å¼åªæ˜¯æ’¤é”€ï¼Œå¦‚æœä»»åŠ¡å·²ç»åœ¨æ‰§è¡Œæ’¤é”€åˆ™æ— æ•ˆ;æ‰€ä»¥æˆ‘è¿™é‡Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•æ¥æ’¤é”€</p><pre><code># é€šè¿‡task_idæ’¤é”€celery.control.revoke(task_id)# æ’¤é”€æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé»˜è®¤ä½¿ç”¨TERMä¿¡å·celery.control.revoke(task_id, terminate=True)# æ’¤é”€æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé»˜è®¤ä½¿ç”¨KILLä¿¡å·celery.control.revoke(task_id, terminate=True, signal='SIGKILL')#åœ¨å®˜ç½‘æ–‡æ¡£ä¸­ä¹Ÿå¯ä»¥å°†å¤šä¸ªtask_idç»„æˆåˆ—è¡¨å½¢å¼ç„¶ååŒæ—¶æ’¤é”€å¤šä¸ªä»»åŠ¡celery.control.revoke([task_id1,task_id2,task_id3,task_id4.......])</code></pre><h4 id="okï¼Œä»¥ä¸Šå°±æ˜¯Celery-çš„åŸºæœ¬ä½¿ç”¨ã€‚"><a href="#okï¼Œä»¥ä¸Šå°±æ˜¯Celery-çš„åŸºæœ¬ä½¿ç”¨ã€‚" class="headerlink" title="okï¼Œä»¥ä¸Šå°±æ˜¯Celery çš„åŸºæœ¬ä½¿ç”¨ã€‚"></a>okï¼Œä»¥ä¸Šå°±æ˜¯Celery çš„åŸºæœ¬ä½¿ç”¨ã€‚</h4>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Celery </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redisé›†ç¾¤è¯¦ç»†æ­å»ºæŒ‡å—</title>
      <link href="/2017/06/04/redis-ji-qun-xiang-xi-da-jian-zhi-nan/"/>
      <url>/2017/06/04/redis-ji-qun-xiang-xi-da-jian-zhi-nan/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis-é›†ç¾¤ç®€ä»‹"><a href="#Redis-é›†ç¾¤ç®€ä»‹" class="headerlink" title="Redis é›†ç¾¤ç®€ä»‹"></a>Redis é›†ç¾¤ç®€ä»‹</h2><p>Redis æ˜¯ä¸€ä¸ªå¼€æºçš„ key-value å­˜å‚¨ç³»ç»Ÿï¼Œç”±äºå‡ºä¼—çš„æ€§èƒ½ï¼Œå¤§éƒ¨åˆ†äº’è”ç½‘ä¼ä¸šéƒ½ç”¨æ¥åšæœåŠ¡å™¨ç«¯ç¼“å­˜ã€‚Redis åœ¨3.0ç‰ˆæœ¬å‰åªæ”¯æŒå•å®ä¾‹æ¨¡å¼ï¼Œè™½ç„¶æ”¯æŒä¸»ä»æ¨¡å¼ã€å“¨å…µæ¨¡å¼éƒ¨ç½²æ¥è§£å†³å•ç‚¹æ•…éšœï¼Œä½†æ˜¯ç°åœ¨äº’è”ç½‘ä¼ä¸šåŠ¨è¾„å¤§å‡ ç™¾Gçš„æ•°æ®ï¼Œå¯å®Œå…¨æ˜¯æ²¡æ³•æ»¡è¶³ä¸šåŠ¡çš„éœ€æ±‚ï¼Œæ‰€ä»¥ï¼ŒRedis åœ¨ 3.0 ç‰ˆæœ¬ä»¥åå°±æ¨å‡ºäº†é›†ç¾¤æ¨¡å¼ã€‚</p><p>Redis ä»3.0.0æ­£å¼ç‰ˆå¼€å§‹å®˜æ–¹æ”¯æŒé›†ç¾¤, Redis é›†ç¾¤é‡‡ç”¨äº†P2Pçš„æ¨¡å¼ï¼Œå®Œå…¨å»ä¸­å¿ƒåŒ–ã€‚Redis æŠŠæ‰€æœ‰çš„ Key åˆ†æˆäº† 16384 ä¸ª slotï¼Œæ¯ä¸ª Redis å®ä¾‹è´Ÿè´£å…¶ä¸­ä¸€éƒ¨åˆ† slot ã€‚é›†ç¾¤ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆèŠ‚ç‚¹ã€ç«¯å£ã€slotç­‰ï¼‰ï¼Œéƒ½é€šè¿‡èŠ‚ç‚¹ä¹‹é—´å®šæœŸçš„æ•°æ®äº¤æ¢è€Œæ›´æ–°ã€‚</p><p>Redis å®¢æˆ·ç«¯å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ª Redis å®ä¾‹å‘å‡ºè¯·æ±‚ï¼Œå¦‚æœæ‰€éœ€æ•°æ®ä¸åœ¨è¯¥å®ä¾‹ä¸­ï¼Œé€šè¿‡é‡å®šå‘å‘½ä»¤å¼•å¯¼å®¢æˆ·ç«¯è®¿é—®æ‰€éœ€çš„å®ä¾‹ã€‚</p><h2 id="éšéšä¾¿ä¾¿æ­å»ºä¸€ä¸ªé›†ç¾¤"><a href="#éšéšä¾¿ä¾¿æ­å»ºä¸€ä¸ªé›†ç¾¤" class="headerlink" title="éšéšä¾¿ä¾¿æ­å»ºä¸€ä¸ªé›†ç¾¤"></a>éšéšä¾¿ä¾¿æ­å»ºä¸€ä¸ªé›†ç¾¤</h2><p>å®‰è£…éƒ¨ç½²ä»»ä½•ä¸€ä¸ªåº”ç”¨å…¶å®éƒ½å¾ˆç®€å•ï¼Œåªè¦å®‰è£…æ­¥éª¤ä¸€æ­¥ä¸€æ­¥æ¥å°±è¡Œäº†ã€‚ä¸‹é¢è¯´ä¸€ä¸‹ Redis é›†ç¾¤æ­å»ºè§„åˆ’ï¼Œç”±äºé›†ç¾¤è‡³å°‘éœ€è¦6ä¸ªèŠ‚ç‚¹ï¼ˆ3ä¸»3ä»æ¨¡å¼ï¼‰ï¼Œæ‰€ä»¥ï¼Œæ²¡æœ‰è¿™ä¹ˆå¤šæœºå™¨ç»™æˆ‘ç©ï¼Œç°åœ¨è®¡åˆ’æ˜¯åœ¨ä¸€å°æœºå™¨ä¸Šæ¨¡æ‹Ÿä¸€ä¸ªé›†ç¾¤ï¼Œå½“ç„¶ï¼Œè¿™å’Œç”Ÿäº§ç¯å¢ƒçš„é›†ç¾¤æ­å»ºæ²¡æœ¬è´¨åŒºåˆ«ã€‚</p><h4 id="1-è·å–è½¯ä»¶åŒ…"><a href="#1-è·å–è½¯ä»¶åŒ…" class="headerlink" title="1.è·å–è½¯ä»¶åŒ…"></a>1.è·å–è½¯ä»¶åŒ…</h4><pre><code>cd /tmp/ &amp;&amp; wget http://download.redis.io/releases/redis-4.0.11.tar.gzmkdir /usr/local/redis &amp;&amp; tar -xr /tmp/redis-4.0.11.tar.gz -C /usr/local/rediscd /usr/local/redis./configuremake -j 4make install</code></pre><h4 id="2-è§„åˆ’åˆ›å»ºæ–‡ä»¶ç›®å½•"><a href="#2-è§„åˆ’åˆ›å»ºæ–‡ä»¶ç›®å½•" class="headerlink" title="2.è§„åˆ’åˆ›å»ºæ–‡ä»¶ç›®å½•"></a>2.è§„åˆ’åˆ›å»ºæ–‡ä»¶ç›®å½•</h4><p>æˆ‘ä»¬è®¡åˆ’é›†ç¾¤ä¸­ Redis èŠ‚ç‚¹çš„ç«¯å£å·ä¸º 9001-9006 ï¼Œç«¯å£å·å³é›†ç¾¤ä¸‹å„å®ä¾‹æ–‡ä»¶å¤¹ã€‚æ•°æ®å­˜æ”¾åœ¨ ç«¯å£å·/data æ–‡ä»¶å¤¹ä¸­ã€‚</p><pre><code>mkdir /usr/local/redis-cluster/cd /usr/local/redis-cluster/for i in {1..6};do    mkdir 900${i}/datadone</code></pre><h4 id="3-å¤åˆ¶æ‰§è¡Œè„šæœ¬"><a href="#3-å¤åˆ¶æ‰§è¡Œè„šæœ¬" class="headerlink" title="3. å¤åˆ¶æ‰§è¡Œè„šæœ¬"></a>3. å¤åˆ¶æ‰§è¡Œè„šæœ¬</h4><p>åœ¨ /usr/local/redis-cluster ä¸‹åˆ›å»º bin æ–‡ä»¶å¤¹ï¼Œç”¨æ¥å­˜æ”¾é›†ç¾¤è¿è¡Œè„šæœ¬ï¼Œå¹¶æŠŠå®‰è£…å¥½çš„ Redis çš„ src è·¯å¾„ä¸‹çš„è¿è¡Œè„šæœ¬æ‹·è´è¿‡æ¥ã€‚çœ‹å‘½ä»¤ï¼š</p><pre><code>mkdir /usr/local/redis-cluster/bincd /usr/local/redis/src # ä¸‹è½½åè§£å‹ç¼–è¯‘åçš„srcç›®å½•cp mkreleasehdr.sh redis-benchmark redis-check-aof redis-check-dump redis-cli redis-server redis-trib.rb /usr/local/redis-cluster/bin</code></pre><h4 id="4-å¤åˆ¶ä¸€ä¸ªæ–°-Redis-å®ä¾‹"><a href="#4-å¤åˆ¶ä¸€ä¸ªæ–°-Redis-å®ä¾‹" class="headerlink" title="4.å¤åˆ¶ä¸€ä¸ªæ–° Redis å®ä¾‹"></a>4.å¤åˆ¶ä¸€ä¸ªæ–° Redis å®ä¾‹</h4><p>æˆ‘ä»¬ç°åœ¨ä»å·²å®‰è£…å¥½çš„ Redis ä¸­å¤åˆ¶ä¸€ä¸ªæ–°çš„å®ä¾‹åˆ° 9001 æ–‡ä»¶å¤¹ï¼Œå¹¶ä¿®æ”¹ redis.conf é…ç½®ã€‚</p><pre><code>cp /usr/local/redis/* /usr/local/redis-cluster/9001port 9001ï¼ˆæ¯ä¸ªèŠ‚ç‚¹çš„ç«¯å£å·ï¼‰daemonize yesbind 192.168.56.127ï¼ˆç»‘å®šå½“å‰æœºå™¨ IPï¼‰dir /usr/local/redis-cluster/9001/data/ï¼ˆæ•°æ®æ–‡ä»¶å­˜æ”¾ä½ç½®ï¼‰pidfile /var/run/redis_9001.pidï¼ˆpid 9001å’Œportè¦å¯¹åº”ï¼‰cluster-enabled yesï¼ˆå¯åŠ¨é›†ç¾¤æ¨¡å¼ï¼‰cluster-config-file nodes9001.confï¼ˆ9001å’Œportè¦å¯¹åº”ï¼‰cluster-node-timeout 15000appendonly yes</code></pre><h4 id="5-å†å¤åˆ¶å‡ºäº”ä¸ªæ–°-Redis-å®ä¾‹"><a href="#5-å†å¤åˆ¶å‡ºäº”ä¸ªæ–°-Redis-å®ä¾‹" class="headerlink" title="5.å†å¤åˆ¶å‡ºäº”ä¸ªæ–° Redis å®ä¾‹"></a>5.å†å¤åˆ¶å‡ºäº”ä¸ªæ–° Redis å®ä¾‹</h4><p>æˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸€ä¸ªèŠ‚ç‚¹äº†ï¼Œå…¶å®æ¥ä¸‹æ¥å°±æ˜¯æœºæ¢°åŒ–çš„å†å®Œæˆå¦å¤–äº”ä¸ªèŠ‚ç‚¹ï¼Œå…¶å®å¯ä»¥è¿™ä¹ˆåšï¼šæŠŠ 9001 å®ä¾‹ å¤åˆ¶åˆ°å¦å¤–äº”ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œå”¯ä¸€è¦ä¿®æ”¹çš„å°±æ˜¯ redis.conf ä¸­çš„æ‰€æœ‰å’Œç«¯å£çš„ç›¸å…³çš„ä¿¡æ¯å³å¯ï¼Œå…¶å®å°±é‚£ä¹ˆå››ä¸ªä½ç½®ã€‚å¼€å§‹æ“ä½œï¼Œçœ‹å‘½ä»¤ï¼š</p><pre><code>\cp -rf /usr/local/redis-cluster/9001/* /usr/local/redis-cluster/9002\cp -rf /usr/local/redis-cluster/9001/* /usr/local/redis-cluster/9003\cp -rf /usr/local/redis-cluster/9001/* /usr/local/redis-cluster/9004\cp -rf /usr/local/redis-cluster/9001/* /usr/local/redis-cluster/9005\cp -rf /usr/local/redis-cluster/9001/* /usr/local/redis-cluster/9006</code></pre><p>è¿™é‡Œæˆ‘ä»¬æŠŠé…ç½®å¤åˆ¶è¿‡å»ä¹‹åéœ€è¦ä¿®æ”¹å¯¹åº”æ–‡ä»¶å¤¹ä¸­çš„redis.conf ç”¨sedæˆ–è€…vimå…¨å±€æ›¿æ¢å³å¯ï¼Œä¸»è¦æ˜¯ç«¯å£</p><p>ä¸‹é¢ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å¯åŠ¨å®ƒä»¬</p><pre><code>for i in {1..6};do    /usr/local/bin/redis-server /usr/local/redis-cluster/900${i}/redis.conf done[root@localhost redis-cluster]# ps aux | grep redis | grep -v greproot       3995  0.5  0.6 151404 11864 ?        Ssl  10:51   0:10 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9001 [cluster]root       4000  0.4  0.6 151404 11856 ?        Ssl  10:51   0:09 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9002 [cluster]root       4005  0.4  0.6 151404 11856 ?        Ssl  10:51   0:09 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9003 [cluster]root       4010  0.1  0.6 151404 11872 ?        Ssl  10:51   0:02 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9004 [cluster]root       4015  0.0  0.6 151404 11876 ?        Ssl  10:51   0:01 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9005 [cluster]root       4020  0.0  0.6 151404 11872 ?        Ssl  10:51   0:01 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9006 [cluster]root       4509  0.8  0.6 149356 11880 ?        Ssl  10:55   0:14 /usr/local/redis-cluster/bin/redis-server [root@localhost redis-cluster]#</code></pre><p>ä»¥ä¸Š å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„6ä¸ªå®ä¾‹å·²ç»å¯åŠ¨äº†<br>æµ‹è¯•ä¸€ä¸‹ï¼Ÿ</p><p>éšä¾¿æ‰¾ä¸ªèŠ‚ç‚¹æµ‹è¯•ä¸€ä¸‹:</p><pre><code>/usr/local/redis-cluster/bin/redis-cli -h 192.168.56.127 -p 9001192.168.56.127:9001&gt; set name guomaoqiu(error) CLUSTERDOWN Hash slot not served192.168.56.127:9001&gt;</code></pre><p>è¿æ¥æˆåŠŸäº†ï¼Œä½†å¥½åƒæŠ¥é”™äº†</p><p>è¿™æ˜¯å› ä¸ºè™½ç„¶æˆ‘ä»¬é…ç½®å¹¶å¯åŠ¨äº† Redis é›†ç¾¤æœåŠ¡ï¼Œä½†æ˜¯ä»–ä»¬æš‚æ—¶è¿˜å¹¶ä¸åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œäº’ç›¸ç›´æ¥å‘ç°ä¸äº†ï¼Œè€Œä¸”è¿˜æ²¡æœ‰å¯å­˜å‚¨çš„ä½ç½®ï¼Œå°±æ˜¯æ‰€è°“çš„slotï¼ˆæ§½ï¼‰ã€‚</p><h4 id="6-å®‰è£…é›†ç¾¤æ‰€éœ€è½¯ä»¶"><a href="#6-å®‰è£…é›†ç¾¤æ‰€éœ€è½¯ä»¶" class="headerlink" title="6.å®‰è£…é›†ç¾¤æ‰€éœ€è½¯ä»¶"></a>6.å®‰è£…é›†ç¾¤æ‰€éœ€è½¯ä»¶</h4><p>ç”±äº Redis é›†ç¾¤éœ€è¦ä½¿ç”¨ ruby å‘½ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®‰è£… ruby å’Œç›¸å…³æ¥å£ã€‚</p><pre><code>å®‰è£…rediséœ€è¦rubyç‰ˆæœ¬æœ€ä½æ˜¯2.2.2ï¼Œè€Œcentos yumåº“ä¸­rubyç‰ˆæœ¬æ”¯æŒåˆ°2.0.0ã€‚æ‰€ä»¥ï¼Œæ— æ³•æ»¡è¶³éœ€æ±‚ã€‚è§£å†³æ–¹æ¡ˆï¼š1.å®‰è£…curlsudo yum install curl2.å®‰è£…RVMcurl -L get.rvm.io | bash -s stablesource /usr/local/rvm/scripts/rvm3.æŸ¥çœ‹rvmåº“ä¸­å·²çŸ¥çš„rubyç‰ˆæœ¬rvm list known4.å®‰è£…ä¸€ä¸ªrubyç‰ˆæœ¬rvm install 2.3.35.è®¾ç½®é»˜è®¤ç‰ˆæœ¬rvm use 2.3.36.å¸è½½ä¸€ä¸ªå·²çŸ¥ç‰ˆæœ¬rvm remove 2.0.07.æŸ¥çœ‹rubyç‰ˆæœ¬ruby â€“version8.å†å®‰è£…rediså°±å¯ä»¥äº†gem install redis</code></pre><h4 id="7-åˆ©ç”¨å®˜æ–¹æä¾›çš„å‘½ä»¤åˆ›å»ºé›†ç¾¤"><a href="#7-åˆ©ç”¨å®˜æ–¹æä¾›çš„å‘½ä»¤åˆ›å»ºé›†ç¾¤" class="headerlink" title="7. åˆ©ç”¨å®˜æ–¹æä¾›çš„å‘½ä»¤åˆ›å»ºé›†ç¾¤"></a>7. åˆ©ç”¨å®˜æ–¹æä¾›çš„å‘½ä»¤åˆ›å»ºé›†ç¾¤</h4><pre><code>/usr/local/redis-cluster/bin/redis-trib.rb create --replicas 1 192.168.56.127:9001 192.168.56.127:9002 192.168.56.127:9003 192.168.56.127:9004 192.168.56.127:9005 192.168.56.127:9006</code></pre><p>ç®€å•è§£é‡Šä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ï¼šè°ƒç”¨ ruby å‘½ä»¤æ¥è¿›è¡Œåˆ›å»ºé›†ç¾¤ï¼Œâ€“replicas 1 è¡¨ç¤ºä¸»ä»å¤åˆ¶æ¯”ä¾‹ä¸º 1:1ï¼Œå³ä¸€ä¸ªä¸»èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªä»èŠ‚ç‚¹ï¼›ç„¶åï¼Œé»˜è®¤ç»™æˆ‘ä»¬åˆ†é…å¥½äº†æ¯ä¸ªä¸»èŠ‚ç‚¹å’Œå¯¹åº”ä»èŠ‚ç‚¹æœåŠ¡ï¼Œä»¥åŠ solt çš„å¤§å°ï¼Œå› ä¸ºåœ¨ Redis é›†ç¾¤ä¸­æœ‰ä¸”ä»…æœ‰ 16383 ä¸ª solt ï¼Œé»˜è®¤æƒ…å†µä¼šç»™æˆ‘ä»¬å¹³å‡åˆ†é…ï¼Œå½“ç„¶ä½ å¯ä»¥æŒ‡å®šï¼Œåç»­çš„å¢å‡èŠ‚ç‚¹ä¹Ÿå¯ä»¥é‡æ–°åˆ†é…ã€‚</p><pre><code>[root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb create --replicas 1 192.168.56.127:9001 192.168.56.127:9002 192.168.56.127:9003 192.168.56.127:9004 192.168.56.127:9005 192.168.56.127:9006&gt;&gt;&gt; Creating cluster&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...Using 3 masters:# ä¸‰ä¸ªä¸»èŠ‚ç‚¹192.168.56.127:9001192.168.56.127:9002192.168.56.127:9003# ä¸‰ä¸ªä¸»èŠ‚ç‚¹å¯¹åº”ä¸‰ä¸ªä»èŠ‚ç‚¹Adding replica 192.168.56.127:9005 to 192.168.56.127:9001Adding replica 192.168.56.127:9006 to 192.168.56.127:9002Adding replica 192.168.56.127:9004 to 192.168.56.127:9003&gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity[WARNING] Some slaves are in the same host as their masterM: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001   slots:0-5460 (5461 slots) masterM: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002   slots:5461-10922 (5462 slots) masterM: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003   slots:10923-16383 (5461 slots) masterS: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004   replicates 474fd53f7199ad70cce7f18bd68f5445b559509aS: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005   replicates e070e76789352d2492cfc9800850e943e0c4b72dS: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006   replicates 0fcbaa301451baf87284546513003568e47b5daaCan I set the above configuration? (type 'yes' to accept): yes&gt;&gt;&gt; Nodes configuration updated&gt;&gt;&gt; Assign a different config epoch to each node&gt;&gt;&gt; Sending CLUSTER MEET messages to join the clusterWaiting for the cluster to join...&gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001)M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001   slots:0-5460 (5461 slots) master   1 additional replica(s)M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002   slots:5461-10922 (5462 slots) master   1 additional replica(s)M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003   slots:10923-16383 (5461 slots) master   1 additional replica(s)S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006   slots: (0 slots) slave   replicates 0fcbaa301451baf87284546513003568e47b5daaS: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004   slots: (0 slots) slave   replicates 474fd53f7199ad70cce7f18bd68f5445b559509aS: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005   slots: (0 slots) slave   replicates e070e76789352d2492cfc9800850e943e0c4b72d[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.</code></pre><p>ä»¥ä¸Šæ‰§è¡Œç»“æœä»£è¡¨é›†ç¾¤æ­å»ºæˆåŠŸå•¦ï¼ï¼ï¼</p><p>éªŒè¯ï¼š</p><pre><code>/usr/local/redis-cluster/bin/redis-cli -c -h 192.168.56.127 -p 9001192.168.56.127:9001&gt; cluster infocluster_state:okcluster_slots_assigned:16384cluster_slots_ok:16384cluster_slots_pfail:0cluster_slots_fail:0cluster_known_nodes:6cluster_size:3cluster_current_epoch:6cluster_my_epoch:1cluster_stats_messages_ping_sent:167cluster_stats_messages_pong_sent:172cluster_stats_messages_sent:339cluster_stats_messages_ping_received:167cluster_stats_messages_pong_received:167cluster_stats_messages_meet_received:5cluster_stats_messages_received:339192.168.56.127:9001&gt; cluster nodes474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002@19002 master - 0 1536205294229 2 connected 5461-10922e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003@19003 master - 0 1536205293000 3 connected 10923-16383bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006@19006 slave 0fcbaa301451baf87284546513003568e47b5daa 0 1536205295234 6 connected0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001@19001 myself,master - 0 1536205294000 1 connected 0-5460950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004@19004 slave 474fd53f7199ad70cce7f18bd68f5445b559509a 0 1536205293217 4 connected17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005@19005 slave e070e76789352d2492cfc9800850e943e0c4b72d 0 1536205292212 5 connected192.168.56.127:9001&gt; set name guomaoqiu-&gt; Redirected to slot [5798] located at 192.168.56.127:9002OK192.168.56.127:9002&gt; get name"guomaoqiu"192.168.56.127:9002&gt;</code></pre><p>é€šè¿‡å‘½ä»¤ï¼Œå¯ä»¥è¯¦ç»†çš„çœ‹å‡ºé›†ç¾¤ä¿¡æ¯å’Œå„ä¸ªèŠ‚ç‚¹çŠ¶æ€ï¼Œä¸»ä»ä¿¡æ¯ä»¥åŠè¿æ¥æ•°ã€æ§½ä¿¡æ¯ç­‰ã€‚è¿™ä¹ˆçœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»çœŸçš„æŠŠ Redis é›†ç¾¤æ­å»ºéƒ¨ç½²æˆåŠŸå•¦ï¼</p><h2 id="å¦‚ä½•æ–°å¢èŠ‚ç‚¹ï¼Ÿ"><a href="#å¦‚ä½•æ–°å¢èŠ‚ç‚¹ï¼Ÿ" class="headerlink" title="å¦‚ä½•æ–°å¢èŠ‚ç‚¹ï¼Ÿ"></a>å¦‚ä½•æ–°å¢èŠ‚ç‚¹ï¼Ÿ</h2><p>æ–°å¢èŠ‚ç‚¹æ— éå°±æ˜¯å¤åˆ¶é…ç½®ï¼Œä¿®æ”¹é…ç½®ï¼Œç„¶åå¯åŠ¨ï¼›æˆ‘è¿™é‡Œè¿˜æ˜¯åˆ›å»ºäº†ä¸€å¯¹ä¸€ä¸»ä¸€ä»çš„é…ç½®ï¼Œç«¯å£åˆ†åˆ«å¯¹åº”çš„æ˜¯9007ã€9008</p><h4 id="1-å¯åŠ¨ä¸¤ä¸ªå®ä¾‹-å‡è®¾æˆ‘è¿™é‡Œå·²ç»å¤åˆ¶é…ç½®ï¼Œä¿®æ”¹å®Œé…ç½®äº†"><a href="#1-å¯åŠ¨ä¸¤ä¸ªå®ä¾‹-å‡è®¾æˆ‘è¿™é‡Œå·²ç»å¤åˆ¶é…ç½®ï¼Œä¿®æ”¹å®Œé…ç½®äº†" class="headerlink" title="1.å¯åŠ¨ä¸¤ä¸ªå®ä¾‹(å‡è®¾æˆ‘è¿™é‡Œå·²ç»å¤åˆ¶é…ç½®ï¼Œä¿®æ”¹å®Œé…ç½®äº†)"></a>1.å¯åŠ¨ä¸¤ä¸ªå®ä¾‹(å‡è®¾æˆ‘è¿™é‡Œå·²ç»å¤åˆ¶é…ç½®ï¼Œä¿®æ”¹å®Œé…ç½®äº†)</h4><pre><code>for i in {7..8};do    /usr/local/redis-cluster/bin/redis-server /usr/local/redis-cluster/900${i}/redis.conf done6002:C 06 Sep 11:50:53.048 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo6002:C 06 Sep 11:50:53.048 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=6002, just started6002:C 06 Sep 11:50:53.048 # Configuration loaded6004:C 06 Sep 11:50:53.060 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo6004:C 06 Sep 11:50:53.060 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=6004, just started6004:C 06 Sep 11:50:53.060 # Configuration loadedps aux | grep redis | grep -v grepredis      1180  0.0  0.3 142900  5828 ?        Ssl  11:28   0:01 /usr/bin/redis-server 0.0.0.0:6379root       4257  0.0  0.6 149356 11880 ?        Ssl  11:32   0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9001 [cluster]root       4262  0.0  0.6 149356 11880 ?        Ssl  11:32   0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9002 [cluster]root       4267  0.0  0.6 149356 11876 ?        Ssl  11:32   0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9003 [cluster]root       4272  0.0  0.6 149356 11908 ?        Ssl  11:32   0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9004 [cluster]root       4277  0.0  0.6 149356 11920 ?        Ssl  11:32   0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9005 [cluster]root       4282  0.0  0.6 149356 11912 ?        Ssl  11:32   0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9006 [cluster]root       6003  0.1  0.5 147308  9616 ?        Ssl  11:50   0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9007 [cluster]root       6008  0.0  0.5 147308  9616 ?        Ssl  11:50   0:00 /usr/local/redis-cluster/bin/redis-server 192.168.56.127:9008 [cluster]</code></pre><p>ä»¥ä¸Š å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¯åŠ¨äº†åé¢ä¸¤ä¸ªå®ä¾‹ï¼Œå¹¶ä¸”è¿›ç¨‹ä¸­æ ‡æ³¨äº†æ˜¯ä»¥é›†ç¾¤æ–¹å¼å¯åŠ¨, ä½†æ˜¯æ­¤æ—¶è¿˜å¹¶æ²¡æœ‰å°†å®ä¾‹åŠ å…¥åˆ°é›†ç¾¤å½“ä¸­ã€‚</p><h4 id="2-æ·»åŠ å®ä¾‹åˆ°é›†ç¾¤"><a href="#2-æ·»åŠ å®ä¾‹åˆ°é›†ç¾¤" class="headerlink" title="2.æ·»åŠ å®ä¾‹åˆ°é›†ç¾¤"></a>2.æ·»åŠ å®ä¾‹åˆ°é›†ç¾¤</h4><pre><code>[root@locahost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb add-node 192.168.56.127:9007 192.168.56.127:9001&gt;&gt;&gt; Adding node 192.168.56.127:9007 to cluster 192.168.56.127:9001&gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001)M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001   slots:0-5460 (5461 slots) master   1 additional replica(s)M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002   slots:5461-10922 (5462 slots) master   1 additional replica(s)M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003   slots:10923-16383 (5461 slots) master   1 additional replica(s)S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006   slots: (0 slots) slave   replicates 0fcbaa301451baf87284546513003568e47b5daaS: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004   slots: (0 slots) slave   replicates 474fd53f7199ad70cce7f18bd68f5445b559509aS: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005   slots: (0 slots) slave   replicates e070e76789352d2492cfc9800850e943e0c4b72d[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.&gt;&gt;&gt; Send CLUSTER MEET to node 192.168.56.127:9007 to make it join the cluster.[OK] New node added correctly.[root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-cli -c -h 192.168.56.127 -p 9001 cluster nodes474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002@19002 master - 0 1536215194000 2 connected 5461-10922e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003@19003 master - 0 1536215194000 3 connected 10923-16383bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006@19006 slave 0fcbaa301451baf87284546513003568e47b5daa 0 1536215193000 6 connected0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001@19001 myself,master - 0 1536215192000 1 connected 0-5460950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004@19004 slave 474fd53f7199ad70cce7f18bd68f5445b559509a 0 1536215195858 4 connected1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007@19007 master - 0 1536215195000 0 connected17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005@19005 slave e070e76789352d2492cfc9800850e943e0c4b72d 0 1536215194855 5 connected</code></pre><p>ä»¥ä¸Šå¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡ add-node å‚æ•°æ·»åŠ äº† 9007è¿™ä¸ªå®ä¾‹ï¼›å‘½ä»¤æœ€åä¸€ä¸ªå‚æ•°æ˜¯å·²ç»æˆä¸ºé›†ç¾¤çš„é›†ç¾¤æˆå‘˜host:port<br>è€Œä¸”å®ä¾‹9007è·å¾—äº†ä¸€ä¸ªé›†ç¾¤ID:<code>1714784542b3afc9e2a8b2c93fff49d095e7d72b</code></p><h4 id="5-å¢åŠ å®ä¾‹çš„ä»èŠ‚ç‚¹åˆ°é›†ç¾¤"><a href="#5-å¢åŠ å®ä¾‹çš„ä»èŠ‚ç‚¹åˆ°é›†ç¾¤" class="headerlink" title="5. å¢åŠ å®ä¾‹çš„ä»èŠ‚ç‚¹åˆ°é›†ç¾¤"></a>5. å¢åŠ å®ä¾‹çš„ä»èŠ‚ç‚¹åˆ°é›†ç¾¤</h4><p>ä»¥ä¸Šæˆ‘ä»¬å°†å®ä¾‹9007ä½œä¸ºmasterå¢åŠ åˆ°äº†é›†ç¾¤ä¸­ï¼Œä½†æ˜¯æŒ‰ç…§å‰é¢çš„è§„åˆ’ï¼Œæ¯ä¸ªmasterå¯¹åº”ä¸€ä¸ªslaveæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å®ä¾‹9008åŠ å…¥é›†ç¾¤å¹¶å°†å…¶ç§°ä¸º9007çš„slave,å‘½ä»¤å¦‚ä¸‹</p><pre><code>[root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb add-node --slave --master-id 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9008 192.168.56.127:9001&gt;&gt;&gt; Adding node 192.168.56.127:9008 to cluster 192.168.56.127:9001&gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001)M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001   slots:0-5460 (5461 slots) master   1 additional replica(s)M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002   slots:5461-10922 (5462 slots) master   1 additional replica(s)M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003   slots:10923-16383 (5461 slots) master   1 additional replica(s)S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006   slots: (0 slots) slave   replicates 0fcbaa301451baf87284546513003568e47b5daaS: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004   slots: (0 slots) slave   replicates 474fd53f7199ad70cce7f18bd68f5445b559509aM: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007   slots: (0 slots) master   0 additional replica(s)S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005   slots: (0 slots) slave   replicates e070e76789352d2492cfc9800850e943e0c4b72d[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.&gt;&gt;&gt; Send CLUSTER MEET to node 192.168.56.127:9008 to make it join the cluster.Waiting for the cluster to join.&gt;&gt;&gt; Configure node as replica of 192.168.56.127:9007.[OK] New node added correctly.[root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb check 192.168.56.127:9001&gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001)M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001   slots:0-5460 (5461 slots) master   1 additional replica(s)M: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002   slots:5461-10922 (5462 slots) master   1 additional replica(s)M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003   slots:10923-16383 (5461 slots) master   1 additional replica(s)S: 5ed978b695e6a222e67d13c68e55f6c4e74b7ba6 192.168.56.127:9008   slots: (0 slots) slave   replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72bS: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006   slots: (0 slots) slave   replicates 0fcbaa301451baf87284546513003568e47b5daaS: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004   slots: (0 slots) slave   replicates 474fd53f7199ad70cce7f18bd68f5445b559509aM: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007   slots: (0 slots) master   1 additional replica(s)S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005   slots: (0 slots) slave   replicates e070e76789352d2492cfc9800850e943e0c4b72d[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.</code></pre><p>ä»¥ä¸Šæˆ‘ä»¬å°†ä¸¤ä¸ªèŠ‚ç‚¹åŠ å…¥åˆ°äº†é›†ç¾¤ä¸­ï¼Œä½†æ˜¯ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°æˆ‘ä»¬çš„å®ä¾‹9007æ‰€æ‹¥æœ‰çš„slotæ•°é‡ä¸º0ï¼Œé‚£æ­¤æ—¶å°±éœ€è¦å°†é‡æ–°è°ƒæ•´å“ˆå¸Œæ§½å•¦~<br>å†æ¬¡ä¹‹å‰æˆ‘ä»¬ä¸‰ä¸ªmaster å¹³å‡å°†16384 åˆ†æˆäº†ä¸‰ç­‰åˆ†ï¼Œé‚£æˆ‘ä»¬æ–°å¢åŠ äº†ä¸€ä¸ªmaster ï¼Œä¸ºäº†å¹³è¡¡æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºè¿™ä¸ªæ–°çš„masteréœ€è¦å¤šå°‘å“ˆå¸Œæ§½ï¼Œå³ 16384/4 = 4096 æˆ‘ä»¬éœ€è¦ç§»åŠ¨4096ä¸ªæ§½ç‚¹åˆ°9007ä¸Šã€‚</p><pre><code>[root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb reshard 192.168.56.127:9001&gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001)M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001   slots:0-5460 (5461 slots) master   1 additional replica(s)S: 5ed978b695e6a222e67d13c68e55f6c4e74b7ba6 192.168.56.127:9008   slots: (0 slots) slave   replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72bM: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007   slots:5461-5798 (0 slots) master   1 additional replica(s)S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005   slots: (0 slots) slave   replicates e070e76789352d2492cfc9800850e943e0c4b72dM: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002   slots:5799-10922 (5462 slots) master   1 additional replica(s)M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003   slots:10923-16383 (5461 slots) master   1 additional replica(s)S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006   slots: (0 slots) slave   replicates 0fcbaa301451baf87284546513003568e47b5daaS: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004   slots: (0 slots) slave   replicates 474fd53f7199ad70cce7f18bd68f5445b559509a[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.# è¿™é‡Œéœ€è¦è¾“å…¥æˆ‘ä»¬æ‰€éœ€è¦çš„å“ˆå¸Œæ§½How many slots do you want to move (from 1 to 16384)? 4097# è¿™é‡Œéœ€è¦è¾“å…¥æˆ‘ä»¬å®ä¾‹9007çš„IDWhat is the receiving node ID? 1714784542b3afc9e2a8b2c93fff49d095e7d72bPlease enter all the source node IDs.  Type 'all' to use all the nodes as source nodes for the hash slots.  Type 'done' once you entered all the source nodes IDs.Source node #1:all#è¾“å…¥all è¡¨ç¤ºä»æ‰€æœ‰çš„ä¸»èŠ‚ç‚¹ä¸­éšæœºè½¬ç§»ï¼Œå‡‘å¤Ÿ1000ä¸ªå“ˆå¸Œæ§½#ç„¶åå†è¾“å…¥yesï¼Œredisé›†ç¾¤å°±å¼€å§‹åˆ†é…å“ˆå¸Œæ§½äº†ã€‚</code></pre><p>ä»¥ä¸Š:<br>redis-trib ä¼šå‘ä½ è¯¢é—®é‡æ–°åˆ†ç‰‡çš„æºèŠ‚ç‚¹ï¼ˆsource nodeï¼‰ï¼Œå³ï¼Œè¦ä»ç‰¹ç‚¹çš„å“ªä¸ªèŠ‚ç‚¹ä¸­å–å‡º 4096 ä¸ªå“ˆå¸Œæ§½ï¼Œè¿˜æ˜¯ä»å…¨éƒ¨èŠ‚ç‚¹æå–4096ä¸ªå“ˆå¸Œæ§½ï¼Œ å¹¶å°†è¿™äº›æ§½ç§»åŠ¨åˆ°9007èŠ‚ç‚¹ä¸Šé¢ã€‚</p><p>å¦‚æœæˆ‘ä»¬ä¸æ‰“ç®—ä»ç‰¹å®šçš„èŠ‚ç‚¹ä¸Šå–å‡ºæŒ‡å®šæ•°é‡çš„å“ˆå¸Œæ§½ï¼Œé‚£ä¹ˆå¯ä»¥å‘redis-tribè¾“å…¥ allï¼Œè¿™æ ·çš„è¯ï¼Œ é›†ç¾¤ä¸­çš„æ‰€æœ‰ä¸»èŠ‚ç‚¹éƒ½ä¼šæˆä¸ºæºèŠ‚ç‚¹ï¼Œredis-tribä»å„ä¸ªæºèŠ‚ç‚¹ä¸­å„å–å‡ºä¸€éƒ¨åˆ†å“ˆå¸Œæ§½ï¼Œå‡‘å¤Ÿ4096ä¸ªï¼Œç„¶åç§»åŠ¨åˆ°9007èŠ‚ç‚¹ä¸Šï¼š</p><p>éªŒè¯ï¼š</p><pre><code>[root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb check 192.168.56.127:9001&gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001)M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001   slots:1280-5460 (4096 slots) master   1 additional replica(s)S: 5ed978b695e6a222e67d13c68e55f6c4e74b7ba6 192.168.56.127:9008   slots: (0 slots) slave   replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72bM: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007   slots:0-1279,5461-6998,10923-12201 (4096 slots) master   1 additional replica(s)S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005   slots: (0 slots) slave   replicates e070e76789352d2492cfc9800850e943e0c4b72dM: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002   slots:6999-10922 (4096 slots) master   1 additional replica(s)M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003   slots:12202-16383 (4096 slots) master   1 additional replica(s)S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006   slots: (0 slots) slave   replicates 0fcbaa301451baf87284546513003568e47b5daaS: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004   slots: (0 slots) slave   replicates 474fd53f7199ad70cce7f18bd68f5445b559509a[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.</code></pre><p>ä»¥ä¸Šæˆ‘ä»¬çš„é›†ç¾¤æ­å»ºä»¥åŠæ–°å¢èŠ‚ç‚¹å°±å®Œæˆäº†ï¼›</p><h4 id="6-ä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹"><a href="#6-ä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="6. ä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹:"></a>6. ä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹:</h4><p>å’ŒèŠ‚ç‚¹æ·»åŠ ä¸€æ ·ï¼Œç§»é™¤èŠ‚ç‚¹ä¹Ÿæœ‰ç§»é™¤ä¸»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹</p><h5 id="1ã€ç§»é™¤ä¸»èŠ‚ç‚¹"><a href="#1ã€ç§»é™¤ä¸»èŠ‚ç‚¹" class="headerlink" title="1ã€ç§»é™¤ä¸»èŠ‚ç‚¹"></a>1ã€ç§»é™¤ä¸»èŠ‚ç‚¹</h5><p>ç§»é™¤èŠ‚ç‚¹ä½¿ç”¨redis-tribçš„del-nodeå‘½ä»¤</p><pre><code>/usr/local/redis-cluster/bin/redis-trib.rb del-node 192.168.56.127:9001 ${node-id}</code></pre><p>192.168.56.127:9001å…¶ä¸­ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹ï¼Œnode-idä¸ºè¦åˆ é™¤çš„ä¸»èŠ‚ç‚¹,è¿™é‡Œå’Œæ·»åŠ èŠ‚ç‚¹ä¸åŒ,ç§»é™¤èŠ‚ç‚¹node-idæ˜¯å¿…éœ€çš„ï¼Œæµ‹è¯•åˆ é™¤9003ä¸»èŠ‚ç‚¹</p><pre><code>[root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb del-node 192.168.56.127:9001 e070e76789352d2492cfc9800850e943e0c4b72d&gt;&gt;&gt; Removing node e070e76789352d2492cfc9800850e943e0c4b72d from cluster 192.168.56.127:9001[ERR] Node 192.168.56.127:9003 is not empty! Reshard data away and try again.</code></pre><p>redis clusteræç¤º9003å·²ç»æœ‰æ•°æ®äº†ï¼Œä¸èƒ½å¤Ÿè¢«åˆ é™¤ï¼Œéœ€è¦å°†ä»–çš„æ•°æ®è½¬ç§»å‡ºå»ï¼Œä¹Ÿå°±æ˜¯å’Œæ–°å¢ä¸»èŠ‚ç‚¹ä¸€æ ·éœ€é‡æ–°åˆ†ç‰‡ã€‚</p><pre><code>/usr/local/redis-cluster/bin/redis-trib.rb reshard 192.168.56.127:9001</code></pre><p>æ‰§è¡Œä»¥åä¼šæç¤ºæˆ‘ä»¬ç§»é™¤çš„å¤§å°ï¼Œå› ä¸º9003å ç”¨äº†4096ä¸ªæ§½ç‚¹</p><pre><code>&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.How many slots do you want to move (from 1 to 16384)?</code></pre><p>è¾“å…¥4096<br>æç¤ºç§»åŠ¨çš„node idï¼Œå¡«å†™9007çš„node idã€‚</p><pre><code>&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.How many slots do you want to move (from 1 to 16384)? 4182What is the receiving node ID? 1714784542b3afc9e2a8b2c93fff49d095e7d72b</code></pre><p>éœ€è¦ç§»åŠ¨åˆ°å…¨éƒ¨ä¸»èŠ‚ç‚¹ä¸Šè¿˜æ˜¯å•ä¸ªä¸»èŠ‚ç‚¹</p><pre><code>Please enter all the source node IDs.  Type 'all' to use all the nodes as source nodes for the hash slots.  Type 'done' once you entered all the source nodes IDs.Source node #1:</code></pre><p>å°†4096ä¸ªæ§½ç‚¹ç§»åŠ¨åˆ°9007ä¸Šï¼Œå¡«å†™9003çš„node id ï¼še070e76789352d2492cfc9800850e943e0c4b72d</p><pre><code>Source node #1:e070e76789352d2492cfc9800850e943e0c4b72dSource node #2:done</code></pre><p>ç¡®è®¤ä¹‹åä¼šä¸€ä¸ªä¸€ä¸ªå°†9003çš„å¡æ§½ç§»åˆ°åˆ°9007ä¸Šã€‚</p><pre><code>[root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb check 192.168.56.127:9001&gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001)M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001   slots:1280-5460 (4096 slots) master   1 additional replica(s)S: 5ed978b695e6a222e67d13c68e55f6c4e74b7ba6 192.168.56.127:9008   slots: (0 slots) slave   replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72bM: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007   slots:0-1279,5461-6998,10923-16383 (8192 slots) master   2 additional replica(s)S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005   slots: (0 slots) slave   replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72bM: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002   slots:6999-10922 (4096 slots) master   1 additional replica(s)M: e070e76789352d2492cfc9800850e943e0c4b72d 192.168.56.127:9003   slots: (0 slots) master   0 additional replica(s)S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006   slots: (0 slots) slave   replicates 0fcbaa301451baf87284546513003568e47b5daaS: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004   slots: (0 slots) slave   replicates 474fd53f7199ad70cce7f18bd68f5445b559509a[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.</code></pre><p>ä»¥ä¸Šæˆ‘ä»¬å°†å®ä¾‹9003çš„å“ˆå¸Œæ§½å…¨éƒ¨è½¬ç§»åˆ°äº†9007ï¼Œå·²ç»ä¸º0 ,æ­¤æ—¶å†æ¥åˆ é™¤æˆ‘ä»¬çš„èŠ‚ç‚¹å°±è¡Œäº†~</p><pre><code>[root@localhost redis-cluster]# /usr/local/redis-cluster/bin/redis-trib.rb del-node 192.168.56.127:9001 e070e76789352d2492cfc9800850e943e0c4b72d&gt;&gt;&gt; Removing node e070e76789352d2492cfc9800850e943e0c4b72d from cluster 192.168.56.127:9001&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...&gt;&gt;&gt; SHUTDOWN the node.# çœ‹ä¸‹é¢ç»“æœ æ‰§è¡Œå®Œdel-node 9003èŠ‚ç‚¹å°±å·²ç»ä»é›†ç¾¤ä¸­å‰”é™¤å•¦~ğŸ˜&gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.127:9001)M: 0fcbaa301451baf87284546513003568e47b5daa 192.168.56.127:9001   slots:1280-5460 (4096 slots) master   1 additional replica(s)S: 5ed978b695e6a222e67d13c68e55f6c4e74b7ba6 192.168.56.127:9008   slots: (0 slots) slave   replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72bM: 1714784542b3afc9e2a8b2c93fff49d095e7d72b 192.168.56.127:9007   slots:0-1279,5461-6998,10923-16383 (8192 slots) master   2 additional replica(s)S: 17db098db9fd222df002e649506f88efcdc83633 192.168.56.127:9005   slots: (0 slots) slave   replicates 1714784542b3afc9e2a8b2c93fff49d095e7d72bM: 474fd53f7199ad70cce7f18bd68f5445b559509a 192.168.56.127:9002   slots:6999-10922 (4096 slots) master   1 additional replica(s)S: bd278fcea63862199e964a6aab2e786710cf5575 192.168.56.127:9006   slots: (0 slots) slave   replicates 0fcbaa301451baf87284546513003568e47b5daaS: 950c399165439660efb6ff2f907f938e213de530 192.168.56.127:9004   slots: (0 slots) slave   replicates 474fd53f7199ad70cce7f18bd68f5445b559509a[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.</code></pre><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å½“ç„¶æˆ‘ä»¬é›†ç¾¤æ­å»ºå·²ç»å®Œæˆï¼Œé‚£é›†ç¾¤çš„ä½œç”¨æ˜¯ä¸ºäº†è§£å†³åˆ†ç‰‡çš„é—®é¢˜ï¼Œå¦‚æœéœ€è¦æ­å»ºé«˜å¯ç”¨é›†ç¾¤ï¼›ä¹Ÿå°±æ˜¯ä¸»çš„å¤±è´¥åä»çš„èƒ½å¤Ÿåˆ‡æ¢è§’è‰²,<br>æ‰€ä»¥å¯ä»¥ä½¿ç”¨å“¨å…µæœºåˆ¶æ¥è§£å†³HA.<br>sentinelå’Œclusterä¸»è¦åŒºåˆ«ï¼Œsentinelç”¨æ¥è§£å†³HAï¼ˆé«˜å¯ç”¨ï¼‰é—®é¢˜ï¼Œè€Œclusterä¸»è¦è§£å†³shardingï¼ˆåˆ†ç‰‡ï¼‰é—®é¢˜ã€‚ä¸¤ä¸ªç»å¸¸ç»“åˆä½¿ç”¨æ­å»ºé«˜å¯ç”¨é›†ç¾¤ã€‚</p><h2 id="å…³äºå“ˆå¸Œæ§½çš„æ¦‚å¿µï¼š"><a href="#å…³äºå“ˆå¸Œæ§½çš„æ¦‚å¿µï¼š" class="headerlink" title="å…³äºå“ˆå¸Œæ§½çš„æ¦‚å¿µï¼š"></a>å…³äºå“ˆå¸Œæ§½çš„æ¦‚å¿µï¼š</h2><p>Redis é›†ç¾¤ä¸­å†…ç½®äº† 16384 ä¸ªå“ˆå¸Œæ§½ï¼Œå½“éœ€è¦åœ¨ Redis é›†ç¾¤ä¸­æ”¾ç½®ä¸€ä¸ª key-valueæ—¶ï¼Œredis å…ˆå¯¹ key ä½¿ç”¨ crc16 ç®—æ³•ç®—å‡ºä¸€ä¸ªç»“æœï¼Œç„¶åæŠŠç»“æœå¯¹ 16384 æ±‚ä½™æ•°ï¼Œè¿™æ ·æ¯ä¸ª key éƒ½ä¼šå¯¹åº”ä¸€ä¸ªç¼–å·åœ¨ 0-16383 ä¹‹é—´çš„å“ˆå¸Œæ§½ï¼Œredis ä¼šæ ¹æ®èŠ‚ç‚¹æ•°é‡å¤§è‡´å‡ç­‰çš„å°†å“ˆå¸Œæ§½æ˜ å°„åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚</p><p>Redis é›†ç¾¤æ²¡æœ‰ä½¿ç”¨ä¸€è‡´æ€§hash, è€Œæ˜¯å¼•å…¥äº†å“ˆå¸Œæ§½çš„æ¦‚å¿µã€‚</p><p>Redis é›†ç¾¤æœ‰16384ä¸ªå“ˆå¸Œæ§½,æ¯ä¸ªkeyé€šè¿‡CRC16æ ¡éªŒåå¯¹16384å–æ¨¡æ¥å†³å®šæ”¾ç½®å“ªä¸ªæ§½.é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†hashæ§½ã€‚è¿™ç§ç»“æ„å¾ˆå®¹æ˜“æ·»åŠ æˆ–è€…åˆ é™¤èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ— è®ºæ˜¯æ·»åŠ åˆ é™¤æˆ–è€…ä¿®æ”¹æŸä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½ä¸ä¼šé€ æˆé›†ç¾¤ä¸å¯ç”¨çš„çŠ¶æ€ã€‚</p><p>ä½¿ç”¨å“ˆå¸Œæ§½çš„å¥½å¤„å°±åœ¨äºå¯ä»¥æ–¹ä¾¿çš„æ·»åŠ æˆ–ç§»é™¤èŠ‚ç‚¹ã€‚</p><p>å½“éœ€è¦å¢åŠ èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦æŠŠå…¶ä»–èŠ‚ç‚¹çš„æŸäº›å“ˆå¸Œæ§½æŒªåˆ°æ–°èŠ‚ç‚¹å°±å¯ä»¥äº†ï¼›</p><p>å½“éœ€è¦ç§»é™¤èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦æŠŠç§»é™¤èŠ‚ç‚¹ä¸Šçš„å“ˆå¸Œæ§½æŒªåˆ°å…¶ä»–èŠ‚ç‚¹å°±è¡Œäº†ï¼›</p><p>åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬ä»¥åæ–°å¢æˆ–ç§»é™¤èŠ‚ç‚¹çš„æ—¶å€™ä¸ç”¨å…ˆåœæ‰æ‰€æœ‰çš„ redis æœåŠ¡ã€‚</p><p>â€œç”¨äº†å“ˆå¸Œæ§½çš„æ¦‚å¿µï¼Œè€Œæ²¡æœ‰ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œä¸éƒ½æ˜¯å“ˆå¸Œä¹ˆï¼Ÿè¿™æ ·åšçš„åŸå› æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿâ€<br>Redis Clusteræ˜¯è‡ªå·±åšçš„crc16çš„ç®€å•hashç®—æ³•ï¼Œæ²¡æœ‰ç”¨ä¸€è‡´æ€§hashã€‚Redisçš„ä½œè€…è®¤ä¸ºå®ƒçš„crc16(key) mod 16384çš„æ•ˆæœå·²ç»ä¸é”™äº†ï¼Œè™½ç„¶æ²¡æœ‰ä¸€è‡´æ€§hashçµæ´»ï¼Œä½†å®ç°å¾ˆç®€å•ï¼ŒèŠ‚ç‚¹å¢åˆ æ—¶å¤„ç†èµ·æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚</p><p>â€œä¸ºäº†åŠ¨æ€å¢åˆ èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¸è‡³äºä¸¢å¤±æ•°æ®ä¹ˆï¼Ÿâ€<br>èŠ‚ç‚¹å¢åˆ æ—¶ä¸ä¸¢å¤±æ•°æ®å’Œhashç®—æ³•æ²¡ä»€ä¹ˆå…³ç³»ï¼Œä¸ä¸¢å¤±æ•°æ®è¦æ±‚çš„æ˜¯ä¸€ä»½æ•°æ®æœ‰å¤šä¸ªå‰¯æœ¬ã€‚</p><p>â€œè¿˜æœ‰é›†ç¾¤æ€»å…±æœ‰2çš„14æ¬¡æ–¹ï¼Œ16384ä¸ªå“ˆå¸Œæ§½ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªå“ˆå¸Œæ§½ä¸­å­˜çš„key å’Œ valueæ˜¯ä»€ä¹ˆï¼Ÿâ€<br>å½“ä½ å¾€Redis Clusterä¸­åŠ å…¥ä¸€ä¸ªKeyæ—¶ï¼Œä¼šæ ¹æ®crc16(key) mod 16384è®¡ç®—è¿™ä¸ªkeyåº”è¯¥åˆ†å¸ƒåˆ°å“ªä¸ªhash slotä¸­ï¼Œä¸€ä¸ªhash slotä¸­ä¼šæœ‰å¾ˆå¤škeyå’Œvalueã€‚ä½ å¯ä»¥ç†è§£æˆè¡¨çš„åˆ†åŒºï¼Œä½¿ç”¨å•èŠ‚ç‚¹æ—¶çš„redisæ—¶åªæœ‰ä¸€ä¸ªè¡¨ï¼Œæ‰€æœ‰çš„keyéƒ½æ”¾åœ¨è¿™ä¸ªè¡¨é‡Œï¼›æ”¹ç”¨Redis Clusterä»¥åä¼šè‡ªåŠ¨ä¸ºä½ ç”Ÿæˆ16384ä¸ªåˆ†åŒºè¡¨ï¼Œä½ insertæ•°æ®æ—¶ä¼šæ ¹æ®ä¸Šé¢çš„ç®€å•ç®—æ³•æ¥å†³å®šä½ çš„keyåº”è¯¥å­˜åœ¨å“ªä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºé‡Œæœ‰å¾ˆå¤škeyã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis-cluster </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è“é²¸å¹³å°å®è·µåŠåº”ç”¨...</title>
      <link href="/2017/05/31/lan-jing-ping-tai-shi-jian-ji-ying-yong-2/"/>
      <url>/2017/05/31/lan-jing-ping-tai-shi-jian-ji-ying-yong-2/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€:"></a>å‰è¨€:</h4><p>åœ¨ä»Šå¹´ä¸‰æœˆä»½è“é²¸æ¨å‡ºäº†ä¸€å¥—å…è´¹çš„è“é²¸DevOpsæŠ€èƒ½åŸ¹è®­ï¼Œå€ŸåŠ©è“é²¸å¹³å°è‡´åŠ›äºè®©æ¯ä¸ªè¿ç»´å±Œä¸éƒ½å…·å¤‡ä¸€å®šçš„å¼€å‘èƒ½åŠ›ï¼›æœ‰å¹¸åœ¨æ­¤æ¬¡åŸ¹è®­è¯¾ç¨‹åšæŒäº†ä¸‹æ¥ï¼Œä¹Ÿæ”¶è·äº†å…³äºè…¾è®¯è“é²¸è¿ç»´çš„ä¸€äº›ç†å¿µã€æ€ç»´ï¼›åŒæ—¶è‡ªå·±çš„å·¥ä½œæ–¹å¼ã€å­¦ä¹ æ–¹å¼ä¹Ÿæœ‰äº†ä¸€å®šçš„æå‡ã€æ”¹å˜ï¼›å†æ­¤æ„Ÿè°¢å„ä½å¯¼å¸ˆçš„å­œå­œä¸å€¦çš„æ•™æˆâ€”â€“æˆäººä»¥é±¼ä¸å¦‚æˆäººä»¥æ¸”ã€‚</p><hr><h4 id="ä¸€ã€å¦‚ä½•å­¦ä¹ å®ƒï¼Ÿ"><a href="#ä¸€ã€å¦‚ä½•å­¦ä¹ å®ƒï¼Ÿ" class="headerlink" title="ä¸€ã€å¦‚ä½•å­¦ä¹ å®ƒï¼Ÿ"></a>ä¸€ã€å¦‚ä½•å­¦ä¹ å®ƒï¼Ÿ</h4><ol><li>LinuxåŸºç¡€(å¿…å¤‡)ï¼›</li><li>éœ€è¦æœ‰ä¸€å®šçš„PythonåŸºç¡€çŸ¥è¯†ï¼›</li><li>å‰ç«¯æ–¹é¢ä¹Ÿéœ€è¦å¤šå†™ï¼›</li><li>å­¦ä¹ èƒ½åŠ› + å­¦ä¹ æ–¹æ³•ï¼›</li></ol><hr><h4 id="äºŒã€å­¦ä¹ é€”å¾„ï¼š"><a href="#äºŒã€å­¦ä¹ é€”å¾„ï¼š" class="headerlink" title="äºŒã€å­¦ä¹ é€”å¾„ï¼š"></a>äºŒã€å­¦ä¹ é€”å¾„ï¼š</h4><p>é“¾æ¥: <a href="http://bbs.bk.tencent.com/forum.php?mod=viewthread&amp;tid=261&amp;extra=page=1">è“é²¸DevOpsæŠ€èƒ½åŸ¹è®­</a></p><hr><h4 id="ä¸‰ã€æˆ‘çš„å­¦ä¹ è®°å½•"><a href="#ä¸‰ã€æˆ‘çš„å­¦ä¹ è®°å½•" class="headerlink" title="ä¸‰ã€æˆ‘çš„å­¦ä¹ è®°å½•:"></a>ä¸‰ã€æˆ‘çš„å­¦ä¹ è®°å½•:</h4><p>é“¾æ¥: <a href="http://bbs.bk.tencent.com/forum.php?mod=viewthread&amp;tid=261&amp;page=21&amp;authorid=704">ä½œä¸šè®°å½•</a></p><hr><h4 id="å››ã€ç›®å‰å­¦ä¹ æˆæœ"><a href="#å››ã€ç›®å‰å­¦ä¹ æˆæœ" class="headerlink" title="å››ã€ç›®å‰å­¦ä¹ æˆæœ:"></a>å››ã€ç›®å‰å­¦ä¹ æˆæœ:</h4><ol><li>è“é²¸paaså¹³å°é¡µé¢æˆªå›¾: <img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2017/05/14962014386437-14.jpg"></li><li>è“é²¸å¼€å‘è€…ä¸­å¿ƒ: ï¿¼<a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2017/05/WechatIMG2.jpeg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2017/05/WechatIMG2.jpeg"></a></li><li>è‡ªä¸»å¼€å‘Appæƒé™æ§åˆ¶å¹³å°: <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2017/05/WechatIMG5.jpeg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2017/05/WechatIMG5.jpeg"></a>ï¿¼</li><li>è‡ªä¸»å¼€å‘è¿ç»´ç®¡æ§å¹³å°: <img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2017/05/14962014574341-16.jpg">ï¿¼</li></ol><hr><h4 id="äº”ã€å°ç»“"><a href="#äº”ã€å°ç»“" class="headerlink" title="äº”ã€å°ç»“:"></a>äº”ã€å°ç»“:</h4><h5 id="ä¸Šé¢çš„ä¸¤ä¸ªåº”ç”¨å·²ç»åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒ-å…¶ä»–å„ä¸ªéƒ¨é—¨çš„å¹³å°å¼€å‘ing"><a href="#ä¸Šé¢çš„ä¸¤ä¸ªåº”ç”¨å·²ç»åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒ-å…¶ä»–å„ä¸ªéƒ¨é—¨çš„å¹³å°å¼€å‘ing" class="headerlink" title="ä¸Šé¢çš„ä¸¤ä¸ªåº”ç”¨å·²ç»åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒ;å…¶ä»–å„ä¸ªéƒ¨é—¨çš„å¹³å°å¼€å‘ing;"></a>ä¸Šé¢çš„ä¸¤ä¸ªåº”ç”¨å·²ç»åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒ;å…¶ä»–å„ä¸ªéƒ¨é—¨çš„å¹³å°å¼€å‘ing;</h5><h5 id="ç°åœ¨å°ä¼™ä¼´å„¿ä»¬å¦‚æœå»å­¦ä¹ çš„è¯ï¼›åº”è¯¥éå¸¸çš„é¡ºåˆ©ï¼Œæ¯•ç«Ÿå‘å·®ä¸å¤šéƒ½è¢«å¡«å®Œäº†ã€‚"><a href="#ç°åœ¨å°ä¼™ä¼´å„¿ä»¬å¦‚æœå»å­¦ä¹ çš„è¯ï¼›åº”è¯¥éå¸¸çš„é¡ºåˆ©ï¼Œæ¯•ç«Ÿå‘å·®ä¸å¤šéƒ½è¢«å¡«å®Œäº†ã€‚" class="headerlink" title="ç°åœ¨å°ä¼™ä¼´å„¿ä»¬å¦‚æœå»å­¦ä¹ çš„è¯ï¼›åº”è¯¥éå¸¸çš„é¡ºåˆ©ï¼Œæ¯•ç«Ÿå‘å·®ä¸å¤šéƒ½è¢«å¡«å®Œäº†ã€‚"></a>ç°åœ¨å°ä¼™ä¼´å„¿ä»¬å¦‚æœå»å­¦ä¹ çš„è¯ï¼›åº”è¯¥éå¸¸çš„é¡ºåˆ©ï¼Œæ¯•ç«Ÿå‘å·®ä¸å¤šéƒ½è¢«å¡«å®Œäº†ã€‚</h5><h5 id="ä¸æƒ³è¯´å¤ªå¤šï¼›æ­¤ç¯‡åšæ–‡è®°å½•ä¸€ä¸‹è¿™ä¸‰ä¸ªæœˆä»¥æ¥çš„ä¸€äº›æ”¶è·å§"><a href="#ä¸æƒ³è¯´å¤ªå¤šï¼›æ­¤ç¯‡åšæ–‡è®°å½•ä¸€ä¸‹è¿™ä¸‰ä¸ªæœˆä»¥æ¥çš„ä¸€äº›æ”¶è·å§" class="headerlink" title="ä¸æƒ³è¯´å¤ªå¤šï¼›æ­¤ç¯‡åšæ–‡è®°å½•ä¸€ä¸‹è¿™ä¸‰ä¸ªæœˆä»¥æ¥çš„ä¸€äº›æ”¶è·å§;"></a>ä¸æƒ³è¯´å¤ªå¤šï¼›æ­¤ç¯‡åšæ–‡è®°å½•ä¸€ä¸‹è¿™ä¸‰ä¸ªæœˆä»¥æ¥çš„ä¸€äº›æ”¶è·å§;</h5><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2017/06/14962839951327.jpg">ï¿¼</p><h5 id="ä½ çš„å¯¹æ‰‹åœ¨çœ‹ä¹¦ï¼Œ"><a href="#ä½ çš„å¯¹æ‰‹åœ¨çœ‹ä¹¦ï¼Œ" class="headerlink" title="ä½ çš„å¯¹æ‰‹åœ¨çœ‹ä¹¦ï¼Œ"></a>ä½ çš„å¯¹æ‰‹åœ¨çœ‹ä¹¦ï¼Œ</h5><h5 id="ä½ çš„ä»‡äººåœ¨ç£¨åˆ€ï¼Œ"><a href="#ä½ çš„ä»‡äººåœ¨ç£¨åˆ€ï¼Œ" class="headerlink" title="ä½ çš„ä»‡äººåœ¨ç£¨åˆ€ï¼Œ"></a>ä½ çš„ä»‡äººåœ¨ç£¨åˆ€ï¼Œ</h5><h5 id="ä½ çš„é—ºå¯†åœ¨å‡è‚¥ï¼Œ"><a href="#ä½ çš„é—ºå¯†åœ¨å‡è‚¥ï¼Œ" class="headerlink" title="ä½ çš„é—ºå¯†åœ¨å‡è‚¥ï¼Œ"></a>ä½ çš„é—ºå¯†åœ¨å‡è‚¥ï¼Œ</h5><h5 id="éš”å£è€ç‹åœ¨ç»ƒè…°ï¼Œ"><a href="#éš”å£è€ç‹åœ¨ç»ƒè…°ï¼Œ" class="headerlink" title="éš”å£è€ç‹åœ¨ç»ƒè…°ï¼Œ"></a>éš”å£è€ç‹åœ¨ç»ƒè…°ï¼Œ</h5><h5 id="æˆ‘ä»¬å¿…é¡»ä¸æ–­å­¦ä¹ ï¼Œ"><a href="#æˆ‘ä»¬å¿…é¡»ä¸æ–­å­¦ä¹ ï¼Œ" class="headerlink" title="æˆ‘ä»¬å¿…é¡»ä¸æ–­å­¦ä¹ ï¼Œ"></a>æˆ‘ä»¬å¿…é¡»ä¸æ–­å­¦ä¹ ï¼Œ</h5><h5 id="æ‰èƒ½è®©è‡ªå·±å˜å¾—æ›´å¼ºã€‚"><a href="#æ‰èƒ½è®©è‡ªå·±å˜å¾—æ›´å¼ºã€‚" class="headerlink" title="æ‰èƒ½è®©è‡ªå·±å˜å¾—æ›´å¼ºã€‚"></a>æ‰èƒ½è®©è‡ªå·±å˜å¾—æ›´å¼ºã€‚</h5>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç³»ç»Ÿè¿ç»´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How to Use Mojo/webqq Send QQ Message</title>
      <link href="/2017/04/06/how-to-use-mojowebqq-send-qq-message/"/>
      <url>/2017/04/06/how-to-use-mojowebqq-send-qq-message/</url>
      
        <content type="html"><![CDATA[<h4 id="1-get-docker-images"><a href="#1-get-docker-images" class="headerlink" title="1. get docker images"></a>1. get docker images</h4><pre><code>docker pull sjdy521/mojo-webqq</code></pre><h4 id="2-run-it"><a href="#2-run-it" class="headerlink" title="2. run it"></a>2. run it</h4><pre><code>docker run -d -p 9999:5000 -v /tmp/:/tmp/ sjdy521/mojo-webqq</code></pre><h4 id="3-check-logs"><a href="#3-check-logs" class="headerlink" title="3. check logs"></a>3. check logs</h4><pre><code>docker logs -f CONTAINER_ID[17/04/07 15:57:13] [info] å½“å‰æ­£åœ¨ä½¿ç”¨ Mojo-Webqq v2.0.8[17/04/07 15:57:13] [warn] å½“å‰ç‰ˆæœ¬ä¸1.x.xç‰ˆæœ¬ä¸å…¼å®¹ï¼Œæ”¹åŠ¨è¯¦æƒ…å‚è§æ›´æ–°æ—¥å¿—[17/04/07 15:57:13] [info] æ‰§è¡Œæ’ä»¶[ Mojo::Webqq::Plugin::UploadQRcode ][17/04/07 15:57:13] [info] æ‰§è¡Œæ’ä»¶[ Mojo::Webqq::Plugin::ShowMsg ][17/04/07 15:57:13] [info] æ‰§è¡Œæ’ä»¶[ Mojo::Webqq::Plugin::Openqq ][17/04/07 15:57:13] [info] Listening at "http://0.0.0.0:5000"Server available at http://0.0.0.0:5000[17/04/07 15:57:13] [info] åˆå§‹åŒ– smartqq å®¢æˆ·ç«¯å‚æ•°...[17/04/07 15:57:13] [info] æ­£åœ¨è·å–ç™»å½•äºŒç»´ç ...[17/04/07 15:57:13] [info] äºŒç»´ç å·²ä¸‹è½½åˆ°æœ¬åœ°[ /tmp/mojo_webqq_qrcode_default.png ][17/04/07 15:57:15] [info] äºŒç»´ç å·²ä¸Šä¼ äº‘å­˜å‚¨[ https://ooo.0o0.ooo/2017/04/07/58e7465b89582.png ][17/04/07 15:57:15] [info] ç­‰å¾…æ‰‹æœºQQæ‰«æäºŒç»´ç ...[17/04/07 15:58:01] [info] æ‰‹æœºQQæ‰«ç æˆåŠŸï¼Œè¯·åœ¨æ‰‹æœºä¸Šç‚¹å‡»[å…è®¸ç™»å½•smartQQ]æŒ‰é’®...[17/04/07 15:59:11] [info] æ£€æŸ¥å®‰å…¨ä»£ç ...[17/04/07 15:59:11] [info] è·å–æ•°æ®éªŒè¯å‚æ•°...[17/04/07 15:59:11] [info] å°è¯•è¿›è¡Œç™»å½•(2)...[17/04/07 15:59:12] [info] å¸å·(xxxxxxxxxxxxx)ç™»å½•æˆåŠŸ</code></pre><h4 id="4-scan-qrcode"><a href="#4-scan-qrcode" class="headerlink" title="4. scan qrcode"></a>4. scan qrcode</h4><pre><code>/tmp/mojo_webqq_qrcode_default.png</code></pre><h4 id="5-sendmessage"><a href="#5-sendmessage" class="headerlink" title="5. sendmessage:"></a>5. sendmessage:</h4><pre><code>curl "http://YOUR_SERVER_IP:9999/openqq/send_friend_message?uid=friends_qq_num&amp;content=hello"curl "http://YOUR_SERVER_IP:9999/openqq/send_group_message?uid=group_qq_number&amp;content=hehe"</code></pre><h4 id="6-other-system-use"><a href="#6-other-system-use" class="headerlink" title="6. other system use:"></a>6. other system use:</h4><pre><code>def send_message(number, content):  url = "http://YOUR_SERVER_IP:9999/openqq/send_friend_message"  data = {        "uid": number,        "content": content,  }  requests.get(url=url,data=data)  if __name__ == "__main__":  send_message('2399447849','hello')</code></pre>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>How to Install Gateone(WebSSH)</title>
      <link href="/2017/02/21/how-to-install-gateonewebssh/"/>
      <url>/2017/02/21/how-to-install-gateonewebssh/</url>
      
        <content type="html"><![CDATA[<h5 id="1-Install-dependent-package-CentOS7"><a href="#1-Install-dependent-package-CentOS7" class="headerlink" title="1.Install dependent package(CentOS7)"></a>1.Install dependent package(CentOS7)</h5><pre><code>yum install python-pip</code></pre><h5 id="2-Get-install-source-code"><a href="#2-Get-install-source-code" class="headerlink" title="2.Get install source code"></a>2.Get install source code</h5><pre><code>git clone https://github.com/liftoff/GateOne.gitcd  GateOne/python setup.py install</code></pre><h5 id="3-Start-this-service-will-Generate-the-configuration-file-etc-gateone"><a href="#3-Start-this-service-will-Generate-the-configuration-file-etc-gateone" class="headerlink" title="3. Start this service will Generate the configuration file(/etc/gateone/*)"></a>3. Start this service will Generate the configuration file(/etc/gateone/*)</h5><pre><code>/etc/gateone # GateOne's default install dirservice gateone start</code></pre><h5 id="4-You-will-see-some-messages-flash-by-wait-untill-you-see-something-like-GateOne-will-by-default-run-on-443-https-and-will-allow-access-only-from-the-hostname-that-it-autodetects-so-make-sure-that-whaterver-URL-you-normally-access-this-server-through-is-listed-in-GateOneâ€™s-orgin-list"><a href="#4-You-will-see-some-messages-flash-by-wait-untill-you-see-something-like-GateOne-will-by-default-run-on-443-https-and-will-allow-access-only-from-the-hostname-that-it-autodetects-so-make-sure-that-whaterver-URL-you-normally-access-this-server-through-is-listed-in-GateOneâ€™s-orgin-list" class="headerlink" title="4. You will see some messages flash by, wait untill you see something like:GateOne will by default run on 443(https), and will allow access only from the hostname that it autodetects, so make sure that whaterver URL you normally access, this server through is listed in GateOneâ€™s orgin list:"></a>4. You will see some messages flash by, wait untill you see something like:GateOne will by default run on 443(https), and will allow access only from the hostname that it autodetects, so make sure that whaterver URL you normally access, this server through is listed in GateOneâ€™s orgin list:</h5><pre><code>Listening on https://*:443/vim /etc/gateone/conf.d/10server.conf</code></pre><h5 id="5-Now-run"><a href="#5-Now-run" class="headerlink" title="5.Now run:"></a>5.Now run:</h5><pre><code>/etc/init.d/gateone start orservice gateone start</code></pre><h5 id="6-Access-Webssh"><a href="#6-Access-Webssh" class="headerlink" title="6.Access Webssh:"></a>6.Access Webssh:</h5><pre><code>https://YOUR_SERVER_IP</code></pre><h5 id="like-this"><a href="#like-this" class="headerlink" title="like this:"></a>like this:</h5><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2017/02/14876901172167-2.jpg">ï¿¼</p><h5 id="Sure-the-GateOne-has-Docker-Version-you-can"><a href="#Sure-the-GateOne-has-Docker-Version-you-can" class="headerlink" title="Sure ,the GateOne has Docker Version, you can:"></a>Sure ,the GateOne has Docker Version, you can:</h5><pre><code>docker pull gateonedocker run -d --name=gateone -p 443:8000 liftoff/gateoneorgit clone https://github.com/liftoff/GateOne.gitcd  GateOne/dockerdocker build -t gateone .</code></pre>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç³»ç»Ÿè¿ç»´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>&quot;Devops&quot; Demo(å¦‚æœæ–‡ä¸­å›¾ç‰‡æ˜¾ç¤ºä¸å®Œæ•´ï¼Œè¯·å¤šæ¬¡åˆ·æ–°)</title>
      <link href="/2016/12/16/devops-demo/"/>
      <url>/2016/12/16/devops-demo/</url>
      
        <content type="html"><![CDATA[<h4 id="ä»Šå¹´æ–­æ–­ç»­ç»­åœ¨å·¥ä½œä¹‹ä½™å­¦ä¹ äº†ä¸€ä¸‹-Python-Webæ¡†æ¶-ä¸‹é¢ç®€è¦è¯´ä¸‹å­¦çš„ä¸œè¥¿ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š"><a href="#ä»Šå¹´æ–­æ–­ç»­ç»­åœ¨å·¥ä½œä¹‹ä½™å­¦ä¹ äº†ä¸€ä¸‹-Python-Webæ¡†æ¶-ä¸‹é¢ç®€è¦è¯´ä¸‹å­¦çš„ä¸œè¥¿ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š" class="headerlink" title="ä»Šå¹´æ–­æ–­ç»­ç»­åœ¨å·¥ä½œä¹‹ä½™å­¦ä¹ äº†ä¸€ä¸‹ Python Webæ¡†æ¶,ä¸‹é¢ç®€è¦è¯´ä¸‹å­¦çš„ä¸œè¥¿ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š"></a>ä»Šå¹´æ–­æ–­ç»­ç»­åœ¨å·¥ä½œä¹‹ä½™å­¦ä¹ äº†ä¸€ä¸‹ Python Webæ¡†æ¶,ä¸‹é¢ç®€è¦è¯´ä¸‹å­¦çš„ä¸œè¥¿ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</h4><ul><li><h4 id="Flask-åŒ…æ‹¬å„ä¸ªå­ç³»ç»Ÿç»„ä»¶-Bootstrap"><a href="#Flask-åŒ…æ‹¬å„ä¸ªå­ç³»ç»Ÿç»„ä»¶-Bootstrap" class="headerlink" title="Flask(åŒ…æ‹¬å„ä¸ªå­ç³»ç»Ÿç»„ä»¶) + Bootstrap"></a>Flask(åŒ…æ‹¬å„ä¸ªå­ç³»ç»Ÿç»„ä»¶) + Bootstrap</h4><h5 id="ä¸»è¦æ˜¯ç¬¬ä¸€ä¸ªæ¥è§¦çš„å°±æ˜¯Flaskè¿™ä¸ªæ¡†æ¶-æœŸåˆç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯å¼€å‘èµ·æ¥éå¸¸çš„å¿«æ·ã€æ–¹ä¾¿-å„ä¸ªå­ç³»ç»Ÿä¹Ÿæœ‰å•ç‹¬çš„å­¦ä¹ èµ„æ–™-æ‰€ä»¥ä»ä¸€å¼€å§‹æˆ‘ä¹Ÿå°±ä¸€ç›´æ–­æ–­ç»­ç»­çš„åœ¨æŠ˜è…¾ï¼›"><a href="#ä¸»è¦æ˜¯ç¬¬ä¸€ä¸ªæ¥è§¦çš„å°±æ˜¯Flaskè¿™ä¸ªæ¡†æ¶-æœŸåˆç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯å¼€å‘èµ·æ¥éå¸¸çš„å¿«æ·ã€æ–¹ä¾¿-å„ä¸ªå­ç³»ç»Ÿä¹Ÿæœ‰å•ç‹¬çš„å­¦ä¹ èµ„æ–™-æ‰€ä»¥ä»ä¸€å¼€å§‹æˆ‘ä¹Ÿå°±ä¸€ç›´æ–­æ–­ç»­ç»­çš„åœ¨æŠ˜è…¾ï¼›" class="headerlink" title="ä¸»è¦æ˜¯ç¬¬ä¸€ä¸ªæ¥è§¦çš„å°±æ˜¯Flaskè¿™ä¸ªæ¡†æ¶,æœŸåˆç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯å¼€å‘èµ·æ¥éå¸¸çš„å¿«æ·ã€æ–¹ä¾¿,å„ä¸ªå­ç³»ç»Ÿä¹Ÿæœ‰å•ç‹¬çš„å­¦ä¹ èµ„æ–™,æ‰€ä»¥ä»ä¸€å¼€å§‹æˆ‘ä¹Ÿå°±ä¸€ç›´æ–­æ–­ç»­ç»­çš„åœ¨æŠ˜è…¾ï¼›"></a>ä¸»è¦æ˜¯ç¬¬ä¸€ä¸ªæ¥è§¦çš„å°±æ˜¯Flaskè¿™ä¸ªæ¡†æ¶,æœŸåˆç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯å¼€å‘èµ·æ¥éå¸¸çš„å¿«æ·ã€æ–¹ä¾¿,å„ä¸ªå­ç³»ç»Ÿä¹Ÿæœ‰å•ç‹¬çš„å­¦ä¹ èµ„æ–™,æ‰€ä»¥ä»ä¸€å¼€å§‹æˆ‘ä¹Ÿå°±ä¸€ç›´æ–­æ–­ç»­ç»­çš„åœ¨æŠ˜è…¾ï¼›</h5><h5 id="Bootstrap-DiaoBaoäº†"><a href="#Bootstrap-DiaoBaoäº†" class="headerlink" title="Bootstrap DiaoBaoäº†."></a>Bootstrap DiaoBaoäº†.</h5></li><li><h4 id="SaltStack-API-netapi-rest-cherrypy"><a href="#SaltStack-API-netapi-rest-cherrypy" class="headerlink" title="SaltStack API(netapi/rest_cherrypy)"></a>SaltStack API(netapi/rest_cherrypy)</h4><h5 id="è¿™ä¸ªå°±ä¸ç”¨è¯´äº†å§ï¼Œè¿ç»´äººéƒ½çŸ¥é“ï¼›"><a href="#è¿™ä¸ªå°±ä¸ç”¨è¯´äº†å§ï¼Œè¿ç»´äººéƒ½çŸ¥é“ï¼›" class="headerlink" title="è¿™ä¸ªå°±ä¸ç”¨è¯´äº†å§ï¼Œè¿ç»´äººéƒ½çŸ¥é“ï¼›"></a>è¿™ä¸ªå°±ä¸ç”¨è¯´äº†å§ï¼Œè¿ç»´äººéƒ½çŸ¥é“ï¼›</h5><h5 id="åœ¨æŒæ¡äº†SaltStackåœ¨å‘½ä»¤è¡Œçš„ç”¨æ³•ä¹‹åå°±éœ€è¦å»å­¦ä¹ ã€æ¢ç´¢æ›´å¤šæ›´ä¾¿åˆ©çš„æ–¹æ³•æ¥å®ç°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼›"><a href="#åœ¨æŒæ¡äº†SaltStackåœ¨å‘½ä»¤è¡Œçš„ç”¨æ³•ä¹‹åå°±éœ€è¦å»å­¦ä¹ ã€æ¢ç´¢æ›´å¤šæ›´ä¾¿åˆ©çš„æ–¹æ³•æ¥å®ç°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼›" class="headerlink" title="åœ¨æŒæ¡äº†SaltStackåœ¨å‘½ä»¤è¡Œçš„ç”¨æ³•ä¹‹åå°±éœ€è¦å»å­¦ä¹ ã€æ¢ç´¢æ›´å¤šæ›´ä¾¿åˆ©çš„æ–¹æ³•æ¥å®ç°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼›"></a>åœ¨æŒæ¡äº†SaltStackåœ¨å‘½ä»¤è¡Œçš„ç”¨æ³•ä¹‹åå°±éœ€è¦å»å­¦ä¹ ã€æ¢ç´¢æ›´å¤šæ›´ä¾¿åˆ©çš„æ–¹æ³•æ¥å®ç°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼›</h5></li><li><h4 id="Zabbix-API"><a href="#Zabbix-API" class="headerlink" title="Zabbix API"></a>Zabbix API</h4><h5 id="ç›‘æ§åˆ©å™¨-zabbix-æ›´ä¸ç”¨è¯´äº†ã€‚"><a href="#ç›‘æ§åˆ©å™¨-zabbix-æ›´ä¸ç”¨è¯´äº†ã€‚" class="headerlink" title="ç›‘æ§åˆ©å™¨ zabbix, æ›´ä¸ç”¨è¯´äº†ã€‚"></a>ç›‘æ§åˆ©å™¨ zabbix, æ›´ä¸ç”¨è¯´äº†ã€‚</h5><h5 id="ç”±äºå·¥ä½œä¸Šçš„æ‰€éœ€-å¢å‡æœåŠ¡å™¨æ˜¯å¸¸æœ‰çš„äº‹-é‚£æ€ä¹ˆå¿«é€Ÿçš„å»æ·»åŠ -åˆ é™¤ä¸»æœºå‘¢-å½“ç„¶å°±è¦è®©æ¥å£å¸®å¿™å»å¤„ç†å•¦ï¼›"><a href="#ç”±äºå·¥ä½œä¸Šçš„æ‰€éœ€-å¢å‡æœåŠ¡å™¨æ˜¯å¸¸æœ‰çš„äº‹-é‚£æ€ä¹ˆå¿«é€Ÿçš„å»æ·»åŠ -åˆ é™¤ä¸»æœºå‘¢-å½“ç„¶å°±è¦è®©æ¥å£å¸®å¿™å»å¤„ç†å•¦ï¼›" class="headerlink" title="ç”±äºå·¥ä½œä¸Šçš„æ‰€éœ€,å¢å‡æœåŠ¡å™¨æ˜¯å¸¸æœ‰çš„äº‹,é‚£æ€ä¹ˆå¿«é€Ÿçš„å»æ·»åŠ /åˆ é™¤ä¸»æœºå‘¢,å½“ç„¶å°±è¦è®©æ¥å£å¸®å¿™å»å¤„ç†å•¦ï¼›"></a>ç”±äºå·¥ä½œä¸Šçš„æ‰€éœ€,å¢å‡æœåŠ¡å™¨æ˜¯å¸¸æœ‰çš„äº‹,é‚£æ€ä¹ˆå¿«é€Ÿçš„å»æ·»åŠ /åˆ é™¤ä¸»æœºå‘¢,å½“ç„¶å°±è¦è®©æ¥å£å¸®å¿™å»å¤„ç†å•¦ï¼›</h5></li></ul><h4 id="ä¸‹é¢æ˜¯demoçš„é›å½¢ï¼š"><a href="#ä¸‹é¢æ˜¯demoçš„é›å½¢ï¼š" class="headerlink" title="ä¸‹é¢æ˜¯demoçš„é›å½¢ï¼š"></a>ä¸‹é¢æ˜¯demoçš„é›å½¢ï¼š</h4><h5 id="ç™»å½•ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Flaskè‡ªå¸¦çš„Flask-Loginç»„ä»¶ï¼ŒéªŒè¯ç ç”¨çš„æ˜¯Googleçš„ReCAPTCHA-å½“ç„¶è¿™ä¸ªåœ¨Flaskè¡¨å•ä¸­å·²"><a href="#ç™»å½•ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Flaskè‡ªå¸¦çš„Flask-Loginç»„ä»¶ï¼ŒéªŒè¯ç ç”¨çš„æ˜¯Googleçš„ReCAPTCHA-å½“ç„¶è¿™ä¸ªåœ¨Flaskè¡¨å•ä¸­å·²" class="headerlink" title="ç™»å½•ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Flaskè‡ªå¸¦çš„Flask-Loginç»„ä»¶ï¼ŒéªŒè¯ç ç”¨çš„æ˜¯Googleçš„ReCAPTCHA,å½“ç„¶è¿™ä¸ªåœ¨Flaskè¡¨å•ä¸­å·²"></a>ç™»å½•ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Flaskè‡ªå¸¦çš„Flask-Loginç»„ä»¶ï¼ŒéªŒè¯ç ç”¨çš„æ˜¯Googleçš„ReCAPTCHA,å½“ç„¶è¿™ä¸ªåœ¨Flaskè¡¨å•ä¸­å·²</h5><p>ç»é›†æˆäº†ï¼› <img src="/2016/12/16/devops-demo/14818093599191.jpg">ï¿¼</p><h5 id="SaltStack-å‘½ä»¤æ‰§è¡Œ-è°ƒç”¨çš„æ˜¯SaltApi-è¿™é‡Œéœ€è¦æ‰‹åŠ¨å¡«å†™ä¸»æœºå-æ˜¯ä¸ªéœ€è¦ä¼˜åŒ–çš„åœ°æ–¹-ï¿¼"><a href="#SaltStack-å‘½ä»¤æ‰§è¡Œ-è°ƒç”¨çš„æ˜¯SaltApi-è¿™é‡Œéœ€è¦æ‰‹åŠ¨å¡«å†™ä¸»æœºå-æ˜¯ä¸ªéœ€è¦ä¼˜åŒ–çš„åœ°æ–¹-ï¿¼" class="headerlink" title="SaltStack å‘½ä»¤æ‰§è¡Œ,è°ƒç”¨çš„æ˜¯SaltApi,è¿™é‡Œéœ€è¦æ‰‹åŠ¨å¡«å†™ä¸»æœºå,æ˜¯ä¸ªéœ€è¦ä¼˜åŒ–çš„åœ°æ–¹.ï¿¼"></a>SaltStack å‘½ä»¤æ‰§è¡Œ,è°ƒç”¨çš„æ˜¯SaltApi,è¿™é‡Œéœ€è¦æ‰‹åŠ¨å¡«å†™ä¸»æœºå,æ˜¯ä¸ªéœ€è¦ä¼˜åŒ–çš„åœ°æ–¹.<img src="/2016/12/16/devops-demo/14818078774983.jpg">ï¿¼</h5><p><img src="/2016/12/16/devops-demo/14818079617121.jpg">ï¿¼</p><h5 id="å½“ç„¶æœ‰äº†è¿™ä¸ªæ‰§è¡Œå‘½ä»¤-å“¥å­å°±è¦åšåäº‹äº†-è¿™æ€ä¹ˆè¡Œ-é‚£å°±æŠŠä¸€äº›å±é™©çš„å‘½ä»¤æ·»åŠ åˆ°block-listå½“ä¸­-é¿å…è¯¯æ“ä½œ"><a href="#å½“ç„¶æœ‰äº†è¿™ä¸ªæ‰§è¡Œå‘½ä»¤-å“¥å­å°±è¦åšåäº‹äº†-è¿™æ€ä¹ˆè¡Œ-é‚£å°±æŠŠä¸€äº›å±é™©çš„å‘½ä»¤æ·»åŠ åˆ°block-listå½“ä¸­-é¿å…è¯¯æ“ä½œ" class="headerlink" title="å½“ç„¶æœ‰äº†è¿™ä¸ªæ‰§è¡Œå‘½ä»¤,å“¥å­å°±è¦åšåäº‹äº†,è¿™æ€ä¹ˆè¡Œ!é‚£å°±æŠŠä¸€äº›å±é™©çš„å‘½ä»¤æ·»åŠ åˆ°block_listå½“ä¸­,é¿å…è¯¯æ“ä½œ."></a>å½“ç„¶æœ‰äº†è¿™ä¸ªæ‰§è¡Œå‘½ä»¤,å“¥å­å°±è¦åšåäº‹äº†,è¿™æ€ä¹ˆè¡Œ!é‚£å°±æŠŠä¸€äº›å±é™©çš„å‘½ä»¤æ·»åŠ åˆ°block_listå½“ä¸­,é¿å…è¯¯æ“ä½œ.</h5><p><img src="/2016/12/16/devops-demo/14818560611617.jpg">ï¿¼</p><h5 id="âŠ™oâŠ™-â€¦-è¿™ä¸ªåšçš„ä¸æ˜¯å¤ªç¾è§‚ï¼›æ•°æ®æ˜¯ä»æ•°æ®åº“æŸ¥è¯¢å‡ºæ¥çš„-è€Œè¿™äº›æœåŠ¡å™¨çš„â€é™æ€â€æ•°æ®éƒ½æ˜¯é€šè¿‡SaltStackçš„grainsè·å–åˆ°çš„-çœ‹åˆ°æ—è¾¹é‚£ä¸ªColletæŒ‰é’®äº†ä¹ˆ-é‚£ä¸ªçš„åŠŸèƒ½å°±æ˜¯ä¸€é”®è·å–å„ä¸ªminionçš„grainsç„¶åå¯¼å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œæ¯å½“æœ‰æ–°çš„minionåŠ å…¥æ—¶åªè¦åœ¨æ­¤ç‚¹å‡»Collet-Saltå°±ä¼šé©¬ä¸åœè¹„çš„åˆ°æ–°minionç«¯æ‹‰å–ç›¸å…³ä¿¡æ¯-ç„¶åå†™å…¥æ•°æ®åº“-åˆ é™¤æŒ‰é’®çš„ä½œç”¨æ˜¯ä»æ•°æ®åº“å½“ä¸­åˆ é™¤æ­¤æ¡è®°å½•-ï¿¼"><a href="#âŠ™oâŠ™-â€¦-è¿™ä¸ªåšçš„ä¸æ˜¯å¤ªç¾è§‚ï¼›æ•°æ®æ˜¯ä»æ•°æ®åº“æŸ¥è¯¢å‡ºæ¥çš„-è€Œè¿™äº›æœåŠ¡å™¨çš„â€é™æ€â€æ•°æ®éƒ½æ˜¯é€šè¿‡SaltStackçš„grainsè·å–åˆ°çš„-çœ‹åˆ°æ—è¾¹é‚£ä¸ªColletæŒ‰é’®äº†ä¹ˆ-é‚£ä¸ªçš„åŠŸèƒ½å°±æ˜¯ä¸€é”®è·å–å„ä¸ªminionçš„grainsç„¶åå¯¼å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œæ¯å½“æœ‰æ–°çš„minionåŠ å…¥æ—¶åªè¦åœ¨æ­¤ç‚¹å‡»Collet-Saltå°±ä¼šé©¬ä¸åœè¹„çš„åˆ°æ–°minionç«¯æ‹‰å–ç›¸å…³ä¿¡æ¯-ç„¶åå†™å…¥æ•°æ®åº“-åˆ é™¤æŒ‰é’®çš„ä½œç”¨æ˜¯ä»æ•°æ®åº“å½“ä¸­åˆ é™¤æ­¤æ¡è®°å½•-ï¿¼" class="headerlink" title="(âŠ™oâŠ™)â€¦ è¿™ä¸ªåšçš„ä¸æ˜¯å¤ªç¾è§‚ï¼›æ•°æ®æ˜¯ä»æ•°æ®åº“æŸ¥è¯¢å‡ºæ¥çš„;è€Œè¿™äº›æœåŠ¡å™¨çš„â€é™æ€â€æ•°æ®éƒ½æ˜¯é€šè¿‡SaltStackçš„grainsè·å–åˆ°çš„,çœ‹åˆ°æ—è¾¹é‚£ä¸ªColletæŒ‰é’®äº†ä¹ˆ;é‚£ä¸ªçš„åŠŸèƒ½å°±æ˜¯ä¸€é”®è·å–å„ä¸ªminionçš„grainsç„¶åå¯¼å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œæ¯å½“æœ‰æ–°çš„minionåŠ å…¥æ—¶åªè¦åœ¨æ­¤ç‚¹å‡»Collet Saltå°±ä¼šé©¬ä¸åœè¹„çš„åˆ°æ–°minionç«¯æ‹‰å–ç›¸å…³ä¿¡æ¯,ç„¶åå†™å…¥æ•°æ®åº“, åˆ é™¤æŒ‰é’®çš„ä½œç”¨æ˜¯ä»æ•°æ®åº“å½“ä¸­åˆ é™¤æ­¤æ¡è®°å½•.ï¿¼"></a>(âŠ™oâŠ™)â€¦ è¿™ä¸ªåšçš„ä¸æ˜¯å¤ªç¾è§‚ï¼›æ•°æ®æ˜¯ä»æ•°æ®åº“æŸ¥è¯¢å‡ºæ¥çš„;è€Œè¿™äº›æœåŠ¡å™¨çš„â€é™æ€â€æ•°æ®éƒ½æ˜¯é€šè¿‡SaltStackçš„grainsè·å–åˆ°çš„,çœ‹åˆ°æ—è¾¹é‚£ä¸ª<code>Collet</code>æŒ‰é’®äº†ä¹ˆ;é‚£ä¸ªçš„åŠŸèƒ½å°±æ˜¯ä¸€é”®è·å–å„ä¸ªminionçš„grainsç„¶åå¯¼å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œæ¯å½“æœ‰æ–°çš„minionåŠ å…¥æ—¶åªè¦åœ¨æ­¤ç‚¹å‡»<code>Collet</code> Saltå°±ä¼šé©¬ä¸åœè¹„çš„åˆ°æ–°minionç«¯æ‹‰å–ç›¸å…³ä¿¡æ¯,ç„¶åå†™å…¥æ•°æ®åº“, <code>åˆ é™¤</code>æŒ‰é’®çš„ä½œç”¨æ˜¯ä»æ•°æ®åº“å½“ä¸­åˆ é™¤æ­¤æ¡è®°å½•.<img src="/2016/12/16/devops-demo/14818081121387.jpg">ï¿¼</h5><h5 id="ç‚¹å‡»ä¸Šå›¾çš„è¯¦ç»†å°±å¯ä»¥çœ‹åˆ°å…³äºè¿™å°ä¸»æœºçš„è¯¦ç»†çŠ¶æ€äº†-Statusè¿™ä¸ªæ˜¯å®æ—¶æŠ“å–çš„å½“å‰è¿™å°ä¸»æœºçš„å½“å‰çŠ¶æ€-è€Œä¸‹é¢çš„ä¸¤å¼ ç›‘æ§å›¾å½¢åˆ™æ˜¯è°ƒç”¨äº†Grafana"><a href="#ç‚¹å‡»ä¸Šå›¾çš„è¯¦ç»†å°±å¯ä»¥çœ‹åˆ°å…³äºè¿™å°ä¸»æœºçš„è¯¦ç»†çŠ¶æ€äº†-Statusè¿™ä¸ªæ˜¯å®æ—¶æŠ“å–çš„å½“å‰è¿™å°ä¸»æœºçš„å½“å‰çŠ¶æ€-è€Œä¸‹é¢çš„ä¸¤å¼ ç›‘æ§å›¾å½¢åˆ™æ˜¯è°ƒç”¨äº†Grafana" class="headerlink" title="ç‚¹å‡»ä¸Šå›¾çš„è¯¦ç»†å°±å¯ä»¥çœ‹åˆ°å…³äºè¿™å°ä¸»æœºçš„è¯¦ç»†çŠ¶æ€äº†,Statusè¿™ä¸ªæ˜¯å®æ—¶æŠ“å–çš„å½“å‰è¿™å°ä¸»æœºçš„å½“å‰çŠ¶æ€,è€Œä¸‹é¢çš„ä¸¤å¼ ç›‘æ§å›¾å½¢åˆ™æ˜¯è°ƒç”¨äº†Grafana."></a>ç‚¹å‡»ä¸Šå›¾çš„<code>è¯¦ç»†</code>å°±å¯ä»¥çœ‹åˆ°å…³äºè¿™å°ä¸»æœºçš„è¯¦ç»†çŠ¶æ€äº†,Statusè¿™ä¸ªæ˜¯å®æ—¶æŠ“å–çš„å½“å‰è¿™å°ä¸»æœºçš„å½“å‰çŠ¶æ€,è€Œä¸‹é¢çš„ä¸¤å¼ ç›‘æ§å›¾å½¢åˆ™æ˜¯è°ƒç”¨äº†Grafana.</h5><h5 id="æœ¬æƒ³è‡ªå·±ç”»å›¾çš„-ä½†æ˜¯æ²¡å¤ªå¤šçš„æ—¶é—´å»ç ”ç©¶å‰ç«¯æ–¹é¢çš„ä¸œè¥¿-å†µä¸”å›¾å½¢åŒ–çš„ä¸œè¥¿ä¹Ÿè›®å¤šäº†-å°±æ¯”å¦‚zabbixé‡Œé¢çš„ç›‘æ§å›¾ä¸ç¾è§‚çš„è¯åŠ ä¸Šgrafanaæ¸²æŸ“ï¼›å†æ¬¡å°±æ˜¯ELKé‡Œé¢çš„å›¾å½¢-æœ¬æƒ³å»è°ƒç”¨ELK-APIçš„-å‘ç°ç»“åˆåˆ°è¿™é‡Œä¹Ÿæ²¡å•¥åµç”¨-è¦çœ‹å›¾ç›´æ¥è®¿é—®Kibanaå°±è¡Œäº†ï¼›"><a href="#æœ¬æƒ³è‡ªå·±ç”»å›¾çš„-ä½†æ˜¯æ²¡å¤ªå¤šçš„æ—¶é—´å»ç ”ç©¶å‰ç«¯æ–¹é¢çš„ä¸œè¥¿-å†µä¸”å›¾å½¢åŒ–çš„ä¸œè¥¿ä¹Ÿè›®å¤šäº†-å°±æ¯”å¦‚zabbixé‡Œé¢çš„ç›‘æ§å›¾ä¸ç¾è§‚çš„è¯åŠ ä¸Šgrafanaæ¸²æŸ“ï¼›å†æ¬¡å°±æ˜¯ELKé‡Œé¢çš„å›¾å½¢-æœ¬æƒ³å»è°ƒç”¨ELK-APIçš„-å‘ç°ç»“åˆåˆ°è¿™é‡Œä¹Ÿæ²¡å•¥åµç”¨-è¦çœ‹å›¾ç›´æ¥è®¿é—®Kibanaå°±è¡Œäº†ï¼›" class="headerlink" title="æœ¬æƒ³è‡ªå·±ç”»å›¾çš„,ä½†æ˜¯æ²¡å¤ªå¤šçš„æ—¶é—´å»ç ”ç©¶å‰ç«¯æ–¹é¢çš„ä¸œè¥¿,å†µä¸”å›¾å½¢åŒ–çš„ä¸œè¥¿ä¹Ÿè›®å¤šäº†,å°±æ¯”å¦‚zabbixé‡Œé¢çš„ç›‘æ§å›¾ä¸ç¾è§‚çš„è¯åŠ ä¸Šgrafanaæ¸²æŸ“ï¼›å†æ¬¡å°±æ˜¯ELKé‡Œé¢çš„å›¾å½¢,æœ¬æƒ³å»è°ƒç”¨ELK APIçš„,å‘ç°ç»“åˆåˆ°è¿™é‡Œä¹Ÿæ²¡å•¥åµç”¨,è¦çœ‹å›¾ç›´æ¥è®¿é—®Kibanaå°±è¡Œäº†ï¼›"></a>æœ¬æƒ³è‡ªå·±ç”»å›¾çš„,ä½†æ˜¯æ²¡å¤ªå¤šçš„æ—¶é—´å»ç ”ç©¶å‰ç«¯æ–¹é¢çš„ä¸œè¥¿,å†µä¸”å›¾å½¢åŒ–çš„ä¸œè¥¿ä¹Ÿè›®å¤šäº†,å°±æ¯”å¦‚zabbixé‡Œé¢çš„ç›‘æ§å›¾ä¸ç¾è§‚çš„è¯åŠ ä¸Šgrafanaæ¸²æŸ“ï¼›å†æ¬¡å°±æ˜¯ELKé‡Œé¢çš„å›¾å½¢,æœ¬æƒ³å»è°ƒç”¨ELK APIçš„,å‘ç°ç»“åˆåˆ°è¿™é‡Œä¹Ÿæ²¡å•¥åµç”¨,è¦çœ‹å›¾ç›´æ¥è®¿é—®Kibanaå°±è¡Œäº†ï¼›</h5><p><img src="/2016/12/16/devops-demo/14818082338278.jpg">ï¿¼</p><h5 id="ä¸‹é¢ä¸¤å¼ æ˜¯å…³äºZabbixAPIçš„æ“ä½œ-æ·»åŠ æœåŠ¡å™¨æ˜¯é€šè¿‡ä¸Šä¼ ä¸€ä¸ªå›ºå®šæ ¼å¼çš„-xlsæ ¼å¼æ–‡ä»¶-ç„¶åå°å»è§£ææ–‡ä»¶å†…å®¹-è°ƒç”¨APIè¿›è¡Œä¸»æœºçš„æ·»åŠ -åˆ é™¤ä¸»æœºä¹ŸåŒæ ·è°ƒç”¨APIæ“ä½œå®ç°-ï¿¼"><a href="#ä¸‹é¢ä¸¤å¼ æ˜¯å…³äºZabbixAPIçš„æ“ä½œ-æ·»åŠ æœåŠ¡å™¨æ˜¯é€šè¿‡ä¸Šä¼ ä¸€ä¸ªå›ºå®šæ ¼å¼çš„-xlsæ ¼å¼æ–‡ä»¶-ç„¶åå°å»è§£ææ–‡ä»¶å†…å®¹-è°ƒç”¨APIè¿›è¡Œä¸»æœºçš„æ·»åŠ -åˆ é™¤ä¸»æœºä¹ŸåŒæ ·è°ƒç”¨APIæ“ä½œå®ç°-ï¿¼" class="headerlink" title="ä¸‹é¢ä¸¤å¼ æ˜¯å…³äºZabbixAPIçš„æ“ä½œ,æ·»åŠ æœåŠ¡å™¨æ˜¯é€šè¿‡ä¸Šä¼ ä¸€ä¸ªå›ºå®šæ ¼å¼çš„.xlsæ ¼å¼æ–‡ä»¶,ç„¶åå°å»è§£ææ–‡ä»¶å†…å®¹,è°ƒç”¨APIè¿›è¡Œä¸»æœºçš„æ·»åŠ ,åˆ é™¤ä¸»æœºä¹ŸåŒæ ·è°ƒç”¨APIæ“ä½œå®ç°.ï¿¼"></a>ä¸‹é¢ä¸¤å¼ æ˜¯å…³äºZabbixAPIçš„æ“ä½œ,æ·»åŠ æœåŠ¡å™¨æ˜¯é€šè¿‡ä¸Šä¼ ä¸€ä¸ªå›ºå®šæ ¼å¼çš„.xlsæ ¼å¼æ–‡ä»¶,ç„¶åå°å»è§£ææ–‡ä»¶å†…å®¹,è°ƒç”¨APIè¿›è¡Œä¸»æœºçš„æ·»åŠ ,åˆ é™¤ä¸»æœºä¹ŸåŒæ ·è°ƒç”¨APIæ“ä½œå®ç°.<img src="/2016/12/16/devops-demo/14818090897130.jpg">ï¿¼</h5><p><img src="/2016/12/16/devops-demo/14818092530495.jpg">ï¿¼</p><h5 id="å·®ä¸å¤šå®ç°çš„å°±æ˜¯ä¸Šé¢è¿™äº›-å…¶ä»–åŠŸèƒ½è¿˜åœ¨ç»§ç»­å­¦ä¹ ã€ç ”ç©¶ä¸­â€¦"><a href="#å·®ä¸å¤šå®ç°çš„å°±æ˜¯ä¸Šé¢è¿™äº›-å…¶ä»–åŠŸèƒ½è¿˜åœ¨ç»§ç»­å­¦ä¹ ã€ç ”ç©¶ä¸­â€¦" class="headerlink" title="å·®ä¸å¤šå®ç°çš„å°±æ˜¯ä¸Šé¢è¿™äº›,å…¶ä»–åŠŸèƒ½è¿˜åœ¨ç»§ç»­å­¦ä¹ ã€ç ”ç©¶ä¸­â€¦"></a>å·®ä¸å¤šå®ç°çš„å°±æ˜¯ä¸Šé¢è¿™äº›,å…¶ä»–åŠŸèƒ½è¿˜åœ¨ç»§ç»­å­¦ä¹ ã€ç ”ç©¶ä¸­â€¦</h5><h5 id="æœ›å„è·¯å¤§ç¥å‹¿å–·-å¸Œæœ›èƒ½å¾—åˆ°å„ä½å¤§ç¥çš„å»ºè®®-è°¢è°¢ã€‚"><a href="#æœ›å„è·¯å¤§ç¥å‹¿å–·-å¸Œæœ›èƒ½å¾—åˆ°å„ä½å¤§ç¥çš„å»ºè®®-è°¢è°¢ã€‚" class="headerlink" title="æœ›å„è·¯å¤§ç¥å‹¿å–·,å¸Œæœ›èƒ½å¾—åˆ°å„ä½å¤§ç¥çš„å»ºè®®,è°¢è°¢ã€‚"></a>æœ›å„è·¯å¤§ç¥å‹¿å–·,å¸Œæœ›èƒ½å¾—åˆ°å„ä½å¤§ç¥çš„å»ºè®®,è°¢è°¢ã€‚</h5><p><img src="/2016/12/16/devops-demo/14818127314229.jpg">ï¿¼</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è‡ªåŠ¨åŒ–è¿ç»´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerä¹‹gitlab-Ce</title>
      <link href="/2016/08/05/docker-zhigitlabce/"/>
      <url>/2016/08/05/docker-zhigitlabce/</url>
      
        <content type="html"><![CDATA[<h3 id="1ã€"><a href="#1ã€" class="headerlink" title="1ã€"></a>1ã€</h3><pre><code>docker pull gitlab-ce</code></pre><h3 id="2ã€"><a href="#2ã€" class="headerlink" title="2ã€"></a>2ã€</h3><pre><code>mkdir -p /data/gitlab/{config,data,logs}</code></pre><h3 id="3ã€"><a href="#3ã€" class="headerlink" title="3ã€"></a>3ã€</h3><pre><code>docker run --detach \-p 443:443 -p 80:80 -p 2222:22 \--name gitlab-ce \--restart=always \    --volume /data/gitlab/config:/etc/gitlab \     --volume /data/gitlab/logs:/var/log/gitlab \--volume /data/gitlab/data:/var/opt/gitlab \docker.io/gitlab/gitlab-ce</code></pre><h3 id="æˆ–è€…çœç•¥ç¬¬ä¸€ä¸ªæ­¥éª¤ç›´æ¥åˆ›å»ºç›®å½•ï¼Œç„¶årunèµ·æ¥ï¼›"><a href="#æˆ–è€…çœç•¥ç¬¬ä¸€ä¸ªæ­¥éª¤ç›´æ¥åˆ›å»ºç›®å½•ï¼Œç„¶årunèµ·æ¥ï¼›" class="headerlink" title="æˆ–è€…çœç•¥ç¬¬ä¸€ä¸ªæ­¥éª¤ç›´æ¥åˆ›å»ºç›®å½•ï¼Œç„¶årunèµ·æ¥ï¼›"></a>æˆ–è€…çœç•¥ç¬¬ä¸€ä¸ªæ­¥éª¤ç›´æ¥åˆ›å»ºç›®å½•ï¼Œç„¶årunèµ·æ¥ï¼›</h3><pre><code>docker run --detach -p 4433:443 -p 880:80 -p 2222:22 --name gitlab-ce --restart=always --volume /data/gitlab/config:/etc/gitlab --volume /data/gitlab/logs:/var/log/gitlab --volume /data/gitlab/data:/var/opt/gitlab docker.io/gitlab/gitlab-ce</code></pre><h3 id="GitLab-ä¿®æ”¹ä¸»æœºåä¸æ›´æ¢-IP-é…ç½®"><a href="#GitLab-ä¿®æ”¹ä¸»æœºåä¸æ›´æ¢-IP-é…ç½®" class="headerlink" title="GitLab ä¿®æ”¹ä¸»æœºåä¸æ›´æ¢ IP é…ç½®"></a>GitLab ä¿®æ”¹ä¸»æœºåä¸æ›´æ¢ IP é…ç½®</h3><p>vim /data/gitlab/config/gitlab.rb<br>13 liens:<br>æ·»åŠ ï¼š[å°†<code>external_url = 'http://git.example.com'</code>ä¿®æ”¹ä¸ºâ€™<a href="http://dockerå®¿ä¸»æœºip//]">http://dockerå®¿ä¸»æœºIP/\]</a><br>267 lines:<br>gitlab_rails[â€˜gitlab_shell_ssh_portâ€™] = 2222 #ä¿®æ”¹ä½¿ç”¨sshåè®®æ—¶çš„ç«¯å£2222</p><p>é‡è¯»é…ç½®:<br>è¿›å…¥å®¹å™¨ï¼Œç„¶åæ‰§è¡Œgitlab-ctl reconfigure</p><h3 id="è®¿é—®ï¼š"><a href="#è®¿é—®ï¼š" class="headerlink" title="è®¿é—®ï¼š"></a>è®¿é—®ï¼š</h3><p>ç”±äºsshä½¿ç”¨äº†é22æ ‡å‡†æ®µç«¯å£ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä½¿ç”¨è¿™æ ·è¿æ¥gitlabå³å¯.<br>git clone ssh://<a href="mailto:git@192.168.1.89">git@192.168.1.89</a>:2222/guomaoqiu/test.git</p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Flask+bootstrapå†™ç™»å½•é¡µé¢</title>
      <link href="/2016/07/14/flaskbootstrap-e5-86-99-e7-99-bb-e5-bd-95-e9-a1-b5-e9-9d-a2/"/>
      <url>/2016/07/14/flaskbootstrap-e5-86-99-e7-99-bb-e5-bd-95-e9-a1-b5-e9-9d-a2/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘æœ‰äº›éœ€æ±‚ã€æƒ³æ³•ï¼Œæ¯•ç«Ÿdevopsçš„é£è¿˜æ˜¯å¾ˆå¼ºçƒˆçš„å•Šï¼Œæ‰€ä»¥å°±è·Ÿé£å­¦å­¦devæ–¹é¢çš„ä¸œè¥¿ï¼› flaskæ˜¯ä¸€ä¸ªå¾ˆå°å·§å¾ˆæ–¹ä¾¿çš„webframeï¼Œå¬æœ‹å‹è¯´èµ·djangoéå¸¸çš„é‡ï¼Œäºæ˜¯æˆ‘å°±åœ¨è¿˜æœ‰ç‚¹pythonåŸºç¡€çš„èƒ½åŠ›ä¸‹é€‰æ‹©flaskå­¦å­¦ï¼›å‡†å¤‡ç”¨è¿™ä¸ªæ¡†æ¶å¼€å‘æ–°çš„å¹³å°ï¼Œé¦–å…ˆå°±è¦æœ‰ç”¨æˆ·ç™»å½•é¡µé¢ï¼Œç”¨flaskå¯ä»¥è¿™æ ·å®ç°ï¼š ä»£ç ç»“æ„ï¼š</p><p>flasky<br>â”œâ”€â”€ run.py<br>â”œâ”€â”€ static<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ av1.jpg<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ av2.jpg<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ av3.jpg<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ bootstrap.min.css<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ bootstrap.min.js<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ bootstrap-responsive.min.css<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ excanvas.min.js<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ fullcalendar.css<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ fullcalendar.min.js<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ glyphicons-halflings.png<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ GNU-Linux-Logo-Penguin-SVG.png<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.flot.min.js<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.flot.resize.min.js<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.min.js<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.peity.min.js<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ jquery.ui.custom.js<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ logo.png<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ Tux.jpg<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.dashboard.js<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.grey.css<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.js<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.login.css<br>â”‚&nbsp;&nbsp; â”œâ”€â”€ unicorn.login.js<br>â”‚&nbsp;&nbsp; â””â”€â”€ unicorn.main.css<br>â””â”€â”€ templates<br>    â”œâ”€â”€ base.html<br>    â”œâ”€â”€ check.html<br>    â”œâ”€â”€ index.html<br>    â”œâ”€â”€ login.html<br>    â””â”€â”€ upload.html</p><p>&nbsp; å‰ç«¯å°±ç”¨bootstrapå±•ç¤ºï¼Œlogin.html</p><figure class="highlight django"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">{% <span class="name"><span class="name">extends</span></span> \"base.html\" %}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">{% <span class="name"><span class="name">block</span></span> title %}</span><span class="language-xml"> Dachen FTP </span><span class="template-tag">{% <span class="name"><span class="name">endblock</span></span> %}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="template-tag">{% <span class="name"><span class="name">block</span></span> body %}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"logo"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"{ {url_for('static',filename='GNU-Linux-Logo-Penguin-SVG.png')}}"</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"loginbox"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"loginform"</span> <span class="attr">class</span>=<span class="string">"form-vertical"</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">p</span>&gt;</span>Sing in to blog.sctux.com<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="comment">&lt;!--&lt;div class="control-group"&gt; --&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"controls"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-prepend"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"{ {request.form.username}}"</span> <span class="attr">placeholder</span>=<span class="string">"Username"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               &lt;!\-\- <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-group"</span>&gt;</span> --&gt;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"controls"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-prepend"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                          <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"pass"</span> <span class="attr">placeholder</span>=<span class="string">"Password "</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-90 col-md-offset-12"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>Sign in<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">{% <span class="name"><span class="name">if</span></span> error %}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"red"</span>&gt;</span>{ { error }}<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      </span><span class="template-tag">{% <span class="name"><span class="name">endif</span></span> %}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        </span><span class="template-tag">{% <span class="name"><span class="name">endblock</span></span> %}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure><p>&nbsp; run.pyå†…å®¹ï¼š</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">\<span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask.ext.wtf <span class="keyword">import</span> Form</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render\_template, redirect, url\_<span class="keyword">for</span></span><br><span class="line"></span><br><span class="line">app = Flask(\_\_name\_\_)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/login'</span>,methods=\[<span class="string">'POST'</span>,<span class="string">'GET'</span>\]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">  error=<span class="literal">False</span></span><br><span class="line">  <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">    <span class="keyword">if</span> request.form\[<span class="string">'username'</span>\] != <span class="string">'user1'</span> <span class="keyword">or</span> request.form\[<span class="string">'pass'</span>\] != <span class="string">'user1@1qaz'</span>:</span><br><span class="line">      error=<span class="string">"username or password error !"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">  <span class="keyword">return</span> render_template(<span class="string">'login.html'</span>,error=error)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/index'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">  <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>,result=result)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/upload'</span>,methods=\[<span class="string">'GET'</span>,<span class="string">'POST'</span>\]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">  <span class="keyword">return</span> render_template(<span class="string">'upload.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/check'</span>,methods=\[<span class="string">'POST'</span>,<span class="string">'GET'</span>\]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>():</span><br><span class="line">  <span class="keyword">return</span> render_template(<span class="string">'check.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/logout'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">  <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> \_\_name\_\_==<span class="string">"\_\_main\_\_"</span>:</span><br><span class="line">   app.run(debug=<span class="literal">True</span>,host=<span class="string">'xxxxxxxxx'</span>,port=<span class="number">4000</span>)</span><br></pre></td></tr></tbody></table></figure><p>å¯åŠ¨ python run.py è®¿é—® <a href="http://xxxxxxxxx:4000/">http://xxxxxxxxx:4000/</a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/07/login-page-1.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/07/login-page-1.jpg" alt="login page"></a> ç™»å½•ä¸»é¡µçš„æ•ˆæœï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/07/2222.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/07/2222.jpg" alt="index"></a> å¥½å•¦ï¼Œä¸€ä¸ªç®€å•çš„ç™»å½•é¡µé¢å°±å†™å¥½å•¦ï¼›flask å€¼å¾—ä½ æ‹¥æœ‰!</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
          <category> è„šæœ¬ç¼–ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bootstrap </tag>
            
            <tag> flask </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jqå‘½ä»¤-åœ¨å‘½ä»¤è¡Œç›´æ¥è§£æJsonæ–‡æ¡£</title>
      <link href="/2016/06/20/jq-ming-ling-zai-ming-ling-xing-zhi-jie-jie-xijson/"/>
      <url>/2016/06/20/jq-ming-ling-zai-ming-ling-xing-zhi-jie-jie-xijson/</url>
      
        <content type="html"><![CDATA[<h4 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><pre><code>yum install -y libtool &amp;&amp; \wget https://github.com/stedolan/jq/releases/download/jq-1.5/jq-1.5.tar.gz &amp;&amp; \tar -xf jq-1.5.tar.gz -C /usr/local  &amp;&amp; \cd /usr/local/jq-1.5 &amp;&amp; \./configure --disable-maintainer-mode &amp;&amp; \make LDFLAGS=-all-static &amp;&amp; \make install &amp;&amp; \cp /usr/local/jq-1.5/jq /sbin/ \echo "ç¨‹åºå·²å®‰è£…: `which jq`"</code></pre><h4 id="ä¸¾ä¸ªæ —å­ï¼Œå¦‚ï¼š"><a href="#ä¸¾ä¸ªæ —å­ï¼Œå¦‚ï¼š" class="headerlink" title="ä¸¾ä¸ªæ —å­ï¼Œå¦‚ï¼š"></a>ä¸¾ä¸ªæ —å­ï¼Œå¦‚ï¼š</h4><h5 id="æˆ‘è¿™é‡Œæœ‰ä¸ªAPIè¯·æ±‚ï¼Œåœ¨ç»ˆç«¯ä¸­å¾—åˆ°çš„ç»“æœæ˜¯ä¸€ä¸²jsonå­—ç¬¦ä¸²ï¼Œä½†æ˜¯çœ‹èµ·æ¥ä¸æ˜¯é‚£ä¹ˆè§„æ•´ï¼Œä¸€ä¸‹å­è¿˜å¾ˆéš¾åˆ¤æ–­æ˜¯ä»€ä¹ˆæ ¼å¼ï¼›"><a href="#æˆ‘è¿™é‡Œæœ‰ä¸ªAPIè¯·æ±‚ï¼Œåœ¨ç»ˆç«¯ä¸­å¾—åˆ°çš„ç»“æœæ˜¯ä¸€ä¸²jsonå­—ç¬¦ä¸²ï¼Œä½†æ˜¯çœ‹èµ·æ¥ä¸æ˜¯é‚£ä¹ˆè§„æ•´ï¼Œä¸€ä¸‹å­è¿˜å¾ˆéš¾åˆ¤æ–­æ˜¯ä»€ä¹ˆæ ¼å¼ï¼›" class="headerlink" title="æˆ‘è¿™é‡Œæœ‰ä¸ªAPIè¯·æ±‚ï¼Œåœ¨ç»ˆç«¯ä¸­å¾—åˆ°çš„ç»“æœæ˜¯ä¸€ä¸²jsonå­—ç¬¦ä¸²ï¼Œä½†æ˜¯çœ‹èµ·æ¥ä¸æ˜¯é‚£ä¹ˆè§„æ•´ï¼Œä¸€ä¸‹å­è¿˜å¾ˆéš¾åˆ¤æ–­æ˜¯ä»€ä¹ˆæ ¼å¼ï¼›"></a>æˆ‘è¿™é‡Œæœ‰ä¸ªAPIè¯·æ±‚ï¼Œåœ¨ç»ˆç«¯ä¸­å¾—åˆ°çš„ç»“æœæ˜¯ä¸€ä¸²jsonå­—ç¬¦ä¸²ï¼Œä½†æ˜¯çœ‹èµ·æ¥ä¸æ˜¯é‚£ä¹ˆè§„æ•´ï¼Œä¸€ä¸‹å­è¿˜å¾ˆéš¾åˆ¤æ–­æ˜¯ä»€ä¹ˆæ ¼å¼ï¼›</h5><pre><code>[root@localhost ~]# curl -s http://SERVER_IP/health/monitor/service{"data":{"serCode":"0","serDesc":"æœåŠ¡æ­£å¸¸"},"resultCode":1}</code></pre><h5 id="äºæ˜¯é€šè¿‡jqè¿™ä¸ªå‘½ä»¤æˆ‘ä»¬æ ¼å¼åŒ–ä¸€ä¸‹ï¼Œç»ˆç«¯é‡Œé¢çœ‹åˆ°çš„ç»“æœå°±æ˜¯ä¸‹é¢è¿™æ ·çš„å•¦"><a href="#äºæ˜¯é€šè¿‡jqè¿™ä¸ªå‘½ä»¤æˆ‘ä»¬æ ¼å¼åŒ–ä¸€ä¸‹ï¼Œç»ˆç«¯é‡Œé¢çœ‹åˆ°çš„ç»“æœå°±æ˜¯ä¸‹é¢è¿™æ ·çš„å•¦" class="headerlink" title="äºæ˜¯é€šè¿‡jqè¿™ä¸ªå‘½ä»¤æˆ‘ä»¬æ ¼å¼åŒ–ä¸€ä¸‹ï¼Œç»ˆç«¯é‡Œé¢çœ‹åˆ°çš„ç»“æœå°±æ˜¯ä¸‹é¢è¿™æ ·çš„å•¦"></a>äºæ˜¯é€šè¿‡jqè¿™ä¸ªå‘½ä»¤æˆ‘ä»¬æ ¼å¼åŒ–ä¸€ä¸‹ï¼Œç»ˆç«¯é‡Œé¢çœ‹åˆ°çš„ç»“æœå°±æ˜¯ä¸‹é¢è¿™æ ·çš„å•¦</h5><pre><code>[root@salt-api ~]# curl -s http://SERVER_IP/health/monitor/service | jq{  "data": {    "serCode": "0",    "serDesc": "æœåŠ¡æ­£å¸¸"  },  "resultCode": 1}</code></pre>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flask-Login AttributeError: &#39;Bool&#39; Object Has No Attribute &#39;__Call__&#39;</title>
      <link href="/2016/06/06/flasklogin-yong-hu-pan-duan-shi-hou-bao-cuo/"/>
      <url>/2016/06/06/flasklogin-yong-hu-pan-duan-shi-hou-bao-cuo/</url>
      
        <content type="html"><![CDATA[<h4 id="ä»Šå¤©åœ¨ä½¿ç”¨flask-loginæ·»åŠ ç”¨æˆ·è®¤è¯çš„æ—¶å€™æœåŠ¡å™¨å‡ºç°äº†æŠ¥é”™"><a href="#ä»Šå¤©åœ¨ä½¿ç”¨flask-loginæ·»åŠ ç”¨æˆ·è®¤è¯çš„æ—¶å€™æœåŠ¡å™¨å‡ºç°äº†æŠ¥é”™" class="headerlink" title="ä»Šå¤©åœ¨ä½¿ç”¨flask-loginæ·»åŠ ç”¨æˆ·è®¤è¯çš„æ—¶å€™æœåŠ¡å™¨å‡ºç°äº†æŠ¥é”™"></a>ä»Šå¤©åœ¨ä½¿ç”¨flask-loginæ·»åŠ ç”¨æˆ·è®¤è¯çš„æ—¶å€™æœåŠ¡å™¨å‡ºç°äº†æŠ¥é”™</h4><p><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/06/0.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/06/0-300x140.jpg" alt="0"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/06/1.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/06/1.jpg" alt="1"></a></p><h4 id="è€Œæˆ‘çš„-base-htmlæ˜¯è¿™æ ·å†™çš„ï¼š"><a href="#è€Œæˆ‘çš„-base-htmlæ˜¯è¿™æ ·å†™çš„ï¼š" class="headerlink" title="è€Œæˆ‘çš„ base.htmlæ˜¯è¿™æ ·å†™çš„ï¼š"></a>è€Œæˆ‘çš„ base.htmlæ˜¯è¿™æ ·å†™çš„ï¼š</h4><p><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/06/2.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/06/2-300x56.jpg" alt="2"></a> ï¿¼å»çœ‹å®˜æ–¹æ–‡æ¡£å§ï¼Œé€‰æ‹©å¯¹åº”ç‰ˆæœ¬çš„æ–‡æ¡£(æˆ‘è¿™é‡Œæ˜¯0.3.1): <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/06/3.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/06/3-300x78.jpg" alt="3"></a> ï¿¼å†çœ‹çœ‹å…¶å‰é¢çš„ç‰ˆæœ¬æ˜¯ä¸æ˜¯è¿™æ ·å®šä¹‰çš„ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/06/4.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/06/4-300x68.jpg" alt="4"></a>ï¿¼</p><h4 id="çœ‹å§-ç‰ˆæœ¬é—®é¢˜é€ æˆã€‚"><a href="#çœ‹å§-ç‰ˆæœ¬é—®é¢˜é€ æˆã€‚" class="headerlink" title="çœ‹å§ ç‰ˆæœ¬é—®é¢˜é€ æˆã€‚"></a>çœ‹å§ ç‰ˆæœ¬é—®é¢˜é€ æˆã€‚</h4>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>åƒé‡Œé©¬å¸¸æœ‰ï¼Œè€Œä¼¯ä¹ä¸å¸¸æœ‰</title>
      <link href="/2016/05/08/qianlima/"/>
      <url>/2016/05/08/qianlima/</url>
      
        <content type="html"><![CDATA[<p>ä¸–æœ‰ä¼¯ä¹ï¼Œç„¶åæœ‰åƒé‡Œé©¬ã€‚åƒé‡Œé©¬å¸¸æœ‰ï¼Œè€Œä¼¯ä¹ä¸å¸¸æœ‰ï¼›æ•…è™½æœ‰åé©¬ï¼Œç¥—è¾±äºå¥´éš¶äººä¹‹æ‰‹ï¼Œéªˆæ­»äºæ§½æ¥ä¹‹é—´ï¼Œä¸ä»¥åƒé‡Œç§°ä¹Ÿã€‚ é©¬ä¹‹åƒé‡Œè€…ï¼Œä¸€é£Ÿæˆ–å°½ç²Ÿä¸€çŸ³ã€‚é£Ÿé©¬è€…ä¸çŸ¥å…¶èƒ½åƒé‡Œè€Œé£Ÿä¹Ÿï¼›æ˜¯é©¬ä¹Ÿï¼Œè™½æœ‰åƒé‡Œä¹‹èƒ½ï¼Œé£Ÿä¸é¥±ï¼ŒåŠ›ä¸è¶³ï¼Œæ‰ç¾ä¸å¤–è§ï¼Œä¸”æ¬²ä¸å¸¸é©¬ç­‰ä¸å¯å¾—ï¼Œå®‰æ±‚å…¶èƒ½åƒé‡Œä¹Ÿï¼Ÿ ç­–ä¹‹ä¸ä»¥å…¶é“ï¼Œé£Ÿä¹‹ä¸èƒ½å°½å…¶æï¼Œé¸£ä¹‹è€Œä¸èƒ½é€šå…¶æ„ï¼Œæ‰§ç­–è€Œä¸´ä¹‹æ›°ï¼šâ€œå¤©ä¸‹æ— é©¬ï¼â€å‘œå‘¼ï¼å…¶çœŸæ— é©¬é‚ªï¼Ÿå…¶çœŸä¸çŸ¥é©¬ä¹Ÿï¼</p>]]></content>
      
      
      <categories>
          
          <category> å¿ƒæƒ…éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>MongoDBåŸºæœ¬æ“ä½œ</title>
      <link href="/2016/05/02/mongodb-ji-ben-cao-zuo/"/>
      <url>/2016/05/02/mongodb-ji-ben-cao-zuo/</url>
      
        <content type="html"><![CDATA[<h4 id="1-åˆ é™¤ç”¨æˆ·"><a href="#1-åˆ é™¤ç”¨æˆ·" class="headerlink" title="1.åˆ é™¤ç”¨æˆ·"></a>1.åˆ é™¤ç”¨æˆ·</h4><pre><code>mongo&gt;use db1mongo&gt;show users;mongo&gt;db.dropUser("User_name")</code></pre><h4 id="2-å¤‡ä»½"><a href="#2-å¤‡ä»½" class="headerlink" title="2.å¤‡ä»½"></a>2.å¤‡ä»½</h4><pre><code>mongodump -h 127.0.0.1:27017 -d health_init -u=health_init -p=health_init -o /tmp/</code></pre><h4 id="3-æ¢å¤"><a href="#3-æ¢å¤" class="headerlink" title="3.æ¢å¤"></a>3.æ¢å¤</h4><pre><code>mongorestore -d health_test --drop -u=dachenadm -p=dachen@ad /tmp/health_ini</code></pre><h4 id="4-æˆæƒï¼š"><a href="#4-æˆæƒï¼š" class="headerlink" title="4.æˆæƒï¼š"></a>4.æˆæƒï¼š</h4><pre><code>#åˆ›å»ºä¸€ä¸ªè§’è‰²ï¼šuse amdin;db.createRole({role:'sysadmin',roles:[],privileges:[{resource:{anyResource:true},actions:['anyAction']}]})#æˆæƒä¸€ä¸ªç”¨æˆ·use health;db.createUser(  {      user: "health",      pwd:  "healthnx",      roles: [{ role: "sysadmin", db: "admin" }]  }</code></pre><h4 id="5-mongoè¿œç¨‹æ‰§è¡Œéœ€è¦è®¤è¯çš„æœåŠ¡å™¨çš„jsæ–‡ä»¶"><a href="#5-mongoè¿œç¨‹æ‰§è¡Œéœ€è¦è®¤è¯çš„æœåŠ¡å™¨çš„jsæ–‡ä»¶" class="headerlink" title="5. mongoè¿œç¨‹æ‰§è¡Œéœ€è¦è®¤è¯çš„æœåŠ¡å™¨çš„jsæ–‡ä»¶"></a>5. mongoè¿œç¨‹æ‰§è¡Œéœ€è¦è®¤è¯çš„æœåŠ¡å™¨çš„jsæ–‡ä»¶</h4><pre><code>/usr/bin/mongo -h 10.251.225.205:27017/health -u health -p healthnx update.js</code></pre><h4 id="6-æŸ¥çœ‹collectionå†…å®¹ï¼š"><a href="#6-æŸ¥çœ‹collectionå†…å®¹ï¼š" class="headerlink" title="6.æŸ¥çœ‹collectionå†…å®¹ï¼š"></a>6.æŸ¥çœ‹collectionå†…å®¹ï¼š</h4><pre><code>db.d_role.find()</code></pre><h4 id="7-æ›´æ–°æ“ä½œ"><a href="#7-æ›´æ–°æ“ä½œ" class="headerlink" title="7.æ›´æ–°æ“ä½œ"></a>7.æ›´æ–°æ“ä½œ</h4><h5 id="Mongodbæ•°æ®æ›´æ–°å‘½ä»¤"><a href="#Mongodbæ•°æ®æ›´æ–°å‘½ä»¤" class="headerlink" title="Mongodbæ•°æ®æ›´æ–°å‘½ä»¤"></a>Mongodbæ•°æ®æ›´æ–°å‘½ä»¤</h5><h5 id="Mongodbæ›´æ–°æœ‰ä¸¤ä¸ªå‘½ä»¤ï¼šupdateã€saveã€‚"><a href="#Mongodbæ›´æ–°æœ‰ä¸¤ä¸ªå‘½ä»¤ï¼šupdateã€saveã€‚" class="headerlink" title="Mongodbæ›´æ–°æœ‰ä¸¤ä¸ªå‘½ä»¤ï¼šupdateã€saveã€‚"></a>Mongodbæ›´æ–°æœ‰ä¸¤ä¸ªå‘½ä»¤ï¼šupdateã€saveã€‚</h5><h5 id="updateå‘½ä»¤æ ¼å¼"><a href="#updateå‘½ä»¤æ ¼å¼" class="headerlink" title="updateå‘½ä»¤æ ¼å¼:"></a>updateå‘½ä»¤æ ¼å¼:</h5><pre><code>db.collection.update(criteria,objNew,upsert,multi)</code></pre><h5 id="å‚æ•°è¯´æ˜ï¼š"><a href="#å‚æ•°è¯´æ˜ï¼š" class="headerlink" title="å‚æ•°è¯´æ˜ï¼š"></a>å‚æ•°è¯´æ˜ï¼š</h5><h5 id="criteriaï¼šæŸ¥è¯¢æ¡ä»¶"><a href="#criteriaï¼šæŸ¥è¯¢æ¡ä»¶" class="headerlink" title="criteriaï¼šæŸ¥è¯¢æ¡ä»¶"></a>criteriaï¼šæŸ¥è¯¢æ¡ä»¶</h5><h5 id="objNewï¼šupdateå¯¹è±¡å’Œä¸€äº›æ›´æ–°æ“ä½œç¬¦"><a href="#objNewï¼šupdateå¯¹è±¡å’Œä¸€äº›æ›´æ–°æ“ä½œç¬¦" class="headerlink" title="objNewï¼šupdateå¯¹è±¡å’Œä¸€äº›æ›´æ–°æ“ä½œç¬¦"></a>objNewï¼šupdateå¯¹è±¡å’Œä¸€äº›æ›´æ–°æ“ä½œç¬¦</h5><h5 id="upsertï¼šå¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ï¼Œæ˜¯å¦æ’å…¥objNewè¿™ä¸ªæ–°çš„æ–‡æ¡£ï¼Œtrueä¸ºæ’å…¥ï¼Œé»˜è®¤ä¸ºfalseï¼Œä¸æ’å…¥ã€‚"><a href="#upsertï¼šå¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ï¼Œæ˜¯å¦æ’å…¥objNewè¿™ä¸ªæ–°çš„æ–‡æ¡£ï¼Œtrueä¸ºæ’å…¥ï¼Œé»˜è®¤ä¸ºfalseï¼Œä¸æ’å…¥ã€‚" class="headerlink" title="upsertï¼šå¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ï¼Œæ˜¯å¦æ’å…¥objNewè¿™ä¸ªæ–°çš„æ–‡æ¡£ï¼Œtrueä¸ºæ’å…¥ï¼Œé»˜è®¤ä¸ºfalseï¼Œä¸æ’å…¥ã€‚"></a>upsertï¼šå¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ï¼Œæ˜¯å¦æ’å…¥objNewè¿™ä¸ªæ–°çš„æ–‡æ¡£ï¼Œtrueä¸ºæ’å…¥ï¼Œé»˜è®¤ä¸ºfalseï¼Œä¸æ’å…¥ã€‚</h5><h5 id="multiï¼šé»˜è®¤æ˜¯falseï¼Œåªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ã€‚å¦‚æœä¸ºtrueï¼ŒæŠŠæŒ‰æ¡ä»¶æŸ¥è¯¢så‡ºæ¥çš„è®°å½•å…¨éƒ¨æ›´æ–°ã€‚"><a href="#multiï¼šé»˜è®¤æ˜¯falseï¼Œåªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ã€‚å¦‚æœä¸ºtrueï¼ŒæŠŠæŒ‰æ¡ä»¶æŸ¥è¯¢så‡ºæ¥çš„è®°å½•å…¨éƒ¨æ›´æ–°ã€‚" class="headerlink" title="multiï¼šé»˜è®¤æ˜¯falseï¼Œåªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ã€‚å¦‚æœä¸ºtrueï¼ŒæŠŠæŒ‰æ¡ä»¶æŸ¥è¯¢så‡ºæ¥çš„è®°å½•å…¨éƒ¨æ›´æ–°ã€‚"></a>multiï¼šé»˜è®¤æ˜¯falseï¼Œåªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡è®°å½•ã€‚å¦‚æœä¸ºtrueï¼ŒæŠŠæŒ‰æ¡ä»¶æŸ¥è¯¢så‡ºæ¥çš„è®°å½•å…¨éƒ¨æ›´æ–°ã€‚</h5><h2 id="8-mongodbçš„æ–‡æ¡£å¯¼å…¥å¯¼å‡ºï¼š"><a href="#8-mongodbçš„æ–‡æ¡£å¯¼å…¥å¯¼å‡ºï¼š" class="headerlink" title="8.mongodbçš„æ–‡æ¡£å¯¼å…¥å¯¼å‡ºï¼š"></a>8.mongodbçš„æ–‡æ¡£å¯¼å…¥å¯¼å‡ºï¼š</h2><pre><code>1.  mongoimport -h 127.0.0.1:27017  -u USENAME -p PASSWORD -c COLLECTIONS b_hospitaldept.json 2.  mongoexport -h 127.0.0.1:27017 -d DB -u USENAME -p PASSWORD -c COLLECTIONS -o checkin_b_hospitaldept.json</code></pre><h2 id="9-å¯¹collectionsæ“ä½œ"><a href="#9-å¯¹collectionsæ“ä½œ" class="headerlink" title="9.å¯¹collectionsæ“ä½œ"></a>9.å¯¹collectionsæ“ä½œ</h2><pre><code>1.  use demodb &nbsp;//ä½¿ç”¨demodbï¼Œä»¥ä¸‹å‡è®¾æ“ä½œçš„collectionæ˜¯foo2.  db.foo.remove({"id":"bar"}) &nbsp;//åˆ é™¤ä¸€æ¡æ•°æ®3.  db.foo.remove() //åˆ é™¤fooä¸­çš„æ‰€æœ‰è®°å½•ï¼Œä½†æ˜¯fooè¿˜å­˜åœ¨ï¼Œshow collectionè¿˜å¯ä»¥çœ‹åˆ°foo4.  db.foo.drop() &nbsp;//åˆ é™¤fooè¿™ä¸ªcollectionï¼Œï¼ˆshow collectionå·²ç»çœ‹ä¸åˆ°fooäº†ï¼‰ä½†æ˜¯æŸ¥çœ‹æ•°æ®æ–‡ä»¶å‘ç°å¤§å°ä¸å˜ï¼ŒMongodbä¸ä¼šè‡ªåŠ¨é‡Šæ”¾æ–‡ä»¶ç©ºé—´5.  db.repairDatabase() &nbsp;//æ‰§è¡Œè¿™ä¸ªå‘½ä»¤åï¼ŒMongodbä¼šæŠŠä¸éœ€è¦çš„ç©ºé—´é‡Šæ”¾å‡ºæ¥</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Jenkinsé…ç½®ä»¤ç‰Œè¿œç¨‹è§¦å‘é¡¹ç›®æ„å»º</title>
      <link href="/2016/04/18/jenkins-e9-85-8d-e7-bd-ae-e4-bb-a4-e7-89-8c-e8-bf-9c-e7-a8-8b-e8-a7-a6-e5-8f-91-e9-a1-b9-e7-9b-ae-e6-9e-84-e5-bb-ba/"/>
      <url>/2016/04/18/jenkins-e9-85-8d-e7-bd-ae-e4-bb-a4-e7-89-8c-e8-bf-9c-e7-a8-8b-e8-a7-a6-e5-8f-91-e9-a1-b9-e7-9b-ae-e6-9e-84-e5-bb-ba/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨æ‰§è¡ŒJenkinsçš„é¡¹ç›®æ„å»ºçš„æ—¶å€™ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡webç®¡ç†ç•Œé¢ä¸­çš„â€æ„å»ºâ€æ¥æ‰§è¡Œé¡¹ç›®æ„å»ºæ“ä½œï¼Œä½†æ˜¯é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡é¡¹ç›®é…ç½®ä¸­çš„â€æ„å»ºè§¦å‘å™¨â€æ¥è§¦å‘æ„å»ºæ“ä½œï¼Œå…¶ä¸­â€æ„å»ºè§¦å‘å™¨â€æœ‰ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡é…ç½®ä»¤ç‰Œè¿œç¨‹è§¦å‘é¡¹ç›®æ„å»ºï¼›è¦å¯ç”¨Token(ä»¤ç‰Œ)è¿œç¨‹è§¦å‘é¡¹ç›®æ„å»ºé¦–å…ˆè¦ä¿è¯JenkinsæœåŠ¡å®‰è£…äº†<a href="https://wiki.jenkins-ci.org/display/JENKINS/Build+Token+Root+Plugin">build-token-root</a>&nbsp;æ’ä»¶ï¼Œå¹¶ä¸”é…ç½®äº†Jenkinsçš„èº«ä»½éªŒè¯(ä¸æ˜¯å¿…é¡»)ã€‚ è¯¥å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ’ä»¶å‘¢ï¼Ÿ æ‰“å¼€ä¸€ä¸ªJenkins Project â€“&gt; é…ç½® <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/04/11.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/04/11.jpg" alt="build"></a>ç„¶ååœ¨æˆ‘ä»¬è‡ªå·±çš„å·¥ä½œæœºä¸Šç¼–å†™ä¸€æ¡è¿œç¨‹æ‰§è¡Œçš„å‘½ä»¤å³å¯ï¼Œå…¶å®å°±æ˜¯ä¸€æ¡POSTè¯·æ±‚ï¼Œå¦‚ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/04/11111.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/04/11111.jpg" alt="11111"></a>  åœ¨æˆ‘ä»¬å·¥ä½œæœºä¸Šç›´æ¥æ‰§è¡Œè¯¥curlè¯·æ±‚å°±å¯ä»¥æ‰§è¡Œé¡¹ç›®çš„æ„å»ºå•¦ï¼Œè€Œä¸å†éœ€è¦ç‚¹å‡»é¡µé¢ä¸­çš„â€æ„å»ºâ€ï¼Œç”¨è¿™ç§æ–¹å¼ä¸»è¦è¿˜æ˜¯ä¹ æƒ¯å§ï¼Œæ•²å‘½ä»¤çš„æ„Ÿè§‰è¿˜æ˜¯æŒºå¥½çš„ï¼›ä¸€èˆ¬ä¸ºäº†æ–¹ä¾¿æˆ‘éƒ½æ˜¯å†™åˆ°ä¸€ä¸ªè„šæœ¬é‡Œé¢å»æ‰§è¡Œï¼Œå¦‚æœæœ‰å¤šä¸ªé¡¹ç›®ä¹Ÿå¯ä»¥é€šè¿‡ä¼ å‚å•Šï¼Œå¤šä¸ªå‚æ•°(é¡¹ç›®)ä¸€èµ·æ‰§è¡Œæ„å»ºï¼›çœ‹è‡ªå·±çš„å·¥ä½œç¯å¢ƒè€Œå®šå§ï¼Œåœ¨è§£å†³é—®é¢˜çš„æƒ…å†µä¸‹ï¼ŒåŠ å¿«ä¸ªäººå·¥ä½œæ•ˆç‡çš„æƒ…å†µä¸‹è¿˜æ˜¯æ€ä¹ˆç®€å•æ€ä¹ˆæ¥å§ã€‚ä¸‹å›¾å°±æ˜¯æˆ‘æ‰§è¡Œäº†è¿™æ¡å‘½ä»¤çš„ç»“æœï¼Œè·Ÿæˆ‘ä»¬æ‰‹åŠ¨åœ¨webç•Œé¢ç‚¹å‡»â€æ„å»ºâ€æ˜¯ä¸€æ ·çš„æ•ˆæœã€‚ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/04/222.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/04/222.jpg" alt="222"></a></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Lvmçš„åˆ›å»º</title>
      <link href="/2016/03/29/lvm-chuang-jian/"/>
      <url>/2016/03/29/lvm-chuang-jian/</url>
      
        <content type="html"><![CDATA[<h4 id="1-æŸ¥çœ‹ç£ç›˜ï¼š"><a href="#1-æŸ¥çœ‹ç£ç›˜ï¼š" class="headerlink" title="1. æŸ¥çœ‹ç£ç›˜ï¼š"></a>1. æŸ¥çœ‹ç£ç›˜ï¼š</h4><pre><code>[root@localhost ~]# fdisk -l......ç£ç›˜ /dev/sdbï¼š21.5 GB, 21474836480 å­—èŠ‚ï¼Œ41943040 ä¸ªæ‰‡åŒºUnits = æ‰‡åŒº of 1 * 512 = 512 bytesæ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚ç£ç›˜ /dev/sdcï¼š21.5 GB, 21474836480 å­—èŠ‚ï¼Œ41943040 ä¸ªæ‰‡åŒºUnits = æ‰‡åŒº of 1 * 512 = 512 bytesæ‰‡åŒºå¤§å°(é€»è¾‘/ç‰©ç†)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚I/O å¤§å°(æœ€å°/æœ€ä½³)ï¼š512 å­—èŠ‚ / 512 å­—èŠ‚......</code></pre><h4 id="2-å¯¹ä¸¤å—ç£ç›˜è¿›è¡Œlvmæ ¼å¼åˆ†åŒº"><a href="#2-å¯¹ä¸¤å—ç£ç›˜è¿›è¡Œlvmæ ¼å¼åˆ†åŒº" class="headerlink" title="2. å¯¹ä¸¤å—ç£ç›˜è¿›è¡Œlvmæ ¼å¼åˆ†åŒº"></a>2. å¯¹ä¸¤å—ç£ç›˜è¿›è¡Œlvmæ ¼å¼åˆ†åŒº</h4><pre><code>fdisk /dev/sdb/ --&gt; n --&gt; p --&gt; åˆ†åŒºå·(é»˜è®¤) --&gt; èµ·å§‹æ‰‡åŒº(é»˜è®¤) --&gt; lastæ‰‡åŒº(é»˜è®¤)# ä¿®æ”¹åˆ†åŒºæ ¼å¼t --&gt; 8e Linux LVM(åˆ†åŒºæ ¼å¼ä¸ºlvm) --&gt; w (ä¿å­˜)# é€€å‡ºåå¯¹ç£ç›˜/dev/sdc æ‰§è¡Œç›¸åŒæ“ä½œå³å¯</code></pre><h4 id="3-åˆ›å»ºç‰©ç†å·-PV"><a href="#3-åˆ›å»ºç‰©ç†å·-PV" class="headerlink" title="3. åˆ›å»ºç‰©ç†å·(PV)"></a>3. åˆ›å»ºç‰©ç†å·(PV)</h4><pre><code>[root@localhost ~]# pvcreate /dev/sdb1  Physical volume "/dev/sdb1" successfully created[root@localhost ~]# pvcreate /dev/sdc1  Physical volume "/dev/sdc1" successfully created[root@localhost ~]## pvdisplay æ˜¾ç¤ºè¯¦ç»†PVä¿¡æ¯  "/dev/sdb1" is a new physical volume of "20.00 GiB"  --- NEW Physical volume ---  PV Name               /dev/sdb1  VG Name  PV Size               20.00 GiB  Allocatable           NO  PE Size               0  Total PE              0  Free PE               0  Allocated PE          0  PV UUID               LcLg0U-gofo-MapY-eilj-OpkQ-TYMO-nSDfh3  "/dev/sdc1" is a new physical volume of "20.00 GiB"  --- NEW Physical volume ---  PV Name               /dev/sdc1  VG Name  PV Size               20.00 GiB  Allocatable           NO  PE Size               0  Total PE              0  Free PE               0  Allocated PE          0  PV UUID               r9Dp6u-S1hL-EmXb-6M7c-yefR-Bzts-B0Rdtd</code></pre><h4 id="4-å°†PVåŠ å…¥åˆ°å·ç»„ä¸­-VG"><a href="#4-å°†PVåŠ å…¥åˆ°å·ç»„ä¸­-VG" class="headerlink" title="4. å°†PVåŠ å…¥åˆ°å·ç»„ä¸­(VG)"></a>4. å°†PVåŠ å…¥åˆ°å·ç»„ä¸­(VG)</h4><pre><code>[root@localhost ~]# vgcreate vg-group /dev/sdb1 /dev/sdc1  Volume group "vg-group" successfully created</code></pre><h4 id="5-åˆ›å»ºä¸€ä¸ª10Gå¤§å°çš„lvm"><a href="#5-åˆ›å»ºä¸€ä¸ª10Gå¤§å°çš„lvm" class="headerlink" title="5. åˆ›å»ºä¸€ä¸ª10Gå¤§å°çš„lvm"></a>5. åˆ›å»ºä¸€ä¸ª10Gå¤§å°çš„lvm</h4><pre><code>[root@localhost ~]# vgs  VG       #PV #LV #SN Attr   VSize  VFree  centos     1   2   0 wz--n- 19.51g     0  vg-group   2   0   0 wz--n- 39.99g 39.99g[root@localhost ~]# lvcreate -L 10G -n data vg-group  Logical volume "data" created[root@localhost ~]# lvs  LV   VG       Attr       LSize  Pool Origin Data%  Move Log Cpy%Sync Convert  root centos   -wi-ao---- 17.51g  swap centos   -wi-ao----  2.00g  data vg-group -wi-a----- 10.00g</code></pre><h4 id="6-æ ¼å¼åŒ–è¿™ä¸ªlvmæˆxfsæ–‡ä»¶ç³»ç»Ÿ"><a href="#6-æ ¼å¼åŒ–è¿™ä¸ªlvmæˆxfsæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="6. æ ¼å¼åŒ–è¿™ä¸ªlvmæˆxfsæ–‡ä»¶ç³»ç»Ÿ"></a>6. æ ¼å¼åŒ–è¿™ä¸ªlvmæˆxfsæ–‡ä»¶ç³»ç»Ÿ</h4><pre><code>[root@localhost ~]# mkfs.xfs /dev/vg-group/data   # æ³¨æ„è¿™ä¸ªè·¯å¾„æ˜¯/dev/å·ç»„å/lvmåmeta-data=/dev/vg-group/data     isize=256    agcount=4, agsize=655360 blks         =                       sectsz=512   attr=2, projid32bit=1         =                       crc=0data     =                       bsize=4096   blocks=2621440, imaxpct=25         =                       sunit=0      swidth=0 blksnaming   =version 2              bsize=4096   ascii-ci=0 ftype=0log      =internal log           bsize=4096   blocks=2560, version=2         =                       sectsz=512   sunit=0 blks, lazy-count=1realtime =none                   extsz=4096   blocks=0, rtextents=0[root@localhost ~]# lvs  LV   VG       Attr       LSize  Pool Origin Data%  Move Log Cpy%Sync Convert  root centos   -wi-ao---- 17.51g  swap centos   -wi-ao----  2.00g  data vg-group -wi-a----- 10.00g[root@localhost ~]#</code></pre><h4 id="7-é€»è¾‘å·æ‰©å®¹"><a href="#7-é€»è¾‘å·æ‰©å®¹" class="headerlink" title="7. é€»è¾‘å·æ‰©å®¹"></a>7. é€»è¾‘å·æ‰©å®¹</h4><pre><code>ä½¿ç”¨ lvextend å‘½ä»¤è¿›è¡Œé€»è¾‘å·æ‰©å®¹ã€‚æˆ‘æŠŠæ‰€æœ‰å‰©ä½™ç©ºé—´éƒ½åˆ†é…ç»™äº†data[root@localhost ~]# lvextend -l +100%FREE /dev/vg-group/data  Extending logical volume data to 39.99 GiB  Logical volume data successfully resized[root@localhost ~]# lvs  LV   VG       Attr       LSize  Pool Origin Data%  Move Log Cpy%Sync Convert  root centos   -wi-ao---- 17.51g  swap centos   -wi-ao----  2.00g  data vg-group -wi-a----- 39.99g[root@localhost ~]# mkdir /data[root@localhost ~]# mount /dev/vg-group/data /data/[root@localhost ~]# df -hT | grep "data"   # å¯ä»¥çœ‹åˆ°è¿™æ—¶å€™çš„data åªæœ‰10Gï¼Œå¯æ˜¯æˆ‘ä»¬çš„lvmå·²ç»æœ‰40G/dev/mapper/vg--group-data xfs        10G   33M   10G    1% /data</code></pre><h4 id="8-ä½¿ç”¨xfs-growfså‘½ä»¤åœ¨çº¿è°ƒæ•´xfsæ ¼å¼æ–‡ä»¶ç³»ç»Ÿå¤§å°"><a href="#8-ä½¿ç”¨xfs-growfså‘½ä»¤åœ¨çº¿è°ƒæ•´xfsæ ¼å¼æ–‡ä»¶ç³»ç»Ÿå¤§å°" class="headerlink" title="8. ä½¿ç”¨xfs_growfså‘½ä»¤åœ¨çº¿è°ƒæ•´xfsæ ¼å¼æ–‡ä»¶ç³»ç»Ÿå¤§å°"></a>8. ä½¿ç”¨xfs_growfså‘½ä»¤åœ¨çº¿è°ƒæ•´xfsæ ¼å¼æ–‡ä»¶ç³»ç»Ÿå¤§å°</h4><pre><code>[root@localhost ~]# xfs_growfs /dev/vg-group/datameta-data=/dev/mapper/vg--group-data isize=256    agcount=4, agsize=655360 blks         =                       sectsz=512   attr=2, projid32bit=1         =                       crc=0data     =                       bsize=4096   blocks=2621440, imaxpct=25         =                       sunit=0      swidth=0 blksnaming   =version 2              bsize=4096   ascii-ci=0 ftype=0log      =internal               bsize=4096   blocks=2560, version=2         =                       sectsz=512   sunit=0 blks, lazy-count=1realtime =none                   extsz=4096   blocks=0, rtextents=0data blocks changed from 2621440 to 10483712[root@localhost ~]# df -hT | grep "data"/dev/mapper/vg--group-data xfs        40G   33M   40G    1% /data</code></pre><h4 id="9-åŠ å…¥ç°æœ‰çš„å·ç»„ä¸­ï¼š"><a href="#9-åŠ å…¥ç°æœ‰çš„å·ç»„ä¸­ï¼š" class="headerlink" title="9 .åŠ å…¥ç°æœ‰çš„å·ç»„ä¸­ï¼š"></a>9 .åŠ å…¥ç°æœ‰çš„å·ç»„ä¸­ï¼š</h4><pre><code>(1)# æŸ¥çœ‹ç°æœ‰å·ç»„[root@localhost ~]# vgs  VG       #PV #LV #SN Attr   VSize  VFree  centos     1   2   0 wz--n- 19.51g    0  vg-group   2   1   0 wz--n- 39.99g    0(2)#æŸ¥çœ‹æ–°åŠ ç£ç›˜,è¿˜æ˜¯å…ˆåˆ†åŒºï¼Œç„¶åæ›´æ”¹lvmæ ¼å¼(ç•¥)[root@localhost ~]# fdisk -l | grep sddç£ç›˜ /dev/sddï¼š21.5 GB, 21474836480 å­—èŠ‚ï¼Œ41943040 ä¸ªæ‰‡åŒº/dev/sdd1            2048    41943039    20970496   8e  Linux LVM(3)#ä½¿ç”¨ vgextend å‘½ä»¤æŠŠ/dev/sdd1åŠ å…¥åˆ°centos[root@localhost ~]# vgextend centos /dev/sdd1  Volume group "centos" successfully extended[root@localhost ~]# vgs  VG       #PV #LV #SN Attr   VSize  VFree  centos     2   2   0 wz--n- 39.50g 20.00g  vg-group   2   1   0 wz--n- 39.99g     0  (4)ä½¿ç”¨ lvextend å‘½ä»¤è¿›è¡Œé€»è¾‘å·rootæ‰©å®¹ã€‚æˆ‘æŠŠæ‰€æœ‰å‰©ä½™ç©ºé—´éƒ½åˆ†é…ç»™äº†root[root@localhost ~]# lvextend -l +100%FREE /dev/centos/root  Extending logical volume root to 37.50 GiB  Logical volume root successfully resized[root@localhost ~]# xfs_growfs /dev/centos/rootmeta-data=/dev/mapper/centos-root isize=256    agcount=4, agsize=1147392 blks         =                       sectsz=512   attr=2, projid32bit=1         =                       crc=0data     =                       bsize=4096   blocks=4589568, imaxpct=25         =                       sunit=0      swidth=0 blksnaming   =version 2              bsize=4096   ascii-ci=0 ftype=0log      =internal               bsize=4096   blocks=2560, version=2         =                       sectsz=512   sunit=0 blks, lazy-count=1realtime =none                   extsz=4096   blocks=0, rtextents=0data blocks changed from 4589568 to 9831424[root@localhost ~]## æ­¤æ—¶æˆ‘ä»¬çš„æ ¹åˆ†åŒºå°±å¾—åˆ°äº†æ‰©å®¹å•¦ï¼›[root@localhost ~]# df -hT | grep "root"/dev/mapper/centos-root    xfs        38G  929M   37G    3% /</code></pre><h4 id="æ³¨æ„ï¼š"><a href="#æ³¨æ„ï¼š" class="headerlink" title="æ³¨æ„ï¼š"></a>æ³¨æ„ï¼š</h4><pre><code>pvs -- vgs -- lvs</code></pre>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLæŠ¥é”™ERROR 1030 (HY000): è§£å†³è¿‡ç¨‹</title>
      <link href="/2016/03/19/mysql-e6-8a-a5-e9-94-99error-1030-hy000-e8-a7-a3-e5-86-b3-e8-bf-87-e7-a8-8b/"/>
      <url>/2016/03/19/mysql-e6-8a-a5-e9-94-99error-1030-hy000-e8-a7-a3-e5-86-b3-e8-bf-87-e7-a8-8b/</url>
      
        <content type="html"><![CDATA[<p><strong>é—®é¢˜</strong>ï¼š ä»Šå¤©å¼€å‘åŒäº‹åœ¨æ‰§è¡Œjenkinsè‡ªåŠ¨åŒ–æ„å»ºæ—¶ï¼Œç”±äºæ‰§è¡Œä¸€ä¸ªmysqlæ›´æ–°çš„æ“ä½œå¯¼è‡´æ„å»ºå¤±è´¥ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/1.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/1.jpg" alt="1"></a> è¿™ä¸ªæ–‡ä»¶ä¸»è¦æ˜¯å¼€å‘ç”¨äºæ‰§è¡Œæ„å»ºéƒ¨ç½²çš„æ—¶å€™æ›´æ–°æ•°æ®åº“çš„sqlæ–‡ä»¶ï¼Œé‡Œé¢æœ‰å¤§é‡çš„æ’å…¥è¯­å¥ï¼› ç™»å½•åˆ°æµ‹è¯•æœåŠ¡å™¨å°†jenkinsä¸­çš„è¯­å¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œäº†ä¸€éè¿˜æ˜¯æŠ¥åŒæ ·çš„é”™è¯¯ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/2.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/2.jpg" alt="2"></a> çœ‹åˆ°è¿™ä¸ªæŠ¥é”™è²Œä¼¼ä¸å­˜å‚¨å¼•æ“æœ‰å…³ç³»ï¼Œäºæ˜¯ç™»å½•åˆ°mysqlä¸­æ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/3.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/3.jpg" alt="3"></a> <strong>è§£å†³æ€è·¯</strong> 1.çœ‹äº†ä¸‹å…·ä½“é”™è¯¯ä»£ç  <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/4.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/4.jpg" alt="4"></a> åœ¨tmpä¸‹æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Ÿä½†æ˜¯è¿™ä¸ªæ–‡ä»¶æ—¶ä¸´æ—¶ç”Ÿæˆçš„ï¼Œæœ¬æ¥å°±åº”è¯¥æ²¡æœ‰å•Šï¼ é‚£å°±æ˜¯åˆ›å»ºçš„æ—¶å€™å‡ºé”™äº†?! 2.æŸ¥çœ‹äº†ä¸€ä¸‹ç£ç›˜ç©ºé—´ï¼Œæˆ‘æ»´ä¸ªä¹–ä¹–ï¼ŒåŸæ¥ç¬¬ä¸€å—ç£ç›˜æ»¡äº† <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/5.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/5.jpg" alt="5"></a> å¥½å§ï¼Œæ¸…ç†äº†ä¸€äº›æ–‡ä»¶ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/6.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/6.jpg" alt="6"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/66.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/03/66.jpg" alt="66"></a> å†æ¬¡æ‰§è¡Œæ„å»ºï¼Œé¡ºåˆ©å®Œæˆï¼</p>]]></content>
      
      
      <categories>
          
          <category> æ•…éšœå¤„ç† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql error </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æˆ‘çš„51CTOåšå®¢æ–‡ç« é“¾æ¥æ±‡æ€»</title>
      <link href="/2016/01/07/e6-88-91-e7-9a-8451cto-e5-8d-9a-e5-ae-a2-e6-96-87-e7-ab-a0-e9-93-be-e6-8e-a5-e6-b1-87-e6-80-bb/"/>
      <url>/2016/01/07/e6-88-91-e7-9a-8451cto-e5-8d-9a-e5-ae-a2-e6-96-87-e7-ab-a0-e9-93-be-e6-8e-a5-e6-b1-87-e6-80-bb/</url>
      
        <content type="html"><![CDATA[<p>å°†ä¹‹å‰åœ¨51CTOçš„æ‰€æœ‰åšå®¢æ•´ç†äº†ä¸€ç•ª, ç‚¹å‡»æ–‡ç« åç§°å°±å¯ä»¥è·³åˆ°51ctoè¯»é˜…å•¦^o^</p><h1 id="é›†ç¾¤-é«˜å¯ç”¨-è´Ÿè½½å‡è¡¡"><a href="#é›†ç¾¤-é«˜å¯ç”¨-è´Ÿè½½å‡è¡¡" class="headerlink" title="é›†ç¾¤/é«˜å¯ç”¨/è´Ÿè½½å‡è¡¡"></a>é›†ç¾¤/é«˜å¯ç”¨/è´Ÿè½½å‡è¡¡</h1><p><a href="http://maoqiu.blog.51cto.com/8570467/1405684">LVS_NATå®ç°è¿‡ç¨‹â€¦</a> <a href="http://maoqiu.blog.51cto.com/8570467/1414425">LVS_DRå®ç°è¿‡ç¨‹â€¦</a> <a href="http://maoqiu.blog.51cto.com/8570467/1405675">KeepalivedåŸºç¡€çŸ¥è¯†</a> <a href="http://maoqiu.blog.51cto.com/8570467/1399876">Linux HAé›†ç¾¤ä¹‹DRBDè¯¦è§£</a> <a href="http://maoqiu.blog.51cto.com/8570467/1405875">åŸºäºkeepalivedçš„Haproxyé«˜å¯ç”¨é…ç½®</a></p><h1 id="åˆ†å¸ƒå¼"><a href="#åˆ†å¸ƒå¼" class="headerlink" title="åˆ†å¸ƒå¼"></a>åˆ†å¸ƒå¼</h1><p><a href="http://maoqiu.blog.51cto.com/8570467/1409676">åˆ†å¸ƒå¼ç¼“å­˜varnishç®€ä»‹</a> <a href="http://maoqiu.blog.51cto.com/8570467/1409382">åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸMogileFSç®€ä»‹</a></p><h1 id="æ•°æ®åº“"><a href="#æ•°æ®åº“" class="headerlink" title="æ•°æ®åº“"></a>æ•°æ®åº“</h1><p><a href="http://maoqiu.blog.51cto.com/8570467/1392816">MysqlçŸ¥è¯†æ€»ç»“ï¼ˆä¸€ï¼‰</a> <a href="http://maoqiu.blog.51cto.com/8570467/1392818">MysqlçŸ¥è¯†æ€»ç»“ï¼ˆäºŒï¼‰</a> <a href="http://maoqiu.blog.51cto.com/8570467/1394389">MysqlçŸ¥è¯†æ€»ç»“ï¼ˆä¸‰ï¼‰</a> <a href="http://maoqiu.blog.51cto.com/8570467/1398202">MariaDB/Mysqlä¹‹ä¸»ä»æ¶æ„çš„å¤åˆ¶åŸç†åŠä¸»ä»/åŒä¸»é…ç½®è¯¦è§£(ä¸€)</a> <a href="http://maoqiu.blog.51cto.com/8570467/1398241">MariaDB/Mysqlä¹‹ä¸»ä»æ¶æ„çš„å¤åˆ¶åŸç†åŠä¸»ä»/åŒä¸»é…ç½®è¯¦è§£(äºŒ)</a> <a href="http://maoqiu.blog.51cto.com/8570467/1396244">MariaDBä¹‹å¤‡ä»½æ¢å¤å‡†åˆ™ï¼ˆä¸‰ï¼‰</a> <a href="http://maoqiu.blog.51cto.com/8570467/1396211">MariaDBä¹‹åŸºäºmysqldumpä¸lvm-snapshotå¤‡ä»½æ¢å¤Databases or Tablesï¼ˆä¸€ï¼‰</a> <a href="http://maoqiu.blog.51cto.com/8570467/1396217">MariaDBä¹‹åŸºäºPercona Xtrabackupå¤‡ä»½å¤§æ•°æ®åº“ã€å®Œæ•´å¤‡ä»½ä¸å¢é‡å¤‡ä»½ã€‘ï¼ˆäºŒï¼‰</a></p><h1 id="Linux-å‰–æ"><a href="#Linux-å‰–æ" class="headerlink" title="Linux å‰–æ"></a>Linux å‰–æ</h1><p><a href="http://maoqiu.blog.51cto.com/8570467/1370675">Linuxç³»ç»Ÿ-å°å€’è…¾ä¹‹Linux DIYå®šåˆ¶è£å‰ª(é™„å¸¦ç®€å•ç½‘ç»œåŠŸèƒ½)o_o(ä¸€)</a> <a href="http://maoqiu.blog.51cto.com/8570467/1390908">Linuxç³»ç»Ÿ-å°å€’è…¾ä¹‹Linux DIYå®šåˆ¶è£å‰ª(New kernel+Busybox)o_oï¼ˆäºŒï¼‰</a> <a href="http://maoqiu.blog.51cto.com/8570467/1390910">Linuxç³»ç»Ÿ-å°å€’è…¾ä¹‹Linux DIYå®šåˆ¶è£å‰ª(å®šåˆ¶Linux+SSH/Nginx)o_oï¼ˆä¸‰ï¼‰</a></p><h1 id="æ–‡ä»¶åŒæ­¥"><a href="#æ–‡ä»¶åŒæ­¥" class="headerlink" title="æ–‡ä»¶åŒæ­¥"></a>æ–‡ä»¶åŒæ­¥</h1><p><a href="http://maoqiu.blog.51cto.com/8570467/1387058">LinuxToolsâ€”Rsyncâ€”åŸç†åŠå…¶åº”ç”¨(ä¸€)</a> <a href="http://maoqiu.blog.51cto.com/8570467/1387062">LinuxToolsâ€”Rsyncâ€”åŸç†åŠå…¶åº”ç”¨(äºŒ)</a></p><h1 id="å®‰å…¨ç®¡ç†"><a href="#å®‰å…¨ç®¡ç†" class="headerlink" title="å®‰å…¨ç®¡ç†"></a>å®‰å…¨ç®¡ç†</h1><p><a href="http://maoqiu.blog.51cto.com/8570467/1386888">Linuxå®‰å…¨ç®¡ç†-Iptables-NATæŠ€æœ¯åº”ç”¨</a> <a href="http://maoqiu.blog.51cto.com/8570467/1386704">Linuxå®‰å…¨ç®¡ç†-IptablesåŸç†åŠå…¶åº”ç”¨</a></p><h1 id="Linux-Service"><a href="#Linux-Service" class="headerlink" title="Linux Service"></a>Linux Service</h1><p><a href="http://maoqiu.blog.51cto.com/8570467/1381723">Linuxç½‘ç»œæœåŠ¡-Web Serviceä¹‹ã€HTTPåè®®ç®€ä»‹ã€‘(ä¸€)</a> <a href="http://maoqiu.blog.51cto.com/8570467/1381724">Linuxç½‘ç»œæœåŠ¡-Web Serviceä¹‹ã€Apache-Preforkã€Workerå’ŒEventä¸‰ç§å·¥ä½œæ¨¡å¼åˆ†æã€‘(äºŒ)</a> <a href="http://maoqiu.blog.51cto.com/8570467/1386861">Linuxç½‘ç»œæœåŠ¡-Web Serviceä¹‹ã€apacheçš„åŠŸèƒ½ã€å®‰è£…ã€é…ç½®æ–‡ä»¶ä»‹ç»ä»¥åŠå®éªŒå®ä¾‹ã€‘(ä¸‰)</a> <a href="http://maoqiu.blog.51cto.com/8570467/1386643">Linuxç½‘ç»œæœåŠ¡-LAMPä¹‹åŸºäºNFS+Fastcgiçš„LAMPæ­å»º</a> <a href="http://maoqiu.blog.51cto.com/8570467/1384026">Linuxç½‘ç»œæœåŠ¡-LAMPä¹‹PhpåŸºäºApacheçš„æ¨¡å—å®ç°</a> <a href="http://maoqiu.blog.51cto.com/8570467/1386616">Linuxç½‘ç»œæœåŠ¡ä¹‹DNSæœåŠ¡å™¨ä»‹ç»åŠé…ç½®å®ä¾‹è¯¦è§£</a></p><h1 id="ç³»ç»Ÿç®¡ç†"><a href="#ç³»ç»Ÿç®¡ç†" class="headerlink" title="ç³»ç»Ÿç®¡ç†"></a>ç³»ç»Ÿç®¡ç†</h1><p><a href="http://maoqiu.blog.51cto.com/8570467/1377421">Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹åŠ å¯†ã€è§£å¯†ã€OpensslåŸºæœ¬åº”ç”¨åŠCAå®ç°è¿‡ç¨‹</a> <a href="http://maoqiu.blog.51cto.com/8570467/1368586">Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹åŠç³»ç»Ÿåˆå§‹åŒ–å­¦ä¹ æ€»ç»“</a> <a href="http://maoqiu.blog.51cto.com/8570467/1364131">Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹è½¯ä»¶åŒ…ç®¡ç†ã€é™„httpæºç å®‰è£…å®ä¾‹ã€‘</a> <a href="http://maoqiu.blog.51cto.com/8570467/1364072">Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹findå‘½ä»¤å­¦ä¹ æ€»ç»“</a> <a href="http://maoqiu.blog.51cto.com/8570467/1360448">Shellç¼–ç¨‹å…¥é—¨è¿›é˜¶ä¹‹Grepå‘½ä»¤åŠæ­£åˆ™è¡¨è¾¾å¼çŸ¥è¯†æ¢³ç†</a> <a href="http://maoqiu.blog.51cto.com/8570467/1359596">Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹ç”¨æˆ·ã€æƒé™ç®¡ç†</a> <a href="http://maoqiu.blog.51cto.com/8570467/1359589">Shellç¼–ç¨‹å…¥é—¨è¿›é˜¶ä¹‹bashé…ç½®æ–‡ä»¶ä»‹ç»</a> <a href="http://maoqiu.blog.51cto.com/8570467/1359585">Shellç¼–ç¨‹å…¥é—¨è¿›é˜¶ä¹‹Bash Shellç‰¹æ€§</a> <a href="http://maoqiu.blog.51cto.com/8570467/1359519">Linuxå‘½ä»¤çš„æ ¼å¼ã€å¸¸ç”¨å‘½ä»¤æ±‡æ€»ä»¥åŠä¸€äº›ç³»ç»ŸåŸºæœ¬æ¦‚å¿µ</a> <a href="http://maoqiu.blog.51cto.com/8570467/1358968">Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹å¦‚ä½•åœ¨ç»ˆç«¯ä¸Šè·å–Linuxå‘½ä»¤å¸®åŠ©.</a> <a href="http://maoqiu.blog.51cto.com/8570467/1358373">Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹ç»ˆç«¯,ä¼ªç»ˆç«¯æ¦‚å¿µè¯¦è§£ä¹‹tty,ptyç­‰</a> <a href="http://maoqiu.blog.51cto.com/8570467/1358265">Linuxç³»ç»ŸåŸºç¡€-ç®¡ç†ä¹‹Linux ç›®å½•é…ç½®æ ‡å‡†ï¼šFHSï¼šFileSystem Hierarchy Standard</a></p><h1 id="æ‚è°ˆ"><a href="#æ‚è°ˆ" class="headerlink" title="æ‚è°ˆ"></a>æ‚è°ˆ</h1><p><a href="http://maoqiu.blog.51cto.com/8570467/1358231">å‡å¦‚Linuxç‰ˆæœ¬éƒ½å¦‚å¥³äºº</a></p>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Zabbixå¾®ä¿¡æŠ¥è­¦</title>
      <link href="/2015/11/21/zabbix-e5-be-ae-e4-bf-a1-e6-8a-a5-e8-ad-a6/"/>
      <url>/2015/11/21/zabbix-e5-be-ae-e4-bf-a1-e6-8a-a5-e8-ad-a6/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€æ³¨å†Œå¾®ä¿¡å…¬ä¼—å·"><a href="#ä¸€ã€æ³¨å†Œå¾®ä¿¡å…¬ä¼—å·" class="headerlink" title="ä¸€ã€æ³¨å†Œå¾®ä¿¡å…¬ä¼—å·"></a>ä¸€ã€æ³¨å†Œå¾®ä¿¡å…¬ä¼—å·</h2><p>é¦–å…ˆç”³è¯·å¾®ä¿¡å…¬ä¼—å¹³å°<a href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com/</a>ä¸€ä¸ªäººæœ€å¤šç”³è¯·5ä¸ªå…¬ä¼—å·ï¼Œç”³è¯·å®Œä¹‹åå°±å¯ä»¥æ ¹æ®è…¾è®¯çš„æç¤ºä½¿ç”¨å¾®ä¿¡å…¬ä¼—å·äº†ï¼Œç„¶åç”¨ä½ è‡ªå·±çš„å¾®ä¿¡æ‰«æå…³æ³¨å¾®ä¿¡å·ã€‚ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/%7Fmeitu_1.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/%7Fmeitu_1.jpg" alt="meitu_1"></a> é€šè¿‡æ‰«æè¿‡åå°±å¯ä»¥çœ‹åˆ°å·²ç»æœ‰ä¸€ä¸ªç”¨æˆ·å…³æ³¨å•¦ï¼›äºæ˜¯æˆ‘ä»¬è¿™é‡Œéœ€è¦æŸ¥çœ‹ç”¨æˆ·çš„ID ç‚¹å‡» â€œç”¨æˆ·ç®¡ç†â€ï¼Œç„¶åç‚¹å‡»ä¸€ä¸‹ç”¨æˆ·çš„å¤´åƒï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨çš„åœ°å€æ å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªè¿™ä¸ªï¼Œå…¶ä¸­çº¢è‰²éƒ¨åˆ†å°±æ˜¯ç”¨æˆ·çš„å¾®ä¿¡IDå•¦ï¼Œå…ˆè®°ä¸‹è¿™ä¸ªID <a href="https://mp.weixin.qq.com/cgi-bin/singlesendpage?t=message/send&amp;action=index&amp;tofakeid=250995555&amp;token=94167798&amp;lang=zh_CN">https://mp.weixin.qq.com/cgi-bin/singlesendpage?t=message/send&amp;action=index&amp;tofakeid=250995555&amp;token=94167798&amp;lang=zh_CN</a> <img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_2.jpg" alt="meitu_2"> &nbsp;</p><h2 id="äºŒã€ä¸‹è½½å¹¶é…ç½®å¾®ä¿¡å…¬ä¼—å¹³å°ç§æœ‰æ¥å£"><a href="#äºŒã€ä¸‹è½½å¹¶é…ç½®å¾®ä¿¡å…¬ä¼—å¹³å°ç§æœ‰æ¥å£" class="headerlink" title="äºŒã€ä¸‹è½½å¹¶é…ç½®å¾®ä¿¡å…¬ä¼—å¹³å°ç§æœ‰æ¥å£"></a>äºŒã€ä¸‹è½½å¹¶é…ç½®å¾®ä¿¡å…¬ä¼—å¹³å°ç§æœ‰æ¥å£</h2><p>1.è·å–ä»£ç </p><p>git clone <a href="https://github.com/lealife/WeiXin-Private-API">https://github.com/lealife/WeiXin-Private-API</a></p><p>2.ä¿®æ”¹zabbixé…ç½®æ–‡ä»¶</p><p>[root@Control-machine ~]# cp -r WeiXin-Private-API /usr/lib/zabbix/alertscripts/<br>[root@Control-machine ~]# cd /usr/lib/zabbix/alertscripts/<br>[root@Control-machine alertscripts]# chown zabbix:zabbix WeiXin-Private-API<br>[root@Control-machine alertscripts]# </p><p>#ä¿®æ”¹test.phpæ–‡ä»¶<br>[root@Control-machine alertscripts]# vim WeiXin-Private-API/test.php<br>&lt;?php<br>require â€œconfig.phpâ€;<br>require â€œinclude/WeiXin.phpâ€;<br>$weiXin = new WeiXin($G_CONFIG[â€˜weiXinâ€™]);<br>$testFakeId = â€œ$argv[1]â€œ;<br>$msg=â€$argv[3]â€œ;<br>    print_r($weiXin-&gt;send($testFakeId, â€œ$msgâ€));</p><p>3.ä¿®æ”¹config.phpæ–‡ä»¶</p><p>[root@Control-machine alertscripts]# vim WeiXin-Private-API/config.php<br>&lt;?php<br>// å…¨å±€é…ç½®<br>$G_ROOT = dirname(__FILE__);<br>$G_CONFIG[â€œweiXinâ€] = array(<br>        â€˜accountâ€™ =&gt; â€˜ä½ çš„å¾®ä¿¡å…¬ä¼—ç™»å½•å·ç â€™,<br>        â€˜passwordâ€™ =&gt; â€˜ä½ çš„å¾®ä¿¡å…¬ä¼—ç™»å½•å¯†ç â€™,<br>        â€˜cookiePathâ€™ =&gt; $G_ROOT. â€˜/cache/cookieâ€™, // cookieç¼“å­˜æ–‡ä»¶è·¯å¾„<br>        â€˜webTokenPathâ€™ =&gt; $G_ROOT. â€˜/cache/webTokenâ€™, // webTokenç¼“å­˜æ–‡ä»¶è·¯å¾„<br>);</p><p>4.ä¿®æ”¹test.phpæ–‡ä»¶</p><p>[root@Control-machine alertscripts]# vim WeiXin-Private-API/test.php<br>&lt;?php<br>require â€œconfig.phpâ€;<br>require â€œinclude/WeiXin.phpâ€;<br>$weiXin = new WeiXin($G_CONFIG[â€˜weiXinâ€™]);<br>$testFakeId = â€œ$argv[1]â€œ;<br>$msg=â€$argv[3]â€œ;<br>    print_r($weiXin-&gt;send($testFakeId, â€œ$msgâ€));</p><p>æ³¨æ„è¿™é‡Œ$msg=â€$argv[3]â€œè¡¨ç¤ºzabbixä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå› ä¸ºåœ¨zabbixæŠ¥è­¦æ—¶ä¼šä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼š ä¸€æ˜¯å¾®ä¿¡å¥½å‹IDï¼ŒäºŒæ˜¯æŠ¥è­¦ä¿¡æ¯çš„ä¸»é¢˜ï¼Œä¸‰æ˜¯æŠ¥è­¦ä¿¡æ¯çš„å…·ä½“å†…å®¹ï¼Œè¿™é‡Œè·³è¿‡äº†æŠ¥è­¦ä¿¡æ¯ä¸»é¢˜ï¼Œç›´æ¥å‘é€æŠ¥è­¦ä¿¡æ¯å†…å®¹ 5.åˆ›å»ºå¾®ä¿¡æŠ¥è­¦è„šæœ¬</p><p>[root@Control-machine alertscripts]# vim weixin<br>/usr/bin/php /usr/lib/zabbix/alertscripts/WeiXin-Private-API/test.php â€œ$1â€ â€œ$2â€ â€œ$3â€<br>[root@Control-machine alertscripts]# chown zabbix:zabbix weixin<br>[root@Control-machine alertscripts]# chmod +x weixin </p><p>6.æµ‹è¯•æŠ¥è­¦</p><p>[root@Control-machine alertscripts]# /usr/bin/php /usr/lib/zabbix/alertscripts/WeiXin-Private-API/test.php 250995555 â€œâ€ â€œTestâ€<br>PHP Notice:  Undefined index: HTTP_USER_AGENT in /usr/lib/zabbix/alertscripts/WeiXin-Private-API/include/LeaWeiXinClient.php on line 33<br>PHP Notice:  curl_setopt(): CURLOPT_SSL_VERIFYHOST no longer accepts the value 1, value 2 will be used instead in /usr/lib/zabbix/alertscripts/WeiXin-Private-API/include/LeaWeiXinClient.php on line 32<br>PHP Notice:  Undefined index: HTTP_USER_AGENT in /usr/lib/zabbix/alertscripts/WeiXin-Private-API/include/LeaWeiXinClient.php on line 33<br>stdClass Object<br>(<br>    [base_resp] =&gt; stdClass Object<br>        (<br>            [ret] =&gt; 0<br>            [err_msg] =&gt; ok  #è¯´æ˜å·²ç»å‘é€å‡ºå»å•¦<br>        )</p><p>)<br>[root@Control-machine alertscripts]# </p><p>#ä»¥ä¸ŠPHPçš„æç¤ºä¿¡æ¯å¯ä»¥å¿½ç•¥</p><p>æŸ¥çœ‹ç»“æœ <img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_3.jpg" alt="meitu_3"></p><h2 id="ä¸‰ã€é…ç½®zabbix"><a href="#ä¸‰ã€é…ç½®zabbix" class="headerlink" title="ä¸‰ã€é…ç½®zabbix"></a>ä¸‰ã€é…ç½®zabbix</h2><p>1.æ·»åŠ æŠ¥è­¦åª’ä»‹ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_4.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_4.jpg" alt="meitu_4"></a> 2.æ·»åŠ ç”¨æˆ·æŠ¥è­¦åª’ä»‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯administrator <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_5.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_5.jpg" alt="meitu_5"></a> 3.æ·»åŠ æŠ¥è­¦åŠ¨ä½œ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_6.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_6.jpg" alt="meitu_6"></a> ä¿¡æ¯å¦‚ä¸‹ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_8.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_8.jpg" alt="meitu_8"></a> ä¿®æ”¹æ“ä½œæ¡ä»¶ï¼Œä¿æŒé»˜è®¤çš„ä¹Ÿå¯ä»¥ï¼› ä¿å­˜è®¾ç½®</p><h2 id="å››ã€æµ‹è¯•"><a href="#å››ã€æµ‹è¯•" class="headerlink" title="å››ã€æµ‹è¯•"></a>å››ã€æµ‹è¯•</h2><p>æˆ‘è¿™é‡Œå°†ç›‘æ§mysqlä¸»ä»çš„è„šæœ¬æ‰‹åŠ¨æ”¹ä¸€ä¸‹ï¼Œè®©å…¶zabbixæ£€æµ‹åˆ°å¹¶æŠ¥è­¦ æ‰‹æœºå¾®ä¿¡æŸ¥çœ‹æŠ¥è­¦ä¿¡æ¯ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_7.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/meitu_7.jpg" alt="meitu_7"></a> ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå…¬ä¼—å·å‘æˆ‘çš„å¾®ä¿¡å‘é€æ¶ˆæ¯è¶…è¿‡48ä¸ªå°æ—¶æˆ‘æ²¡æœ‰å›å¤ï¼Œé‚£ä¹ˆå…¬ä¼—å·å°†ä¸ä¼šä¸»åŠ¨å‘é€æ¶ˆæ¯ã€‚ç„¶åæˆ‘ä»¬åœ¨å¾®ä¿¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨æ”¶åˆ°æŠ¥è­¦é€šçŸ¥ååœ¨48ä¸ªå°æ—¶ä¹‹å†…å¯ä»¥ç®€å•çš„å›å¤ä¸€ä¸ªå­—ç¬¦ï¼Œæˆ–è€…ä¸€æ®µè¯å³å¯ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/Screenshot-from-2015-11-30-164029.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/Screenshot-from-2015-11-30-164029.png" alt="Screenshot from 2015-11-30 16:40:29"></a> å‚è€ƒæ–‡ç« é“¾æ¥ï¼š <a href="http://blog.chinaunix.net/uid-30236771-id-5037842.html">http://blog.chinaunix.net/uid-30236771-id-5037842.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Saltstackåˆ©ç”¨Returnersç¨‹åºä¿å­˜æ‰§è¡Œç»“æœåˆ°mysql</title>
      <link href="/2015/11/19/saltstack-e5-88-a9-e7-94-a8returners-e7-a8-8b-e5-ba-8f-e4-bf-9d-e5-ad-98-e6-89-a7-e8-a1-8c-e7-bb-93-e6-9e-9c-e5-88-b0mysql/"/>
      <url>/2015/11/19/saltstack-e5-88-a9-e7-94-a8returners-e7-a8-8b-e5-ba-8f-e4-bf-9d-e5-ad-98-e6-89-a7-e8-a1-8c-e7-bb-93-e6-9e-9c-e5-88-b0mysql/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æˆ‘ä»¬æ‰§è¡Œsaltstackçš„æ—¶å€™ï¼Œminionç«¯ä¼šè¿”å›ä¸€å¤§å †çš„æ‰§è¡Œç»“æœæ˜¾ç¤ºåœ¨masterç«¯ï¼Œé‚£å¦‚ä½•å°†æ¯ä¸€æ¬¡slatæ‰§è¡Œçš„ç»“æœè¿™äº›ç»“æœä¿å­˜èµ·æ¥ä¾¿äºæ—¥åæŸ¥è¯¢ï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†saltstackçš„è¿”å›ç¨‹åºReturnersï¼Œå¯ä»¥ä¿å­˜åœ¨Redisï¼ŒMongodbï¼ŒMySQLç­‰è¿™äº›ç¨‹åºå½“ä¸­ï¼› æ³¨æ„è¿™çš„è¿”å›å¹¶ä¸æ˜¯å°†æ‰§è¡Œç»“æœè¿”å›ç»™masterï¼Œmasterå†å†™å…¥åˆ°MySQLæˆ–è€…Redisä¸­ï¼Œè€Œæ˜¯salt-minionç«¯ç›´æ¥å‘MySQLæˆ–è€…Redisä¸­å†™ï¼Œ ä¸‹é¢æ˜¯æ“ä½œæ­¥éª¤ï¼š 1.å®‰è£…è½¯ä»¶åŒ…</p><p>masterç«¯ï¼šyum install -y MySQL-python mysql mysql-server<br>minionç«¯ï¼šyum install -y MySQL-python</p><p>2.å»ºç«‹æ•°æ®åº“ï¼Œåˆ›å»ºsaltæ‰€éœ€è¦çš„æ•°æ®åº“åŠè¡¨ç»“æ„</p><p>CREATE DATABASE  `salt`<br>  DEFAULT CHARACTER SET utf8<br>  DEFAULT COLLATE utf8_general_ci;</p><p>USE `salt`;</p><h2 id="Table-structure-for-table-jids"><a href="#Table-structure-for-table-jids" class="headerlink" title="---- Table structure for table `jids`"></a>--<br>-- Table structure for table `jids`</h2><p>DROP TABLE IF EXISTS `jids`;<br>CREATE TABLE `jids` (<br>  `jid` varchar(255) NOT NULL,<br>  `load` mediumtext NOT NULL,<br>  UNIQUE KEY `jid` (`jid`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;</p><h2 id="Table-structure-for-table-salt-returns"><a href="#Table-structure-for-table-salt-returns" class="headerlink" title="---- Table structure for table `salt_returns`"></a>--<br>-- Table structure for table `salt_returns`</h2><p>DROP TABLE IF EXISTS `salt_returns`;<br>CREATE TABLE `salt_returns` (<br>  `fun` varchar(50) NOT NULL,<br>  `jid` varchar(255) NOT NULL,<br>  `return` mediumtext NOT NULL,<br>  `id` varchar(255) NOT NULL,<br>  `success` varchar(10) NOT NULL,<br>  `full_ret` mediumtext NOT NULL,<br>  `alter_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,<br>  KEY `id` (`id`),<br>  KEY `jid` (`jid`),<br>  KEY `fun` (`fun`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;</p><h2 id="Table-structure-for-table-salt-events"><a href="#Table-structure-for-table-salt-events" class="headerlink" title="---- Table structure for table `salt_events`"></a>--<br>-- Table structure for table `salt_events`</h2><p>DROP TABLE IF EXISTS `salt_events`;<br>CREATE TABLE `salt_events` (<br>`id` BIGINT NOT NULL AUTO_INCREMENT,<br>`tag` varchar(255) NOT NULL,<br>`data` varchar(1024) NOT NULL,<br>`alter_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,<br>PRIMARY KEY (`id`),<br>KEY `tag` (`tag`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;</p><p>#æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š<br>mysql&gt; use salt<br>Database changed<br>mysql&gt; show tables;<br>+â€”â€”â€”â€”â€”-+<br>| Tables_in_salt |<br>+â€”â€”â€”â€”â€”-+<br>| jids           |<br>| salt_events    |<br>| salt_returns   |<br>+â€”â€”â€”â€”â€”-+<br>3 rows in set (0.00 sec)</p><p>3.æˆæƒæ•°æ®åº“ï¼Œä¿®æ”¹masteré…ç½®</p><p>mysql &gt; grant all on salt.* to salt@â€™192.168.2.0/255.255.255.0â€™ identified by â€˜saltâ€™;<br>mysql &gt; flush privileges;</p><p>åœ¨masterç«¯æˆ–è€…æ¯ä¸ªminionç«¯éƒ½å†™å¦‚ä»¥ä¸‹é…ç½®å†…å®¹ã€‚å½“ç„¶å¦‚æœå†™åœ¨masterç«¯æ˜¯æ¯”è¾ƒç®€å•çš„åšæ³•ï¼Œå› ä¸ºåªéœ€è¦å†™ä¸€æ¬¡å°±è¡Œå•¦ã€‚æˆ‘è¿™é‡Œå†™åœ¨äº†masterç«¯ã€‚</p><p>[root@saltstack-node1 ~]# vim /etc/salt/master<br>return: mysql<br>mysql.host: â€˜192.168.2.21â€™#mysql æ•°æ®åº“æœåŠ¡å™¨åœ°å€<br>mysql.user: â€˜saltâ€™<br>mysql.pass: â€˜saltâ€™<br>mysql.db: â€˜saltâ€™<br>mysql.port: 3306</p><p>4.æ‰§è¡Œè¯­å¥æµ‹è¯•ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/salt-returners_meitu_1.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/salt-returners_meitu_1.jpg" alt="salt-returners_meitu_1"></a></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ELK+Kafka ä¼ä¸šæ—¥å¿—æ”¶é›†å¹³å°(äºŒ)</title>
      <link href="/2015/11/14/elkkafka-e4-bc-81-e4-b8-9a-e6-97-a5-e5-bf-97-e6-94-b6-e9-9b-86-e5-b9-b3-e5-8f-b0-e4-ba-8c/"/>
      <url>/2015/11/14/elkkafka-e4-bc-81-e4-b8-9a-e6-97-a5-e5-bf-97-e6-94-b6-e9-9b-86-e5-b9-b3-e5-8f-b0-e4-ba-8c/</url>
      
        <content type="html"><![CDATA[<p>ä¸Šç¯‡åšæ–‡ä¸»è¦æ€»ç»“äº†ä¸€ä¸‹elkã€åŸºäºkafkaçš„zookeeperé›†ç¾¤æ­å»ºï¼Œä»¥åŠç³»ç»Ÿæ—¥å¿—é€šè¿‡zookeeperé›†ç¾¤è¾¾åˆ°æˆ‘ä»¬é›†ç¾¤çš„æ•´ä¸ªè¿‡ç¨‹ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç€ä¸‹é¢è¿™ä¸ªæœªå®Œæˆçš„å‡ ä¸ªä¸»é¢˜ 4.Kibanaéƒ¨ç½²; 5.Nginxè´Ÿè½½å‡è¡¡Kibanaè¯·æ±‚; 6.æ¡ˆä¾‹ï¼šnginxæ—¥å¿—æ”¶é›†ä»¥åŠMySQLæ…¢æ—¥å¿—æ”¶é›†; 7.KibanaæŠ¥è¡¨åŸºæœ¬ä½¿ç”¨; &nbsp;</p><h3 id="Kibanaçš„éƒ¨ç½²"><a href="#Kibanaçš„éƒ¨ç½²" class="headerlink" title="Kibanaçš„éƒ¨ç½²;"></a>Kibanaçš„éƒ¨ç½²;</h3><p>Kibanaçš„ä½œç”¨ï¼Œæƒ³å¿…å¤§å®¶éƒ½çŸ¥é“äº†å°±æ˜¯ä¸€ä¸ªå±•ç¤ºå·¥å…·ï¼ŒæŠ¥è¡¨å†…å®¹éå¸¸çš„ä¸°å¯Œï¼› ä¸‹é¢æˆ‘ä»¬åœ¨ä¸¤å°esä¸Šé¢æ­å»ºä¸¤å¥—kibana 1.è·å–kibanaè½¯ä»¶åŒ…</p><p>[root@es1 ~]# wget <a href="https://download.elastic.co/kibana/kibana/kibana-4.1.2-linux-x64.tar.gz">https://download.elastic.co/kibana/kibana/kibana-4.1.2-linux-x64.tar.gz</a><br>[root@es1 ~]# tar -xf kibana-4.2.0-linux-x64.tar.gz -C /usr/local/</p><p>2.ä¿®æ”¹é…ç½®æ–‡ä»¶</p><p>[root@es1 ~]# cd /usr/local/<br>[root@es1 local]# ln -sv kibana-4.1.2-linux-x64 kibana<br>`kibanaâ€™ -&gt; `kibana-4.2.0-linux-x64â€™<br>[root@es1 local]# cd kibana</p><p>[root@es1 kibana]# vim config/kibana.yml<br>server.port: 5601      #é»˜è®¤ç«¯å£å¯ä»¥ä¿®æ”¹çš„<br>server.host: â€œ0.0.0.0â€ #kibanaç›‘å¬çš„ip<br>elasticsearch.url: â€œ<a href="http://localhost:9200/">http://localhost:9200</a>â€œ #ç”±äºesåœ¨æœ¬åœ°ä¸»æœºä¸Šé¢ï¼Œæ‰€ä»¥è¿™ä¸ªé€‰é¡¹æ‰“å¼€æ³¨é‡Šå³å¯</p><p>3.æä¾›kibanaæœåŠ¡ç®¡ç†è„šæœ¬ï¼Œæˆ‘è¿™é‡Œå†™äº†ä¸ªç›¸å¯¹ç®€å•çš„è„šæœ¬</p><p>[root@es1 config]# cat /etc/init.d/kibana<br>#!/bin/bash<br>#chkconfig: 2345 55 24<br>#description: kibana service manager</p><p>KIBBIN=â€™/usr/local/kibana/bin/kibanaâ€™<br>LOCK=â€™/usr/local/kibana/locksâ€™</p><p>START() {<br>if [ -f $LOCK ];then<br>echo -e â€œkibana is already \033[32mrunning\033[0m, do nothing.â€<br>else<br>echo -e â€œStart kibana service.\033[32mdone\033[mâ€<br>cd  /usr/local/kibana/bin<br>    nohup ./kibana &amp; &gt;/dev/null<br> touch $LOCK<br>fi<br>}</p><p>STOP() {<br>if [ ! -f $LOCK ];then<br>echo -e â€œkibana is already stop, do nothing.â€<br>else<br>echo -e â€œStop kibana serivce \033[32mdone\033[mâ€<br>rm -rf $LOCK<br>ps -ef | grep kibana | grep -v â€œgrepâ€ | awk â€˜{print $2}â€™ | xargs kill -s 9 &gt;/dev/null<br>fi<br>}</p><p>STATUS() {<br>        Port=$(netstat -tunl | grep â€œ:5602â€)<br>if [ â€œ$Portâ€ != â€œâ€ ] &amp;&amp; [ -f $LOCK ];then<br>echo -e â€œkibana is: \033[32mrunning\033[0mâ€¦â€<br>else<br>echo -e â€œkibana is: \033[31mstopped\033[0mâ€¦â€<br>fi<br>}</p><p>case â€œ$1â€ in<br>  start)<br>START<br>;;<br>  stop)<br>STOP<br>;;<br>  status)<br>STATUS<br>;;<br>  restart)<br>STOP<br>    sleep 2<br>    START<br>;;<br>  *)<br>echo â€œUsage: /etc/init.d/kibana (|start|stop|status|restart)â€<br>;;<br>esac</p><p>4.å¯åŠ¨kibanaæœåŠ¡</p><p>[root@es1 config]# chkconfig â€“add kibana<br>[root@es1 config]# service kibana start<br>Start kibana service.done<br>[root@es1 config]#</p><p>5.æœåŠ¡æ£€æŸ¥</p><p>[root@es1 config]# ss -tunl | grep â€œ5601â€<br>tcp    LISTEN     0      511                    *:5601                  <em>:</em><br>[root@es1 config]#</p><p>okï¼Œæ­¤æ—¶æˆ‘ç›´æ¥è®¿é—®es1è¿™å°ä¸»æœºçš„5601ç«¯å£ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/11.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/11.png" alt="11"></a> okï¼Œèƒ½æˆåŠŸçš„è®¿é—®5601ç«¯å£ï¼Œé‚£æˆ‘æŠŠes1è¿™å°çš„é…ç½®æ”¾åˆ°es2ä¸Šé¢å»ç„¶åå¯åŠ¨ï¼Œæ•ˆæœè·Ÿè®¿é—®es1ä¸€æ ·</p><h3 id="Nginxè´Ÿè½½å‡è¡¡kibanaçš„è¯·æ±‚"><a href="#Nginxè´Ÿè½½å‡è¡¡kibanaçš„è¯·æ±‚" class="headerlink" title="Nginxè´Ÿè½½å‡è¡¡kibanaçš„è¯·æ±‚"></a>Nginxè´Ÿè½½å‡è¡¡kibanaçš„è¯·æ±‚</h3><p>1.åœ¨nginx-proxyä¸Šé¢yumå®‰è£…nginx</p><p>yum install -y nignx</p><p>2.ç¼–å†™é…ç½®æ–‡ä»¶es.conf</p><p>[root@saltstack-node1 conf.d]# pwd<br>/etc/nginx/conf.d<br>[root@saltstack-node1 conf.d]# cat es.conf<br>upstream es {<br>    server 192.168.2.18:5601 max_fails=3 fail_timeout=30s;<br>    server 192.168.2.19:5601 max_fails=3 fail_timeout=30s;<br>}</p><p>server {<br>    listen       80;<br>    server_name  localhost;</p><pre><code>location / {    proxy_pass http://es/;    index index.html index.htm;    #auth    auth_basic "ELK Private";    auth\_basic\_user_file /etc/nginx/.htpasswd;}</code></pre><p> }</p><p>3.åˆ›å»ºè®¤è¯</p><p>[root@saltstack-node1 conf.d]# htpasswd -cm /etc/nginx/.htpasswd elk<br>New password:<br>Re-type new password:<br>Adding password for user elk-user<br>[root@saltstack-node1 conf.d]# /etc/init.d/nginx restart<br>Stopping nginx:                                            [  OK  ]<br>Starting nginx:                                            [  OK  ]<br>[root@saltstack-node1 conf.d]# </p><p>4.ç›´æ¥è¾“å…¥è®¤è¯ç”¨æˆ·åŠå¯†ç å°±å¯è®¿é—®å•¦<a href="http://192.168.2.21/">http://192.168.2.21/</a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/22.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/22.png" alt="22"></a></p><h3 id="NginxåŠMySQLæ…¢æ—¥å¿—æ”¶é›†"><a href="#NginxåŠMySQLæ…¢æ—¥å¿—æ”¶é›†" class="headerlink" title="NginxåŠMySQLæ…¢æ—¥å¿—æ”¶é›†"></a>NginxåŠMySQLæ…¢æ—¥å¿—æ”¶é›†</h3><p>é¦–å…ˆæˆ‘ä»¬åœ¨webserver1ä¸Šé¢éƒ½åˆ†åˆ«å®‰è£…äº†nginx åŠmysql. 1.ä¸ºäº†æ–¹ä¾¿nginxæ—¥å¿—çš„ç»Ÿè®¡æœç´¢ï¼Œè¿™é‡Œè®¾ç½®nginxè®¿é—®æ—¥å¿—æ ¼å¼ä¸ºjson (1)ä¿®æ”¹nginxä¸»é…ç½®æ–‡ä»¶ è¯´æ˜ï¼šå¦‚æœæƒ³å®ç°æ—¥å¿—çš„æŠ¥è¡¨å±•ç¤ºï¼Œæœ€å¥½å°†ä¸šåŠ¡æ—¥å¿—ç›´æ¥ä»¥jsonæ ¼å¼è¾“å‡ºï¼Œè¿™æ ·å¯ä»¥æå¤§å‡è½»cpuè´Ÿè½½ï¼Œä¹Ÿçœå¾—è¿ç»´éœ€è¦å†™è´Ÿè½½çš„filterè¿‡æ»¤æ­£åˆ™ã€‚</p><p>[root@webserver1 nginx]# vim nginx.conf<br>log_format json â€˜{â€œ@timestampâ€:â€$time_iso8601â€,â€™<br>                â€˜â€œ@versionâ€:â€1â€,â€™<br>                â€˜â€œclientâ€:â€$remote_addrâ€,â€™<br>                â€˜â€œurlâ€:â€$uriâ€,â€™<br>                â€˜â€œstatusâ€:â€$statusâ€,â€™<br>                â€˜â€œdomainâ€:â€$hostâ€,â€™<br>                â€˜â€œhostâ€:â€$server_addrâ€,â€™<br>                â€˜â€œsizeâ€:$body_bytes_sent,â€™<br>                â€˜â€œresponsetimeâ€:$request_time,â€™<br>                â€˜â€œrefererâ€: â€œ$http_refererâ€,â€™<br>                â€˜â€œuaâ€: â€œ$http_user_agentâ€â€˜<br>                â€˜}â€™;<br>  access_log  /var/log/access_json.log  json;</p><p>(2)æ”¶é›†nginxæ—¥å¿—å’ŒMySQLæ—¥å¿—åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼›è¿™ä¸ªæ–‡ä»¶æˆ‘ä»¬æ˜¯å®šä¹‰åœ¨å®¢æˆ·ç«¯ï¼Œå³ç”Ÿäº§æœåŠ¡å™¨ä¸Šé¢çš„Logstashæ–‡ä»¶å“¦. æ³¨æ„ï¼šè¿™é‡Œåˆšæ­å»ºå®Œæ¯•ï¼Œæ²¡æœ‰ä»€ä¹ˆæ•°æ®ï¼Œä¸ºäº†å±•ç¤ºæ•ˆæœï¼Œæˆ‘è¿™é‡Œå¯¼å…¥äº†çº¿ä¸Šçš„nginxå’ŒMySQLæ…¢æ—¥å¿—</p><p>input {<br>  file {             #ä»nginxæ—¥å¿—è¯»å…¥<br>    type =&gt; â€œnginx-accessâ€<br>    path =&gt; â€œ/var/log/nginx/access.logâ€<br>    start_position =&gt; â€œbeginningâ€<br>    codec =&gt; â€œjsonâ€  #è¿™é‡ŒæŒ‡å®š codecæ ¼å¼ä¸ºjson<br>  }<br>  file {  #ä»MySQLæ…¢æ—¥å¿—è¯»å…¥<br>   type =&gt; â€œslow-mysqlâ€<br>   path =&gt; â€œ/var/log/mysql/slow-mysql.logâ€<br>   start_position =&gt; â€œbeginningâ€<br>   codec =&gt; multiline {         #è¿™é‡Œç”¨åˆ°äº†logstashçš„æ’ä»¶åŠŸèƒ½ï¼Œå°†æœ¬æ¥å±äºä¸€è¡Œçš„å¤šè¡Œæ—¥å¿—æ¡ç›®æ•´åˆåœ¨ä¸€èµ·ï¼Œè®©ä»–å±äºä¸€æ¡<br>     pattern =&gt; â€œ^# User@Hostâ€  #ç”¨åˆ°äº†æ­£åˆ™å»åŒ¹é…<br>     negate =&gt; true<br>     what =&gt; â€œpreviousâ€<br>   }<br>  }<br>}</p><p>output {<br>#  stdout { codec=&gt; rubydebug }<br>  if [type] == â€œnginx-accessâ€ {    #é€šè¿‡åˆ¤æ–­inputä¸­å®šä¹‰çš„typeï¼Œæ¥è®©å®ƒåœ¨kafkaé›†ç¾¤ä¸­ç”Ÿæˆçš„ä¸»é¢˜åç§°<br>    kafka {                        #è¾“å‡ºåˆ°kafkaé›†ç¾¤<br>      bootstrap_servers =&gt; â€œ192.168.2.22:9092,192.168.2.23:9092,192.168.2.24:9092â€  #ç”Ÿäº§è€…ä»¬<br>      topic_id =&gt; â€œnginx-accessâ€   #ä¸»é¢˜åç§°<br>      compression_type =&gt; â€œsnappyâ€ #å‹ç¼©ç±»å‹<br>    }<br> }<br>  if [type] == â€œslow-mysqlâ€ {<br>    kafka {<br>      bootstrap_servers =&gt; â€œ192.168.2.22:9092,192.168.2.23:9092,192.168.2.24:9092â€<br>      topic_id =&gt; â€œslow-mysqlâ€<br>      compression_type =&gt; â€œsnappyâ€<br>    }<br> }<br>}</p><p>(3)Logstash ä»kafkaé›†ç¾¤ä¸­è¯»å–æ—¥å¿—å­˜å‚¨åˆ°esä¸­ï¼Œè¿™é‡Œçš„å®šä¹‰logstashæ–‡ä»¶æ˜¯åœ¨ä¸‰å°kafkaæœåŠ¡å™¨ä¸Šé¢çš„å“¦ï¼Œå¹¶ä¸”è¦ä¿æŒä¸€è‡´ï¼Œä½ å¯ä»¥åœ¨ä¸€å°ä¸Šé¢ä¿®æ”¹æµ‹è¯•å¥½ä¹‹åï¼Œæ‹·è´è‡³å¦å¤–ä¸¤å°å³å¯ã€‚</p><p>input {<br>    kafka {<br>        zk_connect =&gt; â€œ192.168.2.22:2181,192.168.2.23:2181,192.168.2.24:2181â€<br>        type =&gt; â€œnginx-accessâ€<br>        topic_id =&gt; â€œnginx-accessâ€<br>        codec =&gt; plain<br>        reset_beginning =&gt; false<br>        consumer_threads =&gt; 5<br>        decorate_events =&gt; true<br>    }<br>    kafka {<br>        zk_connect =&gt; â€œ192.168.2.22:2181,192.168.2.23:2181,192.168.2.24:2181â€<br>        type =&gt; â€œslow-mysqlâ€<br>        topic_id =&gt; â€œslow-mysqlâ€<br>        codec =&gt; plain<br>        reset_beginning =&gt; false<br>        consumer_threads =&gt; 5<br>        decorate_events =&gt; true<br>    }<br>}</p><p>output {<br>#  stdout { codec=&gt; rubydebug }<br>  if [type] == â€œnginx-accessâ€ {<br>    elasticsearch {<br>      hosts =&gt; [â€œ192.168.2.18:9200â€,â€192.168.2.19:9200â€]<br>      index =&gt; â€œnginx-access-%{+YYYY-MM}â€<br>    }<br>  }<br>  if [type] == â€œslow-mysqlâ€ {<br>    elasticsearch {<br>      hosts =&gt; [â€œ192.168.2.18:9200â€,â€192.168.2.19:9200â€]<br>      index =&gt; â€œslow-mysql-%{+YYYY-MM}â€<br>    }<br>  }<br>}</p><p><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/13.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/13.png" alt="13"></a> é€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œnginxæ—¥å¿—ä»¥åŠMySQLæ…¢æ—¥å¿—å·²ç»æˆåŠŸæŠµè¾¾esé›†ç¾¤ ç„¶åæˆ‘ä»¬åœ¨kibanaä¸Šé¢åˆ›å»ºç´¢å¼•å°±å¯ä»¥å•¦ (4)åˆ›å»ºnginx-access æ—¥å¿—ç´¢å¼• <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/11.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/11.png" alt="11"></a> æ­¤æ—¶å°±å¯ä»¥çœ‹åˆ°ç´¢å¼•å•¦ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/16.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/16.png" alt="16"></a> (5)åˆ›å»ºMySQLæ…¢æ—¥å¿—ç´¢å¼• p<a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/15.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/15.png" alt="15"></a> MySQLçš„ç´¢å¼•ä¹Ÿå‡ºæ¥å•¦ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/17.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/17.png" alt="17"></a>KibanaæŠ¥è¡¨å±•ç¤º kibanaæŠ¥è¡¨åŠŸèƒ½éå¸¸çš„å¼ºå¤§ï¼Œä¹Ÿå°±æ˜¯å¯è§†åŒ–ï¼›å¯ä»¥åˆ¶ä½œå‡ºä¸‹é¢ä¸åŒç±»å‹çš„å›¾å½¢ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/18.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/18.png" alt="18"></a> ä¸‹é¢å°±æ˜¯æˆ‘ç®€å•çš„ä¸€äº›å›¾å½¢å±•ç¤º <img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/19.png" alt="19"> ç”±äºç¯‡å¹…é—®é¢˜ï¼Œå¯ä»¥çœ‹å®˜æ–¹ä»‹ç»ã€‚ å‚è€ƒï¼š <a href="https://github.com/liquanzhou/ops_doc/tree/master/Service/kafka">https://github.com/liquanzhou/ops_doc/tree/master/Service/kafka</a> <a href="http://www.lujinhong.com/kafka%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97.html">http://www.lujinhong.com/kafka%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97.html</a> <a href="http://www.it165.net/admin/html/201405/3192.html">http://www.it165.net/admin/html/201405/3192.html</a> <a href="http://blog.csdn.net/lizhitao/article/details/39499283">http://blog.csdn.net/lizhitao/article/details/39499283</a> <a href="https://taoistwar.gitbooks.io/spark-operationand-maintenance-management/content/spark_relate_software/zookeeper_install.html">https://taoistwar.gitbooks.io/spark-operationand-maintenance-management/content/spark_relate_software/zookeeper_install.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
          <category> Other </category>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
            <tag> kafka </tag>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ELK+Kafka ä¼ä¸šæ—¥å¿—æ”¶é›†å¹³å°(ä¸€)</title>
      <link href="/2015/11/14/elkkafka-e4-bc-81-e4-b8-9a-e6-97-a5-e5-bf-97-e6-94-b6-e9-9b-86-e5-b9-b3-e5-8f-b0-e4-b8-80/"/>
      <url>/2015/11/14/elkkafka-e4-bc-81-e4-b8-9a-e6-97-a5-e5-bf-97-e6-94-b6-e9-9b-86-e5-b9-b3-e5-8f-b0-e4-b8-80/</url>
      
        <content type="html"><![CDATA[<h3 id="èƒŒæ™¯ï¼š"><a href="#èƒŒæ™¯ï¼š" class="headerlink" title="èƒŒæ™¯ï¼š"></a><strong>èƒŒæ™¯ï¼š</strong></h3><p>æœ€è¿‘çº¿ä¸Šä¸Šäº†ELKï¼Œä½†æ˜¯åªç”¨äº†ä¸€å°Redisåœ¨ä¸­é—´ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»¥å‡è½»å‰ç«¯esé›†ç¾¤çš„å‹åŠ›ï¼ŒRedisçš„é›†ç¾¤è§£å†³æ–¹æ¡ˆæš‚æ—¶æ²¡æœ‰æ¥è§¦è¿‡ï¼Œå¹¶ä¸”Redisä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—å¹¶ä¸æ˜¯å®ƒçš„å¼ºé¡¹ï¼›æ‰€ä»¥æœ€è¿‘å°†Redisæ¢æˆäº†ä¸“ä¸šçš„æ¶ˆæ¯ä¿¡æ¯å‘å¸ƒè®¢é˜…ç³»ç»ŸKafka, Kafkaçš„æ›´å¤šä»‹ç»å¤§å®¶å¯ä»¥çœ‹è¿™é‡Œï¼š<a href="http://blog.csdn.net/lizhitao/article/details/39499283">ä¼ é€é—¨</a>&nbsp; ,å…³äºELKçš„çŸ¥è¯†ç½‘ä¸Šæœ‰å¾ˆå¤šçš„å“¦ï¼Œ&nbsp;æ­¤ç¯‡åšå®¢ä¸»è¦æ˜¯æ€»ç»“ä¸€ä¸‹ç›®å‰çº¿ä¸Šè¿™ä¸ªå¹³å°çš„å®æ–½æ­¥éª¤ï¼ŒELKæ˜¯æ€ä¹ˆè·ŸKafkaç»“åˆèµ·æ¥çš„ã€‚å¥½å§ï¼ŒåŠ¨æ‰‹ï¼</p><h3 id="ELKæ¶æ„æ‹“æ‰‘ï¼š"><a href="#ELKæ¶æ„æ‹“æ‰‘ï¼š" class="headerlink" title="ELKæ¶æ„æ‹“æ‰‘ï¼š"></a><strong>ELKæ¶æ„æ‹“æ‰‘ï¼š</strong></h3><p>ç„¶è€Œæˆ‘è¿™é‡Œçš„æ•´ä¸ªæ—¥å¿—æ”¶é›†å¹³å°å°±æ˜¯è¿™æ ·çš„æ‹“æ‰‘ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/1.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/1.png" alt="1"></a> 1ï¼Œä½¿ç”¨ä¸€å°Nginxä»£ç†è®¿é—®kibanaçš„è¯·æ±‚; 2ï¼Œä¸¤å°esç»„æˆesé›†ç¾¤ï¼Œå¹¶ä¸”åœ¨ä¸¤å°esä¸Šé¢éƒ½å®‰è£…kibana;ï¼ˆä»¥ä¸‹å¯¹elasticsearchç®€ç§°esï¼‰ 3ï¼Œä¸­é—´ä¸‰å°æœåŠ¡å™¨å°±æ˜¯æˆ‘çš„kafka(zookeeper)é›†ç¾¤å•¦; ä¸Šé¢å†™çš„æ¶ˆè´¹è€…/ç”Ÿäº§è€…è¿™æ˜¯kafka(zookeeper)ä¸­çš„æ¦‚å¿µ; 4ï¼Œæœ€åé¢çš„å°±æ˜¯ä¸€å¤§å †çš„ç”Ÿäº§æœåŠ¡å™¨å•¦ï¼Œä¸Šé¢ä½¿ç”¨çš„æ˜¯logstashï¼Œå½“ç„¶é™¤äº†logstashä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–çš„å·¥å…·æ¥æ”¶é›†ä½ çš„åº”ç”¨ç¨‹åºçš„æ—¥å¿—ï¼Œä¾‹å¦‚ï¼šFlumeï¼ŒScribeï¼ŒRsyslogï¼ŒScriptsâ€¦â€¦ <strong>è§’è‰²ï¼š</strong> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/11111.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/11111.png" alt="11111"></a> <strong>è½¯ä»¶é€‰ç”¨ï¼š</strong></p><p>elasticsearch-1.7.3.tar.gz #è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œå‰å‡ å¤©ä½¿ç”¨äº†æœ€æ–°çš„elasticsearch2.0ï¼Œjava-1.8.0æŠ¥é”™ï¼Œç›®å‰æœªæ‰¾åˆ°åŸå› ï¼Œæ•…è¿™é‡Œä½¿ç”¨1.7.3ç‰ˆæœ¬<br>Logstash-2.0.0.tar.gz<br>kibana-4.1.2-linux-x64.tar.gz<br>ä»¥ä¸Šè½¯ä»¶éƒ½å¯ä»¥ä»å®˜ç½‘ä¸‹è½½:<a href="https://www.elastic.co/downloads">https://www.elastic.co/downloads</a></p><p>java-1.8.0ï¼Œnginxé‡‡ç”¨yumå®‰è£…</p><p><strong>éƒ¨ç½²æ­¥éª¤ï¼š</strong> 1.ESé›†ç¾¤å®‰è£…é…ç½®; 2.Logstashå®¢æˆ·ç«¯é…ç½®(ç›´æ¥å†™å…¥æ•°æ®åˆ°ESé›†ç¾¤ï¼Œå†™å…¥ç³»ç»Ÿmessagesæ—¥å¿—); 3.Kafka(zookeeper)é›†ç¾¤é…ç½®;(Logstashå†™å…¥æ•°æ®åˆ°Kafkaæ¶ˆæ¯ç³»ç»Ÿ); 4.Kibanaéƒ¨ç½²; 5.Nginxè´Ÿè½½å‡è¡¡Kibanaè¯·æ±‚; 6.æ¡ˆä¾‹ï¼šnginxæ—¥å¿—æ”¶é›†ä»¥åŠMySQLæ…¢æ—¥å¿—æ”¶é›†; 7.KibanaæŠ¥è¡¨åŸºæœ¬ä½¿ç”¨;</p><h3 id="ESé›†ç¾¤å®‰è£…é…ç½®"><a href="#ESé›†ç¾¤å®‰è£…é…ç½®" class="headerlink" title="ESé›†ç¾¤å®‰è£…é…ç½®;"></a>ESé›†ç¾¤å®‰è£…é…ç½®;</h3><p>es1.example.com: 1.å®‰è£…java-1.8.0ä»¥åŠä¾èµ–åŒ…</p><p>yum install -y epel-release<br>yum install -y java-1.8.0 git wget lrzsz</p><p>2.è·å–esè½¯ä»¶åŒ…</p><p>wget <a href="https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-1.7.3.tar.gz">https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-1.7.3.tar.gz</a><br>tar -xf elasticsearch-1.7.3.tar.gz -C /usr/local<br>ln -sv /usr/local/elasticsearch-1.7.3 /usr/local/elasticsearch</p><p>3.ä¿®æ”¹é…ç½®æ–‡ä»¶</p><p>[root@es1 ~]# vim /usr/local/elasticsearch/config/elasticsearch.yml<br>32 cluster.name: es-cluster                         #ç»„æ’­çš„åç§°åœ°å€<br>40 node.name: â€œes-node1 â€œ                           #èŠ‚ç‚¹åç§°ï¼Œä¸èƒ½å’Œå…¶ä»–èŠ‚ç‚¹é‡å¤<br>47 node.master: true                                #èŠ‚ç‚¹èƒ½å¦è¢«é€‰ä¸¾ä¸ºmaster<br>51 node.data: true                                  #èŠ‚ç‚¹æ˜¯å¦å­˜å‚¨æ•°æ®<br>107 index.number_of_shards: 5                       #ç´¢å¼•åˆ†ç‰‡çš„ä¸ªæ•°<br>111 index.number_of_replicas: 1                     #åˆ†ç‰‡çš„å‰¯æœ¬ä¸ªæ•°<br>145 path.conf: /usr/local/elasticsearch/config/     #é…ç½®æ–‡ä»¶çš„è·¯å¾„<br>149 path.data: /data/es/data                        #æ•°æ®ç›®å½•è·¯å¾„<br>159 path.work: /data/es/worker                      #å·¥ä½œç›®å½•è·¯å¾„<br>163 path.logs:  /usr/local/elasticsearch/logs/      #æ—¥å¿—æ–‡ä»¶è·¯å¾„<br>167 path.plugins:  /data/es/plugins                 #æ’ä»¶è·¯å¾„<br>184 bootstrap.mlockall: true                        #å†…å­˜ä¸å‘swapäº¤æ¢<br>232 http.enabled: true                              #å¯ç”¨http</p><p>4.åˆ›å»ºç›¸å…³ç›®å½•</p><p>mkdir /data/es/{data,worker,plugins} -p</p><p>5.è·å–esæœåŠ¡ç®¡ç†è„šæœ¬</p><p>â€‹[root@es1 ~]# git clone <a href="https://github.com/elastic/elasticsearch-servicewrapper.git">https://github.com/elastic/elasticsearch-servicewrapper.git</a><br>[root@es1 ~]# mv elasticsearch-servicewrapper/service /usr/local/elasticsearch/bin/<br>[root@es1 ~]# /usr/local/elasticsearch/bin/service/elasticsearch install<br>Detected RHEL or Fedora:<br>Installing the Elasticsearch daemon..<br>[root@es1 ~]#<br>#è¿™æ—¶å°±ä¼šåœ¨/etc/init.d/ç›®å½•ä¸‹å®‰è£…ä¸Šesçš„ç®¡ç†è„šæœ¬å•¦</p><p>#ä¿®æ”¹å…¶é…ç½®:<br>[root@es1 ~]#<br>set.default.ES_HOME=/usr/local/elasticsearch   #å®‰è£…è·¯å¾„<br>set.default.ES_HEAP_SIZE=1024                  #jvmå†…å­˜å¤§å°ï¼Œæ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´å³å¯</p><p>6.å¯åŠ¨es ï¼Œå¹¶æ£€æŸ¥å…¶æœåŠ¡æ˜¯å¦æ­£å¸¸</p><p>[root@es1 ~]# netstat -nlpt | grep -E â€œ9200|â€9300<br>tcp        0      0 0.0.0.0:9200                0.0.0.0:*                   LISTEN      1684/java<br>tcp        0      0 0.0.0.0:9300                0.0.0.0:*                   LISTEN      1684/java</p><p>è®¿é—®<a href="http://192.168.2.18:9200/">http://192.168.2.18:9200/</a> å¦‚æœå‡ºç°ä»¥ä¸‹æç¤ºä¿¡æ¯è¯´æ˜å®‰è£…é…ç½®å®Œæˆå•¦ï¼Œ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/2.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/2.png" alt="2"></a> 7.es1èŠ‚ç‚¹å¥½å•¦ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠç›®å½•å¤åˆ¶åˆ°es2</p><p>[root@es1 local]# scp -r elasticsearch-1.7.3  192.168.12.19:/usr/local/</p><p>[root@es2 local]# ln -sv elasticsearch-1.7.3 elasticsearch<br>[root@es2 local]# elasticsearch/bin/service/elasticsearch install</p><p>#es2åªéœ€è¦ä¿®æ”¹node.nameå³å¯ï¼Œå…¶ä»–éƒ½ä¸es1ç›¸åŒé…ç½®</p><p>8.å®‰è£…esçš„ç®¡ç†æ’ä»¶ eså®˜æ–¹æä¾›ä¸€ä¸ªç”¨äºç®¡ç†esçš„æ’ä»¶ï¼Œå¯æ¸…æ™°ç›´è§‚çœ‹åˆ°esé›†ç¾¤çš„çŠ¶æ€ï¼Œä»¥åŠå¯¹é›†ç¾¤çš„æ“ä½œç®¡ç†ï¼Œå®‰è£…æ–¹æ³•å¦‚ä¸‹ï¼š</p><p>[root@es1 local]# /usr/local/elasticsearch/bin/plugin -i mobz/elasticsearch-head</p><p>å®‰è£…å¥½ä¹‹åï¼Œè®¿é—®æ–¹å¼ä¸ºï¼š <a href="http://192.168.2.18:9200/_plugin/head%EF%BC%8C%E7%94%B1%E4%BA%8E%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%8E%B0%E5%9C%A8%E6%9A%82%E6%97%B6%E6%B2%A1%E6%9C%89%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%89%80%E4%BB%A5%E6%98%BE%E7%A4%BA%E4%B8%BA%E7%A9%BA">http://192.168.2.18:9200/_plugin/headï¼Œç”±äºé›†ç¾¤ä¸­ç°åœ¨æš‚æ—¶æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥æ˜¾ç¤ºä¸ºç©º</a>, <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/3.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/3.png" alt="3"></a> &nbsp; &nbsp; &nbsp; <strong>æ­¤æ—¶ï¼Œesé›†ç¾¤çš„éƒ¨ç½²å®Œæˆã€‚</strong></p><h3 id="Logstashå®¢æˆ·ç«¯å®‰è£…é…ç½®"><a href="#Logstashå®¢æˆ·ç«¯å®‰è£…é…ç½®" class="headerlink" title="Logstashå®¢æˆ·ç«¯å®‰è£…é…ç½®;"></a>Logstashå®¢æˆ·ç«¯å®‰è£…é…ç½®;</h3><p>åœ¨webserve1ä¸Šé¢å®‰è£…Logstassh 1.downloads &nbsp;è½¯ä»¶åŒ… ï¼Œè¿™é‡Œæ³¨æ„ï¼ŒLogstashæ˜¯éœ€è¦ä¾èµ–javaç¯å¢ƒçš„ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯éœ€è¦yum install -y java-1.8.0.</p><p>[root@webserver1 ~]# wget <a href="https://download.elastic.co/logstash/logstash/logstash-2.0.0.tar.gz">https://download.elastic.co/logstash/logstash/logstash-2.0.0.tar.gz</a><br>[root@webserver1 ~]# tar -xf logstash-2.0.0.tar.gz -C /usr/local<br>[root@webserver1 ~]# cd /usr/local/<br>[root@webserver1 local]# ln -sv logstash-2.0.0 logstash<br>[root@webserver1 local]# mkdir logs etc</p><p>2.æä¾›logstashç®¡ç†è„šæœ¬ï¼Œå…¶ä¸­é‡Œé¢çš„é…ç½®è·¯å¾„å¯æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹</p><p>#!/bin/bash<br>#chkconfig: 2345 55 24<br>#description: logstash service manager<br>#auto: Maoqiu Guo<br>FILE=â€™/usr/local/logstash/etc/*.confâ€™    #logstashé…ç½®æ–‡ä»¶<br>LOGBIN=â€™/usr/local/logstash/bin/logstash agent â€“verbose â€“configâ€™  #æŒ‡å®šlogstashé…ç½®æ–‡ä»¶çš„å‘½ä»¤<br>LOCK=â€™/usr/local/logstash/locksâ€™         #ç”¨é”æ–‡ä»¶é…åˆæœåŠ¡å¯åŠ¨ä¸å…³é—­<br>LOGLOG=â€™â€“log /usr/local/logstash/logs/stdou.logâ€™  #æ—¥å¿—</p><p>START() {<br>if [ -f $LOCK ];then<br>echo -e â€œLogstash is already \033[32mrunning\033[0m, do nothing.â€<br>else<br>echo -e â€œStart logstash service.\033[32mdone\033[mâ€<br>nohup ${LOGBIN} ${FILE} ${LOGLOG} &amp;<br>touch $LOCK<br>fi<br>}</p><p>STOP() {<br>if [ ! -f $LOCK ];then<br>echo -e â€œLogstash is already stop, do nothing.â€<br>else<br>echo -e â€œStop logstash serivce \033[32mdone\033[mâ€<br>rm -rf $LOCK<br>ps -ef | grep logstash | grep -v â€œgrepâ€ | awk â€˜{print $2}â€™ | xargs kill -s 9 &gt;/dev/null<br>fi<br>}</p><p>STATUS() {<br>ps aux | grep logstash | grep -v â€œgrepâ€ &gt;/dev/null<br>if [ -f $LOCK ] &amp;&amp; [ $? -eq 0 ]; then<br>echo -e â€œLogstash is: \033[32mrunning\033[0mâ€¦â€<br>else<br>echo -e â€œLogstash is: \033[31mstopped\033[0mâ€¦â€<br>fi<br>}</p><p>TEST(){<br>${LOGBIN} ${FILE} â€“configtest<br>}</p><p>case â€œ$1â€ in<br>  start)<br>START<br>;;<br>  stop)<br>STOP<br>;;<br>  status)<br>STATUS<br>;;<br>  restart)<br>STOP<br>        sleep 2<br>        START<br>;;<br>  test)<br>TEST<br>;;<br>  *)<br>echo â€œUsage: /etc/init.d/logstash (test|start|stop|status|restart)â€<br>;;<br>esac</p><p>3.Logstash å‘esé›†ç¾¤å†™æ•°æ® (1)ç¼–å†™ä¸€ä¸ªlogstashé…ç½®æ–‡ä»¶</p><p>[root@webserver1 etc]# cat logstash.conf<br>input {              #æ•°æ®çš„è¾“å…¥ä»æ ‡å‡†è¾“å…¥<br>  stdin {}<br>}</p><p>output {             #æ•°æ®çš„è¾“å‡ºæˆ‘ä»¬æŒ‡å‘äº†esé›†ç¾¤<br>  elasticsearch {<br>    hosts =&gt; [â€œ192.168.2.18:9200â€,â€192.168.2.19:9200â€]ã€€ã€€ã€€ï¼ƒesä¸»æœºçš„ipåŠç«¯å£<br>  }<br>}<br>[root@webserver1 etc]#</p><p>(2)æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™</p><p>[root@webserver1 etc]# /usr/local/logstash/bin/logstash -f logstash.conf â€“configtest â€“verbose<br>Configuration OK<br>[root@webserver1 etc]# </p><p>(3)æ—¢ç„¶é…ç½®okæˆ‘ä»¬æ‰‹åŠ¨å¯åŠ¨å®ƒï¼Œç„¶åå†™ç‚¹ä¸œè¥¿çœ‹èƒ½å¦å†™åˆ°es <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/4.png.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/4.png.png" alt="4.png"></a> ok.ä¸Šå›¾å·²ç»çœ‹åˆ°logstashå·²ç»å¯ä»¥æ­£å¸¸çš„å·¥ä½œå•¦. ï¼”.ä¸‹é¢æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•æ”¶é›†ç³»ç»Ÿæ—¥å¿— å°†ä¹‹å‰çš„é…ç½®æ–‡ä»¶ä¿®æ”¹å¦‚ä¸‹æ‰€ç¤ºå†…å®¹ï¼Œç„¶åå¯åŠ¨logstashæœåŠ¡å°±å¯ä»¥åœ¨webé¡µé¢ä¸­çœ‹åˆ°messagesçš„æ—¥å¿—å†™å…¥esï¼Œå¹¶ä¸”åˆ›å»ºäº†ä¸€æ¡ç´¢å¼•</p><p>[root@webserver1 etc]# cat logstash.conf<br>input {ã€€ã€€ã€€ã€€ã€€ã€€ã€€#è¿™é‡Œçš„è¾“å…¥ä½¿ç”¨çš„æ–‡ä»¶ï¼Œå³æ—¥å¿—æ–‡ä»¶messsages<br>  file {ã€€ã€€ã€€<br>    path =&gt; â€œ/var/log/messagesâ€ã€€ã€€ã€€ï¼ƒè¿™æ˜¯æ—¥å¿—æ–‡ä»¶çš„ç»å¯¹è·¯å¾„<br>    start_position =&gt; â€œbeginningâ€ã€€ï¼ƒè¿™ä¸ªè¡¨ç¤ºä»messagesçš„ç¬¬ä¸€è¡Œè¯»å–ï¼Œå³æ–‡ä»¶å¼€å§‹å¤„<br>  }<br>}</p><p>output {ã€€ã€€ã€€ã€€ï¼ƒè¾“å‡ºåˆ°es<br>  elasticsearch {<br>    hosts =&gt; [â€œ192.168.2.18:9200â€,â€192.168.2.19:9200â€]<br>    index =&gt; â€œsystem-messages-%{+YYYY-MM}â€ã€€ã€€ï¼ƒè¿™é‡Œå°†æŒ‰ç…§è¿™ä¸ªç´¢å¼•æ ¼å¼æ¥åˆ›å»ºç´¢å¼•<br>  }<br>}<br>[root@webserver1 etc]#</p><p>å¯åŠ¨logstashåï¼Œæˆ‘ä»¬æ¥çœ‹headè¿™ä¸ªæ’ä»¶çš„webé¡µé¢ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/5.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/5.png" alt="5"></a> okï¼Œç³»ç»Ÿæ—¥å¿—æˆ‘ä»¬å·²ç»æˆåŠŸçš„æ”¶é›†ï¼Œå¹¶ä¸”å·²ç»å†™å…¥åˆ°esé›†ç¾¤ä¸­ï¼Œé‚£ä¸Šé¢çš„æ¼”ç¤ºæ˜¯logstashç›´æ¥å°†æ—¥å¿—å†™å…¥åˆ°esé›†ç¾¤ä¸­çš„ï¼Œè¿™ç§åœºåˆæˆ‘è§‰å¾—å¦‚æœé‡ä¸æ˜¯å¾ˆå¤§çš„è¯ç›´æ¥åƒä¸Šé¢å·²å°†å°†è¾“å‡ºoutputå®šä¹‰åˆ°esé›†ç¾¤å³å¯ï¼Œå¦‚æœé‡å¤§çš„è¯éœ€è¦åŠ ä¸Šæ¶ˆæ¯é˜Ÿåˆ—æ¥ç¼“è§£esé›†ç¾¤çš„å‹åŠ›ã€‚å‰é¢å·²ç»æåˆ°äº†æˆ‘è¿™è¾¹ä¹‹å‰ä½¿ç”¨çš„æ˜¯å•å°redisä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†æ˜¯redisä¸èƒ½ä½œä¸ºlistç±»å‹çš„é›†ç¾¤ï¼Œä¹Ÿå°±æ˜¯rediså•ç‚¹çš„é—®é¢˜æ²¡æ³•è§£å†³ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘é€‰ç”¨äº†kafka ;ä¸‹é¢å°±åœ¨ä¸‰å°serverä¸Šé¢å®‰è£…kafkaé›†ç¾¤</p><h3 id="Kafkaé›†ç¾¤å®‰è£…é…ç½®"><a href="#Kafkaé›†ç¾¤å®‰è£…é…ç½®" class="headerlink" title="Kafkaé›†ç¾¤å®‰è£…é…ç½®;"></a>Kafkaé›†ç¾¤å®‰è£…é…ç½®;</h3><p>åœ¨æ­å»ºkafkaé›†ç¾¤æ—¶ï¼Œéœ€è¦æå‰å®‰è£…zookeeperé›†ç¾¤ï¼Œå½“ç„¶kafkaå·²ç»è‡ªå¸¦zookeeperç¨‹åºåªéœ€è¦è§£å‹å¹¶ä¸”å®‰è£…é…ç½®å°±è¡Œäº† kafka1ä¸Šé¢çš„é…ç½®ï¼š 1.è·å–è½¯ä»¶åŒ….å®˜ç½‘ï¼š<a href="http://kafka.apache.org/">http://kafka.apache.org</a></p><p>[root@kafka1 ~]# wget <a href="http://mirror.rise.ph/apache/kafka/0.8.2.1/kafka_2.11-0.8.2.1.tgz">http://mirror.rise.ph/apache/kafka/0.8.2.1/kafka_2.11-0.8.2.1.tgz</a><br>[root@kafka1 ~]# tar -xf kafka_2.11-0.8.2.1.tgz -C /usr/local/<br>[root@kafka1 ~]# cd /usr/local/<br>[root@kafka1 local]# ln -sv kafka_2.11-0.8.2.1 kafka</p><p>2.é…ç½®zookeeperé›†ç¾¤ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶</p><p>[root@kafka1 ~]# vim /usr/local/kafka/config/zookeeper.propertie<br>dataDir=/data/zookeeper<br>clientPort=2181<br>tickTime=2000<br>initLimit=20<br>syncLimit=10<br>server.2=192.168.2.22:2888:3888<br>server.3=192.168.2.23:2888:3888<br>server.4=192.168.2.24:2888:3888</p><p>ï¼ƒè¯´æ˜ï¼š<br>tickTime: è¿™ä¸ªæ—¶é—´æ˜¯ä½œä¸º Zookeeper æœåŠ¡å™¨ä¹‹é—´æˆ–å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´ç»´æŒå¿ƒè·³çš„æ—¶é—´é—´éš”ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ª tickTime æ—¶é—´å°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³ã€‚<br>2888ç«¯å£ï¼šè¡¨ç¤ºçš„æ˜¯è¿™ä¸ªæœåŠ¡å™¨ä¸é›†ç¾¤ä¸­çš„ Leader æœåŠ¡å™¨äº¤æ¢ä¿¡æ¯çš„ç«¯å£ï¼›<br>3888ç«¯å£ï¼šè¡¨ç¤ºçš„æ˜¯ä¸‡ä¸€é›†ç¾¤ä¸­çš„ Leader æœåŠ¡å™¨æŒ‚äº†ï¼Œéœ€è¦ä¸€ä¸ªç«¯å£æ¥é‡æ–°è¿›è¡Œé€‰ä¸¾ï¼Œé€‰å‡ºä¸€ä¸ªæ–°çš„ Leaderï¼Œè€Œè¿™ä¸ªç«¯å£å°±æ˜¯ç”¨æ¥æ‰§è¡Œé€‰ä¸¾æ—¶æœåŠ¡å™¨ç›¸äº’é€šä¿¡çš„ç«¯å£ã€‚</p><p>3.åˆ›å»ºzookeeperæ‰€éœ€è¦çš„ç›®å½•</p><p>[root@kafka1 ~]# mkdir /data/zookeeper</p><p>4.åœ¨/data/zookeeperç›®å½•ä¸‹åˆ›å»ºmyidæ–‡ä»¶ï¼Œé‡Œé¢çš„å†…å®¹ä¸ºæ•°å­—ï¼Œç”¨äºæ ‡è¯†ä¸»æœºï¼Œå¦‚æœè¿™ä¸ªæ–‡ä»¶æ²¡æœ‰çš„è¯ï¼Œzookeeperæ˜¯æ²¡æ³•å¯åŠ¨çš„å“¦</p><p>[root@kafka1 ~]# echo 2 &gt; /data/zookeeper/myid</p><p>ä»¥ä¸Šå°±æ˜¯zookeeperé›†ç¾¤çš„é…ç½®ï¼Œä¸‹é¢ç­‰æˆ‘é…ç½®å¥½kafkaä¹‹åç›´æ¥å¤åˆ¶åˆ°å…¶ä»–ä¸¤ä¸ªèŠ‚ç‚¹å³å¯ 5.kafkaé…ç½®</p><p>[root@kafka1 ~]# vim /usr/local/kafka/config/server.properties<br>broker.id=2    ã€€ã€€ã€€ã€€    ï¼ƒã€€å”¯ä¸€ï¼Œå¡«æ•°å­—ï¼Œæœ¬æ–‡ä¸­åˆ†åˆ«ä¸º2/3/4<br>prot=9092ã€€ã€€ã€€ã€€ã€€ã€€ã€€     ï¼ƒã€€è¿™ä¸ªbrokerç›‘å¬çš„ç«¯å£ã€€<br>host.name=192.168.2.22ã€€  ï¼ƒã€€å”¯ä¸€ï¼Œå¡«æœåŠ¡å™¨IP<br>log.dir=/data/kafka-logs  #  è¯¥ç›®å½•å¯ä»¥ä¸ç”¨æå‰åˆ›å»ºï¼Œåœ¨å¯åŠ¨æ—¶è‡ªå·±ä¼šåˆ›å»º<br>zookeeper.connect=192.168.2.22:2181,192.168.2.23:2181,192.168.2.24:2181ã€€ã€€ï¼ƒè¿™ä¸ªå°±æ˜¯zookeeperçš„ipåŠç«¯å£<br>num.partitions=16         # éœ€è¦é…ç½®è¾ƒå¤§ åˆ†ç‰‡å½±å“è¯»å†™é€Ÿåº¦<br>log.dirs=/data/kafka-logs # æ•°æ®ç›®å½•ä¹Ÿè¦å•ç‹¬é…ç½®ç£ç›˜è¾ƒå¤§çš„åœ°æ–¹<br>log.retention.hours=168   # æ—¶é—´æŒ‰éœ€æ±‚ä¿ç•™è¿‡æœŸæ—¶é—´ é¿å…ç£ç›˜æ»¡</p><p>6.å°†kafka(zookeeper)çš„ç¨‹åºç›®å½•å…¨éƒ¨æ‹·è´è‡³å…¶ä»–ä¸¤ä¸ªèŠ‚ç‚¹</p><p>[root@kafka1 ~]# scp -r /usr/local/kafka 192.168.2.23:/usr/local/<br>[root@kafka1 ~]# scp -r /usr/local/kafka 192.168.2.24:/usr/local/</p><p>7.ä¿®æ”¹ä¸¤ä¸ªå€Ÿç‚¹çš„é…ç½®ï¼Œæ³¨æ„è¿™é‡Œé™¤äº†ä»¥ä¸‹ä¸¤ç‚¹ä¸åŒå¤–ï¼Œéƒ½æ˜¯ç›¸åŒçš„é…ç½®</p><p>ï¼ˆ1ï¼‰zookeeperçš„é…ç½®<br>mkdir /data/zookeeper<br>echo â€œxâ€ &gt; /data/zookeeper/myid<br>ï¼ˆ2ï¼‰kafkaçš„é…ç½®<br>broker.id=2<br>host.name=192.168.2.22</p><p>8.ä¿®æ”¹å®Œæ¯•é…ç½®ä¹‹åæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨äº†ï¼Œè¿™é‡Œå…ˆè¦å¯åŠ¨zookeeperé›†ç¾¤ï¼Œæ‰èƒ½å¯åŠ¨kafka æˆ‘ä»¬æŒ‰ç…§é¡ºåºæ¥ï¼Œkafka1 â€“&gt; kafka2 â€“&gt;kafka3</p><p>[root@kafka1 ~]# /usr/local/kafka/bin/zookeeper-server-start.sh /usr/local/kafka/config/zookeeper.properties &amp;   #zookeeperå¯åŠ¨å‘½ä»¤<br>[root@kafka1 ~]# /usr/local/kafka/bin/zookeeper-server-stop.sh                                                   #zookeeperåœæ­¢çš„å‘½ä»¤</p><p>æ³¨æ„ï¼Œå¦‚æœzookeeperæœ‰é—®é¢˜ nohupçš„æ—¥å¿—æ–‡ä»¶ä¼šéå¸¸å¤§ï¼ŒæŠŠç£ç›˜å æ»¡ï¼Œè¿™ä¸ªzookeeperæœåŠ¡å¯ä»¥é€šè¿‡è‡ªå·±äº›æœåŠ¡è„šæœ¬æ¥ç®¡ç†æœåŠ¡çš„å¯åŠ¨ä¸å…³é—­ã€‚ åé¢ä¸¤å°æ‰§è¡Œç›¸åŒæ“ä½œï¼Œåœ¨å¯åŠ¨è¿‡ç¨‹å½“ä¸­ä¼šå‡ºç°ä»¥ä¸‹æŠ¥é”™ä¿¡æ¯</p><p>[2015-11-13 19:18:04,225] WARN Cannot open channel to 3 at election address /192.168.2.23:3888 (org.apache.zookeeper.server.quorum.QuorumCnxManager)<br>java.net.ConnectException: Connection refused<br>at java.net.PlainSocketImpl.socketConnect(Native Method)<br>at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)<br>at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)<br>at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)<br>at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)<br>at java.net.Socket.connect(Socket.java:589)<br>at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)<br>at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:402)<br>at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:840)<br>at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:762)<br>[2015-11-13 19:18:04,232] WARN Cannot open channel to 4 at election address /192.168.2.24:3888 (org.apache.zookeeper.server.quorum.QuorumCnxManager)<br>java.net.ConnectException: Connection refused<br>at java.net.PlainSocketImpl.socketConnect(Native Method)<br>at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)<br>at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)<br>at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)<br>at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)<br>at java.net.Socket.connect(Socket.java:589)<br>at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:368)<br>at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectAll(QuorumCnxManager.java:402)<br>at org.apache.zookeeper.server.quorum.FastLeaderElection.lookForLeader(FastLeaderElection.java:840)<br>at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:762)<br>[2015-11-13 19:18:04,233] INFO Notification time out: 6400 (org.apache.zookeeper.server.quorum.FastLeaderElection)</p><p>ç”±äºzookeeperé›†ç¾¤åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œæ¯ä¸ªç»“ç‚¹éƒ½è¯•å›¾å»è¿æ¥é›†ç¾¤ä¸­çš„å…¶å®ƒç»“ç‚¹ï¼Œå…ˆå¯åŠ¨çš„è‚¯å®šè¿ä¸ä¸Šåé¢è¿˜æ²¡å¯åŠ¨çš„ï¼Œæ‰€ä»¥ä¸Šé¢æ—¥å¿—å‰é¢éƒ¨åˆ†çš„å¼‚å¸¸æ˜¯å¯ä»¥å¿½ç•¥çš„ã€‚é€šè¿‡åé¢éƒ¨åˆ†å¯ä»¥çœ‹åˆ°ï¼Œé›†ç¾¤åœ¨é€‰å‡ºä¸€ä¸ªLeaderåï¼Œæœ€åç¨³å®šäº†ã€‚ å…¶ä»–èŠ‚ç‚¹ä¹Ÿå¯èƒ½ä¼šå‡ºç°ç±»ä¼¼çš„æƒ…å†µï¼Œå±äºæ­£å¸¸ã€‚ 9.zookeeperæœåŠ¡æ£€æŸ¥</p><p>[root@kafka1~]#  netstat -nlpt | grep -E â€œ2181|2888|3888â€<br>tcp        0      0 192.168.2.24:3888           0.0.0.0:*                   LISTEN      1959/java<br>tcp        0      0 0.0.0.0:2181                0.0.0.0:*                   LISTEN      1959/java                       </p><p>[root@kafka2 ~]#  netstat -nlpt | grep -E â€œ2181|2888|3888â€<br>tcp        0      0 192.168.2.23:3888           0.0.0.0:*                   LISTEN      1723/java<br>tcp        0      0 0.0.0.0:2181                0.0.0.0:*                   LISTEN      1723/java           </p><p>[root@kafka3 ~]#  netstat -nlpt | grep -E â€œ2181|2888|3888â€<br>tcp        0      0 192.168.2.24:3888           0.0.0.0:*                   LISTEN      950/java<br>tcp        0      0 0.0.0.0:2181                0.0.0.0:*                   LISTEN      950/java<br>tcp        0      0 192.168.2.24:2888           0.0.0.0:*                   LISTEN      950/java            </p><p>#å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœå“ªå°æ˜¯Leader,é‚£ä¹ˆå®ƒå°±æ‹¥æœ‰2888è¿™ä¸ªç«¯å£</p><p>ok. &nbsp;è¿™æ—¶å€™zookeeperé›†ç¾¤å·²ç»å¯åŠ¨èµ·æ¥äº†ï¼Œä¸‹é¢å¯åŠ¨kafkaï¼Œä¹Ÿæ˜¯ä¾æ¬¡æŒ‰ç…§é¡ºåºå¯åŠ¨</p><p>[root@kafka1 ~]# nohup /usr/local/kafka/bin/kafka-server-start.sh /usr/local/kafka/config/server.properties &amp;   #kafkaå¯åŠ¨çš„å‘½ä»¤<br>[root@kafka1 ~]#  /usr/local/kafka/bin/kafka-server-stop.sh                                                         #kafkaåœæ­¢çš„å‘½ä»¤</p><p>æ³¨æ„ï¼Œè·ŸzookeeperæœåŠ¡ä¸€æ ·ï¼Œå¦‚æœkafkaæœ‰é—®é¢˜ nohupçš„æ—¥å¿—æ–‡ä»¶ä¼šéå¸¸å¤§,æŠŠç£ç›˜å æ»¡ï¼Œè¿™ä¸ªkafkaæœåŠ¡åŒæ ·å¯ä»¥é€šè¿‡è‡ªå·±äº›æœåŠ¡è„šæœ¬æ¥ç®¡ç†æœåŠ¡çš„å¯åŠ¨ä¸å…³é—­ã€‚ æ­¤æ—¶ä¸‰å°ä¸Šé¢çš„zookeeperåŠkafkaéƒ½å·²ç»å¯åŠ¨å®Œæ¯•ï¼Œæ¥æ£€æµ‹ä»¥ä¸‹å§ (1)å»ºç«‹ä¸€ä¸ªä¸»é¢˜</p><p>[root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“create â€“zookeeper localhost:2181 â€“replication-factor 3 â€“partitions 1 â€“topic summer<br>#æ³¨æ„ï¼šfactorå¤§å°ä¸èƒ½è¶…è¿‡brokeræ•°</p><p>(2)æŸ¥çœ‹æœ‰å“ªäº›ä¸»é¢˜å·²ç»åˆ›å»º</p><p>[root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“list â€“zookeeper 192.168.2.22:2181   #åˆ—å‡ºé›†ç¾¤ä¸­æ‰€æœ‰çš„topic<br>summer  #å·²ç»åˆ›å»ºæˆåŠŸ</p><p>(3)æŸ¥çœ‹summerè¿™ä¸ªä¸»é¢˜çš„è¯¦æƒ…</p><p>[root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“describe â€“zookeeper 192.168.2.22:2181 â€“topic summer<br>Topic:summerPartitionCount:1ReplicationFactor:3Configs:<br>Topic: summerPartition: 0Leader: 2Replicas: 2,4,3Isr: 2,4,3</p><p>#ä¸»é¢˜åç§°ï¼šsummer<br>#Partition:åªæœ‰ä¸€ä¸ªï¼Œä»0å¼€å§‹<br>#leader ï¼šidä¸º2çš„broker<br>#Replicas å‰¯æœ¬å­˜åœ¨äºbroker idä¸º2,3,4çš„ä¸Šé¢<br>#Isr:æ´»è·ƒçŠ¶æ€çš„broker</p><p>(4)å‘é€æ¶ˆæ¯ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ç”Ÿäº§è€…è§’è‰²</p><p>[root@kafka1 ~]# /bin/bash /usr/local/kafka/bin/kafka-console-producer.sh â€“broker-list 192.168.2.22:9092 â€“topic summer<br>This is a messages<br>welcome to kafka    </p><p>(5)æ¥æ”¶æ¶ˆæ¯ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯æ¶ˆè´¹è€…è§’è‰²</p><p>[root@kafka2 ~]# /usr/local/kafka/bin/kafka-console-consumer.sh â€“zookeeper  192.168.2.24:2181 â€“topic summer â€“from-beginning<br>This is a messages<br>welcome to kafka</p><p>å¦‚æœèƒ½å¤Ÿåƒä¸Šé¢ä¸€æ ·èƒ½å¤Ÿæ¥æ”¶åˆ°ç”Ÿäº§è€…å‘è¿‡æ¥çš„æ¶ˆæ¯ï¼Œé‚£è¯´æ˜åŸºäºkafkaçš„zookeeperé›†ç¾¤å°±æˆåŠŸå•¦ã€‚ 10ï¼Œä¸‹é¢æˆ‘ä»¬å°†webserver1ä¸Šé¢çš„logstashçš„è¾“å‡ºæ”¹åˆ°kafkaä¸Šé¢ï¼Œå°†æ•°æ®å†™å…¥åˆ°kafkaä¸­ (1)ä¿®æ”¹webserver1ä¸Šé¢çš„logstashé…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼šå„ä¸ªå‚æ•°å¯ä»¥åˆ°<a href="https://www.elastic.co/">å®˜ç½‘</a>æŸ¥è¯¢.</p><p>root@webserver1 etc]# cat logstash.conf<br>input {             #è¿™é‡Œçš„è¾“å…¥è¿˜æ˜¯å®šä¹‰çš„æ˜¯ä»æ—¥å¿—æ–‡ä»¶è¾“å…¥<br>  file {<br>    type =&gt; â€œsystem-messageâ€<br>    path =&gt; â€œ/var/log/messagesâ€<br>    start_position =&gt; â€œbeginningâ€<br>  }<br>}</p><p>output {<br>    #stdout { codec =&gt; rubydebug }   #è¿™æ˜¯æ ‡å‡†è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œå¯ä»¥ç”¨äºè°ƒè¯•çœ‹æœ‰æ²¡æœ‰è¾“å‡ºï¼Œæ³¨æ„è¾“å‡ºçš„æ–¹å‘å¯ä»¥æœ‰å¤šä¸ª<br>    kafka {   #è¾“å‡ºåˆ°kafka<br>      bootstrap_servers =&gt; â€œ192.168.2.22:9092,192.168.2.23:9092,192.168.2.24:9092â€   #ä»–ä»¬å°±æ˜¯ç”Ÿäº§è€…<br>      topic_id =&gt; â€œsystem-messagesâ€  #è¿™ä¸ªå°†ä½œä¸ºä¸»é¢˜çš„åç§°ï¼Œå°†ä¼šè‡ªåŠ¨åˆ›å»º<br>      compression_type =&gt; â€œsnappyâ€   #å‹ç¼©ç±»å‹<br>    }<br>}<br>[root@webserver1 etc]#</p><p>(2)é…ç½®æ£€æµ‹</p><p>[root@webserver1 etc]# /usr/local/logstash/bin/logstash -f logstash.conf â€“configtest â€“verbose<br>Configuration OK<br>[root@webserver1 etc]# </p><p>(2)å¯åŠ¨Logstashï¼Œè¿™é‡Œæˆ‘ç›´æ¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œå³å¯</p><p>[root@webserver1 etc]# /usr/local/logstash/bin/logstash -f logstash.conf</p><p>(3)éªŒè¯æ•°æ®æ˜¯å¦å†™å…¥åˆ°kafkaï¼Œè¿™é‡Œæˆ‘ä»¬æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†ä¸€ä¸ªå«system-messagesçš„ä¸»é¢˜</p><p>[root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“list â€“zookeeper 192.168.2.22:2181<br>summer<br>system-messages   #å¯ä»¥çœ‹åˆ°è¿™ä¸ªä¸»é¢˜å·²ç»ç”Ÿæˆäº†</p><p>#å†çœ‹çœ‹è¿™ä¸ªä¸»é¢˜çš„è¯¦æƒ…:<br>[root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“describe â€“zookeeper 192.168.2.22:2181 â€“topic system-messages<br>Topic:system-messagesPartitionCount:16ReplicationFactor:1Configs:<br>Topic: system-messagesPartition: 0Leader: 2Replicas: 2Isr: 2<br>Topic: system-messagesPartition: 1Leader: 3Replicas: 3Isr: 3<br>Topic: system-messagesPartition: 2Leader: 4Replicas: 4Isr: 4<br>Topic: system-messagesPartition: 3Leader: 2Replicas: 2Isr: 2<br>Topic: system-messagesPartition: 4Leader: 3Replicas: 3Isr: 3<br>Topic: system-messagesPartition: 5Leader: 4Replicas: 4Isr: 4<br>Topic: system-messagesPartition: 6Leader: 2Replicas: 2Isr: 2<br>Topic: system-messagesPartition: 7Leader: 3Replicas: 3Isr: 3<br>Topic: system-messagesPartition: 8Leader: 4Replicas: 4Isr: 4<br>Topic: system-messagesPartition: 9Leader: 2Replicas: 2Isr: 2<br>Topic: system-messagesPartition: 10Leader: 3Replicas: 3Isr: 3<br>Topic: system-messagesPartition: 11Leader: 4Replicas: 4Isr: 4<br>Topic: system-messagesPartition: 12Leader: 2Replicas: 2Isr: 2<br>Topic: system-messagesPartition: 13Leader: 3Replicas: 3Isr: 3<br>Topic: system-messagesPartition: 14Leader: 4Replicas: 4Isr: 4<br>Topic: system-messagesPartition: 15Leader: 2Replicas: 2Isr: 2<br>[root@kafka1 ~]# </p><p>å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªä¸»é¢˜ç”Ÿæˆäº†16ä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºéƒ½æœ‰å¯¹åº”è‡ªå·±çš„Leaderï¼Œä½†æ˜¯æˆ‘æƒ³è¦æœ‰10ä¸ªåˆ†åŒºï¼Œ3ä¸ªå‰¯æœ¬å¦‚ä½•åŠï¼Ÿè¿˜æ˜¯è·Ÿæˆ‘ä»¬ä¸Šé¢ä¸€æ ·å‘½ä»¤è¡Œæ¥åˆ›å»ºä¸»é¢˜å°±è¡Œï¼Œå½“ç„¶å¯¹äºlogstashè¾“å‡ºçš„æˆ‘ä»¬ä¹Ÿå¯ä»¥æå‰å…ˆå®šä¹‰ä¸»é¢˜ï¼Œç„¶åå¯åŠ¨logstash ç›´æ¥å¾€å®šä¹‰å¥½çš„ä¸»é¢˜å†™æ•°æ®å°±è¡Œå•¦ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><p>[root@kafka1 ~]# /usr/local/kafka/bin/kafka-topics.sh â€“create â€“zookeeper 192.168.2.22:2181 â€“replication-factor 3 â€“partitions 10 â€“topic TOPIC_NAME</p><p>å¥½äº†ï¼Œæˆ‘ä»¬å°†logstashæ”¶é›†åˆ°çš„æ•°æ®å†™å…¥åˆ°äº†kafkaä¸­äº†ï¼Œåœ¨å®éªŒè¿‡ç¨‹ä¸­æˆ‘ä½¿ç”¨whileè„šæœ¬æµ‹è¯•äº†å¦‚æœä¸æ–­çš„å¾€kafkaå†™æ•°æ®çš„åŒæ—¶åœæ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œæ•°æ®å†™å…¥æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚ é‚£å¦‚ä½•å°†æ•°æ®ä»kafkaä¸­è¯»å–ç„¶åç»™æˆ‘ä»¬çš„esé›†ç¾¤å‘¢ï¼Ÿé‚£ä¸‹é¢æˆ‘ä»¬åœ¨kafkaé›†ç¾¤ä¸Šå®‰è£…Logstashï¼Œå®‰è£…æ­¥éª¤ä¸å†èµ˜è¿°ï¼›ä¸‰å°ä¸Šé¢çš„logstash çš„é…ç½®å¦‚ä¸‹ï¼Œä½œç”¨æ˜¯å°†kafkaé›†ç¾¤çš„æ•°æ®è¯»å–ç„¶åè½¬äº¤ç»™esé›†ç¾¤ï¼Œè¿™é‡Œä¸ºäº†æµ‹è¯•æˆ‘è®©ä»–æ–°å»ºä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼Œæ³¨æ„è¿™é‡Œçš„è¾“å…¥æ—¥å¿—è¿˜æ˜¯messagesï¼Œä¸»é¢˜åç§°è¿˜æ˜¯â€œsystem-messagesâ€</p><p>[root@kafka1 etc]# more logstash.conf<br>input {<br>    kafka {<br>        zk_connect =&gt; â€œ192.168.2.22:2181,192.168.2.23:2181,192.168.2.24:2181â€   #æ¶ˆè´¹è€…ä»¬<br>        topic_id =&gt; â€œsystem-messagesâ€<br>        codec =&gt; plain<br>        reset_beginning =&gt; false<br>        consumer_threads =&gt; 5<br>        decorate_events =&gt; true<br>    }<br>}</p><p>output {<br>    elasticsearch {<br>      hosts =&gt; [â€œ192.168.2.18:9200â€,â€192.168.2.19:9200â€]<br>      index =&gt; â€œtest-system-messages-%{+YYYY-MM}â€           #ä¸ºäº†åŒºåˆ†ä¹‹å‰å®éªŒï¼Œæˆ‘è¿™é‡Œæ–°ç”Ÿæˆçš„æ‰€ä»¥åå­—ä¸ºâ€œtest-system-messages-%{+YYYY-MM}â€<br>  }<br>  }</p><p>åœ¨ä¸‰å°kafkaä¸Šé¢å¯åŠ¨Logstashï¼Œæ³¨æ„æˆ‘è¿™é‡Œæ˜¯åœ¨å‘½ä»¤è¡Œå¯åŠ¨çš„ï¼›</p><p>[root@kafka1 etc]# pwd<br>/usr/local/logstash/etc<br>[root@kafka1 etc]# /usr/local/logstash/bin/logstash -f logstash.conf<br>[root@kafka2 etc]# pwd<br>/usr/local/logstash/etc<br>[root@kafka2 etc]# /usr/local/logstash/bin/logstash -f logstash.conf<br>[root@kafka3 etc]# pwd<br>/usr/local/logstash/etc<br>[root@kafka3 etc]# /usr/local/logstash/bin/logstash -f logstash.conf </p><p>åœ¨webserver1ä¸Šå†™å…¥æµ‹è¯•å†…å®¹ï¼Œå³webserver1ä¸Šé¢åˆ©ç”¨messageè¿™ä¸ªæ–‡ä»¶æ¥æµ‹è¯•ï¼Œæˆ‘å…ˆå°†å…¶æ¸…ç©ºï¼Œç„¶åå¯åŠ¨</p><p>[root@webserver1 etc]# &gt;/var/log/messages<br>[root@webserver1 etc]# echo â€œæˆ‘å°†é€šè¿‡kafkaé›†ç¾¤è¾¾åˆ°esé›†ç¾¤å“¦^0^â€ &gt;&gt; /var/log/messages<br>#å¯åŠ¨logstash,è®©å…¶è¯»å–messagesä¸­çš„å†…å®¹</p><p>ä¸‹å›¾ä¸ºæˆ‘åœ¨å®¢æˆ·ç«¯å†™å…¥åˆ°kafkaé›†ç¾¤çš„åŒæ—¶ä¹Ÿå°†å…¶è¾“å…¥åˆ°ç»ˆç«¯ï¼Œè¿™é‡Œå†™å…¥äº†ä¸‰æ¡å†…å®¹ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/6.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/6.png" alt="6"></a> è€Œä¸‹é¢ä¸‰å¼ å›¾ä¾§å¯ä»¥çœ‹å‡ºï¼Œä¸‰å°Logstash å¾ˆå¹³å‡çš„ä»kafkaé›†ç¾¤å½“ä¸­è¯»å–å‡ºæ¥äº†æ—¥å¿—å†…å®¹ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/7.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/7.png" alt="7"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/9.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/9.png" alt="9"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/8.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/8.png" alt="8"></a> å†æ¥çœ‹çœ‹æˆ‘ä»¬çš„esç®¡ç†ç•Œé¢ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/10.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/10.png" alt="10"></a> ok ,çœ‹åˆ°äº†å§ï¼Œ æµç¨‹å·®ä¸å¤šå°±æ˜¯ä¸‹é¢ é…±ç´«å’¯ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/111.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/11/111.png" alt="111"></a> ç”±äºç¯‡å¹…è¾ƒé•¿ï¼Œæˆ‘å°† 4.Kibanaéƒ¨ç½²; 5.Nginxè´Ÿè½½å‡è¡¡Kibanaè¯·æ±‚; 6.æ¡ˆä¾‹ï¼šnginxæ—¥å¿—æ”¶é›†ä»¥åŠMySQLæ…¢æ—¥å¿—æ”¶é›†; 7.KibanaæŠ¥è¡¨åŸºæœ¬ä½¿ç”¨; æ”¾åˆ°ä¸‹ä¸€ç¯‡åšå®¢ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
            <tag> kafka </tag>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¸…ç†Elasticsearchçš„ç´¢å¼•</title>
      <link href="/2015/10/23/e6-b8-85-e7-90-86elasticsearch-e7-9a-84-e7-b4-a2-e5-bc-95/"/>
      <url>/2015/10/23/e6-b8-85-e7-90-86elasticsearch-e7-9a-84-e7-b4-a2-e5-bc-95/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨ä½¿ç”¨ logstashæ¥åšæ—¥å¿—æ”¶é›† å¹¶ç”¨ elasticsearchæ¥æœç´¢ï¼Œå› ä¸ºæ—¥å¿—æ²¡æœ‰è¿›è¡Œè¿‡æ»¤ï¼Œæ²¡å‡ å¤©å°±å‘ç°elasticsearchçš„ç´¢å¼•æ–‡ä»¶å¤§çš„å“äººï¼Œä¹‹å‰è¿˜çœŸæ²¡æ¸…ç†è¿‡ã€‚å…¶å®è¦è¯´æ¸…ç† ä¹Ÿç®€å•ï¼Œç›´æ¥åˆ° elasticsearch dataæ–‡ä»¶å¤¹é‡Œåˆ æ‰å°±è¡Œäº†ï¼Œä½†æ€ä¹ˆä¹Ÿå¾—åšçš„æœ‰ç‚¹æŠ€æœ¯å«é‡ä¸æ˜¯ï¼Ÿ ä¸Šç½‘ç«™çœ‹äº†çœ‹æ–‡æ¡£ï¼Œå…¶å®ä¹ŸæŒºç®€å•ä¸€æ¡å‘½ä»¤å°±è¡Œäº†</p><p> 1,  # curl -XDELETE â€˜<a href="http://localhost:9200/logstash-">http://localhost:9200/logstash-</a>*â€™<br> 2,  æ¸…ç†æ‰äº†æ‰€æœ‰çš„ç´¢å¼•æ–‡ä»¶ï¼Œæˆ‘å‘ç°curlåˆ é™¤æ¯”rmåˆ é™¤è¦å¿«å‡ºå¾ˆå¤š</p><p>ä¸‹é¢æ˜¯ä¸»é¡µä¸Šçš„è¯¦ç»†ä»‹ç»ï¼Œå…¶ä»–éƒ¨åˆ†å¯ä»¥è‡ªå·±çœ‹ï¼Œ <a href="http://www.elasticsearch.org/guide/reference/api/delet">http://www.elasticsearch.org/guide/reference/api/delet</a></p>]]></content>
      
      
      <categories>
          
          <category> æ•…éšœå¤„ç† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> logstash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¿ç»´äºº,ä½ åº”è¯¥äº†è§£çš„ä¸‰å¼ æ­¦åŠŸå¿ƒæ³•å›¾(è½¬è½½)</title>
      <link href="/2015/10/23/e8-bf-90-e7-bb-b4-e4-ba-ba-e4-bd-a0-e5-ba-94-e8-af-a5-e4-ba-86-e8-a7-a3-e7-9a-84-e4-b8-89-e5-bc-a0-e6-ad-a6-e5-8a-9f-e5-bf-83-e6-b3-95-e5-9b-be-e8-bd-ac-e8-bd-bd/"/>
      <url>/2015/10/23/e8-bf-90-e7-bb-b4-e4-ba-ba-e4-bd-a0-e5-ba-94-e8-af-a5-e4-ba-86-e8-a7-a3-e7-9a-84-e4-b8-89-e5-bc-a0-e6-ad-a6-e5-8a-9f-e5-bf-83-e6-b3-95-e5-9b-be-e8-bd-ac-e8-bd-bd/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>ä¸€ã€è¿ç»´æŠ€èƒ½å›¾</strong></p></blockquote><p>åšä¸ºä¸€ä¸ªè¿ç»´å·¥ç¨‹å¸ˆï¼Œä½ çŸ¥é“ä½ åº”è¯¥å­¦ä¹ ä»€ä¹ˆï¼Ÿæ€ä¹ˆå­¦ä¹ å—ï¼Ÿæœå“ªä¸ªæ–¹å‘å‘å±•å—ï¼Ÿä¸‹é¢ä¸€å¼ è¿ç»´å·¥ç¨‹å¸ˆæŠ€èƒ½å›¾ï¼Œè®©ä½ äº†è§£ï¼ å›¾ç‰‡é“¾æ¥ï¼Œ<a href="http://blog.sctux.com/images/1111.png">ç‚¹æˆ‘^_^</a></p><blockquote><p><strong>äºŒã€è‡ªåŠ¨åŒ–è¿ç»´è·¯çº¿å›¾</strong></p></blockquote><p>è¿ç»´è‡ªåŠ¨åŒ–åœ¨å›½å†…å·²ç»å£°åè¿œèºäº†ï¼Œéšç€äº’è”ç½‘å¿«é€Ÿçš„å‘å±•ï¼Œè¿ç»´ä¸å•å•æ˜¯å‡ ä¸ªè„šæœ¬ï¼Œå‡ ä¸ªæ–‡æ¡£å¯ä»¥èƒœä»»çš„ï¼DevOpsåœ¨å›½å†…å¾ˆå—çƒ­æ§ï¼Œä½†æ˜¯çœŸæ­£çš„è‡ªåŠ¨åŒ–ä¹‹è·¯ï¼Œä½ èµ°åˆ°äº†å“ªï¼Ÿä½ çŸ¥é“è¯¥æ€ä¹ˆèµ°å—ï¼Ÿä¸‹é¢çš„æ­¦åŠŸå¿ƒæ³•å›¾å‘Šè¯‰ä½ è¯¥æ€ä¹ˆèµ°ï¼ å›¾ç‰‡é“¾æ¥ï¼Œ<a href="http://blog.sctux.com/images/2222.png">ç‚¹æˆ‘^_^</a></p><blockquote><p><strong>ä¸‰ã€äº‘è®¡ç®—çŸ¥è¯†å¤§å®å…¸</strong></p></blockquote><p>ä»2013å¹´å¼€å§‹ï¼Œæˆ‘å›½äº‘è®¡ç®—æŒç»­å¿«é€Ÿå‘å±•ï¼Œäº§ä¸šè§„æ¨¡ä¸æ–­æ‰©å¤§ï¼Œäº§ä¸šé“¾æ—¥è¶‹å®Œå–„ï¼Œäº§ä¸šç¯å¢ƒä¸æ–­ä¼˜åŒ–ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸å°‘åˆ›ä¸šè€…çœ‹åˆ°äº†å¸‚åœºï¼Œä¸å°‘äº‘è®¡ç®—å…¬å¸å´›èµ·ã€‚ä½†æ˜¯äººæ‰åœ¨å“ªé‡Œï¼Œå“ªäº›æ˜¯çœŸæ­£çš„äº‘è®¡ç®—äººæ‰ï¼Ÿäº‘è®¡ç®—äººæ‰ä»–åº”è¯¥ä¼šä»€ä¹ˆï¼Œä¸‹é¢Cloud computing imageå‘Šè¯‰ä½  å›¾ç‰‡é“¾æ¥ï¼Œ<a href="http://blog.sctux.com/images/3333.png">ç‚¹æˆ‘^_^</a> <strong>ç”±äºåŸä½œè€…åˆ¶ä½œçš„å›¾ç‰‡è¾ƒå¤§ï¼Œè¿™é‡Œä¸èƒ½æ­£å¸¸çš„æ˜¾ç¤ºï¼Œç‚¹å‡»é“¾æ¥ç„¶åæ‰©å¤§å¯æ¸…æ™°çœ‹åˆ°ï¼</strong></p><p>å¤©ä¸‹æ­¦åŠŸå”¯å¿«ä¸æ”»ï¼Œè¿™å¥è¯è¿ç”¨åˆ°äº’è”ç½‘ï¼Œå°±æ˜¯ä½ æœ€å¿«ã€æœ€å¥½ã€æœ€æ—©çš„æŒæ¡äº†äº’è”ç½‘çš„æœ€æ–°æŠ€æœ¯ï¼Œä½ å°±æ˜¯æ¯”è¾ƒåƒé¦™çš„äººæ‰ï¼å°±åƒæœ€æ–°æ¯”è¾ƒäººä»¬çš„å®¹å™¨DockeræŠ€æœ¯ä¸€æ ·ï¼Œå¦‚æœä½ æ˜¯å…ˆè¡Œè€…ï¼Œä½ ç°åœ¨è‡³å°‘æ˜¯ä¸€å®¶Dockerç”Ÿæ€æŠ€æœ¯åˆ›ä¸šæœåŠ¡çš„åˆä¼™äººï¼é©å‘½è¿˜æœªèƒœåˆ©ï¼ŒåŒå¿—è¿˜éœ€åŠªåŠ›ï¼Œå„ä½è‹¦é€¼çš„äº’è”ç½‘å·¥ä½œè€…ï¼ŒåŠ æ²¹ï¼</p>]]></content>
      
      
      <categories>
          
          <category> å¿ƒæƒ…éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Zabbix ç›‘æ§MysqlçŠ¶æ€ä»¥åŠmysqlä¸»ä»</title>
      <link href="/2015/10/23/zabbix-e7-9b-91-e6-8e-a7mysql-e7-8a-b6-e6-80-81-e4-bb-a5-e5-8f-8amysql-e4-b8-bb-e4-bb-8e/"/>
      <url>/2015/10/23/zabbix-e7-9b-91-e6-8e-a7mysql-e7-8a-b6-e6-80-81-e4-bb-a5-e5-8f-8amysql-e4-b8-bb-e4-bb-8e/</url>
      
        <content type="html"><![CDATA[<p>ä¸€ï¼Œåˆ©ç”¨zabbixè‡ªå¸¦æ¨¡æ¿ç›‘æ§mysqlçŠ¶æ€ï¼š 1ï¼Œåœ¨ä»çš„mysqlæœåŠ¡å™¨ä¸Šé¢åˆ›å»ºä¸€ä¸ªç”¨äºzabbixç›‘æ§çš„ç”¨æˆ· grant replication client on <em>.</em> to zabbix@â€™localhostâ€™ &nbsp;IDENTIFIED BY â€˜PASSWORDâ€™; 2ï¼Œæ ¹æ®zabbixç›‘æ§mysqlçš„keyæ”¹å†™è„šæœ¬</p><p>#/bin/bash<br>DEF=â€â€“defaults-file=/etc/zabbix/my.confâ€<br>MYSQL=â€™/usr/local/webservers/mysql-5.6.19/bin/mysqladminâ€™<br>ARGS=1<br>if [ $# -ne â€œ$ARGSâ€ ];then<br>    echo â€œPlease input one arguement:â€<br>fi<br>case $1 in<br>    Uptime)<br>        result=<code>${MYSQL} $DEF status|cut -f2 -d":"|cut -f1 -d"T"</code><br>            echo $result<br>            ;;<br>        Com_update)<br>            result=<code>${MYSQL} $DEF extended-status |grep -w "Com_update"|cut -d"|" -f3</code><br>            echo $result<br>            ;;<br>        Slow_queries)<br>        result=<code>${MYSQL} $DEF status |cut -f5 -d":"|cut -f1 -d"O"</code><br>                echo $result<br>                ;;<br>    Com_select)<br>        result=<code>${MYSQL} $DEF extended-status |grep -w "Com_select"|cut -d"|" -f3</code><br>                echo $result<br>                ;;<br>    Com_rollback)<br>        result=<code>${MYSQL} $DEF extended-status |grep -w "Com_rollback"|cut -d"|" -f3</code><br>                echo $result<br>                ;;<br>    Questions)<br>        result=<code>${MYSQL} $DEF status|cut -f4 -d":"|cut -f1 -d"S"</code><br>                echo $result<br>                ;;<br>    Com_insert)<br>        result=<code>${MYSQL} $DEF extended-status |grep -w "Com_insert"|cut -d"|" -f3</code><br>                echo $result<br>                ;;<br>    Com_delete)<br>        result=<code>${MYSQL} $DEF extended-status |grep -w "Com_delete"|cut -d"|" -f3</code><br>                echo $result<br>                ;;<br>    Com_commit)<br>        result=<code>${MYSQL} $DEF extended-status |grep -w "Com_commit"|cut -d"|" -f3</code><br>                echo $result<br>                ;;<br>    Bytes_sent)<br>        result=<code>${MYSQL} $DEF extended-status |grep -w "Bytes_sent" |cut -d"|" -f3</code><br>                echo $result<br>                ;;<br>    Bytes_received)<br>        result=<code>${MYSQL} $DEF extended-status |grep -w "Bytes_received" |cut -d"|" -f3</code><br>                echo $result<br>                ;;<br>    Com_begin)<br>        result=<code>${MYSQL} $DEF extended-status |grep -w "Com_begin"|cut -d"|" -f3</code><br>                echo $result<br>                ;; </p><pre><code>    *)     echo "Usage:$0(Uptime|Com\_update|Slow\_queries|Com\_select|Com\_rollback|Questions)"     ;; </code></pre><p>esac</p><p>ä¸Šé¢çš„è„šæœ¬ä¸­ï¼š /etc/zabbix/my.conf è¿™ä¸ªæ–‡ä»¶å®šä¹‰çš„æ˜¯zabbixè¿™ä¸ªmysqlç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åç›´æ¥æŒ‡å®šè¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å‘½ä»¤è¡Œç›´æ¥è¾“å…¥zabbixçš„ç”¨æˆ·å¯†ç çš„è¯ä¼šä¸€è¡Œæç¤ºï¼Œå½±å“æˆ‘ä»¬zabbixå–å€¼ï¼Œä¾‹å¦‚ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-131307.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-131307.png" alt="Screenshot from 2015-10-23 13:13:07"></a> å¦‚æœæˆ‘ä»¬ç›´æ¥æŒ‡å®šäº†è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆé‚£è¡Œæç¤ºå°±ä¸ä¼šå‡ºç° <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-131457.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-131457.png" alt="Screenshot from 2015-10-23 13:14:57"></a> /etc/zabbix/my.confçš„å†…å®¹ï¼š</p><p>[client]<br>host=localhost<br>user=zabbix<br>password=â€™PASSWORDâ€™<br>socket = /data/mysql/mysql.sock</p><p>3ï¼Œè®¾ç½®zabbix_agentç«¯ é¦–å…ˆå¯ç”¨è‡ªå®šä¹‰çš„key å»æ‰zabbix_agenté…ç½®æ–‡ä»¶çš„259è¡Œ: Include=/usr/local/etc/zabbix_agentd.conf.d/*.conf ç„¶åè‡ªå®šä¹‰ä¸€ä¸ªmysql-status.conf åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œå†…å®¹ä¸ºï¼š</p><p>UserParameter=mysql.version,/usr/local/webservers/mysql-5.6.19/bin/mysql -V<br>UserParameter=mysql.ping,/usr/local/webservers/mysql-5.6.19/bin/mysqladmin â€“defaults-file=/etc/zabbix/my.conf ping | grep -c alive<br>UserParameter=mysql.status[*],/home/shell/mysql-status.sh $1<br>#æ³¨æ„ï¼šè¿™é‡Œè‡ªå®šä¹‰çš„key å»ºè®®ä½¿ç”¨å‘½ä»¤çš„ç»å¯¹è·¯å¾„</p><p>ok ä¸Šé¢çš„å†…å®¹å®šä¹‰å¥½ä¹‹åé‡å¯zabbix_agentæœåŠ¡ï¼Œç„¶åå°±å¯ä»¥åœ¨zabbix_serverç«¯çœ‹ä¸€ä¸‹èƒ½ä¸èƒ½è·å–åˆ°keyå€¼ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-132702.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-132702.png" alt="Screenshot from 2015-10-23 13:27:02"></a> å¥½å•¦ï¼Œä»¥ä¸Šå†…å®¹ä¸­å¯ä»¥çœ‹åˆ°å–å€¼æ­£å¸¸ï¼Œæˆ‘ä»¬åœ¨zabbix dashboardä¸­æŸ¥çœ‹ä¸€ä¸‹å§ï¼› <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-132949.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-132949.png" alt="Screenshot from 2015-10-23 13:29:49"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-133031.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-133031.png" alt="Screenshot from 2015-10-23 13:30:31"></a> è‡³æ­¤å·²ç»ç›‘æ§åˆ°mysqlçš„çŠ¶æ€å•¦ï¼›è¿™é‡Œä¸€å®šè¦æ³¨æ„mysqlç”¨æˆ·å–è·å–mysqlæœåŠ¡çš„çŠ¶æ€æ—¶å€™çš„æƒé™ï¼› äºŒã€zabbixç›‘æ§mysqlä¸»ä»çŠ¶æ€ è·Ÿä¸Šé¢çš„æ­¥éª¤å·®ä¸å¤šï¼Œè¿™é‡Œä½¿ç”¨çš„mysqlç”¨æˆ·æˆ‘è¿˜æ˜¯ä½¿ç”¨çš„zabbixç”¨æˆ· é‚£è¿™é‡Œç›´æ¥å°±è‡ªå®šä¹‰key å•¦ï¼Œå¤§å®¶éƒ½çŸ¥é“mysqlä¸»ä»çŠ¶æ€æˆ‘ä»¬ä¸€èˆ¬é€šè¿‡åœ¨mysql slavesä¸Šé¢çš„show slave status ç„¶åçœ‹</p><p>Slave_IO_Running: Yes<br>Slave_SQL_Running: Yes</p><p>è¿™ä¸¤ä¸ªå€¼ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªä¸ä¸ºYesé‚£è¯´æ˜ä¸»ä»åŒæ­¥æ˜¯æœ‰é—®é¢˜çš„ï¼Œé‚£æˆ‘ä»¬ç”¨zabbixè¿™ä¸ªçš„èº«ä»½æ¥è·å–è¿™ä¸ªå€¼ ç¼–å†™è„šæœ¬ï¼šmysql_replication.sh</p><p>#!/bin/bash<br>/usr/local/webservers/mysql-5.6.19/bin/mysql â€“defaults-file=/etc/zabbix/my.conf -e â€˜show slave status\Gâ€™ | grep -E â€œSlave_IO_Running:|Slave_SQL_Running:â€  | awk â€˜{print $2}â€™ | grep -c Yes</p><p>è¿™ä¸ªè„šæœ¬çš„ç”¨é€”æ˜¯ï¼Œç”¨zabbixç”¨æˆ·èº«ä»½æ‰§è¡Œâ€show slave status\Gâ€è¿™ä¸ªå‘½ä»¤ï¼Œç„¶åæˆªå–Yesè¿™ä¸ªå…³é”®å­—çš„è¡Œæ•°æ˜¯2 æˆ–è€…é 2 <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-134737.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-134737.png" alt="Screenshot from 2015-10-23 13:47:37"></a> åœ¨zabbix_server ç«¯/usr/local/etc/zabbix_agentd.conf.d/ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ï¼šmysql-replication.confï¼Œå†…å®¹ä¸ºï¼š</p><p>UserParameter=mysql.replication,/home/shell/mysql-replication.sh</p><p>å†™å¥½ä¹‹åï¼Œé‡å¯zabbix_agent ç„¶ååœ¨zabbix_serverç«¯æµ‹è¯•ä¸€ä¸‹çœ‹èƒ½å¦è·å–åˆ°è¿™ä¸ªå€¼ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-140321.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-140321.png" alt="Screenshot from 2015-10-23 14:03:21"></a> zabbix_serverç«¯èƒ½è·å–ï¼Œç°åœ¨åœ¨zabbix dashboardæ·»åŠ è¿™ä¸ªitemå§ Configurationâ€“&gt;Hostâ€“&gt;database-node2â€“&gt;Itemsâ€“&gt;Create item <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-140754.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-140754.png" alt="Screenshot from 2015-10-23 14:07:54"></a> è¿™é‡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„key éœ€è¦æ‰‹åŠ¨è¾“å…¥keyåç§°ã€‚æˆ‘è¿™é‡Œå®šä¹‰è¿‡äº†ï¼Œç›´æ¥ç‚¹å‡»â€œAddâ€å°±è¡Œäº† ç„¶åæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªTriggers Triggersâ€“&gt;Create triggers <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-141313.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-141313.png" alt="Screenshot from 2015-10-23 14:13:13"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-141153.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-141153.png" alt="Screenshot from 2015-10-23 14:11:53"></a> æ£€æµ‹å®ƒæœ€åä¸€æ¬¡çš„å–å€¼æ˜¯ä¸æ˜¯å°äº2ï¼Œå®šä¹‰Nçš„å€¼ä¸º2ï¼Œå¦‚æœå–å¾—çš„å€¼å°äº2å°±è¯´æ˜æœ‰é—®é¢˜å•¦ï¼Œ å®šä¹‰ä¸€ä¸‹æŠ¥è­¦ï¼š Configurationâ€“&gt;Actionâ€“&gt;Create action <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-141621.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-141621.png" alt="Screenshot from 2015-10-23 14:16:21"></a></p><p>é‚®ä»¶é€šçŸ¥å†…å®¹ï¼š<br>MySQL.Repliaction<br>ERRORâ€”MySQL master-slave â€“&gt;{ITEM.VALUE1}<br>MySQL ä¸»ä»å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æµ‹ä¸»ä»çŠ¶æ€ï¼ï¼ï¼<br>å‘Šè­¦ä¸»æœº : {HOSTNAME1}<br>å‘Šè­¦æ—¶é—´ : {EVENT.DATE} {EVENT.TIME}<br>å‘Šè­¦ç­‰çº§ : {TRIGGER.SEVERITY}<br>å‘Šè­¦ä¿¡æ¯ : {TRIGGER.NAME}<br>å‘Šè­¦é¡¹ç›® : {TRIGGER.KEY1}<br>é—®é¢˜è¯¦æƒ… : {ITEM.NAME}:{ITEM.VALUE}<br>å½“å‰çŠ¶æ€ : {TRIGGER.STATUS}:{ITEM.VALUE1}<br>äº‹ä»¶ID : {EVENT.ID}</p><p>æ¢å¤åçš„å›å¤:<br>OKâ€”MySQL master-slave â€“&gt;{ITEM.VALUE1}<br>MySQL ä¸»ä»é—®é¢˜æ¢å¤ï¼Œè¯·ç¡®è®¤ä¸»ä»çŠ¶æ€ï¼ï¼ï¼<br>å‘Šè­¦ä¸»æœº : {HOSTNAME1}<br>å‘Šè­¦æ—¶é—´ : {EVENT.DATE} {EVENT.TIME}<br>å‘Šè­¦ç­‰çº§ : {TRIGGER.SEVERITY}<br>å‘Šè­¦ä¿¡æ¯ : {TRIGGER.NAME}<br>å‘Šè­¦é¡¹ç›® : {TRIGGER.KEY1}<br>é—®é¢˜è¯¦æƒ… : {ITEM.NAME}:{ITEM.VALUE}<br>å½“å‰çŠ¶æ€ : {TRIGGER.STATUS}:{ITEM.VALUE1}<br>äº‹ä»¶ID   : {EVENT.ID}</p><p>æ¡ä»¶ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-141903.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-141903.png" alt="Screenshot from 2015-10-23 14:19:03"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-141935.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-141935.png" alt="Screenshot from 2015-10-23 14:19:35"></a> zabbixè‡ªå®šä¹‰è„šæœ¬å‘é€é‚®ä»¶ï¼› é¦–å…ˆæˆ‘ä»¬è¦åœ¨zabbix_serverç«¯å¯ç”¨è‡ªå®šä¹‰è„šæœ¬å‘é€é‚®ä»¶ï¼Œåœ¨zabbix_serverä¸»é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ä¸º AlertScriptsPath=/usr/lib/zabbix/alertscripts &nbsp;è„šæœ¬å­˜æ”¾çš„ç›®å½• ç„¶åæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªè„šæœ¬mail.py</p><p>#!/usr/bin/python<br>#coding:utf-8 </p><p>import smtplib<br>from email.mime.text import MIMEText<br>import sys </p><p>#é‚®ç®±æœåŠ¡å™¨åœ°å€<br>mail_host = â€˜smtp.qq.comâ€™<br>#é‚®ç®±ç”¨æˆ·å<br>mail_user = â€˜xxxxxxxâ€™<br>#é‚®ç®±å¯†ç <br>mail_pass = â€˜xxxxxxxxâ€™<br>mail_postfix = â€˜qq.comâ€™</p><p>def send_mail(to_list,subject,content):<br>    me = mail_user+â€&lt;â€+mail_user+â€@â€+mail_postfix+â€&gt;â€<br>    msg = MIMEText(content,_charset=â€™utf-8â€™)<br>    msg[â€˜Subjectâ€™] = subject<br>    msg[â€˜Fromâ€™] = me<br>    msg[â€˜toâ€™] = to_list </p><pre><code>try:    s = smtplib.SMTP()    s.connect(mail_host)    s.login(mail\_user,mail\_pass)    s.sendmail(me,to\_list,msg.as\_string())    s.close()    return Trueexcept Exception,e:    print str(e)    return False</code></pre><p>if __name__ == â€œ__main__â€œ:<br>    send_mail(sys.argv[1], sys.argv[2], sys.argv[3])</p><p>è®°å¾—åŠ ä¸Šæ‰§è¡Œæƒé™ï¼› ç„¶ååœ¨zabbix dashboardä¸Šé¢å®šä¹‰ç”¨æˆ·çš„mediaåŠ ä¸Šç”¨æˆ·çš„é‚®ç®±å³å¯ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-142528.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-142528.png" alt="Screenshot from 2015-10-23 14:25:28"></a> ä»¥ä¸Šå°±å¯ä»¥å®ç°æŠ¥è­¦å•¦ æµ‹è¯•ä¸€ä¸‹ï¼Œå°†mysql-replication.shè¿™ä¸ªè„šæœ¬çš„å€¼è‡ªå®šä¹‰ä¸€ä¸ªè¾“å‡ºå€¼ä¸º0æˆ–è€…1 <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-142832.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-142832.png" alt="Screenshot from 2015-10-23 14:28:32"></a> æŸ¥çœ‹é‚®ä»¶ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/zabbix_1.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/zabbix_1.png" alt="zabbix_1"></a> å¦‚æœæ¢å¤åçš„å›å¤ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/zabbix_2.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/zabbix_2.png" alt="zabbix_2"></a> ok å·²ç»æˆåŠŸèƒ½çœ‹åˆ°è¿™ä¸ªç›‘æ§æ²¡é—®é¢˜å•¦ã€‚ ä¸‹é¢æ¥çœ‹ä¸€ä¸‹zabbix + grafana ,è¿™ä¸ªæ˜¯ä½œä¸ºé¡µé¢å±•ç¤ºæ¯”è¾ƒåä¸½çš„æ•ˆæœ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-144225.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-144225.png" alt="Screenshot from 2015-10-23 14:42:25"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-144008.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/Screenshot-from-2015-10-23-144008.png" alt="Screenshot from 2015-10-23 14:40:08"></a> åªè¦æ˜¯åœ¨zabbix ä¸­æœ‰çš„ itemséƒ½å¯ä»¥åœ¨grafanaä¸­å±•ç¤ºã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> grafana </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ£€æŸ¥æ–‡ä»¶æ—¶é—´æˆ³ï¼Œå¯¹æ¯”æ—¶é—´çš„Shellè„šæœ¬</title>
      <link href="/2015/10/16/e6-a3-80-e6-9f-a5-e6-96-87-e4-bb-b6-e6-97-b6-e9-97-b4-e6-88-b3-ef-bc-8c-e5-af-b9-e6-af-94-e6-97-b6-e9-97-b4-e7-9a-84shell-e8-84-9a-e6-9c-ac/"/>
      <url>/2015/10/16/e6-a3-80-e6-9f-a5-e6-96-87-e4-bb-b6-e6-97-b6-e9-97-b4-e6-88-b3-ef-bc-8c-e5-af-b9-e6-af-94-e6-97-b6-e9-97-b4-e7-9a-84shell-e8-84-9a-e6-9c-ac/</url>
      
        <content type="html"><![CDATA[<p>åº”å¼€å‘éœ€æ±‚ï¼Œæœ‰äº›é”æ–‡ä»¶ç”Ÿæˆä¹‹åä¸ä¼šåœ¨å›ºå®šæ—¶é—´å†…åˆ é™¤ï¼Œé€ æˆç¨‹åºçš„è®¡åˆ’ä»»åŠ¡ä¼šå¡æ­»ï¼Œäºæ˜¯éœ€è¦ä¸€ä¸ªæ£€æŸ¥å¯¹æ¯”locksæ–‡ä»¶çš„è„šæœ¬æ¥å®æ—¶æ£€æµ‹è¿™ä¸ªç›®å½•ä¸‹çš„*.locksæ–‡ä»¶</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="comment">#è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">curren_time=\`<span class="built_in">date</span> +%H:%M:%S\`  </span><br><span class="line"></span><br><span class="line"><span class="comment">#--time-stype=FORMAT</span></span><br><span class="line"><span class="built_in">ls</span> -l --time-style=+%H:%M:%S /xxxxxx/*.locks &gt;/tmp/locks 2&gt;/dev/null</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> -r line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="comment">#æ–‡ä»¶å†…å®¹</span></span><br><span class="line">file_time=\`<span class="built_in">echo</span> <span class="variable">$line</span> | awk -F <span class="string">' '</span> <span class="string">'{print $6}'</span>\`  </span><br><span class="line"><span class="comment">#æ–‡ä»¶ç»å¯¹è·¯å¾„åŠåç§°</span></span><br><span class="line">File=\`<span class="built_in">echo</span> <span class="variable">$line</span> | awk -F <span class="string">' '</span> <span class="string">'{print $7}'</span>\`</span><br><span class="line"></span><br><span class="line"><span class="comment">#è½¬æ¢æˆUnixæ—¶é—´æˆ³</span></span><br><span class="line">date1=\`<span class="built_in">date</span> -d <span class="string">"<span class="variable">$curren_time</span>"</span> +%s\`</span><br><span class="line">date2=\`<span class="built_in">date</span> -d <span class="string">"<span class="variable">$file_time</span>"</span> +%s\`</span><br><span class="line"></span><br><span class="line"><span class="comment">#å½“å‰æ—¶é—´å‡å»æ–‡ä»¶ç”Ÿäº§æ—¶é—´çš„å·®å€¼è¿›è¡Œæ¯”è¾ƒ(shell çš„è¿ç®—ç”¨exprå…³é”®å­—)</span></span><br><span class="line">DD=$(<span class="built_in">expr</span> <span class="variable">$date1</span> - <span class="variable">$date2</span>)</span><br><span class="line"><span class="keyword">if</span> \[ <span class="variable">$DD</span> -gt 120 \];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$curren_time</span> --- Greater than 2 minutes, <span class="variable">$File</span> will be delete."</span></span><br><span class="line">    <span class="built_in">sleep</span> 2</span><br><span class="line">    <span class="built_in">rm</span> -rf <span class="variable">$File</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span> &lt; /tmp/locks</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x /home/shell/check\_locks\_file.sh</span><br><span class="line"><span class="built_in">nohup</span> /bin/bash /home/shell/check\_locks\_file.sh &gt;/var/log/check_locks.log &amp;</span><br></pre></td></tr></tbody></table></figure><p>ä¸¤ä¸ªå…³é”®ç‚¹<br>1ã€lså‘½ä»¤çš„ç”¨æ³• ï¼š â€“time-type=FORMAT å‚æ•°<br>2ã€å°†å¸¸è§„çš„æ—¶é—´è½¬æ¢æˆUnixæ—¶é—´æˆ³</p>]]></content>
      
      
      <categories>
          
          <category> Shell </category>
          
          <category> è„šæœ¬ç¼–ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> expr </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºCentOS6.5 X86_64 æºç æ­å»ºGitLab</title>
      <link href="/2015/09/30/e5-9f-ba-e4-ba-8ecentos6-5-x86-64-e6-ba-90-e7-a0-81-e6-90-ad-e5-bb-bagitlab/"/>
      <url>/2015/09/30/e5-9f-ba-e4-ba-8ecentos6-5-x86-64-e6-ba-90-e7-a0-81-e6-90-ad-e5-bb-bagitlab/</url>
      
        <content type="html"><![CDATA[<p>ç³»ç»Ÿï¼šCentOS6.5 X86_64 å·²å®Œæˆåˆå§‹åŒ–ï¼šé˜²ç«å¢™ã€SELinux å…³é—­ã€ä¸å¿…è¦æœåŠ¡åœæ­¢ï¼Œä¸å¿…è¦ç”¨æˆ·åˆ é™¤â€¦â€¦â€¦ 1.æ·»åŠ epelæº</p><p>wget -O /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 <a href="https://www.fedoraproject.org/static/0608B895.txt">https://www.fedoraproject.org/static/0608B895.txt</a> &amp;&amp; rpm â€“import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</p><p>#æŸ¥çœ‹Keyæ˜¯å¦å®‰è£…æˆåŠŸ<br>rpm -qa gpg*</p><p>&nbsp; 2.å®‰è£…epelæº</p><p>rpm -Uvh <a href="http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm">http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</a></p><p>&nbsp; 3.æ·»åŠ PUIASæº</p><p>wget -O /etc/yum.repos.d/PUIAS_6_computational.repo <a href="https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/install/centos/PUIAS/_6/_computational.repo">https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/install/centos/PUIAS\_6\_computational.repo</a></p><p>&nbsp; 4.ä¸‹è½½å¹¶å®‰è£…gpg-key</p><p>wget -O /etc/pki/rpm-gpg/RPM-GPG-KEY-puias <a href="http://springdale.math.ias.edu/data/puias/6/x86_64/os/RPM-GPG-KEY-puias">http://springdale.math.ias.edu/data/puias/6/x86_64/os/RPM-GPG-KEY-puias</a> &amp;&amp; rpm â€“import /etc/pki/rpm-gpg/RPM-GPG-KEY-puias</p><p>#æŸ¥çœ‹æºæ˜¯å¦æ·»åŠ æˆåŠŸ[å¦‚æœä¸æˆåŠŸï¼Œæ‰§è¡Œï¼šyum-config-manager â€“enable epel â€“enable PUIAS_6_computational]<br>yum repolist</p><p>&nbsp; 5.å®‰è£…æ•´ä¸ªæ­å»ºgitlabçš„ç›¸å…³çš„ä¾èµ–åŒ…</p><p>yum -y groupinstall â€˜Development Toolsâ€™<br>yum -y install readline readline-devel ncurses-devel gdbm-devel glibc-devel tcl-devel openssl-devel curl-devel expat-devel db4-devel byacc sqlite-devel libyaml libyaml-devel libffi libffi-devel libxml2 libxml2-devel libxslt libxslt-devel libicu libicu-devel system-config-firewall-tui redis sudo wget crontabs logwatch logrotate perl-Time-HiRes git cmake libcom_err-devel.i686 libcom_err-devel.x86_64 nodejs</p><p>&nbsp; 6.é…ç½®é»˜è®¤ç¼–è¾‘å™¨</p><p>yum -y install vim-enhanced<br>update-alternatives â€“set editor /usr/bin/vim.basic<br>ln -s /usr/bin/vim /usr/bin/edito</p><p>#reStructuredText markupè¯­æ³•æ”¯æŒï¼Œéœ€è¦å®‰è£…ä¾èµ–åŒ…ï¼š<br>yum install -y python-docutils</p><p>&nbsp; 7.å®‰è£…git(git&gt;=1.7.10 å¦‚æœä½äºæˆ‘ä»¬å¯ä»¥ä»æ–°ç¼–è¯‘å®‰è£…)</p><p>yum install zlib-devel perl-CPAN gettext curl-devel expat-devel gettext-devel openssl-devel<br>mkdir /tmp/git &amp;&amp; cd /tmp/git<br>curl â€“progress <a href="https://www.kernel.org/pub/software/scm/git/git-2.1.3.tar.gz">https://www.kernel.org/pub/software/scm/git/git-2.1.3.tar.gz</a> | tar xz<br>cd git-2.1.3/ &amp;&amp; ./configure â€“prefix=/usr/local/git &amp;&amp; make &amp;&amp; make install</p><p>&nbsp; 8.å®‰è£…ruby(å¦‚æœç³»ç»Ÿä¸­Rubyçš„ç‰ˆæœ¬æ˜¯2.0ä»¥å‰çš„é‚£ä¹ˆè¯·ç§»é™¤ï¼ŒGitLabåªæ”¯æŒRuby 2.0+ç‰ˆæœ¬)</p><p>yum remove ruby</p><p>mkdir /tmp/ruby &amp;&amp; cd /tmp/ruby<br>curl â€“progress <a href="ftp://ftp.ruby-lang.org/pub/ruby/2.1/ruby-2.1.2.tar.gz">ftp://ftp.ruby-lang.org/pub/ruby/2.1/ruby-2.1.2.tar.gz</a> | tar xz<br>cd ruby-2.1.2<br>./configure â€“prefix=/usr/local/ â€“disable-install-rdoc<br>make<br>make install<br>#è®°å¾—æ£€æŸ¥rubyçš„ç‰ˆæœ¬æ˜¯å¦æ˜¯æœ€æ–°<br>ruby â€“version</p><p>&nbsp; 9.å®‰è£…Bundler Gem(ç”±äº`<a href="http://rubygems.org/%60%E5%B7%B2%E8%A2%AB%E5%A2%99%EF%BC%8C%E8%BF%99%E9%87%8C%E6%9B%BF%E6%8D%A2%E6%BA%90%E4%B8%BA/%60https://ruby.taobao.org/%60">http://rubygems.org\`å·²è¢«å¢™ï¼Œè¿™é‡Œæ›¿æ¢æºä¸º\`https://ruby.taobao.org\`</a>)</p><p># æ·»åŠ æ·˜å®æºå¹¶ä¸”ç§»é™¤å®˜æ–¹æº<br>gem sources -a <a href="https://ruby.taobao.org/">https://ruby.taobao.org</a><br>gem sources -r <a href="https://rubygems.org/">https://rubygems.org/</a></p><p>&nbsp; 10.å®‰è£…Bundler</p><p>gem install bundler -vâ€™1.5.2â€™ â€“no-doc</p><p>&nbsp; 11.System Usersä¸ºGitLabåˆ›å»ºç”¨æˆ·</p><p>adduser â€“system â€“shell /bin/bash â€“comment â€˜GitLabâ€™ â€“create-home â€“home-dir /home/git/ git</p><p>&nbsp; 12.ç¼–è¾‘sudoersæ–‡ä»¶ï¼Œå°†rubyå’Œgitçš„ç¨‹åºè·¯å¾„æ·»åŠ åˆ°PATHä¸­ï¼Œä½¿gitç”¨æˆ·ä½œä¸ºrootæ¥ä½¿ç”¨gemå‘½ä»¤</p><p>sed -ie â€˜s@Defaults\    secure_path\ \=\ \/sbin\:\/bin\:\/usr\/sbin\:\/usr\/bin@Defaults\    secure_path\ \=\ \/sbin\:\/bin\:\/usr\/sbin\:\/usr\/bin\:/usr\/local\/bin@gâ€™ /etc/sudoers</p><p>&nbsp; 13.å®‰è£…mysql</p><p>yum install -y mysql mysql-devel mysql-server<br>service mysqld start</p><p>#ä¸ºgitlabåˆ›å»ºæ•°æ®åº“<br>#åˆ›å»ºç”¨æˆ·<br>mysql -e â€œCREATE USER â€˜gitâ€˜@â€™localhostâ€™ IDENTIFIED BY â€˜xxxxxâ€™;â€</p><p>#åˆ›å»ºæ•°æ®åº“<br>mysql -e â€œCREATE DATABASE IF NOT EXISTS \`gitlabhq_production\` DEFAULT CHARACTER SET \`utf8\` COLLATE \`utf8_unicode_ci\`;â€</p><p>#æˆæƒ<br>mysql -e â€œGRANT SELECT, LOCK TABLES, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON \`gitlabhq_production\`.* TO â€˜gitâ€˜@â€™localhostâ€™;â€</p><p>#ç”¨gitç”¨æˆ·å°è¯•ç™»é™†éªŒè¯æ˜¯å¦æˆåŠŸ<br>sudo -u git -H mysql -u git -pxxxxxx  -e â€˜show databases;â€™</p><p>#è®°å¾—è¦ç»™rootç”¨æˆ·å¯†ç å“¦ã€‚</p><p>&nbsp; 14.å®‰è£…redis(å·²ç»åœ¨å‰é¢çš„ä¾èµ–åŒ…å®‰è£…æ—¶å®‰è£…äº†)</p><p>chkconfig redis on</p><p>#é…ç½®Redisä½¿ç”¨sockets<br>cp /etc/redis.conf /etc/redis.conf.orig</p><p># å…³é—­Redis ç›‘å¬äºTCP<br>sed â€˜s/^port .*/port 0/â€˜ /etc/redis.conf.orig | sudo tee /etc/redis.conf</p><p>#å¯ç”¨Redis socket<br>echo â€˜unixsocket /var/run/redis/redis.sockâ€™ | sudo tee -a /etc/redis.conf<br>echo -e â€˜unixsocketperm 0770â€™ | sudo tee -a /etc/redis.conf</p><p>#è®¾ç½®socketç›®å½•å±ä¸»ï¼ˆç»„ï¼‰ä¸ºredis<br>chown redis:redis /var/run/redis<br>chmod 755 /var/run/redis</p><p>#å°†gitç”¨æˆ·æ·»åŠ è‡³redisç»„<br>usermod -aG redis git</p><p>#å¯åŠ¨redisæœåŠ¡<br>service redis start</p><p>&nbsp; 15.å®‰è£…gitlabï¼Œä»¥åŠç›¸å…³é…ç½®</p><p>cd /home/git/<br>sudo -u git -H git clone <a href="http://git.oschina.net/Yxnt/gitlab">http://git.oschina.net/Yxnt/gitlab</a></p><p># é…ç½®gitlab<br>cd /home/git/gitlab &amp;&amp; sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml</p><p>#è®¿é—®åœ°å€ä¸ºæœ¬æœºIP<br>sudo -u git -H sed -ie â€œs/host: .*/host: `hostname â€“all-ip-addresses`/gâ€ config/gitlab.yml</p><p>#åˆ›å»ºsatellitesç›®å½•<br>sudo -u git -H mkdir /home/git/gitlab-satellites &amp;&amp; chmod u+rwx,g=rx,o-rwx /home/git/gitlab-satellites</p><p>#ç¡®è®¤gitlabå¯ä»¥å†™å…¥tmp/pidsã€tmp/socketsä»¥åŠpublic/uploads/ç›®å½•<br>chmod -R u+rwX tmp/pids/ &amp;&amp; chmod -R u+rwX tmp/sockets/ &amp;&amp; chmod -R u+rwX  public/uploads</p><p>#å¤åˆ¶Unicorné…ç½®æ–‡ä»¶<br>sudo -u git -H cp config/unicorn.rb.example config/unicorn.rb</p><p>#å¤åˆ¶Rack attacké…ç½®æ–‡ä»¶<br>sudo -u git -H cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb</p><p>#é…ç½®Git å…¨å±€è®¾ç½®<br>sudo -u git -H git config â€“global user.name â€œGitLabâ€<br>sudo -u git -H git config â€“global user.email â€œ<a href="mailto:example@example.com">example@example.com</a>â€œ<br>sudo -u git -H git config â€“global core.autocrlf input</p><p>#é…ç½®Redisè¿æ¥è®¾ç½®<br>sudo -u git -H cp config/resque.yml.example config/resque.yml<br>sudo -u git -H sed -ie â€œs/develo.*/development:\ unix:\/var\/run\/redis\/redis.sock/gâ€ config/resque.yml</p><p>#é…ç½®Gitlab æ•°æ®åº“è®¾ç½®ï¼ˆæ³¨æ„è¿™é‡Œçš„socketæ–‡ä»¶ä½ç½®ï¼Œä¸åŒç‰ˆæœ¬çš„mysqlä½ç½®ä¸ä¸€æ ·)<br>sudo -u git cp config/database.yml.mysql config/database.yml<br>sudo -u git sed -ie â€œ12s/password: \â€œsecure password\â€œ/password: $MYSQL_PASS/gâ€ config/database.yml<br>sudo -u git sed -ie â€œ13,14s/#\ //gâ€ config/database.yml<br>sudo -u git sed -ie â€œ14s@socket: \/tmp\/mysql.sock@socket: \/var\/lib/mysql\/mysql.sock@gâ€ config/database.yml</p><p>#ç¡®å®šdatabase.ymlæ–‡ä»¶åªä¸ºgitç”¨æˆ·å¯è¯»<br>sudo -u git -H chmod o-rwx config/database.yml</p><p>&nbsp; 16.å®‰è£…Gems</p><p>cd /home/git/gitlab</p><p>#æ›´æ¢é…ç½®æ–‡ä»¶ä¸­çš„rubyæº<br>sudo -u git -H sed -ie â€œs@source\ \â€œhttp:\/\/rubygems.org\â€œ@source\ \â€œhttp:\/\/ruby.taobao.org\â€œ@gâ€ ../gitlab-shell/Gemfile</p><p>#å®‰è£…<br>sudo -u git -H bundle install â€“deployment â€“without development test postgres aws</p><p>&nbsp; 17.å®‰è£…,é…ç½®gitlab-shell</p><p>cd /home/git/gitlab/<br>sudo -u git -H bundle exec rake gitlab<span class="github-emoji"><span>ğŸš</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>install[v2.6.3] REDIS_URL=unix:/var/run/redis/redis.sock RAILS_ENV=production</p><p>#é…ç½®(åœ¨å®‰è£…è¿‡ç¨‹ä¸­å…¶å®gitlab-shellé…ç½®å·²ç»è‡ªåŠ¨ç”Ÿæˆäº†ï¼Œä½†æ˜¯æœ‰å¿…è¦æ£€æŸ¥æ ¸å®ä¸€ä¸‹é‡Œé¢çš„é…ç½®ï¼Œå°¤å…¶æ˜¯gitlab_url)<br>cp /home/git/gitlab-shell/config.yml /home/git/gitlab-shell/config.yml.bak</p><p>&nbsp; 18.åˆå§‹åŒ–æ•°æ®å¹¶ä¸”æ¿€æ´»é«˜çº§ç‰¹æ€§</p><p>#è¿™é‡Œä¼šæç¤ºè¾“å…¥yes/noï¼Œè¾“å…¥yeså³å¯ï¼ˆæˆ‘è¿™é‡Œç›´æ¥ä¼ é€’ä¸€ä¸ªyesè¿‡å»ï¼‰<br>echo yes| sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production<br>#è¿™é‡Œä¼šç”Ÿæˆä¸€ä¸ªè´¦æˆ·å’Œå¯†ç ï¼š<br>#loginâ€¦â€¦â€¦root<br>#passwordâ€¦â€¦5iveL!fe è¿™ä¸ªå¯†ç å¯ä»¥æ›´æ”¹ï¼š sudo -u git -H bundle exec rake gitlab:setup RAILS_ENV=production GITLAB_ROOT_PASSWORD=YOUR_NETPASSWORD</p><p>#ç”Ÿæˆjs.cssç­‰æ–‡ä»¶ï¼ˆå¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥çš„è¯ï¼Œä½ åœ¨è®¿é—®æ—¶ç½‘é¡µcssç­‰æ˜¯ä¹±çš„ï¼‰<br>cd /home/git/gitlab<br>bundle exec rake assets:precompile RAILS_ENV=production</p><p>&nbsp; 19.å®‰è£…gitlabå¯åŠ¨ç®¡ç†è„šæœ¬</p><p>wget -O /etc/init.d/gitlab <a href="https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/init/sysvinit/centos/gitlab-unicorn">https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/init/sysvinit/centos/gitlab-unicorn</a><br>chmod +x /etc/init.d/gitlab<br>chkconfig â€“add gitlab<br>chkconfig gitlab on</p><p>#è®¾ç½®gitlabæœåŠ¡çš„æ—¥å¿—æ»šåŠ¨<br>cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab</p><p>&nbsp; 20.æ£€æŸ¥åº”ç”¨ç¨‹åºçŠ¶æ€</p><p>sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production<br>#æ‰§è¡Œè¯¥å‘½ä»¤ å¦‚æœé¡ºåˆ©çš„è¯ï¼Œä¼šå°†å…³äºgitlabçš„ ç›¸å…³è¯¦ç»†ä¿¡æ¯å±•ç¤ºå‡ºæ¥</p><p>å’Œä¸‹å›¾å·®ä¸å¤š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/gitlab-information.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/gitlab-information.png" alt="gitlab-information"></a> &nbsp; 21.å¯åŠ¨gitlab</p><p>#å¯åŠ¨gitlab<br>service gitlab start</p><p>&nbsp; 22.å®‰è£…nginx ï¼Œå°†è®¿é—®è¯·æ±‚åä»£åˆ°åç«¯çš„8080ç«¯å£</p><p>yum install -y nginx &amp;&amp; chkconfig nginx on</p><p>#åˆ é™¤nginxä¸­çš„è¿™ä¸ªé»˜è®¤é…ç½®æ–‡ä»¶<br>rm -rf /etc/nginx/conf.d/default.conf</p><p>#è·å–gitlabçš„nginxæ¨¡æ¿é…ç½®æ–‡ä»¶<br>wget -O /etc/nginx/conf.d/gitlab.conf <a href="https://gitlab.com/gitlab-org/gitlab-ce/raw/master/lib/support/nginx/gitlab">https://gitlab.com/gitlab-org/gitlab-ce/raw/master/lib/support/nginx/gitlab</a></p><p>#å¯¹æ¨¡æ¿æ–‡ä»¶çš„ä¸€äº›ä¿®æ”¹<br>sed -ie â€œ38s/.*/server\ localhost:8080;/gâ€ /etc/nginx/conf.d/gitlab.conf<br>sed -ie â€œs/YOUR_SERVER_FQDN/`hostname`/gâ€ /etc/nginx/conf.d/gitlab.conf<br>sed -ie â€œ52dâ€ /etc/nginx/conf.d/gitlab.conf</p><p>#å°†ç”¨æˆ·nginxåŠ å…¥åˆ°gitç»„(è¿™æ­¥éå¸¸çš„å…³é”®)<br>usermod -a -G git nginx<br>chmod g+rx /home/git/</p><p>#å¯åŠ¨nginx<br>service nginx start</p><p>&nbsp; ok ï¼Œè‡³æ­¤gitlabçš„å®‰è£…å·²ç»ç»“æŸã€‚æˆ‘ä»¬é€šè¿‡<a href="http://your-server-ip/">http://YOUR-SERVER-IP/</a> å°±å¯ä»¥è®¿é—®åˆ°ä½ çš„gitlabå¹³å°äº† <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/gitlab-login.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/gitlab-login.png" alt="gitlab-login"></a></p>]]></content>
      
      
      <categories>
          
          <category> Webç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡Inodeåˆ é™¤linuxä¸‹çš„æ–‡ä»¶</title>
      <link href="/2015/09/19/e9-80-9a-e8-bf-87inode-e5-88-a0-e9-99-a4linux-e4-b8-8b-e7-9a-84-e6-96-87-e4-bb-b6/"/>
      <url>/2015/09/19/e9-80-9a-e8-bf-87inode-e5-88-a0-e9-99-a4linux-e4-b8-8b-e7-9a-84-e6-96-87-e4-bb-b6/</url>
      
        <content type="html"><![CDATA[<p>ç”±äºæŸäº›åŸå› åœ¨æˆ‘ä»¬linuxç³»ç»Ÿä¸Šé¢æ€»ä¼šå‡ºç°ä¸€äº›ä¹±ç æ–‡ä»¶ï¼Œæˆ–è€…ä¸èƒ½æ­£å¸¸è¾“å…¥çš„æ–‡ä»¶åï¼Œå½“é‡åˆ°è¿™äº›æ— æ³•æ­£å¸¸è¾“å…¥çš„æ–‡ä»¶åè¦åˆ é™¤çš„æ—¶å€™å°±éœ€è¦ä½¿ç”¨æ–‡ä»¶å¯¹åº”çš„inodeå·å¯¹æ–‡ä»¶è¿›è¡Œåˆ é™¤ã€‚ inodeçš„åŸç†è¿™é‡Œå°±ä¸å†è¯´äº†ï¼Œå…·ä½“è¯´æ˜å‚è§ï¼š<a href="http://www.ruanyifeng.com/blog/2011/12/inode.html">http://www.ruanyifeng.com/blog/2011/12/inode.html</a> ä¸‹é¢è¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶æ˜¯æˆ‘åœ¨ç½‘ä¸Šä¸‹è½½çš„ä¸€ä¸ªç½‘é¡µæ¨¡æ¿ï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ªä¸èƒ½rm çš„æ–‡ä»¶ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-19-132604.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-19-132604.png" alt="Screenshot from 2015-09-19 13:26:04"></a> é‚£ä»ä½•å¾—çŸ¥ -?+?.txt è¿™ä¸ªæ–‡ä»¶çš„inodeå·å‘¢ï¼Œls&nbsp; å‘½ä»¤æœ‰ä¸ªå‚æ•° -i</p><p>  -i, â€“inode                print the index number of each file</p><p><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-19-133027.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-19-133027.png" alt="Screenshot from 2015-09-19 13:30:27"></a> ä¸Šå›¾ä¸­ï¼š<strong>291606</strong>&nbsp; è¿™ä¸ªå·ç å°±æ˜¯ è¿™ä¸ªæ–‡ä»¶çš„inode å·å•¦ã€‚ç„¶åæˆ‘ä»¬ç»“åˆfindå‘½ä»¤å°±å¯ä»¥å°†å®ƒåˆ é™¤å•¦  <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-19-133514.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-19-133514.png" alt="Screenshot from 2015-09-19 13:35:14"></a></p>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> inode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Expectè¯¦è§£(sshè‡ªåŠ¨ç™»å½•)</title>
      <link href="/2015/09/16/expect-e8-af-a6-e8-a7-a3ssh-e8-87-aa-e5-8a-a8-e7-99-bb-e5-bd-95/"/>
      <url>/2015/09/16/expect-e8-af-a6-e8-a7-a3ssh-e8-87-aa-e5-8a-a8-e7-99-bb-e5-bd-95/</url>
      
        <content type="html"><![CDATA[<p>Expectæ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†<strong>äº¤äº’</strong>çš„å‘½ä»¤ã€‚å€ŸåŠ©Expectï¼Œæˆ‘ä»¬å¯ä»¥å°†äº¤äº’è¿‡ç¨‹å†™åœ¨ä¸€ä¸ªè„šæœ¬ä¸Šï¼Œä½¿ä¹‹è‡ªåŠ¨åŒ–å®Œæˆã€‚å½¢è±¡çš„è¯´ï¼Œsshç™»å½•ï¼Œftpç™»å½•ç­‰éƒ½ç¬¦åˆ<strong>äº¤äº’</strong>çš„å®šä¹‰ã€‚ä¸‹æ–‡æˆ‘ä»¬é¦–å…ˆæå‡ºä¸€ä¸ªé—®é¢˜ï¼Œç„¶åä»‹ç»åŸºç¡€çŸ¥å››ä¸ªå‘½ä»¤ï¼Œæœ€åæå‡ºè§£å†³æ–¹æ³•ã€‚ Expectä¸­æœ€å…³é”®çš„å››ä¸ªå‘½ä»¤æ˜¯send,expect,spawn,interactã€‚</p><p>sendï¼šç”¨äºå‘è¿›ç¨‹å‘é€å­—ç¬¦ä¸²<br>expectï¼šä»è¿›ç¨‹æ¥æ”¶å­—ç¬¦ä¸²<br>spawnï¼šå¯åŠ¨æ–°çš„è¿›ç¨‹<br>interactï¼šå…è®¸ç”¨æˆ·äº¤äº’</p><h3 id="1-sendå‘½ä»¤"><a href="#1-sendå‘½ä»¤" class="headerlink" title="1. sendå‘½ä»¤"></a>1. sendå‘½ä»¤</h3><p>sendå‘½ä»¤æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œå¹¶å°†è¯¥å‚æ•°å‘é€åˆ°è¿›ç¨‹ã€‚</p><p>expect1.1&gt; send â€œhello world\nâ€<br>hello world</p><h3 id="2-expectå‘½ä»¤"><a href="#2-expectå‘½ä»¤" class="headerlink" title="2. expectå‘½ä»¤"></a>2. expectå‘½ä»¤</h3><h3 id="1-åŸºç¡€çŸ¥è¯†"><a href="#1-åŸºç¡€çŸ¥è¯†" class="headerlink" title="(1)åŸºç¡€çŸ¥è¯†"></a>(1)åŸºç¡€çŸ¥è¯†</h3><p>expectå‘½ä»¤å’Œsendå‘½ä»¤æ­£å¥½ç›¸åï¼Œexpecté€šå¸¸æ˜¯ç”¨æ¥ç­‰å¾…ä¸€ä¸ªè¿›ç¨‹çš„åé¦ˆã€‚expectå¯ä»¥æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œä¹Ÿå¯ä»¥æ¥æ”¶æ­£åˆ™è¡¨è¾¾å¼å‚æ•°ã€‚å’Œä¸Šæ–‡çš„sendå‘½ä»¤ç»“åˆï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„äº¤äº’å¼çš„ä¾‹å­ï¼š</p><p>expect â€œhi\nâ€<br>send â€œhello there!\nâ€</p><p>è¿™ä¸¤è¡Œä»£ç çš„æ„æ€æ˜¯ï¼šä»æ ‡å‡†è¾“å…¥ä¸­ç­‰åˆ°hiå’Œæ¢è¡Œé”®åï¼Œå‘æ ‡å‡†è¾“å‡ºè¾“å‡ºhello thereã€‚</p><p>tipsï¼š $expect_out(buffer)å­˜å‚¨äº†æ‰€æœ‰å¯¹expectçš„è¾“å…¥ï¼Œ&lt;$expect_out(0,string)&gt;å­˜å‚¨äº†åŒ¹é…åˆ°expectå‚æ•°çš„è¾“å…¥ã€‚</p><p>æ¯”å¦‚å¦‚ä¸‹ç¨‹åºï¼š</p><p>expect â€œhi\nâ€<br>send â€œyou typed &lt;$expect_out(buffer)&gt;â€<br>send â€œbut I only expected &lt;$expect_out(0,string)&gt;â€</p><p>å½“åœ¨æ ‡å‡†è¾“å…¥ä¸­è¾“å…¥</p><p>test<br>hi</p><p>æ˜¯ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹</p><p>you typed: test<br>hi<br>I only expect: hi</p><h4 id="2-æ¨¡å¼-åŠ¨ä½œ"><a href="#2-æ¨¡å¼-åŠ¨ä½œ" class="headerlink" title="(2)æ¨¡å¼-åŠ¨ä½œ"></a>(2)æ¨¡å¼-åŠ¨ä½œ</h4><p>expectæœ€å¸¸ç”¨çš„è¯­æ³•æ˜¯æ¥è‡ªtclè¯­è¨€çš„æ¨¡å¼-åŠ¨ä½œã€‚è¿™ç§è¯­æ³•æå…¶çµæ´»ï¼Œä¸‹é¢æˆ‘ä»¬å°±å„ç§è¯­æ³•åˆ†åˆ«è¯´æ˜ã€‚ å•ä¸€åˆ†æ”¯æ¨¡å¼è¯­æ³•ï¼š</p><p>expect â€œhiâ€ {send â€œYou said hiâ€}</p><p>åŒ¹é…åˆ°hiåï¼Œä¼šè¾“å‡ºâ€you said hiâ€ å¤šåˆ†æ”¯æ¨¡å¼è¯­æ³•ï¼š</p><p>expect â€œhiâ€ { send â€œYou said hi\nâ€ } <br>â€œhelloâ€ { send â€œHello yourself\nâ€ } <br>â€œbyeâ€ { send â€œThat was unexpected\nâ€ }</p><p>åŒ¹é…åˆ°hi,hello,byeä»»æ„ä¸€ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œæ‰§è¡Œç›¸åº”çš„è¾“å‡ºã€‚ç­‰åŒäºå¦‚ä¸‹å†™æ³•ï¼š</p><p>expect {<br>â€œhiâ€ { send â€œYou said hi\nâ€}<br>â€œhelloâ€ { send â€œHello yourself\nâ€}<br>â€œbyeâ€ { send â€œThat was unexpected\nâ€}<br>}</p><h3 id="3-spawnå‘½ä»¤"><a href="#3-spawnå‘½ä»¤" class="headerlink" title="3. spawnå‘½ä»¤"></a>3. spawnå‘½ä»¤</h3><p>ä¸Šæ–‡çš„æ‰€æœ‰demoéƒ½æ˜¯å’Œæ ‡å‡†è¾“å…¥è¾“å‡ºè¿›è¡Œäº¤äº’ï¼Œä½†æ˜¯æˆ‘ä»¬è·Ÿå¸Œæœ›ä»–å¯ä»¥å’ŒæŸä¸€ä¸ªè¿›ç¨‹è¿›è¡Œäº¤äº’ã€‚spawmå‘½ä»¤å°±æ˜¯ç”¨æ¥å¯åŠ¨æ–°çš„è¿›ç¨‹çš„ã€‚spawnå çš„sendå’Œexpectå‘½ä»¤éƒ½æ˜¯å’Œspawnæ‰“å¼€çš„è¿›ç¨‹è¿›è¡Œäº¤äº’çš„ã€‚ç»“åˆä¸Šæ–‡çš„sendå’Œexpectå‘½ä»¤æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹æ›´å¤æ‚çš„ç¨‹åºæ®µäº†ã€‚</p><p>set timeout -1<br>spawn ftp ftp.test.com      //æ‰“å¼€æ–°çš„è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹ç”¨æˆ·è¿æ¥è¿œç¨‹ftpæœåŠ¡å™¨<br>expect â€œNameâ€             //è¿›ç¨‹è¿”å›Nameæ—¶<br>send â€œuser\râ€        //å‘è¿›ç¨‹è¾“å…¥anonymous\r<br>expect â€œPassword:â€        //è¿›ç¨‹è¿”å›Password:æ—¶<br>send â€œ123456\râ€    //å‘è¿›ç¨‹è¾“å…¥<a href="mailto:don@libes.com">don@libes.com</a>\r<br>expect â€œftp&gt; â€œ            //è¿›ç¨‹è¿”å›ftp&gt;æ—¶<br>send â€œbinary\râ€           //å‘è¿›ç¨‹è¾“å…¥binary\r<br>expect â€œftp&gt; â€œ            //è¿›ç¨‹è¿”å›ftp&gt;æ—¶<br>send â€œget test.tar.gz\râ€  //å‘è¿›ç¨‹è¾“å…¥get test.tar.gz\r</p><p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯ç™»å½•åˆ°ftpæœåŠ¡å™¨ftp ftp.uu.netä¸Šï¼Œå¹¶ä»¥äºŒè¿›åˆ¶çš„æ–¹å¼ä¸‹è½½æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶test.tar.gzã€‚ç¨‹åºä¸­æœ‰è¯¦ç»†çš„æ³¨é‡Šã€‚</p><h3 id="4-interact"><a href="#4-interact" class="headerlink" title="4.interact"></a>4.interact</h3><p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ç»“åˆspawnã€expectã€sendè‡ªåŠ¨åŒ–çš„å®Œæˆå¾ˆå¤šä»»åŠ¡äº†ã€‚ä½†æ˜¯ï¼Œå¦‚ä½•è®©äººåœ¨é€‚å½“çš„æ—¶å€™å¹²é¢„è¿™ä¸ªè¿‡ç¨‹äº†ã€‚æ¯”å¦‚ä¸‹è½½å®Œ ftpæ–‡ä»¶æ—¶ï¼Œä»ç„¶å¯ä»¥åœç•™åœ¨ftpå‘½ä»¤è¡ŒçŠ¶æ€ï¼Œä»¥ä¾¿æ‰‹åŠ¨çš„æ‰§è¡Œåç»­å‘½ä»¤ã€‚interactå¯ä»¥è¾¾åˆ°è¿™äº›ç›®çš„ã€‚ä¸‹é¢çš„demoåœ¨è‡ªåŠ¨ç™»å½•ftpåï¼Œå…è®¸ç”¨ æˆ·äº¤äº’ã€‚</p><p>spawn ftp ftp.test.com<br>expect â€œNameâ€<br>send â€œuser\râ€<br>expect â€œPassword:â€<br>send â€œ123456\râ€<br>interact</p><p>å¦‚ä½•å®ç°expect sshè‡ªåŠ¨ç™»å½•ï¼Ÿ</p><p>yum install -y expect </p><p>vim loging_myvps.sh<br>#!/usr/bin/expect -f<br>set ip xxx.xxx.xxx.xxx<br>set password **********<br>set timeout 10<br>spawn ssh USERNAME@$ip<br>expect {<br>â€œ*yes/noâ€ { send â€œyes\râ€; exp_continue}<br>â€œ*password:â€ { send â€œ$password\râ€ }<br>}<br>interact</p><p>./login_myvps.sh   å³å¯ç™»å½•</p>]]></content>
      
      
      <categories>
          
          <category> Shell </category>
          
          <category> è„šæœ¬ç¼–ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> expect </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python os.systemçš„ç»“æœä¸èƒ½èµ‹å€¼åˆ°å˜é‡</title>
      <link href="/2015/09/15/python-os-system-e7-9a-84-e7-bb-93-e6-9e-9c-e4-b8-8d-e8-83-bd-e8-b5-8b-e5-80-bc-e5-88-b0-e5-8f-98-e9-87-8f/"/>
      <url>/2015/09/15/python-os-system-e7-9a-84-e7-bb-93-e6-9e-9c-e4-b8-8d-e8-83-bd-e8-b5-8b-e5-80-bc-e5-88-b0-e5-8f-98-e9-87-8f/</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©åœ¨å­¦ä¹ python osæ¨¡å—çš„systemæ–¹æ³•æ—¶ï¼Œå‘ç°ä¸èƒ½èµ‹å€¼ç»™å˜é‡ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-15-224523.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-15-224523.png" alt="Screenshot from 2015-09-15 22:45:23"></a> &nbsp; åæ¥æŸ¥è¯¢å¾—çŸ¥æœ‰æ›´æ–°çš„æ¨¡å—ï¼Œå¦‚ä¸‹ï¼š</p><p>os.system<br>os.spawn*<br>os.popen*<br>popen2.*<br>commands.*</p><p>é‡æ–°ä½¿ç”¨a = os.popen(â€˜df -hTâ€™).read()&nbsp; å°±èƒ½è·å–åˆ°å•¦ã€‚ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-15-225038.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-15-225038.png" alt="Screenshot from 2015-09-15 22:50:38"></a></p>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Git ä»£ç æ‹‰å–ã€åŒæ­¥ã€é€šçŸ¥</title>
      <link href="/2015/09/14/git-e4-bb-a3-e7-a0-81-e6-8b-89-e5-8f-96-e3-80-81-e5-90-8c-e6-ad-a5-e3-80-81-e9-80-9a-e7-9f-a5/"/>
      <url>/2015/09/14/git-e4-bb-a3-e7-a0-81-e6-8b-89-e5-8f-96-e3-80-81-e5-90-8c-e6-ad-a5-e3-80-81-e9-80-9a-e7-9f-a5/</url>
      
        <content type="html"><![CDATA[<p>ä»£ç æ‰˜ç®¡åˆ°gtihubï¼Œå¼€å‘äººå‘˜è¿›è¡Œæœ¬åœ°ä¿®æ”¹pushåˆ°ä»“åº“åï¼Œè¿™é‡Œä½¿ç”¨pullåœ¨webæœåŠ¡å™¨ä¸Šå®šæœŸæ‹‰å»ä»£ç è‡³å¼€å‘å¼€å‘æœåŠ¡å™¨</p><p>more code_sync_template.sh<br>#!/bin/sh<br>update_dir=â€/home/demo/â€œ #every time upload code main dir<br>webroot=â€/var/www/templateâ€<br>#bak_dir=â€/codedata/bak/deployâ€ #backup file main dir<br>gibin=â€/usr/bin/gitâ€ #git bin path<br>rsync_bin=â€/usr/bin/rsyncâ€  #rsync path<br>#è¿™ä¸ªå˜é‡å®šä¹‰çš„æ˜¯ä»£ç æ‹‰å–åˆ°æœ¬åœ°ä¹‹ååŒæ­¥åˆ°webç›®å½•æ—¶è¿‡æ’é™¤ä¸€äº›ç‰¹å®šçš„æ–‡ä»¶<br>#rsync_exclude=â€.svn|<em>.gz|</em>.cache|<em>.txt|</em>.git|_tmp|temp|pma|dsn.php|gem*|global_config.php<br>â€œ<br>Name=â€templateâ€<br>LOG=â€/var/log/code_sync_template.logâ€<br>TIME=`date +%F\ %T`<br>OLD_IFS=â€$IFSâ€  #backup IFS<br>COMMAND=â€sed -n â€˜/$TIME start/,\$pâ€™ $LOG &gt; /tmp/template.logâ€</p><p>#get gitos code to local<br>pull_code()<br>{<br>if [ -d $update_dir/$Name ];then</p><pre><code>  if cd $update_dir/$Name &amp;&amp; $gibin pull git@è¿™é‡Œæ˜¯ä½ çš„ä»£ç ä»“åº“åœ°å€ &amp;&gt;&gt;</code></pre><p> $LOG ;then<br>           echo -e â€œ\033[32m `date` git pull code success \033[mâ€<br>      else<br>           echo -e â€œ\033[31m `date` git pull code error \033[mâ€ &amp;&amp; exit 1<br>      fi<br>else<br>     echo -e â€œ\033[32m Clone code to local. \033[mâ€<br>     cd $update_dir &amp;&amp; $gibin clone git@è¿™é‡Œæ˜¯ä½ çš„ä»£ç ä»“åº“åœ°å€<br>fi<br>}</p><p>#sync local code to webroot<br>#å®šä¹‰çš„æ˜¯å°†æœ€æ–°æ‹‰å–åˆ°çš„ä»£ç åŒæ­¥åˆ°webç›®å½•<br>sync_code()<br>{<br>#$rsync_bin -uavz $update_dir/$Name $webroot/$Name<br>if [ â€œ$rsync_excludeâ€ ];then<br>IFS=â€|â€<br>   exclude_arr=($rsync_exclude)<br>     for e_arr in ${exclude_arr[@]};do<br>          echo $e_arr &gt;&gt;/tmp/code_exclude_list<br>     done<br>$rsync_bin -avz â€“exclude-from=â€/tmp/code_exclude_listâ€  $update_dir/$Name/* $webr<br>oot/<br>else<br>$rsync_bin -avz  $update_dir/$Name/* $webroot/<br>fi<br>IFS=â€$OLD_IFSâ€<br>}</p><p>Notice(){<br>        #è¿™ä¸ªæ˜¯é€šè¿‡ä¸€ä¸ªevalå‘½ä»¤æ¥æ‰§è¡Œä¸€æ®µå‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤æè¿°çš„æ˜¯ä»ä¸Šæ¬¡è„šæœ¬æ‰§è¡Œè®°å½•æ—¥å¿—åå¼€å§‹åˆ°æœ€åçš„æ—¥å¿—ä¿¡æ¯<br>eval $COMMAND<br>        #è¿™é‡Œæ˜¯åœ¨è¿‡æ»¤æ­¤æ¬¡åŒæ­¥æ˜¯è®°å½•çš„æ—¥å¿—ä¸­pullæœ‰æ²¡æœ‰æ–‡ä»¶æ›´æ–°<br>grep -E â€œfiles changed|Fast-forwardâ€ /tmp/template.log<br>if [ $? -eq 0 ];then<br>        #è¿™é‡Œä½¿ç”¨ä¸€ä¸ªpythonè„šæœ¬æ¥è·å–pullæ—¶æ›´æ–°äº†çš„å…·ä½“æ–‡ä»¶æœ‰å“ªäº›ï¼Œç„¶åå°†å†…å®¹é€šè¿‡é‚®ä»¶å‘é€åˆ°æŒ‡å®šé‚®ç®±<br>python /home/demo/mail-template.py<br>else<br>        exit 5<br>fi<br>}</p><p>echo â€˜ â€˜ &gt;&gt; $LOG<br>echo -e â€œ\033[42;37m ############ Template $TIME start ############ \033[mâ€ &gt;&gt; $LOG<br>echo -e â€œ\033[47;30m Template Pull remote code to local. \033[0mâ€ &gt;&gt; $LOG<br>echo -e â€œ\033[47;30m Template Pull remote code to local. \033[0mâ€<br>pull_code &gt;&gt; $LOG<br>echo -e â€œ\033[47;30m Template Sync local code to wwwroot.\033[0mâ€ &gt;&gt; $LOG<br>echo -e â€œ\033[47;30m Template Sync local code to wwwroot.\033[0mâ€<br>sync_code &gt;&gt; $LOG<br>echo -e â€œ\033[46;37m ############ Template $TIME  end  ############ \033[mâ€ &gt;&gt; $LOG<br>echo â€˜ â€˜ &gt;&gt; $LOG<br>Notice</p><p>&nbsp; é‚®ä»¶é€šçŸ¥è„šæœ¬ï¼Œèƒ½å¤Ÿåœ¨è‡ªå®šä¹‰çš„æ—¶é—´å‘¨æœŸå†…è·å–åˆ°æœ€æ–°ä»£ç æ—¶ èƒ½å‘é€é‚®ä»¶åˆ°æŒ‡å®šçš„é‚®ç®±ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æé†’ç®¡ç†äººå‘˜çŸ¥æ‚‰è¿™ä¸€åŠ¨ä½œã€‚</p><p>#!/usr/bin/env python<br>#-*- coding: UTF-8 -*-<br>import smtplib<br>import os,sys<br>from email.mime.text import MIMEText</p><p>mailto_list=[â€˜<a href="mailto:guomaoqiu@gmail.com">guomaoqiu@gmail.com</a>â€˜]<br>mail_host=â€™smtp.qq.comâ€™<br>mail_port=â€™25â€™<br>mail_user=â€™2399447849â€™<br>mail_pass=â€™xxxxxxâ€™<br>mail_postfix=â€™qq.comâ€™</p><p>filename = â€œ/tmp/template.logâ€</p><p>fo = open(filename,â€rbâ€)<br>filecon = fo.read();<br>str1 = â€œ</p><pre>{0}</pre>â€œ.format(filecon)<p></p><p>def send_mail(to_list,sub,content):<br>    me=â€Code Sync Noticeã€Templateã€‘â€+â€&lt;â€+mail_user+â€@â€+mail_postfix+â€&gt;â€<br>    msg = MIMEText(content,_subtype=â€™htmlâ€™,_charset=â€™utt-8â€™)<br>    msg[â€˜Subjectâ€™] = sub<br>    msg[â€˜Fromâ€™]=me<br>    msg[â€˜toâ€™]=â€;â€.join(to_list)<br>    try:<br>        s = smtplib.SMTP()<br>   s.connect(mail_host)<br>s.login(mail_user,mail_pass)<br>s.sendmail(me,to_list,msg.as_string())<br>s.close()<br>return True<br>    except Exception, e:<br>print str(e)<br>return False<br>if __name__==â€™__main__â€˜:<br>   if send_mail(mailto_list,â€New Files Are Addedâ€,str1):<br>print â€œå‘é€æˆåŠŸâ€<br>   else:<br>print â€œå‘é€å¤±è´¥â€</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
          <category> Shell </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Pythonå‘é€é‚®ä»¶(é‚®ä»¶å†…å®¹ä»æ–‡ä»¶è¯»å…¥)</title>
      <link href="/2015/09/10/python-e5-8f-91-e9-80-81-e9-82-ae-e4-bb-b6-e9-82-ae-e4-bb-b6-e5-86-85-e5-ae-b9-e4-bb-8e-e6-96-87-e4-bb-b6-e8-af-bb-e5-85-a5/"/>
      <url>/2015/09/10/python-e5-8f-91-e9-80-81-e9-82-ae-e4-bb-b6-e9-82-ae-e4-bb-b6-e5-86-85-e5-ae-b9-e4-bb-8e-e6-96-87-e4-bb-b6-e8-af-bb-e5-85-a5/</url>
      
        <content type="html"><![CDATA[<p>æœ‰ä¸ªéœ€æ±‚ï¼Œåˆ©ç”¨pythonè„šæœ¬å‘å‡ºæ¥çš„é‚®ä»¶çš„å†…å®¹æ˜¯ä»æ–‡ä»¶è¯»å–çš„ã€‚å¹¶ä¸”ä¿æŒè¿™ä¸ªæ–‡ä»¶åŸæœ‰çš„æ ¼å¼ã€‚</p><p>#!/usr/bin/env python<br>#-*- coding: UTF-8 -*-<br>import smtplib,os,sys<br>from email.mime.text import MIMEText</p><p>mailto_list=[â€˜<a href="mailto:guomaoqiu@gmail.com">guomaoqiu@gmail.com</a>â€˜]<br>mail_host=â€™smtp.qq.comâ€™<br>mail_port=â€™25â€™<br>mail_user=â€™2399447849â€™<br>mail_pass=â€™xxxxxxxxxâ€™   #-&gt;ä½ æ‡‚çš„â€¦<br>mail_postfix=â€™qq.comâ€™</p><p>filename = â€œ/tmp/test.logâ€   #-&gt;å°†è¦è¯»å–ä½œä¸ºé‚®ä»¶å†…å®¹çš„æ–‡ä»¶</p><p>fo = open(filename,â€rbâ€)<br>filecon = fo.read();<br>str1 = â€œ</p><pre>{0}</pre>â€œ.format(filecon)  <p></p><p>def send_mail(to_list,sub,content):<br>    me=â€Code Sync Noticeâ€+â€&lt;â€+mail_user+â€@â€+mail_postfix+â€&gt;â€<br>    msg = MIMEText(content,_subtype=â€™htmlâ€™,_charset=â€™utf-8â€™)<br>    msg[â€˜Subjectâ€™] = sub<br>    msg[â€˜Fromâ€™]=me<br>    msg[â€˜toâ€™]=â€;â€.join(to_list)<br>    try:<br>        s = smtplib.SMTP()<br>        s.connect(mail_host)<br>        s.login(mail_user,mail_pass)<br>        s.sendmail(me,to_list,msg.as_string())<br>        s.close()<br>        return True<br>    except Exception, e:<br>        print str(e)<br>        return False<br>if __name__==â€™__main__â€˜:<br>   if send_mail(mailto_list,â€New Flies Are Addedâ€,str1):<br>        print â€œå‘é€æˆåŠŸâ€<br>   else:<br>        print â€œå‘é€å¤±è´¥â€</p><p>æ‰§è¡Œç»“æœï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-10-222600.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-10-222600.png" alt="Screenshot from 2015-09-10 22:26:00"></a> ä¹‹å‰å‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘åœ¨æ–‡ä»¶è¯»å–ä¹‹åå†™æˆè¿™æ ·çš„ï¼Œæœªå¯¹è¯»å…¥çš„å­—ç¬¦ä¸²æ ¼å¼æ ¼å¼åŒ–ã€‚</p><p>fo = open(filename,â€rbâ€)<br>filecon = fo.read();<br>str1 = filecon</p><p>è€Œè¿™æ ·å‘å‡ºæ¥çš„é‚®ä»¶ç»“æœå´æ˜¯è¿™æ ·çš„ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-10-222819.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-10-222819.png" alt="Screenshot from 2015-09-10 22:28:19"></a> å‘é€ HTML å½¢å¼çš„é‚®ä»¶ï¼Œéœ€è¦ email.mime.text ä¸­çš„ MIMEText çš„ _subtype è®¾ç½®ä¸º htmlï¼Œå¹¶ä¸” _text çš„å†…å®¹åº”è¯¥ä¸º HTML å½¢å¼ å¯å‚è€ƒï¼š<a href="http://m.blog.chinaunix.net/uid-23802873-id-4477364.html">http://m.blog.chinaunix.net/uid-23802873-id-4477364.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Pythoné“¾æ¥mysqlæ•°æ®åº“çš„ä¸€äº›æ“ä½œ</title>
      <link href="/2015/09/10/python-e9-93-be-e6-8e-a5mysql-e6-95-b0-e6-8d-ae-e5-ba-93-e7-9a-84-e4-b8-80-e4-ba-9b-e6-93-8d-e4-bd-9c/"/>
      <url>/2015/09/10/python-e9-93-be-e6-8e-a5mysql-e6-95-b0-e6-8d-ae-e5-ba-93-e7-9a-84-e4-b8-80-e4-ba-9b-e6-93-8d-e4-bd-9c/</url>
      
        <content type="html"><![CDATA[<p>ä¸€ã€å®éªŒè§„åˆ’ 1ã€é¦–å…ˆå®éªŒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æå‰åˆ›å»ºä¸€ä¸ªæ•°æ®åº“TESTDBï¼Œç„¶åæˆä¸€ä¸ªç”¨æˆ·testç®¡ç†è¯¥æ•°æ®åº“,è¿™é‡Œæˆ‘è®¾ç½®çš„å¯†ç æ˜¯test123; 2ã€è¦ç”¨pythoné“¾æ¥æ•°æ®åº“éœ€è¦ç”¨åˆ°ç¬¬ä¸‰æ–¹æ³•æ¨¡å—MySQLdb; 3ã€åˆ©ç”¨pythonè„šæœ¬å¯¹æ•°æ®åº“åšä¸€äº›ç®€å•æ“ä½œ; äºŒã€å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å—MySQLdb. 1ã€è·å–æ¨¡å—</p><p>wget <a href="https://pypi.python.org/packages/source/M/MySQL-python/MySQL-python-1.2.5.zip">https://pypi.python.org/packages/source/M/MySQL-python/MySQL-python-1.2.5.zip</a></p><p>2ã€è§£å‹ï¼Œå®‰è£…</p><p>unzip MySQL-python-1.2.5.zip<br>cd MySQL-python-1.2.5<br>python setup.py build<br>python setup.py install</p><p>3ã€æ£€æŸ¥å®‰è£…æƒ…å†µï¼Œè¿›å…¥pythonå‘½ä»¤è¡Œæ‰§è¡Œ importï¼Œå¦‚æœä¸æŠ¥å‡ºä»»ä½•ä¿¡æ¯è¯´æ˜æˆåŠŸå®‰è£…å¹¶ä¸”å¯¼å…¥æˆåŠŸ</p><p>demo@demo:~$ python<br>Python 2.7.9 (default, Apr  2 2015, 15:33:21)<br>[GCC 4.9.2] on linux2<br>Type â€œhelpâ€, â€œcopyrightâ€, â€œcreditsâ€ or â€œlicenseâ€ for more information.</p><blockquote><blockquote><p>&gt; import MySQLdb</p><blockquote></blockquote></blockquote></blockquote><p>ä¸‰ã€å¯¹mysqlæ•°æ®åº“çš„ä¸€äº›æ“ä½œ 1ã€è¿æ¥æ•°æ®åº“TESTDBå¹¶æŸ¥çœ‹æ•°æ®åº“çš„ç‰ˆæœ¬</p><p>#!/usr/bin/env python<br>#-*- coding: UTF-8 -*-<br>import MySQLdb</p><p>db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€)</p><p>cursor = db.cursor()</p><p>cursor.execute(â€œSELECT VERSION()â€)</p><p>data = cursor.fetchone()</p><p>print â€œDatabase version: %s â€œ % data</p><p>db.close()</p><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p>demo@demo:<del>/python_learn$ python mysql_connect.py<br>Database version: 5.6.25-0ubuntu0.15.04.1<br>demo@demo:</del>/python_learn$ </p><p>2ã€é“¾æ¥åˆ°æ•°æ®åº“TESTDBå¹¶ä¸”åˆ›å»ºä¸€ä¸ªå¼ è¡¨</p><p>#!/usr/bin/env python<br>#-*- coding: UTF-8 -*-<br>import MySQLdb</p><p>db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€)</p><p>cursor = db.cursor()</p><p>cursor.execute(â€œDROP TABLE IF EXISTS EMPLOYEEâ€)</p><p>sql = â€œâ€â€CREATE TABLE `EMPLOYEE` (<br>  `FIRST_NAME` varchar(20) DEFAULT NULL,<br>  `LAST_NAME` varchar(20) DEFAULT NULL,<br>  `AGE` int(11) DEFAULT NULL,<br>  `SEX` varchar(20) DEFAULT NULL,<br>  `INCOME` varchar(20) DEFAULT NULL<br>) ENGINE=InnoDB DEFAULT CHARSET=latin1 â€œâ€â€</p><p>cursor.execute(sql)</p><p>db.close()</p><p>æ‰§è¡Œç»“æœæˆ‘ä»¬é€šè¿‡é“¾æ¥åˆ°æ•°æ®åº“å»æŸ¥çœ‹</p><p>mysql&gt; use TESTDB;<br>Database changed<br>mysql&gt; SHOW TABLES;<br>+â€”â€”â€”â€”â€”â€”+<br>| Tables_in_TESTDB |<br>+â€”â€”â€”â€”â€”â€”+<br>| EMPLOYEE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>+â€”â€”â€”â€”â€”â€”+<br>1 row in set (0.00 sec)</p><p>mysql&gt;<br>mysql&gt; DESC EMPLOYEE;<br>+â€”â€”â€”â€”+â€”â€”â€”â€”-+â€”â€”+â€”â€“+â€”â€”â€”+â€”â€”-+<br>| Field&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Null | Key | Default | Extra |<br>+â€”â€”â€”â€”+â€”â€”â€”â€”-+â€”â€”+â€”â€“+â€”â€”â€”+â€”â€”-+<br>| FIRST_NAME | varchar(20) | YES&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>| LAST_NAME&nbsp; | varchar(20) | YES&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>| AGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | int(11)&nbsp;&nbsp;&nbsp;&nbsp; | YES&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>| SEX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | varchar(20) | YES&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>| INCOME&nbsp;&nbsp;&nbsp;&nbsp; | varchar(20) | YES&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br>+â€”â€”â€”â€”+â€”â€”â€”â€”-+â€”â€”+â€”â€“+â€”â€”â€”+â€”â€”-+<br>5 rows in set (0.00 sec)</p><p>mysql&gt; select * from EMPLOYEE;   #ç›®å‰è¯¥è¡¨æ²¡æœ‰ä»»ä½•æ•°æ®<br>Empty set (0.00 sec)</p><p>mysql&gt;</p><p>3ã€è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¹¶åœ¨EMPLOYEEè¡¨ä¸­æ’å…¥æ•°æ®</p><p>#!/usr/bin/env python<br>#-*- coding: UTF-8 -*-<br>import MySQLdb</p><p>db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€)</p><p>cursor = db.cursor()</p><p>sql = â€œâ€â€INSERT INTO EMPLOYEE(FIRST_NAME,<br> LAST_NAME,AGE,SEX,INCOME)<br> VALUES (â€˜Guoâ€™,â€™Maoqiuoâ€™,â€™24â€™,â€™Mâ€™,â€™1991â€™)â€â€â€</p><p>try:<br>    cursor.execute(sql)<br>    db.commit()<br>except:<br>    db.rollback()</p><p>db.close()</p><p>æ‰§è¡Œç»“æœå¦‚ä¸‹</p><p>mysql&gt; select * from EMPLOYEE;<br>+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+<br>| FIRST_NAME | LAST_NAME | AGE  | SEX  | INCOME |<br>+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+<br>| Guo        | Maoqiuo   |   24 | M    | 1991   |<br>+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+<br>1 row in set (0.00 sec)</p><p>mysql&gt; </p><p>4ã€é“¾æ¥æ•°æ®åº“ä½¿ç”¨selectè¯­å¥è¿›è¡ŒæŸ¥è¯¢ï¼Œè¿™é‡Œå®éªŒä½¿ç”¨æ¡ä»¶æŸ¥è¯¢ï¼Œé‚£æˆ‘éœ€è¦å¤šä¸€ç‚¹æ•°æ®æ‰è¡Œï¼Œé‚£æˆ‘ä¿®æ”¹ä¸Šé¢çš„é‚£ä¸ªè„šæœ¬ç„¶åå¤šæ‰§è¡Œå‡ éå³å¯ï¼Œçœ‹åˆ°çš„ç»“æœå¦‚ä¸‹</p><p>mysql&gt; select * from EMPLOYEE;<br>+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+<br>| FIRST_NAME | LAST_NAME | AGE  | SEX  | INCOME |<br>+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+<br>| Guo        | Maoqiuo   |   24 | M    | 1991   |<br>| Bruce      | Li        |   25 | M    | 1989   |<br>| Fan        | bingbing  |   28 | F    | 1988   |<br>| Jack       | cheng     |   45 | M    | 1968   |<br>| joy        | jiang     |   26 | F    | 1977   |<br>+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+<br>5 rows in set (0.00 sec)</p><p>ä½¿ç”¨æ¡ä»¶æŸ¥è¯¢</p><p>#!/usr/bin/env python<br>#-*- coding: UTF-8 -*-<br>import MySQLdb</p><p>db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€)</p><p>cursor = db.cursor()</p><p>sql = â€œSELECT * FROM EMPLOYEE WHERE INCOME &gt; â€˜%dâ€™â€ % (1988)</p><p>try:<br>    cursor.execute(sql)<br>    results = cursor.fetchall()</p><pre><code>for row in results:    fname = row\[0\]    lname = row\[1\]    age = row\[2\]    sex = row\[3\]    income = row\[4\]    print "Fname=%s, Lanme=%s, Age=%d, Sex=%s, Income=%s\\n"  % (fname,lname,age,sex,income)</code></pre><p>except:<br>    print â€œError: unable to fecth dataâ€</p><p>db.close()</p><p>æ‰§è¡Œç»“æœå¦‚ä¸‹</p><p>deamon@deamon:~/python_learn$ python mysql_select.py<br>Fname=Guo, Lanme=Maoqiuo, Age=24, Sex=M, Income=1991</p><p>Fname=Bruce, Lanme=Li, Age=25, Sex=M, Income=1989</p><p>4ã€è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¹¶æ›´æ–°åœ¨EMPLOYEEè¡¨çš„æ•°æ®ï¼Œå°†æ€§åˆ«ä¸ºMçš„äººå‘˜åœ¨å¹´é¾„ä¸ŠåŠ 2</p><p>#!/usr/bin/env python<br>#-*- coding: UTF-8 -*-<br>import MySQLdb</p><p>db = MySQLdb.connect(â€œlocalhostâ€,â€testuserâ€,â€test123â€,â€TESTDBâ€)</p><p>cursor = db.cursor()</p><p>sql = â€œUPDATE EMPLOYEE SET AGE = AGE +2  WHERE  SEX = â€˜%câ€™ â€œ % (â€˜Mâ€™)</p><p>try:<br>    cursor.execute(sql)<br>    db.commit()<br>except:<br>    db.rollback()<br>    print â€œErrorâ€</p><p>db.close()</p><p>æ‰§è¡Œåçš„ç»“æœ</p><p>mysql&gt; select * from TESTDB.EMPLOYEE;<br>+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+<br>| FIRST_NAME | LAST_NAME | AGE  | SEX  | INCOME |<br>+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+<br>| Guo        | Maoqiuo   |   26 | M    | 1991   |<br>| Bruce      | Li        |   27 | M    | 1989   |<br>| Fan        | bingbing  |   28 | F    | 1988   |<br>| Jack       | cheng     |   47 | M    | 1968   |<br>| joy        | jiang     |   26 | F    | 1977   |<br>+â€”â€”â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”+â€”â€”â€“+<br>5 rows in set (0.00 sec)</p><p>mysql&gt;</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysqldb </tag>
            
            <tag> python-mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Seafile-ä¸ªäºº/å›¢é˜Ÿ/å…¬å¸ä¸“å±ç§æœ‰æ–‡ä»¶åŒæ­¥æœåŠ¡ (äº‘å­˜å‚¨ç½‘ç›˜)</title>
      <link href="/2015/09/08/seafile-e4-b8-aa-e4-ba-ba-e5-9b-a2-e9-98-9f-e5-85-ac-e5-8f-b8-e4-b8-93-e5-b1-9e-e7-a7-81-e6-9c-89-e6-96-87-e4-bb-b6-e5-90-8c-e6-ad-a5-e6-9c-8d-e5-8a-a1-e4-ba-91-e5-ad-98-e5-82-a8-e7-bd-91/"/>
      <url>/2015/09/08/seafile-e4-b8-aa-e4-ba-ba-e5-9b-a2-e9-98-9f-e5-85-ac-e5-8f-b8-e4-b8-93-e5-b1-9e-e7-a7-81-e6-9c-89-e6-96-87-e4-bb-b6-e5-90-8c-e6-ad-a5-e6-9c-8d-e5-8a-a1-e4-ba-91-e5-ad-98-e5-82-a8-e7-bd-91/</url>
      
        <content type="html"><![CDATA[<p>ä¸€ã€ç®€ä»‹ï¼š <strong>seafile</strong> æ˜¯ç”±å›½å†…å›¢é˜Ÿå¼€å‘çš„ä¸€ä¸ªå›½é™…åŒ–çš„<strong>å¼€æºäº‘å­˜å‚¨è½¯ä»¶</strong>é¡¹ç›®ï¼Œç›®å‰æ®è¯´å·²æœ‰10ä¸‡å·¦å³çš„ç”¨æˆ·ï¼Œå…¸å‹çš„æœºæ„ç”¨æˆ·åŒ…æ‹¬æ¯”åˆ©æ—¶çš„çš‡å®¶è‡ªç„¶ç§‘å­¦åšç‰©é¦†ã€å¾·å›½çš„ Wuppertal æ°”å€™ã€èƒ½æºç ”ç©¶æ‰€ç­‰ç­‰ã€‚Seafile åŒæ—¶æä¾›äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è½¯ä»¶å…è´¹ä¸‹è½½ï¼Œä»»ä½•ä¸ªäººæˆ–å…¬å¸éƒ½èƒ½æ­å»ºå±äºè‡ªå·±çš„ç§æœ‰æ–‡ä»¶åŒæ­¥æœåŠ¡ã€‚Seafile çš„æœåŠ¡å™¨ç«¯æ”¯æŒ Linux&nbsp;ã€Windows ä»¥åŠæ ‘è“æ´¾å¹³å°ï¼Œå®¢æˆ·ç«¯é™¤äº†ç½‘é¡µç‰ˆä¹‹å¤–ï¼Œè¿˜æ”¯æŒ Macã€Linuxã€Windows ä¸‰ä¸ªæ¡Œé¢å¹³å°ä»¥åŠ Android å’Œ iOS ä¸¤ä¸ªç§»åŠ¨å¹³å°ã€‚ä½ å¯ä»¥åˆ©ç”¨å±€åŸŸç½‘é‡Œçš„ä¸€å°ç”µè„‘ä½œä¸ºæœåŠ¡å™¨ï¼Œæ­å»ºä¸€ä¸ªä»…å±€åŸŸç½‘å†…éƒ¨èƒ½è®¿é—®çš„ä¸“æœ‰äº‘å­˜å‚¨æœåŠ¡ï¼Œä¹Ÿèƒ½å°† Seafile éƒ¨ç½²åˆ°äº’è”ç½‘ä¸Šçš„è¯¸å¦‚é˜¿é‡Œäº‘ã€Linode æˆ–ä»»ä½• VPSã€ç‹¬ç«‹æœåŠ¡å™¨ä¸Šï¼Œå®ç°ä¸€ä¸ªç§äººçš„åœ¨çº¿äº‘å­˜å‚¨æœåŠ¡ã€‚ åŒæ—¶ï¼ŒSeafile æ”¯æŒç”¨æˆ·åŒæ—¶ä½¿ç”¨å¤šä¸ªåŒæ­¥æœåŠ¡å™¨ï¼Œè€Œä¸”èƒ½å¤Ÿåœ¨ä¸åŒæœåŠ¡å™¨ä¹‹é—´åˆ‡æ¢ã€‚æ¯”å¦‚ï¼Œç”¨æˆ·å¯ä»¥ç”¨å…¬å¸æœåŠ¡å™¨æ¥åŒæ­¥å·¥ä½œæ–‡ä»¶ï¼Œç”¨ä¸ªäººæœåŠ¡å™¨ä¸æœ‹å‹å…±äº«ç§äººæ–‡ä»¶ï¼Œä¸¤è€…äº’ä¸å¹²æ‰°ï¼Œç§å¯†æ€§ä¹Ÿå¯ä¿è¯ã€‚è€Œä¸”ï¼Œç”±äº Seafile æ˜¯å¼€æºçš„é¡¹ç›®ï¼Œå› æ­¤ç›¸å¯¹æ¥è¯´æ•°æ®çš„ç§å¯†æ€§è¿˜æ˜¯æœ‰ä¿éšœçš„ï¼Œèµ·ç ä¸å¿…æ‹…å¿ƒæœ‰ä»€ä¹ˆçœ‹ä¸è§çš„åé—¨ã€‚å…·ä½“ä»‹ç»å¯ä»¥å‚è§seafileå®˜æ–¹æ–‡æ¡£ä»‹ç»ã€‚ ä¸‹é¢æˆ‘ä»¬å°±å¼€å§‹åœ¨å±€åŸŸç½‘å†…æ­å»ºä¸€å°ç§æœ‰çš„äº‘å­˜å‚¨ã€‚ äºŒã€å®‰è£…seafileæœåŠ¡å™¨ 1ã€å®‰è£…å‰å‡†å¤‡ï¼š è¯·ç¡®ä¿æœåŠ¡å™¨ ä¸Šé¢å®‰è£…äº†ä»¥ä¸‹æ¨¡å—(è¿™æ¬¾è½¯ä»¶æ˜¯ç”¨Django+Python2.7æ‰€å¼€å‘çš„ï¼Œæ‰€ä»¥è¦ä¿è¯æœåŠ¡å™¨ä¸Šé¢çš„pythonç‰ˆæœ¬) python 2.7 python-setuptools python-imaging (è¿™ä¸ªæ˜¯pythonçš„ä¸€ä¸ªåº“ï¼Œç½‘ä¸Šä¸å¥½æ‰¾åˆ°ï¼Œä¸‹è½½åœ°å€<a href="http://www.pythonware.com/products/pil/">http://www.pythonware.com/products/pil/</a>) python-mysqldb 2ã€è·å–æœåŠ¡ç«¯è½¯ä»¶åŒ…</p><p>wget <a href="https://bintray.com/artifact/download/seafile-org/seafile/seafile-server/_4.3.2/_x86-64.tar.gz">https://bintray.com/artifact/download/seafile-org/seafile/seafile-server\_4.3.2\_x86-64.tar.gz</a></p><p>3ã€è§£å‹å®‰è£…</p><p>tar -xf seafile-server_4.3.2_x86-64.tar.gz<br>mkdir /home/seafile<br>mv seafile-server-4.3.2 /home/seafile/seafile-server<br>cd /home/seafile/seafile-server</p><p>./setup-seafile-mysql.sh  #è¿è¡Œå®‰è£…è„šæœ¬å¹¶å›ç­”é¢„è®¾é—®é¢˜</p><p>å¦‚æœä½ çš„ç³»ç»Ÿä¸­æ²¡æœ‰å®‰è£…ä¸Šé¢çš„æŸä¸ªè½¯ä»¶ï¼Œé‚£ä¹ˆ Seafileåˆå§‹åŒ–è„šæœ¬ä¼šæé†’ä½ å®‰è£…ç›¸åº”çš„è½¯ä»¶åŒ….</p><p>./setup-seafile-mysql.sh<br>Checking python on this machine â€¦  #-&gt;æ‰§è¡Œè¿™ä¸ªè„šæœ¬ä¹‹åä¼šå»æ£€æŸ¥ä¹‹å‰è¯´çš„é‚£äº›ä¾èµ–åŒ…ï¼Œå¦‚æœå®‰è£…åŒ…ä¸å®Œæ•´å°†ä¼šæç¤ºä½ æŸä¸ªè½¯ä»¶åŒ…æœªå®‰è£…<br>  Checking python module: setuptools â€¦ Done.<br>  Checking python module: python-imaging â€¦ Done.<br>  Checking python module: python-mysqldb â€¦ Done.</p><p>-----------------------------------------------------------------<br>This script will guide you to setup your seafile server using MySQL.<br>Make sure you have read seafile server manual at</p><pre><code>    https://github.com/haiwen/seafile/wiki</code></pre><p>Press ENTER to continue              #-&gt;è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸‹å›è½¦ï¼Œå†ç»§ç»­<br>-----------------------------------------------------------------</p><p>What is the name of the server? It will be displayed on the client.<br>3 - 15 letters or digits<br>[ server name ] seafile-server       #-&gt;è®¾ç½®æˆ‘ä»¬çš„æœåŠ¡å™¨åç§°</p><p>What is the ip or domain of the server?<br>For example: <a href="http://www.mycompany.com/">www.mycompany.com</a>, 192.168.1.101         #-&gt;æœåŠ¡å™¨çš„IP<br>[ This serverâ€™s ip or domain ] 192.168.2.108</p><p>Where do you want to put your seafile data?<br>Please use a volume with enough free space<br>[ default â€œ/home/seafile/seafile-dataâ€ ] /data/seafile   #-&gt;å­˜å‚¨çš„ä½ç½®æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯/data/seafile</p><p>Which port do you want to use for the seafile fileserver?<br>[ default â€œ8082â€ ]     #-&gt;é»˜è®¤çš„å·¥ä½œç«¯å£</p><p>-------------------------------------------------------<br>Please choose a way to initialize seafile databases:<br>-------------------------------------------------------<br>#-&gt;å¦‚æœé€‰æ‹©1, ä½ éœ€è¦æä¾›æ ¹å¯†ç . è„šæœ¬ç¨‹åºä¼šåˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·ã€‚<br>#-&gt;å¦‚æœé€‰æ‹©2, ccnet/seafile/seahub æ•°æ®åº“åº”è¯¥å·²ç»è¢«ä½ ï¼ˆæˆ–è€…å…¶ä»–äººï¼‰æå‰åˆ›å»ºã€‚<br>[1] Create new ccnet/seafile/seahub databases<br>[2] Use existing ccnet/seafile/seahub databases</p><p>[ 1 or 2 ] 1</p><p>What is the host of mysql server?<br>[ default â€œlocalhostâ€ ] </p><p>What is the port of mysql server?<br>[ default â€œ3306â€ ] </p><p>What is the password of the mysql root user?<br>[ root password ]    #-&gt;è¿™é‡Œéœ€è¦mysqlçš„rootæƒé™è¿›è¡Œåˆ›å»ºåº“çš„æ“ä½œ</p><p>verifying password of user root â€¦  done</p><p>Enter the name for mysql user of seafile. It would be created if not exists.<br>[ default â€œrootâ€ ] </p><p>Enter the database name for ccnet-server:<br>[ default â€œccnet-dbâ€ ] </p><p>Enter the database name for seafile-server:<br>[ default â€œseafile-dbâ€ ] </p><p>Enter the database name for seahub:<br>[ default â€œseahub-dbâ€ ] </p><p>#-&gt;ä»¥ä¸Šä¸‰ä¸ªåº“åéƒ½ç”¨é»˜è®¤çš„ </p><p>ä»¥ä¸Šæ­¥éª¤å®Œæˆåå°†ä¼šå‡ºç°ä¸€ä¸‹æç¤ºä¿¡æ¯ï¼Œè¯´æ˜æˆ‘ä»¬å®‰è£…å°±æˆåŠŸå•¦ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/seaf.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/seaf.png" alt="seaf"></a> ä¸‰ã€å¯åŠ¨seafileæœåŠ¡å’Œseahubç½‘ç«™ 1ã€åœ¨/home/seafile/seafile-serverç›®å½•ä¸‹æ‰§è¡Œ</p><p>#-&gt;å¯åŠ¨seafile<br>./seafile.sh start # å¯åŠ¨ Seafile æœåŠ¡</p><p>#-&gt;å¯åŠ¨seahub<br>./seahub.sh start <port>  # å¯åŠ¨ Seahub ç½‘ç«™ ï¼ˆé»˜è®¤è¿è¡Œåœ¨8000ç«¯å£ä¸Šï¼‰</port></p><p>æ³¨æ„ï¼šä½ ç¬¬ä¸€æ¬¡å¯åŠ¨ seahub æ—¶ï¼Œ<code>seahub.sh</code> è„šæœ¬ä¼šæç¤ºä½ åˆ›å»ºä¸€ä¸ª seafile ç®¡ç†å‘˜å¸å·ï¼Œå°±åƒä¸‹é¢è¿™æ · <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/seahub.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/seahub.png" alt="seahub"></a> è¿™ä¸ªç®¡ç†è´¦å·å¿…é¡»æ˜¯ä½ è‡ªå·±å–æ³¨å†Œçš„ä»»æ„é‚®ç®±åœ°å€ï¼Œç™»é™†ç®¡ç†ä½¿ç”¨è¿™ä¸ªåœ°å€ï¼Œæˆ‘è¿™é‡Œç”¨çš„æ˜¯gmail. æœåŠ¡å¯åŠ¨å, æ‰“å¼€æµè§ˆå™¨å¹¶è¾“å…¥è¿™ä¸ªåœ°å€ <a href="http://192.168.2.108:8000/">http://192.168.2.108:8000</a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/web.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/web.png" alt="web"></a> è¾“å…¥è´¦å·å¯†ç å°±ä¼šè¢«é‡å®šå‘åˆ°ç™»é™†é¡µé¢. è¾“å…¥ä½ åœ¨å®‰è£… Seafile æ—¶æä¾›çš„ç”¨æˆ·åå’Œå¯†ç åï¼Œä½ ä¼šè¿›å…¥ Myhome é¡µé¢ï¼Œæ–°å»ºèµ„æ–™åº“. <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/seafile.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/seafile.png" alt="seafile"></a> &nbsp; è‡³æ­¤ï¼Œseafileç§æœ‰ä¸å­˜å‚¨å…±äº«å¹³å°å·²ç»éƒ¨ç½²å®Œæ¯•äº†ã€‚ ä¸‹é¢æˆ‘ä»¬å¯ä»¥å»ä¸‹è½½ä¸€ä¸ªå®¢æˆ·ç«¯å®‰è£…ä¸Š æˆ‘è¿™é‡Œä½¿ç”¨çš„Ubuntuä¸‹çš„å®¢æˆ·ç«¯ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/account.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/account.png" alt="account"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-220859.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-220859.png" alt="Screenshot from 2015-09-08 22:08:59"></a> &nbsp; å› ä¸ºä¹‹å‰å°±æŠŠæˆ‘çš„åº“ä¸‹è½½åˆ°äº†æœ¬åœ°ï¼Œä½ å¯ä»¥åœ¨æœ¬åœ°åº“æ·»åŠ æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»åŒæ­¥å°±ä¼šåŒæ­¥åˆ°æœåŠ¡å™¨ç«¯å•¦ï¼Œå°±åƒè¿™æ ·(å¦‚æœä½ ä¸ä½¿ç”¨å®¢æˆ·ç«¯çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ç½‘é¡µç‰ˆ) <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-221208.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-221208.png" alt="Screenshot from 2015-09-08 22:12:08"></a> å½“ç„¶ä»–çš„å®¢æˆ·ç«¯ä¸åªæ˜¯åœ¨linux(ubuntu) ä¸Šé¢æ‰æœ‰å“¦ï¼Œ å®¢æˆ·ç«¯åœ¨ï¼š ç§»åŠ¨ç«¯æœ‰ï¼šAndroidï¼ŒIos æ¡Œé¢ç«¯æœ‰ï¼šwindowsã€Linuxã€Mac æœåŠ¡ç«¯åœ¨ï¼š Windowsã€Linuxã€æ ‘è“æ´¾ ä»»ä½•å¹³å°çš„æµè§ˆå™¨ã€‚ ä¸‹é¢æ˜¯æˆ‘æ‰‹æœºç«¯çš„æˆªå›¾ï¼ŒæœåŠ¡å™¨è·Ÿæ‰‹æœºçš„wifiæ˜¯åœ¨ä¸€ä¸ªå±€åŸŸç½‘å†…çš„ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/1.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/1-281x500.png" alt="1"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/2.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/2-281x500.png" alt="2"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/3.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/3-281x500.png" alt="3"></a> &nbsp; æ—¢ç„¶è¯´äº†æ˜¯å›¢é˜Ÿã€ä¼ä¸šæˆ–è€…ä¸ªäººä½¿ç”¨ï¼Œé‚£æ¯ä¸ªäººéƒ½è¦æœ‰ä¸ªè´¦å·ï¼Œé‚£æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªè´¦å·æ‰è¡Œï¼Œå› ä¸ºæˆ‘ä½¿ç”¨çš„seafile serveræ˜¯ç¤¾åŒºç‰ˆï¼Œæœ‰è®¸å¤šçš„åŠŸèƒ½éƒ½ä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯æˆ‘è§‰å¾—ä½œä¸ºä¸€ä¸ªå°å›¢é˜Ÿï¼Œæˆ–è€…ä¸ªäººä½¿ç”¨å†é€‚åˆä¸è¿‡äº†ã€‚ ä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè´¦å·ï¼Œåœ¨winä¸Šé¢ç™»é™†ï¼Œå¿…é¡»è¦è®©ä½ éƒ½æœåŠ¡å™¨è¿æ¥ç½‘ç»œï¼Œå¹¶ä¸”æ³¨å†Œä½¿ç”¨seafileçš„ç”¨æˆ·å¿…é¡»ä½¿ç”¨emailåœ°å€ä½œä¸ºç™»é™†è´¦å·ï¼Œè¿™ä¸ªè´¦å·å¿…é¡»æ˜¯å­˜åœ¨å¯ç™»å½•çš„email <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-224030.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-224030.png" alt="Screenshot from 2015-09-08 22:40:30"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-224241.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-224241.png" alt="Screenshot from 2015-09-08 22:42:41"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-224530.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-224530.png" alt="Screenshot from 2015-09-08 22:45:30"></a> æˆ‘ä»¬åªéœ€è¦å°†è¿™ä¸ªèµ„æ–™åº“ä¸‹è½½åˆ°æœ¬åœ°å°±å¯äº†ï¼Œæ·»åŠ æ–‡ä»¶ï¼Œç„¶åå³å‡»â€œæˆ‘çš„èµ„æ–™åº“â€å°±å¯ä»¥çœ‹åˆ°åŒæ­¥åˆ°æœåŠ¡å™¨äº†ã€‚ ç„¶åæˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°èµ„æ–™åº“ä¸­æŒ‡å®šæŸä¸ªæ–‡ä»¶ç”Ÿæˆä¸€ä¸ªä¸‹è½½é“¾æ¥ï¼Œå¯ä»¥åˆ†äº«ç»™æˆ‘çš„å°ä¼™ä¼´ä¸‹è½½ã€‚ æˆ‘çœ‹äº†ä¸€ä¸‹æœåŠ¡å™¨ä¸Šé¢çš„æ•°æ®å­˜å‚¨ç›®å½•ï¼Œæ•°æ®ä¼ å…¥åˆ°æœåŠ¡å™¨ç«¯å°±ç±»ä¼¼äºMap Reduceè¿™ç§è½¯ä»¶æ¶æ„å°†æ•°æ®åˆ‡æˆäº†å¾ˆå¤šå¾ˆå¤šä»½ï¼Œç„¶ååˆ›å»ºç´¢å¼•ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè·å–æ•°æ®æ—¶æ‹¿åˆ°ç´¢å¼•ï¼Œæœ€åæ ¹æ®ç´¢å¼•é‡ç»„æ•°æ®ï¼Œå†è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ã€‚ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-230020.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/Screenshot-from-2015-09-08-230020.png" alt="Screenshot from 2015-09-08 23:00:20"></a> ä¸Šå›¾ä¸­0211e*********è¿™ä¸ªç›®å½•æ˜¯ç”¨æˆ·seafileshareçš„èµ„æ–™åº“ï¼Œæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨æ˜¯å®ƒå°±å°†ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶æ‹†æ•£äº†ï¼Œåœ¨æœåŠ¡ç«¯æˆ‘ä»¬æ‰¾ä¸åˆ°ä¸€ä¸ªå®Œæ•´çš„è½¯ä»¶åŒ…ã€‚è¿™ç§å­˜å‚¨æ–¹å¼è·Ÿmogilefsæœ‰äº›ç±»ä¼¼ã€‚ æ„Ÿè§‰ç¤¾åŒºç‰ˆè¿˜æ˜¯æœ‰äº›å±€é™æ€§ï¼Œä½†æ˜¯å¯¹äºä¸ªäººï¼Œä¸€ä¸ªå›¢é˜Ÿæˆ‘ä¸ªäººè§‰å¾—å®Œå…¨è¶³å¤Ÿå•¦ã€‚ å¥½äº†å¦‚æœéœ€è¦äº†è§£æ›´å¤šï¼Œå¯ä»¥åˆ°å®˜ç½‘äº†è§£ä½¿ç”¨ï¼š<a href="https://www.seafile.com/en/home/">http://www.seafile.com</a></p>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ SaltStackå°è®°â€”ç¬¬ä¸‰ç« ã€ŠPillarä½¿ç”¨æ–¹æ³•ã€‹</title>
      <link href="/2015/08/18/saltstack-pillar-de-shi-xian-fang-shi/"/>
      <url>/2015/08/18/saltstack-pillar-de-shi-xian-fang-shi/</url>
      
        <content type="html"><![CDATA[<h4 id="1-è¦å¯ç”¨pillarï¼Œé¦–å…ˆè¦ä¿®æ”¹masterä¸­çš„é…ç½®"><a href="#1-è¦å¯ç”¨pillarï¼Œé¦–å…ˆè¦ä¿®æ”¹masterä¸­çš„é…ç½®" class="headerlink" title="1.è¦å¯ç”¨pillarï¼Œé¦–å…ˆè¦ä¿®æ”¹masterä¸­çš„é…ç½®"></a>1.è¦å¯ç”¨pillarï¼Œé¦–å…ˆè¦ä¿®æ”¹masterä¸­çš„é…ç½®</h4><pre><code>[root@salt-master pillar]# vim /etc/salt/masterpillar_roots: &nbsp;baseï¼š &nbsp; &nbsp;- /salt/pillar</code></pre><h4 id="2-é‡å¯master"><a href="#2-é‡å¯master" class="headerlink" title="2.é‡å¯master"></a>2.é‡å¯master</h4><pre><code>[root@salt-master pillar]# systemctl restar salt-master</code></pre><h4 id="3-æ˜¯å­˜æ”¾åœ¨masterç«¯ï¼Œé»˜è®¤ä½ç½®-srv-pillarï¼Œéœ€è¦æ–°å»ºç›®å½•ã€‚å’Œsalt-slsç±»ä¼¼ï¼Œä¹Ÿæ˜¯éœ€è¦top-sls"><a href="#3-æ˜¯å­˜æ”¾åœ¨masterç«¯ï¼Œé»˜è®¤ä½ç½®-srv-pillarï¼Œéœ€è¦æ–°å»ºç›®å½•ã€‚å’Œsalt-slsç±»ä¼¼ï¼Œä¹Ÿæ˜¯éœ€è¦top-sls" class="headerlink" title="3.æ˜¯å­˜æ”¾åœ¨masterç«¯ï¼Œé»˜è®¤ä½ç½®/srv/pillarï¼Œéœ€è¦æ–°å»ºç›®å½•ã€‚å’Œsalt slsç±»ä¼¼ï¼Œä¹Ÿæ˜¯éœ€è¦top.sls"></a>3.æ˜¯å­˜æ”¾åœ¨masterç«¯ï¼Œé»˜è®¤ä½ç½®/srv/pillarï¼Œéœ€è¦æ–°å»ºç›®å½•ã€‚å’Œsalt slsç±»ä¼¼ï¼Œä¹Ÿæ˜¯éœ€è¦top.sls</h4><pre><code>mkdir /srv/pillar</code></pre><h4 id="4-åœ¨-srv-pillarç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªtop-slsæ–‡ä»¶"><a href="#4-åœ¨-srv-pillarç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªtop-slsæ–‡ä»¶" class="headerlink" title="4.åœ¨/srv/pillarç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªtop.slsæ–‡ä»¶"></a>4.åœ¨/srv/pillarç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªtop.slsæ–‡ä»¶</h4><pre><code>[root@salt-master pillar]# vim top.sls #å†…å®¹å¦‚ä¸‹ï¼šbase: &nbsp;'node2.example.com': &nbsp;#æŒ‡å®šçš„ä¸»æœº &nbsp; &nbsp;- sc #è°ƒç”¨scæ¨¡ç‰ˆä¸­çš„å€¼ </code></pre><h4 id="5-åœ¨-srv-pillarä¸­åˆ›å»ºä¸€ä¸ªsc-slsæ–‡ä»¶"><a href="#5-åœ¨-srv-pillarä¸­åˆ›å»ºä¸€ä¸ªsc-slsæ–‡ä»¶" class="headerlink" title="5.åœ¨/srv/pillarä¸­åˆ›å»ºä¸€ä¸ªsc.slsæ–‡ä»¶"></a>5.åœ¨/srv/pillarä¸­åˆ›å»ºä¸€ä¸ªsc.slsæ–‡ä»¶</h4><pre><code>[root@salt-master pillar]# vim sc.sls #å†…å®¹ä¸ºé”®å€¼å¯¹,k, væ ¼å¼çš„name: guomaoqiuage: 22language: chineses</code></pre><p>å¥½å•¦ï¼Œæ­¤æ—¶pillarå®šä¹‰å¥½äº†</p><h4 id="6-æ‰§è¡Œsaltutil-sync-grains-åˆ·æ–°pillarçš„å€¼"><a href="#6-æ‰§è¡Œsaltutil-sync-grains-åˆ·æ–°pillarçš„å€¼" class="headerlink" title="6.æ‰§è¡Œsaltutil.sync_grains #åˆ·æ–°pillarçš„å€¼"></a>6.æ‰§è¡Œsaltutil.sync_grains #åˆ·æ–°pillarçš„å€¼</h4><pre><code>[root@salt-master pillar]# salt 'node2.exmaple.com' saltutil.refresh_pillar#çœ‹ä¸‹ç»“æœï¼š[root@salt-master pillar]# salt "node2.example.com" pillar.datanode2.example.com: &nbsp; &nbsp;---------- &nbsp; &nbsp;age: &nbsp; &nbsp; &nbsp; &nbsp;22 &nbsp; &nbsp;language: &nbsp; &nbsp; &nbsp; &nbsp;chineses &nbsp; &nbsp;name: &nbsp; &nbsp; &nbsp; &nbsp;guomaoqiu</code></pre><h4 id="7-ç”±ä¸Šå¯è§åœ¨node2è¿™å°ä¸»æœºä¸Šå·²ç»æœ‰pillarå€¼å•¦ï¼Œåªæ˜¯è¿™ä¸ªå€¼æ˜¯ä¿å­˜åœ¨masterç«¯çš„ï¼›é‚£é—®é¢˜æ¥äº†-å¦‚ä½•ä½¿ç”¨jinjaæ¨¡æ¿æ¥è°ƒç”¨grainsæˆ–è€…æ˜¯pillarçš„å€¼å‘¢ï¼Ÿçœ‹ä¸‹é¢ï¼š"><a href="#7-ç”±ä¸Šå¯è§åœ¨node2è¿™å°ä¸»æœºä¸Šå·²ç»æœ‰pillarå€¼å•¦ï¼Œåªæ˜¯è¿™ä¸ªå€¼æ˜¯ä¿å­˜åœ¨masterç«¯çš„ï¼›é‚£é—®é¢˜æ¥äº†-å¦‚ä½•ä½¿ç”¨jinjaæ¨¡æ¿æ¥è°ƒç”¨grainsæˆ–è€…æ˜¯pillarçš„å€¼å‘¢ï¼Ÿçœ‹ä¸‹é¢ï¼š" class="headerlink" title="7.ç”±ä¸Šå¯è§åœ¨node2è¿™å°ä¸»æœºä¸Šå·²ç»æœ‰pillarå€¼å•¦ï¼Œåªæ˜¯è¿™ä¸ªå€¼æ˜¯ä¿å­˜åœ¨masterç«¯çš„ï¼›é‚£é—®é¢˜æ¥äº†,å¦‚ä½•ä½¿ç”¨jinjaæ¨¡æ¿æ¥è°ƒç”¨grainsæˆ–è€…æ˜¯pillarçš„å€¼å‘¢ï¼Ÿçœ‹ä¸‹é¢ï¼š"></a>7.ç”±ä¸Šå¯è§åœ¨node2è¿™å°ä¸»æœºä¸Šå·²ç»æœ‰pillarå€¼å•¦ï¼Œåªæ˜¯è¿™ä¸ªå€¼æ˜¯ä¿å­˜åœ¨masterç«¯çš„ï¼›é‚£é—®é¢˜æ¥äº†,å¦‚ä½•ä½¿ç”¨jinjaæ¨¡æ¿æ¥è°ƒç”¨grainsæˆ–è€…æ˜¯pillarçš„å€¼å‘¢ï¼Ÿçœ‹ä¸‹é¢ï¼š</h4><pre><code>[root@salt-master salt]# pwd/srv/salt[root@salt-master salt]# cat top.sls base: &nbsp;'node2.example.com': &nbsp; &nbsp;- test.test[root@salt-master salt]# cat test/test.sls /tmp/test1.conf: &nbsp;file.managed: &nbsp; &nbsp;- source: salt://test/test1.conf.jinja &nbsp; &nbsp;- template: jinja &nbsp;#è°ƒç”¨jinjaæ¨¡æ¿</code></pre><p>çœ‹ä¸€ä¸‹æ¨¡æ¿æ–‡ä»¶ï¼štest1.conf.jinja <img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/05/14621012702761.jpg">ï¿¼ è¯¥æ¨¡æ¿æ–‡ä»¶éƒ½è°ƒç”¨äº†grainsåŠpillarçš„å€¼</p><h4 id="8-æ¨åˆ°node2ä¸Šé¢å»ï¼š"><a href="#8-æ¨åˆ°node2ä¸Šé¢å»ï¼š" class="headerlink" title="8.æ¨åˆ°node2ä¸Šé¢å»ï¼š"></a>8.æ¨åˆ°node2ä¸Šé¢å»ï¼š</h4><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/05/14620997738947.jpg">ï¿¼</p><h4 id="9-åœ¨minionç«¯æŸ¥çœ‹"><a href="#9-åœ¨minionç«¯æŸ¥çœ‹" class="headerlink" title="9.åœ¨minionç«¯æŸ¥çœ‹"></a>9.åœ¨minionç«¯æŸ¥çœ‹</h4><p><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2016/05/14620997971326.jpg">ï¿¼ çœ‹åˆ°äº†çº¢è‰²æ¡†ä½çš„å°±æ˜¯é€šè¿‡è°ƒç”¨grains,pillarå€¼ç”Ÿæˆçš„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ SaltStackå°è®°â€”ç¬¬äºŒç« ã€Šç¼–å†™é…ç½®åŠåº”ç”¨ã€‹</title>
      <link href="/2015/08/13/e5-ad-a6-e4-b9-a0saltstack-e5-b0-8f-e8-ae-b0-e7-ac-ac-e4-ba-8c-e7-ab-a0-e3-80-8a-e7-bc-96-e5-86-99-e9-85-8d-e7-bd-ae-e5-8f-8a-e5-ba-94-e7-94-a8-e3-80-8b/"/>
      <url>/2015/08/13/e5-ad-a6-e4-b9-a0saltstack-e5-b0-8f-e8-ae-b0-e7-ac-ac-e4-ba-8c-e7-ab-a0-e3-80-8a-e7-bc-96-e5-86-99-e9-85-8d-e7-bd-ae-e5-8f-8a-e5-ba-94-e7-94-a8-e3-80-8b/</url>
      
        <content type="html"><![CDATA[<p>ä¸Šæ¬¡è®°å½•äº†ä¸€ä¸‹saltçš„å®‰è£…å’Œé…ç½®ï¼Œä¸‹é¢è®°å½•ä¸€ä¸‹å¦‚ä½•å»ç¼–å†™ä¸€ä¸ªé…ç½®å¹¶ä¸”åº”ç”¨åˆ°minion. SaltStacké»˜è®¤çš„é…ç½®æ–‡ä»¶è·¯å¾„åœ¨/srv/slatä¸‹ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªç›®å½•å°±æ–°å»ºä¸ªã€‚å¦‚æœä¸ç¡®å®šå¯ä»¥æ‰“å¼€Masterçš„ä¸»é…ç½®æ–‡ä»¶çœ‹ä¸‹ã€‚ åœ¨masterä¸»é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‰“å¼€ä¸€ä¸‹ä¸‰è¡Œçš„æ³¨é‡Šï¼Œè¿™å°±æ˜¯saltçš„é»˜è®¤é…ç½®è·¯å¾„ã€‚ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/1.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/1.png" alt="1"></a> è¿™é‡Œé»˜è®¤é…ç½®æ–‡ä»¶æ˜¯æ³¨é‡Šäº†çš„ï¼Œå¦‚æœéœ€è¦ç›´æ¥å–æ¶ˆæ³¨é‡Šå°±è¡Œäº†ã€‚ åˆ‡è®°ï¼Œæ¯æ¬¡ä¿®æ”¹äº†é…ç½®æ–‡ä»¶éƒ½è¦é‡å¯æœåŠ¡ ä¸‹é¢ä»¥ä¸¤ä¸ªéœ€æ±‚ä¸ºä¾‹å­è¿›è¡Œå­¦ä¹ : a.åœ¨minionä¸Šé¢å®‰è£…httpdæœåŠ¡ï¼Œå¹¶ä¸”å¯åŠ¨ä¹‹ b.è‡ªå»ºindex.htmlæ–‡ä»¶ï¼Œåœ¨masterç«¯åº”ç”¨é…ç½®å®Œæˆåç›´æ¥è®¿é—®minionçš„httpæœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤ºæˆ‘è‡ªå®šçš„index.htmlæ–‡ä»¶å†…å®¹ é¢ï¼Œåˆšå¼€å§‹å­¦ä¹ è¿™ä¸ªçš„æ—¶å€™é…ç½®æ–‡ä»¶ç¼–å†™å¾ˆæ˜¯ä¸€ä»¶å¤´ç–¼çš„äº‹æƒ…ï¼› <strong>ä¸€ã€é…ç½®æ–‡ä»¶è¯´æ˜</strong> 1.å¼•å¯¼é…ç½®æ–‡ä»¶ top.sls saltstackçš„ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶é»˜è®¤ä¸ºtop.slsï¼Œæ˜¯ä½äº/srv/salt/ç›®å½•ä¸‹çš„ï¼Œå½“ç„¶è¿™ä¸æ˜¯ç»å¯¹çš„ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶çš„å“¦ã€‚è¿™ä¸ªæ–‡ä»¶æ˜¯å¿…é¡»è¦æœ‰çš„ã€‚ ä¾‹å¦‚ï¼š</p><p>[root@saltstack-node1 salt]# more top.sls<br>base:                       ###å¯ä»¥ç†è§£ä¸ºä»“åº“<br>  â€˜node0.example.comâ€™:      ###å¯¹è±¡åï¼Œå°±æ˜¯é’ˆå¯¹é‚£äº›minionï¼Œè¿™é‡Œå¯ä»¥æ”¯æŒç»„ä»€ä¹ˆçš„ï¼Œå°±æ˜¯å„ç§åŒ¹é…å§<br>    - apache                ###èµ„æºå(è‡ªå®šä¹‰)</p><p>è¯´æ˜ï¼šèµ„æºåéœ€è¦åœ¨/srv/saltç›®å½•æ–°å»ºæ–‡ä»¶ä¸ºapache.slsï¼Œæ³¨æ„ï¼šæ‰€æœ‰ç”Ÿæ•ˆçš„é…ç½®æ–‡ä»¶éƒ½æ˜¯ä»¥slsç»“å°¾çš„ã€‚ 2.èµ„æºé…ç½®æ–‡ä»¶ /srv/salt/apache.sls è¿™ä¸ªå°±æ˜¯ä¸Šé¢topä¸­æŒ‡å®šçš„èµ„æºå</p><p>[root@saltstack-node1 salt]# cat apache.sls<br>apache-service:            ###ID,è‡ªå®šä¹‰<br>  pkg.installed:           ###ä½¿ç”¨åŒ…ç®¡ç†çš„insalledæ–¹æ³•<br>   - names:                ###åç§°<br>     - httpd               ###è½¯ä»¶åŒ…å<br>     - httpd-devel<br>  service.running:         ###æ¨¡å—åç§°ï¼Œå®‰è£…å¥½ä¹‹åè¦å¯åŠ¨å®ƒ<br>   - name: httpd           ###å¯åŠ¨ä»€ä¹ˆ<br>   - enable: True          ###å¼€æœºè‡ªå¯åŠ¨<br>   - reload: True          ###ç›‘è§†è¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæœ‰å˜åŠ¨ï¼Œæˆ‘ä»¬è¦é‡è½½æœåŠ¡<br>   - watch:<br>      - file: /var/www/html/index.html  ###æ–‡ä»¶è·¯å¾„<br>   - require:              ###åº”ç”¨å‰æï¼Œhttpdè¿™ä¸ªè½¯ä»¶åŒ…å®‰è£…å¥½ä¹‹åï¼Œæ‰æ‰§è¡Œserviceè¿™ä¸ªæ¨¡å—<br>      - pkg: httpd<br>  file.managed:            ###æ¨¡å—åç§°ï¼Œä½¿ç”¨fileæ¨¡å—çš„managedè¿™ä¸ªæ–¹æ³•ï¼Œç›®çš„ï¼Œæ–‡ä»¶ç®¡ç†<br>    - name: /var/www/html/index.html  ###minionç«¯çš„æ–‡ä»¶å…·ä½“è·¯å¾„<br>    - source: salt://index.html       ###æºæ–‡ä»¶<br>    - user: apache                    ###è¿™ä¸ªæ–‡ä»¶çš„ä¸€äº›å±æ€§<br>    - group: root<br>    - mode: 644<br>    - backup: minion                  ###æ”¹å˜ä¹‹å‰å¤‡ä»½<br>    - require:                        ###åŒä¸Šï¼Œæ‰§è¡Œå®Œä¸Šé¢çš„ï¼Œåœ¨æ‰§è¡Œè¿™ä¸ª<br>       - pkg: httpd</p><p>è¯´æ˜ï¼šæºæ–‡ä»¶çš„ä½ç½®å°±æ˜¯åœ¨/srv/saltç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶index.htmlã€‚ æˆ‘è¿™é‡Œå†…å®¹è‡ªå®šä¹‰ï¼š echo â€œ</p><h1>SaltStack</h1>â€œ &gt; index.html é…ç½®ç¼–å†™å®Œæ¯•æœ€åçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/2.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/2.png" alt="2"></a> <strong>äºŒã€åº”ç”¨äºå®¢æˆ·ç«¯</strong> ç»è¿‡ä¸Šé¢Masterç«¯ç¼–å†™é…ç½®æ–‡ä»¶åï¼Œæ­¤æ—¶å·²ç»ç”Ÿæ•ˆã€‚Minionsåªè¦åŒæ­¥èµ„æºå³å¯å®ç°ä¸Šé¢çš„ä¸¤ä¸ªéœ€æ±‚ã€‚é‚£ä¹ˆå°±æ˜¯å¦‚ä½•æ¥åŒæ­¥ï¼Ÿ è¿™é‡Œæœ‰ä¸¤ç§æ–¹å¼ï¼š ç¬¬ä¸€ç§æ‰‹åŠ¨åœ¨Masterä¸Šæ‰§è¡Œæ¨é€å‘½ä»¤ï¼Œç¬¬äºŒç§æ˜¯åœ¨Minionè®¾ç½®æ—¶é—´é—´éš”è‡ªåŠ¨æƒ³Masterç«¯åŒæ­¥æœ€æ–°çš„èµ„æºã€‚ 1ã€Masteræ‰‹åŠ¨åŒæ­¥ åœ¨Masterä¸Šæ‰§è¡Œ# salt â€˜*â€™ state.highstate ###æ„æ€æ˜¯å‘æ‰€æœ‰Minionsæ¨é€æœ€æ–°èµ„æº 2ã€Minionè‡ªåŠ¨åŒæ­¥ åœ¨/etc/salt/minioné…ç½®æ–‡ä»¶ä¸­å¢åŠ <p></p><p>schedule:<br>highstate:<br>function: state.highstate<br>seconds: 30    ###æ„æ€æ˜¯æ¯30ç§’å‘MasteråŒæ­¥ä¸€æ¬¡æœ€æ–°èµ„æºï¼Œä¹Ÿå¯è®¾ç½®åˆ†-mintusã€å°æ—¶-hours</p><p>ä¸‹é¢æ˜¯åœ¨masterç«¯æ‰§è¡Œçš„ç»“æœï¼š å½“ç„¶åœ¨æ¨é€èµ„æºæ—¶æˆ‘ä»¬å¯ä»¥å…ˆæµ‹è¯•ä¸€ä¸‹ï¼Œå‘½ä»¤ï¼š salt â€˜node0.example.comâ€™ state.highstate test=True <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/3.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/3.png" alt="3"></a> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/4.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/4.png" alt="4"></a> ä¸Šé¢çš„æ¨é€å·²ç»å®Œæˆï¼Œä¸‹é¢éªŒè¯ç»“æœï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/6.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/6.png" alt="6"></a> è‡³æ­¤ä¸Šé¢ä¸¤ä¸ªéœ€æ±‚å·²ç»å®ç°äº†ã€‚è¿™ä¹Ÿæ˜¯saltæœ€åŸºæœ¬çš„ç”¨æ³•åŠåŠŸèƒ½å•¦ã€‚åé¢ç»§ç»­å­¦ä¹ ã€‚ çœ‹æ¥æä¸ªlampæˆ–è€…lnmpå¹³å°ä¹Ÿå¯ä»¥è½»è€Œæ˜“ä¸¾çš„å®ç°äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ SaltStackå°è®°---ç¬¬ä¸€ç« ã€Šå®‰è£…åŠç®€å•æµ‹è¯•ã€‹</title>
      <link href="/2015/08/12/e5-ad-a6-e4-b9-a0saltstack-e5-b0-8f-e8-ae-b0-e7-ac-ac-e4-b8-80-e7-ab-a0-e3-80-8a-e5-ae-89-e8-a3-85-e5-8f-8a-e7-ae-80-e5-8d-95-e6-b5-8b-e8-af-95-e3-80-8b/"/>
      <url>/2015/08/12/e5-ad-a6-e4-b9-a0saltstack-e5-b0-8f-e8-ae-b0-e7-ac-ac-e4-b8-80-e7-ab-a0-e3-80-8a-e5-ae-89-e8-a3-85-e5-8f-8a-e7-ae-80-e5-8d-95-e6-b5-8b-e8-af-95-e3-80-8b/</url>
      
        <content type="html"><![CDATA[<p><strong>ä¸€ã€ä»€ä¹ˆæ˜¯saltstack</strong> Saltï¼Œ,ä¸€ç§å…¨æ–°çš„åŸºç¡€è®¾æ–½ç®¡ç†æ–¹å¼ï¼Œéƒ¨ç½²è½»æ¾ï¼Œåœ¨å‡ åˆ†é’Ÿå†…å¯è¿è¡Œèµ·æ¥ï¼Œæ‰©å±•æ€§å¥½ï¼Œå¾ˆå®¹æ˜“ç®¡ç†ä¸Šä¸‡å°æœåŠ¡å™¨ï¼Œé€Ÿåº¦å¤Ÿå¿«ï¼ŒæœåŠ¡å™¨ä¹‹é—´ç§’çº§é€šè®¯ã€‚saltåº•å±‚é‡‡ç”¨åŠ¨æ€çš„è¿æ¥æ€»çº¿, ä½¿å…¶å¯ä»¥ç”¨äºç¼–é…, è¿œç¨‹æ‰§è¡Œ, é…ç½®ç®¡ç†ç­‰ç­‰. SaltStack æ˜¯ç»§ Puppetã€Chef ä¹‹åæ–°å‡ºç°çš„é…ç½®ç®¡ç†åŠè¿œç¨‹æ‰§è¡Œå·¥å…·ï¼Œ ç›®å‰ï¼ŒSaltStack æ­£å¾—åˆ°è¶Šæ¥è¶Šå¤šçš„ç©ç›®ã€‚ä¸ Puppet ç›¸æ¯”ï¼ŒSaltStack æ²¡æœ‰é‚£ä¹ˆç¬¨é‡ï¼Œæ„Ÿè§‰è¾ƒä¸ºè½»é‡ï¼›ä¸åƒ Puppet æœ‰ ä¸€å¥—è‡ªå·±çš„ DSL ç”¨æ¥å†™é…ç½®ï¼ŒSaltStack ä½¿ç”¨ YAML ä½œä¸ºé…ç½®æ–‡ä»¶æ ¼å¼ï¼Œå†™ èµ·æ¥æ—¢ç®€å•åˆå®¹æ˜“ï¼ŒåŒæ—¶ä¹Ÿä¾¿äºåŠ¨æ€ç”Ÿæˆï¼›æ­¤å¤–ï¼ŒSaltStack åœ¨è¿œç¨‹æ‰§è¡Œå‘½ä»¤ æ—¶çš„é€Ÿåº¦éå¸¸å¿«ï¼Œä¹ŸåŒ…å«ä¸°å¯Œçš„æ¨¡å—ã€‚ å®˜æ–¹ç«™ç‚¹ï¼š<a href="http://www.saltstack.com/">http://www.saltstack.com/</a> å®˜æ–¹æ–‡æ¡£ï¼š<a href="http://docs.saltstack.com/">http://docs.saltstack.com/</a> ä¸­æ–‡ç«™ç‚¹ï¼š<a href="http://www.saltstack.cn/">http://www.saltstack.cn/</a> ä¸­æ–‡æ‰‹å†Œï¼š<a href="http://docs.saltstack.cn/">http://docs.saltstack.cn/</a> ä¸­æ–‡wikiï¼š<a href="http://wiki.saltstack.cn/doc">http://wiki.saltstack.cn/doc</a> &nbsp; <strong>äºŒã€å®‰è£…</strong> è¿™é‡Œé‡‡ç”¨çš„æ˜¯ä»EPELæºç›´æ¥yumå®‰è£…ï¼Œå½“ç„¶æˆ‘ä»¬è¦æ›´æ–°epelæºï¼š</p><p># rpm -Uvh <a href="http://dl.fedoraproject.org/pub/epel/5/x86_64/epel-release-5-4.noarch.rpm">http://dl.fedoraproject.org/pub/epel/5/x86_64/epel-release-5-4.noarch.rpm</a> SaltStack-Masterï¼ˆä¸»æœåŠ¡å™¨ï¼‰ # yum -y install salt-master SaltStack-Minionï¼ˆä»æœåŠ¡å™¨ï¼‰ # yum -y install salt-minion</p><p>&nbsp; <strong>ä¸‰ã€ç®€å•é…ç½®åŠä½¿ç”¨</strong> 1ã€åŸºæœ¬ä¿¡æ¯ï¼š</p><p>Masterç«¯ï¼š192.168.1.21  saltstack-node1.example.com<br>Minionç«¯ï¼š192.168.1.22  saltstack-node2.example.com</p><p>2ã€å¯åŠ¨å‘½ä»¤ï¼š</p><p>Masterç«¯ï¼š/etc/init.d/salt-master {start|stop|status|restart|condrestart|reload}<br>Minionç«¯ï¼š/etc/init.d/salt-minion {start|stop|status|restart|condrestart|reload}</p><p>3.ä¸»é…ç½®æ–‡ä»¶ï¼š</p><p>Masterç«¯ï¼š/etc/salt/master<br>Minionç«¯ï¼š/etc/salt/master</p><p>4.é…ç½®Masterç«¯ ä¿®æ”¹ç›‘å¬åœ°å€é»˜è®¤ä¸ºç›‘å¬æ‰€æœ‰</p><p>sed -ie â€˜s/^#.*interface:.*/\  interface: 192.168.1.111/gâ€™ /etc/salt/master<br>###æ³¨ï¼šå¦‚æœä½¿ç”¨ä¸»æœºåï¼Œè¯·ç»‘å®šhosts</p><p>5.é…ç½®minionç«¯ å®¢æˆ·ç«¯minionçš„é…ç½®ï¼Œvim /etc/salt/minion,æ·»åŠ master IPåœ°å€å’Œminion IDå·ï¼ŒIDå»ºè®®ç”¨ä¸»æœºåæ¥é…ç½®,ç„¶åå¼€å¯æ—¥å¿—åŠŸèƒ½ï¼Œä¸ºäº†ä¸é‡å¤æ“ä½œæˆ‘ä¸‹é¢å†™äº†ä¸€ä¸ªè„šæœ¬ï¼Œå½“æˆ‘ä»¬é…ç½®minionæ—¶èƒ½å¿«é€Ÿæå®šï¼š</p><p>#/bin/bash<br>#desc : salt client setttings<br>read -p â€œInput Mster IP: â€œ MIP    ###æŒ‡å®šmasterIP<br>COMM1=â€sed -i \â€œs/#master: salt/master: $MIP/\â€œ /etc/salt/minionâ€<br>eval $COMM1</p><h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>echo â€˜ â€˜<br>read -p â€œInput Minion ID: â€œ MID  ###ä¿®æ”¹minion ID<br>COMM2=â€sed -i \â€œs/#id:.*/id: $MID/\â€œ /etc/salt/minionâ€<br>eval $COMM2<br>###  å¼€å¯æ—¥å¿—<br>sed -i â€œs@#log_file: /var/log/salt/minion@log_file: /var/log/salt/minion@1â€ /etc/salt/minion<br>sed -i â€˜488dâ€™ /etc/salt/minion</p><h1 id="-1"><a href="#-1" class="headerlink" title=""></a></h1><p>sed -i â€œs@#key_logfile: /var/log/salt/key@key_logfile: /var/log/salt/key@â€ /etc/salt/minion</p><h1 id="-2"><a href="#-2" class="headerlink" title=""></a></h1><p>echo â€˜ â€˜<br>echo -e â€œ\033[42;37m Salt-minion Information: \033[0mâ€<br>echo â€˜##############################â€™<br>sed -e â€˜/^#/d;/^$/dâ€™ /etc/salt/minion<br>echo â€˜##############################â€™<br>echo â€˜ â€˜<br>###å¯åŠ¨æœåŠ¡<br>/etc/init.d/salt-minion start<br>###åªè¦æœ‰æ–°çš„minionå®¢æˆ·ç«¯æ·»åŠ è¿›æ¥æˆ‘ä»¬è¿è¡Œè¿™ä¸ªè„šæœ¬å°±å¯å¿«é€Ÿå®Œæˆminionç«¯çš„é…ç½®å•¦.</p><p>6.ä¿®æ”¹å®Œæ¯•æˆ‘ä»¬å°±å¯ä»¥é‡å¯æœåŠ¡å•¦. &nbsp; <strong>å››ã€å¼€å§‹å’ŒMasterç«¯é€šä¿¡</strong> 1.Minionç¬¬ä¸€æ¬¡ä¸Masterç«¯é€šä¿¡ä¼šå‘å…¶ç”³è¯·ç­¾å‘è¯ä¹¦ã€‚åœ¨Masterç«¯æ‰§è¡Œ# salt-key å³å¯çœ‹åˆ°å·²ç»ç­¾å‘ã€å¾…ç­¾å‘ä»¥åŠæ‹’ç»çš„Minionåˆ—è¡¨ã€‚ä¸Šé¢é‚£å°Minionåˆšåˆšç”³è¯·ï¼Œæ‰€ä»¥ç°åœ¨åœ¨Masterä¸Šæ‰§è¡Œå‘½ä»¤åSaltStack- Minion01å°†ä¼šå‡ºç°åœ¨å¾…ç­¾å‘çš„åˆ—è¡¨ä¸­ã€‚ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/Screenshot-from-2015-08-12-153102.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/Screenshot-from-2015-08-12-153102.png" alt="Screenshot from 2015-08-12 15:31:02"></a> å¯¹äºæ‰¹é‡ç®¡ç†ï¼Œé¦–å…ˆå»ºè®®çš„å°±æ˜¯æ‰“å¼€Masterç«¯çš„è‡ªåŠ¨ç­¾å‘è¯ä¹¦ï¼Œè¦ä¸ç„¶å°±å¾—åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œå‘½ä»¤# salt-key -a Minion-IDæˆ–è€…# salt-key -Aï¼Œä½†ç›¸æ¯”éƒ½æ¯”è¾ƒéº»çƒ¦,äºæ˜¯æˆ‘ä»¬å¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†å…¶è‡ªåŠ¨ç­¾å‘</p><p>sed -ie â€˜s/^#auto_accept:.*/\auto_accept: True/gâ€™ /etc/salt/master<br>/etc/init.d/salt-master restart</p><p>æ­¤æ—¶å†æ¬¡æ‰§è¡Œ# salt-key å°†ä¼šçœ‹åˆ°saltstack-node2.example.comå‡ºç°åœ¨å·²ç­¾å‘çš„åˆ—è¡¨ä¸­ã€‚ &nbsp; <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/PIC2.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/PIC2.png" alt="PIC2"></a> 2.ç®€å•æµ‹è¯•å…¶åŠŸèƒ½ï¼š ç›®å‰ä¸ºæ­¢ï¼ŒMasterç«¯å·²ç»å¯ä»¥å’ŒMinionæ­£å¸¸é€šä¿¡ã€‚ é¦–å…ˆæµ‹è¯•ä¸‹ï¼Œå‘saltstack-node2.example.comæ‰§è¡Œä¸€æ¡æŸ¥çœ‹å†…å­˜çš„å‘½ä»¤ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/PIC3.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/08/PIC3.png" alt="PIC3"></a> è¿™é‡Œå°±å…ˆä¸è§£é‡Šå‘½ä»¤çš„å«ä¹‰å•¦,åé¢åœ¨ç»†è¯´ã€‚ è‡³æ­¤ï¼Œç®€å•æµ‹è¯•å®Œæ¯• å½“ç„¶SaltStackçš„åŠŸèƒ½ä¸æ­¢äºæ­¤ï¼Œä¸‹ç¯‡æ­£å¼çœ‹ä¸‹ä»–æ˜¯å¦‚ä½•å·¥ä½œä»¥åŠå„ç§é…ç½®çš„ç¼–å†™.</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ–è¿ç»´ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> saltstack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬</title>
      <link href="/2015/06/19/linux-e7-b3-bb-e7-bb-9f-e5-88-9d-e5-a7-8b-e5-8c-96/"/>
      <url>/2015/06/19/linux-e7-b3-bb-e7-bb-9f-e5-88-9d-e5-a7-8b-e5-8c-96/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨å®‰è£…å¥½æ“ä½œç³»ç»Ÿåä¸€èˆ¬éƒ½éœ€è¦å¯¹ç³»ç»Ÿåšä¸€äº›é’ˆå¯¹äºè‡ªå·±ç¯å¢ƒçš„æƒ…å†µåšä¸€ä¸‹ç³»ç»Ÿåˆå§‹åŒ–ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸€èˆ¬ç”¨shellè„šæœ¬æ¥è·‘ä¸€éï¼ŒæŠŠç›¸å…³çš„å‚æ•°ã€é…ç½®è°ƒæ•´ä¸€ä¸‹å°±å¥½äº†ã€‚ä½¿ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬å°±å¯ä»¥åˆå§‹åŒ–æˆ‘ä»¬ç³»ç»Ÿå•¦ã€‚</p><p>#!/bin/bash<br>#Version 1.9<br>#Auth: guomaoqiu<br>#For CentOS_mini<br>#Made on 2015-06-19</p><p>echo â€œ   â€œ<br>echo â€œ#############################################################################â€<br>echo â€œ#  Initialize for the CentOS 6.4/6.5 mini_installed.                        #â€<br>echo â€œ#                                                                           #â€<br>echo â€œ#  Please affirm this OS connected net already before running this script ! #â€<br>echo â€œ#                                                                           #â€<br>echo â€œ#  must first connect to the Internet. because yum need it.                  #â€<br>echo â€œ#############################################################################â€<br>echo â€œ   â€œ</p><p>format() {<br>          #echo -e â€œ\033[42;37m ########### Finished ########### \033[0mâ€<br>          sleep 5<br>          echo -e â€œ\033[42;37m ########### Finished ########### \033[0mâ€<br>          echo â€œ  â€œ<br>         }</p><p>##########################################################################<br># Set time æ—¶åŒº/æ—¶é—´åŒæ­¥è®¾ç½®<br>echo â€œSet time.â€<br>/bin/cp -f /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&gt; /dev/null<br>yum -y install ntpdate &amp;&gt; /dev/null<br>ntpdate  0.centos.pool.ntp.org &amp;&gt; /dev/null<br>hwclock -w<br>format</p><p>####################################################################################<br>#Set network ç½‘å¡å¼€æœºè‡ªå¯åŠ¨<br>#sed -i â€œs/ONBOOT=no/ONBOOT=yes/gâ€  /etc/sysconfig/network-scripts/ifcfg-eth0<br>#sed -i â€œs/NM_CONTROLLED=no/NM_CONTROLLED=no/gâ€/etc/sysconfig/network-scripts/ifcfg-eth0<br>#/etc/init.d/network restart &amp;&gt;/dev/null<br>#echo â€œ==================================â€ &gt;&gt; $LOG<br>#format</p><p>##########################################################################<br># Create Log åˆ›å»ºè¯¥è„šæœ¬è¿è¡Œè®°å½•æ—¥å¿—<br>echo â€œCreate log file.â€<br>DATE1=`date +â€%F %H:%Mâ€`<br>LOG=/var/log/sysinitinfo.log<br>echo $DATE1 &gt;&gt; $LOG<br>echo â€œâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€œ &gt;&gt; $LOG<br>echo â€œFor CentOS_miniâ€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>echo â€œSet timezone is Shanghaiâ€ &gt;&gt; $LOG<br>echo â€œFinished ntpdateâ€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Disabled Selinux ç¦ç”¨Selinux<br>echo â€œDisabled SELinux.â€<br>sed -i â€˜s/^SELINUX=enforcing/SELINUX=disabled/â€˜ /etc/sysconfig/selinux<br>echo â€œ==================================================â€<br>echo â€œDisabled SELinux.â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Stop iptables ç¦ç”¨iptables<br>echo â€œStop iptables.â€<br>service iptables stop &amp;&gt; /dev/null<br>chkconfig â€“level 35 iptables off<br>echo â€œStop iptables.â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Disable ipv6 ç¦ç”¨IPV6<br>echo â€œDisable ipv6.â€<br>echo â€œalias net-pf-10 offâ€ &gt;&gt; /etc/modprobe.conf<br>echo â€œalias ipv6 offâ€ &gt;&gt; /etc/modprobe.conf<br>chkconfig â€“level 35 ip6tables off<br>echo â€œDisable ipv6.â€&gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>##########################################################################<br>#Set history commands  è®¾ç½®å‘½ä»¤å†å²è®°å½•å‚æ•°<br>echo â€œSet history commands.â€<br>echo â€œHISTFILESIZE=4000â€ &gt;&gt; /etc/bashrc<br>echo â€œHISTSIZE=4000â€ &gt;&gt; /etc/bashrc<br>echo â€œHISTTIMEFORMAT=â€™%F/%Tâ€™â€ &gt;&gt; /etc/bashrc<br>source /etc/bashrc<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>##########################################################################<br># Epel å‡çº§epelæº<br>echo â€œInstall epelâ€<br>rpm -Uvh <a href="http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm">http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</a> &amp;&gt; /dev/null<br>sed -i â€œs/^#base/base/gâ€ /etc/yum.repos.d/epel.repo<br>sed -i â€œs/^mirr/#mirr/gâ€ /etc/yum.repos.d/epel.repo<br>echo â€œ==================================================â€<br>echo â€œInstall epelâ€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>##########################################################################<br>#Yum install Development tools  å®‰è£…å¼€å‘åŒ…ç»„åŠå¿…å¤‡è½¯ä»¶<br>echo â€œInstall Development tools(It will be a moment,waitâ€¦â€¦)â€<br>yum groupinstall -y â€œDevelopment toolsâ€ &amp;&gt; /dev/null<br>yum groupinstall -y â€œServer Platform Developmentâ€ &amp;&gt; /dev/null<br>yum groupinstall -y â€œDesktop Platform Developmentâ€ &amp;&gt; /dev/null<br>yum groupinstall -y â€œchinese-supportâ€ &amp;&gt;/dev/null<br>for I in bind-utils lrzsz wget gcc gcc-c++ vim htop ;do<br>yum install -y $I<br>done<br>echo â€œ==================================================â€<br>echo â€œInstall Development toolsâ€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>##########################################################################<br># Yum update bash and openssl  å‡çº§bash/openssl<br>echo â€œUpdate bash and opensslâ€<br>yum -y update bash &amp;&gt; /dev/null<br>yum -y update openssl &amp;&gt; /dev/null<br>echo â€œ==================================================â€<br>echo â€œUpdate bash and opensslâ€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Set ssh è®¾ç½®sshç™»å½•ç­–ç•¥<br>echo â€œDisabled EmptyPassword.â€<br>echo â€œDisabled SSH-DNS.â€<br>echo â€œSet timeout is 6m.â€<br>sed -i â€œs/^#PermitEmptyPasswords/PermitEmptyPasswords/â€œ /etc/ssh/sshd_config<br>sed -i â€œs/^#LoginGraceTime 2m/LoginGraceTime 6m/â€œ /etc/ssh/sshd_config<br>echo â€œUseDNS noâ€ &gt;&gt; /etc/ssh/sshd_config<br>echo â€œ==================================================â€<br>echo â€œDisabled EmptyPassword.â€ &gt;&gt; $LOG<br>echo â€œDisabled SSH-DNS.â€ &gt;&gt; $LOG<br>echo â€œSet timeout is 6m.â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Set default init 3  è®¾ç½®ç³»ç»Ÿé»˜è®¤åˆå§‹åŒ–<br>echo â€œDefault init 3.â€<br>sed -i â€˜s/^id:5:initdefault:/id:3:initdefault:/â€˜ /etc/inittab<br>echo â€œ==================================================â€<br>echo â€œDefault init 3.â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Stop Service  å…³é—­ä¸å¿…è¦çš„æœåŠ¡<br>echo â€œSome services are turned off now.â€<br>for SER in rpcbind postfix portreserve certmonger mdmonitor blk-availability lvm2-monitor udev-post cups dhcpd firstboot gpm haldaemon hidd ip6tables ipsec isdn kudzu lpd mcstrans messagebus microcode_ctl netfs nfs nfslock nscd acpid anacron apmd atd auditd autofs avahi-daemon avahi-dnsconfd bluetooth cpuspeed pcscd portmap readahead_early restorecond rpcgssd rpcidmapd rstatd sendmail setroubleshoot snmpd sysstat xfs xinetd yppasswdd ypserv yum-updatesd<br> do<br>    /sbin/chkconfig â€“list $SER &amp;&gt; /dev/null<br>  if [ $? -eq 0 ]<br>    then<br>      chkconfig â€“level 35  $SER off<br>    echo â€œ$SERâ€ &gt;&gt; $LOG<br>  fi<br> done<br>echo â€œ==================================================â€<br>echo â€œSome services are turned off now:â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Del unnecessary users åˆ é™¤ä¸å¿…è¦çš„ç”¨æˆ·<br>echo â€œDel unnecessary users.â€<br>for USERS in adm lp sync shutdown halt mail news uucp operator games gopher<br> do<br>  grep $USERS /etc/passwd &amp;&gt;/dev/null<br>  if [ $? -eq 0 ]<br>   then<br>    userdel $USERS &amp;&gt; /dev/null<br>    echo $USERS &gt;&gt; $LOG<br>  fi<br> done<br>echo â€œ==================================================â€<br>echo â€œDel unnecessary users.â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Del unnecessary groups åˆ é™¤ä¸å¿…è¦çš„ç”¨æˆ·ç»„<br>echo â€œDel unnecessary groups.â€<br>for GRP in adm lp mail news uucp games gopher mailnull floppy dip pppusers popusers slipusers daemon<br> do<br>  grep $GRP /etc/group &amp;&gt; /dev/null<br>  if [ $? -eq 0 ]<br>   then<br>    groupdel $GRP &amp;&gt; /dev/null<br>    echo $GRP &gt;&gt; $LOG<br>  fi<br> done<br>echo â€œ==================================================â€<br>echo â€œDel unnecessary groups.â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Disabled reboot by keys ctlaltdelete ç¦ç”¨ctlaltdeleteé‡å¯åŠŸèƒ½<br>echo â€œDisabled reboot by keys ctlaltdeleteâ€<br>sed -i â€˜s/^exec/#exec/â€˜ /etc/init/control-alt-delete.conf<br>echo â€œ==================================================â€<br>echo â€œDisabled reboot by keys ctlaltdeleteâ€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Set ulimit  è®¾ç½®æ–‡ä»¶å¥æŸ„æ•°<br>echo â€œSet ulimit 1000000â€<br>echo â€œ*    soft    nofile  1000000â€ &gt;&gt; /etc/security/limits.conf<br>echo â€œ*    hard    nofile  1000000â€ &gt;&gt; /etc/security/limits.conf<br>echo â€œ*    soft    nproc 102400â€ &gt;&gt; /etc/security/limits.conf<br>echo â€œ*    hard    nproc 102400â€ &gt;&gt; /etc/security/limits.conf<br>sed -i â€˜s/102400/1000000/â€˜ /etc/security/limits.d/90-nproc.conf<br>echo â€œ==================================================â€<br>echo â€œSet ulimit 1000000â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Set login message è®¾ç½®ç™»å½•æ—¶æ˜¾ç¤ºçš„ä¿¡æ¯<br>echo â€œSet login message.â€<br>echo â€œThis is not a public Serverâ€ &gt; /etc/issue<br>echo â€œThis is not a public Serverâ€ &gt; /etc/redhat-release<br>echo â€œ==================================================â€<br>echo â€œSet login message.â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Record SUID and SGID files<br>DATE2=`date +â€%Fâ€`<br>echo â€œRecord SUID and SGID files.â€<br>echo â€œSUID â€” â€œ &gt; /var/log/SuSg_â€$DATE2â€.log<br>find / -path â€˜/procâ€™  -prune -o -perm -4000 &gt;&gt; /var/log/SuSg_â€$DATE2â€.log<br>echo â€œâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” â€œ &gt;&gt; /var/log/SuSg_â€$DATE2â€.log<br>echo â€œSGID â€” â€œ &gt;&gt; /var/log/SuSg_â€$DATE2â€.log<br>find / -path â€˜/procâ€™  -prune -o -perm -2000 &gt;&gt; /var/log/SuSg_â€$DATE2â€.log<br>echo â€œ==================================================â€<br>echo â€œRecord SUID and SGID.â€ &gt;&gt; $LOG<br>echo â€œRecord is in /var/log/SuSg_â€$DATE2â€.logâ€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Disabled crontab send mail ç¦ç”¨æ‰§è¡Œä»»åŠ¡è®¡åˆ’æ—¶å‘rootå‘é€é‚®ä»¶<br>echo â€œDisable crontab send mail.â€<br>sed -i â€˜s/^MAILTO=root/MAILTO=â€â€/â€˜ /etc/crontab<br>sed -i â€˜s/^mail\.\*/mail\.err/â€˜ /etc/rsyslog.conf<br>echo â€œ==================================================â€<br>echo â€œDisable crontab send mail.â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Set ntp client è®¾ç½®æ—¶é—´æœåŠ¡å®¢æˆ·ç«¯<br>echo â€œSet ntp client.â€<br>SED() {<br>    cp -p /etc/ntp.conf /etc/ntp.conf.bak<br>    sed -i â€˜/^server/dâ€™ /etc/ntp.conf<br>    sed -i â€˜/^includefile/ i\server 0.centos.pool.ntp.org iburstâ€™ /etc/ntp.conf<br>    sed -i â€˜/0.centos.pool.ntp.org/ a\server 1.centos.pool.ntp.org iburstâ€™ /etc/ntp.conf<br>    sed -i â€˜/1.centos.pool.ntp.org/ a\server 2.centos.pool.ntp.org iburstâ€™ /etc/ntp.conf<br>    sed -i â€˜/2.centos.pool.ntp.org/ a\server 3.centos.pool.ntp.org iburstâ€™ /etc/ntp.conf<br>    chkconfig â€“level 35 ntpd on &amp;&gt; /dev/null<br>    echo â€œ==================================================â€<br>}<br>rpm -q ntp &amp;&gt; /dev/null<br>if [ $? -eq 0 ]<br>  then<br>    SED<br>  else<br>   yum -y install ntp &amp;&gt; /dev/null<br>   SED<br>fi<br>echo â€œSet ntp client.â€ &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format</p><p>###########################################################################<br># Set sysctl.conf è®¾ç½®å†…æ ¸å‚æ•°<br>echo â€œSet sysctl.confâ€<br>#webåº”ç”¨ä¸­listenå‡½æ•°çš„backlogé»˜è®¤ä¼šå°†å†…æ ¸å‚æ•°çš„net.core.somaxconné™åˆ¶åˆ°128ï¼Œè€Œnginxå®šä¹‰çš„NGX_LISTEN_BACKLOGé»˜è®¤æ˜¯511ï¼Œæ‰€ä»¥å¿…é¡»è°ƒæ•´,ä¸€èˆ¬è°ƒæ•´ä¸º2048<br>echo â€œnet.core.somaxconn = 2048â€ &gt;&gt; /etc/sysctl.conf</p><p>echo â€œnet.core.rmem_default = 262144â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.core.wmem_default = 262144â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.core.rmem_max = 16777216â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.core.wmem_max = 16777216â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.ipv4.tcp_rmem = 4096 4096 16777216â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.ipv4.tcp_wmem = 4096 4096 16777216â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.ipv4.tcp_mem = 786432 2097152 3145728â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.ipv4.tcp_max_syn_backlog = 16384â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.core.netdev_max_backlog = 20000â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.ipv4.tcp_fin_timeout = 15â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.ipv4.tcp_tw_reuse = 1â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.ipv4.tcp_tw_recycle = 1â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.ipv4.tcp_max_orphans = 131072â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œnet.ipv4.ip_local_port_range = 1024 65535â€ &gt;&gt; /etc/sysctl.conf<br>echo â€œSet sysctl.conf â€”- â€œ &gt;&gt; $LOG<br>/sbin/sysctl  -p &gt;&gt; $LOG<br>echo â€œ==================================â€ &gt;&gt; $LOG<br>format<br>###########################################################################<br># Done<br>echo â€œFinished,You can check infomations in $LOG .â€<br>#echo â€œSystem will reboot in 60s.â€<br>#shutdown -r 1</p><p>å¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹ï¼Œå„ä½å¤§å©¶å¯ä»¥æå‡ºæ¥ï¼Œå¤§å®¶ä¸€èµ·è¿›æ­¥å“ˆï¼›è°¢è°¢æ‚¨çš„æ„è§ã€‚ Download Script: <a href="http://www.sctux.com/project/initsystem.sh">initsystem.sh</a></p>]]></content>
      
      
      <categories>
          
          <category> Shell </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡ Ulimit æ”¹å–„ç³»ç»Ÿæ€§èƒ½</title>
      <link href="/2015/04/23/e9-80-9a-e8-bf-87-ulimit-e6-94-b9-e5-96-84-e7-b3-bb-e7-bb-9f-e6-80-a7-e8-83-bd/"/>
      <url>/2015/04/23/e9-80-9a-e8-bf-87-ulimit-e6-94-b9-e5-96-84-e7-b3-bb-e7-bb-9f-e6-80-a7-e8-83-bd/</url>
      
        <content type="html"><![CDATA[<p><strong>æ¦‚è¿°</strong> ç³»ç»Ÿæ€§èƒ½ä¸€ç›´æ˜¯ä¸€ä¸ªå—å…³æ³¨çš„è¯é¢˜ï¼Œå¦‚ä½•é€šè¿‡æœ€ç®€å•çš„è®¾ç½®æ¥å®ç°æœ€æœ‰æ•ˆçš„æ€§èƒ½è°ƒä¼˜ï¼Œå¦‚ä½•åœ¨æœ‰é™èµ„æºçš„æ¡ä»¶ä¸‹ä¿è¯ç¨‹åºçš„è¿ä½œï¼Œulimit æ˜¯æˆ‘ä»¬åœ¨å¤„ç†è¿™äº›é—®é¢˜æ—¶ï¼Œç»å¸¸ä½¿ç”¨çš„ä¸€ç§ç®€å•æ‰‹æ®µã€‚ulimit æ˜¯ä¸€ç§ linux ç³»ç»Ÿçš„å†…é”®åŠŸèƒ½ï¼Œå®ƒå…·æœ‰ä¸€å¥—å‚æ•°é›†ï¼Œç”¨äºä¸ºç”±å®ƒç”Ÿæˆçš„ shell è¿›ç¨‹åŠå…¶å­è¿›ç¨‹çš„èµ„æºä½¿ç”¨è®¾ç½®é™åˆ¶ã€‚æœ¬æ–‡å°†åœ¨åé¢çš„ç« èŠ‚ä¸­è¯¦ç»†è¯´æ˜ ulimit çš„åŠŸèƒ½ï¼Œä½¿ç”¨ä»¥åŠå®ƒçš„å½±å“ï¼Œå¹¶ä»¥å…·ä½“çš„ä¾‹å­æ¥è¯¦ç»†åœ°é˜è¿°å®ƒåœ¨é™åˆ¶èµ„æºä½¿ç”¨æ–¹é¢çš„å½±å“ã€‚ <strong>ulimit çš„åŠŸèƒ½å’Œç”¨æ³•</strong> <strong>ulimit åŠŸèƒ½ç®€è¿°</strong> å‡è®¾æœ‰è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå½“ä¸€å° Linux ä¸»æœºä¸ŠåŒæ—¶ç™»é™†äº† 10 ä¸ªäººï¼Œåœ¨ç³»ç»Ÿèµ„æºæ— é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œè¿™ 10 ä¸ªç”¨æˆ·åŒæ—¶æ‰“å¼€äº† 500 ä¸ªæ–‡æ¡£ï¼Œè€Œå‡è®¾æ¯ä¸ªæ–‡æ¡£çš„å¤§å°æœ‰ 10Mï¼Œè¿™æ—¶ç³»ç»Ÿçš„å†…å­˜èµ„æºå°±ä¼šå—åˆ°å·¨å¤§çš„æŒ‘æˆ˜ã€‚ è€Œå®é™…åº”ç”¨çš„ç¯å¢ƒè¦æ¯”è¿™ç§å‡è®¾å¤æ‚çš„å¤šï¼Œä¾‹å¦‚åœ¨ä¸€ä¸ªåµŒå…¥å¼å¼€å‘ç¯å¢ƒä¸­ï¼Œå„æ–¹é¢çš„èµ„æºéƒ½æ˜¯éå¸¸ç´§ç¼ºçš„ï¼Œå¯¹äºå¼€å¯æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ï¼Œåˆ†é…å †æ ˆçš„å¤§å°ï¼ŒCPU æ—¶é—´ï¼Œè™šæ‹Ÿå†…å­˜å¤§å°ï¼Œç­‰ç­‰ï¼Œéƒ½æœ‰éå¸¸ä¸¥æ ¼çš„è¦æ±‚ã€‚èµ„æºçš„åˆç†é™åˆ¶å’Œåˆ†é…ï¼Œä¸ä»…ä»…æ˜¯ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§çš„å¿…è¦æ¡ä»¶ï¼Œä¹Ÿä¸ç³»ç»Ÿä¸Šè½¯ä»¶è¿è¡Œçš„æ€§èƒ½æœ‰ç€å¯†ä¸å¯åˆ†çš„è”ç³»ã€‚è¿™æ—¶ï¼Œulimit å¯ä»¥èµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ï¼Œå®ƒæ˜¯ä¸€ç§ç®€å•å¹¶ä¸”æœ‰æ•ˆçš„å®ç°èµ„æºé™åˆ¶çš„æ–¹å¼ã€‚ ulimit ç”¨äºé™åˆ¶ shell å¯åŠ¨è¿›ç¨‹æ‰€å ç”¨çš„èµ„æºï¼Œæ”¯æŒä»¥ä¸‹å„ç§ç±»å‹çš„é™åˆ¶ï¼šæ‰€åˆ›å»ºçš„å†…æ ¸æ–‡ä»¶çš„å¤§å°ã€è¿›ç¨‹æ•°æ®å—çš„å¤§å°ã€Shell è¿›ç¨‹åˆ›å»ºæ–‡ä»¶çš„å¤§å°ã€å†…å­˜é”ä½çš„å¤§å°ã€å¸¸é©»å†…å­˜é›†çš„å¤§å°ã€æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€åˆ†é…å †æ ˆçš„æœ€å¤§å¤§å°ã€CPU æ—¶é—´ã€å•ä¸ªç”¨æˆ·çš„æœ€å¤§çº¿ç¨‹æ•°ã€Shell è¿›ç¨‹æ‰€èƒ½ä½¿ç”¨çš„æœ€å¤§è™šæ‹Ÿå†…å­˜ã€‚åŒæ—¶ï¼Œå®ƒæ”¯æŒç¡¬èµ„æºå’Œè½¯èµ„æºçš„é™åˆ¶ã€‚ ä½œä¸ºä¸´æ—¶é™åˆ¶ï¼Œulimit å¯ä»¥ä½œç”¨äºé€šè¿‡ä½¿ç”¨å…¶å‘½ä»¤ç™»å½•çš„ shell ä¼šè¯ï¼Œåœ¨ä¼šè¯ç»ˆæ­¢æ—¶ä¾¿ç»“æŸé™åˆ¶ï¼Œå¹¶ä¸å½±å“äºå…¶ä»– shell ä¼šè¯ã€‚è€Œå¯¹äºé•¿æœŸçš„å›ºå®šé™åˆ¶ï¼Œulimit å‘½ä»¤è¯­å¥åˆå¯ä»¥è¢«æ·»åŠ åˆ°ç”±ç™»å½• shell è¯»å–çš„æ–‡ä»¶ä¸­ï¼Œä½œç”¨äºç‰¹å®šçš„ shell ç”¨æˆ·ã€‚ <img src="https://www.ibm.com/developerworks/cn/linux/l-cn-ulimit/images/image001.jpg" alt="ulimit çš„ä½¿ç”¨"> åœ¨ä¸‹é¢çš„ç« èŠ‚ä¸­ï¼Œå°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ ulimit åšç›¸åº”çš„èµ„æºé™åˆ¶ã€‚ å¦‚ä½•ä½¿ç”¨ ulimit ulimit é€šè¿‡ä¸€äº›å‚æ•°é€‰é¡¹æ¥ç®¡ç†ä¸åŒç§ç±»çš„ç³»ç»Ÿèµ„æºã€‚åœ¨æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†è®²è§£è¿™äº›å‚æ•°çš„ä½¿ç”¨ã€‚ ulimit å‘½ä»¤çš„æ ¼å¼ä¸ºï¼šulimit [options] [limit] å…·ä½“çš„ options å«ä¹‰ä»¥åŠç®€å•ç¤ºä¾‹å¯ä»¥å‚è€ƒä»¥ä¸‹è¡¨æ ¼ã€‚</p><p><strong>è¡¨ 1. ulimit å‚æ•°è¯´æ˜</strong></p><p>é€‰é¡¹ [options]</p><p>å«ä¹‰</p><p>ä¾‹å­</p><p>-H</p><p>è®¾ç½®ç¡¬èµ„æºé™åˆ¶ï¼Œä¸€æ—¦è®¾ç½®ä¸èƒ½å¢åŠ ã€‚</p><p>ulimit â€“ Hs 64ï¼›é™åˆ¶ç¡¬èµ„æºï¼Œçº¿ç¨‹æ ˆå¤§å°ä¸º 64Kã€‚</p><p>-S</p><p>è®¾ç½®è½¯èµ„æºé™åˆ¶ï¼Œè®¾ç½®åå¯ä»¥å¢åŠ ï¼Œä½†æ˜¯ä¸èƒ½è¶…è¿‡ç¡¬èµ„æºè®¾ç½®ã€‚</p><p>ulimit â€“ Sn 32ï¼›é™åˆ¶è½¯èµ„æºï¼Œ32 ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>-a</p><p>æ˜¾ç¤ºå½“å‰æ‰€æœ‰çš„ limit ä¿¡æ¯ã€‚</p><p>ulimit â€“ aï¼›æ˜¾ç¤ºå½“å‰æ‰€æœ‰çš„ limit ä¿¡æ¯ã€‚</p><p>-c</p><p>æœ€å¤§çš„ core æ–‡ä»¶çš„å¤§å°ï¼Œ ä»¥ blocks ä¸ºå•ä½ã€‚</p><p>ulimit â€“ c unlimitedï¼› å¯¹ç”Ÿæˆçš„ core æ–‡ä»¶çš„å¤§å°ä¸è¿›è¡Œé™åˆ¶ã€‚</p><p>-d</p><p>è¿›ç¨‹æœ€å¤§çš„æ•°æ®æ®µçš„å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚</p><p>ulimit -d unlimitedï¼›å¯¹è¿›ç¨‹çš„æ•°æ®æ®µå¤§å°ä¸è¿›è¡Œé™åˆ¶ã€‚</p><p>-f</p><p>è¿›ç¨‹å¯ä»¥åˆ›å»ºæ–‡ä»¶çš„æœ€å¤§å€¼ï¼Œä»¥ blocks ä¸ºå•ä½ã€‚</p><p>ulimit â€“ f 2048ï¼›é™åˆ¶è¿›ç¨‹å¯ä»¥åˆ›å»ºçš„æœ€å¤§æ–‡ä»¶å¤§å°ä¸º 2048 blocksã€‚</p><p>-l</p><p>æœ€å¤§å¯åŠ é”å†…å­˜å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚</p><p>ulimit â€“ l 32ï¼›é™åˆ¶æœ€å¤§å¯åŠ é”å†…å­˜å¤§å°ä¸º 32 Kbytesã€‚</p><p>-m</p><p>æœ€å¤§å†…å­˜å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚</p><p>ulimit â€“ m unlimitedï¼›å¯¹æœ€å¤§å†…å­˜ä¸è¿›è¡Œé™åˆ¶ã€‚</p><p>-n</p><p>å¯ä»¥æ‰“å¼€æœ€å¤§æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚</p><p>ulimit â€“ n 128ï¼›é™åˆ¶æœ€å¤§å¯ä»¥ä½¿ç”¨ 128 ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>-p</p><p>ç®¡é“ç¼“å†²åŒºçš„å¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚</p><p>ulimit â€“ p 512ï¼›é™åˆ¶ç®¡é“ç¼“å†²åŒºçš„å¤§å°ä¸º 512 Kbytesã€‚</p><p>-s</p><p>çº¿ç¨‹æ ˆå¤§å°ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚</p><p>ulimit â€“ s 512ï¼›é™åˆ¶çº¿ç¨‹æ ˆçš„å¤§å°ä¸º 512 Kbytesã€‚</p><p>-t</p><p>æœ€å¤§çš„ CPU å ç”¨æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚</p><p>ulimit â€“ t unlimitedï¼›å¯¹æœ€å¤§çš„ CPU å ç”¨æ—¶é—´ä¸è¿›è¡Œé™åˆ¶ã€‚</p><p>-u</p><p>ç”¨æˆ·æœ€å¤§å¯ç”¨çš„è¿›ç¨‹æ•°ã€‚</p><p>ulimit â€“ u 64ï¼›é™åˆ¶ç”¨æˆ·æœ€å¤šå¯ä»¥ä½¿ç”¨ 64 ä¸ªè¿›ç¨‹ã€‚</p><p>-v</p><p>è¿›ç¨‹æœ€å¤§å¯ç”¨çš„è™šæ‹Ÿå†…å­˜ï¼Œä»¥ Kbytes ä¸ºå•ä½ã€‚</p><p>ulimit â€“ v 200000ï¼›é™åˆ¶æœ€å¤§å¯ç”¨çš„è™šæ‹Ÿå†…å­˜ä¸º 200000 Kbytesã€‚</p><p>æ–°è£…çš„linuxé»˜è®¤åªæœ‰1024ï¼Œå½“ä½œè´Ÿè½½è¾ƒå¤§çš„æœåŠ¡å™¨æ—¶ï¼Œå¾ˆå®¹æ˜“é‡åˆ°error: too many open filesã€‚å› æ­¤ï¼Œéœ€è¦å°†å…¶æ”¹å¤§ã€‚ ä½¿ç”¨ ulimit -n 65535 å¯å³æ—¶ä¿®æ”¹ï¼Œä½†é‡å¯åå°±æ— æ•ˆäº†ã€‚ï¼ˆæ³¨ulimit -SHn 65535 ç­‰æ•ˆ ulimit -n 65535ï¼Œ-SæŒ‡softï¼Œ-HæŒ‡hard) æœ‰å¦‚ä¸‹ä¸‰ç§ä¿®æ”¹æ–¹å¼ï¼š 1.åœ¨/etc/rc.local ä¸­å¢åŠ ä¸€è¡Œ ulimit -SHn 65535 2.åœ¨/etc/profile ä¸­å¢åŠ ä¸€è¡Œ ulimit -SHn 65535 3.åœ¨/etc/security/limits.confæœ€åå¢åŠ å¦‚ä¸‹ä¸¤è¡Œè®°å½• * soft nofile 65535 * hard nofile 65535 <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/04/QQ%E6%88%AA%E5%9B%BE20150423202805.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/04/QQ%E6%88%AA%E5%9B%BE20150423202805.png" alt="QQæˆªå›¾20150423202805"></a></p>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ulimit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®åº“é“¾æ¥è¶…æ—¶ï¼Œå¯èƒ½åŸå› ç”±äºç©ºé—´ä¸è¶³é€ æˆ</title>
      <link href="/2015/04/15/e6-95-b0-e6-8d-ae-e5-ba-93-e9-93-be-e6-8e-a5-e8-b6-85-e6-97-b6-ef-bc-8c-e5-8f-af-e8-83-bd-e5-8e-9f-e5-9b-a0-e7-94-b1-e4-ba-8e-e7-a9-ba-e9-97-b4-e4-b8-8d-e8-b6-b3-e9-80-a0-e6-88-90/"/>
      <url>/2015/04/15/e6-95-b0-e6-8d-ae-e5-ba-93-e9-93-be-e6-8e-a5-e8-b6-85-e6-97-b6-ef-bc-8c-e5-8f-af-e8-83-bd-e5-8e-9f-e5-9b-a0-e7-94-b1-e4-ba-8e-e7-a9-ba-e9-97-b4-e4-b8-8d-e8-b6-b3-e9-80-a0-e6-88-90/</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©å¼€å‘äººå‘˜å‘ŠçŸ¥ï¼Œæµ‹è¯•æœåŠ¡å™¨æ•°æ®åº“é“¾æ¥è¶…æ—¶ æˆ‘ç™»å½•æµ‹è¯•æœåŠ¡å™¨<br>1ã€æ£€æŸ¥mysqlè¿è¡ŒçŠ¶æ€ï¼Œç»“æœï¼šæ­£å¸¸ é€šè¿‡æ‰§è¡Œss -tunl | grep â€œ3306â€ ä»¥åŠ ps aux | grep â€œmysqldâ€ æ¥åˆ¤å®š<br>2ã€æ£€æŸ¥mysqlæ—¥å¿—ï¼Œç»“æœï¼šæ­£å¸¸ é€šè¿‡æŸ¥çœ‹mysqlçš„é”™è¯¯æ—¥å¿—<br>3ã€ç”±äºç³»ç»Ÿç”¨çš„æ˜¯CentOS7 äºæ˜¯ä¹é€šè¿‡å¦å¤–ä¸€ç§æ–¹å¼æŸ¥çœ‹mysqlçš„çŠ¶æ€<br>systemctl status mysqld<br><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/10/nospace.png" alt="nospace"><br>å¯ä»¥çœ‹å‡ºæ¥ï¼Œè™½ç„¶è¿æ¥æ•°æ®åº“æ—¶å‡ºç°äº†ç‚¹é—®é¢˜ï¼Œä½†æ˜¯mysql å¹¶æœªåœæ­¢è¿è¡Œã€‚ </p><p>è§£å†³åŠæ³•ï¼šæ¸…ç†ç£ç›˜ç©ºé—´ï¼Œä¸ºmysqlæ•°æ® æ‰€åœ¨åˆ†åŒºè…¾å‡ºç©ºé—´ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ•…éšœå¤„ç† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> nospace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vsftp-è™šæ‹Ÿç”¨æˆ·è®¾ç½®ä¸åŒæƒé™</title>
      <link href="/2015/04/02/vsftp-xu-ni-yong-hu-she-zhi-bu-tong-quan-xian/"/>
      <url>/2015/04/02/vsftp-xu-ni-yong-hu-she-zhi-bu-tong-quan-xian/</url>
      
        <content type="html"><![CDATA[<h4 id="1-system-version"><a href="#1-system-version" class="headerlink" title="1.system version"></a>1.system version</h4><pre><code>CentOS Linux release 7.2.1511 (Core)</code></pre><h4 id="2-install-vsftpd"><a href="#2-install-vsftpd" class="headerlink" title="2.install vsftpd"></a>2.install vsftpd</h4><pre><code>yum install -y vsftpd</code></pre><h4 id="3-create-rootdir"><a href="#3-create-rootdir" class="headerlink" title="3.create rootdir"></a>3.create rootdir</h4><pre><code>mkdir /data/program/ftpdata &amp;&amp; chmod a-w /data/program/ftpdata/</code></pre><h4 id="4-create-local-user-for-map-to-virtualuser"><a href="#4-create-local-user-for-map-to-virtualuser" class="headerlink" title="4.create local user(for map to virtualuser)"></a>4.create local user(for map to virtualuser)</h4><pre><code>useradd -s /sbin/nologin -d /data/program/ftpdata ftpuser</code></pre><h4 id="5-install-db-for-auth"><a href="#5-install-db-for-auth" class="headerlink" title="5.install db(for auth)"></a>5.install db(for auth)</h4><pre><code>yum install -y db*</code></pre><h4 id="6-create-virtual-users"><a href="#6-create-virtual-users" class="headerlink" title="6.create virtual users"></a>6.create virtual users</h4><pre><code>cd /etc/vsftpd/vim virtualuser.txt user1    # this username1234qwer # this passworduser2    # this username123.com  # this password</code></pre><h4 id="7-create-db"><a href="#7-create-db" class="headerlink" title="7.create db"></a>7.create db</h4><pre><code>db_load -T -t hash -f virtualuser.txt /etc/vsftpd/virtualuser.db</code></pre><h4 id="8-create-pam-auth-file"><a href="#8-create-pam-auth-file" class="headerlink" title="8.create pam auth file"></a>8.create pam auth file</h4><pre><code>vim /etc/pam.d/vsftpd.vuauth      required  /lib64/security/pam_userdb.so db=/etc/vsftpd/virtualuseraccount   required  /lib64/security/pam_userdb.so db=/etc/vsftpd/virtualuser# if your system is centos6.x release so use this configure:auth      sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/virtualuseraccount   sufficient  /lib64/security/pam_userdb.so db=/etc/vsftpd/virtualuser</code></pre><h4 id="9-configure-vsftpd-conf"><a href="#9-configure-vsftpd-conf" class="headerlink" title="9.configure vsftpd.conf"></a>9.configure vsftpd.conf</h4><pre><code>vim /etc/vsftpd.confanonymous_enable=NO#allow_writeable_chroot # if your vsftpd version is 3.xlocal_enable=YESwrite_enable=YESlocal_umask=022dirmessage_enable=YESxferlog_enable=YESconnect_from_port_20=YESxferlog_std_format=YESchroot_local_user=YESchroot_list_enable=YESchroot_list_file=/etc/vsftpd/chroot_listlisten=NOlisten_ipv6=YESpam_service_name=ftpuseruserlist_enable=YEStcp_wrappers=YESguest_enable=YESguest_username=ftp01pam_service_name=vsftpd.vuuser_config_dir=/etc/vsftpd/user_conf</code></pre><h4 id="10-create-each-user-config-dir"><a href="#10-create-each-user-config-dir" class="headerlink" title="10.create each user config dir"></a>10.create each user config dir</h4><pre><code>cd /etc/vsftpd/ &amp;&amp; mkdir user_conf &amp;&amp; cd user_conf# for user1 config# this user can uploadã€wirteã€download vim user1anon_world_readable_only=NOanon_upload_enable=YESanon_mkdir_write_enable=YESanon_other_write_enable=YES/data/program/ftpdata/user1_home/  # virtual user's datadir# for user2 config# this user only can readã€download, can't uploadvim user2anon_world_readable_only=NOanon_upload_enable=NOanon_mkdir_write_enable=NOanon_other_write_enable=NO/data/program/ftpdata/user2_home # virtual user's datadir</code></pre>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ftp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vim Nginxé…ç½®æ–‡ä»¶è¯­æ³•é«˜äº®</title>
      <link href="/2015/03/09/vim-nginx-e9-85-8d-e7-bd-ae-e6-96-87-e4-bb-b6-e8-af-ad-e6-b3-95-e9-ab-98-e4-ba-ae/"/>
      <url>/2015/03/09/vim-nginx-e9-85-8d-e7-bd-ae-e6-96-87-e4-bb-b6-e8-af-ad-e6-b3-95-e9-ab-98-e4-ba-ae/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨ç¼–è¾‘é…ç½®nginxçš„é…ç½®æ–‡ä»¶æ—¶ï¼Œç”±äºä»–æ²¡æœ‰é«˜äº®çš„åŠŸèƒ½ï¼Œä½†æ˜¯nginxå®˜æ–¹æ˜¯æ”¯æŒè¿™ä¸ªåŠŸèƒ½çš„ï¼›è¦æƒ³åœ¨ç¼–è¾‘é…ç½®nginxé…ç½®æ–‡ä»¶çš„æ—¶å€™é«˜äº®è¯­æ³•ä»¥é™ä½é…ç½®çš„é”™è¯¯å‘ç”Ÿç‡å¯ç§»æ‰§è¡Œè¿™ä¸ªå°è„šæœ¬è€Œåˆ°è¾¾ç›®çš„ï¼š</p><p>#!/bin/bash<br>mkdir -p ~/.vim/syntax &amp;&amp; cd ~/.vim/syntax<br>wget <a href="http://www.vim.org/scripts/download/_script.php?src%5C_id=14376">http://www.vim.org/scripts/download\_script.php?src\_id=14376</a> -O nginx.vim &gt;/dev/null<br>echo â€œau BufRead,BufNewFile /usr/local/webserver/nginx/conf/* set ft=nginxâ€ &gt; ~/.vim/filetype.vim<br>#å…¶ä¸­è·¯å¾„/usr/local/webserver/nginx/conf/*ä¸ºä½ çš„nginx.confæ–‡ä»¶è·¯å¾„</p>]]></content>
      
      
      <categories>
          
          <category> Shell </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Zabbix æ¸…ç†è¿‡ä¹…çš„å†å²ä¿¡æ¯</title>
      <link href="/2014/11/04/zabbix-e6-b8-85-e7-90-86-e8-bf-87-e4-b9-85-e7-9a-84-e5-8e-86-e5-8f-b2-e4-bf-a1-e6-81-af/"/>
      <url>/2014/11/04/zabbix-e6-b8-85-e7-90-86-e8-bf-87-e4-b9-85-e7-9a-84-e5-8e-86-e5-8f-b2-e4-bf-a1-e6-81-af/</url>
      
        <content type="html"><![CDATA[<p>å½“æˆ‘ä»¬çš„zabbixè¿è¡Œæ—¶é—´ä¹…äº†ï¼Œç›‘æ§çš„èŠ‚ç‚¹å¤šäº†ï¼Œæ•°æ®ä¿¡æ¯ä¼šå¢é•¿çš„å¾ˆå¿«ï¼Œæƒ³å¤‡ä»½é‡Œé¢çš„æ•°æ®åº“æ—¶ï¼Œè¦æµªè´¹å¤§é‡çš„æ—¶é—´ï¼Œzabbixé‡Œé¢æœ€å¤§çš„è¡¨å°±æ˜¯å†å²è®°å½•çš„è¡¨äº†ï¼Œç½‘ä¸Šå¾ˆå¤šäººéƒ½æ˜¯å†™å…¨éƒ¨æ¸…ç©ºè¿™äº›è¡¨çš„æ•°æ®ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥æŒ‰æ—¶é—´æ¥åˆ é™¤é‡Œé¢çš„å†å²è®°å½•ï¼› é‡Œé¢æœ€å¤§çš„è¡¨æ˜¯ â€œhistoryâ€ å’Œ â€œhistory_uintâ€ä¸¤ä¸ªè¡¨ï¼› zabbixé‡Œé¢çš„æ—¶é—´æ˜¯ç”¨çš„æ—¶é—´æˆ³æ–¹å¼è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥è½¬æ¢ä¸€ä¸‹ï¼Œç„¶åæ ¹æ®æ—¶é—´æˆ³æ¥åˆ é™¤ï¼› æ¯”å¦‚è¦åˆ é™¤2012å¹´çš„11æœˆ25å·ä»¥å‰çš„æ•°æ® 1ã€å…ˆå°†æ ‡å‡†æ—¶é—´è½¬æ¢ä¸ºæ—¶é—´æˆ³</p><p># date +%s -d â€œ2012-11-25 00:00:00â€<br>1353772800</p><p>2ã€mysqlæ¸…ç†æ•°æ®</p><p>mysql&gt; use zabbix;<br>mysql&gt; DELETE FROM `history_uint` WHERE `clock` &lt; 1327939201;<br>mysql&gt; optimize table history_uint;</p><p>æ³¨ï¼šæ‰§è¡Œè¿‡ç¬¬äºŒè¡Œå‘½ä»¤ä¹‹åå¯èƒ½ä¼šéœ€è¦å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´ï¼Œä¸­é—´ä¸è¦Kæ‰äº†ï¼Œå¦åˆ™å®¹æ˜“ä¸¢å¤±æ•°æ®çš„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>LVS+Keepalived</title>
      <link href="/2014/10/31/lvskeepalived/"/>
      <url>/2014/10/31/lvskeepalived/</url>
      
        <content type="html"><![CDATA[<p>è¯´æ˜ï¼š æœ¬æ–‡æ¡£ä»…å›´ç»•lvs+keepalivedå¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ã€æ•…éšœå‰”é™¤ã€åç«¯realserverå¥åº·ç›‘æµ‹ã€ä¸»å¤‡åˆ‡æ¢é‚®ä»¶é€šçŸ¥;è€Œé˜²ç«å¢™ã€ç½‘ç»œ(è·¯ç”±äº¤æ¢)ã€åç«¯æ•°æ®å­˜å‚¨ã€å†…å¤–ç½‘æš‚æœªè€ƒè™‘; <strong>ä¸€ã€ç¯å¢ƒå‡†å¤‡ï¼š</strong> 1.æ“ä½œç³»ç»Ÿ</p><p>CentOS6.4-x86_64</p><p>2.è½¯ä»¶ç‰ˆæœ¬ï¼š</p><p>ipvsadm-1.25-10.el6.x86_64<br>keepalived-1.2.7-3.el6.x86_64<br>httpd-2.2.15-26.el6.centos.x86_64</p><p>3.å®éªŒæ‹“æ‰‘ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/1.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/1.png" alt="1"></a> 4.æ—¶é—´åŒæ­¥ï¼š</p><figure class="highlight autoit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">node1:</span><br><span class="line">\[root<span class="symbol">@node1</span> ~\]<span class="meta"># ntpdate 203.117.180.36</span></span><br><span class="line">\[root<span class="symbol">@node1</span> ~\]<span class="meta"># echo <span class="string">"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36"</span> &gt;&gt; /etc/crontab</span></span><br><span class="line">node2:</span><br><span class="line">\[root<span class="symbol">@node2</span> ~\]<span class="meta"># ntpdate 203.117.180.36</span></span><br><span class="line">\[root<span class="symbol">@node1</span> ~\]<span class="meta"># echo <span class="string">"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36"</span> &gt;&gt; /etc/crontab</span></span><br><span class="line">master:</span><br><span class="line">\[root<span class="symbol">@master</span> ~\]<span class="meta"># ntpdate 203.117.180.36</span></span><br><span class="line">\[root<span class="symbol">@master</span> ~\]<span class="meta"># echo <span class="string">"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36"</span> &gt;&gt; /etc/crontab</span></span><br><span class="line">Slave:</span><br><span class="line">\[root<span class="symbol">@slave</span> ~\]<span class="meta"># ntpdate 203.117.180.36</span></span><br><span class="line">\[root<span class="symbol">@slave</span> ~\]<span class="meta"># echo <span class="string">"*/10 * * * * /usr/sbin/ntpdate 203.117.180.36"</span> &gt;&gt; /etc/crontab</span></span><br></pre></td></tr></tbody></table></figure><p>5.ä¸»æœºåç›¸äº’è§£æï¼š</p><figure class="highlight accesslog"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">node1:</span><br><span class="line">\<span class="string">[root@node1 ~\]</span># cat /etc/hosts</span><br><span class="line"><span class="number">127.0.0.1</span>&nbsp;&nbsp; localhost localhost.localdomain localhost4 localhost4.localdomain4&nbsp;</span><br><span class="line">::<span class="number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; localhost localhost.localdomain localhost6 localhost6.localdomain6&nbsp;</span><br><span class="line"><span class="number">192.168.254.201</span>&nbsp;&nbsp;&nbsp; node1.test.com&nbsp;&nbsp;&nbsp; node1&nbsp;</span><br><span class="line"><span class="number">192.168.254.202</span>&nbsp;&nbsp;&nbsp; node2.test.com&nbsp;&nbsp;&nbsp; node2</span><br><span class="line">node2:</span><br><span class="line">\<span class="string">[root@node2 ~\]</span># cat /etc/hosts</span><br><span class="line"><span class="number">127.0.0.1</span>&nbsp;&nbsp; localhost localhost.localdomain localhost4 localhost4.localdomain4&nbsp;</span><br><span class="line">::<span class="number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; localhost localhost.localdomain localhost6 localhost6.localdomain6&nbsp;</span><br><span class="line"><span class="number">192.168.254.201</span>&nbsp;&nbsp;&nbsp; node1.test.com&nbsp;&nbsp;&nbsp; node1&nbsp;</span><br><span class="line"><span class="number">192.168.254.202</span>&nbsp;&nbsp;&nbsp; node2.test.com&nbsp;&nbsp;&nbsp; node2</span><br></pre></td></tr></tbody></table></figure><p>6.å®‰è£…yumæºï¼š(å…¶ä»–ä¸‰å°ä¸»æœºä¸Šé¢åŒæ ·æ‰§è¡Œä»¥ä¸‹ä¸¤æ¡å‘½ä»¤å³å¯ï¼Œå‰æ:èƒ½ä¸Šç½‘)</p><figure class="highlight crystal"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">node1:</span></span><br><span class="line">\[root<span class="variable">@node1</span>~\]<span class="comment">#</span></span><br><span class="line">rpm -ivh <span class="symbol">http:</span>/<span class="regexp">/download.fedoraproject.org/pub</span><span class="regexp">/epel/</span><span class="number">6</span>/x86_64/epel-release-<span class="number">6</span>-<span class="number">8</span>.noarch.rpm</span><br><span class="line">\[root<span class="variable">@node1</span> ~\]<span class="comment"># rpm -ivh http://elrepo.org/elrepo-release-6-5.el6.elrepo.noarch.rpm</span></span><br></pre></td></tr></tbody></table></figure><p>*<em>äºŒã€<strong><strong>web</strong></strong>èŠ‚ç‚¹å®‰è£…é…ç½®ï¼š</em>* å®‰è£…webæœåŠ¡å¹¶æ‰§è¡Œrealserver.sh,ä¸ºlo:0ç»‘å®šVIPåœ°å€192.168.254.200ï¼ŒæŠ‘åˆ¶ARPå¹¿æ’­; node1/node2é…ç½®ï¼š</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">\[root@node1 ~\]<span class="comment"># yum install -y httpd&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</span></span><br><span class="line">\[root@node1 ~\]<span class="comment"># echo "&lt;h1&gt;Rs1.test.com&lt;/h1&gt;" &gt; /var/www/html/index.html</span></span><br><span class="line">\[root@node1 ~\]<span class="comment"># service httpd start</span></span><br><span class="line">\[root@node1 ~\]<span class="comment"># chkconfig httpd on</span></span><br><span class="line">\[root@node1 ~\]<span class="comment"># mkdir script</span></span><br><span class="line">\[root@node1 ~\]<span class="comment"># cd script/</span></span><br><span class="line">\[root@node1 ~\]<span class="comment"># vim script/realserver.sh</span></span><br><span class="line"><span class="comment">#-&gt;LVSå®¢æˆ·ç«¯é…ç½®è„šæœ¬realserver.shï¼š</span></span><br><span class="line"><span class="comment">#!/bin/bash&nbsp;</span></span><br><span class="line">\<span class="comment"># Script to start LVS DR real server.&nbsp;&nbsp;</span></span><br><span class="line">\<span class="comment"># description: LVS DR real server&nbsp;&nbsp;</span></span><br><span class="line"></span><br><span class="line">.&nbsp; <span class="regexp">/etc/</span>rc.d<span class="regexp">/init.d/</span>functions</span><br><span class="line">VIP=<span class="number">192.168</span>.<span class="number">254.200</span>&nbsp;</span><br><span class="line">host=`<span class="regexp">/bin/</span>hostname`</span><br><span class="line">case <span class="string">"$1"</span> <span class="keyword">in</span>&nbsp;</span><br><span class="line">start)&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment"># Start LVS-DR real server on this machine.&nbsp;&nbsp;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="regexp">/sbin/i</span>fconfig lo down&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="regexp">/sbin/i</span>fconfig lo up&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="number">1</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4<span class="regexp">/conf/</span>lo/arp_ignore&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="number">2</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4<span class="regexp">/conf/</span>lo/arp_announce&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="number">1</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4<span class="regexp">/conf/</span>all/arp_ignore&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="number">2</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4<span class="regexp">/conf/</span>all/arp_announce</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="regexp">/sbin/i</span>fconfig lo:<span class="number">0</span> <span class="variable">$VIP</span> broadcast <span class="variable">$VIP</span> netmask <span class="number">255.255</span>.<span class="number">255.255</span> up&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="regexp">/sbin/</span>route add -host <span class="variable">$VIP</span> dev lo:<span class="number">0</span></span><br><span class="line">;;&nbsp;</span><br><span class="line"></span><br><span class="line">stop)</span><br><span class="line"></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment"># Stop LVS-DR real server loopback device(s).&nbsp;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="regexp">/sbin/i</span>fconfig lo:<span class="number">0</span> down&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="number">0</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4<span class="regexp">/conf/</span>lo/arp_ignore&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="number">0</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4<span class="regexp">/conf/</span>lo/arp_announce&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="number">0</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4<span class="regexp">/conf/</span>all/arp_ignore&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="number">0</span> &gt; <span class="regexp">/proc/</span>sys<span class="regexp">/net/i</span>pv4<span class="regexp">/conf/</span>all/arp_announce</span><br><span class="line">;;&nbsp;</span><br><span class="line"></span><br><span class="line">status)</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment"># Status of LVS-DR real server.&nbsp;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; islothere=`<span class="regexp">/sbin/i</span>fconfig lo:<span class="number">0</span> | grep <span class="variable">$VIP</span>`&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; isrothere=\`netstat -rn | grep <span class="string">"lo:0"</span> | grep <span class="variable">$VIP</span>\`&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="keyword">if</span> \[ ! <span class="string">"$islothere"</span> -o ! <span class="string">"isrothere"</span> \];then&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment"># Either the route or the lo:0 device&nbsp;&nbsp;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment"># not found.&nbsp;&nbsp;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="string">"LVS-DR real server Stopped."</span>&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="keyword">else</span>&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="string">"LVS-DR real server Running."</span>&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi&nbsp;&nbsp;</span><br><span class="line">;;&nbsp;&nbsp;</span><br><span class="line">*)&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment"># Invalid entry.&nbsp;&nbsp;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo <span class="string">"$0: Usage: $0 {start|status|stop}"</span>&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="keyword">exit</span> <span class="number">1</span>&nbsp;&nbsp;</span><br><span class="line"></span><br><span class="line">;;&nbsp;&nbsp;</span><br><span class="line">esac</span><br><span class="line">\[root@node1 ~\]<span class="comment"># chmod +x script/realserver.sh</span></span><br><span class="line">\[root@node1 ~\]<span class="comment"># ./script/realserver.sh start</span></span><br></pre></td></tr></tbody></table></figure><p>#-&gt;å°†è¯¥è„šæœ¬scpåˆ°node2èŠ‚ç‚¹æ‰§è¡Œ./script/realserver.sh startå³å¯</p><p>#-&gt;å¦‚æœæœåŠ¡å™¨é‡å¯ï¼Œé‚£è¿˜éœ€è¦æ‰‹åŠ¨çš„å»æ‰§è¡Œè¿™ä¸ªè„šæœ¬ï¼ŒæœåŠ¡ä¾¿ä¸å¯ä½¿ç”¨äº†ï¼Œæ‰€ä»¥å¯ä»¥å°†realserver.shåŠ å…¥åˆ°å¼€æœºå¯åŠ¨é¡¹ä¸­;</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\[root@node1 ~\]<span class="comment"># vim /etc/rc.local</span></span><br><span class="line"><span class="regexp">/bin/</span>bash <span class="regexp">/root/</span>script/realserver.sh start</span><br><span class="line">\[root@node1 ~\]<span class="comment"># scp /script/realserver 192.168.254.46:/root/script</span></span><br><span class="line"><span class="comment">#-&gt;æ•ˆæœå¦‚ä¸‹ï¼š</span></span><br><span class="line">[![<span class="number">2</span>](https:<span class="regexp">//</span>qcloud.coding.net<span class="regexp">/u/gu</span>omaoqiu<span class="regexp">/p/gu</span>omaoqiu<span class="regexp">/git/</span>raw<span class="regexp">/master/u</span>ploads<span class="regexp">/2014/</span><span class="number">10</span><span class="regexp">/2.png)](https:/</span><span class="regexp">/qcloud.coding.net/u</span><span class="regexp">/guomaoqiu/</span>p<span class="regexp">/guomaoqiu/gi</span>t<span class="regexp">/raw/m</span>aster<span class="regexp">/uploads/</span><span class="number">2014</span><span class="regexp">/10/</span><span class="number">2</span>.png) [![<span class="number">3</span>](https:<span class="regexp">//</span>qcloud.coding.net<span class="regexp">/u/gu</span>omaoqiu<span class="regexp">/p/gu</span>omaoqiu<span class="regexp">/git/</span>raw<span class="regexp">/master/u</span>ploads<span class="regexp">/2014/</span><span class="number">10</span><span class="regexp">/3.png)](https:/</span><span class="regexp">/qcloud.coding.net/u</span><span class="regexp">/guomaoqiu/</span>p<span class="regexp">/guomaoqiu/gi</span>t<span class="regexp">/raw/m</span>aster<span class="regexp">/uploads/</span><span class="number">2014</span><span class="regexp">/10/</span><span class="number">3</span>.png)</span><br><span class="line"><span class="comment">#-&gt;å®¢æˆ·ç«¯è®¿é—®æµ‹è¯•ï¼š</span></span><br><span class="line">[![<span class="number">4</span>](https:<span class="regexp">//</span>qcloud.coding.net<span class="regexp">/u/gu</span>omaoqiu<span class="regexp">/p/gu</span>omaoqiu<span class="regexp">/git/</span>raw<span class="regexp">/master/u</span>ploads<span class="regexp">/2014/</span><span class="number">10</span><span class="regexp">/4.png)](https:/</span><span class="regexp">/qcloud.coding.net/u</span><span class="regexp">/guomaoqiu/</span>p<span class="regexp">/guomaoqiu/gi</span>t<span class="regexp">/raw/m</span>aster<span class="regexp">/uploads/</span><span class="number">2014</span><span class="regexp">/10/</span><span class="number">4</span>.png)</span><br></pre></td></tr></tbody></table></figure><p>*<em>ä¸‰ã€<strong><strong>LVS-DR-Master/Slave</strong></strong>å®‰è£…é…ç½®ï¼š</em>* <strong>3.1.master/slave<strong><strong>éƒ½å®‰è£…</strong></strong>keepalived<strong><strong>å’Œ</strong></strong>ipvsadm :</strong></p><figure class="highlight less"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">master:</span><br><span class="line">\[root@master ~\]# yum install -<span class="attribute">y ipvsadm keepalived</span></span><br><span class="line"><span class="attribute">\[root@master ~\]# cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak&nbsp; #-&gt;ä¿®æ”¹é…ç½®æ–‡ä»¶ä¹‹å‰æœ€å¥½å°†è¯¥é…ç½®æ–‡ä»¶å¤‡ä»½ã€‚é¿å…åç»­å‡ºç°é—®é¢˜</span></span><br><span class="line"><span class="attribute">Slave</span>:</span><br><span class="line">\[root<span class="variable">@slave</span> ~\]# yum install -y ipvsadm keepalived</span><br><span class="line">\[root<span class="variable">@slave</span> ~\]# cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br><span class="line"></span><br><span class="line">**<span class="number">3.2</span>.****åœ¨****Lvs-DR-Master****ä¸Šé¢çš„é…ç½®ï¼š**</span><br><span class="line"></span><br><span class="line">\[root<span class="variable">@master</span> ~\]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">&nbsp;&nbsp; notification_email {</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="number">2399447849</span><span class="variable">@qq</span>.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#-&gt;#è®¾ç½®æŠ¥è­¦é‚®ä»¶åœ°å€ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªï¼Œæ¯è¡Œä¸€ä¸ª</span><br><span class="line">&nbsp;&nbsp; }</span><br><span class="line">&nbsp;&nbsp; <span class="selector-tag">notification</span>\<span class="selector-tag">_email</span>\<span class="selector-tag">_from</span> <span class="selector-tag">root</span>@<span class="selector-tag">localhost</span><span class="selector-class">.localdomain</span></span><br><span class="line">&nbsp;&nbsp; <span class="selector-tag">smtp_server</span> <span class="number">127.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="selector-id">#-</span>&gt;è®¾ç½®<span class="selector-tag">smtp</span> <span class="selector-tag">server</span>çš„åœ°å€</span><br><span class="line">&nbsp;&nbsp; <span class="selector-tag">smtp</span>\<span class="selector-tag">_connect</span>\<span class="selector-tag">_timeout</span> <span class="number">30</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="selector-id">#-</span>&gt;è®¾ç½®è¿æ¥<span class="selector-tag">smtp</span> <span class="selector-tag">server</span>çš„è¶…æ—¶æ—¶é—´</span><br><span class="line">&nbsp;&nbsp; <span class="selector-tag">router</span>\<span class="selector-tag">_id</span> <span class="selector-tag">LVS</span>\<span class="selector-tag">_DEVEL</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="selector-id">#-</span>&gt;è¡¨ç¤ºè¿è¡Œ<span class="selector-tag">keepalived</span>æœåŠ¡å™¨çš„ä¸€ä¸ªæ ‡è¯†ã€‚å‘é‚®ä»¶æ—¶æ˜¾ç¤ºåœ¨é‚®ä»¶ä¸»é¢˜çš„ä¿¡æ¯</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">vrrp</span>\<span class="selector-tag">_instance</span> <span class="selector-tag">VI</span>\<span class="selector-tag">_1</span> {</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">state</span> <span class="selector-tag">MASTER</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;æŒ‡å®š<span class="selector-tag">keepalived</span>çš„è§’è‰²ï¼Œ<span class="selector-tag">MASTER</span>è¡¨ç¤ºæ­¤ä¸»æœºæ˜¯ä¸»æœåŠ¡å™¨ï¼Œ<span class="selector-tag">BACKUP</span>è¡¨ç¤ºæ­¤ä¸»æœºæ˜¯å¤‡ç”¨æœåŠ¡å™¨</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">interface</span> <span class="selector-tag">eth0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;æŒ‡å®š<span class="selector-tag">HA</span>ç›‘æµ‹ç½‘ç»œçš„æ¥å£</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">virtual</span>\<span class="selector-tag">_router</span>\<span class="selector-tag">_id</span> <span class="number">60</span> &nbsp;<span class="selector-id">#-</span>&gt;è™šæ‹Ÿè·¯ç”±æ ‡è¯†ï¼Œè¿™ä¸ªæ ‡è¯†æ˜¯ä¸€ä¸ªæ•°å­—,åŒä¸€ä¸ª<span class="selector-tag">vrrp</span>å®ä¾‹ä½¿ç”¨å”¯ä¸€çš„æ ‡è¯†ã€‚å³åŒä¸€<span class="selector-tag">vrrp_instance</span>ä¸‹,<span class="selector-tag">MASTER</span>å’Œ<span class="selector-tag">BACKUP</span>&gt;å¿…é¡»æ˜¯ä¸€è‡´çš„</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">priority</span> <span class="number">101</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;å®šä¹‰ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œåœ¨åŒä¸€ä¸ª<span class="selector-tag">vrrp_instance</span>ä¸‹ï¼Œ<span class="selector-tag">MASTER</span>çš„ä¼˜å…ˆçº§å¿…é¡»å¤§äº<span class="selector-tag">BACKUP</span>çš„ä¼˜å…ˆçº§</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">advert_int</span> <span class="number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è®¾å®š<span class="selector-tag">MASTER</span>ä¸<span class="selector-tag">BACKUP</span>è´Ÿè½½å‡è¡¡å™¨ä¹‹é—´åŒæ­¥æ£€æŸ¥çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">authentication</span> {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è®¾ç½®éªŒè¯ç±»å‹å’Œå¯†ç </span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">auth_type</span> <span class="selector-tag">PASS</span>&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è®¾ç½®éªŒè¯ç±»å‹ï¼Œä¸»è¦æœ‰<span class="selector-tag">PASS</span>å’Œ<span class="selector-tag">AH</span>ä¸¤ç§</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">auth</span>\<span class="selector-tag">_pass</span> <span class="number">1111</span>&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è®¾ç½®éªŒè¯å¯†ç ï¼Œåœ¨åŒä¸€ä¸ª<span class="selector-tag">vrrp</span>\<span class="selector-tag">_instance</span>ä¸‹ï¼Œ<span class="selector-tag">MASTER</span>ä¸<span class="selector-tag">BACKUP</span>å¿…é¡»ä½¿ç”¨ç›¸åŒçš„å¯†ç æ‰èƒ½æ­£å¸¸é€šä¿¡</span><br><span class="line">&nbsp;&nbsp; }</span><br><span class="line"></span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">virtual_ipaddress</span> {&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è®¾ç½®è™šæ‹Ÿ<span class="selector-tag">IP</span>åœ°å€ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªè™šæ‹Ÿ<span class="selector-tag">IP</span>åœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">192.168</span><span class="selector-class">.254</span><span class="selector-class">.200</span>&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;å®¢æˆ·ç«¯é€šè¿‡è®¿é—®çš„å°±æ˜¯è¯¥<span class="selector-tag">IP</span>åœ°å€</span><br><span class="line">&nbsp;&nbsp;&nbsp; }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">virtual_server</span> <span class="number">192.168</span><span class="selector-class">.254</span><span class="selector-class">.200</span> <span class="number">80</span> {&nbsp; <span class="selector-id">#-</span>&gt;è®¾ç½®è™šæ‹ŸæœåŠ¡å™¨ï¼Œéœ€è¦æŒ‡å®šè™šæ‹Ÿ<span class="selector-tag">IP</span>åœ°å€å’ŒæœåŠ¡ç«¯å£ï¼Œ<span class="selector-tag">IP</span>ä¸ç«¯å£ä¹‹é—´ç”¨ç©ºæ ¼éš”å¼€</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">delay_loop</span> <span class="number">6</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è®¾ç½®è¿è¡Œæƒ…å†µæ£€æŸ¥æ—¶é—´ï¼Œå•ä½æ˜¯ç§’</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">lb_algo</span> <span class="selector-tag">rr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è®¾ç½®è´Ÿè½½è°ƒåº¦ç®—æ³•ï¼Œè¿™é‡Œè®¾ç½®ä¸º<span class="selector-tag">rr</span>ï¼Œå³è½®è¯¢ç®—æ³•</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">lb_kind</span> <span class="selector-tag">DR</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è®¾ç½®<span class="selector-tag">LVS</span>å®ç°è´Ÿè½½å‡è¡¡çš„æœºåˆ¶ï¼Œæœ‰<span class="selector-tag">NAT</span>ã€<span class="selector-tag">TUN</span>ã€<span class="selector-tag">DR</span>ä¸‰ä¸ªæ¨¡å¼å¯é€‰</span><br><span class="line"><span class="selector-tag">nat_mask</span> <span class="number">255.255</span><span class="selector-class">.255</span><span class="selector-class">.0</span></span><br><span class="line"><span class="selector-id">#persistence_timeout</span> <span class="number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;ä¼šè¯ä¿æŒæ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚è¿™ä¸ªé€‰é¡¹å¯¹åŠ¨æ€ç½‘é¡µæ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œä¸ºé›†ç¾¤ç³»ç»Ÿä¸­çš„<span class="selector-tag">session</span>å…±äº«æä¾›äº†ä¸€ä¸ªå¾ˆå¥½&gt;çš„è§£å†³æ–¹æ¡ˆã€‚</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;æœ‰äº†è¿™ä¸ªä¼šè¯ä¿æŒåŠŸèƒ½ï¼Œç”¨æˆ·çš„è¯·æ±‚ä¼šè¢«ä¸€ç›´åˆ†å‘åˆ°æŸä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œç›´åˆ°è¶…è¿‡è¿™ä¸ªä¼šè¯çš„ä¿æŒæ—¶é—´ã€‚</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªä¼šè¯ä¿æŒæ—¶é—´æ˜¯æœ€å¤§æ— å“åº”è¶…æ—¶æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·åœ¨æ“ä½œåŠ¨æ€é¡µé¢æ—¶ï¼Œå¦‚æœ<span class="number">50</span>ç§’å†…æ²¡</span><br><span class="line">æœ‰æ‰§è¡Œä»»ä½•æ“ä½œï¼Œ</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">protocol</span> <span class="selector-tag">TCP</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;æŒ‡å®šè½¬å‘åè®®ç±»å‹ï¼Œæœ‰<span class="selector-tag">TCP</span>å’Œ<span class="selector-tag">UDP</span>ä¸¤ç§</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">real_server</span> <span class="number">192.168</span><span class="selector-class">.254</span><span class="selector-class">.45</span> <span class="number">80</span>&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;é…ç½®æœåŠ¡èŠ‚ç‚¹<span class="number">1</span>ï¼Œéœ€è¦æŒ‡å®š<span class="selector-tag">real</span> <span class="selector-tag">server</span>çš„çœŸå®<span class="selector-tag">IP</span>åœ°å€å’Œç«¯å£ï¼Œ<span class="selector-tag">IP</span>ä¸ç«¯å£ä¹‹é—´ç”¨ç©ºæ ¼éš”å¼€</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">weight</span> <span class="number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;é…ç½®æœåŠ¡èŠ‚ç‚¹çš„æƒå€¼ï¼Œæƒå€¼å¤§å°ç”¨æ•°å­—è¡¨ç¤ºï¼Œæ•°å­—è¶Šå¤§ï¼Œæƒå€¼è¶Šé«˜ï¼Œè®¾ç½®æƒå€¼å¤§å°å¯ä»¥ä¸ºä¸åŒæ€§èƒ½çš„æœåŠ¡å™¨</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;åˆ†é…ä¸åŒçš„è´Ÿè½½ï¼Œå¯ä»¥ä¸ºæ€§èƒ½é«˜çš„æœåŠ¡å™¨è®¾ç½®è¾ƒé«˜çš„æƒå€¼ï¼Œè€Œä¸ºæ€§èƒ½è¾ƒä½çš„æœåŠ¡å™¨è®¾ç½®ç›¸å¯¹è¾ƒä½çš„æƒå€¼ï¼Œè¿™æ ·</span><br><span class="line">æ‰èƒ½åˆç†åœ°åˆ©ç”¨å’Œåˆ†é…ç³»ç»Ÿèµ„æº</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">HTTP_GET</span> {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;<span class="selector-tag">realserver</span>çš„çŠ¶æ€æ£€æµ‹è®¾ç½®éƒ¨åˆ†ï¼Œå•ä½æ˜¯ç§’</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">url</span> {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">path</span> /</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">status_code</span> <span class="number">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;çŠ¶æ€ç å®šä¹‰</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">connect_timeout</span> <span class="number">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è¡¨ç¤º<span class="number">3</span>ç§’æ— å“åº”è¶…æ—¶</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">nb</span>\<span class="selector-tag">_get</span>\<span class="selector-tag">_retry</span> <span class="number">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è¡¨ç¤ºé‡è¯•æ¬¡æ•°</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">delay</span>\<span class="selector-tag">_before</span>\<span class="selector-tag">_retry</span> <span class="number">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-id">#-</span>&gt;è¡¨ç¤ºé‡è¯•é—´éš”</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br><span class="line"></span><br><span class="line">&nbsp;&nbsp;&nbsp; }</span><br><span class="line"></span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="selector-tag">real_server</span> <span class="number">192.168</span><span class="selector-class">.254</span><span class="selector-class">.46</span> <span class="number">80</span> {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">weight</span> <span class="number">1</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">HTTP_GET</span> {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">url</span> {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">path</span> /</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">status_code</span> <span class="number">200</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">connect_timeout</span> <span class="number">3</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">nb</span>\<span class="selector-tag">_get</span>\<span class="selector-tag">_retry</span> <span class="number">3</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="selector-tag">delay</span>\<span class="selector-tag">_before</span>\<span class="selector-tag">_retry</span> <span class="number">3</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br><span class="line">&nbsp;&nbsp;&nbsp; }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>#-&gt;æ ¹æ®å®éªŒçš„æ‹“æ‰‘å¯çŸ¥åç«¯çš„realserveræœ‰ä¸¤å°ï¼Œæ‰€ä»¥ä¸Šé¢å®šä¹‰äº†ä¸¤ä¸ªrealserverçš„é…ç½®</p><p><strong>3.3<strong><strong>åœ¨</strong></strong>Lvs-DR-Slave****ä¸Šé¢çš„é…ç½®ï¼š</strong></p><p>[root@master ~]# scp /etc/keepalived/keepalived.conf 192.168.254.48:/etc/keepalived/&nbsp; #-&gt;å°†masterä¸Šé¢çš„é…ç½®å¤åˆ¶è‡³slave,ç„¶åç¨ä½œä¿®æ”¹ï¼š<br>[root@slave ~]# vim /etc/keepalived/keepalived.conf<br>#-&gt;é…ç½®æ–‡ä»¶å„ä¸ªå‚æ•°ä¸Šé¢ä»¥è§£é‡Šï¼Œè¿™é‡Œåªå¯¹éœ€è¦ä¿®æ”¹çš„ä½œè¯´æ˜ï¼š</p><figure class="highlight livescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">&nbsp;&nbsp; notification_email {</span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="number">2399447849</span>@qq.com</span><br><span class="line">&nbsp;&nbsp; }</span><br><span class="line">&nbsp;&nbsp; notification<span class="string">\_email\_from</span> root</span><br><span class="line">&nbsp;&nbsp; smtp_server <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">&nbsp;&nbsp; smtp<span class="string">\_connect\_timeout</span> <span class="number">30</span></span><br><span class="line">&nbsp;&nbsp; router<span class="string">\_id</span> LVS<span class="string">\_DEVEL</span></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">&nbsp;</span><br><span class="line"></span><br><span class="line">vrrp<span class="string">\_instance</span> VI<span class="string">\_1</span> {</span><br><span class="line">&nbsp;&nbsp;&nbsp; state BACKUP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">#-&gt;æŒ‡å®šè¯¥æœåŠ¡å™¨çš„keepalivedè§’è‰²ä¸ºBACKUP(å¤‡ç”¨æœåŠ¡å™¨)</span></span><br><span class="line">&nbsp;&nbsp;  interface eth0</span><br><span class="line">&nbsp;&nbsp;  virtual<span class="string">\_router\_id</span> <span class="number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp;&nbsp;&nbsp; priority <span class="number">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">#-&gt;åœ¨åŒä¸€ä¸ªvrrp_instanceä¸‹ï¼ŒMASTERçš„ä¼˜å…ˆçº§å¿…é¡»å¤§äºBACKUPçš„ä¼˜å…ˆçº§</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; advert_int <span class="number">1</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; authentication {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth_type PASS</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth_pass <span class="number">1111</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; }</span><br><span class="line"></span><br><span class="line">&nbsp;&nbsp;&nbsp; virtual_ipaddress {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">192.168</span>.<span class="number">254.200</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">&nbsp;</span><br><span class="line"></span><br><span class="line">virtual_server <span class="number">192.168</span>.<span class="number">254.200</span> <span class="number">80</span> {</span><br><span class="line">&nbsp;&nbsp;&nbsp; delay_loop <span class="number">6</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; lb_algo rr</span><br><span class="line">&nbsp;&nbsp;&nbsp; lb_kind DR</span><br><span class="line">&nbsp;&nbsp; nat_mask <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; <span class="comment">#persistence_timeout 50</span></span><br><span class="line">protocol TCP</span><br><span class="line">&nbsp;&nbsp; real_server <span class="number">192.168</span>.<span class="number">254.45</span> <span class="number">80</span>&nbsp; {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; weight <span class="number">1</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HTTP_GET {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; url {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; path /</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status_code <span class="number">200</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connect_timeout <span class="number">3</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nb<span class="string">\_get\_retry</span> <span class="number">3</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay<span class="string">\_before\_retry</span> <span class="number">3</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br><span class="line">&nbsp;&nbsp;&nbsp; }</span><br><span class="line">&nbsp;&nbsp;&nbsp; real_server <span class="number">192.168</span>.<span class="number">254.46</span> <span class="number">80</span> {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; weight <span class="number">1</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HTTP_GET {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; url {</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; path /</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; status_code <span class="number">200</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connect_timeout <span class="number">3</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nb<span class="string">\_get\_retry</span> <span class="number">3</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay<span class="string">\_before\_retry</span> <span class="number">3</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br><span class="line">&nbsp;&nbsp;&nbsp; }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>*<em>3.4.<strong><strong>å¯åŠ¨</strong></strong>keepalived (<strong><strong>å¯åŠ¨è¿‡ç¨‹ä¸­è§‚å¯Ÿæ—¥å¿—</strong></strong>)</em>*</p><figure class="highlight livescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br></pre></td><td class="code"><pre><span class="line">master:</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> service keepalived start &amp;&amp; tail -f /<span class="keyword">var</span>/log/messages</span><br><span class="line">...........</span><br><span class="line">...........</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">14</span> master Keepalived_healthcheckers<span class="string">\[31358\]:</span> Opening file <span class="string">'/etc/keepalived/keepalived.conf'</span>.</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">14</span> master Keepalived_healthcheckers<span class="string">\[31358\]:</span> Configuration <span class="keyword">is</span> <span class="keyword">using</span> : <span class="number">16384</span> Bytes</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">14</span> master Keepalived_healthcheckers<span class="string">\[31358\]:</span> Using LinkWatch kernel netlink reflector...</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">14</span> master Keepalived_healthcheckers<span class="string">\[31358\]:</span> Activating healthchecker <span class="keyword">for</span> service <span class="string">\[192.168.254.45\]:80</span></span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">14</span> master Keepalived_healthcheckers<span class="string">\[31358\]:</span> Activating healthchecker <span class="keyword">for</span> service <span class="string">\[192.168.254.46\]:80</span></span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">15</span> master Keepalived<span class="string">\_vrrp\[31359\]:</span> VRRP<span class="string">\_Instance(VI_1)</span> Transition <span class="keyword">to</span> MASTER STATE</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">16</span> master Keepalived<span class="string">\_vrrp\[31359\]:</span> VRRP<span class="string">\_Instance(VI_1)</span> Entering MASTER STATE&nbsp; <span class="comment">#-&gt;ä¸»æœåŠ¡å™¨çŠ¶æ€</span></span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">16</span> master Keepalived<span class="string">\_vrrp\[31359\]:</span> VRRP<span class="string">\_Instance(VI_1)</span> setting protocol VIPs.</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">16</span> master Keepalived<span class="string">\_vrrp\[31359\]:</span> VRRP<span class="string">\_Instance(VI_1)</span> Sending gratuitous ARPs <span class="literal">on</span> eth0 <span class="keyword">for</span> <span class="number">192.168</span>.<span class="number">254.200</span></span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">16</span> master Keepalived_healthcheckers<span class="string">\[31358\]:</span> Netlink reflector reports IP <span class="number">192.168</span>.<span class="number">254.200</span> added</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">21</span> master Keepalived<span class="string">\_vrrp\[31359\]:</span> VRRP<span class="string">\_Instance(VI_1)</span> Sending gratuitous ARPs <span class="literal">on</span> eth0 <span class="keyword">for</span> <span class="number">192.168</span>.<span class="number">254.200</span></span><br><span class="line">...........</span><br><span class="line">...........</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> ipvsadm -L â€“n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">#-&gt;LVSçŠ¶æ€</span></span><br><span class="line">IP Virtual Server version <span class="number">1.2</span>.<span class="number">1</span> (size=<span class="number">4096</span>)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">&nbsp; -<span class="string">\&gt;</span> RemoteAddress:Port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Forward Weight ActiveConn InActConn</span><br><span class="line">TCP&nbsp; <span class="number">192.168</span>.<span class="number">254.200</span>:<span class="number">80</span> rr</span><br><span class="line">&nbsp; -<span class="string">\&gt;</span> <span class="number">192.168</span>.<span class="number">254.45</span>:<span class="number">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Route&nbsp;&nbsp; <span class="number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp; -<span class="string">\&gt;</span> <span class="number">192.168</span>.<span class="number">254.46</span>:<span class="number">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Route&nbsp;&nbsp; <span class="number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> ip a</span><br><span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">16436</span> qdisc noqueue state UNKNOWN</span><br><span class="line">&nbsp;&nbsp;&nbsp; link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; inet <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">&nbsp;&nbsp;&nbsp; inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; valid<span class="string">\_lft</span> forever preferred<span class="string">\_lft</span> forever</span><br><span class="line"><span class="number">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER<span class="string">\_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo<span class="string">\_fast</span> state UP qlen <span class="number">1000</span></span><br><span class="line">&nbsp;&nbsp; link/ether <span class="number">00</span>:<span class="number">0c</span>:<span class="number">29</span>:<span class="number">5d</span>:<span class="number">7d</span>:<span class="number">94</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">&nbsp;&nbsp;&nbsp; inet <span class="number">192.168</span>.<span class="number">254.47</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">254.255</span> scope global eth0</span><br><span class="line">&nbsp;&nbsp;&nbsp; inet <span class="number">192.168</span>.<span class="number">254.200</span>/<span class="number">32</span> scope global eth0&nbsp;&nbsp;&nbsp; <span class="comment">#-&gt;æ­¤æ—¶VIPåœ¨masterä¸Šé¢</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; inet6 fe80::<span class="number">20c</span>:<span class="number">29ff</span>:fe5d:<span class="number">7d</span>94/<span class="number">64</span> scope link</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; valid<span class="string">\_lft</span> forever preferred<span class="string">\_lft</span> forever</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span></span><br><span class="line">Slave:</span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span> service keepalived start &amp;&amp; tail -f /<span class="keyword">var</span>/log/messages</span><br><span class="line">...........</span><br><span class="line">...........</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">34</span> slave Keepalived_vrrp<span class="string">\[31389\]:</span> Opening file <span class="string">'/etc/keepalived/keepalived.conf'</span>.</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">34</span> slave Keepalived_vrrp<span class="string">\[31389\]:</span> Configuration <span class="keyword">is</span> <span class="keyword">using</span> : <span class="number">62845</span> Bytes</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">34</span> slave Keepalived_vrrp<span class="string">\[31389\]:</span> Using LinkWatch kernel netlink reflector...</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">34</span> slave Keepalived<span class="string">\_vrrp\[31389\]:</span> VRRP<span class="string">\_Instance(VI_1)</span> Entering BACKUP STATE&nbsp; <span class="comment">#-&gt;å¤‡ç”¨æœåŠ¡å™¨çŠ¶æ€</span></span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">34</span> slave Keepalived_vrrp<span class="string">\[31389\]:</span> VRRP sockpool: <span class="string">\[ifindex(2),</span> proto(<span class="number">112</span>), fd(<span class="number">10</span>,<span class="number">11</span>)<span class="string">\]</span></span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">34</span> slave Keepalived_healthcheckers<span class="string">\[31388\]:</span> Opening file <span class="string">'/etc/keepalived/keepalived.conf'</span>.</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">34</span> slave Keepalived_healthcheckers<span class="string">\[31388\]:</span> Configuration <span class="keyword">is</span> <span class="keyword">using</span> : <span class="number">16384</span> Bytes</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">34</span> slave Keepalived_healthcheckers<span class="string">\[31388\]:</span> Using LinkWatch kernel netlink reflector...</span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">34</span> slave Keepalived_healthcheckers<span class="string">\[31388\]:</span> Activating healthchecker <span class="keyword">for</span> service <span class="string">\[192.168.254.45\]:80</span></span><br><span class="line">Oct <span class="number">29</span> <span class="number">21</span>:<span class="number">42</span>:<span class="number">34</span> slave Keepalived_healthcheckers<span class="string">\[31388\]:</span> Activating healthchecker <span class="keyword">for</span> service <span class="string">\[192.168.254.46\]:80</span></span><br><span class="line">...........</span><br><span class="line">...........</span><br><span class="line"></span><br><span class="line">**<span class="number">3.5</span>.****æµ‹è¯•ï¼š** [![<span class="number">5</span>](https:<span class="regexp">//qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/5.png)](https://</span>qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/<span class="number">2014</span>/<span class="number">10</span>/<span class="number">5.png</span>) **<span class="number">3.6</span>.****æ¨¡æ‹Ÿæ•…éšœ**ï¼š (<span class="number">1</span>)åœæ‰node1èŠ‚ç‚¹çš„webæœåŠ¡ï¼š</span><br><span class="line"></span><br><span class="line"><span class="string">\[root@node1</span> ~<span class="string">\]#</span> service httpd stop</span><br><span class="line">åœæ­¢ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"><span class="string">\[root@node1</span> ~<span class="string">\]#</span></span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)æŸ¥çœ‹ä¸€ä¸‹æŠ¥è­¦é‚®ä»¶ï¼š [![<span class="number">6</span>](https:<span class="regexp">//qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/6.png)](https://</span>qcloud.coding.net<span class="regexp">/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/6.png) (3)å†åœ¨å‰ç«¯è°ƒåº¦å™¨ä¸ŠæŸ¥çœ‹ä¸€ä¸‹LVSçŠ¶æ€ï¼š [![7](https:/</span><span class="regexp">/qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/7.png)](https:/</span>/qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/<span class="number">2014</span>/<span class="number">10</span>/<span class="number">7.png</span>) å¾ˆæ˜æ˜¾é‚£å°å‡ºç°é—®é¢˜çš„realserveræ¡ç›®å·²ç»è¢«å‰”é™¤äº† (<span class="number">4</span>)æ¢å¤node1èŠ‚ç‚¹ä¸Šçš„webæœåŠ¡ï¼š</span><br><span class="line"></span><br><span class="line"><span class="string">\[root@node1</span> ~<span class="string">\]#</span> service httpd start</span><br><span class="line">å¯åŠ¨ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"><span class="string">\[root@node1</span> ~<span class="string">\]#</span></span><br><span class="line"></span><br><span class="line">(<span class="number">5</span>) æŸ¥çœ‹ä¸€ä¸‹æŠ¥è­¦é‚®ä»¶ï¼š [![<span class="number">8</span>](https:<span class="regexp">//qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/8.png)](https://</span>qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/<span class="number">2014</span>/<span class="number">10</span>/<span class="number">8.png</span>) (<span class="number">6</span>)å…³é—­masterä¸Šé¢çš„keepalivedï¼š</span><br><span class="line"></span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> service keepalived stop</span><br><span class="line">åœæ­¢ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> ipvsadm -L -n</span><br><span class="line">IP Virtual Server version <span class="number">1.2</span>.<span class="number">1</span> (size=<span class="number">4096</span>)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">&nbsp; -<span class="string">\&gt;</span> RemoteAddress:Port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Forward Weight ActiveConn InActConn</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span></span><br><span class="line"></span><br><span class="line">(<span class="number">7</span>)æŸ¥çœ‹slaveçŠ¶æ€ï¼š</span><br><span class="line"></span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span> ip a</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">&nbsp;&nbsp;&nbsp; inet <span class="number">192.168</span>.<span class="number">254.200</span>/<span class="number">32</span> scope global eth0&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">#-&gt;å¯è§VIPå·²ç»è½¬ç§»åˆ°äº†slaveä¸Šé¢ï¼›å¹¶ä¸”é€šè¿‡å®¢æˆ·ç«¯è®¿é—®ä»ç„¶æ­£å¸¸ï¼</span></span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">&nbsp;<span class="string">\[root@slave</span> ~<span class="string">\]#</span> ipvsadm -L -n</span><br><span class="line">IP Virtual Server version <span class="number">1.2</span>.<span class="number">1</span> (size=<span class="number">4096</span>)</span><br><span class="line"></span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"></span><br><span class="line">&nbsp; -<span class="string">\&gt;</span> RemoteAddress:Port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Forward Weight ActiveConn InActConn</span><br><span class="line"></span><br><span class="line">TCP&nbsp; <span class="number">192.168</span>.<span class="number">254.200</span>:<span class="number">80</span> rr</span><br><span class="line">&nbsp; -<span class="string">\&gt;</span> <span class="number">192.168</span>.<span class="number">254.45</span>:<span class="number">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Route&nbsp;&nbsp; <span class="number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line">&nbsp; -<span class="string">\&gt;</span> <span class="number">192.168</span>.<span class="number">254.46</span>:<span class="number">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Route&nbsp;&nbsp; <span class="number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span></span><br><span class="line"></span><br><span class="line">**é€šè¿‡ä¸Šé¢çš„æ¼”ç¤ºç°åœ¨çš„****LVS****çš„é«˜å¯ç”¨å³å‰ç«¯è´Ÿè½½å‡è¡¡è°ƒåº¦å™¨çš„é«˜å¯ç”¨ï¼ŒåŒæ—¶å®ç°äº†å¯¹åç«¯****realserver****ç›‘æ§ï¼Œä¹Ÿå®ç°äº†åç«¯****realserver****å®•æœºæ—¶ä¼šç»™ç®¡ç†å‘˜å‘é€é‚®ä»¶ï¼›ä½†æ˜¯ç›®å‰è¿˜é¢ä¸´å‡ ä¸ªé—®é¢˜ï¼š**</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>  **å¦‚æœæ‰€æœ‰çš„****realserver****éƒ½å®•æœºï¼Œå¦‚ä½•å¤„ç†ï¼Œç”¨æˆ·æ‰“ä¸å¼€å°±ç­‰å®ƒæ‰“ä¸å¼€ï¼Œè¿˜æ˜¯å‹å–„çš„æç¤ºä¸€ä¸‹ï¼Ÿ**</span><br><span class="line"><span class="number">2.</span>  **æ€ä¹ˆå®Œæˆç»´æŠ¤æ¨¡å¼****keepalived****åˆ‡æ¢ï¼Ÿ**</span><br><span class="line"><span class="number">3.</span>  **å¦‚ä½•åœ¨****keepalived****ä¸»å¤‡åˆ‡æ¢æ—¶å‘ç®¡ç†å‘˜å‘é€é‚®ä»¶ï¼Ÿ**</span><br><span class="line"></span><br><span class="line">**å››ã€****LVS+Keepalived****åç»­å»¶ä¼¸ï¼š** **<span class="number">4.1</span>.****æ‰€æœ‰****realserver****éƒ½å®•æœºå¦‚ä½•å¤„ç†ï¼Ÿ** åœ¨é›†ç¾¤ä¸­å¦‚æœæ‰€æœ‰real serverå…¨éƒ¨å®•æœºäº†ï¼Œå®¢æˆ·ç«¯è®¿é—®æ—¶å°±ä¼šå‡ºç°é”™è¯¯é¡µé¢ï¼Œè¿™æ ·æ˜¯å¾ˆä¸å‹å¥½çš„ï¼Œæˆ‘ä»¬å¾—æä¾›ä¸€ä¸ªç»´æŠ¤é¡µé¢æ¥æé†’ç”¨æˆ·ï¼ŒæœåŠ¡å™¨æ­£åœ¨ç»´æŠ¤ï¼Œä»€ä¹ˆæ—¶é—´å¯ä»¥è®¿é—®ç­‰ï¼Œä¸‹é¢å°±æ¥è§£å†³ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æä¾›ä¸€å°å¤‡ç”¨çš„real serverå½“æ‰€æœ‰çš„æœåŠ¡å™¨å®•æœºæ—¶ï¼Œæä¾›ç»´æŠ¤é¡µé¢ï¼Œä½†è¿™æ ·åšæœ‰ç‚¹æµªè´¹æœåŠ¡å™¨ã€‚å¦ä¸€ç§å°±æ˜¯åœ¨è´Ÿè½½å‡è¡¡å™¨ä¸Šæä¾›ç»´æŠ¤é¡µé¢ï¼Œè¿™æ ·æ˜¯æ¯”è¾ƒé è°±çš„ï¼Œä¹Ÿæ¯”è¾ƒå¸¸ç”¨ã€‚ä¸‹é¢å°±æ¥å…·ä½“æ“ä½œä¸€ä¸‹ã€‚ (<span class="number">1</span>)åœ¨masterå’Œslaveä¸Šé¢å®‰è£…httpd</span><br><span class="line"></span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> yum install -y httpd</span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span> yum install -y httpd</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)æä¾›ç»´æŠ¤é¡µé¢æ–‡ä»¶</span><br><span class="line"></span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> echo <span class="string">"Oops ... you visit the page does not exist, the server may be maintained?"</span> &gt; /<span class="keyword">var</span>/www/html/index.html</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> service httpd start</span><br><span class="line">å¯åŠ¨ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span> echo <span class="string">"Oops ... you visit the page does not exist, the server may be maintained?"</span> &gt; /<span class="keyword">var</span>/www/html/index.html</span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span> service httpd start</span><br><span class="line">å¯åŠ¨ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"></span><br><span class="line">(<span class="number">3</span>)æµ‹è¯•ï¼š [![<span class="number">9</span>](https:<span class="regexp">//qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/9.png)](https://</span>qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/<span class="number">2014</span>/<span class="number">10</span>/<span class="number">9.png</span>) (<span class="number">4</span>)ä¿®æ”¹master/slaveçš„keepalivedé…ç½®æ–‡ä»¶ï¼š</span><br><span class="line"></span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">notification_email {</span><br><span class="line"><span class="number">2399447849</span>@qq.com</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">notification<span class="string">\_email\_from</span> root</span><br><span class="line">smtp_server <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">smtp<span class="string">\_connect\_timeout</span> <span class="number">30</span></span><br><span class="line">router<span class="string">\_id</span> LVS<span class="string">\_DEVEL</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp<span class="string">\_instance</span> VI<span class="string">\_1</span> {</span><br><span class="line">state MASTER</span><br><span class="line">interface eth0</span><br><span class="line">       virtual<span class="string">\_router\_id</span> <span class="number">60</span></span><br><span class="line">       priority <span class="number">101</span></span><br><span class="line">       advert_int <span class="number">1</span></span><br><span class="line">      authentication {</span><br><span class="line">       auth_type PASS</span><br><span class="line">      auth_pass <span class="number">1111</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">virtual_ipaddress {</span><br><span class="line">     <span class="number">192.168</span>.<span class="number">254.200</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">virtual_server <span class="number">192.168</span>.<span class="number">254.200</span> <span class="number">80</span> {</span><br><span class="line">delay_loop <span class="number">6</span></span><br><span class="line">lb_algo rr</span><br><span class="line">lb_kind DR</span><br><span class="line">nat_mask <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line"><span class="comment">#persistence_timeout 50</span></span><br><span class="line">protocol TCP</span><br><span class="line"></span><br><span class="line">real_server <span class="number">192.168</span>.<span class="number">254.45</span> <span class="number">80</span>&amp;nbsp; {</span><br><span class="line">weight <span class="number">1</span></span><br><span class="line">HTTP_GET {</span><br><span class="line"></span><br><span class="line">  url {</span><br><span class="line">   path /</span><br><span class="line">   status_code <span class="number">200</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">connect_timeout <span class="number">3</span></span><br><span class="line">nb<span class="string">\_get\_retry</span> <span class="number">3</span></span><br><span class="line">delay<span class="string">\_before\_retry</span> <span class="number">3</span></span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">real_server <span class="number">192.168</span>.<span class="number">254.46</span> <span class="number">80</span> {</span><br><span class="line">weight <span class="number">1</span></span><br><span class="line">HTTP_GET {</span><br><span class="line">url {</span><br><span class="line">path /</span><br><span class="line">status_code <span class="number">200</span></span><br><span class="line">}</span><br><span class="line">connect_timeout <span class="number">3</span></span><br><span class="line">nb<span class="string">\_get\_retry</span> <span class="number">3</span></span><br><span class="line">delay<span class="string">\_before\_retry</span> <span class="number">3</span></span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">sorry_server <span class="number">127.0</span>.<span class="number">0.1</span>&amp;nbsp;&amp;nbsp; <span class="comment">#-&gt;å¢åŠ è¯¥é…ç½®å‚æ•°ï¼Œslaveä¸Šé¢ä¹Ÿéœ€è¦æ·»åŠ ï¼Œæ­¤å¤„ç•¥ã€‚</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">(<span class="number">5</span>)å…³é—­æ‰€æœ‰çš„realserver webæœåŠ¡,é‡æ–°å¯åŠ¨master/slave çš„keepalived: &nbsp;</span><br><span class="line"></span><br><span class="line">node1:</span><br><span class="line"><span class="string">\[root@node1</span> ~<span class="string">\]#</span> service httpd stop</span><br><span class="line">åœæ­¢ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"><span class="string">\[root@node1</span> ~<span class="string">\]#</span></span><br><span class="line">node2:</span><br><span class="line"><span class="string">\[root@node2</span> ~<span class="string">\]#</span> service httpd stop</span><br><span class="line">åœæ­¢ httpdï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"><span class="string">\[root@node2</span> ~<span class="string">\]#</span></span><br><span class="line">master:</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> service keepalived restart</span><br><span class="line">åœæ­¢ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line">æ­£åœ¨å¯åŠ¨ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span></span><br><span class="line">slave:</span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span> service keepalived restart</span><br><span class="line">åœæ­¢ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line">æ­£åœ¨å¯åŠ¨ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span></span><br><span class="line"></span><br><span class="line">(<span class="number">6</span>)æŸ¥çœ‹ä¸€ä¸‹LVSçŠ¶æ€ï¼š [![<span class="number">10</span>](https:<span class="regexp">//qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/10.png)](https://</span>qcloud.coding.net<span class="regexp">/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/10.png) (7)è®¿é—®æµ‹è¯•ï¼š [![11](https:/</span><span class="regexp">/qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/11.png)](https:/</span>/qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/<span class="number">2014</span>/<span class="number">10</span>/<span class="number">11.png</span>) **<span class="number">4.2</span>.****å¦‚ä½•å®Œæˆç»´æŠ¤æ¨¡å¼****keepalived** **åˆ‡æ¢ï¼Ÿ** ä¸€èˆ¬æˆ‘ä»¬åœ¨æµ‹è¯•ä¸»ä»åˆ‡æ¢çš„è¿‡ç¨‹å½“ä¸­è¦ä¹ˆæ˜¯æ‰‹åŠ¨åœæ­¢keepalivedæœåŠ¡ï¼Œè¦ä¹ˆæ˜¯æ‰‹åŠ¨å…³é—­ç½‘å¡ï¼Œé‚£è¿˜æœ‰å…¶ä»–æ–¹æ³•å®ç°ç»´æŠ¤æ¨¡å¼çš„åˆ‡æ¢ï¼Œè¿™å°±æ˜¯vrrp_scriptåŠŸèƒ½ï¼› (<span class="number">1</span>)master/slaveé…ç½®ï¼š**(****æ³¨****:****è¿™é‡Œæ¼”ç¤ºä¸»æœåŠ¡å™¨çš„é…ç½®ï¼Œæ·»åŠ ä¸Šå»çš„åœ¨****slave****ä¸Šé¢ä¹Ÿéœ€è¦æ·»åŠ ä»¥çº¢è‰²æ ‡æ³¨å†…å®¹****)**</span><br><span class="line"></span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line"></span><br><span class="line">notification_email {</span><br><span class="line"><span class="number">2399447849</span>@qq.com</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">notification<span class="string">\_email\_from</span> root</span><br><span class="line">smtp_server <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">smtp<span class="string">\_connect\_timeout</span> <span class="number">30</span></span><br><span class="line">router<span class="string">\_id</span> LVS<span class="string">\_DEVEL</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp<span class="string">\_script</span> chk<span class="string">\_schedown</span> {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">#-&gt;å®šä¹‰vrrpæ‰§è¡Œè„šæœ¬</span></span><br><span class="line">&nbsp;&nbsp; script <span class="string">"\[ -e /etc/keepalived/down \] &amp;&amp; exit 1 || exit 0"</span> &nbsp;<span class="comment">#-&gt;æŸ¥çœ‹æ˜¯å¦æœ‰downæ–‡ä»¶ï¼Œæœ‰å°±è¿›å…¥ç»´æŠ¤æ¨¡å¼</span></span><br><span class="line">&nbsp;&nbsp; interval <span class="number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">#-&gt;ç›‘æ§é—´éš”æ—¶é—´</span></span><br><span class="line">&nbsp;&nbsp; weight -<span class="number">5</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">#-&gt;é™ä½ä¼˜å…ˆçº§,å³priorityå‚æ•°</span></span><br><span class="line">&nbsp;&nbsp; fall <span class="number">2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">#-&gt;å¤±è´¥æ¬¡æ•°</span></span><br><span class="line">&nbsp;&nbsp; rise <span class="number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">#-&gt;æˆåŠŸæ¬¡æ•°</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp<span class="string">\_instance</span> VI<span class="string">\_1</span> {</span><br><span class="line">state MASTER</span><br><span class="line">interface eth0</span><br><span class="line">virtual<span class="string">\_router\_id</span> <span class="number">60</span></span><br><span class="line">priority <span class="number">101</span></span><br><span class="line">advert_int <span class="number">1</span></span><br><span class="line">authentication {</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass <span class="number">1111</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">virtual_ipaddress {</span><br><span class="line"><span class="number">192.168</span>.<span class="number">254.200</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">track_script {&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">#-&gt;è„šæœ¬è¿½è¸ª</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; chk_schedown&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<span class="comment">#-&gt;ä¸Šé¢è‡ªå®šä¹‰çš„vrrpè„šæœ¬åç§°</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">virtual_server <span class="number">192.168</span>.<span class="number">254.200</span> <span class="number">80</span> {</span><br><span class="line">delay_loop <span class="number">6</span></span><br><span class="line">lb_algo rr</span><br><span class="line">lb_kind DR</span><br><span class="line">nat_mask <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line"><span class="comment">#persistence_timeout 50</span></span><br><span class="line">protocol TCP</span><br><span class="line">&nbsp;</span><br><span class="line">real_server <span class="number">192.168</span>.<span class="number">254.45</span> <span class="number">80</span>&nbsp; {</span><br><span class="line">weight <span class="number">1</span></span><br><span class="line">HTTP_GET {</span><br><span class="line">url {</span><br><span class="line">path /</span><br><span class="line">status_code <span class="number">200</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">connect_timeout <span class="number">3</span></span><br><span class="line">nb<span class="string">\_get\_retry</span> <span class="number">3</span></span><br><span class="line">delay<span class="string">\_before\_retry</span> <span class="number">3</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">real_server <span class="number">192.168</span>.<span class="number">254.46</span> <span class="number">80</span> {</span><br><span class="line">weight <span class="number">1</span></span><br><span class="line">HTTP_GET {</span><br><span class="line">url {</span><br><span class="line">path /</span><br><span class="line">status_code <span class="number">200</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">connect_timeout <span class="number">3</span></span><br><span class="line">nb<span class="string">\_get\_retry</span> <span class="number">3</span></span><br><span class="line">delay<span class="string">\_before\_retry</span> <span class="number">3</span></span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">sorry_server <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)æµ‹è¯•ï¼š </span><br><span class="line"></span><br><span class="line">master:</span><br><span class="line"><span class="string">\[root@master</span> keepalived<span class="string">\]#</span> touch down &nbsp;<span class="comment">#-&gt;æ–°å»ºä¸€ä¸ªdownæ–‡ä»¶ï¼Œè¿›å…¥ç»´æŠ¤æ¨¡å¼</span></span><br><span class="line"><span class="string">\[root@master</span> keepalived<span class="string">\]#</span> ll</span><br><span class="line">æ€»ç”¨é‡ <span class="number">4</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root&nbsp;&nbsp;&nbsp; <span class="number">0</span> <span class="number">10</span>æœˆ <span class="number">30</span> <span class="number">00</span>:<span class="number">16</span> down</span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">1513</span> <span class="number">10</span>æœˆ <span class="number">30</span> <span class="number">00</span>:<span class="number">08</span> keepalived.conf</span><br><span class="line"><span class="string">\[root@master</span> keepalived<span class="string">\]#</span> tail -f /<span class="keyword">var</span>/log/messages</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">Oct <span class="number">30</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">43</span> node3 Keepalived<span class="string">\_vrrp\[31993\]:</span> VRRP<span class="string">\_Script(chk_schedown)</span> failed</span><br><span class="line">Oct <span class="number">30</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">44</span> node3 Keepalived<span class="string">\_vrrp\[31993\]:</span> VRRP<span class="string">\_Instance(VI_1)</span> Received higher prio advert</span><br><span class="line">Oct <span class="number">30</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">44</span> node3 Keepalived<span class="string">\_vrrp\[31993\]:</span> VRRP<span class="string">\_Instance(VI_1)</span> Entering BACKUP STATE</span><br><span class="line">Oct <span class="number">30</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">44</span> node3 Keepalived<span class="string">\_vrrp\[31993\]:</span> VRRP<span class="string">\_Instance(VI_1)</span> removing protocol VIPs.</span><br><span class="line">Oct <span class="number">30</span> <span class="number">00</span>:<span class="number">16</span>:<span class="number">44</span> node3 Keepalived_healthcheckers<span class="string">\[31992\]:</span> Netlink reflector reports IP <span class="number">192.168</span>.<span class="number">254.200</span> removed&nbsp; <span class="comment">#-&gt;è¯¥VIPå·²è½¬ç§»åˆ°slave.</span></span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line"><span class="string">\[root@master</span> keepalived<span class="string">\]#</span> ip a&nbsp;&nbsp; <span class="comment">#-&gt;VIP å·²è½¬ç§»åˆ°slave</span></span><br><span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">16436</span> qdisc noqueue state UNKNOWN</span><br><span class="line">link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">inet <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">valid<span class="string">\_lft</span> forever preferred<span class="string">\_lft</span> forever</span><br><span class="line"><span class="number">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER<span class="string">\_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo<span class="string">\_fast</span> state UP qlen <span class="number">1000</span></span><br><span class="line">link/ether <span class="number">00</span>:<span class="number">0c</span>:<span class="number">29</span>:<span class="number">5d</span>:<span class="number">7d</span>:<span class="number">94</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet <span class="number">192.168</span>.<span class="number">254.47</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">254.255</span> scope global eth0</span><br><span class="line">inet6 fe80::<span class="number">20c</span>:<span class="number">29ff</span>:fe5d:<span class="number">7d</span>94/<span class="number">64</span> scope link</span><br><span class="line">valid<span class="string">\_lft</span> forever preferred<span class="string">\_lft</span> forever</span><br><span class="line"><span class="string">\[root@master</span> keepalived<span class="string">\]#</span></span><br><span class="line">slave:</span><br><span class="line"><span class="string">\[root@slave</span> keepalived<span class="string">\]#</span> ip a</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">inet <span class="number">192.168</span>.<span class="number">254.200</span>/<span class="number">32</span> scope global eth0&nbsp;&nbsp; <span class="comment">#-&gt;VIP å·²è½¬ç§»è¿‡æ¥</span></span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line"><span class="string">\[root@slave</span> keepalived<span class="string">\]#</span></span><br><span class="line"></span><br><span class="line">&nbsp; **è‡³æ­¤è‡ªå†™ç›‘æµ‹è„šæœ¬ï¼Œå®Œæˆç»´æŠ¤æ¨¡å¼åˆ‡æ¢ï¼Œå·²ç»å®Œæˆï¼›ä¸‹é¢æ¥è§£å†³æœ€åä¸€ä¸ªé—®é¢˜ï¼š** **<span class="number">4.3</span>.****å¦‚ä½•åœ¨****Keepalived****ä¸»ä»åˆ‡æ¢æ—¶å‘ç®¡ç†å‘˜å‘é€é€šçŸ¥é‚®ä»¶ï¼Ÿ** (<span class="number">1</span>)Keepalivedé€šçŸ¥è„šæœ¬è¿›é˜¶ç¤ºä¾‹ï¼š</span><br><span class="line"></span><br><span class="line">ä¸‹é¢çš„è„šæœ¬å¯ä»¥æ¥å—é€‰é¡¹ï¼Œå…¶ä¸­ï¼š</span><br><span class="line">-s, --service SERVICE,...ï¼šæŒ‡å®šæœåŠ¡è„šæœ¬åç§°ï¼Œå½“çŠ¶æ€åˆ‡æ¢æ—¶å¯è‡ªåŠ¨å¯åŠ¨ã€é‡å¯æˆ–å…³é—­æ­¤æœåŠ¡ï¼›</span><br><span class="line">-a, --address VIP: æŒ‡å®šç›¸å…³è™šæ‹Ÿè·¯ç”±å™¨çš„VIPåœ°å€ï¼›</span><br><span class="line">-m, --mode {mm|mb}ï¼šæŒ‡å®šè™šæ‹Ÿè·¯ç”±çš„æ¨¡å‹ï¼Œmmè¡¨ç¤ºä¸»ä¸»ï¼Œmbè¡¨ç¤ºä¸»å¤‡ï¼›å®ƒä»¬è¡¨ç¤ºç›¸å¯¹äºåŒä¸€ç§æœåŠ¡è€Œæ–¹ï¼Œå…¶VIPçš„å·¥ä½œç±»å‹ï¼›</span><br><span class="line">-n, --notify {master|backup|fault}ï¼šæŒ‡å®šé€šçŸ¥çš„ç±»å‹ï¼Œå³vrrpè§’è‰²åˆ‡æ¢çš„ç›®æ ‡è§’è‰²ï¼›</span><br><span class="line">-h, --helpï¼šè·å–è„šæœ¬çš„ä½¿ç”¨å¸®åŠ©ï¼›</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="string">\#</span> Author: Tux</span><br><span class="line"><span class="string">\#</span> description: An example <span class="keyword">of</span> notify script</span><br><span class="line"><span class="string">\#</span> Usage: notify.sh -m|--mode {mm|mb} -s|--service SERVICE1,... -a|--address VIP&amp;nbsp; -n|--notify {master|backup|falut} -h|--help</span><br><span class="line"></span><br><span class="line">&amp;nbsp;</span><br><span class="line"></span><br><span class="line">helpflag=<span class="number">0</span></span><br><span class="line">serviceflag=<span class="number">0</span></span><br><span class="line">modeflag=<span class="number">0</span></span><br><span class="line">addressflag=<span class="number">0</span></span><br><span class="line">notifyflag=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">contact=<span class="string">'2399447849@qq.com'</span>&amp;nbsp;&amp;nbsp; <span class="comment">#-&gt;æŒ‡å®šè”ç³»äºº;å¯ä»¥æœ‰å¤šä¸ªï¼Œç”¨â€,â€åˆ†éš”å¼€æ¥</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line">Usage() {</span><br><span class="line">  echo <span class="string">"Usage: notify.sh \[-m|--mode {mm|mb}\] \[-s|--service SERVICE1,...\] &lt;-a|--address VIP&gt;  &lt;-n|--notify {master|backup|falut}&gt;"</span> </span><br><span class="line">  echo <span class="string">"Usage: notify.sh -h|--help"</span></span><br><span class="line">}</span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line">ParseOptions() {</span><br><span class="line">  local I=<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> <span class="string">\[</span> $<span class="comment"># -gt 0 \]; then</span></span><br><span class="line">    <span class="keyword">while</span> <span class="string">\[</span> $I -le $<span class="comment"># \]; do</span></span><br><span class="line">      <span class="keyword">case</span> $<span class="number">1</span> <span class="keyword">in</span></span><br><span class="line">  -s|--service)</span><br><span class="line"><span class="string">\[</span> $<span class="comment"># -lt 2 \] &amp;&amp; return 3</span></span><br><span class="line">     serviceflag=<span class="number">1</span></span><br><span class="line"> services=(<span class="string">\`echo</span> $<span class="number">2</span>|awk -F<span class="string">","</span> <span class="string">'{for(i=1;i&lt;=NF;i++) print $i}'</span><span class="string">\`)</span></span><br><span class="line">shift <span class="number">2</span> ;;</span><br><span class="line">  -h|--help)</span><br><span class="line"> helpflag=<span class="number">1</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        shift</span><br><span class="line">;;</span><br><span class="line">  -a|--address)</span><br><span class="line"><span class="string">\[</span> $<span class="comment"># -lt 2 \] &amp;&amp; return 3</span></span><br><span class="line">    addressflag=<span class="number">1</span></span><br><span class="line">vip=$<span class="number">2</span></span><br><span class="line">shift <span class="number">2</span></span><br><span class="line">;;</span><br><span class="line">  -m|--mode)</span><br><span class="line"><span class="string">\[</span> $<span class="comment"># -lt 2 \] &amp;&amp; return 3</span></span><br><span class="line">mode=$<span class="number">2</span></span><br><span class="line">shift <span class="number">2</span></span><br><span class="line">;;</span><br><span class="line">  -n|--notify)</span><br><span class="line"><span class="string">\[</span> $<span class="comment"># -lt 2 \] &amp;&amp; return 3</span></span><br><span class="line">notifyflag=<span class="number">1</span></span><br><span class="line">notify=$<span class="number">2</span></span><br><span class="line">shift <span class="number">2</span></span><br><span class="line">;;</span><br><span class="line">  *)</span><br><span class="line">echo <span class="string">"Wrong options..."</span></span><br><span class="line">Usage</span><br><span class="line"><span class="keyword">return</span> <span class="number">7</span></span><br><span class="line">;;</span><br><span class="line">       esac</span><br><span class="line">    done</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">  fi</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">#workspace=$(dirname $0)</span></span><br><span class="line"></span><br><span class="line">RestartService() {</span><br><span class="line">  <span class="keyword">if</span> <span class="string">\[</span> ${<span class="comment">#@} -gt 0 \]; then</span></span><br><span class="line">    <span class="keyword">for</span> I <span class="keyword">in</span> $@; <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">if</span> <span class="string">\[</span> -x <span class="regexp">/etc/rc.d/init.d/</span>$I <span class="string">\];</span> <span class="keyword">then</span></span><br><span class="line">        <span class="regexp">/etc/rc.d/init.d/</span>$I restart</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        echo <span class="string">"$I is not a valid service..."</span></span><br><span class="line">      fi</span><br><span class="line">    done</span><br><span class="line">  fi</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">StopService() {</span><br><span class="line">  <span class="keyword">if</span> <span class="string">\[</span> ${<span class="comment">#@} -gt 0 \]; then</span></span><br><span class="line">    <span class="keyword">for</span> I <span class="keyword">in</span> $@; <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">if</span> <span class="string">\[</span> -x <span class="regexp">/etc/rc.d/init.d/</span>$I <span class="string">\];</span> <span class="keyword">then</span></span><br><span class="line">        <span class="regexp">/etc/rc.d/init.d/</span>$I stop</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        echo <span class="string">"$I is not a valid service..."</span></span><br><span class="line">      fi</span><br><span class="line">    done</span><br><span class="line">  fi</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Notify() {</span><br><span class="line">    mailsubject=<span class="string">"\`hostname\` to be $1: $vip floating"</span></span><br><span class="line">    mailbody=<span class="string">"\`date '+%F %H:%M:%S'\`, vrrp transition, \`hostname\` changed to be $1."</span></span><br><span class="line">    echo $mailbody | mail -s <span class="string">"$mailsubject"</span> $contact</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">\#</span> Main <span class="built_in">Function</span></span><br><span class="line">ParseOptions $@</span><br><span class="line"><span class="string">\[</span> $? -ne <span class="number">0</span> <span class="string">\]</span> &amp;&amp; Usage &amp;&amp; exit <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="string">\[</span> $helpflag -eq <span class="number">1</span> <span class="string">\]</span> &amp;&amp; Usage &amp;&amp; exit <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">\[</span> $addressflag -ne <span class="number">1</span> -o $notifyflag -ne <span class="number">1</span> <span class="string">\];</span> <span class="keyword">then</span></span><br><span class="line">  Usage</span><br><span class="line">  exit <span class="number">2</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">mode=${mode:-mb}</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> $notify <span class="keyword">in</span></span><br><span class="line"><span class="string">'master'</span>)</span><br><span class="line">  <span class="keyword">if</span> <span class="string">\[</span> $serviceflag -eq <span class="number">1</span> <span class="string">\];</span> <span class="keyword">then</span></span><br><span class="line">      RestartService ${services<span class="string">\[*\]}</span></span><br><span class="line">  fi</span><br><span class="line">  Notify master</span><br><span class="line">  ;;</span><br><span class="line"><span class="string">'backup'</span>)</span><br><span class="line">  <span class="keyword">if</span> <span class="string">\[</span> $serviceflag -eq <span class="number">1</span> <span class="string">\];</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">\[</span> <span class="string">"$mode"</span> == <span class="string">'mb'</span> <span class="string">\];</span> <span class="keyword">then</span></span><br><span class="line">      StopService ${services<span class="string">\[*\]}</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      RestartService ${services<span class="string">\[*\]}</span></span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">  Notify backup</span><br><span class="line">  ;;</span><br><span class="line"><span class="string">'fault'</span>)</span><br><span class="line">  Notify fault</span><br><span class="line">  ;;</span><br><span class="line">*)</span><br><span class="line">  Usage</span><br><span class="line">  exit <span class="number">4</span></span><br><span class="line">  ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>) åœ¨keepalived.confé…ç½®æ–‡ä»¶ä¸­ï¼Œå…¶è°ƒç”¨æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</span><br><span class="line"></span><br><span class="line">notify<span class="string">\_master</span> <span class="string">"/etc/keepalived/notify.sh -n master -a VIP\_address"</span></span><br><span class="line">notify<span class="string">\_backup</span> <span class="string">"/etc/keepalived/notify.sh -n backup -a VIP\_address"</span></span><br><span class="line">notify<span class="string">\_fault</span> <span class="string">"/etc/keepalived/notify.sh -n fault -a VIP\_address"</span></span><br><span class="line"></span><br><span class="line">(<span class="number">3</span>)ä¿®æ”¹master/slave çš„keepalivedé…ç½®æ–‡ä»¶ï¼šã€ &nbsp;</span><br><span class="line"></span><br><span class="line">master:</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> vim /etc/keepalived/keepalived.conf</span><br><span class="line"></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">notification_email {</span><br><span class="line"><span class="number">2399447849</span>@qq.com</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">notification<span class="string">\_email\_from</span> root</span><br><span class="line">smtp_server <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">smtp<span class="string">\_connect\_timeout</span> <span class="number">30</span></span><br><span class="line">router<span class="string">\_id</span> LVS<span class="string">\_DEVEL</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">&nbsp;</span><br><span class="line"></span><br><span class="line">vrrp<span class="string">\_script</span> chk<span class="string">\_schedown</span> {</span><br><span class="line">script <span class="string">"\[ -e /etc/keepalived/down \] &amp;&amp; exit 1 || exit 0"</span></span><br><span class="line">interval <span class="number">1</span></span><br><span class="line">weight -<span class="number">5</span></span><br><span class="line">fall <span class="number">2</span></span><br><span class="line">rise <span class="number">1</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vrrp<span class="string">\_instance</span> VI<span class="string">\_1</span> {</span><br><span class="line">state MASTER</span><br><span class="line">interface eth0</span><br><span class="line">virtual<span class="string">\_router\_id</span> <span class="number">60</span></span><br><span class="line">priority <span class="number">101</span></span><br><span class="line">advert_int <span class="number">1</span></span><br><span class="line">authentication {</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass <span class="number">1111</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">virtual_ipaddress {</span><br><span class="line"><span class="number">192.168</span>.<span class="number">254.200</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">track_script {</span><br><span class="line">     chk_schedown</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">#-&gt;å¢åŠ ä»¥ä¸‹ä¸‰è¡Œ(æ³¨ï¼šåœ¨slaveä¸Šé¢ä¹Ÿä¸€æ ·æ·»åŠ è¿™ä¸‰è¡Œï¼Œæ­¤å¤„ç•¥)</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; notify_master <span class="string">"/etc/keepalived/notify.sh -n master -a 192.168.254.200"</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; notify_backup <span class="string">"/etc/keepalived/notify.sh -n backup -a 192.168.254.200"</span></span><br><span class="line">&nbsp;&nbsp;&nbsp; notify_fault <span class="string">"/etc/keepalived/notify.sh -n fault -a 192.168.254.200"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">&nbsp;</span><br><span class="line"></span><br><span class="line">virtual_server <span class="number">192.168</span>.<span class="number">254.200</span> <span class="number">80</span> {</span><br><span class="line">delay_loop <span class="number">6</span></span><br><span class="line">lb_algo rr</span><br><span class="line">lb_kind DR</span><br><span class="line">nat_mask <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line"><span class="comment">#persistence_timeout 50</span></span><br><span class="line">protocol TCP</span><br><span class="line">&nbsp;</span><br><span class="line"></span><br><span class="line">real_server <span class="number">192.168</span>.<span class="number">254.45</span> <span class="number">80</span>&nbsp; {</span><br><span class="line">weight <span class="number">1</span></span><br><span class="line">HTTP_GET {</span><br><span class="line">    url {</span><br><span class="line">      path /</span><br><span class="line">      status_code <span class="number">200</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">connect_timeout <span class="number">3</span></span><br><span class="line">nb<span class="string">\_get\_retry</span> <span class="number">3</span></span><br><span class="line">delay<span class="string">\_before\_retry</span> <span class="number">3</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">real_server <span class="number">192.168</span>.<span class="number">254.46</span> <span class="number">80</span> {</span><br><span class="line">weight <span class="number">1</span></span><br><span class="line">HTTP_GET {</span><br><span class="line">url {</span><br><span class="line">path /</span><br><span class="line">status_code <span class="number">200</span></span><br><span class="line">}</span><br><span class="line">connect_timeout <span class="number">3</span></span><br><span class="line">nb<span class="string">\_get\_retry</span> <span class="number">3</span></span><br><span class="line">delay<span class="string">\_before\_retry</span> <span class="number">3</span></span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">sorry_server <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">80</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">&nbsp; (<span class="number">4</span>)æ·»åŠ è„šæœ¬ï¼š è®²ä¸Šè¿°çš„è„šæœ¬æ·»åŠ è‡³masterå’Œslaveçš„<span class="regexp">/etc/keepalived/</span>ç›®å½•ä¸‹(æ³¨æ„æƒé™)ï¼š</span><br><span class="line"></span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> ll /etc/keepalived</span><br><span class="line">æ€»ç”¨é‡ <span class="number">8</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">1748</span> <span class="number">10</span>æœˆ <span class="number">30</span> <span class="number">17</span>:<span class="number">08</span> keepalived.conf</span><br><span class="line">-rwxr-xr-x. <span class="number">1</span> root root <span class="number">2380</span> <span class="number">10</span>æœˆ <span class="number">30</span> <span class="number">00</span>:<span class="number">57</span> notify.sh</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span></span><br><span class="line">&nbsp;</span><br><span class="line"><span class="comment">#-&gt;å¤åˆ¶è‡³slave</span></span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> scp <span class="regexp">/etc/keepalived/notify.sh 192.168.254.48:/etc/keepalived/</span></span><br><span class="line"></span><br><span class="line">(<span class="number">5</span>)æµ‹è¯•ä¸€ä¸‹è„šæœ¬å¯ç”¨æ€§ï¼š</span><br><span class="line"></span><br><span class="line"><span class="string">\[root@slave</span> keepalived<span class="string">\]#</span> ./notify.sh --help</span><br><span class="line">Usage: notify.sh <span class="string">\[-m|--mode</span> {mm|mb}<span class="string">\]</span> <span class="string">\[-s|--service</span> SERVICE1,...<span class="string">\]</span> &lt;-a|--address VIP&gt;&nbsp; &lt;-n|--notify {master|backup|falut}&gt;</span><br><span class="line">Usage: notify.sh -h|--help</span><br><span class="line"><span class="string">\[root@slave</span> keepalived<span class="string">\]#</span> ./notify.sh -m mb -a <span class="number">2.2</span>.<span class="number">2.2</span> -n master</span><br><span class="line"><span class="string">\[root@slave</span> keepalived<span class="string">\]#</span></span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹é‚®ä»¶: [![<span class="number">12</span>](https:<span class="regexp">//qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/12.png)](https://</span>qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/<span class="number">2014</span>/<span class="number">10</span>/<span class="number">12.png</span>) åœ¨æ¨¡æ‹Ÿæ•…éšœæ—¶é‡å¯ä¸€ä¸‹keepalived,ä»¥å…å‰é¢çš„å®éªŒé€ æˆå½±å“ã€‚ æ³¨ï¼šç°åœ¨å·²ç»å¯ä»¥æˆåŠŸæ”¶åˆ°é‚®ä»¶ï¼Œé€šçŸ¥è„šæœ¬å¯ç”¨ï¼› (<span class="number">6</span>)æ•…éšœæ¨¡æ‹Ÿï¼š &lt;<span class="number">1</span>&gt;å…ˆé‡å¯ä¸»å¤‡keepalivedæœåŠ¡</span><br><span class="line"></span><br><span class="line">master:</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> service keepalived restart</span><br><span class="line">åœæ­¢ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line">æ­£åœ¨å¯åŠ¨ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span></span><br><span class="line">slave:</span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span> service keepalived restart</span><br><span class="line">åœæ­¢ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">\[ç¡®å®š\]</span></span><br><span class="line">æ­£åœ¨å¯åŠ¨ keepalivedï¼š&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">\[ç¡®å®š\]</span></span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span></span><br><span class="line"></span><br><span class="line">&lt;<span class="number">2</span>&gt;æ­£å¸¸æƒ…å†µä¸‹æ­¤æ—¶VIPåœ¨masterä¸Šé¢</span><br><span class="line"></span><br><span class="line">master:</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span> ip a</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">inet <span class="number">192.168</span>.<span class="number">254.200</span>/<span class="number">32</span> scope global eth0</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line"><span class="string">\[root@master</span> ~<span class="string">\]#</span></span><br><span class="line"></span><br><span class="line">&lt;<span class="number">3</span>&gt;åœ¨masterçš„/etc/keepalivedç›®å½•ä¸‹ touchä¸€ä¸ªæ–‡ä»¶â€downâ€</span><br><span class="line"></span><br><span class="line">master:</span><br><span class="line"><span class="string">\[root@master</span> keepalived<span class="string">\]#</span> touch down</span><br><span class="line"></span><br><span class="line">&lt;<span class="number">4</span>&gt;è§‚å¯ŸVIP è½¬ç§»æƒ…å†µ</span><br><span class="line"></span><br><span class="line">slave:</span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span> ip a</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">inet <span class="number">192.168</span>.<span class="number">254.200</span>/<span class="number">32</span> scope global eth0</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line"><span class="string">\[root@slave</span> ~<span class="string">\]#</span></span><br></pre></td></tr></tbody></table></figure><p>&lt;5&gt;ç»“æœæŸ¥çœ‹â€”&gt;é‚®ä»¶æ”¶å– <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/13.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/13.png" alt="13"></a> &lt;6&gt;Clientè®¿é—®æµ‹è¯• <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/14.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/10/14.png" alt="14"></a> ä»ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œåœ¨keepalivedä¸»å¤‡åˆ‡æ¢æ—¶ï¼Œä¸ä»…èƒ½å¤Ÿå‘é€é‚®ä»¶ï¼Œè€Œä¸”è®¿é—®æœåŠ¡ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼› è‡³æ­¤Lvs+Keepalivedçš„åŸºæœ¬åº”ç”¨å®éªŒæ¼”ç¤ºå®Œæ¯•ï¼</p>]]></content>
      
      
      <categories>
          
          <category> è´Ÿè½½å‡è¡¡ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Floating </tag>
            
            <tag> keepalived </tag>
            
            <tag> lvs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcatç¯å¢ƒæ­å»ºåŠjspç«™ç‚¹å®ç°</title>
      <link href="/2014/08/28/tomcat-e7-8e-af-e5-a2-83-e6-90-ad-e5-bb-ba-e5-8f-8ajsp-e7-ab-99-e7-82-b9-e5-ae-9e-e7-8e-b0/"/>
      <url>/2014/08/28/tomcat-e7-8e-af-e5-a2-83-e6-90-ad-e5-bb-ba-e5-8f-8ajsp-e7-ab-99-e7-82-b9-e5-ae-9e-e7-8e-b0/</url>
      
        <content type="html"><![CDATA[<p>&nbsp; å®‰è£…JDK(é…ç½®javaç¯å¢ƒ)ï¼š ç¯å¢ƒï¼šCentOS6.5_x86-64bit ä¸€ã€å…ˆå®‰è£…JVM 1.ä½¿ç”¨7ç‰ˆæœ¬çš„jdk(åˆ°å®˜ç½‘ä¸‹è½½ç›¸åº”çš„è½¯ä»¶åŒ…åˆ°æœ¬åœ°<a href="http://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase7-521261.html#jre-7u9-oth-JPR">http://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase7-521261.html#jre-7u9-oth-JPR</a>)</p><p>[root@localhost ~]# rpm -ivh jdk-7u9-linux-x64.rpm<br>Preparingâ€¦ ########################################### [100%]<br>1:jdk ########################################### [100%]<br>Unpacking JAR filesâ€¦<br>rt.jarâ€¦<br>Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/rt.pack<br>jsse.jar..<br>Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/jsse.pack<br>charsets.jarâ€¦<br>Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/charsets.pack<br>tools.jarâ€¦<br>Error: Could not open input file: /usr/java/jdk1.7.0_09/lib/tools.pack<br>localedata.jarâ€¦<br>Error: Could not open input file: /usr/java/jdk1.7.0_09/jre/lib/ext/localedata.pack<br>#-&gt;ä»¥ä¸Šé‚£äº›é”™è¯¯å¯ä»¥å¿½ç•¥ï¼Œä¸å½±å“jdkåˆ°å®‰è£…å’Œä½¿ç”¨</p><p>2.å®‰è£…åç”Ÿæˆçš„æ–‡ä»¶ï¼š</p><p>[root@localhost ~]# cd /usr/java/<br>[root@localhost java]# ll<br>total 4<br>lrwxrwxrwx 1 root root 16 May 6 10:58 default -&gt; /usr/java/latest<br>drwxr-xr-x 10 root root 4096 May 6 10:58 jdk1.7.0_09<br>lrwxrwxrwx 1 root root 21 May 6 10:58 latest -&gt; /usr/java/jdk1.7.0_09</p><p>3.ä¿®æ”¹javaç¯å¢ƒå˜é‡ï¼š</p><p>[root@localhost ~]# vim /etc/profile.d/java.sh<br>export JAVA_HOME=/usr/java/latest<br>export PATH=$JAVA_HOME/bin:$PATH<br>[root@localhost ~]# . /etc/profile.d/java.sh</p><p>4.æµ‹è¯•javaç¯å¢ƒæ˜¯å¦å¯ç”¨.</p><p>[root@localhost java]# java -version<br>java version â€œ1.7.0_09â€<br>Java(TM) SE Runtime Environment (build 1. 7.0_09-b05)<br>Java HotSpot(TM) 64-Bit Server VM (build 23.5-b02, mixed mode)<br>[root@localhost java]#</p><p>æ­¤æ—¶åªæ˜¯éƒ¨ç½²å¥½äº†javaç¯å¢ƒ,è€Œå¹¶éè¿è¡Œä»»ä½•çš„JAVAç¨‹åº,è€ŒTomcatå°±æ˜¯è¿è¡Œåœ¨è¿™ä¸ªç¯å¢ƒä¸Šé¢çš„JAVAç¨‹åº äºŒã€å®‰è£…é…ç½®tomcat 1.è·å–è½¯ä»¶åŒ…å¹¶è§£å‹å®‰è£…ï¼š</p><p>[root@localhost ~]# wget <a href="http://apache.fayea.com/apache-mirror/tomcat/tomcat-7/v7.0.55/bin/apache-tomcat-7.0.55.tar.gz">http://apache.fayea.com/apache-mirror/tomcat/tomcat-7/v7.0.55/bin/apache-tomcat-7.0.55.tar.gz</a><br>[root@localhost ~]# tar -xf apache-tomcat-7.0.55.tar.gz -C /usr/local/<br>[root@localhost ~]# cd /usr/local/<br>[root@localhost local]# ln -sv apache-tomcat-7.0.5 tomcat<br>`tomcatâ€™ -&gt; `apache-tomcat-7.0.55â€™<br>[root@localhost local]# cd tomcat/<br>[root@localhost tomcat]#</p><p>2.æ›´æ”¹tomcatç¯å¢ƒå˜é‡ï¼š</p><p>[root@localhost ~]# vim /etc/profile.d/tomcat.sh<br>export CATALINA_HOME=/usr/local/tomcat<br>export PATH=$CATALINA_HOME/bin/:$PATH<br>[root@localhost ~]# . /etc/profile.d/tomcat</p><p>3.å¯åŠ¨tomcat</p><p>[root@localhost tomcat]# catalina.sh start</p><p>4.éªŒè¯æ˜¯å¦å¯åŠ¨</p><p>[root@localhost tomcat]# ss -tunlp | grep java<br>tcp LISTEN 0 100 :::8080 :::* users:((â€œjavaâ€,25953,42))<br>tcp LISTEN 0 1 ::ffff:127.0.0.1:8005 :::* users:((â€œjavaâ€,25953,46))<br>tcp LISTEN 0 100 :::8009 :::* users:((â€œjavaâ€,25953,43))<br>#â€”&gt;æ³¨æ„ä¸‰ä¸ªç«¯å£ï¼Œæ¯ä¸€ä¸ªå•ç‹¬çš„javaç¨‹åºéƒ½æ˜¯ç”±ä¸€ä¸ªjvmæ¥è¿è¡Œçš„.<br>[root@localhost tomcat]# jps<br>25953 Bootstrap #â€”&gt;è¿™ä¸ªè¿›ç¨‹æ˜¯tomcatå¯åŠ¨æ—¶ä¸ºäº†å®ç°å…¶åŠ é€Ÿçš„ä¸€ä¸ªç¨‹åº.æœ‰è¿™ä¸ªè¿›ç¨‹åˆ™è¡¨ç¤ºå¯åŠ¨æˆåŠŸ.<br>25995 Jps<br>[root@localhost tomcat]#</p><p>5.ç½‘é¡µè®¿é—®æµ‹è¯•ï¼š<a href="http://ip:8080/">http://IP:8080</a> ç°åœ¨tomcatå·²ç»å¯åŠ¨äº†,æ³¨æ„ä¸Šå›¾ä¸­çš„ä¸‰ä¸ªæŒ‰é’®,åç»­è¯´. <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/wpid-d698a595a631e5b1f4c10780198b6dc9_c8b5d927-ed11-4825-ac80-c5f047b7c4a0.jpg"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/wpid-d698a595a631e5b1f4c10780198b6dc9_c8b5d927-ed11-4825-ac80-c5f047b7c4a0-600x348.jpg" alt="wpid-d698a595a631e5b1f4c10780198b6dc9_c8b5d927-ed11-4825-ac80-c5f047b7c4a0.jpg"></a> 6.ä¸ºäº†æ–¹ä¾¿ç®¡ç†tomcatï¼Œä¸ºå…¶æä¾›SysVç®¡ç†è„šæœ¬.</p><p>[root@localhost ~]# vim /etc/rc.d/init.d/tomcat<br>#!/bin/sh<br># Tomcat init script for Linux.</p><h1 id=""><a href="#" class="headerlink" title=""></a></h1><p># chkconfig: 2345 96 14<br># description: The Apache Tomcat servlet/JSP container.<br>JAVA_HOME=/usr/java/latest<br>CATALINA_HOME=/usr/local/tomcat<br>export JAVA_HOME CATALINA_HOME<br>. /etc/init.d/functions</p><p>case $1 in<br>start)<br>  $CATALINA_HOME/bin/catalina.sh start &amp;&gt;/dev/null;;<br>stop)<br>  $CATALINA_HOME/bin/catalina.sh stop &amp;&gt;/dev/null;;<br>  restart)<br>$CATALINA_HOME/bin/catalina.sh stop &amp;&gt;/dev/null<br>  sleep 2<br>  $CATALINA_HOME/bin/catalina.sh start &amp;&gt;/dev/null;;<br>*)<br>  echo â€œUsage:`basename $0` {start|stop|restart}â€<br>exit 1<br>;;<br>esac<br>[root@localhost ~]# chmod +X /etc/rc.d/init.d/tomcat<br>[root@localhost ~]# chkconfig â€“add tomcat<br>#-&gt;é€šè¿‡ä¸Šé¢è¿™ä¸ªæœåŠ¡æ§åˆ¶è„šæœ¬å°±å¯ä»¥æ§åˆ¶tomcatçš„å¯åŠ¨ã€å…³é—­ç­‰æ“ä½œäº†;</p><p>7.Tomcat é…ç½®æ–‡ä»¶é…ç½®å±‚æ¬¡ï¼š Tomcatæ˜¯ä¸€ä¸ªåŸºäºç»„ä»¶çš„æœåŠ¡å™¨ï¼Œå®ƒçš„æ„æˆç»„ä»¶éƒ½æ˜¯å¯é…ç½®çš„ï¼Œå…¶ä¸­æœ€å¤–å±‚çš„ç»™ä»¶æ˜¯CATALINA SERVLETå®¹å™¨ï¼Œå…¶ä»–çš„ç»„ä»¶æŒ‰ç…§ä¸€å®šçš„æ ¼å¼è¦æ±‚é…ç½®åœ¨è¿™ä¸ªé¡¶å±‚å®¹å™¨ä¸­ã€‚Tomcatçš„å„ä¸ªç»„ä»¶æ˜¯server.xmlæ–‡ä»¶ä¸­é…ç½®çš„ï¼ŒTomcatæœåŠ¡å™¨é»˜è®¤æƒ…å†µä¸‹å¯¹å„ç§ç»„ä»¶éƒ½æœ‰é»˜è®¤çš„å®ç°ï¼Œä¸‹é¢é€šè¿‡åˆ†æserver.xmlæ–‡ä»¶æ¥ç†è§£Tomcatçš„å„ä¸ªç»„ä»¶æ˜¯å¦‚ä½•ç»„ç»‡çš„ã€‚</p><p><server>    #â€”&gt;é¡¶å±‚ç»„ä»¶ï¼Œä»£è¡¨ä¸€ä¸ªæœåŠ¡å™¨<br>     <service>    #â€”&gt;é¡¶å±‚ç»„ä»¶ï¼Œæ˜¯Connectorçš„é›†åˆï¼Œå°†è¿æ¥å™¨å…³è”è‡³engineï¼›å› æ­¤ä¸€ä¸ªserviceå†…éƒ¨å¯ä»¥æœ‰å¤šä¸ªconnectorï¼Œä½†åªèƒ½æœ‰ä¸€ä¸ªengine<br>          <connector>    #â€”&gt;è¿æ¥å™¨ç±»ç»„ä»¶ï¼Œä»£è¡¨é€šä¿¡æ¥å£<br>          <engine>    #â€”&gt;å®¹å™¨ç±»ç»„ä»¶ï¼Œä¸ºç‰¹å®šçš„Serviceç»„ä»¶å¤„ç†æ‰€æœ‰å®¢æˆ·è¯·æ±‚ï¼Œå¯åŒ…å«å¤šä¸ªHost<br>               <host>    #â€”&gt;ä¸ºç‰¹å®šçš„è™šæ‹Ÿä¸»æœºå¤„ç†æ‰€æœ‰å®¢æˆ·è¯·æ±‚<br>                    <context>    #â€”&gt;ä¸ºç‰¹å®šçš„WEBåº”ç”¨å¤„ç†æ‰€æœ‰å®¢æˆ·è¯·æ±‚<br>                    </context><br>               </host><br>               <host><br>               </host><br>          </engine><br>     </connector></service><br></server></p><p>è¯¦è¿°è¿™äº›ç»„ä»¶ï¼š **é¡¶çº§ç»„ä»¶ï¼š**ä½äºæ•´ä¸ªé…ç½®çš„é¡¶å±‚ï¼› **å®¹å™¨ç±»ï¼š**å¯ä»¥åŒ…å«å…¶å®ƒç»„ä»¶çš„ç»„ä»¶ï¼›<br>&nbsp; &nbsp; &nbsp;engine: æ ¸å¿ƒå®¹å™¨ï¼Œcatalinaå¼•æ“ï¼Œè´Ÿè´£é€šè¿‡connectoræ¥æ”¶ç”¨æˆ·è¯·æ±‚,åœ¨ä¸€ä¸ªenginå†…éƒ¨å¯ä»¥æœ‰å¤šä¸ªhost<br>&nbsp; &nbsp; &nbsp;host: ç±»ä¼¼äºhttpdä¸­çš„è™šæ‹Ÿä¸»æœºï¼›æ”¯æŒåŸºäºFQDNçš„è™šæ‹Ÿä¸»æœº<br>&nbsp;&nbsp;&nbsp;&nbsp; context: æœ€å†…å±‚çš„å®¹å™¨ç±»ç»„ä»¶ï¼Œä¸€ä¸ªcontextä»£è¡¨ä¸€ä¸ªwebåº”ç”¨ç¨‹åºï¼›é…ç½®contextçš„ä¸»è¦ç›®çš„ï¼ŒæŒ‡å®šå¯¹åº”çš„webappçš„æ ¹ç›®å½•ï¼›è¿˜èƒ½ä¸ºwebappæŒ‡å®šé¢å¤–çš„å±æ€§ï¼Œå¦‚éƒ¨ç½²æ–¹å¼ç­‰ï¼› **è¿æ¥å™¨ç»„ä»¶ï¼š**è¿æ¥ç”¨æˆ·è¯·æ±‚è‡³tomcatï¼› ä¸¤ç±»è¿æ¥å™¨ï¼š 1.åŸºäºHTTP åè®® 2.åŸºäºAJP äºŒè¿›åˆ¶åè®®,ä½¿ç”¨httpdåå‘ä»£ç†ç”¨æˆ·è¯·æ±‚è‡³tomcatæ—¶,åœ¨httpdå’Œtomcatä¹‹é—´ä½¿ç”¨.è¢«åµŒå¥—ç±»çš„ç»„ä»¶ï¼šä½äºä¸€ä¸ªå®¹å™¨å½“ä¸­ï¼Œä¸èƒ½åŒ…å«å…¶å®ƒç»„ä»¶ï¼› **è¢«åµŒå¥—ç±»çš„ç»„ä»¶ï¼š**ä½äºä¸€ä¸ªå®¹å™¨å½“ä¸­ï¼Œä¸èƒ½åŒ…å«å…¶å®ƒç»„ä»¶ï¼› valve: æ‹¦æˆªè¯·æ±‚å¹¶åœ¨å°†å…¶è½¬è‡³å¯¹åº”çš„webappä¹‹å‰è¿›è¡ŒæŸç§å¤„ç†æ“ä½œï¼›å¯ä»¥ç”¨äºä»»ä½•å®¹å™¨ä¸­ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; access log valve:&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; remote address filter value: åŸºäºIPåšè®¿é—®æ§åˆ¶<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logger: æ—¥å¿—è®°å½•å™¨ï¼Œç”¨äºè®°å½•ç»„ä»¶ å†…éƒ¨çš„çŠ¶æ€ä¿¡æ¯(å¯ç”¨äºé™¤contextä¹‹å¤–çš„ä»»ä½•å®¹å™¨ä¸­)<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; realm: å¯ä»¥ç”¨äºä»»ä½•å®¹å™¨ç±»çš„ç»„ä»¶ä¸­ï¼Œå…³è”ä¸€ä¸ªç”¨æˆ·è®¤è¯åº“ï¼Œå®ç°è®¤è¯å’Œæˆæƒï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UserDatabaseRealm: ä½¿ç”¨JNDIè‡ªå®šä¹‰çš„ç”¨æˆ·è®¤è¯åº“ï¼›<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MemoryRealm: tomcat-users.xmlä¸­&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JDBCRealm: åŸºäºJDBCè¿æ¥è‡³æ•°æ®åº“ä¸­æŸ¥æ‰¾ç”¨æˆ·ï¼› **éƒ¨ç½²:**ä½¿ç”¨ç±»åŠ è½½å™¨,ä¸ºwebappå‡†å¤‡å¥½å…¶ä¾èµ–æ‰€æœ‰ç±». 8.æœåŠ¡ç«¯å£è¯´æ˜ï¼š åœ¨æˆ‘ä»¬å¯åŠ¨ä¹‹åæœ‰3ä¸ªç«¯å£ï¼š8005ï¼Œ8009ï¼Œ8080 <strong>8005</strong> &nbsp;==&gt;ä½äºserveré¡¶çº§ç»„ä»¶å½“ä¸­,å®ƒç›‘å¬äºæœ¬åœ°&lt;127.0.0.1&gt; é€šè¿‡è¿™ä¸ªportæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨æœ¬åœ°å…³é—­tomcatåº”ç”¨ç¨‹åº,ä»¥åŠjavaè¿›ç¨‹. å¦‚ä¸‹ï¼š (1)åœ¨æœ¬æœºå®‰è£…telnet ;&nbsp;</p><p>[root@localhost ~]# yum install -y telnet</p><p>(2)è¿æ¥æœ¬æœº8005port,å‘é€â€SHUTDOWNâ€æŒ‡ä»¤</p><p>[root@localhost ~]# telnet localhost 8005  #â€“&gt;telnetæœ¬åœ°8005port<br>Trying ::1â€¦<br>telnet: connect to address ::1: Connection refused<br>Trying 127.0.0.1â€¦<br>Connected to localhost.<br>Escape character is â€˜^]â€˜.<br>SHUTDOWN     #â€“&gt;å‘é€â€SHUTDOWNâ€æŒ‡ä»¤ï¼<br>Connection closed by foreign host.<br>[root@node1 ~]# ss -tunlp | grep java  #â€“&gt;æ­¤æ—¶å†å»æ£€æŸ¥ç«¯å£,æ˜¾ç¤ºæ²¡æœ‰,è¯´æ˜æˆ‘ä»¬é€šè¿‡telnetå·²ç»å‘é€æŒ‡ä»¤å°†å…¶å…³é—­æˆåŠŸå•¦,å±é™©ç³»æ•°è¾ƒé«˜,é…ç½®æœåŠ¡å®‰å…¨æ€§æ—¶éœ€æ³¨æ„ï¼<br>[root@node1 ~]# service tomcat start   #â€“&gt;å†æ¬¡å¯åŠ¨,æ£€æŸ¥ç«¯å£æ­£å¸¸å¦.<br>[root@node1 ~]# ss -tunlp | grep java<br>tcp    LISTEN     0      100                   :::8080                 :::*      users:((â€œjavaâ€,6430,42))<br>tcp    LISTEN     0      1       ::ffff:127.0.0.1:8005                 :::*      users:((â€œjavaâ€,6430,46))<br>tcp    LISTEN     0      100                   :::8009                 :::*      users:((â€œjavaâ€,6430,43))<br>[root@node1 ~]#</p><p>**&nbsp;8009ï¼Œ8080 &nbsp;==&gt;**å‰é¢å·²è¯´åˆ°äº†åœ¨è¿æ¥å™¨ç»„ä»¶å½“ä¸­æœ‰ä¸ª<connector>,ä»–ä»¬åœ¨è¿™ä¸ªç»„ä»¶å½“ä¸­åˆ†åˆ«å¯¹åº”äº†ä¸¤ç§åè®®. 8009 &nbsp;&nbsp;åŸºäºAJDåè®® 8080 &nbsp;åŸºäºhttpåè®®,å½“ç„¶åœ¨<connector>ä¸­å¯ä»¥æ·»åŠ å„ç§å‚æ•°,ä¾‹å¦‚â€addressâ€ç­‰,é»˜è®¤é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æŒ‡å®šipåœ°å€,é»˜è®¤å°±æ˜¯ç›‘å¬æ‰€æœ‰.è¿™ä¸ªç«¯å£ä¸€èˆ¬ä¿®æ”¹ä¸º80. ä¸‰ã€è™šæ‹Ÿä¸»æœºå®šä¹‰ï¼š (1)åˆ›å»ºç½‘é¡µç›®å½•ï¼š</connector></connector></p><p>[root@node1 ~]# mkdir /www/webapps/ROOT</p><p>(2)åˆ›å»ºç½‘é¡µæµ‹è¯•æ–‡ä»¶:</p><p>[root@localhost ~]# vim /www/webapps/ROOT/index.jsp<br>&lt;%@ page language=â€javaâ€ %&gt;<br>&lt;%@ page import=â€java.util.*â€ %&gt;</p>      <title>JSP test page.</title>        &lt;% out.println("hello,world!"); %&gt;  <!--%--><p>(3)ä¿®æ”¹é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><p>[root@node1 ~]# vim /usr/local/tomcat/conf/server.xml<br>â€¦â€¦<br>â€¦â€¦<br>  <connector port="80" protocol="HTTP/1.1" connectiontimeout="20000" redirectport="8443"><br>â€¦..<br>â€¦..<br><host name="www.aaa.com" appbase="/www/webapps" unpackwars="true" autodeploy="true"><br>             <context path="" docbase="ROOT" reloadable="true"><br>         &lt;Valve className=â€org.apache.catalina.valves.AccessLogValveâ€ directory=â€logsâ€   #-&gt;æ—¥å¿—ä¿å­˜æ ¼å¼<br>                        prefix=â€<a href="http://www.aaa.www_log/">www.aaa.www_log</a>.â€ suffix=â€.txtâ€<br>                        pattern=â€%h %l %u %t "%r" %s %bâ€ /&gt;<br></context></host><br>â€¦â€¦<br>â€¦â€¦</connector></p><p>(4)é‡å¯æœåŠ¡æµ‹è¯•ï¼š</p><p>[root@localhost ~]# service tomcat restart</p><p><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat.png" alt="tomcat"></a> æ³¨æ„:æ­¤å¤„æˆ‘å·²ç»å¯¹è¯¥æœåŠ¡å™¨åšäº†è§£æ. (5)è™šæ‹Ÿä¸»æœºçš„åˆ«åæœºåˆ¶ï¼š</p><p>[root@node1 ~]# vim /usr/local/tomcat/conf/server.xml<br>â€¦â€¦<br>â€¦â€¦<br>  <connector port="80" protocol="HTTP/1.1" connectiontimeout="20000" redirectport="8443"><br>â€¦..<br>â€¦..<br><host name="www.aaa.com" appbase="/www/webapps" unpackwars="true" autodeploy="true"><br>             <context path="" docbase="ROOT" reloadable="true"><br>             <context path="/bbs" docbase="/www/webapps/bbsapp" reloadable="true">  #â€”&gt;åœ¨åŸæœ‰è™šæ‹Ÿä¸»æœºä¸­æ·»åŠ ä¸€ä¸ªContext<br>         &lt;Valve className=â€org.apache.catalina.valves.AccessLogValveâ€ directory=â€logsâ€   #-&gt;æ—¥å¿—ä¿å­˜æ ¼å¼<br>                        prefix=â€<a href="http://www.aaa.www_log/">www.aaa.www_log</a>.â€ suffix=â€.txtâ€<br>                        pattern=â€%h %l %u %t "%r" %s %bâ€ /&gt;<br></context></context></host><br>â€¦â€¦</connector></p><p>#â€”&gt;åˆ›å»ºç›®å½•bbsapp<br>[root@localhost ~]# mkdir /www/webapps/bbsapp<br>#â€”&gt;åˆ›å»ºæµ‹è¯•æ–‡ä»¶<br>[root@localhost ~]# cp /www/webapps/ROOT/index.jsp /www/webapps/bbsapp/index.jsp<br>#â€”&gt;ç¼–è¾‘æµ‹è¯•æ–‡ä»¶,ä¸ä¸Šé¢çš„ä¸åŒå³å¯<br>[root@localhost ~]# vim /www/webapps/bbsapp/index.jsp<br>#â€”&gt;é‡å¯æœåŠ¡æµ‹è¯•<br>[root@localhost ~]# service tomcat restart<br>[root@localhost ~]#<br>â€¦â€¦</p><p><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat1.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat1.png" alt="tomcat"></a> å››ã€æœåŠ¡çŠ¶æ€ä¿¡æ¯&amp;Dashboard: åœ¨æœ€å‰é¢çš„é‚£ç§å›¾ç‰‡å½“ä¸­æˆ‘ä»¬çœ‹åˆ°äº†tomcatæœåŠ¡çš„é»˜è®¤ç•Œé¢æœ‰ä¸‰ä¸ªæŒ‰é’®ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat2.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat2.png" alt="tomcat"></a> &nbsp; å½“æˆ‘ä»¬ç‚¹å‡»â€Server Statusâ€æ—¶,éœ€è¦èº«ä»½éªŒè¯ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat3.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat3.png" alt="tomcat"></a> ç‚¹å‡»â€å–æ¶ˆâ€,ç½‘é¡µä¼šæç¤ºæˆ‘ä»¬å¦‚ä½•å»ä¿®æ”¹,å¹¶èƒ½å¤Ÿç™»å½•æŸ¥çœ‹çŠ¶æ€ç­‰ä¿¡æ¯. <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat4.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat4.png" alt="tomcat"></a> &nbsp;é‚£å°±å»ä¿®æ”¹è¿™ä¸ªé…ç½®æ–‡ä»¶å§ï¼š</p><p>[root@localhost ~]# vim /usr/local/tomcat/conf/tomcat-users.xml<br>â€¦â€¦<br>â€¦â€¦<br><role rolename="manager-gui"><br><user username="tomcat" password="tomcat" roles="manager-gui"><br>â€¦â€¦<br>â€¦â€¦</user></role></p><p>#â€”&gt;é‡å¯æœåŠ¡<br>[root@varnish ~]# service tomcat restart<br>#â€”&gt;#æµ‹è¯•ï¼š(è¿™é‡Œåªæ˜¯çŠ¶æ€ç•Œé¢,å¦‚æœæƒ³çœ‹å…¶ä»–è¯·çœ‹å¸®åŠ©ä¿¡æ¯)</p><p><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat5.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/tomcat5.png" alt="tomcat"></a></p>]]></content>
      
      
      <categories>
          
          <category> Webç›¸å…³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> jdk </tag>
            
            <tag> tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Snmpåè®®è¯¦è§£</title>
      <link href="/2014/08/27/snmp-e5-8d-8f-e8-ae-ae-e8-af-a6-e8-a7-a3/"/>
      <url>/2014/08/27/snmp-e5-8d-8f-e8-ae-ae-e8-af-a6-e8-a7-a3/</url>
      
        <content type="html"><![CDATA[<p>ç›‘æ§ä¸»æœºçš„æ–¹å¼ï¼š 1.åŸºäºé€šè¡Œçš„snmp 2.åŸºäºä¸“ç”¨agent 3.åŸºäºssh(shell) å¯¹äºä¸åŒçš„ç›‘æ§æŒ‡æ ‡ï¼Œæœ€åå®ç°çš„åŠŸèƒ½ä¹Ÿæœ‰æ‰€ä¸åŒ.ä¸‹é¢æ˜¯æœ¬äººé€šè¿‡å­¦ä¹ æ€»ç»“å…³äºä¸snmpåè®®çš„ä¸€äº›è§£é‡Šä»¥åŠè¿ç”¨ SNMP<simple network="" management="" protocol=""> ä¸»è¦å‡ ä¸ªç®€å•çš„æ“ä½œå°±å¯ä»¥å®ç°å¯¹è¿œç¨‹è®¾å¤‡ä¸Šçš„æœåŠ¡ã€èµ„æºç­‰å„ç§ç³»ç»ŸçŠ¶æ€ä¿¡æ¯çš„è·å–,ä¸ä»…ä»…æ˜¯è·å–ä¿¡æ¯è¿™ä¹ˆç®€å•,è¿˜èƒ½åœ¨è¾¾åˆ°æˆ‘ä»¬è®¾å®šå€¼æˆ–çŠ¶æ€çŠ¶æ€å‘ç”Ÿè½¬æ¢æ—¶èƒ½å‘å¯¹æ–¹å‘é€æ§åˆ¶æŒ‡ä»¤; SNMPçš„å·¥ä½œæœºåˆ¶ï¼š ç›‘æ§ç«¯/ä¸€ä¸ªæˆ–å¤šä¸ªè¢«ç›‘æ§ç«¯ ç›‘æ§ç«¯:NMS,è¿™ä¸ªå¹³å°ä¼šä¸ºç®¡ç†å‘˜æä¾›å‘½ä»¤è¡Œæ¥å£,å¯ä»¥å‘é€snmpæŒ‡ä»¤åˆ°ä»»ä½•ä¸€ä¸ªè¢«ç›‘æ§ä¸»æœº,è€Œåœ¨è¢«ç›‘æ§ç«¯å®‰è£…äº†ä¸€ä¸ªæœåŠ¡è¿›ç¨‹,å®ƒç”¨äºæ¥æ”¶æ¥è‡ªç›‘æ§ç«¯çš„æŸ¥è¯¢è¯·æ±‚, å¹¶ä¸”èƒ½å¤Ÿè§£æå¯¹æ–¹çš„æŸ¥è¯¢è¯·æ±‚,å¹¶å°†æŸ¥è¯¢æ•°æ®è¿”å›ç»™å¯¹æ–¹,æ‰€ä»¥è¿™ä¸ªæœåŠ¡è¿›ç¨‹å¯ä»¥ç§°ä¹‹ä¸ºæ˜¯ä¸€ä¸ªagent,å®ƒåªæ˜¯æ¥æ”¶ä¸€äº›æŸ¥è¯¢æˆ–è€…æ˜¯ç®¡ç†æŒ‡ä»¤è€Œå­˜åœ¨çš„ï¼› ç›‘æ§ç«¯å‘é€è¯·æ±‚â€”&gt;agentæ¥å—è¯·æ±‚(æ ¹æ®æŸ¥è¯¢è¯·æ±‚å†…å®¹)â€”&gt;agentè¿”å›æŸ¥è¯¢è¯·æ±‚åˆ°ç›‘æ§ç«¯. ä½†æ˜¯ä¸Šé¢æœ‰ä¸ªå¼Šç«¯,ä¹Ÿå°±æ˜¯è¯´ä»»ä½•ä¸»æœºè¿æ¥åˆ°æˆ‘ä»¬çš„agentå°±å¯ä»¥å‘é€æŒ‡ä»¤,è¿™æ ·ä¸€æ¥å®‰å…¨æ–¹é¢å°±æœ‰äº†å¾ˆå¤§çš„éšæ‚£,äºæ˜¯åœ¨æ­¤åŸºç¡€ä¸Šé¢å°±å¼•å…¥äº†communitiesåœ¨ç›‘æ§ç«¯å’Œagentä¹‹é—´å»ºç«‹é€šä¿¡çš„;ç›¸å½“äºä¸¤ä¸ªç«¯ä¹‹é—´å‘é€è®¤è¯ä¿¡æ¯,ä½†æ˜¯è¿™ä¸ªè®¤è¯ä¿¡æ¯æ˜¯æ˜æ–‡çš„; SNMPçš„åè®® v1: æ‰€æœ‰çš„å®‰å…¨æœºåˆ¶éƒ½æ˜¯åŸºäºcommunitiesæœºåˆ¶æ¥å®ç°,snmpçš„æ‰€æœ‰æ“ä½œåœ¨æœåŠ¡å™¨ç«¯ã€å®¢æˆ·ç«¯ä¹Ÿæ˜¯åŸºäºcommunitiesæœºåˆ¶æ¥å®ç°,åœ¨æ­¤ç‰ˆæœ¬ä¸­communitiesæœ‰ä¸‰ç§: read-only:åªè¯»,ç›‘æ§ç«¯åªèƒ½åˆ°agentç«¯è·å–ä¿¡æ¯; read-write:è¯»å†™,å¯å‘é€ç®¡ç†æŒ‡ä»¤;æœ‰æƒé™æ“ä½œagentç«¯ trap:agentç«¯ä¸»åŠ¨è”ç³»ç›‘æ§ç«¯ï¼›å¼•èµ·ç›‘æ§ç«¯æ³¨æ„çš„ä¸€ç§æœºåˆ¶ï¼› v2: å¯¹äºv2æ¥è¯´åªæ˜¯å¯¹v1åšäº†å¼ºåŒ–,æ­¤ç‰ˆæœ¬æ˜¯åŸºäºcommunity-string-based,è¿™ä¸ªç‰ˆæœ¬ä¹Ÿå«åšv2cï¼› v3: ç”±äºå‰é¢ä¸¤ä¸ªç‰ˆæœ¬è¿‡äºç®€åŒ–,è®¤è¯æœºåˆ¶è¾ƒä¸ºè–„å¼±,æ•…æ­¤å¢å¼ºäº†å…¶è®¤è¯æœºåˆ¶,æ•°æ®ä¼ è¾“æ–¹é¢ä¹Ÿæœ‰äº†å®‰å…¨æ€§.ä½†æ˜¯åœ¨ä¸‰ä¸ªç‰ˆæœ¬ä¸­ç”¨å¾—æœ€å¤šçš„è¿˜æ˜¯v1ç‰ˆæœ¬,åŸå› æ˜¯ç®€å•; snmp(NMS)åªæ˜¯æä¾›äº†å‘½ä»¤æ¥å£å»å®Œæˆé‡‡é›†æ•°æ®è€Œå·²,å¯¹äºé‡‡é›†åˆ°çš„æ•°æ®ä¿å­˜åœ¨å“ªé‡Œå®ƒä¸ä¼šå…³å¿ƒï¼› snmpè¿™ç§æœºåˆ¶è™½ç„¶å®ç°äº†ç½‘ç»œç®¡ç†åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒåªæ˜¯ä¸€ç§åè®®,æŠŠè¿™ç§åè®®äºˆä»¥å®ç°çš„è½¯ä»¶çš„åŠŸèƒ½ä¹Ÿæ˜¯å„ä¸ç›¸åŒçš„; MIBs<management information="" base="">ç®¡ç†ä¿¡æ¯åº“. OID&lt;å¯¹è±¡æ ‡è¯†ç¬¦&gt; å°†å¤§å¤šæ•°ç›‘æ§å¯¹è±¡å®ƒçš„åç§°å’ŒIDå·ä¹‹é—´çš„å¯¹åº”å…³ç³»; æ¯”å¦‚åœ¨agentç«¯,å®ƒä¸ä»…ä»…è¦æ”¶é›†ä¸»æœºçš„ä¿¡æ¯å¤–è¿˜éœ€è¦ç»´æŒä¸€ä¸ªMIB,è¯·æ±‚è¾¾åˆ°agentç«¯åå®ƒè¦çŸ¥é“è¯·æ±‚çš„å†…å®¹æ˜¯ä»€ä¹ˆ,é‚£ä¹ˆåœ¨agentç«¯å°±ä¼šè®°å½•ä¸‹ç›‘æ§å¯¹è±¡å’ŒIDä¹‹é—´çš„æ˜ å°„å…³ç³»;æ‰€ä»¥ä¸€ä¸ªæ ‡å‡†çš„agentè¦æä¾›è‡³å°‘ä¸€ä¸ªåŸºæœ¬çš„MIB,ä»¥ç»´æŒç›‘æ§å¯¹è±¡;ä¹Ÿå«åšMIB-II,æ ¹æ®ä¸»æœºä¸åŒçš„éœ€è¦,MIBçš„å†…å®¹ä¹Ÿæœ‰æ‰€ä¸åŒï¼› å¤§å¤šæ•°èƒ½å¤ŸåŸºäºsnmpçš„ç®¡ç†åŠŸèƒ½éƒ½å±äºmgmtèŠ‚ç‚¹,è€Œåœ¨mgmtä¸‹é¢çš„è¿™ä¸ªmibä¸‹é¢åˆ™æœ‰ä¼—å¤šçš„ç›‘æ§å¯¹è±¡ï¼Œ1.3.6.1.2.1æ˜¯æ¯ä¸€ä¸ªä¸»æœºæˆ–è®¾å¤‡é»˜è®¤æä¾›çš„MIBçš„æ ‡è¯†ï¼š</management></simple></p>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Perl: Warning: Falling Back to the Standard Locale (â€œCâ€)</title>
      <link href="/2014/08/21/perl-warning-falling-back-to-the-standard-locale-c/"/>
      <url>/2014/08/21/perl-warning-falling-back-to-the-standard-locale-c/</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©åœ¨å®‰è£…memcacheçš„phpçš„æ‰©å±•æ—¶é‡åˆ°çš„é”™è¯¯ï¼š 1.å°†è¯¥æ‰©å±•åŒ…è§£å‹ 2.ä½¿ç”¨/usr/bin/phpize(rpmåŒ…å®‰è£…åçš„ä½ç½®)å‘½ä»¤æ¥å‡†å¤‡ PHP å¤–æŒ‚æ¨¡å—çš„ç¼–è¯‘ç¯å¢ƒ(å¦‚æœæ‰¾ä¸åˆ°è¯¥å‘½ä»¤åˆ™éœ€è¦å®‰è£…ï¼Œè¿™ä¸ªå‘½ä»¤æœ‰php-develè¿™ä¸ªåŒ…ç”Ÿæˆï¼Œå¹¶ä¸”è¯¥åŒ…ä½äºDVD2ä¸­) ä¸Šé¢1ã€2æ­¥æˆåŠŸ 3.ä½¿ç”¨/usr/bin/phpizeæ—¶æŠ¥ä»¥ä¸‹é”™è¯¯:</p><p>[root@node1 memcache-2.2.5]# /usr/bin/phpize<br>Configuring for:<br>PHP Api Version:         20090626<br>Zend Module Api No:      20090626<br>Zend Extension Api No:   220090626<br>perl: warning: Setting locale failed.<br>perl: warning: Please check that your locale settings:<br>    LANGUAGE = (unset),<br>    LC_ALL = (unset),<br>    LANG = â€œenâ€<br>    are supported and installed on your system.<br>perl: warning: Falling back to the standard locale (â€œCâ€).<br>perl: warning: Setting locale failed.<br>perl: warning: Please check that your locale settings:<br>    LANGUAGE = (unset),<br>    LC_ALL = (unset),<br>    LANG = â€œenâ€<br>    are supported and installed on your system.<br>perl: warning: Falling back to the standard locale (â€œCâ€).</p><p>åœ¨ä½¿ç”¨å…¶å®ƒçš„æŸäº›å‘½ä»¤æ—¶(å¦‚ï¼šmysqlhotcopy)ä¹Ÿä¼šä¹Ÿå‡ºç°ç±»ä¼¼çš„æç¤ºã€‚ æœç´¢äº†å¥½ä¸€æ®µæ—¶é—´ï¼Œå¹¶è¯•äº†å‡ æ¬¡ï¼Œæ‰¾åˆ°ä¸€ä¸ªè§£å†³æ­¤é—®é¢˜çš„ç®€å•æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><p>[root@node1 memcache-2.2.5]#vim /root/.bashrc<br>#-&gt;å†æœ€åº•éƒ¨åŠ ä¸Š<br>export LC_ALL=C<br>#-&gt;æˆ–è€…ç›´æ¥è¿è¡Œ<br>[root@node1 memcache-2.2.5]# echo â€œexport LC_ALL=Câ€ &gt;&gt; /root/.bashrc<br>#-&gt;ç„¶åæ‰§è¡Œä¸€ä¸‹ï¼š<br>[root@node1 memcache-2.2.5]# source /root/.bashrc</p>]]></content>
      
      
      <categories>
          
          <category> æ•…éšœå¤„ç† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> perl </tag>
            
            <tag> phpize </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vmware Cloneé™·é˜±</title>
      <link href="/2014/07/19/vmware-clone-e9-99-b7-e9-98-b1/"/>
      <url>/2014/07/19/vmware-clone-e9-99-b7-e9-98-b1/</url>
      
        <content type="html"><![CDATA[<p>åœ¨æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨vmware workstationåšå®éªŒæ—¶ï¼Œä¼šé‡åˆ°ä¸»æœºä¸å¤Ÿç”¨çš„æƒ…å†µï¼Œé‚£æ­¤æ—¶æˆ‘ä»¬çš„è§£å†³åŠæ³•ä¸€èˆ¬éƒ½æ˜¯è¦ä¹ˆä»æ–°è£…ä¸€å°æ–°çš„ï¼Œè¦ä¹ˆå°±æ˜¯é€šè¿‡vmware workstationå¼ºå¤§çš„å…‹éš†åŠŸèƒ½å…‹éš†å‡ºæˆ‘ä»¬éœ€è¦çš„è™šæ‹Ÿæœºï¼›æ˜¾ç„¶åè€…çš„ä¼˜åŠ¿æ¯”å‰è€…å¤§ï¼Œæ¯•ç«Ÿä½ ä»æ–°è£…ä¸€å°çš„è¯å ç”¨ä½ çš„ç‰©ç†ç¡¬ç›˜ç©ºé—´ï¼Œå…¶æ¬¡å°±æ˜¯æµªè´¹Your Time. SO,å°±é€‰æ‹©Cloneå§. æˆ‘ç°åœ¨æœ‰ä¸€å°åˆšè£…å¥½çš„è™šæ‹Ÿæœº(æ¯æœº)ï¼Œç”±äºåšå®éªŒæˆ‘éœ€è¦å¤šå°ä¸»æœºï¼›æˆ‘å°†è¿™å°ä¸»æœºå‘½åä¸ºnode1ï¼Œç›®çš„æ˜¯é€šè¿‡è¿™å°æ¯æœºå…‹éš†ä¸€å°è™šæ‹Ÿæœºnode2ï¼› åœ¨Clone Typeé¡µä¸­ï¼Œå•å‡»Create a linked clone(åˆ›å»ºä¸€ä¸ªå…‹éš†é“¾æ¥)ã€‚å¦‚æœé€‰æ‹©ç¬¬äºŒé¡¹Create a full cloneï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„å…‹éš†ã€‚è¿™ä¸¤ä¸ªåŒºåˆ«åœ¨äºï¼šç¬¬ä¸€é¡¹åˆ›å»ºçš„è™šæ‹Ÿæœºå°†ä¾èµ–äºæºè™šæ‹Ÿæœºçš„å­˜åœ¨ï¼Œä½¿ç”¨è¿™é¡¹åˆ›å»ºçš„è™šæ‹Ÿæœºå ç”¨è¾ƒå°‘çš„ç¡¬ç›˜ç©ºé—´ï¼›ç¬¬äºŒé¡¹åˆ›å»ºçš„ è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºï¼Œä½†å ç”¨è¾ƒå¤šçš„ç¡¬ç›˜ç©ºé—´ã€‚æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯Create a linked cloneï¼Œå…·ä½“çš„æ­¥éª¤æˆ‘å°±ä¸å†ç»™å‡ºï¼› node2é€šè¿‡node1ä¸åˆ°10så°±å…‹éš†å¥½å•¦ï¼Œä½†æ˜¯å¾…æˆ‘æŸ¥çœ‹å…‹éš†å‡ºæ¥çš„ä¸¤å°æœºå­çš„ç½‘ç»œä¿¡æ¯æ—¶å±…ç„¶ä¸æ˜¯é»˜è®¤çš„eth0ç½‘å¡ï¼Œæ€ä¹ˆå˜æˆeth1äº†å‘¢ï¼Œå¯¹äºæˆ‘è¿™ç§å­¦ä¹ å¼ºè¿«ç—‡çš„æ¥è¯´ï¼Œè¿™ç§äº‹æƒ…çœŸä¸èƒ½å‘ç”Ÿï¼Œè¿˜æœ‰çš„åŒå­¦é‡åˆ°äº†é€šè¿‡cloneè¿™ç§æœºåˆ¶åœ¨æ“ä½œæ—¶ç½‘å¡å†²çªã€æ— æ³•å¯åŠ¨ç½‘å¡ã€æˆ–è€…æ˜¯é…ç½®äº†IPä¹Ÿä¸æµäºæ˜¯ï¼›äºæ˜¯é€šè¿‡googleäº†ä¸€ä¸‹ï¼š åŸå› å¦‚ä¸‹ï¼š Centosæˆ–RedHatä½¿ç”¨udevåŠ¨æ€ç®¡ç†è®¾å¤‡æ–‡ä»¶ï¼Œå¹¶æ ¹æ®è®¾å¤‡çš„ä¿¡æ¯å¯¹å…¶è¿›è¡ŒæŒä¹…åŒ–å‘½åã€‚udevä¼šåœ¨ç³»ç»Ÿå¼•å¯¼çš„è¿‡ç¨‹ä¸­è¯†åˆ«ç½‘å¡ï¼Œå°†macåœ°å€å’Œç½‘å¡åç§°å¯¹åº”èµ·æ¥è®°å½•åœ¨udevçš„è§„åˆ™è„šæœ¬ä¸­ã€‚è€Œå¯¹äºæ–°çš„è™šæ‹Ÿæœºï¼ŒVMwareä¼šè‡ªåŠ¨ä¸ºè™šæ‹Ÿæœºçš„ç½‘å¡ç”ŸæˆMACåœ°å€ï¼Œå½“ä½ å…‹éš†æˆ–è€…é‡è£…è™šæ‹Ÿæœºè½¯ä»¶æ—¶ï¼Œç”±äºä½ ä½¿ç”¨çš„æ˜¯ä»¥å‰ç³»ç»Ÿè™šæ‹Ÿç¡¬ç›˜çš„ä¿¡æ¯ï¼Œè€Œè¯¥ç³»ç»Ÿä¸­å·²ç»æœ‰eth0çš„ä¿¡æ¯ï¼Œå¯¹äºæ–°å¢çš„ç½‘å¡ï¼Œudevä¼šè‡ªåŠ¨å°†å…¶å‘½åä¸ºeth1ï¼ˆç´¯åŠ çš„åŸåˆ™ï¼‰ï¼Œæ‰€ä»¥åœ¨ä½ çš„ç³»ç»Ÿå¯åŠ¨åï¼Œä½ ä½¿ç”¨ifconfigçœ‹åˆ°çš„ç½‘å¡åä¸ºeth1ã€‚è¿™æ—¶å€™åœ¨/etc/sysconfig/network-script/ä¸‹ä¾ç„¶æ˜¯eth0çš„é…ç½®æ–‡ä»¶ï¼Œè‡ªç„¶ä»–ä¼šè¯†åˆ«å‡ºeth1äº†å™»ã€‚ è§£å†³åŠæ³•ï¼š 1. å°†node2è¿™å°ä¸»æœºçš„/etc/udev/rules.d/70-persistent-net.rules ä¸­ <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/1.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/1.png" alt="1"></a> 2. å°†/etc/sysconfig/network-script/ifcfg-eth0 ä¸­å…³äºmacä¿¡æ¯åˆ æ‰ï¼› 3. æ”¹å®Œårebootæˆ–è€…é‡å¯ç½‘å¡ï¼šservice network restart.å®Œæˆåä½ ä¼šå‘ç°ä¸ç½‘å¡ç¼–å·ä¸ä½ çš„æ­£å¸¸é€»è¾‘ä¸­çš„ä¸€æ ·å•¦.</p>]]></content>
      
      
      <categories>
          
          <category> æ•…éšœå¤„ç† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vmware workstation </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è·å–LinuxæœåŠ¡å™¨ç¡¬ä»¶ä¿¡æ¯</title>
      <link href="/2014/06/29/e8-8e-b7-e5-8f-96linux-e6-9c-8d-e5-8a-a1-e5-99-a8-e7-a1-ac-e4-bb-b6-e4-bf-a1-e6-81-af/"/>
      <url>/2014/06/29/e8-8e-b7-e5-8f-96linux-e6-9c-8d-e5-8a-a1-e5-99-a8-e7-a1-ac-e4-bb-b6-e4-bf-a1-e6-81-af/</url>
      
        <content type="html"><![CDATA[<p>1.æŸ¥çœ‹æœåŠ¡å™¨å‹å·ã€åºåˆ—å·ï¼š</p><p>[root@localhots ~]#dmidecode|grep â€œSystem Informationâ€ -A9|egrep  â€œManufacturer|Product|Serialâ€<br>    Manufacturer: HP<br>    Product Name: ProLiant DL360 G6<br>    Serial Number: JPT0012J2W    </p><p>2.Linux æŸ¥çœ‹å†…å­˜çš„æ’æ§½æ•°,å·²ç»ä½¿ç”¨å¤šå°‘æ’æ§½.æ¯æ¡å†…å­˜å¤šå¤§:</p><p>[root@localhost ~]#dmidecode|grep -A5 â€œMemory Deviceâ€|grep Size|grep -v Range<br>    Size: No Module Installed<br>    Size: No Module Installed<br>    Size: 4096 MB<br>    Size: No Module Installed<br>    Size: No Module Installed<br>    Size: 4096 MB<br>    Size: No Module Installed<br>    Size: No Module Installed<br>    Size: No Module Installed<br>    Size: No Module Installed<br>    Size: No Module Installed<br>    Size: 4096 MB<br>    Size: No Module Installed<br>    Size: No Module Installed<br>    Size: 4096 MB<br>    Size: No Module Installed<br>    Size: No Module Installed<br>    Size: No Module Installed</p><p>3.Linux æŸ¥çœ‹å†…å­˜çš„é¢‘ç‡:</p><p>[root@localhost ~]#dmidecode|grep -A16 â€œMemory Deviceâ€|grep â€˜Speedâ€™<br>    Speed: Unknown<br>    Speed: Unknown<br>    Speed: 1067 MHz<br>    Speed: Unknown<br>    Speed: Unknown<br>    Speed: 1067 MHz<br>    Speed: Unknown<br>    Speed: Unknown<br>    Speed: Unknown<br>    Speed: Unknown<br>    Speed: Unknown<br>    Speed: 1067 MHz<br>    Speed: Unknown<br>    Speed: Unknown<br>    Speed: 1067 MHz<br>    Speed: Unknown<br>    Speed: Unknown<br>    Speed: Unknown</p><p>4.æŸ¥çœ‹cpuçš„ç»Ÿè®¡ä¿¡æ¯:</p><p>[root@localhost ~]# lscpu              #-&gt;å¦‚è¯¥å‘½ä»¤æ‰¾ä¸åˆ°,è¯·å®‰è£…è½¯ä»¶åŒ…util-linux-ng<br>Architecture:          x86_64          #-&gt;cpuæ¶æ„<br>CPU op-mode(s):        32-bit, 64-bit<br>Byte Order:            Little Endian   #-&gt;å°å°¾åº<br>CPU(s):                8               #-&gt;æ€»å…±æœ‰8æ ¸<br>On-line CPU(s) list:   0-7<br>Thread(s) per core:    1               #-&gt;æ¯ä¸ªcpuæ ¸ï¼Œåªèƒ½æ”¯æŒä¸€ä¸ªçº¿ç¨‹ï¼Œå³ä¸æ”¯æŒè¶…çº¿ç¨‹<br>Core(s) per socket:    4               #-&gt;æ¯ä¸ªcpuï¼Œæœ‰4ä¸ªæ ¸<br>Socket(s):             2               #-&gt;æ€»å…±æœ‰2ä¸€ä¸ªcpu<br>NUMA node(s):          2<br>Vendor ID:             GenuineIntel    #-&gt;cpuäº§å•† intel<br>CPU family:            6<br>Model:                 26<br>Stepping:              5<br>CPU MHz:               2266.877<br>BogoMIPS:              4532.68<br>Virtualization:        VT-x            #-&gt;æ”¯æŒcpuè™šæ‹ŸåŒ–æŠ€æœ¯<br>L1d cache:             32K<br>L1i cache:             32K<br>L2 cache:              256K<br>L3 cache:              8192K<br>NUMA node0 CPU(s):     0,2,4,6<br>NUMA node1 CPU(s):     1,3,5,7</p><p>5.æŸ¥çœ‹/proc/cpuinfo,å¯ä»¥çŸ¥é“æ¯ä¸ªcpuä¿¡æ¯ï¼Œå¦‚æ¯ä¸ªCPUçš„å‹å·ï¼Œä¸»é¢‘ç­‰:</p><p>[root@localhost ~]#cat /proc/cpuinfo<br>processor   : 0<br>vendor_id   : GenuineIntel<br>cpu family  : 6<br>model       : 26<br>model name  : Intel(R) Xeon(R) CPU           E5520  @ 2.27GHz<br>â€¦..<br>â€¦..<br>â€¦..<br>#-&gt;ä¸Šé¢è¾“å‡ºçš„æ˜¯ç¬¬ä¸€ä¸ªcpuéƒ¨åˆ†ä¿¡æ¯ï¼Œè¿˜æœ‰7ä¸ªcpuä¿¡æ¯çœç•¥äº†</p><p>6.æŸ¥çœ‹ç‰©ç†CPUä¸ªæ•°:</p><p>[root@localhost ~]# grep â€œphysical idâ€ /proc/cpuinfo  | sort -u<br>physical id    : 0<br>physical id    : 1</p><p>7.æŸ¥çœ‹CPUæ ¸å¿ƒæ•°:</p><p>[root@localhost ~]# grep â€˜core idâ€™ /proc/cpuinfo | sort -u | wc -l<br>4</p><p>8.æŸ¥çœ‹CPUçº¿ç¨‹æ•°:</p><p>[root@localhost ~]# grep â€˜processorâ€™ /proc/cpuinfo | sort -u | wc -l<br>8</p>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•è®©è®¡åˆ’ä»»åŠ¡å®ç°ç§’çº§æ‰§è¡Œ</title>
      <link href="/2014/06/16/e5-a6-82-e4-bd-95-e8-ae-a9-e8-ae-a1-e5-88-92-e4-bb-bb-e5-8a-a1-e5-ae-9e-e7-8e-b0-e7-a7-92-e7-ba-a7-e6-89-a7-e8-a1-8c/"/>
      <url>/2014/06/16/e5-a6-82-e4-bd-95-e8-ae-a9-e8-ae-a1-e5-88-92-e4-bb-bb-e5-8a-a1-e5-ae-9e-e7-8e-b0-e7-a7-92-e7-ba-a7-e6-89-a7-e8-a1-8c/</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘æœ‰ä¸ªåº”ç”¨éœ€æ±‚ï¼Œæ ¹æ®å®é™…è¦æ±‚æœ€å¥½æ˜¯æ¯3ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œä½†æ˜¯crondåªèƒ½æ”¯æŒåˆ°åˆ†ã€‚è¿™è¯¥å¦‚ä½•æ˜¯å¥½ï¼Ÿ ç¬¬ä¸€ç§æ–¹æ³•ï¼š é¦–å…ˆæƒ³åˆ°çš„æ˜¯é€šè¿‡ä¸€ä¸ªè§¦å‘çš„è„šæœ¬ï¼Œç„¶ååœ¨è„šæœ¬ä¸­ä½¿ç”¨æ­»å¾ªç¯æ¥è§£å†³æ­¤é—®é¢˜ï¼Œå¦‚ï¼š</p><p>cat test.sh<br>----------------<br>#!/bin/bash<br>while : ;do<br>        /home/script/test.sh 2&gt;/dev/null &amp;<br>        sleep 3<br>done<br>----------------</p><p>æ³¨æ„ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶è¯·ä¸è¦ä½¿ç”¨sh test.sh&nbsp;&amp; è¿™ç§åå°è¿è¡Œçš„æ–¹å¼ï¼Œå®ƒä¼šåƒµæ­»çš„ã€‚ å¯ä»¥æŠŠå®ƒæ”¾åˆ°è®¡åˆ’ä»»åŠ¡ä½¿å…¶è¿è¡Œï¼Œç„¶åå°†è®¡åˆ’ä»»åŠ¡ä¸­çš„æ­¤æ¡ç›®åˆ é™¤å³å¯ã€‚æœ€åæŠŠè¿™ä¸ªè„šæœ¬æ”¾åˆ°/etc/rc.localè®©å®ƒæ¯æ¬¡å¼€æœºéƒ½å¯ä»¥è¢«è¿è¡Œã€‚ ç¬¬äºŒç§æ–¹æ³•ï¼š å’Œç¬¬äºŒç§æ–¹æ³•ç±»ä¼¼ï¼Œä½†æ˜¯æ¯”èµ·æ¥æ›´ä¾¿æ·ä¸€äº›ã€‚</p><p>cat cron-seconds.sh<br>----------------<br>#!/bin/bash<br>#For excuting the scripts every 3 seconds in crond.</p><p>for((i=1;i&lt;=20;i++));do</p><pre><code>    /home/script/test.sh 2&gt;/dev/null &amp;    sleep 3</code></pre><p>done<br>----------------</p><p>ç„¶åå†™å…¥çš„crontabé‡Œæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚ä¸‹:</p><p>crontab -e<br>----------------<br>* * * * * /bin/bash /home/somedir/cron-seconds.sh<br>----------------</p><p>ç¬¬ä¸‰ç§æ–¹æ³•ï¼š é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨è®¡åˆ’ä»»åŠ¡æ¥ç›´æ¥å®ç°å‘¢ï¼Ÿ æœ€åè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼Œè™½ç„¶æ¡ç›®çœ‹èµ·æ¥å¾ˆå¤šï¼Œä½†æ˜¯ç»éªŒè¯ï¼Œè„šæœ¬è¿è¡Œéå¸¸ç¨³å®šã€‚</p><p>crontab -e<br>#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“<br>## For excuting test.sh.sh every 3 seconds<br>* * * * *  /home/script/test.sh.sh<br>* * * * * sleep 3 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 6 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 9 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 12 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 15 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 18 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 21 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 24 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 27 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 30 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 33 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 36 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 39 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 42 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 45 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 48 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 51 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 54 &amp;&amp;  /home/script/test.sh.sh<br>* * * * * sleep 57 &amp;&amp;  /home/script/test.sh.sh<br>#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“</p><p>&nbsp; ä¸ªäººè¿˜æ˜¯æ¯”è¾ƒå€¾å‘äºç¬¬ä¸‰ç§æ–¹æ³•ï¼Œæ¯•ç«Ÿä½ æ‰§è¡Œtest.shä¹Ÿæ˜¯éœ€è¦æ—¶é—´çš„ã€‚ä½†æ˜¯å¦‚æœå¯¹äºæ—¶é—´ç²¾åº¦ä¸æ˜¯å¾ˆé«˜çš„ï¼Œæ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> crond </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zabbix Server Is Not Running:é”™è¯¯çš„è§£å†³</title>
      <link href="/2014/06/16/zabbix-server-is-not-running-e9-94-99-e8-af-af-e7-9a-84-e8-a7-a3-e5-86-b3/"/>
      <url>/2014/06/16/zabbix-server-is-not-running-e9-94-99-e8-af-af-e7-9a-84-e8-a7-a3-e5-86-b3/</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©åœ¨å®‰è£…äº†zabbix-serverç«¯å &nbsp;åœ¨zabbixçš„dashboardä¸­ä¸­å‡ºç°ä¸‹é¢çš„ä¿¡æ¯:</p><p><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/zabbix.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/zabbix.png" alt="zabbix"></a></p><p><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/zabbix.png">&nbsp;</a><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/zabbix1.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/zabbix1.png" alt="zabbix1">  </a></p><p>éšå³æ£€æŸ¥äº†zabbix-serverçš„è¿è¡ŒçŠ¶æ€å’Œmysqlçš„è¿è¡ŒçŠ¶æ€éƒ½æ˜¯æ­£å¸¸çš„ï¼›å›°æ‰°æœ‰åŠåˆ»é’Ÿå·¦å³ï¼Œå°†æ‰€æœ‰çš„é…ç½®æ–‡ä»¶æ£€æŸ¥äº†ä¸€é å‘ç°åœ¨/etc/zabbix/web/zabbix.conf.php ä¸­æœ‰è¿™ä¹ˆä¸€è¡Œä¿¡æ¯ï¼š</p><p> <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/zabbix2.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/zabbix2.png" alt="zabbix2"></a> </p><p>è§£å†³ï¼š æˆ‘å°†â€ZABBIX-SERVERâ€ æ”¹æˆäº†æˆ‘çš„zabbix-serverçš„IP.ä¿å­˜é€€å‡ºã€é‡å¯zabbix-serverã€åˆ·æ–°dashboard;æ¢å¤æ­£å¸¸å•¦ï¼</p><p>é—®é¢˜åŸå› ï¼š æˆ‘ä»æ–°å®‰è£…äº†ä¸€æ¬¡,å‘ç°åœ¨dashboardç•Œé¢å®‰è£…è¿‡ç¨‹ä¸­,æˆ‘å°†hostçš„åç§°ç»™è‡ªå®šä¹‰äº†, å®ƒé»˜è®¤æ˜¯â€localhostâ€,è¿™é‡Œæ ¹æœ¬å°±ä¸éœ€è¦ä¿®æ”¹,é»˜è®¤å°±è¡Œå•¦ï¼</p><p><a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/zabbix3.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2014/08/zabbix3.png" alt="zabbix3">&nbsp;</a></p><p>â€œNameâ€å€’æ˜¯æ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥ã€‚ æ¯”è¾ƒé‡è¦çš„æ–‡ä»¶å°±æ˜¯/etc/zabbix/ä¸­çš„é‚£ä¸€å †äº†;æ—¥å¿—æ–‡ä»¶çš„è¯éƒ½åœ¨/var/log/zabbixsrv/ä¸‹é¢. è¿˜æœ‰ä¸€äº›é”™è¯¯å€’æ˜¯èƒ½æ ¹æ®ä¸€äº›æç¤ºè§£å†³,æ¯”å¦‚/etc/php.iniä¸­çš„å¥½å‡ ä¸ªå‚æ•°éœ€è¦ä¿®æ”¹ï¼ŒæŒ‰ç…§æç¤ºä¿®æ”¹å®Œï¼Œé‡å¯ä¸€ä¸‹apacheå°±ok!</p>]]></content>
      
      
      <categories>
          
          <category> æ•…éšœå¤„ç† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxä¸Šipå½’å±æŸ¥çœ‹ç¥å™¨</title>
      <link href="/2014/04/12/linux-e4-b8-8aip-e5-bd-92-e5-b1-9e-e6-9f-a5-e7-9c-8b-e7-a5-9e-e5-99-a8/"/>
      <url>/2014/04/12/linux-e4-b8-8aip-e5-bd-92-e5-b1-9e-e6-9f-a5-e7-9c-8b-e7-a5-9e-e5-99-a8/</url>
      
        <content type="html"><![CDATA[<p>naliå–åâ€å“ªé‡Œâ€çš„æ‹¼éŸ³ã€‚ naliåŒ…å«ä¸€ç»„å‘½ä»¤è¡Œç¨‹åºï¼Œå…¶ä¸»è¦åŠŸèƒ½å°±æ˜¯æŠŠä¸€äº›ç½‘ç»œå·¥å…·çš„è¾“å‡ºçš„IPå­—ç¬¦ä¸²ï¼Œé™„åŠ ä¸Šåœ°ç†ä½ç½®ä¿¡æ¯(ä½¿ç”¨çº¯çœŸæ•°æ®åº“) ä¾‹å¦‚218.65.137.1ä¼šå˜æˆ218.65.137.1[å¹¿è¥¿å—å®å¸‚ ç”µä¿¡]ã€‚ æŸ¥è¯¢æ˜¯åœ¨æœ¬åœ°è¿›è¡Œï¼Œå¹¶ä¸ä¼šè¿›è¡Œè”ç½‘æŸ¥è¯¢ï¼Œæ‰€ä»¥æ•ˆç‡æ–¹é¢ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ã€‚ ç›®å‰åŒ…å«ä»¥ä¸‹å‡ ä¸ªå‘½ä»¤ï¼š</p><p>nali nali-dig nali-nslookup nali-traceroute nali-tracepath nali-ping</p><p>ä½¿ç”¨è¿™äº›å‘½ä»¤çš„å‰ææ˜¯ï¼Œä»–ä»¬å¯¹åº”çš„å‘½ä»¤å¿…é¡»å­˜åœ¨ã€‚ä¾‹å¦‚ä½ è¦ç”¨nali-digï¼Œå¿…é¡»ä¿è¯digæ˜¯å­˜åœ¨çš„ã€‚ä»–ä»¬çš„ç”¨æ³•å’ŒåŸå§‹å‘½ä»¤æ˜¯ä¸€æ ·çš„ã€‚ä¾‹å¦‚nali-digï¼Œç”¨æ³•å°±å’Œdigä¸€æ ·ã€‚ å¤§å®¶å¯èƒ½æ³¨æ„åˆ°äº†naliè¿™ä¸ªå‘½ä»¤ï¼Œå®ƒå¯ä»¥å¯¹æ ‡å‡†è¾“å‡ºçš„IPä¸²é™„åŠ ä¸Šåœ°ç†ä¿¡æ¯ã€‚nali-*ç³»åˆ—å·¥å…·éƒ½æ˜¯åŸºäºè¿™ä¸ªæ¥å®ç°çš„ã€‚ ä¸‹è½½ wget <a href="http://www.sctux.com/package/nali-0.1.tar.gz">http://www.sctux.com/package/nali-0.1.tar.gz</a> å®‰è£…</p><p>./configure â€“prefix=/usr &amp;&amp; make &amp;&amp; make instal</p><p>ä½¿ç”¨ 1.ç»Ÿè®¡nginxçš„è®¿é—®è®°å½•</p><p>[root@sctux ~]# awk -F â€˜ â€˜ â€˜{print $1}â€™ /var/log/access_sctux.log | sort -n | uniq -cd | sort -rn | nali</p><p>ç»“æœå¦‚ä¸‹ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/06/nali.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/06/nali.png" alt="nali"></a> 2.ä½¿ç”¨traceroute <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/06/nali-traceroute.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/06/nali-traceroute.png" alt="nali-traceroute"></a> ä¹Ÿå°±æ˜¯è¯´ï¼Œnaliè¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥å¯¹æ ‡å‡†è¾“å‡ºçš„ipï¼Œé™„åŠ ä¸Šåœ°ç†ä¿¡æ¯ã€‚åŒç†ï¼Œå¦‚æœä½ ä¸å–œæ¬¢ç”¨nali-digï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç”¨dig ip|naliè¿™æ ·çš„å‘½ä»¤ã€‚ å¦‚æœä½ è§‰å¾—è¾“å…¥nali-xxxéº»çƒ¦ï¼Œé‚£ä¹ˆå¯ä»¥åšä¸€äº›aliasï¼Œä¾‹å¦‚ï¼š</p><p>vim /root/.bashrc<br>alias traceroute=â€™nali-tracerouteâ€™<br>alias dig=â€™nali-digâ€™</p>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Nagios-NRPEè„šæœ¬è¿”å›å€¼</title>
      <link href="/2014/02/08/nagios-nrpe-e8-84-9a-e6-9c-ac-e8-bf-94-e5-9b-9e-e5-80-bc/"/>
      <url>/2014/02/08/nagios-nrpe-e8-84-9a-e6-9c-ac-e8-bf-94-e5-9b-9e-e5-80-bc/</url>
      
        <content type="html"><![CDATA[<p>è‡ªå®šä¹‰Nagios NRPEè„šæœ¬EXITé€€å‡ºå€¼å’ŒnagiosçŠ¶æ€éƒ½åº”å…³ç³»ï¼š</p><p>çŠ¶æ€</p><p>EXITé€€å‡ºå€¼</p><p>è¾“å‡º</p><p>ä¾‹å­</p><p>OK</p><p>0</p><p>echo â€œOK - itâ€™s ok.â€</p><p>echo â€œOK - itâ€™s ok.â€ exit 0</p><p>WARNING</p><p>1</p><p>echo â€œWARNING - itâ€™s warning.â€</p><p>echo â€œWARNING - itâ€™s warning.â€ exit 1</p><p>CRITICAL</p><p>2</p><p>echo â€œCRITICAL - itâ€™s critical.â€</p><p>echo â€œCRITICAL - itâ€™s critical.â€ exit 2</p><p>UNKNOWN</p><p>3</p><p>echo â€œUNKNOWN - itâ€™s unknown.â€</p><p>echo â€œUNKNOWN - itâ€™s unknown.â€ exit 3</p><p>é”™è¯¯çš„ä¾‹å­ï¼š shellè„šæœ¬ä¸­echoå’Œé€€å‡ºå€¼ï¼š echo â€œOK - itâ€™s ok.â€ exit 1 æ­¤æ—¶ï¼ŒNagiosä¼šæ˜¾ç¤ºï¼š è¿™æ¡æœåŠ¡å¯¹åº”çš„çŠ¶æ€æ˜¯â€WARNINGâ€œï¼Œä½†æ˜¯è¾“å‡ºçš„ä¿¡æ¯æ˜¯â€OK - itâ€™s ok.â€</p>]]></content>
      
      
      <categories>
          
          <category> å¿…å¤‡çŸ¥è¯† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nrpe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vsftp å¼€å¯ PASVæ¨¡å¼</title>
      <link href="/2013/06/19/vsftp-e5-bc-80-e5-90-af-pasv-e6-a8-a1-e5-bc-8f/"/>
      <url>/2013/06/19/vsftp-e5-bc-80-e5-90-af-pasv-e6-a8-a1-e5-bc-8f/</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©åº”è€å¤§è¦æ±‚è¦åœ¨ä¸€å°åœ¨å…¬ç½‘çš„æœºå™¨é…ç½®ä¸€ä¸ªvsftpæœåŠ¡ï¼Œé…ç½®å¥½ä¹‹åå±…ç„¶ä¸èƒ½ç”¨ï¼Œç”šæ˜¯çº³é—·ï¼Œå…·ä½“æŠ¥é”™å¦‚ä¸‹å›¾ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/vsftp-info.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/vsftp-info.png" alt="vsftp-info"></a> 1ã€æˆ‘åœ¨æœ¬æœº ftp localhost å´ä¸€ç‚¹æ²¡æœ‰é—®é¢˜ï¼Ÿ 2ã€ä¸ºä»€ä¹ˆä¸€å‡ºå¤–ç½‘å°±æœ‰é—®é¢˜ï¼Ÿ 3ã€è¿™å°æœåŠ¡å™¨åœ¨å…¬ç½‘ï¼Œåœ¨é˜²ç«å¢™åé¢ï¼Œæœ¬æœºiptablesæ˜¯åœäº†çš„ï¼› 4ã€ä»¥å‰éƒ½æ˜¯åœ¨å†…ç½‘ï¼Œç”šè‡³æ˜¯åŒä¸€ä¸ªç½‘æ®µæ­å»ºvsftpæ¥ä½¿ç”¨ï¼› 5ã€vsftpçš„é…ç½®éå¸¸çš„ç®€å•ï¼Œéš¾é“è¿˜æœ‰äº›åœ°æ–¹æœ‰ç–æ¼ï¼Ÿ è§£å†³æ–¹æ³•ï¼š 1ã€åœ¨/etc/vsftpd/vsftpd.confæœ«å°¾æ·»åŠ ï¼š</p><p>#YESï¼Œå…è®¸æ•°æ®ä¼ è¾“æ—¶ä½¿ç”¨PASVæ¨¡å¼ã€‚NOï¼Œä¸å…è®¸ä½¿ç”¨PASVæ¨¡å¼ã€‚é»˜è®¤å€¼ä¸ºYESã€‚<br>pasv_enable=YES</p><p>#è®¾å®šåœ¨PASVæ¨¡å¼ä¸‹ï¼Œå»ºç«‹æ•°æ®ä¼ è¾“æ‰€å¯ä»¥ä½¿ç”¨portèŒƒå›´çš„ä¸‹ç•Œå’Œä¸Šç•Œï¼Œ0 è¡¨ç¤ºä»»æ„ã€‚é»˜è®¤å€¼ä¸º0ã€‚æŠŠç«¯å£èŒƒå›´è®¾åœ¨æ¯”è¾ƒé«˜çš„ä¸€æ®µèŒƒå›´å†…ï¼Œæ¯”å¦‚50000-60000ï¼Œå°†æœ‰åŠ©äºå®‰å…¨æ€§çš„æé«˜.<br>pasv_min_port=30000<br>pasv_max_port=30005</p><p>#æ­¤é€‰é¡¹ä¸ºä¸€ä¸ªæ•°å­—IPåœ°å€ï¼Œä½œä¸ºPASVå‘½ä»¤çš„å“åº”ã€‚é»˜è®¤å€¼ä¸ºnoneï¼Œå³åœ°å€æ˜¯ä»å‘¼å…¥çš„è¿æ¥å¥—æ¥å­—(incoming connectd socket)ä¸­è·å–ã€‚<br>pasv_address=xxxxxxxxx #æˆ‘è¿™é‡Œé…ç½®çš„æ˜¯è¿™å°æœåŠ¡å™¨çš„å¤–ç½‘IP</p><p>#æ­¤é€‰é¡¹æ¿€æ´»æ—¶ï¼Œå°†å…³é—­PASVæ¨¡å¼çš„å®‰å…¨æ£€æŸ¥ã€‚è¯¥æ£€æŸ¥ç¡®ä¿æ•°æ®è¿æ¥å’Œæ§åˆ¶è¿æ¥æ˜¯æ¥è‡ªåŒä¸€ä¸ªIPåœ°å€ã€‚å°å¿ƒæ‰“å¼€æ­¤é€‰é¡¹ã€‚æ­¤é€‰é¡¹å”¯ä¸€åˆç†çš„ç”¨æ³•æ˜¯å­˜åœ¨äºç”±å®‰å…¨éš§é“æ–¹æ¡ˆæ„æˆçš„ç»„ç»‡ä¸­ã€‚é»˜è®¤å€¼ä¸ºNO<br>#pasv_promiscuous=NO</p><p>2ã€åœ¨é˜²ç«å¢™ä¸Šå¼€å¯30000-30005ç«¯å£ã€‚ 3ã€é‡å¯vsftpdæœåŠ¡ /etc/init.d/vsftpd restart å®¢æˆ·ç«¯å†æ¬¡è®¿é—®å°±æ­£å¸¸å•¦ï¼š <a href="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/vsftp-info2.png"><img src="https://qcloud.coding.net/u/guomaoqiu/p/guomaoqiu/git/raw/master/uploads/2015/09/vsftp-info2.png" alt="vsftp-info2"></a></p>]]></content>
      
      
      <categories>
          
          <category> æ•…éšœå¤„ç† </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
