<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>OpsThoughts</title>
  
  <subtitle>Devopsã€Linuxã€Kubernetesã€Dockerã€Flaskã€Pythonã€Shellã€SRE</subtitle>
  <link href="https://blog.sctux.cc/atom.xml" rel="self"/>
  
  <link href="https://blog.sctux.cc/"/>
  <updated>2025-09-03T16:18:17.293Z</updated>
  <id>https://blog.sctux.cc/</id>
  
  <author>
    <name>NoardGuo-Ops</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æ±‚èŒ-ç³»ç»Ÿè¿ç»´/SREæ–¹å‘</title>
    <link href="https://blog.sctux.cc/2025/09/04/%E6%B1%82%E8%81%8C%E5%B8%96/"/>
    <id>https://blog.sctux.cc/2025/09/04/%E6%B1%82%E8%81%8C%E5%B8%96/</id>
    <published>2025-09-03T16:01:01.000Z</published>
    <updated>2025-09-03T16:18:17.293Z</updated>
    
    <content type="html"><![CDATA[<p>å„ä½æœ‹å‹ï¼Œå¤§å®¶å¥½ï¼</p><p>æˆ‘äºä»Šå¹´7æœˆåº•æ­£å¼ç¦»èŒï¼Œç»“æŸäº†ä¸Šä¸€æ®µå·¥ä½œæ—…ç¨‹ã€‚ç›®å‰æ­£åœ¨å¯»æ‰¾ä¸‹ä¸€ä»½ç³»ç»Ÿè¿ç»´æˆ–SREç›¸å…³çš„å·¥ä½œï¼Œå¸Œæœ›èƒ½å€ŸåŠ©å¤§å®¶çš„åŠ›é‡ã€‚</p><p>æˆ‘æœ‰10å¹´å·¦å³çš„è¿ç»´ç»éªŒï¼Œä»äº‹è¿‡IDCã€æ¸¸æˆã€ç‰©è”ç½‘ã€åŒºå—é“¾è¡Œä¸šã€‚ç†Ÿç»ƒä½¿ç”¨æ“ä½œç³»ç»Ÿã€Kubernetesé›†ç¾¤éƒ¨ç½²ç»´æŠ¤ã€ç›‘æ§ç³»ç»Ÿéƒ¨ç½²ç»´æŠ¤ä»¥åŠäºŒæ¬¡å¡å‘çš„èƒ½åŠ›ä»¥åŠä¸€äº›è‡ªåŠ¨åŒ–è„šæœ¬å·¥å…·å¼€å‘ã€‚åœ¨è¿‡å»çš„å·¥ä½œä¸­ï¼Œæˆ‘è´Ÿè´£ç»´æŠ¤ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œï¼Œå¤„ç†è¿‡ä¸€äº›æ•…éšœï¼Œä¹Ÿå‚ä¸ä»ä¼ ç»Ÿæ¶æ„åˆ°äº‘åŸç”Ÿæ¶æ„çš„è¿ç§»å’Œè½¬å‹ã€‚æˆ‘å¯èƒ½ä¸æ˜¯æœ€é¡¶å°–çš„å¤§ç‰›ï¼Œä½†æˆ‘ç›¸ä¿¡è‡ªå·±æœ‰å¾ˆå¼ºçš„è´£ä»»å¿ƒã€å­¦ä¹ èƒ½åŠ›å’Œå›¢é˜Ÿåä½œç²¾ç¥ï¼Œèƒ½è„šè¸å®åœ°åœ°å®Œæˆä»»åŠ¡ã€‚</p><p>æˆ‘ä¸ªäººéå¸¸çƒ­çˆ±è¿ç»´è¿™ä¸ªäº‹ä¸šï¼Œä½œä¸ºè¿ç»´/SREåœ¨ä¸ºå…¬å¸åˆ›é€ ä»·å€¼çš„åŒæ—¶èƒ½æ»¡è¶³è‡ªå·±çš„æˆå°±æ„Ÿæ˜¯éå¸¸å®Œç¾çš„ä¸€ä»¶äº‹æƒ…ã€‚éå¸¸æ¸´æœ›èƒ½åŠ å…¥ä¸€ä¸ªä¼˜ç§€çš„å›¢é˜Ÿï¼Œä¸å¤§å®¶å…±åŒæˆé•¿ï¼Œä¸ºå…¬å¸è´¡çŒ®å‡ºè‡ªå·±çš„å…¨éƒ¨èƒ½åŠ›ã€‚</p><p>å¦‚æœæ‚¨æ‰€åœ¨å›¢é˜Ÿæœ‰æ‹›è˜éœ€æ±‚ï¼Œæˆ–è€…æœ‰ç›¸å…³çš„ä¿¡æ¯ï¼Œæ³è¯·æ‚¨ä¸åæ¨èæˆ–è”ç³»æˆ‘ã€‚æ„Ÿæ¿€ä¸å°½ï¼</p><p><strong>ğŸ“ æˆ‘çš„è”ç³»æ–¹å¼</strong><br>æ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸æˆ‘äº¤æµï¼š</p><ul><li>ğŸ“§ é‚®ç®±ï¼š<a href="mailto:guomaoqiu@icloud.com">guomaoqiu@icloud.com</a></li><li>ğŸ“ TG: <a href="https://t.me/noardguo_devops">@noardguo_devops</a></li><li>ğŸ’» GitHubï¼š<a href="https://github.com/guomaoqiu">https://github.com/guomaoqiu</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å„ä½æœ‹å‹ï¼Œå¤§å®¶å¥½ï¼&lt;/p&gt;
&lt;p&gt;æˆ‘äºä»Šå¹´7æœˆåº•æ­£å¼ç¦»èŒï¼Œç»“æŸäº†ä¸Šä¸€æ®µå·¥ä½œæ—…ç¨‹ã€‚ç›®å‰æ­£åœ¨å¯»æ‰¾ä¸‹ä¸€ä»½ç³»ç»Ÿè¿ç»´æˆ–SREç›¸å…³çš„å·¥ä½œï¼Œå¸Œæœ›èƒ½å€ŸåŠ©å¤§å®¶çš„åŠ›é‡ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘æœ‰10å¹´å·¦å³çš„è¿ç»´ç»éªŒï¼Œä»äº‹è¿‡IDCã€æ¸¸æˆã€ç‰©è”ç½‘ã€åŒºå—é“¾è¡Œä¸šã€‚ç†Ÿç»ƒä½¿ç”¨æ“ä½œç³»ç»Ÿã€Kubernetesé›†ç¾¤éƒ¨ç½²ç»´æŠ¤ã€ç›‘æ§ç³»ç»Ÿéƒ¨ç½²ç»´æŠ¤ä»¥åŠäºŒæ¬¡å¡å‘çš„èƒ½åŠ›ä»¥åŠä¸€äº›è‡ªåŠ¨åŒ–è„šæœ¬å·¥å…·å¼€å‘ã€‚åœ¨è¿‡å»çš„å·¥ä½œä¸­ï¼Œæˆ‘è´Ÿè´£ç»´æŠ¤ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œï¼Œå¤„ç†è¿‡ä¸€äº›æ•…éšœï¼Œä¹Ÿå‚ä¸ä»ä¼ ç»Ÿæ¶æ„åˆ°äº‘åŸç”Ÿæ¶æ„çš„è¿ç§»å’Œè½¬å‹ã€‚æˆ‘å¯èƒ½ä¸æ˜¯æœ€é¡¶å°–çš„å¤§ç‰›ï¼Œä½†æˆ‘ç›¸ä¿¡è‡ªå·±æœ‰å¾ˆå¼ºçš„è´£ä»»å¿ƒã€å­¦ä¹ èƒ½åŠ›å’Œå›¢é˜Ÿåä½œç²¾ç¥ï¼Œèƒ½è„šè¸å®åœ°åœ°å®Œæˆä»»åŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä¸ªäººéå¸¸çƒ­çˆ±è¿ç»´è¿™ä¸ªäº‹ä¸šï¼Œä½œä¸ºè¿ç»´/SREåœ¨ä¸ºå…¬å¸åˆ›é€ ä»·å€¼çš„åŒæ—¶èƒ½æ»¡è¶³è‡ªå·±çš„æˆå°±æ„Ÿæ˜¯éå¸¸å®Œç¾çš„ä¸€ä»¶äº‹æƒ…ã€‚éå¸¸æ¸´æœ›èƒ½åŠ å…¥ä¸€ä¸ªä¼˜ç§€çš„å›¢é˜Ÿï¼Œä¸å¤§å®¶å…±åŒæˆé•¿ï¼Œä¸ºå…¬å¸è´¡çŒ®å‡ºè‡ªå·±çš„å…¨éƒ¨èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæ‚¨æ‰€åœ¨å›¢é˜Ÿæœ‰æ‹›è˜éœ€æ±‚ï¼Œæˆ–è€…æœ‰ç›¸å…³çš„ä¿¡æ¯ï¼Œæ³è¯·æ‚¨ä¸åæ¨èæˆ–è”ç³»æˆ‘ã€‚æ„Ÿæ¿€ä¸å°½ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ğŸ“ æˆ‘çš„è”ç³»æ–¹å¼&lt;/strong&gt;&lt;br&gt;æ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸æˆ‘äº¤æµï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ğŸ“§ é‚®ç®±ï¼š&lt;a href=&quot;mailto:guomaoqiu@icloud.com&quot;&gt;guomaoqiu@icloud.com&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;ğŸ“ TG: &lt;a href=&quot;https://t.me/noardguo_devops&quot;&gt;@noardguo_devops&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;ğŸ’» GitHubï¼š&lt;a href=&quot;https://github.com/guomaoqiu&quot;&gt;https://github.com/guomaoqiu&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Dockeræ„å»ºæ—¥å¿—æ”¶é›†å¹³å°EFK(TLS)</title>
    <link href="https://blog.sctux.cc/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/"/>
    <id>https://blog.sctux.cc/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/</id>
    <published>2024-07-23T01:56:27.000Z</published>
    <updated>2025-09-01T01:59:08.871Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å¦‚é¢˜ï¼Œ ä¸»è¦è®°å½•ä¸€ä¸‹ä¹‹å‰æ­å»ºéƒ¨ç½²çš„ä¸€å¥—æ—¥å¿—æ”¶é›†ç³»ç»Ÿã€‚è¿™é‡Œé‡‡ç”¨docker-composeçš„æ–¹å¼è¿è¡Œï¼Œè¿˜æ˜¯é‚£å¥è¯ä¸»è¦æ˜¯æ€è·¯ã€‚</p><p>æ–¹å¼: <code>ä¸€å°æœåŠ¡å™¨ä¸Šé¢åˆ©ç”¨docker-composeè¿è¡Œä¸‰ä¸ªESèŠ‚ç‚¹è·ŸKibana,å¹¶å¯ç”¨SSL,å†ä½¿ç”¨Filebeatæ¥æ”¶é›†æœåŠ¡å™¨ä¸Šé¢çš„åº”ç”¨æ—¥å¿—åˆ°ESï¼Œ æœ€åKibanaæ¥åšå±•ç¤º</code></p><h1 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h1><h3 id="ç›®å½•åˆ›å»º"><a href="#ç›®å½•åˆ›å»º" class="headerlink" title="ç›®å½•åˆ›å»º"></a>ç›®å½•åˆ›å»º</h3><figure class="highlight haskell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/{<span class="title">es</span>/<span class="title">node</span>-1/{<span class="title">data</span>,<span class="title">certs</span>,<span class="title">logs</span>,<span class="title">config</span>},plugins}</span></span><br><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/{<span class="title">es</span>/<span class="title">node</span>-2/{<span class="title">data</span>,<span class="title">certs</span>,<span class="title">logs</span>,<span class="title">config</span>},plugins}</span></span><br><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/{<span class="title">es</span>/<span class="title">node</span>-3/{<span class="title">data</span>,<span class="title">certs</span>,<span class="title">logs</span>,<span class="title">config</span>},plugins}</span></span><br><span class="line"><span class="title">mkdir</span> -p /<span class="class"><span class="keyword">data</span>/kibana/{<span class="title">certs</span>,<span class="title">config</span>} -p</span></span><br></pre></td></tr></tbody></table></figure><h3 id="éƒ¨ç½²æ–‡ä»¶"><a href="#éƒ¨ç½²æ–‡ä»¶" class="headerlink" title="éƒ¨ç½²æ–‡ä»¶"></a>éƒ¨ç½²æ–‡ä»¶</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="params">services:</span></span><br><span class="line">  <span class="params">node-1:</span></span><br><span class="line">    <span class="params">image:</span> registry.cn-hangzhou.aliyuncs.com<span class="operator">/</span>bigdata_cloudnative<span class="operator">/</span>elasticsearch:<span class="number">7.17</span>.<span class="number">5</span></span><br><span class="line">    <span class="params">networks:</span> </span><br><span class="line">      <span class="params">bitdata:</span></span><br><span class="line">        <span class="params">ipv4_address:</span> <span class="number">172.20</span>.<span class="number">0.3</span></span><br><span class="line">    <span class="params">container_name:</span> node-<span class="number">1</span></span><br><span class="line">    <span class="params">hostname:</span> node-<span class="number">1</span></span><br><span class="line">    <span class="params">environment:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"ES_JAVA_OPTS=-Xms1024m -Xmx1024m"</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"TZ=Asia/Shanghai"</span></span><br><span class="line">    <span class="params">ulimits:</span></span><br><span class="line">      <span class="params">memlock:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">        <span class="params">hard:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">      <span class="params">nofile:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="number">65536</span></span><br><span class="line">        <span class="params">hard:</span> <span class="number">65536</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"9200:9200"</span></span><br><span class="line">    <span class="params">logging:</span></span><br><span class="line">      <span class="params">driver:</span> <span class="string">"json-file"</span></span><br><span class="line">      <span class="params">options:</span></span><br><span class="line">        <span class="params">max-size:</span> <span class="string">"50m"</span></span><br><span class="line">    <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">1</span><span class="operator">/</span>config<span class="operator">/</span>elasticsearch.yml:<span class="symbol">/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>plugins:<span class="symbol">/usr/share/elasticsearch/plugins</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">1</span><span class="operator">/</span>data:<span class="symbol">/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">1</span><span class="operator">/</span>certs:<span class="symbol">/usr/share/elasticsearch/config/certs</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">1</span><span class="operator">/</span>log:<span class="symbol">/usr/share/elasticsearch/log</span></span><br><span class="line">    <span class="params">healthcheck:</span></span><br><span class="line">      <span class="params">test:</span> [<span class="string">"CMD-SHELL"</span>, <span class="string">"curl -I http://localhost:9200 || exit 1"</span>]</span><br><span class="line">      <span class="params">interval:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">timeout:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">retries:</span> <span class="number">5</span></span><br><span class="line">  <span class="params">node-2:</span></span><br><span class="line">    <span class="params">image:</span> registry.cn-hangzhou.aliyuncs.com<span class="operator">/</span>bigdata_cloudnative<span class="operator">/</span>elasticsearch:<span class="number">7.17</span>.<span class="number">5</span></span><br><span class="line">    <span class="params">networks:</span> </span><br><span class="line">      <span class="params">bitdata:</span></span><br><span class="line">        <span class="params">ipv4_address:</span> <span class="number">172.20</span>.<span class="number">0.4</span></span><br><span class="line">    <span class="params">container_name:</span> node-<span class="number">2</span></span><br><span class="line">    <span class="params">hostname:</span> node-<span class="number">2</span></span><br><span class="line">    <span class="params">environment:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"ES_JAVA_OPTS=-Xms1024m -Xmx1024m"</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"TZ=Asia/Shanghai"</span></span><br><span class="line">    <span class="params">ulimits:</span></span><br><span class="line">      <span class="params">memlock:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">        <span class="params">hard:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">      <span class="params">nofile:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="number">65536</span></span><br><span class="line">        <span class="params">hard:</span> <span class="number">65536</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"9201:9200"</span></span><br><span class="line">    <span class="params">logging:</span></span><br><span class="line">      <span class="params">driver:</span> <span class="string">"json-file"</span></span><br><span class="line">      <span class="params">options:</span></span><br><span class="line">        <span class="params">max-size:</span> <span class="string">"50m"</span></span><br><span class="line">    <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">2</span><span class="operator">/</span>config<span class="operator">/</span>elasticsearch.yml:<span class="symbol">/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>plugins:<span class="symbol">/usr/share/elasticsearch/plugins</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">2</span><span class="operator">/</span>data:<span class="symbol">/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">2</span><span class="operator">/</span>certs:<span class="symbol">/usr/share/elasticsearch/config/certs</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">2</span><span class="operator">/</span>log:<span class="symbol">/usr/share/elasticsearch/log</span></span><br><span class="line">    <span class="params">healthcheck:</span></span><br><span class="line">      <span class="params">test:</span> [<span class="string">"CMD-SHELL"</span>, <span class="string">"curl -I http://localhost:9200 || exit 1"</span>]</span><br><span class="line">      <span class="params">interval:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">timeout:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">retries:</span> <span class="number">5</span></span><br><span class="line">  <span class="params">node-3:</span></span><br><span class="line">    <span class="params">image:</span> registry.cn-hangzhou.aliyuncs.com<span class="operator">/</span>bigdata_cloudnative<span class="operator">/</span>elasticsearch:<span class="number">7.17</span>.<span class="number">5</span></span><br><span class="line">    <span class="params">networks:</span> </span><br><span class="line">      <span class="params">bitdata:</span></span><br><span class="line">        <span class="params">ipv4_address:</span> <span class="number">172.20</span>.<span class="number">0.5</span></span><br><span class="line">    <span class="params">container_name:</span> node-<span class="number">3</span></span><br><span class="line">    <span class="params">hostname:</span> node-<span class="number">3</span></span><br><span class="line">    <span class="params">environment:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"ES_JAVA_OPTS=-Xms1024m -Xmx1024m"</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"TZ=Asia/Shanghai"</span></span><br><span class="line">    <span class="params">ulimits:</span></span><br><span class="line">      <span class="params">memlock:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">        <span class="params">hard:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">      <span class="params">nofile:</span></span><br><span class="line">        <span class="params">soft:</span> <span class="number">65536</span></span><br><span class="line">        <span class="params">hard:</span> <span class="number">65536</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"9202:9200"</span></span><br><span class="line">    <span class="params">logging:</span></span><br><span class="line">      <span class="params">driver:</span> <span class="string">"json-file"</span></span><br><span class="line">      <span class="params">options:</span></span><br><span class="line">        <span class="params">max-size:</span> <span class="string">"50m"</span></span><br><span class="line">    <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">3</span><span class="operator">/</span>config<span class="operator">/</span>elasticsearch.yml:<span class="symbol">/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>plugins:<span class="symbol">/usr/share/elasticsearch/plugins</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">3</span><span class="operator">/</span>data:<span class="symbol">/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">3</span><span class="operator">/</span>certs:<span class="symbol">/usr/share/elasticsearch/config/certs</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>es<span class="operator">/</span>node-<span class="number">3</span><span class="operator">/</span>log:<span class="symbol">/usr/share/elasticsearch/log</span></span><br><span class="line">    <span class="params">healthcheck:</span></span><br><span class="line">      <span class="params">test:</span> [<span class="string">"CMD-SHELL"</span>, <span class="string">"curl -I http://localhost:9200 || exit 1"</span>]</span><br><span class="line">      <span class="params">interval:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">timeout:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">retries:</span> <span class="number">5</span></span><br><span class="line">  <span class="params">kibana:</span></span><br><span class="line">    <span class="params">networks:</span> </span><br><span class="line">      <span class="params">bitdata:</span></span><br><span class="line">        <span class="params">ipv4_address:</span> <span class="number">172.20</span>.<span class="number">0.6</span></span><br><span class="line">    <span class="params">container_name:</span> kibana</span><br><span class="line">    <span class="params">hostname:</span> kibana</span><br><span class="line">    <span class="params">image:</span> registry.cn-hangzhou.aliyuncs.com<span class="operator">/</span>bigdata_cloudnative<span class="operator">/</span>kibana:<span class="number">7.17</span>.<span class="number">5</span></span><br><span class="line">    <span class="params">environment:</span></span><br><span class="line">      <span class="params">TZ:</span> 'Asia<span class="operator">/</span>Shanghai'</span><br><span class="line">    <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>kibana<span class="operator">/</span>cert:<span class="symbol">/etc/kibana/cert</span></span><br><span class="line">      <span class="operator">-</span> .<span class="operator">/</span>kibana<span class="operator">/</span>config<span class="operator">/</span>kibana.yml:<span class="symbol">/usr/share/kibana/config/kibana.yml</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">      <span class="operator">-</span> <span class="number">5601</span>:<span class="number">5601</span></span><br><span class="line">    <span class="params">healthcheck:</span></span><br><span class="line">      <span class="params">test:</span> [<span class="string">"CMD-SHELL"</span>, <span class="string">"curl -I http://localhost:5601 || exit 1"</span>]</span><br><span class="line">      <span class="params">interval:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">timeout:</span> <span class="number">10</span>s</span><br><span class="line">      <span class="params">retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥å¤–éƒ¨ç½‘ç»œ</span></span><br><span class="line"><span class="params">networks:</span></span><br><span class="line">  <span class="params">bitdata:</span></span><br><span class="line">    <span class="params">driver:</span> bridge</span><br><span class="line">    <span class="params">ipam:</span> </span><br><span class="line">      <span class="params">config:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">subnet:</span> <span class="number">172.20</span>.<span class="number">0.0</span><span class="operator">/</span><span class="number">24</span></span><br></pre></td></tr></tbody></table></figure><h2 id="éSSL"><a href="#éSSL" class="headerlink" title="éSSL"></a>éSSL</h2><h3 id="elasticsearch-yamlé…ç½®æ–‡ä»¶"><a href="#elasticsearch-yamlé…ç½®æ–‡ä»¶" class="headerlink" title="elasticsearch.yamlé…ç½®æ–‡ä»¶"></a>elasticsearch.yamlé…ç½®æ–‡ä»¶</h3><p>è¿™é‡Œä»¥<code>node-1</code>ä¸ºä¾‹ï¼Œå…¶ä»–ä¸åŒçš„åœ°æ–¹å°±æ˜¯ <code>node.name</code></p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="symbol">/data/es/node-1/config/elasticsearch.yml</span></span><br><span class="line"><span class="comment">#é›†ç¾¤åç§°</span></span><br><span class="line">cluster.<span class="params">name:</span> elastic</span><br><span class="line"><span class="comment">#å½“å‰è¯¥èŠ‚ç‚¹çš„åç§°</span></span><br><span class="line">node.<span class="params">name:</span> node-<span class="number">1</span></span><br><span class="line"><span class="comment">#æ˜¯ä¸æ˜¯æœ‰èµ„æ ¼ç«é€‰ä¸»èŠ‚ç‚¹</span></span><br><span class="line">node.<span class="params">master:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#æ˜¯å¦å­˜å‚¨æ•°æ®</span></span><br><span class="line">node.<span class="params">data:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#æœ€å¤§é›†ç¾¤èŠ‚ç‚¹æ•°</span></span><br><span class="line">node.<span class="params">max_local_storage_nodes:</span> <span class="number">3</span></span><br><span class="line"><span class="comment">#ç»™å½“å‰èŠ‚ç‚¹è‡ªå®šä¹‰å±æ€§ï¼ˆå¯ä»¥çœç•¥ï¼‰</span></span><br><span class="line"><span class="comment">#node.attr.rack: r1</span></span><br><span class="line"><span class="comment">#æ•°æ®å­˜æ¡£ä½ç½®</span></span><br><span class="line">path.<span class="params">data:</span> <span class="symbol">/usr/share/elasticsearch/data</span></span><br><span class="line"><span class="comment">#æ—¥å¿—å­˜æ”¾ä½ç½®</span></span><br><span class="line">path.<span class="params">logs:</span> <span class="symbol">/usr/share/elasticsearch/log</span></span><br><span class="line"><span class="comment">#æ˜¯å¦å¼€å¯æ—¶é”å®šå†…å­˜ï¼ˆé»˜è®¤ä¸ºæ˜¯ï¼‰</span></span><br><span class="line"><span class="comment">#bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#è®¾ç½®ç½‘å…³åœ°å€ï¼Œæˆ‘æ˜¯è¢«è¿™ä¸ªå‘æ­»äº†ï¼Œè¿™ä¸ªåœ°å€æˆ‘åŸå…ˆå¡«å†™äº†è‡ªå·±çš„å®é™…ç‰©ç†IPåœ°å€ï¼Œ</span></span><br><span class="line"><span class="comment">#ç„¶åå¯åŠ¨ä¸€ç›´æŠ¥æ— æ•ˆçš„IPåœ°å€ï¼Œæ— æ³•æ³¨å…¥9300ç«¯å£ï¼Œè¿™é‡Œåªéœ€è¦å¡«å†™0.0.0.0</span></span><br><span class="line">network.<span class="params">host:</span> <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="comment">#è®¾ç½®æ˜ å°„ç«¯å£</span></span><br><span class="line">http.<span class="params">port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment">#å†…éƒ¨èŠ‚ç‚¹ä¹‹é—´æ²Ÿé€šç«¯å£</span></span><br><span class="line">transport.tcp.<span class="params">port:</span> <span class="number">9300</span></span><br><span class="line"><span class="comment">#é›†ç¾¤å‘ç°é»˜è®¤å€¼ä¸º127.0.0.1:9300,å¦‚æœè¦åœ¨å…¶ä»–ä¸»æœºä¸Šå½¢æˆåŒ…å«èŠ‚ç‚¹çš„ç¾¤é›†,å¦‚æœæ­å»ºé›†ç¾¤åˆ™éœ€è¦å¡«å†™</span></span><br><span class="line"><span class="comment">#es7.x ä¹‹åæ–°å¢çš„é…ç½®ï¼Œå†™å…¥å€™é€‰ä¸»èŠ‚ç‚¹çš„è®¾å¤‡åœ°å€ï¼Œåœ¨å¼€å¯æœåŠ¡åå¯ä»¥è¢«é€‰ä¸ºä¸»èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å†™ä¸Š</span></span><br><span class="line">discovery.<span class="params">seed_hosts:</span> [<span class="string">"172.20.0.3"</span>,<span class="string">"172.20.0.4"</span>,<span class="string">"172.17.0.5"</span>]</span><br><span class="line"><span class="comment">#å½“ä½ åœ¨æ­å»ºé›†ç¾¤çš„æ—¶å€™ï¼Œé€‰å‡ºåˆæ ¼çš„èŠ‚ç‚¹é›†ç¾¤ï¼Œæœ‰äº›äººè¯´çš„å¤ªå®˜æ–¹äº†ï¼Œ</span></span><br><span class="line"><span class="comment">#å…¶å®å°±æ˜¯ï¼Œè®©ä½ é€‰æ‹©æ¯”è¾ƒå¥½çš„å‡ ä¸ªèŠ‚ç‚¹ï¼Œåœ¨ä½ èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œåœ¨è¿™äº›èŠ‚ç‚¹ä¸­é€‰ä¸€ä¸ªåšé¢†å¯¼è€…ï¼Œ</span></span><br><span class="line"><span class="comment">#å¦‚æœä½ ä¸è®¾ç½®å‘¢ï¼Œelasticsearchå°±ä¼šè‡ªå·±é€‰ä¸¾ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠä¸‰ä¸ªèŠ‚ç‚¹éƒ½å†™ä¸Š</span></span><br><span class="line">cluster.<span class="params">initial_master_nodes:</span> [<span class="string">"node-1"</span>,<span class="string">"node-2"</span>,<span class="string">"node-3"</span>]</span><br><span class="line"><span class="comment">#åœ¨ç¾¤é›†å®Œå…¨é‡æ–°å¯åŠ¨åé˜»æ­¢åˆå§‹æ¢å¤ï¼Œç›´åˆ°å¯åŠ¨Nä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">#ç®€å•ç‚¹è¯´åœ¨é›†ç¾¤å¯åŠ¨åï¼Œè‡³å°‘å¤æ´»å¤šå°‘ä¸ªèŠ‚ç‚¹ä»¥ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡æ‰å¯ä»¥è¢«ä½¿ç”¨ï¼Œå¦åˆ™ä¸å¯ä»¥è¢«ä½¿ç”¨ï¼Œ</span></span><br><span class="line">gateway.<span class="params">recover_after_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="comment">#åˆ é™¤ç´¢å¼•æ˜¯æ˜¯å¦éœ€è¦æ˜¾ç¤ºå…¶åç§°ï¼Œé»˜è®¤ä¸ºæ˜¾ç¤º</span></span><br><span class="line"><span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"><span class="comment"># ç¦ç”¨å®‰å…¨é…ç½®</span></span><br><span class="line">xpack.security.<span class="params">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure><h3 id="kibana-yaml"><a href="#kibana-yaml" class="headerlink" title="kibana.yaml"></a>kibana.yaml</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="symbol">/data/kibana/config/kibana.yml</span></span><br><span class="line">server.<span class="params">host:</span> <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="comment"># ç›‘å¬ç«¯å£</span></span><br><span class="line">server.<span class="params">port:</span> <span class="number">5601</span></span><br><span class="line">server.<span class="params">name:</span> <span class="string">"kibana"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kibanaè®¿é—®esæœåŠ¡å™¨çš„URL,å°±å¯ä»¥æœ‰å¤šä¸ªï¼Œä»¥é€—å·","éš”å¼€</span></span><br><span class="line">elasticsearch.<span class="params">hosts:</span> [<span class="string">"http://172.20.0.3:9200"</span>,<span class="string">"http://172.20.0.4:9200"</span>,<span class="string">"http://172.20.0.5:9200"</span>]</span><br><span class="line">monitoring.ui.container.elasticsearch.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># kibanaè®¿é—®Elasticsearchçš„è´¦å·ä¸å¯†ç (å¦‚æœElasticSearchè®¾ç½®äº†çš„è¯)</span></span><br><span class="line">elasticsearch.<span class="params">username:</span> <span class="string">""</span></span><br><span class="line">elasticsearch.<span class="params">password:</span> <span class="string">""</span></span><br><span class="line"><span class="comment"># kibana webè¯­è¨€</span></span><br><span class="line">i18n.<span class="params">locale:</span> <span class="string">"zh-CN"</span></span><br></pre></td></tr></tbody></table></figure><h3 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h3><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ip-<span class="number">10</span>-<span class="number">10</span>-<span class="number">10</span>-<span class="number">29</span>:/data<span class="comment"># docker-compose up -d</span></span><br><span class="line">[+] Running <span class="number">5</span>/<span class="number">5</span></span><br><span class="line"> â ¿ Network data_bitdata  Created                                                 <span class="number">0.0s</span></span><br><span class="line"> â ¿ Container <span class="keyword">node</span><span class="title">-2</span>      <span class="literal">Started</span>                                                 <span class="number">0.6s</span></span><br><span class="line"> â ¿ Container <span class="keyword">node</span><span class="title">-3</span>      <span class="literal">Started</span>                                                 <span class="number">0.8s</span></span><br><span class="line"> â ¿ Container <span class="keyword">node</span><span class="title">-1</span>      <span class="literal">Started</span>                                                 <span class="number">0.8s</span></span><br><span class="line"> â ¿ Container kibana      <span class="literal">Started</span>                                                 <span class="number">0.5s</span></span><br><span class="line"></span><br><span class="line">CONTAINER ID   IMAGE                                                                        COMMAND                  CREATED              STATUS                         PORTS                                                  NAMES</span><br><span class="line"><span class="number">4</span>d5dae9021be   registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:<span class="number">7.17</span>.<span class="number">5</span>   <span class="string">"/bin/tini -- /usr/lâ€¦"</span>   About a minute ago   Up About a minute (healthy)    <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9200</span>-&gt;<span class="number">9200</span>/tcp, :::<span class="number">9200</span>-&gt;<span class="number">9200</span>/tcp, <span class="number">9300</span>/tcp    <span class="keyword">node</span><span class="title">-1</span></span><br><span class="line"><span class="number">84</span>e191d6f875   registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:<span class="number">7.17</span>.<span class="number">5</span>   <span class="string">"/bin/tini -- /usr/lâ€¦"</span>   About a minute ago   Up About a minute (healthy)    <span class="number">9300</span>/tcp, <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9202</span>-&gt;<span class="number">9200</span>/tcp, :::<span class="number">9202</span>-&gt;<span class="number">9200</span>/tcp    <span class="keyword">node</span><span class="title">-3</span></span><br><span class="line"><span class="number">758</span>a4bff2a73   registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/elasticsearch:<span class="number">7.17</span>.<span class="number">5</span>   <span class="string">"/bin/tini -- /usr/lâ€¦"</span>   About a minute ago   Up About a minute (healthy)    <span class="number">9300</span>/tcp, <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9201</span>-&gt;<span class="number">9200</span>/tcp, :::<span class="number">9201</span>-&gt;<span class="number">9200</span>/tcp    <span class="keyword">node</span><span class="title">-2</span></span><br><span class="line">fe55f0446902   registry.cn-hangzhou.aliyuncs.com/bigdata_cloudnative/kibana:<span class="number">7.17</span>.<span class="number">5</span>          <span class="string">"/bin/tini -- /usr/lâ€¦"</span>   About a minute ago   Up About a minute (healthy)    <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">5601</span>-&gt;<span class="number">5601</span>/tcp, :::<span class="number">5601</span>-&gt;<span class="number">5601</span>/tcp              kibana</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢å·²ç»å¯åŠ¨ï¼Œå¦‚æœæœ‰æŠ¥é”™æŸ¥çœ‹å®¹å™¨æ—¥å¿—å°±è¡Œäº†ï¼Œä¹‹å‰éƒ¨ç½²çš„æ—¶å€™æŠ¥é”™å†…å®¹è¿˜æ˜¯å¾ˆæ¸…æ™°</p><p>è¿›å…¥å®¹å™¨æŸ¥çœ‹ï¼š</p><figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># curl localhost:9200</span></span><br><span class="line">{</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"node-1"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elastic"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"tcKUxyWVQb-7LV4zmomsgg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : {</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.17.5"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2022-06-23T21:57:28.736740635Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.11.1"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">}</span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># curl 172.20.3:9200</span></span><br><span class="line">{</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"node-1"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elastic"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"tcKUxyWVQb-7LV4zmomsgg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : {</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.17.5"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2022-06-23T21:57:28.736740635Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.11.1"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">}</span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># curl 172.20.4:9200</span></span><br><span class="line">{</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"node-2"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elastic"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"tcKUxyWVQb-7LV4zmomsgg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : {</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.17.5"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2022-06-23T21:57:28.736740635Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.11.1"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">}</span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># curl 172.20.5:9200</span></span><br><span class="line">{</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"node-3"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elastic"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"tcKUxyWVQb-7LV4zmomsgg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : {</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.17.5"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"8d61b4f7ddf931f219e3745f295ed2bbc50c8e84"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2022-06-23T21:57:28.736740635Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.11.1"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">}</span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data</span><span class="comment"># curl -s 172.20.0.3:9200/_cluster/health | python3 -m json.tool</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"cluster_name"</span>: <span class="string">"elastic"</span>,</span><br><span class="line">    <span class="string">"status"</span>: <span class="string">"green"</span>,</span><br><span class="line">    <span class="string">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"number_of_nodes"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">"number_of_data_nodes"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">"active_primary_shards"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">"active_shards"</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="string">"relocating_shards"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"initializing_shards"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"unassigned_shards"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"delayed_unassigned_shards"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"number_of_pending_tasks"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"number_of_in_flight_fetch"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"task_max_waiting_in_queue_millis"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"active_shards_percent_as_number"</span>: <span class="number">100.0</span></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šè¯´æ˜ESé›†ç¾¤å·²ç»æ­£å¸¸å·¥ä½œï¼Œçœ‹ä¸€ä¸‹é€šè¿‡nginxä»£ç†è½¬å‘åˆ°kibanaçš„ç»“æœ</p><p><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/1.png"></p><p>kibanaä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼Œåªæ˜¯è¿™é‡Œåœ¨è®¿é—®çš„æ—¶å€™ç›´æ¥å°±è¿›å…¥äº†kibanaï¼Œå¦‚æœä¸åŠ ä¸€ä¸ªèº«ä»½éªŒè¯åŠŸèƒ½ï¼Œè¿™å°±ç­‰äºè£¸å¥”ï¼Œå³ä¾¿åœ¨æ”¾åœ¨å†…ç½‘ä¹Ÿæ˜¯æå…¶ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸€ä¸ªèº«ä»½éªŒè¯ã€‚</p><h2 id="SSLæ–¹å¼"><a href="#SSLæ–¹å¼" class="headerlink" title="SSLæ–¹å¼"></a>SSLæ–¹å¼</h2><p>åˆ©ç”¨è‡ªå¸¦çš„å·¥å…·ç”Ÿæˆè¯ä¹¦ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œç”Ÿæˆè¯ä¹¦ï¼Œä½†æ³¨æ„è¦é™åˆ¶åŸŸåå’ŒIPï¼Œå¦åˆ™åœ¨è¿›è¡Œhttpsé€šè®¯æ—¶ä¼šæ ¡éªŒå¤±è´¥</p><p>è¿›å…¥node-1å®¹å™¨ ï¼Œæ“ä½œ</p><figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:~</span><span class="comment"># docker exec -it node-1 bash</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®å®é™…æƒ…å†µé…ç½®ç”Ÿæˆè¯ä¹¦çš„yaml</span></span><br><span class="line">cat &lt;&lt;<span class="title class_">EOF</span> &gt; /usr/share/elasticsearch/node.yml</span><br><span class="line"><span class="symbol">instances:</span></span><br><span class="line">  - <span class="symbol">name:</span> <span class="string">"node"</span></span><br><span class="line">    <span class="symbol">ip:</span></span><br><span class="line">      - <span class="string">"172.20.0.3"</span></span><br><span class="line">      - <span class="string">"172.20.0.4"</span></span><br><span class="line">      - <span class="string">"172.20.0.5"</span></span><br><span class="line">      - <span class="string">"127.0.0.1"</span></span><br><span class="line">      - <span class="string">"172.20.0.6"</span></span><br><span class="line">      - <span class="string">"10.10.10.29"</span> <span class="comment"># è¿™ä¸ªIPæ˜¯æœåŠ¡å™¨çš„IPåœ°å€ï¼Œå› ä¸ºæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯dockerè¿è¡Œesé›†ç¾¤ï¼Œè¿™ä¸ªå¿…é¡»åŠ ä¸Šå»</span></span><br><span class="line">    <span class="symbol">dns:</span></span><br><span class="line">      - <span class="string">"node-1"</span></span><br><span class="line">      - <span class="string">"node-2"</span></span><br><span class="line">      - <span class="string">"node-3 "</span></span><br><span class="line">      - <span class="string">"localhost"</span></span><br><span class="line">      - <span class="string">"kibana"</span></span><br><span class="line">      - <span class="string">"others"</span></span><br><span class="line"><span class="title class_">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆcaè¯ä¹¦ï¼Œé»˜è®¤æ–‡ä»¶åä¸ºelastic-stack-ca.p12ï¼Œå¯æ·»åŠ å¯†ç </span></span><br><span class="line">bin/elasticsearch-certutil ca <span class="comment"># ä¸€è·¯å›è½¦å³å¯</span></span><br><span class="line"><span class="comment"># ç”Ÿæˆè¯ä¹¦ï¼Œé»˜è®¤æ–‡ä»¶åä¸ºcertificate-bundle.zip</span></span><br><span class="line">bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12 --silent --<span class="keyword">in</span> node.yml  <span class="comment"># ä¸€è·¯å›è½¦å³å¯</span></span><br><span class="line"><span class="comment"># å°†è¯ä¹¦å¤åˆ¶åˆ°node-1é…ç½®ç›®å½•ä¸‹</span></span><br><span class="line"></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># cp certificate-bundle.zip elastic-stack-ca.p12 config/certs/</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># cd config/certs/</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># ls</span></span><br><span class="line">certificate-bundle.zip  elastic-stack-ca.p12</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹è¯ä¹¦ï¼Œç›®å½•ç»“æ„ä¸º å®ä¾‹å/å®ä¾‹å.p12 ,æ­¤å¤„ä¸ºnode/node.p12</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># unzip certificate-bundle.zip </span></span><br><span class="line"><span class="symbol">Archive:</span>  certificate-bundle.zip</span><br><span class="line">   <span class="symbol">creating:</span> node/</span><br><span class="line">  <span class="symbol">inflating:</span> node/node.p12           </span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># ls</span></span><br><span class="line">certificate-bundle.zip  elastic-stack-ca.p12  node</span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># ls node/</span></span><br><span class="line">node.p12</span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># rm -rf node certificate-bundle.zip</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config/certs</span><span class="comment"># ls</span></span><br><span class="line">certificate-bundle.zip  elastic-stack-ca.p12  node.p12</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹è¯ä¹¦è®¿é—®æƒé™</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config</span><span class="comment"># chown -R root:elasticsearch certs/       </span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch/config</span><span class="comment"># chmod -R a+rx certs/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶æˆ‘ä»¬éœ€è¦çš„è¯ä¹¦å·²ç»ç”Ÿæˆäº†ï¼ŒåŒæ ·çš„æ–¹å¼å¤åˆ¶åˆ°node-2,node3åä¿®æ”¹æƒé™ï¼Œä¿®æ”¹å±ä¸»ç­‰æ“ä½œ</span></span><br><span class="line"><span class="comment"># é€€å‡ºå®¹å™¨,è¿›å…¥node-1çš„æŒ‚åœ¨ç›®å½•ï¼š</span></span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span>/certs<span class="comment"># pwd</span></span><br><span class="line">/data/es/node<span class="number">-1</span>/certs</span><br><span class="line"></span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span>/certs<span class="comment"># cd ..</span></span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span><span class="comment"># ls</span></span><br><span class="line">certs  config  data  log</span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span><span class="comment"># cp -rf certs ../node-2/</span></span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span><span class="comment"># cp -rf certs ../node-3/</span></span><br><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data/es/node-</span><span class="number">1</span><span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯ä¹¦å·²ç»å‡†å¤‡å®Œæ¯•</span></span><br><span class="line">es/</span><br><span class="line">â”œâ”€â”€ node<span class="number">-1</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ certs</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elastic-stack-ca.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ node.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ config</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elasticsearch.yml</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ data</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ nodes</span><br><span class="line">â”‚&nbsp;&nbsp; â””â”€â”€ log</span><br><span class="line">â”œâ”€â”€ node<span class="number">-2</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ certs</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elastic-stack-ca.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ node.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ config</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elasticsearch.yml</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ data</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ nodes</span><br><span class="line">â”‚&nbsp;&nbsp; â””â”€â”€ log</span><br><span class="line">â”œâ”€â”€ node<span class="number">-3</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ certs</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elastic-stack-ca.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ node.p12</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ config</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â”œâ”€â”€ elasticsearch.yml</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ data</span><br><span class="line">â”‚&nbsp;&nbsp; â”‚&nbsp;&nbsp; â””â”€â”€ nodes</span><br><span class="line">â”‚&nbsp;&nbsp; â””â”€â”€ log</span><br><span class="line">â””â”€â”€ plugins</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶/data/es/node-1/config/elasticsearch.yml. ä»¥èŠ‚ç‚¹<code>node-1</code>ä¸ºä¾‹</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™é‡Œçš„å†…å®¹åŒéssléƒ¨ç½²ä¸€æ ·</span></span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line"><span class="comment"># å¼€å¯xpackå®‰å…¨ç‰¹æ€§</span></span><br><span class="line">xpack.security.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line">xpack.security.authc.api_key.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># å¼€å¯httpså¹¶é…ç½®è¯ä¹¦</span></span><br><span class="line">xpack.security.http.ssl.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line">xpack.security.http.ssl.keystore.<span class="params">path:</span> certs<span class="symbol">/node.p12</span></span><br><span class="line">xpack.security.http.ssl.truststore.<span class="params">path:</span> certs<span class="symbol">/node.p12</span></span><br><span class="line"><span class="comment"># å¼€å¯èŠ‚ç‚¹é—´é€šè®¯sslå¹¶é…ç½®è¯ä¹¦</span></span><br><span class="line">xpack.security.transport.ssl.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line">xpack.security.transport.ssl.<span class="params">verification_mode:</span> certificate</span><br><span class="line">xpack.security.transport.ssl.<span class="params">client_authentication:</span> required</span><br><span class="line">xpack.security.transport.ssl.keystore.<span class="params">path:</span> certs<span class="symbol">/node.p12</span></span><br><span class="line">xpack.security.transport.ssl.truststore.<span class="params">path:</span> certs<span class="operator">/</span>node.p12</span><br></pre></td></tr></tbody></table></figure><p>æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€ä¿®æ”¹åï¼Œé‡å¯ä¸€ä¸‹esé›†ç¾¤ </p><p>é‡å¯å®Œæ¯•åï¼ŒæŸ¥çœ‹çŠ¶æ€å’Œæ—¥å¿—ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸  </p><p>è‹¥æ— å¼‚å¸¸ï¼Œå¯ä»¥å¼€å§‹è®¾ç½®å¯†ç ï¼Œ è¿›å…¥å®¹å™¨ <code>node-1</code></p><figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-29</span><span class="symbol">:/data</span><span class="comment"># docker exec -it node-1 bash</span></span><br><span class="line">root<span class="variable">@node</span><span class="number">-1</span><span class="symbol">:/usr/share/elasticsearch</span><span class="comment"># ./bin/elasticsearch-setup-passwords auto </span></span><br><span class="line"><span class="title class_">Initiating</span> the setup of passwords <span class="keyword">for</span> reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.</span><br><span class="line"><span class="title class_">The</span> passwords will be randomly generated <span class="keyword">and</span> printed to the console.</span><br><span class="line"><span class="title class_">Please</span> confirm that you would like to continue [y/N]y</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‹¥é›†ç¾¤æ²¡é—®é¢˜çš„è¯è¿™é‡Œå°±ä¼šè‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿçš„ä¸€äº›å¯†ç ï¼š</span></span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥æ‰‹åŠ¨è‡ªå®šä¹‰å¯†ç </span></span><br><span class="line">./bin/elasticsearch-setup-passwords interactive</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨ ES API æ£€æŸ¥å„ä¸ªèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -k --<span class="keyword">user</span> <span class="title">elastic</span>:å¯†ç  -X GET <span class="string">"https://172.20.0.3:9200"</span> --cert-<span class="keyword">type</span> P12 --cert /usr/share/elasticsearch/config/certs/node.p12</span><br><span class="line">curl -k --<span class="keyword">user</span> <span class="title">elastic</span>:å¯†ç  -X GET <span class="string">"https://172.20.0.4:9200"</span> --cert-<span class="keyword">type</span> P12 --cert /usr/share/elasticsearch/config/certs/node.p12</span><br><span class="line">curl -k --<span class="keyword">user</span> <span class="title">elastic</span>:å¯†ç  -X GET <span class="string">"https://172.20.0.5:9200"</span> --cert-<span class="keyword">type</span> P12 --cert /usr/share/elasticsearch/config/certs/node.p12</span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ—¶sslå·²é…ç½®å®Œæ¯•ï¼Œé…ç½®kibana</p><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># æŠŠä¹‹å‰æ”¾åœ¨node-1ä¸‹é¢çš„è¯ä¹¦å¤åˆ¶åˆ°kibana/certä¸‹é¢ï¼š</span><br><span class="line"># æå–å…¬é’¥</span><br><span class="line">openssl pkcs12 -<span class="keyword">in</span> elastic-<span class="keyword">stack</span>-<span class="keyword">ca</span>.p12 -<span class="keyword">out</span> elastic-<span class="keyword">stack</span>-<span class="keyword">ca</span>.pem -nokeys -clcerts</span><br><span class="line">openssl pkcs12 -<span class="keyword">in</span> node.p12 -<span class="keyword">out</span> node.pem -nokeys -clcerts</span><br><span class="line"># æå–ç§é’¥</span><br><span class="line">openssl pkcs12 -<span class="keyword">in</span> node.p12 -<span class="keyword">out</span> node.key -nocerts -nodes</span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶kibana/config/kibana.yml</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server.<span class="params">host:</span> <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="comment"># ç›‘å¬ç«¯å£</span></span><br><span class="line">server.<span class="params">port:</span> <span class="number">5601</span></span><br><span class="line">server.<span class="params">name:</span> <span class="string">"kibana"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kibanaè®¿é—®esæœåŠ¡å™¨çš„URL,å°±å¯ä»¥æœ‰å¤šä¸ªï¼Œä»¥é€—å·","éš”å¼€</span></span><br><span class="line"><span class="comment"># es å¼€å¯äº† sslï¼Œæ‰€ä»¥è¿™é‡Œçš„url å¿…é¡»ä½¿ç”¨httpsåè®®</span></span><br><span class="line">elasticsearch.<span class="params">hosts:</span> [<span class="string">"https://172.20.0.3:9200"</span>,<span class="string">"https://172.20.0.4:9200"</span>,<span class="string">"https://172.20.0.5:9200"</span>]</span><br><span class="line">monitoring.ui.container.elasticsearch.<span class="params">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># kibanaè®¿é—®Elasticsearchçš„è´¦å·ä¸å¯†ç (å¦‚æœElasticSearchè®¾ç½®äº†çš„è¯)</span></span><br><span class="line">elasticsearch.<span class="params">username:</span> <span class="string">"kibana_system"</span></span><br><span class="line">elasticsearch.<span class="params">password:</span> <span class="string">"xxxxxxxxxxxx"</span></span><br><span class="line"><span class="comment"># kibana webè¯­è¨€</span></span><br><span class="line">i18n.<span class="params">locale:</span> <span class="string">"zh-CN"</span></span><br><span class="line"><span class="comment"># esè¯ä¹¦é…ç½®, è¿™é‡Œæ˜¯åœ¨docker-composeä¸­å·²ç»æŒ‚è½½è¿›å®¹å™¨äº†</span></span><br><span class="line">elasticsearch.ssl.<span class="params">certificate:</span> <span class="symbol">/etc/kibana/cert/node.pem</span></span><br><span class="line">elasticsearch.ssl.<span class="params">key:</span> <span class="symbol">/etc/kibana/cert/node.key</span></span><br><span class="line"><span class="comment"># esçš„caè¯ä¹¦</span></span><br><span class="line">elasticsearch.ssl.<span class="params">certificateAuthorities:</span> [ <span class="string">"/etc/kibana/cert/elastic-stack-ca.pem"</span> ]</span><br></pre></td></tr></tbody></table></figure><p>ä¿®æ”¹å®Œæ¯•å ï¼Œé‡æ–°éƒ¨ç½²ä¸€ä¸‹ kibanaæœåŠ¡å³å¯</p><p><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/2.png"></p><p>ä»¥ä¸Šåªè¦ç™»å½•å°±å¯ä»¥ä½¿ç”¨äº†ã€‚</p><h2 id="Filebeat-æ—¥å¿—é‡‡é›†"><a href="#Filebeat-æ—¥å¿—é‡‡é›†" class="headerlink" title="Filebeat æ—¥å¿—é‡‡é›†"></a>Filebeat æ—¥å¿—é‡‡é›†</h2><p>è¿™é‡Œæˆ‘æ‰ç”¨çš„æ–¹å¼æ˜¯ dockerè¿è¡Œ filebeatæœåŠ¡ï¼Œç„¶åå°†ç½‘å…³æœåŠ¡å™¨çš„Nginxæ—¥å¿—æŒ‚è½½è¿›filebeat</p><figure class="highlight dts"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="keyword">/opt/</span>filbeat/docker-compose.yaml</span><br><span class="line"><span class="symbol">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line"><span class="symbol">  filebeat:</span></span><br><span class="line"><span class="symbol">    container_name:</span> filebeat_test</span><br><span class="line"><span class="symbol">    image:</span> elastic/filebeat:<span class="number">7.9</span><span class="number">.0</span></span><br><span class="line"><span class="symbol">    user:</span> root</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - <span class="keyword">/data/</span>wwwlogs/:<span class="keyword">/var/</span>log/nginx:ro</span><br><span class="line">      - ./filebeat.yml:<span class="keyword">/usr/</span>share<span class="keyword">/filebeat/</span>filebeat.yml:ro</span><br><span class="line">      - ./ca.crt:<span class="keyword">/usr/</span>share<span class="keyword">/filebeat/</span>certs/ca.crt</span><br><span class="line">      <span class="meta"># è¿™ä¸ªè¯ä¹¦åœ¨æ¥å…¥kibanaçš„æ—¶å€™å·²ç»æå–å‡ºæ¥äº†ï¼Œå³æ–‡ä»¶ï¼šelastic-stack-ca.pem</span></span><br><span class="line">      <span class="meta"># ä»–ä»¬å†…å®¹æ˜¯ä¸€æ ·çš„åªæ˜¯æ–‡ä»¶åã€æ ¼å¼ä¸ä¸€æ ·</span></span><br><span class="line"><span class="symbol">    command:</span> filebeat -e</span><br></pre></td></tr></tbody></table></figure><p>filebeatçš„é…ç½®æ–‡ä»¶åœ¨ /opt/filebeat/filebeat.yml</p><figure class="highlight clean"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/filebeat/filebeat.yml</span><br><span class="line">filebeat.inputs:  </span><br><span class="line">##################################################################################</span><br><span class="line">- type: log</span><br><span class="line">  paths:  </span><br><span class="line">    - /var/log/nginx/testnet-xxxxxxxxxxxx.com.log</span><br><span class="line">  tags: [<span class="string">"proxy-testnet-xxxxxxxxxxxx.com.log"</span>]  </span><br><span class="line">  fields:  </span><br><span class="line">    index: <span class="string">"proxy-testnet-xxxxxxxxxxxx.com.log"</span>  </span><br><span class="line">  json.keys_under_root: true</span><br><span class="line">  json.overwrite_keys: true</span><br><span class="line">  processors:  </span><br><span class="line">    - add_kubernetes_metadata:  </span><br><span class="line">        matchers:  </span><br><span class="line">        - logs_path:  </span><br><span class="line">            logs_path: <span class="string">"/var/log/nginx/"</span>  </span><br><span class="line">    - decode_json_fields:  </span><br><span class="line">        when:  </span><br><span class="line">           regexp:  </span><br><span class="line">             message: <span class="string">"{*}"</span>  </span><br><span class="line">        fields: [<span class="string">"message"</span>]  </span><br><span class="line">        overwrite_keys: true  </span><br><span class="line">##################################################################################</span><br><span class="line">output.elasticsearch:  </span><br><span class="line">  hosts: [<span class="string">"https://10.10.10.29:9200"</span>,<span class="string">"https://10.10.10.29:9201"</span>,<span class="string">"https://10.10.10.29:9201"</span>]</span><br><span class="line">  username: elastic</span><br><span class="line">  password: vDNnbd8FXqR2i13NYGfj</span><br><span class="line">  ssl.certificate_authorities:</span><br><span class="line">    - /usr/share/filebeat/certs/ca.crt</span><br><span class="line">  indices:  </span><br><span class="line">    - index: <span class="string">"proxy-testnet-xxxxxxxxxxxx.com.log-%{+yyyy.MM.dd}"</span>  </span><br><span class="line">      when.contains:  </span><br><span class="line">        fields:  </span><br><span class="line">          index: <span class="string">"proxy-testnet-xxxxxxxxxxxx.com.log"</span> </span><br><span class="line">setup.kibana:</span><br><span class="line">  hosts: <span class="string">"http://10.10.10.29:5601"</span></span><br><span class="line">  username: <span class="string">"elastic"</span></span><br><span class="line">  password: <span class="string">"xxxxxxxxxxxx"</span></span><br></pre></td></tr></tbody></table></figure><p>é…ç½®å®Œæ¯•ä¹‹åï¼ŒæŸ¥çœ‹æ—¥å¿—æ˜¯å¦å¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œåˆ°<code>node-1</code>ä¸Šé¢é€šè¿‡ES APIæŸ¥è¯¢æ˜¯å¦æœ‰indexç”Ÿæˆ</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@node-1:/usr/share/elasticsearch# curl -k --user elastic:xxxxxxxxxxxx -X GET "https://172.20.0.3:9200/<span class="emphasis">_cat/indices " --cert-type P12 --cert /usr/share/elasticsearch/config/certs/node.p12</span></span><br><span class="line"><span class="emphasis">......</span></span><br><span class="line"><span class="emphasis">......</span></span><br><span class="line"><span class="emphasis">......</span></span><br><span class="line"><span class="emphasis">green open proxy-testnet-xxxxxxxxxxxx.com.log-2024.07.23 Su-T62zGTheqbDsDZLzH_</span>A 1 1 2911    0   1.7mb 914.2kb</span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Kibanaé…ç½®"><a href="#Kibanaé…ç½®" class="headerlink" title="Kibanaé…ç½®"></a>Kibanaé…ç½®</h2><p>ä¸Šé¢å¯ä»¥çœ‹åˆ°filebeatå·²ç»æ­£å¸¸å¾€ESå†™å…¥æ•°æ®ï¼Œåœ¨kibanaä¸­é…ç½®ä¸€ä¸‹ï¼š</p><p><code>Stack Manager</code> - <code>Index Patterns</code> - <code>Create index pattern</code></p><p><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/3.png"></p><p>ç›´æ¥åˆ›å»ºåèœå•æ ï¼š <code>Discover</code> é€‰æ‹©åˆšåˆšåˆ›å»ºçš„è¿™ä¸ªIndex Pattern</p><p><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/4.png"><br>æœ€åç›´æ¥å°±å¯ä»¥çœ‹åˆ°æ”¶é›†åˆ°çš„æ—¥å¿—kibanaå·²ç»åšå¥½äº†å­—æ®µåˆ†éš”ï¼Œåªéœ€è¦é€‰æ‹©éœ€è¦çš„å­—æ®µï¼Œæˆ–è€…åŒ¹é…æŸäº›å­—æ®µå°±å¯ä»¥äº†ã€‚</p><p>æ¯”å¦‚ æˆ‘æƒ³çœ‹çŠ¶æ€ç å¤§äºç­‰äº500çš„ï¼š <code>status &gt;= 500</code>ï¼Œéƒ½å¯ä»¥åœ¨ä¸Šé¢çš„æœç´¢æ¡†ä¸­å»å®šä¹‰ç­›é€‰</p><p>å½“ç„¶ä¹Ÿå¯ä»¥æŠŠè¿™ä¸ªæ—¥å¿—åšæˆå¯è§†åŒ–ï¼Œä½†é€‰æ‹©æŸä¸ªæŒ‡æ ‡çš„æ—¶å€™ï¼Œå…¶ä»–æŒ‡æ ‡ä¹Ÿå¯ä»¥è”åŠ¨èµ·æ¥ï¼Œä¾‹å¦‚ï¼š<br><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/5.png"></p><p>æœ€åå†ç»“åˆå‰é¢å†™è¿‡çš„ <a href="https://blog.sctux.cc/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/">å¦‚ä½•åˆ©ç”¨ElastAlert2å¯¹ESä¸­çš„æ—¥å¿—åˆ›å»ºå‘Šè­¦</a> å°±å¯ä»¥è½»æ¾çš„å¯¹æ—¥å¿—è¿›è¡Œç›‘æ§å‘Šè­¦å•¦~</p><p>å†™åœ¨æœ€å </p><p>ä¸Šé¢è¿‡ç¨‹ä»…ä»…æ˜¯è®°å½•ï¼Œä¸»è¦è¿˜æ˜¯æ€è·¯ã€‚</p><p><img src="/2024/07/23/Docker%E6%9E%84%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B9%B3%E5%8F%B0EFK-TLS/6.png"></p><h2 id="k8s-version"><a href="#k8s-version" class="headerlink" title="k8s version"></a>k8s version</h2><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line"><span class="attr">data:</span>  </span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|-  </span></span><br><span class="line"><span class="string">    #====================== input =================  </span></span><br><span class="line"><span class="string">    filebeat.inputs:  </span></span><br><span class="line"><span class="string">    # nginx-ingress  </span></span><br><span class="line"><span class="string">    - type: container  </span></span><br><span class="line"><span class="string">      paths:  </span></span><br><span class="line"><span class="string">        - /var/log/containers/*goerli-testnet-collector*.log  </span></span><br><span class="line"><span class="string">      tags: ["goerli-testnet-collector"]  </span></span><br><span class="line"><span class="string">      fields:  </span></span><br><span class="line"><span class="string">        index: "goerli-testnet-collector"  </span></span><br><span class="line"><span class="string">      processors:  </span></span><br><span class="line"><span class="string">        - add_kubernetes_metadata:  </span></span><br><span class="line"><span class="string">            host: ${NODE_NAME}  </span></span><br><span class="line"><span class="string">            matchers:  </span></span><br><span class="line"><span class="string">            - logs_path:  </span></span><br><span class="line"><span class="string">                logs_path: "/var/log/containers/"  </span></span><br><span class="line"><span class="string">        - decode_json_fields:  </span></span><br><span class="line"><span class="string">            when:  </span></span><br><span class="line"><span class="string">               regexp:  </span></span><br><span class="line"><span class="string">                 message: "{*}"  </span></span><br><span class="line"><span class="string">            fields: ["message"]  </span></span><br><span class="line"><span class="string">            overwrite_keys: true  </span></span><br><span class="line"><span class="string">            target: ""  </span></span><br><span class="line"><span class="string">    # testnet-bsc-collector  </span></span><br><span class="line"><span class="string">    - type: container  </span></span><br><span class="line"><span class="string">      paths:  </span></span><br><span class="line"><span class="string">        - /var/log/containers/*testnet-bsc-collector*.log  </span></span><br><span class="line"><span class="string">      tags: ["testnet-bsc-collector"]  </span></span><br><span class="line"><span class="string">      fields:  </span></span><br><span class="line"><span class="string">        index: "testnet-bsc-collector"  </span></span><br><span class="line"><span class="string">      processors:  </span></span><br><span class="line"><span class="string">        - add_kubernetes_metadata:  </span></span><br><span class="line"><span class="string">            host: ${NODE_NAME}  </span></span><br><span class="line"><span class="string">            matchers:  </span></span><br><span class="line"><span class="string">            - logs_path:  </span></span><br><span class="line"><span class="string">                logs_path: "/var/log/containers/"  </span></span><br><span class="line"><span class="string">        - decode_json_fields:  </span></span><br><span class="line"><span class="string">            when:  </span></span><br><span class="line"><span class="string">               regexp:  </span></span><br><span class="line"><span class="string">                 message: "{*}"  </span></span><br><span class="line"><span class="string">            fields: ["message"]  </span></span><br><span class="line"><span class="string">            #overwrite_keys: true  </span></span><br><span class="line"><span class="string">            target: ""  </span></span><br><span class="line"><span class="string">    #================ output =====================  </span></span><br><span class="line"><span class="string">    output.elasticsearch:  </span></span><br><span class="line"><span class="string">      hosts: ["https://10.10.20.23:9200", "https://10.10.20.120:9200", "https://10.10.20.160:9200"]</span></span><br><span class="line"><span class="string">      username: elastic</span></span><br><span class="line"><span class="string">      password: r40SgkMhmjwK8rIpClFM</span></span><br><span class="line"><span class="string">      ssl.certificate_authorities:</span></span><br><span class="line"><span class="string">        - /usr/share/filebeat/ca.crt</span></span><br><span class="line"><span class="string">      indices:  </span></span><br><span class="line"><span class="string">        - index: "INDEX-NAME-%{+yyyy.MM.dd}"  </span></span><br><span class="line"><span class="string">          when.contains:  </span></span><br><span class="line"><span class="string">            fields:  </span></span><br><span class="line"><span class="string">              index: "INDEX-NAME"  </span></span><br><span class="line"><span class="string">        - index: "testnet-bsc-collector-%{+yyyy.MM.dd}"  </span></span><br><span class="line"><span class="string">          when.contains:  </span></span><br><span class="line"><span class="string">            fields:  </span></span><br><span class="line"><span class="string">              index: "testnet-bsc-collector"  </span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">    <span class="comment">#============== Elasticsearch template setting ==========  </span></span><br><span class="line">    <span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span>  </span><br><span class="line">    <span class="attr">setup.template.name:</span> <span class="string">'k8s-logs'</span>  </span><br><span class="line">    <span class="attr">setup.template.pattern:</span> <span class="string">'k8s-logs-*'</span>  </span><br><span class="line">    <span class="attr">processors:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">drop_fields:</span>  </span><br><span class="line">          <span class="attr">fields:</span> [<span class="string">"agent"</span>,<span class="string">"kubernetes.labels"</span>,<span class="string">"input.type"</span>,<span class="string">"log"</span>,<span class="string">"ecs.version"</span>,<span class="string">"host.name"</span>,<span class="string">"kubernetes.replicaset.name"</span>,<span class="string">"kubernetes.pod.uid"</span>,<span class="string">"kubernetes.pod.uid"</span>,<span class="string">"tags"</span>,<span class="string">"stream"</span>,<span class="string">"kubernetes.container.name"</span>]  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">template:</span>  </span><br><span class="line">    <span class="attr">metadata:</span>  </span><br><span class="line">      <span class="attr">labels:</span>  </span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line">    <span class="attr">spec:</span>  </span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">filebeat</span>  </span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span>  </span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span>  </span><br><span class="line">      <span class="attr">tolerations:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span>  </span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span>  </span><br><span class="line">      <span class="attr">containers:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">        <span class="attr">image:</span> <span class="string">elastic/filebeat:7.9.0</span>  </span><br><span class="line">        <span class="attr">args:</span> [  </span><br><span class="line">          <span class="string">"-c"</span>, <span class="string">"/etc/filebeat.yml"</span>,  </span><br><span class="line">          <span class="string">"-e"</span>,  </span><br><span class="line">        ]  </span><br><span class="line">        <span class="attr">env:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span>  </span><br><span class="line">          <span class="attr">valueFrom:</span>  </span><br><span class="line">            <span class="attr">fieldRef:</span>  </span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span>  </span><br><span class="line">        <span class="attr">securityContext:</span>  </span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">0</span>  </span><br><span class="line">          <span class="comment"># If using Red Hat OpenShift uncomment this:  </span></span><br><span class="line">          <span class="comment">#privileged: true  </span></span><br><span class="line">        <span class="attr">resources:</span>  </span><br><span class="line">          <span class="attr">limits:</span>  </span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span>  </span><br><span class="line">          <span class="attr">requests:</span>  </span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span>  </span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span>  </span><br><span class="line">        <span class="attr">volumeMounts:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span>  </span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/filebeat.yml</span>  </span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span>  </span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">filebeat.yml</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span>  </span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/filebeat/data</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span>  </span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/containerd/</span>  </span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span>  </span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span>  </span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">volumes:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span>  </span><br><span class="line">        <span class="attr">configMap:</span>  </span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">0600</span>  </span><br><span class="line">          <span class="attr">name:</span> <span class="string">filebeat-config</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span>  </span><br><span class="line">        <span class="attr">hostPath:</span>  </span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/containerd/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span>  </span><br><span class="line">        <span class="attr">hostPath:</span>  </span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span>  </span><br><span class="line">      <span class="comment"># data folder stores a registry of read status for all files, so we don't send everything again on a Filebeat pod restart  </span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span>  </span><br><span class="line">        <span class="attr">hostPath:</span>  </span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/filebeat-data</span>  </span><br><span class="line">          <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span>  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line"><span class="attr">subjects:</span>  </span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line"><span class="attr">roleRef:</span>  </span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span>  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line"><span class="attr">rules:</span>  </span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">""</span>] <span class="comment"># "" indicates the core API group  </span></span><br><span class="line">  <span class="attr">resources:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span>  </span><br><span class="line">  <span class="attr">verbs:</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span>  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span>  </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops</span></span><br><span class="line">  <span class="attr">labels:</span>  </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span>  </span><br><span class="line"><span class="meta">---  </span></span><br></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å¦‚é¢˜ï¼Œ ä¸»è¦è®°å½•ä¸€ä¸‹ä¹‹å‰æ­å»ºéƒ¨ç½²çš„ä¸€å¥—æ—¥å¿—æ”¶é›†ç³»ç»Ÿã€‚è¿™é‡Œé‡‡ç”¨docker-composeçš„æ–¹å¼è¿è¡Œï¼Œè¿˜æ˜¯é‚£å¥è¯ä¸»è¦æ˜¯æ€è·¯ã€‚&lt;/p&gt;
&lt;p&gt;æ–¹å¼: &lt;code&gt;ä¸€å°æœåŠ¡å™¨ä¸Šé¢åˆ©ç”¨docker-composeè¿è¡Œä¸‰ä¸ªESèŠ‚ç‚¹è·ŸKibana,å¹¶å¯ç”¨SSL,å†ä½¿ç”¨Filebeatæ¥æ”¶é›†æœåŠ¡å™¨ä¸Šé¢çš„åº”ç”¨æ—¥å¿—åˆ°ESï¼Œ æœ€åKibanaæ¥åšå±•ç¤º&lt;/code&gt;&lt;/p&gt;
&lt;h1 id=&quot;é…ç½®&quot;&gt;&lt;a href=&quot;#é…ç½®&quot; class=&quot;headerlink&quot; title=&quot;é…ç½®&quot;&gt;&lt;/a&gt;é…ç½®&lt;/h1&gt;&lt;h3 id=&quot;ç›®å½•åˆ›å»º&quot;&gt;&lt;a href=&quot;#ç›®å½•åˆ›å»º&quot; class=&quot;headerlink&quot; title=&quot;ç›®å½•åˆ›å»º&quot;&gt;&lt;/a&gt;ç›®å½•åˆ›å»º&lt;/h3&gt;&lt;figure class=&quot;highlight haskell&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title&quot;&gt;mkdir&lt;/span&gt; -p /&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;data&lt;/span&gt;/{&lt;span class=&quot;title&quot;&gt;es&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;node&lt;/span&gt;-1/{&lt;span class=&quot;title&quot;&gt;data&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;certs&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;logs&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;config&lt;/span&gt;},plugins}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title&quot;&gt;mkdir&lt;/span&gt; -p /&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;data&lt;/span&gt;/{&lt;span class=&quot;title&quot;&gt;es&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;node&lt;/span&gt;-2/{&lt;span class=&quot;title&quot;&gt;data&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;certs&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;logs&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;config&lt;/span&gt;},plugins}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title&quot;&gt;mkdir&lt;/span&gt; -p /&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;data&lt;/span&gt;/{&lt;span class=&quot;title&quot;&gt;es&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;node&lt;/span&gt;-3/{&lt;span class=&quot;title&quot;&gt;data&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;certs&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;logs&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;config&lt;/span&gt;},plugins}&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;title&quot;&gt;mkdir&lt;/span&gt; -p /&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;data&lt;/span&gt;/kibana/{&lt;span class=&quot;title&quot;&gt;certs&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;config&lt;/span&gt;} -p&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;éƒ¨ç½²æ–‡ä»¶&quot;&gt;&lt;a href=&quot;#éƒ¨ç½²æ–‡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;éƒ¨ç½²æ–‡ä»¶&quot;&gt;&lt;/a&gt;éƒ¨ç½²æ–‡ä»¶&lt;/h3&gt;&lt;figure class=&quot;highlight nix&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;params&quot;&gt;version:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;params&quot;&gt;services:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;params&quot;&gt;node-1:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;image:&lt;/span&gt; registry.cn-hangzhou.aliyuncs.com&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;bigdata_cloudnative&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;elasticsearch:&lt;span class=&quot;number&quot;&gt;7.17&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;networks:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;bitdata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;ipv4_address:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.20&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;0.3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;container_name:&lt;/span&gt; node-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;hostname:&lt;/span&gt; node-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;environment:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;TZ=Asia/Shanghai&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;ulimits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;memlock:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;soft:&lt;/span&gt; &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;hard:&lt;/span&gt; &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;nofile:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;soft:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;65536&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;hard:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;65536&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;9200:9200&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;logging:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;driver:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;json-file&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;options:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;max-size:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;50m&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;volumes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;config&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;elasticsearch.yml:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/config/elasticsearch.yml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;plugins:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/plugins&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;data:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/data&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;certs:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/config/certs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;log:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/log&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;healthcheck:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;test:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;CMD-SHELL&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;curl -I http://localhost:9200 || exit 1&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;interval:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;timeout:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;retries:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;params&quot;&gt;node-2:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;image:&lt;/span&gt; registry.cn-hangzhou.aliyuncs.com&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;bigdata_cloudnative&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;elasticsearch:&lt;span class=&quot;number&quot;&gt;7.17&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;networks:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;bitdata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;ipv4_address:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.20&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;0.4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;container_name:&lt;/span&gt; node-&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;hostname:&lt;/span&gt; node-&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;environment:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;TZ=Asia/Shanghai&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;ulimits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;memlock:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;soft:&lt;/span&gt; &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;hard:&lt;/span&gt; &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;nofile:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;soft:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;65536&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;hard:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;65536&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;9201:9200&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;logging:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;driver:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;json-file&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;options:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;max-size:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;50m&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;volumes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;config&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;elasticsearch.yml:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/config/elasticsearch.yml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;plugins:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/plugins&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;data:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/data&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;certs:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/config/certs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;log:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/log&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;healthcheck:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;test:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;CMD-SHELL&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;curl -I http://localhost:9200 || exit 1&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;interval:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;timeout:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;retries:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;params&quot;&gt;node-3:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;image:&lt;/span&gt; registry.cn-hangzhou.aliyuncs.com&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;bigdata_cloudnative&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;elasticsearch:&lt;span class=&quot;number&quot;&gt;7.17&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;networks:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;bitdata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;ipv4_address:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.20&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;0.5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;container_name:&lt;/span&gt; node-&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;hostname:&lt;/span&gt; node-&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;environment:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;ES_JAVA_OPTS=-Xms1024m -Xmx1024m&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;TZ=Asia/Shanghai&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;ulimits:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;memlock:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;soft:&lt;/span&gt; &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;hard:&lt;/span&gt; &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;nofile:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;soft:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;65536&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;hard:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;65536&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;9202:9200&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;logging:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;driver:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;json-file&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;options:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;max-size:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;50m&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;volumes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;config&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;elasticsearch.yml:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/config/elasticsearch.yml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;plugins:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/plugins&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;data:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/data&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;certs:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/config/certs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;es&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;node-&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;log:&lt;span class=&quot;symbol&quot;&gt;/usr/share/elasticsearch/log&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;healthcheck:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;test:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;CMD-SHELL&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;curl -I http://localhost:9200 || exit 1&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;interval:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;timeout:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;retries:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;params&quot;&gt;kibana:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;networks:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;bitdata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;params&quot;&gt;ipv4_address:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.20&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;0.6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;container_name:&lt;/span&gt; kibana&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;hostname:&lt;/span&gt; kibana&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;image:&lt;/span&gt; registry.cn-hangzhou.aliyuncs.com&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;bigdata_cloudnative&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;kibana:&lt;span class=&quot;number&quot;&gt;7.17&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;environment:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;TZ:&lt;/span&gt; &#39;Asia&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;Shanghai&#39;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;volumes:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;kibana&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;cert:&lt;span class=&quot;symbol&quot;&gt;/etc/kibana/cert&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; .&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;kibana&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;config&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;kibana.yml:&lt;span class=&quot;symbol&quot;&gt;/usr/share/kibana/config/kibana.yml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;ports:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5601&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;5601&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;healthcheck:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;test:&lt;/span&gt; [&lt;span class=&quot;string&quot;&gt;&quot;CMD-SHELL&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;curl -I http://localhost:5601 || exit 1&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;interval:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;timeout:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;s&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;retries:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# è¿æ¥å¤–éƒ¨ç½‘ç»œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;params&quot;&gt;networks:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;params&quot;&gt;bitdata:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;driver:&lt;/span&gt; bridge&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;params&quot;&gt;ipam:&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;params&quot;&gt;config:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;operator&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;subnet:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;172.20&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;24&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;éSSL&quot;&gt;&lt;a href=&quot;#éSSL&quot; class=&quot;headerlink&quot; title=&quot;éSSL&quot;&gt;&lt;/a&gt;éSSL&lt;/h2&gt;&lt;h3 id=&quot;elasticsearch-yamlé…ç½®æ–‡ä»¶&quot;&gt;&lt;a href=&quot;#elasticsearch-yamlé…ç½®æ–‡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;elasticsearch.yamlé…ç½®æ–‡ä»¶&quot;&gt;&lt;/a&gt;elasticsearch.yamlé…ç½®æ–‡ä»¶&lt;/h3&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åˆ©ç”¨ElastAlert2å¯¹ESä¸­çš„æ—¥å¿—åˆ›å»ºå‘Šè­¦</title>
    <link href="https://blog.sctux.cc/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/"/>
    <id>https://blog.sctux.cc/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/</id>
    <published>2024-07-16T09:56:39.000Z</published>
    <updated>2025-09-01T01:59:08.942Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>çº¿ä¸ŠAPIæœåŠ¡å‡ºç°äº†5xxçš„è¯·æ±‚é”™è¯¯, æœªèƒ½åœ¨ç¬¬ä¸€æ—¶é—´å‘ç°å¯¼è‡´ç”¨æˆ·ä¸»åŠ¨å‘å›¢é˜ŸæŠ¥å‘Šæ¥å£æœ‰å¼‚å¸¸ï¼Œ ç”±äºAPIçš„æ¥å£æ¯”è¾ƒå¤šï¼Œä¹Ÿåªæ˜¯ç›‘æ§äº†éƒ¨åˆ†ï¼Œäº‹åé€šè¿‡æ—¥å¿—æ‰å‘ç°çš„ç¡®ç”¨æˆ·ä¾§åœ¨å¯¹æŸä¸ªæ¥å£è®¿é—®æ—¶ï¼Œé¢‘ç¹å‡ºç°5xxå‘Šè­¦ï¼Œæˆ‘è¿™è¾¹ä¹Ÿæ²¡æœ‰æ”¶åˆ°ä»€ä¹ˆé€šçŸ¥ï¼Œç›®å‰å…ˆæš‚ä¸”ä¸è¯´å‡ºç°5xxæ˜¯ä»€ä¹ˆé€ æˆçš„ï¼Œè€Œæ˜¯åœ¨APIæ¥å£å“åº”çŠ¶æ€çš„ç›‘æ§æ–¹é¢æ²¡æœ‰åšåˆ°å¾ˆåˆ°ä½ï¼Œ æ‰€ä»¥éœ€è¦å¯¹Nginxæ—¥å¿—ä¸­çš„çŠ¶æ€ä¸º5xxçš„è¯·æ±‚ç›‘æ§å‘Šè­¦ï¼Œä»¥ä¾¿èƒ½å¿«é€Ÿå“åº”ï¼Œè§£å†³é—®é¢˜ã€‚</p><h1 id="ElastAlert2"><a href="#ElastAlert2" class="headerlink" title="ElastAlert2"></a>ElastAlert2</h1><p>ElastAlert 2æ˜¯ä¸€ä¸ªç®€å•çš„æ¡†æ¶ï¼Œç”¨äºå¯¹æ¥è‡ª Elasticsearch å’Œ OpenSearch çš„æ•°æ®çš„å¼‚å¸¸ã€å°–å³°æˆ–å…¶ä»–æ„Ÿå…´è¶£çš„æ¨¡å¼å‘å‡ºè­¦æŠ¥ã€‚</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://elastalert2.readthedocs.io/en/latest/">https://elastalert2.readthedocs.io/en/latest/</a></p><p>Github: <a href="https://github.com/jertel/elastalert2">https://github.com/jertel/elastalert2</a></p><h1 id="é…ç½®éƒ¨ç½²"><a href="#é…ç½®éƒ¨ç½²" class="headerlink" title="é…ç½®éƒ¨ç½²"></a>é…ç½®éƒ¨ç½²</h1><p>å½“ç„¶è¿˜æ˜¯é€‰æ‹©å®¹å™¨åŒ–æ–¹å¼è¿è¡Œï¼Œå®˜æ–¹ä¹Ÿæä¾›å¾—æœ‰é•œåƒï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker pull jertel/elastalert2</span><br></pre></td></tr></tbody></table></figure><h3 id="é…ç½®æ–‡ä»¶é…ç½®"><a href="#é…ç½®æ–‡ä»¶é…ç½®" class="headerlink" title="é…ç½®æ–‡ä»¶é…ç½®"></a>é…ç½®æ–‡ä»¶é…ç½®</h3><p>å¯å‚è€ƒ <a href="https://github.com/jertel/elastalert2">https://github.com/jertel/elastalert2</a>  ç›®å½•ä¸­çš„ <code>examples/config.yaml.example</code></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/opt/elastalert2/{data,rules}</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">/opt/elastalert2/config.yaml</span></span><br><span class="line"><span class="attr">rules_folder:</span> <span class="string">rules</span> <span class="comment"># å­˜æ”¾è§„åˆ™æ–‡ä»¶çš„ç›®å½•ï¼Œè¿™ä¸ªç›®å½•éœ€è¦æŒ‚è½½åˆ°/opt/elastalert/ä¸‹</span></span><br><span class="line"><span class="attr">run_every:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">buffer_time:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">es_host:</span> <span class="number">10.10</span><span class="number">.20</span><span class="number">.23</span></span><br><span class="line"><span class="attr">es_port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">use_ssl:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">verify_certs:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">ca_certs:</span> <span class="string">/opt/elastalert/ca.crt</span> <span class="comment"># å¦‚æœé›†ç¾¤å¯ç”¨äº†sslè®°å¾—è¦æŠŠcaè¯ä¹¦æŒ‚åœ¨åˆ°å®¹å™¨çš„è¿™ä¸ªä½ç½®</span></span><br><span class="line"><span class="attr">ssl_show_warn:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">es_send_get_body_as:</span> <span class="string">GET</span></span><br><span class="line"><span class="attr">es_username:</span> <span class="comment"># YOUR ES USERNAME</span></span><br><span class="line"><span class="attr">es_password:</span> <span class="comment"># YOUR ES PASSWORD</span></span><br><span class="line"><span class="attr">writeback_index:</span> <span class="string">elastalert_status</span></span><br><span class="line"><span class="attr">alert_time_limit:</span></span><br><span class="line">  <span class="attr">days:</span> <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Ruleè§„åˆ™é…ç½®"><a href="#Ruleè§„åˆ™é…ç½®" class="headerlink" title="Ruleè§„åˆ™é…ç½®"></a>Ruleè§„åˆ™é…ç½®</h3><p>æˆ‘ä»¬ç½‘å…³æœåŠ¡å™¨çš„Nginxæ—¥å¿—æ˜¯é€šè¿‡filebeatå†™åˆ°Elasticsearchçš„ï¼Œä¹Ÿåšå¥½äº†indexï¼Œå…¶å®åœ¨ELK ç•Œé¢ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™äº›çŠ¶æ€æ•°æ®ï¼Œä½†æ˜¯ä»…ä»…åªæ˜¯å±•ç¤ºï¼Œæ²¡æœ‰å‘Šè­¦ï¼Œæ‰€ä»¥æ‰æœ‰äº†è¿™ç¯‡blogã€‚</p><p>åˆ›å»ºä¸€ä¸ªé’ˆå¯¹ æŸä¸ªAPIåŸŸåçš„æ—¥å¿—çš„çŠ¶æ€ç›‘æ§æ–‡ä»¶ï¼š </p><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vim  /opt/elastalert2/rules/mainnet-api.xxxxx.yaml</span></span><br><span class="line"><span class="attribute">#ruleåå­—,å¿…é¡»å”¯ä¸€</span></span><br><span class="line"><span class="attribute">name</span><span class="punctuation">:</span> <span class="string">The number of times this request responds with a status code of 5xx in the log is greater than 5 times within 1 minute, please pay attention(mainnet-api.xxxxx)!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç±»å‹,å®˜æ–¹æä¾›å¤šç§ç±»å‹</span></span><br><span class="line"><span class="attribute">type</span><span class="punctuation">:</span> <span class="string">frequency</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ESç´¢å¼•,æ”¯æŒé€šé…ç¬¦</span></span><br><span class="line"><span class="attribute">index</span><span class="punctuation">:</span> <span class="string">proxy-mainnet-api.xxxxx.log-*</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åœ¨timeframeæ—¶é—´å†…,åŒ¹é…åˆ°å¤šå°‘ä¸ªç»“æœä¾¿å‘Šè­¦</span></span><br><span class="line"><span class="attribute">num_events</span><span class="punctuation">:</span> <span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç›‘æ§å‘¨æœŸ.é»˜è®¤æ˜¯minutes: 1</span></span><br><span class="line"><span class="attribute">timeframe</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">seconds</span><span class="punctuation">:</span> <span class="string">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#åŒ¹é…æ¨¡å¼.è¿™é‡Œæˆ‘åŒ¹é…çš„æ˜¯500â€”599çš„æ‰€æœ‰å¯èƒ½ä¼šå‡ºç°çš„çŠ¶æ€ç </span></span><br><span class="line"><span class="attribute">filter</span><span class="punctuation">:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">range:</span></span><br><span class="line">    <span class="attribute">status</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">from</span><span class="punctuation">:</span> <span class="string">500</span></span><br><span class="line">      <span class="attribute">to</span><span class="punctuation">:</span> <span class="string">599</span></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰å‘é€æ ¼å¼(start)</span></span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š ä»¥ä¸‹å¯ä»¥è‡ªå®šä¹‰å‘é€çš„å†…å®¹ï¼Œå¦‚æœä»€ä¹ˆéƒ½ä¸æŒ‡å®šï¼Œä¼šå‘é€ElastAlert2åŸç”Ÿçš„ä¸€å¤§å †jsonæ ¼å¼çš„å†…å®¹ï¼Œæ˜“è¯»æ€§å¾ˆä½ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºäº†å†…å®¹ç®€ä»‹ï¼Œæˆ‘è¿™é‡Œå°±åªæ˜¯å®šä¹‰äº†è¿™äº›å†…å®¹ï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">alert_text_type</span><span class="punctuation">:</span> <span class="string">alert_text_only</span></span><br><span class="line"><span class="attribute">alert_text</span><span class="punctuation">:</span> <span class="string">" </span></span><br><span class="line">  <span class="attribute">å“åº”çŠ¶æ€ç </span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">å‘ç”Ÿæ—¶é—´UTC</span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">ES Index</span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">num_hits</span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">è¯·æ±‚URL</span><span class="punctuation">:</span> <span class="string">https://mainnet-api.xxxxx{} \n</span></span><br><span class="line">  <span class="attribute">ClientIP</span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">num_matches</span><span class="punctuation">:</span> <span class="string">{} \n</span></span><br><span class="line">  <span class="attribute">http_user_agent</span><span class="punctuation">:</span> <span class="string">{}</span></span><br><span class="line"><span class="attribute">"</span></span><br><span class="line"><span class="attribute">alert_text_args</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">status</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"@timestamp"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">_index</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">num_hits</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">request_uri</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">http_x_forwarded_for</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">num_matches</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">http_user_agent</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰å‘é€æ ¼å¼(end)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œé€‰æ‹©ä½¿ç”¨çš„æ˜¯Discordæ¥æ¥æ”¶é€šçŸ¥ï¼ŒElastAlert2å…¶å®å¾ˆå¼ºå¤§ï¼Œæ”¯æŒå¾ˆå¤šæ¸ é“çš„å‘Šè­¦</span></span><br><span class="line"><span class="comment"># è¿™é‡Œå‘ç°å¹¶ä¸èƒ½åŒæ—¶å¤šä¸ªæ¸ é“å‘é€å‘Šè­¦æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"># å¦‚æœéœ€è¦å¤šä¸ªå‘Šè­¦æ¸ é“ï¼Œå¯ä»¥å†™ä¸€ä¸ªç±»ä¼¼äºAlertCenterçš„æœåŠ¡ï¼Œé€šè¿‡è¿™ä¸ªæœåŠ¡æ•´åˆåå‘é€åˆ°ä¸åŒçš„æ¸ é“ï¼Œè¿™é‡Œè¿™æ˜¯ä¸ªæ€è·¯ï¼Œç›®å‰å…ˆæ»¡è¶³éœ€æ±‚</span></span><br><span class="line"><span class="attribute">alert</span><span class="punctuation">:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"discord"</span></span><br><span class="line"><span class="attribute">discord_webhook_url</span><span class="punctuation">:</span> <span class="string">"YOUR DISCORD WEBHOOK URL"</span></span><br><span class="line"><span class="attribute">discord_emoji_title</span><span class="punctuation">:</span> <span class="string">":lock:"</span></span><br><span class="line"><span class="attribute">discord_embed_color</span><span class="punctuation">:</span> <span class="string">0xE24D42</span></span><br><span class="line"><span class="attribute">discord_embed_footer</span><span class="punctuation">:</span> <span class="string">"Message sent by from api status moniotor(for @noardguo)"</span></span><br><span class="line"><span class="attribute">discord_embed_icon_url</span><span class="punctuation">:</span> <span class="string">"https://humancoders-formations.s3.amazonaws.com/uploads/course/logo/38/thumb_bigger_formation-elasticsearch.png"</span></span><br></pre></td></tr></tbody></table></figure><h3 id="éƒ¨ç½²è¿è¡Œ"><a href="#éƒ¨ç½²è¿è¡Œ" class="headerlink" title="éƒ¨ç½²è¿è¡Œ"></a>éƒ¨ç½²è¿è¡Œ</h3><p>ä¸Šé¢å·²ç»å‡†å¤‡å¥½äº†æ‰€éœ€è¦çš„æ–‡ä»¶ï¼š</p><figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@ip</span><span class="number">-10</span><span class="number">-10</span><span class="number">-10</span><span class="number">-11</span><span class="symbol">:/opt/elastalert2</span><span class="comment"># tree -L 2</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ ca.crt</span><br><span class="line">â”œâ”€â”€ config.yaml</span><br><span class="line">â”œâ”€â”€ data</span><br><span class="line">â””â”€â”€ rules</span><br><span class="line">    â”œâ”€â”€ mainnet-api.xxxxx.yml</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> directories, <span class="number">3</span> files</span><br></pre></td></tr></tbody></table></figure><p>docker æ–¹å¼è¿è¡Œï¼š</p><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=elastalert2 \</span><br><span class="line">--env=TZ=Asia/Shanghai \</span><br><span class="line">--volume=/<span class="keyword">opt</span>/elastalert2/data:/<span class="keyword">opt</span>/elastalert/data \</span><br><span class="line">--volume=/<span class="keyword">opt</span>/elastalert2/config.yaml:/<span class="keyword">opt</span>/elastalert/config.yaml \</span><br><span class="line">--volume=/<span class="keyword">opt</span>/elastalert2/rules:/<span class="keyword">opt</span>/elastalert/rules \</span><br><span class="line">--volume=/<span class="keyword">opt</span>/elastalert2/<span class="keyword">ca</span>.crt:/<span class="keyword">opt</span>/elastalert/<span class="keyword">ca</span>.crt \</span><br><span class="line">--restart=always \</span><br><span class="line">jertel/elastalert2 </span><br><span class="line"></span><br><span class="line">root@ip-<span class="number">10</span>-<span class="number">10</span>-<span class="number">10</span>-<span class="number">11</span>:/<span class="keyword">opt</span>/elastalert2# docker logs -<span class="keyword">f</span> wonderful_tharp</span><br><span class="line">Reading Elastic <span class="number">7</span> <span class="built_in">index</span> mappings:</span><br><span class="line">Reading <span class="built_in">index</span> mapping <span class="string">'es_mappings/7/silence.json'</span></span><br><span class="line">Reading <span class="built_in">index</span> mapping <span class="string">'es_mappings/7/elastalert_status.json'</span></span><br><span class="line">Reading <span class="built_in">index</span> mapping <span class="string">'es_mappings/7/elastalert.json'</span></span><br><span class="line">Reading <span class="built_in">index</span> mapping <span class="string">'es_mappings/7/past_elastalert.json'</span></span><br><span class="line">Reading <span class="built_in">index</span> mapping <span class="string">'es_mappings/7/elastalert_error.json'</span></span><br><span class="line">Index elastalert_status already <span class="built_in">exists</span>. Skipping <span class="built_in">index</span> creation.</span><br><span class="line">WARNING:<span class="keyword">py</span>.warnings:/usr/local/lib/<span class="keyword">python3</span>.<span class="number">12</span>/site-packages/elasticsearch/connection/base.<span class="keyword">py</span>:<span class="number">193</span>: ElasticsearchDeprecationWarning: Camel case format name dateOptionalTime <span class="keyword">is</span> deprecated <span class="built_in">and</span> will <span class="keyword">be</span> removed in <span class="keyword">a</span> future <span class="keyword">version</span>. Use snake case name date_optional_time instead.</span><br><span class="line">  warnings.warn(message, category=ElasticsearchDeprecationWarning)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæ²¡æœ‰æŠ¥é”™å°±è¯´æ˜è¿è¡Œæ­£å¸¸ï¼Œæ­¤æ—¶ä»kibanaé¢æ¿ä¹Ÿå¯ä»¥çœ‹åˆ°ElaltAlert2ç”Ÿæˆäº†ç›‘æ§å‘Šè­¦æ‰€éœ€è¦çš„index:<br><img src="/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/1.jpeg"></p><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>å½“è¿è¡Œèµ·æ¥åï¼Œæ­¤æ—¶å°±æ˜¯æ˜¯æ—¶é—´ç›‘æ§æ—¥å¿—æ–‡ä»¶çš„ä¸€ä¸ªçŠ¶æ€</p><p>åœ¨ç½‘å…³æœåŠ¡å™¨ä¸Šé¢echoä¸€æ®µå¸¦æœ‰statusä¸º500çš„messageåˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">echo</span> '''{<span class="string">"@timestamp"</span>:<span class="string">"2024-07-16T20:28:10+08:00"</span>,<span class="string">"server_addr"</span>:<span class="string">"110.10.30.187"</span>,<span class="string">"remote_addr"</span>:<span class="string">"10.10.10.248"</span>,<span class="string">"http_x_forwarded_for"</span>:<span class="string">"172.104.86.126, 172.68.119.188"</span>,<span class="string">"scheme"</span>:<span class="string">"http"</span>,<span class="string">"request_method"</span>:<span class="string">"POST"</span>,<span class="string">"request_uri"</span>: <span class="string">"Alert_Test"</span>,<span class="string">"request_length"</span>: <span class="string">"953"</span>,<span class="string">"uri"</span>: <span class="string">"/api/v1/alerttest"</span>, <span class="string">"request_time"</span>:<span class="number">0</span>.<span class="number">002</span>,<span class="string">"body_bytes_sent"</span>:<span class="number">0</span>,<span class="string">"bytes_sent"</span>:<span class="number">335</span>,<span class="string">"status"</span>:<span class="string">"500"</span>,<span class="string">"upstream_time"</span>:<span class="string">"0.002"</span>,<span class="string">"upstream_host"</span>:<span class="string">"10.10.10.139:31333"</span>,<span class="string">"upstream_status"</span>:<span class="string">"200"</span>,<span class="string">"host"</span>:<span class="string">"mainnet-api.xxxxxx"</span>,<span class="string">"http_referer"</span>:<span class="string">"https://test.xyz/"</span>,<span class="string">"http_user_agent"</span>:<span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36"</span>}''' &gt;&gt; mainnet-api.xxxxxx.log</span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ—¶æŸ¥çœ‹ indexå·²ç»è®°å½•åˆ°è¿™æ¡å‘Šè­¦æ¶ˆæ¯, é€šè¿‡æŸ¥è¯¢ç´¢å¼•ä¹Ÿæ‰¾åˆ°äº†è¿™ä¸ªè¯·æ±‚</p><p><img src="/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/2.jpeg"></p><p><img src="/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/4.png"></p><p>åŒæ—¶ï¼ŒDiscordä¹Ÿæ”¶åˆ°äº†å‘Šè­¦é€šçŸ¥</p><p><img src="/2024/07/16/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8ElastAlert2%E5%AF%B9ES%E4%B8%AD%E7%9A%84%E6%97%A5%E5%BF%97%E5%88%9B%E5%BB%BA%E5%91%8A%E8%AD%A6/3.png"></p><p>æœ€åï¼Œå› ä¸ºæˆ‘ä»¬è·‘äº†k8s,ä¸‹é¢ç›´æ¥æŠŠç›¸å…³æ–‡ä»¶ç”¨configmapæ–¹å¼æŒ‚è½½è¿›å»ï¼Œè¿è¡Œä¸€ä¸ªDeploymentå‰¯æœ¬å³å¯ã€‚</p><ul><li>elastalert-config.yaml</li></ul><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  config.<span class="params">yaml:</span> |-</span><br><span class="line">    <span class="params">rules_folder:</span> rules</span><br><span class="line">    <span class="params">run_every:</span></span><br><span class="line">      <span class="params">minutes:</span> <span class="number">1</span></span><br><span class="line">    <span class="params">buffer_time:</span></span><br><span class="line">      <span class="params">minutes:</span> <span class="number">15</span></span><br><span class="line">    <span class="params">es_host:</span> <span class="number">10.10</span>.<span class="number">20.23</span></span><br><span class="line">    <span class="params">es_port:</span> <span class="number">9200</span></span><br><span class="line">    <span class="params">use_ssl:</span> True</span><br><span class="line">    <span class="params">verify_certs:</span> True</span><br><span class="line">    <span class="params">ca_certs:</span> <span class="symbol">/opt/elastalert/ca.crt</span></span><br><span class="line">    <span class="params">ssl_show_warn:</span> True</span><br><span class="line">    <span class="params">es_send_get_body_as:</span> GET</span><br><span class="line">    <span class="params">es_username:</span> elastic</span><br><span class="line">    <span class="params">es_password:</span> A2VdKUHHFoUmlyekVFgd</span><br><span class="line">    <span class="params">writeback_index:</span> elastalert_status</span><br><span class="line">    <span class="params">alert_time_limit:</span></span><br><span class="line">      <span class="params">days:</span> <span class="number">2</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> elastalert-config</span><br><span class="line">  <span class="params">namespace:</span> monitor</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><ul><li>ealstalert-rules.yaml</li></ul><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  mainnet-api.xxxxxx.<span class="params">yml:</span> <span class="string">"#ruleåå­—,å¿…é¡»å”¯ä¸€<span class="char escape_">\n</span>name: The number of times this</span></span><br><span class="line"><span class="string">    request responds with a status code of 5xx in the log is greater than 5 times</span></span><br><span class="line"><span class="string">    within 1 minute, please pay attention(mainnet-api.xxxxx)!<span class="char escape_">\n</span><span class="char escape_">\n</span>#ç±»å‹,å®˜æ–¹æä¾›å¤šç§ç±»å‹<span class="char escape_">\n</span>type:</span></span><br><span class="line"><span class="string">    frequency<span class="char escape_">\n</span><span class="char escape_">\n</span>#ESç´¢å¼•,æ”¯æŒé€šé…ç¬¦<span class="char escape_">\n</span>index: proxy-mainnet-api.xxxxx.log-*<span class="char escape_">\n</span><span class="char escape_">\n</span>#åœ¨timeframeæ—¶é—´å†…,åŒ¹é…åˆ°å¤šå°‘ä¸ªç»“æœä¾¿å‘Šè­¦<span class="char escape_">\n</span>num_events:</span></span><br><span class="line"><span class="string">    1<span class="char escape_">\n</span><span class="char escape_">\n</span>#ç›‘æ§å‘¨æœŸ.é»˜è®¤æ˜¯minutes: 1<span class="char escape_">\n</span>timeframe:<span class="char escape_">\n</span>  seconds: 5  <span class="char escape_">\n</span>  <span class="char escape_">\n</span>#åŒ¹é…æ¨¡å¼.<span class="char escape_">\n</span>filter:<span class="char escape_">\n</span>- range:<span class="char escape_">\n</span></span></span><br><span class="line"><span class="string">    <span class="char escape_">\ </span>  status:<span class="char escape_">\n</span>      from: 500<span class="char escape_">\n</span>      to: 599<span class="char escape_">\n</span>      <span class="char escape_">\n</span>alert_text_type: alert_text_only<span class="char escape_">\n</span>alert_text:</span></span><br><span class="line"><span class="string">    <span class="char escape_">\"</span> <span class="char escape_">\n</span>  å“åº”çŠ¶æ€ç : {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  å‘ç”Ÿæ—¶é—´UTC: {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  ES Index: {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  num_hits: {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span></span></span><br><span class="line"><span class="string">    <span class="char escape_">\ </span>è¯·æ±‚URL: https://mainnet-api.xxxxx.org{} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  ClientIP: {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  num_matches:</span></span><br><span class="line"><span class="string">    {} <span class="char escape_">\\</span>n<span class="char escape_">\n</span>  http_user_agent: {}<span class="char escape_">\n</span><span class="char escape_">\"</span><span class="char escape_">\n</span>alert_text_args:<span class="char escape_">\n</span>    - status<span class="char escape_">\n</span>    - <span class="char escape_">\"</span>@timestamp<span class="char escape_">\"</span><span class="char escape_">\n</span></span></span><br><span class="line"><span class="string">    <span class="char escape_">\ </span>  - _index<span class="char escape_">\n</span>    - num_hits<span class="char escape_">\n</span>    - request_uri<span class="char escape_">\n</span>    - http_x_forwarded_for<span class="char escape_">\n</span></span></span><br><span class="line"><span class="string">    <span class="char escape_">\ </span>  - num_matches<span class="char escape_">\n</span>    - http_user_agent<span class="char escape_">\n</span>      <span class="char escape_">\n</span>      <span class="char escape_">\n</span>alert:<span class="char escape_">\n</span>- <span class="char escape_">\"</span>discord<span class="char escape_">\"</span><span class="char escape_">\n</span>#discord_webhook_url:</span></span><br><span class="line"><span class="string">    <span class="char escape_">\"</span>DISCORD_WEBHOOK_URL"</span>\<span class="params">ndiscord_webhook_url:</span></span><br><span class="line">    \<span class="string">"https://https://discord.com/api/webhooks/1196752947493752933/VRQ01W1pT0PHpl55z0hayqsyjWzt3bzXUMSA4-_5W56fn9j5Nl1zDQT7ZtU_CQWnnlYH<span class="char escape_">\"</span><span class="char escape_">\n</span>discord_emoji_title:</span></span><br><span class="line"><span class="string">    <span class="char escape_">\"</span>:lock:<span class="char escape_">\"</span><span class="char escape_">\n</span>discord_embed_color: 0xE24D42<span class="char escape_">\n</span>discord_embed_footer: <span class="char escape_">\"</span>Message sent</span></span><br><span class="line"><span class="string">    by from api status moniotor(for @Ops-NoardGuo)<span class="char escape_">\"</span><span class="char escape_">\n</span>discord_embed_icon_url: <span class="char escape_">\"</span>https://humancoders-formations.s3.amazonaws.com/uploads/course/logo/38/thumb_bigger_formation-elasticsearch.png<span class="char escape_">\"</span></span></span><br><span class="line"><span class="string">kind: ConfigMap</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: ealstalert-rules</span></span><br><span class="line"><span class="string">  namespace: monitor</span></span><br></pre></td></tr></tbody></table></figure><ul><li><p>ca.crt<br>ç•¥</p></li><li><p>elastalert-deployment.yaml</p></li></ul><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">k8s.kuboard.cn/displayName:</span> <span class="string">elastalert</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s.kuboard.cn/name:</span> <span class="string">elastalert</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elastalert</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s.kuboard.cn/name:</span> <span class="string">elastalert</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s.kuboard.cn/name:</span> <span class="string">elastalert</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">'--verbose'</span> <span class="comment"># è¿™é‡ŒæŒ‡å®šå‚æ•°æ˜¯é»˜è®¤é•œåƒé‡Œé¢å¯ä»¥è·å–çš„å‚æ•°ï¼Œç”¨äºå®šä¹‰æ—¥å¿—è®°å½• æ’é”™æˆ–è€…è¿è¡ŒçŠ¶æ€æŸ¥çœ‹</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">jertel/elastalert2</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">elastalert</span></span><br><span class="line">          <span class="attr">resources:</span> {}</span><br><span class="line">          <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">          <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/opt/elastalert/config.yaml</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">volume-ps74r</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">config.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/opt/elastalert/rules/</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">rules</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/opt/elastalert/ca.crt</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">volume-zmdx7</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">ca.crt</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> {}</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">elastalert-config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">volume-ps74r</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">mainnet-api.xxxxx.yml</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">mainnet-api.xxxxx.yml</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">ealstalert-rules</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">rules</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">elasticsearch-ca.crt</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">volume-zmdx7</span></span><br></pre></td></tr></tbody></table></figure><p>è‡³æ­¤å‘Šè­¦åŠŸèƒ½å·²ç»å®ç°ï¼Œä»¥ä¸Šåªæ˜¯ä¸€ä¸ªå¤§ä½“çš„æ€è·¯ï¼Œä¸ä»…ä»…ç›‘æ§çš„å¯ä»¥æ˜¯çŠ¶æ€ç ï¼Œåº”è¯¥æ˜¯ä½ èƒ½æƒ³åˆ°çš„ï¼Œä»–èƒ½æä¾›çš„éƒ½å¯ä»¥ç›‘æ§èµ·æ¥ã€‚</p><p>å¥½å•¦ï¼Œæˆ‘è¦å»çœ‹5xxçš„æŠ¥é”™åŸå› äº†ğŸ˜€</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;çº¿ä¸ŠAPIæœåŠ¡å‡ºç°äº†5xxçš„è¯·æ±‚é”™è¯¯, æœªèƒ½åœ¨ç¬¬ä¸€æ—¶é—´å‘ç°å¯¼è‡´ç”¨æˆ·ä¸»åŠ¨å‘å›¢é˜ŸæŠ¥å‘Šæ¥å£æœ‰å¼‚å¸¸ï¼Œ ç”±äºAPIçš„æ¥å£æ¯”è¾ƒå¤šï¼Œä¹Ÿåªæ˜¯ç›‘æ§äº†éƒ¨åˆ†ï¼Œäº‹åé€šè¿‡æ—¥å¿—æ‰å‘ç°çš„ç¡®ç”¨æˆ·ä¾§åœ¨å¯¹æŸä¸ªæ¥å£è®¿é—®æ—¶ï¼Œé¢‘ç¹å‡ºç°5xxå‘Šè­¦ï¼Œæˆ‘è¿™è¾¹ä¹Ÿæ²¡æœ‰æ”¶åˆ°ä»€ä¹ˆé€šçŸ¥ï¼Œç›®å‰å…ˆæš‚ä¸”ä¸è¯´å‡ºç°5xxæ˜¯ä»€ä¹ˆé€ æˆçš„ï¼Œè€Œæ˜¯åœ¨APIæ¥å£å“åº”çŠ¶æ€çš„ç›‘æ§æ–¹é¢æ²¡æœ‰åšåˆ°å¾ˆåˆ°ä½ï¼Œ æ‰€ä»¥éœ€è¦å¯¹Nginxæ—¥å¿—ä¸­çš„çŠ¶æ€ä¸º5xxçš„è¯·æ±‚ç›‘æ§å‘Šè­¦ï¼Œä»¥ä¾¿èƒ½å¿«é€Ÿå“åº”ï¼Œè§£å†³é—®é¢˜ã€‚&lt;/p&gt;
&lt;h1 id=&quot;ElastAlert2&quot;&gt;&lt;a href=&quot;#ElastAlert2&quot; class=&quot;headerlink&quot; title=&quot;ElastAlert2&quot;&gt;&lt;/a&gt;ElastAlert2&lt;/h1&gt;&lt;p&gt;ElastAlert 2æ˜¯ä¸€ä¸ªç®€å•çš„æ¡†æ¶ï¼Œç”¨äºå¯¹æ¥è‡ª Elasticsearch å’Œ OpenSearch çš„æ•°æ®çš„å¼‚å¸¸ã€å°–å³°æˆ–å…¶ä»–æ„Ÿå…´è¶£çš„æ¨¡å¼å‘å‡ºè­¦æŠ¥ã€‚&lt;/p&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&quot;https://elastalert2.readthedocs.io/en/latest/&quot;&gt;https://elastalert2.readthedocs.io/en/latest/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Github: &lt;a href=&quot;https://github.com/jertel/elastalert2&quot;&gt;https://github.com/jertel/elastalert2&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;é…ç½®éƒ¨ç½²&quot;&gt;&lt;a href=&quot;#é…ç½®éƒ¨ç½²&quot; class=&quot;headerlink&quot; title=&quot;é…ç½®éƒ¨ç½²&quot;&gt;&lt;/a&gt;é…ç½®éƒ¨ç½²&lt;/h1&gt;&lt;p&gt;å½“ç„¶è¿˜æ˜¯é€‰æ‹©å®¹å™¨åŒ–æ–¹å¼è¿è¡Œï¼Œå®˜æ–¹ä¹Ÿæä¾›å¾—æœ‰é•œåƒï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;docker pull docker pull jertel/elastalert2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;é…ç½®æ–‡ä»¶é…ç½®&quot;&gt;&lt;a href=&quot;#é…ç½®æ–‡ä»¶é…ç½®&quot; class=&quot;headerlink&quot; title=&quot;é…ç½®æ–‡ä»¶é…ç½®&quot;&gt;&lt;/a&gt;é…ç½®æ–‡ä»¶é…ç½®&lt;/h3&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åˆ©ç”¨Pythonè·å–æ‰€æœ‰podå®¹å™¨çŠ¶æ€</title>
    <link href="https://blog.sctux.cc/2024/07/09/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Python%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89pod%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81/"/>
    <id>https://blog.sctux.cc/2024/07/09/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8Python%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89pod%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81/</id>
    <published>2024-07-09T09:38:00.000Z</published>
    <updated>2025-09-01T07:57:25.123Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨æ—¥å¸¸å·¡æ£€è¿‡ç¨‹å½“ä¸­ï¼Œä¸éœ€è¦ç™»å½•æœåŠ¡å™¨å»æŸ¥çœ‹ï¼Œé€šè¿‡è°ƒç”¨k8s apiçš„æ–¹å¼è·å–æ‰€æœ‰podçš„çŠ¶æ€</p><p>ç„¶ååœ¨æ¯å¤©9ç‚¹æ‰§è¡Œæœ¬è„šæœ¬å³å¯ã€‚</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> kubernetes <span class="keyword">import</span> client, config</span><br><span class="line"><span class="keyword">from</span> kubernetes.client.rest <span class="keyword">import</span> ApiException</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timezone</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> pytz</span><br><span class="line"><span class="comment"># åŠ è½½ Kubernetes é…ç½®</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é»˜è®¤ä¼šåœ¨masterèŠ‚ç‚¹å»è¯»å– ~/.kube/config æ–‡ä»¶</span></span><br><span class="line">config.load_kube_config()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º Kubernetes API å®¢æˆ·ç«¯å®ä¾‹</span></span><br><span class="line">api_instance = client.CoreV1Api()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šè¦è·å–çš„å‘½åç©ºé—´åˆ—è¡¨</span></span><br><span class="line">target_namespaces = [sys.argv[<span class="number">1</span>]]  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„ç›®æ ‡å‘½åç©ºé—´åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line">filtered_keywords = [<span class="string">"mysql"</span>, <span class="string">"redis"</span>, <span class="string">"memcached"</span>, <span class="string">"postgres"</span>, <span class="string">"backend"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Discord Webhook URL</span></span><br><span class="line">discord_webhook_url = <span class="string">""</span> <span class="comment"># FOR TEST</span></span><br><span class="line"><span class="comment"># æ›¿æ¢ä¸ºä½ çš„ Discord Webhook URL</span></span><br><span class="line">containers_without_restart = []  <span class="comment"># æ²¡æœ‰é‡å¯åŸå› çš„å®¹å™¨åˆ—è¡¨</span></span><br><span class="line">containers_with_restart = []  <span class="comment"># å…·æœ‰é‡å¯åŸå› çš„å®¹å™¨åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">for</span> target_namespace <span class="keyword">in</span> target_namespaces:</span><br><span class="line">        <span class="comment"># è·å–å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ Pod</span></span><br><span class="line">        pods = api_instance.list_namespaced_pod(namespace=target_namespace).items</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> pod <span class="keyword">in</span> pods:</span><br><span class="line">            pod_name = pod.metadata.name</span><br><span class="line">            pod_status = pod.status.phase</span><br><span class="line">            pod_restart_reason = <span class="string">""</span></span><br><span class="line">            pod_start_time = pod.metadata.creation_timestamp</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(keyword <span class="keyword">in</span> pod_name <span class="keyword">for</span> keyword <span class="keyword">in</span> filtered_keywords):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">            cst_timezone = pytz.timezone(<span class="string">"Asia/Shanghai"</span>)</span><br><span class="line">            current_time = datetime.now(timezone.utc)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è®¡ç®—è¿è¡Œæ—¶é•¿</span></span><br><span class="line">            <span class="keyword">if</span> pod_start_time <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                pod_duration = current_time - pod_start_time</span><br><span class="line">                pod_duration_str = <span class="built_in">str</span>(pod_duration).split(<span class="string">"."</span>)[<span class="number">0</span>]  <span class="comment"># æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå»æ‰å°æ•°éƒ¨åˆ†</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                pod_duration_str = <span class="string">"Unknown"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># æ£€æŸ¥ Pod æ˜¯å¦æœ‰é‡å¯è®°å½•</span></span><br><span class="line">            <span class="keyword">if</span> pod.status.container_statuses <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">for</span> container_status <span class="keyword">in</span> pod.status.container_statuses:</span><br><span class="line">                    restart_count = container_status.restart_count</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># å¦‚æœé‡å¯æ¬¡æ•°å¤§äº 0ï¼Œåˆ™è·å–é‡å¯åŸå› </span></span><br><span class="line">                    <span class="keyword">if</span> restart_count &gt; <span class="number">0</span>:</span><br><span class="line">                        pod_restart_reason = container_status.last_state.terminated.reason</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pod_restart_reason:</span><br><span class="line">                containers_with_restart.append(</span><br><span class="line">                    (pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count)</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                containers_without_restart.append(</span><br><span class="line">                    (pod_name, pod_status, pod_duration_str)</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç”Ÿæˆæ¶ˆæ¯</span></span><br><span class="line">    message = <span class="string">"ç¯å¢ƒ: {0} è·å–æ—¶é—´ï¼š{1}\n\n"</span>.<span class="built_in">format</span>(target_namespace,datetime.now(cst_timezone).strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>) + <span class="string">" CST"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ·»åŠ æ²¡æœ‰é‡å¯åŸå› çš„å®¹å™¨ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">for</span> container <span class="keyword">in</span> containers_without_restart:</span><br><span class="line">        pod_name, pod_status, pod_duration_str = container</span><br><span class="line">        message += <span class="string">"å®¹å™¨åç§°: {0}  å½“å‰çŠ¶æ€: {1}  è¿è¡Œæ—¶é•¿: {2}\n"</span>.<span class="built_in">format</span>(</span><br><span class="line">            pod_name, pod_status, pod_duration_str</span><br><span class="line">        )</span><br><span class="line">    message += <span class="string">"------------------------------------------------------\n"</span></span><br><span class="line">    <span class="comment"># æ·»åŠ å…·æœ‰é‡å¯åŸå› çš„å®¹å™¨ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">for</span> container <span class="keyword">in</span> containers_with_restart:</span><br><span class="line">        pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count = container</span><br><span class="line">        message += <span class="string">"å®¹å™¨åç§°: {0}  å½“å‰çŠ¶æ€: {1}  è¿è¡Œæ—¶é•¿: {2}  é‡å¯åŸå› : {3} é‡å¯æ¬¡æ•°ï¼š{4}\n"</span>.<span class="built_in">format</span>(</span><br><span class="line">            pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    message = <span class="string">"```{0}```"</span>.<span class="built_in">format</span>(message)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å‘é€æ¶ˆæ¯åˆ° Discord</span></span><br><span class="line">    payload = {<span class="string">"content"</span>: message}</span><br><span class="line">    headers = {<span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>}</span><br><span class="line">    response = requests.post(</span><br><span class="line">        discord_webhook_url, data=json.dumps(payload), headers=headers</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(response.content)</span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">204</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Message sent to Discord successfully"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"Failed to send message to Discord. Status code: <span class="subst">{response.status_code}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> ApiException <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"Exception when calling CoreV1Api: <span class="subst">{e}</span>\n"</span>)</span><br></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨æ—¥å¸¸å·¡æ£€è¿‡ç¨‹å½“ä¸­ï¼Œä¸éœ€è¦ç™»å½•æœåŠ¡å™¨å»æŸ¥çœ‹ï¼Œé€šè¿‡è°ƒç”¨k8s apiçš„æ–¹å¼è·å–æ‰€æœ‰podçš„çŠ¶æ€&lt;/p&gt;
&lt;p&gt;ç„¶ååœ¨æ¯å¤©9ç‚¹æ‰§è¡Œæœ¬è„šæœ¬å³å¯ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; kubernetes &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; client, config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; kubernetes.client.rest &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; ApiException&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; datetime &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; datetime, timezone&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; requests&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; sys&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; pytz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# åŠ è½½ Kubernetes é…ç½®&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#é»˜è®¤ä¼šåœ¨masterèŠ‚ç‚¹å»è¯»å– ~/.kube/config æ–‡ä»¶&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;config.load_kube_config()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# åˆ›å»º Kubernetes API å®¢æˆ·ç«¯å®ä¾‹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;api_instance = client.CoreV1Api()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æŒ‡å®šè¦è·å–çš„å‘½åç©ºé—´åˆ—è¡¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;target_namespaces = [sys.argv[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;]]  &lt;span class=&quot;comment&quot;&gt;# æ›¿æ¢ä¸ºä½ çš„ç›®æ ‡å‘½åç©ºé—´åˆ—è¡¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;filtered_keywords = [&lt;span class=&quot;string&quot;&gt;&quot;mysql&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;redis&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;memcached&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;postgres&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;backend&quot;&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Discord Webhook URL&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;discord_webhook_url = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# FOR TEST&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æ›¿æ¢ä¸ºä½ çš„ Discord Webhook URL&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;containers_without_restart = []  &lt;span class=&quot;comment&quot;&gt;# æ²¡æœ‰é‡å¯åŸå› çš„å®¹å™¨åˆ—è¡¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;containers_with_restart = []  &lt;span class=&quot;comment&quot;&gt;# å…·æœ‰é‡å¯åŸå› çš„å®¹å™¨åˆ—è¡¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; target_namespace &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; target_namespaces:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;# è·å–å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ Pod&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        pods = api_instance.list_namespaced_pod(namespace=target_namespace).items&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; pod &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; pods:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            pod_name = pod.metadata.name&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            pod_status = pod.status.phase&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            pod_restart_reason = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            pod_start_time = pod.metadata.creation_timestamp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;any&lt;/span&gt;(keyword &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; pod_name &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; keyword &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; filtered_keywords):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;# è·å–å½“å‰æ—¶é—´&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            cst_timezone = pytz.timezone(&lt;span class=&quot;string&quot;&gt;&quot;Asia/Shanghai&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            current_time = datetime.now(timezone.utc)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;# è®¡ç®—è¿è¡Œæ—¶é•¿&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; pod_start_time &lt;span class=&quot;keyword&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;None&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pod_duration = current_time - pod_start_time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pod_duration_str = &lt;span class=&quot;built_in&quot;&gt;str&lt;/span&gt;(pod_duration).split(&lt;span class=&quot;string&quot;&gt;&quot;.&quot;&lt;/span&gt;)[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;]  &lt;span class=&quot;comment&quot;&gt;# æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå»æ‰å°æ•°éƒ¨åˆ†&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pod_duration_str = &lt;span class=&quot;string&quot;&gt;&quot;Unknown&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;# æ£€æŸ¥ Pod æ˜¯å¦æœ‰é‡å¯è®°å½•&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; pod.status.container_statuses &lt;span class=&quot;keyword&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;None&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; container_status &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; pod.status.container_statuses:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    restart_count = container_status.restart_count&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;# å¦‚æœé‡å¯æ¬¡æ•°å¤§äº 0ï¼Œåˆ™è·å–é‡å¯åŸå› &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; restart_count &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        pod_restart_reason = container_status.last_state.terminated.reason&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; pod_restart_reason:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                containers_with_restart.append(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                containers_without_restart.append(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (pod_name, pod_status, pod_duration_str)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# ç”Ÿæˆæ¶ˆæ¯&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    message = &lt;span class=&quot;string&quot;&gt;&quot;ç¯å¢ƒ: {0} è·å–æ—¶é—´ï¼š{1}&#92;n&#92;n&quot;&lt;/span&gt;.&lt;span class=&quot;built_in&quot;&gt;format&lt;/span&gt;(target_namespace,datetime.now(cst_timezone).strftime(&lt;span class=&quot;string&quot;&gt;&quot;%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt;) + &lt;span class=&quot;string&quot;&gt;&quot; CST&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# æ·»åŠ æ²¡æœ‰é‡å¯åŸå› çš„å®¹å™¨ä¿¡æ¯&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; container &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; containers_without_restart:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        pod_name, pod_status, pod_duration_str = container&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        message += &lt;span class=&quot;string&quot;&gt;&quot;å®¹å™¨åç§°: {0}  å½“å‰çŠ¶æ€: {1}  è¿è¡Œæ—¶é•¿: {2}&#92;n&quot;&lt;/span&gt;.&lt;span class=&quot;built_in&quot;&gt;format&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            pod_name, pod_status, pod_duration_str&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    message += &lt;span class=&quot;string&quot;&gt;&quot;------------------------------------------------------&#92;n&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# æ·»åŠ å…·æœ‰é‡å¯åŸå› çš„å®¹å™¨ä¿¡æ¯&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; container &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; containers_with_restart:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count = container&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        message += &lt;span class=&quot;string&quot;&gt;&quot;å®¹å™¨åç§°: {0}  å½“å‰çŠ¶æ€: {1}  è¿è¡Œæ—¶é•¿: {2}  é‡å¯åŸå› : {3} é‡å¯æ¬¡æ•°ï¼š{4}&#92;n&quot;&lt;/span&gt;.&lt;span class=&quot;built_in&quot;&gt;format&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            pod_name, pod_status, pod_duration_str, pod_restart_reason, restart_count&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    message = &lt;span class=&quot;string&quot;&gt;&quot;```{0}```&quot;&lt;/span&gt;.&lt;span class=&quot;built_in&quot;&gt;format&lt;/span&gt;(message)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# å‘é€æ¶ˆæ¯åˆ° Discord&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    payload = {&lt;span class=&quot;string&quot;&gt;&quot;content&quot;&lt;/span&gt;: message}&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    headers = {&lt;span class=&quot;string&quot;&gt;&quot;Content-Type&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;application/json&quot;&lt;/span&gt;}&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    response = requests.post(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        discord_webhook_url, data=json.dumps(payload), headers=headers&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(response.content)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; response.status_code == &lt;span class=&quot;number&quot;&gt;204&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;Message sent to Discord successfully&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;f&quot;Failed to send message to Discord. Status code: &lt;span class=&quot;subst&quot;&gt;{response.status_code}&lt;/span&gt;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;except&lt;/span&gt; ApiException &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; e:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;f&quot;Exception when calling CoreV1Api: &lt;span class=&quot;subst&quot;&gt;{e}&lt;/span&gt;&#92;n&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;
</summary>
    
    
    
    <category term="k8s" scheme="https://blog.sctux.cc/categories/k8s/"/>
    
    
    <category term="k8s,pod" scheme="https://blog.sctux.cc/tags/k8s-pod/"/>
    
  </entry>
  
  <entry>
    <title>K8Sä¸­MySQLä½¿ç”¨NFSæŒ‚è½½çš„å¼‚å¸¸é—®é¢˜å¤„ç†</title>
    <link href="https://blog.sctux.cc/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"/>
    <id>https://blog.sctux.cc/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/</id>
    <published>2024-05-10T12:58:02.000Z</published>
    <updated>2025-09-01T01:59:08.984Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—®é¢˜åŸå› "><a href="#é—®é¢˜åŸå› " class="headerlink" title="é—®é¢˜åŸå› "></a>é—®é¢˜åŸå› </h1><p>åœ¨k8sä¸­ä½¿ç”¨nfsä½œä¸ºæŒä¹…å­˜å‚¨æ–¹å¼ï¼Œæ ¹æ®ä¸åŒç¯å¢ƒå¯¹åº”ä¸åŒåç§°ç©ºé—´çš„podä½¿ç”¨çš„å­˜å‚¨ç±»/å­˜å‚¨å· ç›¸å¯¹åº”ï¼Œå‘ç°mysql8.0.23 åœ¨å¯åŠ¨æ—¶æŒ‚è½½NFSä¼šå¡ä½çš„æƒ…å†µï¼š</p><h1 id="é—®é¢˜å¤ç°"><a href="#é—®é¢˜å¤ç°" class="headerlink" title="é—®é¢˜å¤ç°"></a>é—®é¢˜å¤ç°</h1><p>è¿™é‡Œåœ¨æŸå°å®¿ä¸»æœºä¸Šé¢åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°ç›®å½•ï¼Œç„¶åæŒ‰ç…§é»˜è®¤æ–¹å¼ï¼š</p><figure class="highlight elixir"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs   <span class="number">10.10</span>.<span class="number">10.142</span><span class="symbol">:/data/bbb</span> /tmp/cc</span><br></pre></td></tr></tbody></table></figure><p>å°†nfsæŒ‚è½½åˆ°æœ¬åœ°ï¼Œç„¶åæ˜ å°„åˆ°å®¹å™¨ä¸­å»ï¼Œæ‰€ä»¥è¿™é‡Œè·Ÿk8sç¯å¢ƒæ²¡å¤šå¤§è”ç³»ï¼Œä¸»è¦æ˜¯nfsæŒ‚è½½é—®é¢˜ï¼š</p><p> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/1.png"></p><p>åˆå§‹åŒ–ä¸€ç›´å¡ç€ï¼Œè€Œä¸”åœ¨æŒ‚è½½ç›®å½•å‘ç°åªæœ‰è¿™ä¸ªæ–‡ä»¶ï¼š</p><p> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/0.png"></p><h1 id="é—®é¢˜æ’æŸ¥"><a href="#é—®é¢˜æ’æŸ¥" class="headerlink" title="é—®é¢˜æ’æŸ¥"></a>é—®é¢˜æ’æŸ¥</h1><p>æ£€æŸ¥ä¸€ä¸‹nfsæŒ‚è½½çš„å‚æ•°æƒ…å†µï¼š</p><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mount -v  | grep nfs</span><br><span class="line"></span><br><span class="line">10.10.10.137:<span class="string">/data/nfs_share_137</span> on <span class="string">/tmp/fans</span> type nfs <span class="params">(rw,relatime,<span class="attr">vers</span>=3,<span class="attr">rsize</span>=1048576,<span class="attr">wsize</span>=1048576,<span class="attr">namlen</span>=255,hard,<span class="attr">proto</span>=tcp,<span class="attr">timeo</span>=600,<span class="attr">retrans</span>=2,<span class="attr">sec</span>=sys,<span class="attr">mountaddr</span>=10.10.10.137,<span class="attr">mountvers</span>=3,<span class="attr">mo</span>=udp,<span class="attr">local_lock</span>=none,<span class="attr">addr</span>=10.10.10.137)</span></span><br><span class="line"></span><br><span class="line">10.10.10.142:<span class="string">/data/bbb</span> on <span class="string">/tmp/cc</span> type nfs <span class="params">(rw,relatime,<span class="attr">vers</span>=3,<span class="attr">rsize</span>=1048576,<span class="attr">wsize</span>=1048576,<span class="attr">namlen</span>=255,hard,<span class="attr">proto</span>=tcp,<span class="attr">timeo</span>=600,<span class="attr">retrans</span>=2,<span class="attr">sec</span>=sys,<span class="attr">mountaddr</span>=10.10.10.142,<span class="attr">mountvers</span>=3,<span class="attr">mountport</span>=<span class="attr">569lock</span>=none,<span class="attr">addr</span>=10.10.10.142)</span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚ä¸Šå¯ä»¥çœ‹å‡ºæˆ‘ä»¬å¦‚æœä½¿ç”¨é»˜è®¤çš„æ–¹å¼ç›´æ¥æŒ‚è½½ï¼Œå®ƒä¼šæœ‰ä¸€äº›é»˜è®¤å‚æ•°</p><p>åé¢ä¹Ÿæ˜¯é€šè¿‡è¯¥å®¹å™¨è¿è¡Œçš„å®¿ä¸»æœºä¸Šçš„å†…æ ¸æ—¥å¿—æ‰å‘ç°ï¼Œè¿™ä¸ªé—®é¢˜ï¼š<br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/3.png"></p><h1 id="é—®é¢˜å¤„ç†"><a href="#é—®é¢˜å¤„ç†" class="headerlink" title="é—®é¢˜å¤„ç†"></a>é—®é¢˜å¤„ç†</h1><p>è¿™ä¸ªé”™è¯¯æç¤ºå®é™…ä¸Šæ˜¯NFSå®¢æˆ·ç«¯æ— æ³•è·å¾—æ–‡ä»¶é”å®šï¼Œè€Œä¸æ˜¯æ— æ³•ä¸NFSæœåŠ¡å™¨å»ºç«‹è”ç³»ã€‚å½“NFSå®¢æˆ·ç«¯æ— æ³•è·å¾—æ–‡ä»¶é”å®šæ—¶ï¼Œå®ƒä¼šå°è¯•å‘NFSæœåŠ¡å™¨å‘é€é”å®šè¯·æ±‚ï¼Œå¹¶ç­‰å¾…æœåŠ¡å™¨å“åº”ã€‚å¦‚æœNFSæœåŠ¡å™¨æ²¡æœ‰å“åº”ï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°ç±»ä¼¼çš„é”™è¯¯æç¤ºã€‚å¯èƒ½é€ æˆè¿™ä¸ªé”™è¯¯çš„åŸå› å¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥NFSæœåŠ¡å™¨çš„è´Ÿè½½æƒ…å†µï¼Œå¦‚æœè´Ÿè½½è¿‡é«˜ï¼Œåˆ™å¯èƒ½éœ€è¦ä¼˜åŒ–æœåŠ¡å™¨é…ç½®æˆ–å¢åŠ æœåŠ¡å™¨æ•°é‡ã€‚</li><li>æ£€æŸ¥NFSå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œå¦‚æœå­˜åœ¨ç½‘ç»œæ•…éšœï¼Œåˆ™å¯èƒ½éœ€è¦ä¿®å¤ç½‘ç»œé—®é¢˜æˆ–æ›´æ”¹ç½‘ç»œé…ç½®ã€‚</li><li>è€ƒè™‘ä½¿ç”¨NFSæŒ‚è½½é€‰é¡¹æ¥ä¼˜åŒ–NFSå®¢æˆ·ç«¯çš„è¡Œä¸ºï¼Œä¾‹å¦‚ä½¿ç”¨softé€‰é¡¹è€Œä¸æ˜¯hardé€‰é¡¹ï¼Œæˆ–è€…ä½¿ç”¨intré€‰é¡¹å…è®¸ä¸­æ–­NFSæ“ä½œã€‚</li><li>å¦‚æœNFSå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨ä¸åŒçš„æ—¶åŒºä¸­è¿è¡Œï¼Œåˆ™å¯èƒ½éœ€è¦ä½¿ç”¨noacé€‰é¡¹æ¥ç¦ç”¨NFSå®¢æˆ·ç«¯çš„å±æ€§ç¼“å­˜ï¼Œä»¥ç¡®ä¿æ–‡ä»¶é”å®šè¯·æ±‚å’Œå“åº”çš„æ—¶é—´æˆ³æ˜¯æ­£ç¡®çš„ã€‚</li><li>å¦‚æœæ‚¨çš„NFSå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¿è¡Œçš„æ˜¯ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œåˆ™å¯èƒ½éœ€è¦ä½¿ç”¨é€‚å½“çš„æŒ‚è½½é€‰é¡¹æ¥ç¡®ä¿æ–‡ä»¶é”å®šæœºåˆ¶å¾—åˆ°æ­£ç¡®æ”¯æŒï¼Œä¾‹å¦‚ä½¿ç”¨nolocké€‰é¡¹æ¥ç¦ç”¨æ–‡ä»¶é”å®šæœºåˆ¶ã€‚</li></ol><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†kuboard, æ— æ³•å…¨å±€å¯¹è¿™ä¸ªå­˜å‚¨ç±»åšæš‚æ—¶ä¸èƒ½å½±å“ä¸šåŠ¡ï¼Œä¸èƒ½æ‰€æœ‰å˜æ›´ï¼š<br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/4.png"><br>è¿™é‡Œåªæ˜¯å•ç‹¬è¿™ä¸ªmysqlæœåŠ¡æ²¡æœ‰åŠæ³•æŒ‚åœ¨ä½¿ç”¨ï¼Œæ˜¯ç”±éœ€è¦æ·»åŠ æŒ‚è½½å‚æ•°ï¼š<br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/5.png"></p><p> æ‰¾åˆ°æˆ‘ä»¬åœ¨é¡µé¢ä¸Šæ–°å»ºçš„pv:</p> <figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> kubectl edit pv <span class="operator">-</span>n testnet pvc-b0de2c7f-<span class="number">49</span>de-<span class="number">4</span>e16-<span class="number">83</span>cc-<span class="number">492</span>de8292e5f</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span></span><br><span class="line"><span class="comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span></span><br><span class="line"><span class="comment"># reopened with the relevant failures.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> PersistentVolume</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">annotations:</span></span><br><span class="line">    pv.kubernetes.io<span class="operator">/</span><span class="params">provisioned-by:</span> nfs-testnet</span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="string">"2023-07-20T16:29:30Z"</span></span><br><span class="line">  <span class="params">finalizers:</span></span><br><span class="line">  <span class="operator">-</span> kubernetes.io<span class="symbol">/pv-protection</span></span><br><span class="line">  <span class="params">name:</span> pvc-b0de2c7f-<span class="number">49</span>de-<span class="number">4</span>e16-<span class="number">83</span>cc-<span class="number">492</span>de8292e5f</span><br><span class="line">  <span class="params">resourceVersion:</span> <span class="string">"147600146"</span></span><br><span class="line">  <span class="params">uid:</span> e9f111ac-<span class="number">293</span>2-<span class="number">46</span>a0-b6bc-<span class="number">876275</span>dfa02f</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">accessModes:</span></span><br><span class="line">  <span class="operator">-</span> ReadWriteOnce</span><br><span class="line">  <span class="params">capacity:</span></span><br><span class="line">    <span class="params">storage:</span> <span class="number">2</span>G</span><br><span class="line">  <span class="params">claimRef:</span></span><br><span class="line">    <span class="params">apiVersion:</span> v1</span><br><span class="line">    <span class="params">kind:</span> PersistentVolumeClaim</span><br><span class="line">    <span class="params">name:</span> dassssssssssssssss</span><br><span class="line">    <span class="params">namespace:</span> testnet</span><br><span class="line">    <span class="params">resourceVersion:</span> <span class="string">"147600141"</span></span><br><span class="line">    <span class="params">uid:</span> b0de2c7f-<span class="number">49</span>de-<span class="number">4</span>e16-<span class="number">83</span>cc-<span class="number">492</span>de8292e5f</span><br><span class="line">  <span class="params">nfs:</span></span><br><span class="line">    <span class="params">path:</span> <span class="symbol">/data/testnet-dassssssssssssssss-pvc-b0de2c7f-49de-4e16-83cc-492de8292e5f</span></span><br><span class="line">    <span class="params">server:</span> <span class="number">10.10</span>.<span class="number">10.142</span></span><br><span class="line">  <span class="params">persistentVolumeReclaimPolicy:</span> Retain</span><br><span class="line">  <span class="params">storageClassName:</span> testnet</span><br><span class="line">  <span class="params">volumeMode:</span> Filesystem</span><br><span class="line"><span class="params">status:</span></span><br><span class="line">  <span class="params">phase:</span> Bound</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åæˆ‘ä»¬åœ¨<code>volumeModeåŒçº§</code> å°±å¯ä»¥å®šä¹‰æŒ‚è½½å‚æ•°(å…·ä½“å‚æ•°ï¼š<a href="https://poe.com/s/FyTCOkthr3VREHU3mByA)%EF%BC%9A">https://poe.com/s/FyTCOkthr3VREHU3mByA)ï¼š</a></p><figure class="highlight ldif"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mountOptions</span>:</span><br><span class="line"><span class="literal">-</span> nolock</span><br><span class="line"><span class="literal">-</span> timeo=120</span><br><span class="line"><span class="literal">-</span> intr</span><br><span class="line"><span class="literal">-</span> retrans=10</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ ·æˆ‘ä»¬å•ç‹¬ä¸ºMySQLæœåŠ¡åˆ›å»ºçš„è¿™ä¸ªpvcå°±æ‹¥æœ‰äº†è¿™äº›æŒ‚è½½å‚æ•°ï¼Œåˆå§‹åŒ–ï¼Œè¿è¡Œæ­£å¸¸ï¼š<br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/6.png"></p><p>åœ¨è¿™ä¸ªpodè¿è¡Œçš„å®¿ä¸»æœºä¸Š æŸ¥çœ‹ç»“æœï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¿®æ”¹pvåçš„å‚æ•°å·²ç»ç”Ÿæ•ˆï¼Œå¹¶ä¸”åœ¨nfsæœåŠ¡ç«¯å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„MySQLåˆå§‹åŒ–æ–‡ä»¶å·²ç»ç”Ÿæˆï¼š<br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/7.png"><br> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/8.png"></p><p>æœ€ç»ˆè¯¥æŒ‚è½½é—®é¢˜å®Œç¾è§£å†³ã€‚</p><p>å¯¹äºç‰¹æ®Šï¼Œä¸åŒçš„deployment å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡ŒæŒ‰ç…§mysqlçš„éƒ¨ç½²ï¼Œè®°å½•ä¸€ä¸‹é¡ºåº</p><ol><li>åˆ›å»ºpvc</li><li>ä¿®æ”¹é»˜è®¤pvcé…ç½®ï¼Œå¢åŠ nfsæŒ‚è½½å‚æ•°</li><li>å¯åŠ¨pod</li><li>æ£€æŸ¥æŒ‚è½½ç›®å½•æ•°æ®æ˜¯å¦æ­£å¸¸ç”Ÿæˆ</li><li>æ£€æŸ¥æŒ‚è½½é€‰é¡¹æ˜¯å¦å·²ç»å¢åŠ </li></ol><p> <img src="/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/00.jpeg"></p><p>By the way:<br>è°è¯´çš„K8Sä¸èƒ½è·‘MySQLï¼Œ æˆ‘å«©æ­»TA ğŸ”ªğŸ”ªğŸ”ª</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;é—®é¢˜åŸå› &quot;&gt;&lt;a href=&quot;#é—®é¢˜åŸå› &quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜åŸå› &quot;&gt;&lt;/a&gt;é—®é¢˜åŸå› &lt;/h1&gt;&lt;p&gt;åœ¨k8sä¸­ä½¿ç”¨nfsä½œä¸ºæŒä¹…å­˜å‚¨æ–¹å¼ï¼Œæ ¹æ®ä¸åŒç¯å¢ƒå¯¹åº”ä¸åŒåç§°ç©ºé—´çš„podä½¿ç”¨çš„å­˜å‚¨ç±»/å­˜å‚¨å· ç›¸å¯¹åº”ï¼Œå‘ç°mysql8.0.23 åœ¨å¯åŠ¨æ—¶æŒ‚è½½NFSä¼šå¡ä½çš„æƒ…å†µï¼š&lt;/p&gt;
&lt;h1 id=&quot;é—®é¢˜å¤ç°&quot;&gt;&lt;a href=&quot;#é—®é¢˜å¤ç°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜å¤ç°&quot;&gt;&lt;/a&gt;é—®é¢˜å¤ç°&lt;/h1&gt;&lt;p&gt;è¿™é‡Œåœ¨æŸå°å®¿ä¸»æœºä¸Šé¢åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°ç›®å½•ï¼Œç„¶åæŒ‰ç…§é»˜è®¤æ–¹å¼ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight elixir&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;mount -t nfs   &lt;span class=&quot;number&quot;&gt;10.10&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;10.142&lt;/span&gt;&lt;span class=&quot;symbol&quot;&gt;:/data/bbb&lt;/span&gt; /tmp/cc&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;


&lt;p&gt;å°†nfsæŒ‚è½½åˆ°æœ¬åœ°ï¼Œç„¶åæ˜ å°„åˆ°å®¹å™¨ä¸­å»ï¼Œæ‰€ä»¥è¿™é‡Œè·Ÿk8sç¯å¢ƒæ²¡å¤šå¤§è”ç³»ï¼Œä¸»è¦æ˜¯nfsæŒ‚è½½é—®é¢˜ï¼š&lt;/p&gt;
&lt;p&gt; &lt;img src=&quot;/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/1.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;åˆå§‹åŒ–ä¸€ç›´å¡ç€ï¼Œè€Œä¸”åœ¨æŒ‚è½½ç›®å½•å‘ç°åªæœ‰è¿™ä¸ªæ–‡ä»¶ï¼š&lt;/p&gt;
&lt;p&gt; &lt;img src=&quot;/2024/05/10/K8S%E4%B8%ADMySQL%E4%BD%BF%E7%94%A8NFS%E6%8C%82%E8%BD%BD%E7%9A%84%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/0.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;é—®é¢˜æ’æŸ¥&quot;&gt;&lt;a href=&quot;#é—®é¢˜æ’æŸ¥&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æ’æŸ¥&quot;&gt;&lt;/a&gt;é—®é¢˜æ’æŸ¥&lt;/h1&gt;</summary>
    
    
    
    
    <category term="NFS" scheme="https://blog.sctux.cc/tags/NFS/"/>
    
  </entry>
  
  <entry>
    <title>Prometheus+Consulå®ç°ä¼ä¸šçº§å®¿ä¸»æœº+å®¹å™¨ç›‘æ§å‘Šè­¦</title>
    <link href="https://blog.sctux.cc/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/"/>
    <id>https://blog.sctux.cc/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/</id>
    <published>2022-09-12T06:45:26.000Z</published>
    <updated>2025-09-01T01:59:08.871Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€èƒŒæ™¯"><a href="#ä¸€ã€èƒŒæ™¯" class="headerlink" title="ä¸€ã€èƒŒæ™¯"></a>ä¸€ã€èƒŒæ™¯</h1><p>å› å…¬å¸å†å²é—ç•™åŸå› æœ‰ä¸ªåˆ«ç¯å¢ƒæš‚æ—¶æ²¡æœ‰ä½¿ç”¨kubernets, ç°åœ¨éœ€è¦å°†è¿™æ‰¹æœåŠ¡å™¨çš„ç›‘æ§ç³»ç»Ÿä»zabbixæ›¿æ¢åˆ°Prometheus, äºæ˜¯ä¹è¿™è¾¹æœ‰ä¸ªé—®é¢˜å°±æ˜¯éœ€è¦å°†æ‰€æœ‰æœåŠ¡å™¨ä¸Šé¢çš„æ‰€æœ‰çš„exporter merticsï¼ˆå³ targetï¼‰åœ°å€å†™åˆ°Prometheusé…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶ï¼Œä¼¼ä¹è¿˜ç®—å¯ä»¥ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘é‡‡ç”¨Prometheus+Consulçš„æ–¹å¼æ¥ç®¡ç†æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰exporterï¼Œ é‚£ä¹ˆè¿™æ ·åšçš„å¥½å¤„æ˜¯æˆ‘ä»¬èƒ½æ›´æ¸…æ™°çš„é€šè¿‡Consulæ¥ç®¡ç†ä¸Šé¢çš„æ¯ä¸ªexporter url , ä»¥åŠé€šè¿‡consulè‡ªå¸¦çš„è‡ªå®šä¹‰å…ƒæ•°æ®ï¼Œå†ç»“åˆPromethuesæ— ç–‘æ˜¯ä¸ªå¾ˆçµæ´»çš„æ–¹å¼ã€‚</p><h1 id="äºŒã€æ¶æ„"><a href="#äºŒã€æ¶æ„" class="headerlink" title="äºŒã€æ¶æ„"></a>äºŒã€æ¶æ„</h1><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/arch.png"></p><ol><li>promtheusé…ç½®æ•°æ®æºä¸ºconsu_sd_configs åœ°å€æŒ‡å‘ä¸€ä¸ªconsulå®¢æˆ·ç«¯åœ°å€ï¼›</li><li>é€šè¿‡è„šæœ¬è°ƒç”¨consulapiçš„æ–¹å¼å°†å®¿ä¸»æœºä¸Šé¢çš„cadvisor-exporter,node-exporter metricsçš„åœ°å€æ³¨å†Œåˆ°consulä¸­ï¼›</li><li>promtheus æ£€æµ‹åˆ°äº†æ–°å¢æœåŠ¡åï¼Œä¼šé€šè¿‡è¿™ä¸ª<a href="http://xxxxxx:xxx/metrics">http://xxxxxx:xxx/metrics</a> url æŠ“å–é‡‡é›†æ•°æ®ï¼›</li><li>åç»­çš„æ•°æ®é‡‡é›†å°±è·Ÿå¹³å¸¸æˆ‘ä»¬ä½¿ç”¨çš„æ–¹å¼ä¸€æ ·äº†ï¼Œé‡‡é›†åˆ°çš„æ•°æ®æ—¶åºä¿å­˜åœ¨promtheusï¼›</li><li>Grafanaä½œä¸ºé‡‡é›†æ•°æ®çš„ä¸€ä¸ªå±•ç¤º,é€šè¿‡å„ç§labelï¼Œæ›´åŠ æ–¹ä¾¿çš„å¯¹é¢æ¿è¿›è¡Œé…ç½®ï¼›</li><li>æ·»åŠ node-exporterï¼Œ cadvisor-exporterçš„æŒ‡æ ‡æŠ¥è­¦è§„åˆ™ï¼Œé€šè¿‡Alertmanager å‘å‡ºä¸»æœºæˆ–å®¹å™¨çš„å‘Šè­¦ï¼›</li></ol><h1 id="ä¸‰ã€å®ç°"><a href="#ä¸‰ã€å®ç°" class="headerlink" title="ä¸‰ã€å®ç°"></a>ä¸‰ã€å®ç°</h1><h2 id="Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²"><a href="#Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²" class="headerlink" title="Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²"></a>Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²</h2><p>è¯¥ç¼–æ’æ–‡ä»¶ä¸­éƒ¨ç½²äº†</p><ol><li>Prometheus: ç›‘æ§ç³»ç»Ÿä¸»ç¨‹åº</li><li>Alertmanager: å‘Šè­¦å‘é€</li><li>Grafana: æ•°æ®å±•ç¤º</li><li>Prometheus-dingding-webhook: é’‰é’‰å‘Šè­¦æ¨é€</li><li>alertmanager-dashboard: ä¸»è¦ç”¨äºå‘Šè­¦æ¡ç›®å±•ç¤ºï¼Œè¯¥è½¯ä»¶æ˜¯å¼€æºé¡¹ç›®ï¼Œéšæ„ä¸‹è½½éƒ¨ç½²</li></ol><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cat &gt; docker-compose.yaml &lt;&lt; EOF</span></span><br><span class="line"><span class="attribute">version</span><span class="punctuation">:</span> <span class="string">'3.7'</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">services</span><span class="punctuation">:</span></span><br><span class="line"><span class="punctuation"></span></span><br><span class="line">  <span class="attribute">prometheus</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">prom/prometheus:latest</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus/:/etc/prometheus/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/prometheus-data:/prometheus</span></span><br><span class="line">    <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--config.file=/etc/prometheus/prometheus.yml'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--storage.tsdb.path=/prometheus'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.console.libraries=/usr/share/prometheus/console_libraries'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.console.templates=/usr/share/prometheus/consoles'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.enable-lifecycle'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.external-url=http://192.168.18.178:9090'</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9090:9090</span></span><br><span class="line">    <span class="attribute">links</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">alertmanager:alertmanager</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">alertmanager</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">prom/alertmanager</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9093:9093</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./alertmanager/:/etc/alertmanager/</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--config.file=/etc/alertmanager/config.yml'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--storage.path=/alertmanager'</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">grafana</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">grafana/grafana:8.4.0</span></span><br><span class="line">    <span class="attribute">depends_on</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">3000:3000</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/grafana-data:/var/lib/grafana</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./grafana/provisioning/:/etc/grafana/provisioning/</span></span><br><span class="line">    <span class="attribute">env_file</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./grafana/config.monitoring</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">webhook</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">timonwong/prometheus-webhook-dingtalk</span></span><br><span class="line">    <span class="attribute">depends_on</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus-webhook-dingtalk/config.yml:/config/config.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus-webhook-dingtalk/dingding.tmpl:/config/dingding.tmpl</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9060:8060</span></span><br><span class="line">    <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.listen-address=:8060'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--config.file=/config/config.yml'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.enable-ui'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--web.enable-lifecycle'</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">alertmanager-dashboard</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">ghcr.io/prymitive/karma:latest</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9094:8080</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">environment</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ALERTMANAGER_URI=http://192.168.18.178:9093</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># runèµ·æ¥</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šè¿è¡Œèµ·æ¥åï¼ŒåŸºæœ¬çš„åŠŸèƒ½å·²ç»å®Œæˆï¼Œæ­¤æ—¶åªéœ€è¦å°†targetæ·»åŠ åˆ°prometheusä¸­å°±å¯ä»¥äº†</p><h2 id="3-2-exporter-æ•°æ®é‡‡é›†å™¨-éƒ¨ç½²"><a href="#3-2-exporter-æ•°æ®é‡‡é›†å™¨-éƒ¨ç½²" class="headerlink" title="3.2 exporter(æ•°æ®é‡‡é›†å™¨)éƒ¨ç½²"></a>3.2 exporter(æ•°æ®é‡‡é›†å™¨)éƒ¨ç½²</h2><p>ä¸Šé¢æåˆ°æˆ‘ä»¬è¿™éƒ¨åˆ†ç¯å¢ƒæ²¡æœ‰è¿ç§»åˆ°k8sï¼Œæ‰€æœ‰å¾®æœåŠ¡éƒ½æ˜¯dockeræ–¹å¼è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šé¢çš„ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œéœ€è¦å•ç‹¬éœ€è¦å»éƒ¨ç½²å¯¹å®¿ä¸»æœºè·Ÿå®¹å™¨çš„eporter(æ•°æ®é‡‡é›†å™¨), ç›®å‰çš„éœ€æ±‚å°±æ˜¯ç›‘æ§å®¿ä¸»æœºä»¥åŠå®¹å™¨ï¼Œå¹¶å°†é‡‡é›†åˆ°çš„æ•°æ®è¿›è¡Œå±•ç¤ºã€å‘Šè­¦ç­‰ã€‚</p><ul><li>å®¿ä¸»æœºçš„ç›‘æ§ï¼šåˆ©ç”¨Prometheusæ­å»ºéƒ¨ç½²ç›‘æ§ç³»ç»Ÿï¼Œé‚£ä¹ˆå¯¹äºæœåŠ¡å™¨å±‚é¢çš„æ•°æ®é‡‡é›†æˆ‘ä»¬é¦–é€‰çš„æ˜¯node-exporterï¼›</li><li>å®¹å™¨çš„ç›‘æ§ï¼šåœ¨è°ƒç ”å®¹å™¨ç›‘æ§è¿™å—å„¿çš„æ—¶å€™å‘ç°container-exporterç›‘æ§æŒ‡æ ‡è™½ç„¶èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œä½†æ˜¯å‘ç°é‡‡é›†çš„æ•°æ®è¿‡äºç®€æ´ä¸”åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šé€ æˆå†…å­˜ç§¯å‹æœ€ç»ˆå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œé™¤éæ˜¯äººä¸ºå¹²æ¶‰é‡å¯ä¸€ä¸‹ï¼Œé‡Šæ”¾å†…å­˜ï¼Œä½†æ˜¯è¿™ç§äº‹å„¿ä¸åº”è¯¥å‘ç”Ÿã€‚å› æ­¤è¿˜æ˜¯é‡‡ç”¨cadvisor exporteræ¥è¿›è¡Œå®¹å™¨çš„æ•°æ®é‡‡é›†</li></ul><p>éœ€è¦åœ¨æ¯å°å®¿ä¸»æœºä¸Šé¢éƒ¨ç½²ä¸¤ä¸ªexporter</p><h3 id="åˆ›å»ºç›®å½•-ä¸€èˆ¬æ”¾åˆ°æ™®é€šç”¨æˆ·appå®¶ç›®å½•å³å¯"><a href="#åˆ›å»ºç›®å½•-ä¸€èˆ¬æ”¾åˆ°æ™®é€šç”¨æˆ·appå®¶ç›®å½•å³å¯" class="headerlink" title="åˆ›å»ºç›®å½•(ä¸€èˆ¬æ”¾åˆ°æ™®é€šç”¨æˆ·appå®¶ç›®å½•å³å¯)"></a>åˆ›å»ºç›®å½•(ä¸€èˆ¬æ”¾åˆ°æ™®é€šç”¨æˆ·appå®¶ç›®å½•å³å¯)</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> exporter-deploy &amp;&amp; <span class="built_in">cd</span> exporter-deploy</span><br></pre></td></tr></tbody></table></figure><h3 id="ç¼–æ’æ–‡ä»¶å‡†å¤‡"><a href="#ç¼–æ’æ–‡ä»¶å‡†å¤‡" class="headerlink" title="ç¼–æ’æ–‡ä»¶å‡†å¤‡"></a>ç¼–æ’æ–‡ä»¶å‡†å¤‡</h3><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cat &gt; docker-compose.yaml &lt;&lt; EOF</span></span><br><span class="line"><span class="attribute">version</span><span class="punctuation">:</span> <span class="string">'3.7'</span></span><br><span class="line"><span class="attribute">services</span><span class="punctuation">:</span></span><br><span class="line">  <span class="comment"># å®¿ä¸»æœºæ•°æ®é‡‡é›†</span></span><br><span class="line">  <span class="attribute">node-exporter</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">bitnami/node-exporter:latest</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/proc:/host/proc:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/sys:/host/sys:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/:/rootfs:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/:/host:ro,rslave</span></span><br><span class="line">    <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--path.rootfs=/host'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--path.procfs=/host/proc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--path.sysfs=/host/sys'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--web.disable-exporter-metrics</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-mount-points</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)"</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9100:9100</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"1.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line">          </span><br><span class="line">  <span class="comment"># å®¹å™¨æ•°æ®é‡‡é›†</span></span><br><span class="line">  <span class="attribute">cadvisor-exporter</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">gcr.io/cadvisor/cadvisor/cadvisor:v0.45.0</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/:/rootfs:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run:/var/run:rw</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/sys:/sys:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/lib/docker/:/var/lib/docker:ro</span></span><br><span class="line">    <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"-docker_only=true"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"-housekeeping_interval=10s"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"-docker_only=true"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"--allow_dynamic_housekeeping=false"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"--storage_duration=20s"</span></span><br><span class="line">    <span class="attribute">ports</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">9105:8080</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">always</span></span><br><span class="line">    <span class="attribute">deploy</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">mode</span><span class="punctuation">:</span> <span class="string">global</span></span><br><span class="line">      <span class="attribute">resources</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">limits</span><span class="punctuation">:</span></span><br><span class="line">          <span class="attribute">cpus</span><span class="punctuation">:</span> <span class="string">"2.0"</span></span><br><span class="line">          <span class="attribute">memory</span><span class="punctuation">:</span> <span class="string">500M</span></span><br><span class="line">EOF</span><br><span class="line"> </span><br><span class="line"><span class="comment"># runèµ·æ¥</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šï¼Œåªéœ€è¦æ­¤é…ç½®æ–‡ä»¶å°±éƒ¨ç½²å¥½äº† â€œexporterå®¢æˆ·ç«¯â€ </p><p>ä¸‹é¢å°±æ˜¯ å°†è¿™å°æœåŠ¡å™¨ä»¥åŠè¿ä¸ªexporterçš„url æ³¨å†Œåˆ°consulä¸­ï¼Œå¦‚æœæœ‰æ‰¹é‡å®‰è£…éœ€æ±‚ï¼Œç›´æ¥åœ¨jumpä¸Šé¢é€šè¿‡ansible æ¨é€å³å¯</p><h2 id="3-3-consul-é›†ç¾¤éƒ¨ç½²"><a href="#3-3-consul-é›†ç¾¤éƒ¨ç½²" class="headerlink" title="3.3 consul é›†ç¾¤éƒ¨ç½²"></a>3.3 consul é›†ç¾¤éƒ¨ç½²</h2><h3 id="æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªdocker-ç½‘ç»œ"><a href="#æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªdocker-ç½‘ç»œ" class="headerlink" title="æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªdocker ç½‘ç»œ"></a>æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªdocker ç½‘ç»œ</h3><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> network create --driver bridge --subnet <span class="number">10.10.0.0</span>/<span class="number">24</span>  consul-network</span><br></pre></td></tr></tbody></table></figure><h3 id="åˆ›å»ºconsulçš„æ•°æ®ã€é…ç½®ç›®å½•"><a href="#åˆ›å»ºconsulçš„æ•°æ®ã€é…ç½®ç›®å½•" class="headerlink" title="åˆ›å»ºconsulçš„æ•°æ®ã€é…ç½®ç›®å½•"></a>åˆ›å»ºconsulçš„æ•°æ®ã€é…ç½®ç›®å½•</h3><figure class="highlight haskell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">sudo</span> mkdir  -p /<span class="class"><span class="keyword">data</span>/consul/consul-server{1..3}/{<span class="title">data</span>,<span class="title">config</span>}</span></span><br><span class="line"><span class="title">sudo</span> mkdir  -p /<span class="class"><span class="keyword">data</span>/consul/consul-client{1..2}/{<span class="title">data</span>,<span class="title">config</span>}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="ç¼–è¾‘docker-composeé…ç½®"><a href="#ç¼–è¾‘docker-composeé…ç½®" class="headerlink" title="ç¼–è¾‘docker-composeé…ç½®"></a>ç¼–è¾‘docker-composeé…ç½®</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; docker-compose-consul-cluster.yaml &lt;&lt; \EOF</span><br><span class="line">version: <span class="string">'3.7'</span></span><br><span class="line"> </span><br><span class="line">services:</span><br><span class="line">  consul-server1:</span><br><span class="line">    image: consul:latest</span><br><span class="line">    network_mode: consul-network</span><br><span class="line">    container_name: consul-server1</span><br><span class="line">    restart: always</span><br><span class="line">    <span class="built_in">command</span>: agent -server -client=0.0.0.0 -bootstrap-expect=3 -node=consul-server1  -<span class="built_in">bind</span>=0.0.0.0  -config-dir=/consul/config</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/consul/consul-server1/data:/consul/data</span><br><span class="line">      - /data/consul/consul-server1/config:/consul/config</span><br><span class="line"> </span><br><span class="line">  consul-server2:</span><br><span class="line">    image: consul:latest</span><br><span class="line">    network_mode: consul-network</span><br><span class="line">    container_name: consul-server2</span><br><span class="line">    restart: always</span><br><span class="line">    <span class="built_in">command</span>: agent -server -client=0.0.0.0 -retry-join=consul-server1 -node=consul-server2  -<span class="built_in">bind</span>=0.0.0.0   -config-dir=/consul/config</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/consul/consul-server2/data:/consul/data</span><br><span class="line">      - /data/consul/consul-server2/config:/consul/config</span><br><span class="line">    depends_on:</span><br><span class="line">      - consul-server1</span><br><span class="line"> </span><br><span class="line">  consul-server3:</span><br><span class="line">    image: consul:latest</span><br><span class="line">    network_mode: consul-network</span><br><span class="line">    container_name: consul-server3</span><br><span class="line">    restart: always</span><br><span class="line">    <span class="built_in">command</span>: agent -server -client=0.0.0.0 -retry-join=consul-server1 -node=consul-server3  -<span class="built_in">bind</span>=0.0.0.0   -config-dir=/consul/config</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/consul/consul-server3/data:/consul/data</span><br><span class="line">      - /data/consul/consul-server3/config:/consul/config</span><br><span class="line">    depends_on:</span><br><span class="line">      - consul-server1</span><br><span class="line"> </span><br><span class="line">  consul-client1:</span><br><span class="line">    image: consul:latest</span><br><span class="line">    network_mode: consul-network</span><br><span class="line">    container_name: consul-client1</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 8500:8500</span><br><span class="line">    <span class="built_in">command</span>: agent -client=0.0.0.0 -retry-join=consul-server1 -ui -node=consul-client1  -<span class="built_in">bind</span>=0.0.0.0   -config-dir=/consul/config</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/consul/consul-client1/data:/consul/data</span><br><span class="line">      - /data/consul/consul-client1/config:/consul/config</span><br><span class="line">    depends_on:</span><br><span class="line">      - consul-server2</span><br><span class="line">      - consul-server3</span><br><span class="line"> </span><br><span class="line">  consul-client2:</span><br><span class="line">    image: consul:latest</span><br><span class="line">    network_mode: consul-network</span><br><span class="line">    container_name: consul-client2</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 8501:8500</span><br><span class="line">    <span class="built_in">command</span>: agent -client=0.0.0.0 -retry-join=consul-server1 -ui -node=consul-client2  -<span class="built_in">bind</span>=0.0.0.0  -config-dir=/consul/config</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/consul/consul-client2/data:/consul/data</span><br><span class="line">      - /data/consul/consul-client2/config:/consul/config</span><br><span class="line">    depends_on:</span><br><span class="line">      - consul-server2</span><br><span class="line">      - consul-server3</span><br><span class="line">EOF</span><br><span class="line"> </span><br><span class="line"><span class="comment"># è¿è¡Œèµ·æ¥ï¼š</span></span><br><span class="line">docker-compose -f docker-compose-consul-cluster.yaml up -d</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE                                                                COMMAND                  CREATED         STATUS                     PORTS                                                                                         NAMES</span><br><span class="line">223826237a7b   consul:latest                                                        <span class="string">"docker-entrypoint.sâ€¦"</span>   3 seconds ago   Up 2 seconds               8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8501-&gt;8500/tcp, :::8501-&gt;8500/tcp   consul-client2</span><br><span class="line">337a3188fb75   consul:latest                                                        <span class="string">"docker-entrypoint.sâ€¦"</span>   3 seconds ago   Up 2 seconds               8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8500-&gt;8500/tcp, :::8500-&gt;8500/tcp   consul-client1</span><br><span class="line">685440aefca3   consul:latest                                                        <span class="string">"docker-entrypoint.sâ€¦"</span>   4 seconds ago   Up 3 seconds               8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                                    consul-server2</span><br><span class="line">5f9927f2ecac   consul:latest                                                        <span class="string">"docker-entrypoint.sâ€¦"</span>   4 seconds ago   Up 3 seconds               8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                                    consul-server3</span><br><span class="line">612b93b95ad9   consul:latest                                                        <span class="string">"docker-entrypoint.sâ€¦"</span>   5 seconds ago   Up 4 seconds               8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                                    consul-server1</span><br><span class="line"> </span><br><span class="line"><span class="comment"># æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š</span></span><br><span class="line">docker <span class="built_in">exec</span> -it consul-server1 consul  members</span><br><span class="line">Node            Address         Status  Type    Build   Protocol  DC   Partition  Segment</span><br><span class="line">consul-server1  10.10.0.2:8301  alive   server  1.13.1  2         dc1  default    &lt;all&gt;</span><br><span class="line">consul-server2  10.10.0.3:8301  alive   server  1.13.1  2         dc1  default    &lt;all&gt;</span><br><span class="line">consul-server3  10.10.0.4:8301  alive   server  1.13.1  2         dc1  default    &lt;all&gt;</span><br><span class="line">consul-client1  10.10.0.6:8301  alive   client  1.13.1  2         dc1  default    &lt;default&gt;</span><br><span class="line">consul-client2  10.10.0.5:8301  alive   client  1.13.1  2         dc1  default    &lt;default&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="è®¿é—®consulçš„webé¡µé¢"><a href="#è®¿é—®consulçš„webé¡µé¢" class="headerlink" title="è®¿é—®consulçš„webé¡µé¢"></a>è®¿é—®consulçš„webé¡µé¢</h3><p><a href="http://192.168.18.179:8501/ui/dc1/overview/server-status">http://192.168.18.179:8501/ui/dc1/overview/server-status</a><br><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/consul.png"></p><p>æ­¤æ—¶é›†ç¾¤å·²ç»æ­å»ºå®Œæ¯•</p><h3 id="å°†æœåŠ¡å™¨çš„exporteræ³¨å†Œåˆ°consul"><a href="#å°†æœåŠ¡å™¨çš„exporteræ³¨å†Œåˆ°consul" class="headerlink" title="å°†æœåŠ¡å™¨çš„exporteræ³¨å†Œåˆ°consul"></a>å°†æœåŠ¡å™¨çš„exporteræ³¨å†Œåˆ°consul</h3><p>åœ¨consul uiä¸­å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ç»“æœ</p><p>ä»¥ä¸Šå°±æ˜¯å°†191.168.18.21ä¸»æœºä¸Šçš„cadvisoræœåŠ¡æ³¨å†Œåˆ°äº†consuä¸Šé¢ï¼Œå°†è¿™ç±»æœåŠ¡çš„åç§°ç»Ÿç§°ä¸º cadvisor-exporter ,å› ä¸ºæœåŠ¡å®ä¾‹idå¿…é¡»å”¯ä¸€ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç‰¹æ®Šå®šä¹‰ä¸€ä¸‹ exporter type - ä¸»æœºå - ipåœ°å€</p><p>æœ€åå°±æ˜¯å°†ä¸¤ä¸ªepxorteréƒ½å°†21è¿™å°ä¸»æœºçš„ä¸¤ä¸ªexporteréƒ½æ³¨å†Œåˆ°äº†consul.</p><h3 id="é…ç½®promeheus-ä½¿å…¶æ”¯æŒconsul"><a href="#é…ç½®promeheus-ä½¿å…¶æ”¯æŒconsul" class="headerlink" title="é…ç½®promeheus ä½¿å…¶æ”¯æŒconsul"></a>é…ç½®promeheus ä½¿å…¶æ”¯æŒconsul</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="params">scrape_configs:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">job_name:</span> 'prometheus'</span><br><span class="line">    <span class="params">scrape_interval:</span> <span class="number">15</span>s</span><br><span class="line">    <span class="params">static_configs:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">targets:</span> ['localhost:<span class="number">9090</span>']</span><br><span class="line"></span><br><span class="line">  <span class="operator">-</span> <span class="params">job_name:</span> <span class="string">"cnosul-prometheus"</span></span><br><span class="line">    <span class="params">consul_sd_configs:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">server:</span> <span class="string">"192.168.18.178:8501"</span></span><br><span class="line">        <span class="params">services:</span> []</span><br><span class="line">    <span class="params">relabel_configs:</span> <span class="comment"># relabe é‡å†™</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">source_labels:</span> [__meta_consul_service] <span class="comment"># serviceæºæ ‡ç­¾</span></span><br><span class="line">        <span class="params">regex:</span> <span class="string">"consul"</span> <span class="comment"># serviceåŒ¹é…</span></span><br><span class="line">        <span class="params">action:</span> drop  <span class="comment"># æ‰§è¡Œçš„åŠ¨ä½œ, è¿™é‡Œä¸éœ€è¦consulçš„metricsï¼Œæ‰€ä»¥dropæ‰</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">source_labels:</span> [__meta_consul_service_metadata_hostname] <span class="comment"># å°†æ­¤æ ‡ç­¾çš„å€¼é‡å†™ä¸ºinstance</span></span><br><span class="line">        <span class="params">target_label:</span> instance</span><br><span class="line">        <span class="params">action:</span> replace</span><br><span class="line">      <span class="operator">-</span> <span class="params">source_labels:</span> [__meta_consul_service_metadata_group]</span><br><span class="line">        <span class="params">target_label:</span> group</span><br><span class="line">        <span class="params">action:</span> replace</span><br><span class="line">      <span class="operator">-</span> <span class="params">source_labels:</span> [__scheme__, __address__, __metrics_path__]</span><br><span class="line">        <span class="params">regex:</span> <span class="string">"(http|https)(.*)"</span>    <span class="comment"># ä¸¤ä¸ªåˆ†ç»„</span></span><br><span class="line">        <span class="params">separator:</span> <span class="string">""</span></span><br><span class="line">        <span class="params">target_label:</span> <span class="string">"endpoint"</span></span><br><span class="line">        <span class="params">replacement:</span> <span class="string">"<span class="subst">${<span class="number">1</span>}</span>://<span class="subst">${<span class="number">2</span>}</span>"</span>   <span class="comment"># å¼•ç”¨ä¸¤ä¸ªåˆ†ç»„</span></span><br><span class="line">        <span class="params">action:</span> replace</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>æ–°å¢åŠ ä»¥ä¸Šé…ç½®ä»¥åé‡æ–°åŠ è½½é…ç½®promtheusæœåŠ¡</p><p>curl -I -X POST <a href="http://127.0.0.1:9090/-/reload">http://127.0.0.1:9090/-/reload</a></p><p>æ³¨æ„ï¼šprometheuså¼€å¯apiçƒ­åŠ è½½ï¼Œéœ€è¦åŠ ä¸Šå¯åŠ¨å‚æ•°ï¼š â€“web.enable-lifecycle</p><p>consulæ³¨å†ŒæœåŠ¡/å®ä¾‹çš„æ—¶å€™å°±éœ€è¦æ·»åŠ è¿™ä¸¤ä¸ªå…ƒæ ‡ç­¾ï¼Œå†é€šè¿‡æ ‡ç­¾é‡æ–° ä¸ºæˆ‘ä»¬éœ€è¦çš„labelï¼Œä¾¿äºåé¢prometheus/grafanaä½¿ç”¨</p><p>ä»¥ä¸Šï¼Œé€šè¿‡é…ç½® prometheus ä¸º consul_sd_configsï¼Œä¹‹åèƒ½å¤Ÿæ­£ç¡®é€šè¿‡æœåŠ¡å‘ç°è·å–åˆ°ä¸¤ä¸ªæœåŠ¡å¾—metircs urlã€‚</p><p>æœåŠ¡å™¨ä¼—å¤šçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é‚£ä¹ˆè¿™é‡Œä¹Ÿå¯ä»¥é€šè¿‡è„šæœ¬çš„æ–¹å¼å»æ·»åŠ ï¼Œå› ä¸ºconsulæœ‰ä»¥ä¸‹å…ƒæ ‡ç­¾ï¼Œé‚£ä¹ˆæ›´å®¹æ˜“ä½¿å¾—æˆ‘ä»¬çš„æ•°æ®å¯æ§ï¼Œä¾‹å¦‚ä¸Šé¢æˆ‘ä»¬åœ¨æ³¨å†ŒæœåŠ¡çš„æ—¶å€™åŠ äº†ä¸€ä¸ª group ï¼Œhostname, consulä¼ é€’åˆ°promtheusä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡relableçš„æ–¹å¼å»é‡å†™, ä»¥ä¸Šä»£è¡¨çš„å°±æ˜¯è¿™ä¸ªä¸»æœºå±äºå“ªä¸ªåˆ†ç»„ï¼Œåç»­å¯ä»¥ä½œä¸ºgrafané¢æ¿ä¸­ï¼Œæˆ–è€…æŠ¥è­¦ä¸­çš„ä¸€ä¸ªå…³é”®æŒ‡æ ‡ã€‚</p><h3 id="å¦‚ä½•æ‰¹é‡æ³¨å†Œcadvisor-node-exporter-åˆ°-consul"><a href="#å¦‚ä½•æ‰¹é‡æ³¨å†Œcadvisor-node-exporter-åˆ°-consul" class="headerlink" title="å¦‚ä½•æ‰¹é‡æ³¨å†Œcadvisor/node exporter åˆ° consul"></a>å¦‚ä½•æ‰¹é‡æ³¨å†Œcadvisor/node exporter åˆ° consul</h3><p>consul è‡ªèº«æä¾›äº†APIï¼Œ å°±åƒä¸Šé¢ä¸€æ ·åšæˆè„šæœ¬ä»¥åï¼Œæ‰¹é‡æ³¨å†ŒæœåŠ¡/å®ä¾‹å³å¯ï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; register_exporter_to_consul.py &lt;&lt; \EOF</span><br><span class="line"> </span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># date: 2022-09-06</span></span><br><span class="line"><span class="comment"># author: guomaoqiu</span></span><br><span class="line"><span class="comment"># desc: æ‰¹é‡æ³¨å†Œcadvisor-exporter, node-exporteræœåŠ¡åˆ°consul</span></span><br><span class="line"> </span><br><span class="line">import json</span><br><span class="line">import requests</span><br><span class="line">import  json</span><br><span class="line"> </span><br><span class="line">consul_url = <span class="string">"http://192.168.18.179:8501/v1/agent/service/register"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># æ³¨å†Œnode-exporter</span></span><br><span class="line">def register_node_exporter(ip,hostname,group):</span><br><span class="line">    nodedata = {</span><br><span class="line">            <span class="string">"id"</span>: <span class="string">"node-exporter-{0}-{1}"</span>.format(hostname,ip),</span><br><span class="line">            # <span class="string">"id"</span>: hostname,</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"node-exporter"</span>,</span><br><span class="line">            <span class="string">"address"</span>: ip,</span><br><span class="line">            <span class="string">"port"</span>: 9100,</span><br><span class="line">            <span class="string">"tags"</span>: [],</span><br><span class="line">            <span class="string">"meta"</span>: {</span><br><span class="line">                <span class="string">"hostname"</span>: hostname,</span><br><span class="line">                <span class="string">"group"</span>:<span class="built_in"> group</span></span><br><span class="line"><span class="built_in"></span>            },</span><br><span class="line">            <span class="string">"checks"</span>: [</span><br><span class="line">                {</span><br><span class="line">                <span class="string">"http"</span>: <span class="string">"http://{0}:9100/metrics"</span>.format(ip),</span><br><span class="line">                <span class="string">"interval"</span>: <span class="string">"5s"</span></span><br><span class="line">                }</span><br><span class="line">        ]</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">print</span>(nodedata)</span><br><span class="line">    try:</span><br><span class="line">        r = requests.put(<span class="attribute">url</span>=consul_url, <span class="attribute">data</span>=json.dumps(nodedata))</span><br><span class="line">        <span class="keyword">if</span> r.status_code == 200:</span><br><span class="line">            <span class="built_in">print</span>(ip, <span class="string">"Node Exporter æ³¨å†ŒæˆåŠŸ"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(ip, <span class="string">"Node Exporter æ³¨å†Œå¤±è´¥"</span>)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># æ³¨å†Œcadvisor-exporter</span></span><br><span class="line">def register_container_exporter(ip,hostname,group):</span><br><span class="line">    container_data = {</span><br><span class="line">            <span class="string">"id"</span>: <span class="string">"cadvisor-exporter-{0}-{1}"</span>.format(hostname,ip),</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"cadvisor-exporter"</span>,</span><br><span class="line">            <span class="string">"address"</span>: ip,</span><br><span class="line">            <span class="string">"port"</span>: 9105,</span><br><span class="line">            <span class="string">"tags"</span>: [],</span><br><span class="line">            <span class="string">"meta"</span>: {</span><br><span class="line">                <span class="string">"hostname"</span>: hostname,</span><br><span class="line">            <span class="string">"group"</span>:<span class="built_in"> group</span></span><br><span class="line"><span class="built_in"></span>            },</span><br><span class="line">            <span class="string">"checks"</span>: [</span><br><span class="line">                {</span><br><span class="line">                <span class="string">"http"</span>: <span class="string">"http://{0}:9105/metrics"</span>.format(ip),</span><br><span class="line">                <span class="string">"interval"</span>: <span class="string">"5s"</span></span><br><span class="line">                }</span><br><span class="line">        ]</span><br><span class="line">    }</span><br><span class="line">    try:</span><br><span class="line">        r = requests.put(<span class="attribute">url</span>=consul_url, <span class="attribute">data</span>=json.dumps(container_data))</span><br><span class="line">        <span class="built_in">print</span>(r.status_code,r.content)</span><br><span class="line">        <span class="keyword">if</span> r.status_code == 200:</span><br><span class="line">            <span class="built_in">print</span>(ip, <span class="string">"Container Exporter æ³¨å†ŒæˆåŠŸ"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(ip, <span class="string">"Container Exporter æ³¨å†Œå¤±è´¥"</span>)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">def register():</span><br><span class="line">    with open(<span class="string">"server_list.txt"</span>,<span class="string">"r"</span>) as f:</span><br><span class="line">        lines = (f.readlines())</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> lines:</span><br><span class="line">           <span class="built_in"> ip </span>=  (str(data).split(<span class="string">"\t"</span>)[1].strip(<span class="string">"\n"</span>))</span><br><span class="line">           <span class="built_in"> group </span>=  (str(data).split(<span class="string">"\t"</span>)[2].strip(<span class="string">"\n"</span>))</span><br><span class="line">            hostname =  (str(data).split(<span class="string">"\t"</span>)[0])</span><br><span class="line">            register_node_exporter(<span class="attribute">ip</span>=ip,hostname=hostname,group=group)</span><br><span class="line">            register_container_exporter(<span class="attribute">ip</span>=ip,hostname=hostname,group=group)</span><br><span class="line"> </span><br><span class="line">register()</span><br><span class="line"> </span><br><span class="line">EOF</span><br><span class="line"> </span><br><span class="line"><span class="comment">### ä»¥ä¸Šéœ€è¦æå‰å‡†å¤‡å¥½ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡Œä¸€æ¡æ•°æ®é‡Œé¢æ ¼å¼å¦‚ä¸‹ï¼š</span></span><br><span class="line"> </span><br><span class="line">cat server_list.txt</span><br><span class="line">hostname1 192.168.18.21   IDE</span><br><span class="line">hostname2 192.168.18.22   IDE</span><br><span class="line">hostname3 192.168.18.31   IDE</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line"> </span><br><span class="line"><span class="comment"># è¿™é‡Œæ˜¯çº¿ä¸‹ç¯å¢ƒçš„ä¸€ä¸ªé…ç½®ï¼Œæ‰€ä»¥å•çº¯åªæ˜¯å°†ç¯å¢ƒä½œä¸ºåˆ†ç»„ï¼Œè¿™é‡Œå¯ä»¥è‡ªå®šä¹‰ï¼Œä½†æ˜¯ä¸èƒ½å°‘äº†æˆ–å¤šäº†å­—æ®µæ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œè„šæœ¬ï¼š</span></span><br><span class="line">python3 register_exporter_to_consul.py </span><br></pre></td></tr></tbody></table></figure><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p8.png"></p><p>æ‰§è¡Œä»¥ä¸Šè„šæœ¬ä»¥åå°±å¯ä»¥åœ¨consulä»¥åŠpromtheus webé¡µé¢è¿›è¡ŒæŸ¥çœ‹æ£€éªŒäº†ï¼š</p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p9.png"></p><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°å·²ç»æ³¨å†Œäº†54ä¸ªï¼Œä½†æ˜¯è¿™å…¶å®åªæ·»åŠ äº†27å°æœåŠ¡å™¨è€Œå·²ï¼Œå› ä¸ºæ¯å°æœåŠ¡å™¨ä¸Šé¢è¿è¡Œäº†ä¸¤ä¸ªexporter,ä¸€ä¸ªæ˜¯node-exporter,ä¸€ä¸ªæ˜¯cadvisor-exporterï¼Œ ä»–ä»¬æœ‰å„è‡ªçš„metrics URL ,æœ€åå†åˆ°prometheusæ£€æŸ¥æ˜¯å¦æ·»åŠ å³å¯ã€‚</p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p10.png"></p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p11.png"><br>ä»¥ä¸Šå¯ä»¥çœ‹åˆ° ï¼ŒæœåŠ¡æ•°é‡ã€exporteræ•°æ®è·å–æ­£å¸¸ã€‚</p><p>è‡³æ­¤ï¼Œconsulçš„éƒ¨ç½²ï¼ŒæœåŠ¡/å®ä¾‹çš„æ³¨å†Œï¼Œpromtheusçš„consul_sd_configsæœåŠ¡è‡ªåŠ¨å‘ç° ï¼Œæ•°æ®é‡‡é›†å·²ç»å®Œæˆï¼Œåç»­å°±æ˜¯å°†prometheus æ¥å…¥åˆ° grafanaï¼š</p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p12.png"></p><p>ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°é€šè¿‡è‡ªå®šä¹‰çš„labelè¿›è¡Œåˆ†ç»„</p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p13.png"></p><h2 id="å‘Šè­¦ç³»ç»Ÿæ¥å…¥"><a href="#å‘Šè­¦ç³»ç»Ÿæ¥å…¥" class="headerlink" title="å‘Šè­¦ç³»ç»Ÿæ¥å…¥"></a>å‘Šè­¦ç³»ç»Ÿæ¥å…¥</h2><p>å·²ç»å¯ä»¥çœ‹åˆ°å®¹å™¨&amp;å®¿ä¸»æœºçš„æ•°æ®å·²ç»æ­£å¸¸é‡‡é›†å¹¶ä¸”å·²ç»èƒ½å¤Ÿåœ¨grafané¢æ¿ä¸Šè¿›è¡Œå±•ç¤º</p><p>æŠ¥è­¦ç³»ç»Ÿä½¿ç”¨çš„æ˜¯Alertmanager æ­é… Webhookæ¥å®ç°ï¼š</p><h3 id="alertmanageré…ç½®"><a href="#alertmanageré…ç½®" class="headerlink" title="alertmanageré…ç½®"></a>alertmanageré…ç½®</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span> alertmanager<span class="symbol">/config.yml</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">global:</span> <span class="comment"># å…¨å±€é…ç½®</span></span><br><span class="line">  <span class="params">resolve_timeout:</span> <span class="number">10</span>m <span class="comment"># è¶…æ—¶æ—¶é—´ é»˜è®¤10m</span></span><br><span class="line"><span class="params">inhibit_rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">source_match:</span>      <span class="comment">## æºæŠ¥è­¦è§„åˆ™</span></span><br><span class="line">      <span class="params">alertname:</span> 'critical'</span><br><span class="line">    <span class="params">target_match:</span></span><br><span class="line">      <span class="params">alertname:</span> 'warning'</span><br><span class="line">    <span class="params">equal:</span> ['alertname']  <span class="comment"># é€šè¿‡alertnameå»æŠ‘åˆ¶</span></span><br><span class="line"><span class="params">route:</span></span><br><span class="line">  <span class="params">receiver:</span> default-receiver</span><br><span class="line">  <span class="params">group_wait:</span> <span class="number">30</span>s</span><br><span class="line">  <span class="params">group_interval:</span> <span class="number">5</span>m</span><br><span class="line">  <span class="params">repeat_interval:</span> <span class="number">3</span>h</span><br><span class="line">  <span class="params">group_by:</span> ['alertname']</span><br><span class="line">  <span class="params">routes:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">receiver:</span> webhook-ide</span><br><span class="line">    <span class="params">matchers:</span></span><br><span class="line">    <span class="operator">-</span> group <span class="operator">=</span> IDE  <span class="comment"># é€šè¿‡prometehus alert rule æŸ¥è¯¢å‡ºæ¥çš„ç»“æœå¿…é¡»åŒ…å« groupå­—æ®µï¼Œå¦åˆ™è¯¥æ¡æŠ¥è­¦ä¸èƒ½å‘é€å‡ºæ¥</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">receiver:</span> webhook-stage</span><br><span class="line">    <span class="params">matchers:</span></span><br><span class="line">    <span class="operator">-</span> group <span class="operator">=</span> Stage</span><br><span class="line">  <span class="operator">-</span> <span class="params">receiver:</span> webhook-Pet</span><br><span class="line">    <span class="params">matchers:</span></span><br><span class="line">    <span class="operator">-</span> group <span class="operator">=</span> Pet</span><br><span class="line"><span class="params">receivers:</span></span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> default-receiver <span class="comment"># è¿™é‡Œä¸éœ€è¦è®¾ç½®ï¼Œéœ€è¦ç²¾ç¡®åŒ¹é…åˆ°æ¯ä¸€æ¡å‘Šè§„åˆ™ ï¼Œä½†æ˜¯è¿™é‡Œå¿…é¡»è¦å­˜åœ¨ï¼Œä¸Šé¢å¼ºè°ƒäº†å¿…é¡»è¦æœ‰ä¸€ä¸ªé»˜è®¤çš„receiver</span></span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> webhook-ide</span><br><span class="line">  <span class="params">webhook_configs:</span> <span class="comment"># webhookå‘Šè­¦é…ç½®</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">url:</span> 'http:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">18.178</span>:<span class="number">9060</span><span class="operator">/</span>dingtalk<span class="operator">/</span>webhook-ide<span class="operator">/</span>send'</span><br><span class="line">    <span class="params">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> webhook-stage</span><br><span class="line">  <span class="params">webhook_configs:</span> <span class="comment"># webhookå‘Šè­¦é…ç½®</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">url:</span> 'http:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">18.178</span>:<span class="number">9060</span><span class="operator">/</span>dingtalk<span class="operator">/</span>webhook-stage<span class="operator">/</span>send'</span><br><span class="line">    <span class="params">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> webhook-Pet</span><br><span class="line">  <span class="params">webhook_configs:</span> <span class="comment"># webhookå‘Šè­¦é…ç½®</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">url:</span> 'http:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">18.178</span>:<span class="number">9060</span><span class="operator">/</span>dingtalk<span class="operator">/</span>webhook-Pet<span class="operator">/</span>send'</span><br><span class="line">    <span class="params">send_resolved:</span> <span class="literal">true</span> </span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯æœåŠ¡åŠ è½½</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="dingding-webhooké…ç½®"><a href="#dingding-webhooké…ç½®" class="headerlink" title="dingding-webhooké…ç½®"></a>dingding-webhooké…ç½®</h3><p>è¿™é‡ŒæŒ‰ç…§ç¯å¢ƒè¿›è¡Œäº†åˆ†ç»„ï¼Œå°†ä¸åŒçš„å‘Šè­¦ä¿¡æ¯é€šè¿‡ç¯å¢ƒå‘é€åˆ°ä¸åŒçš„é’‰é’‰ç¾¤</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span> prometheus-dingding-webhook<span class="symbol">/config.yml</span> <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="comment">## Request timeout</span></span><br><span class="line"><span class="comment"># timeout: 5s</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">## Uncomment following line in order to write template from scratch (be careful!)</span></span><br><span class="line"><span class="comment">#no_builtin_template: false</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">## Customizable templates path</span></span><br><span class="line"><span class="comment">#templates:</span></span><br><span class="line"><span class="comment">#     - /config/dingding.tmpl</span></span><br><span class="line"><span class="params">templates:</span></span><br><span class="line">  <span class="operator">-</span> <span class="symbol">/config/template.tmpl</span></span><br><span class="line"><span class="comment">## You can also override default template using `default_message`</span></span><br><span class="line"><span class="comment">## The following example to use the 'legacy' template from v0.3.0</span></span><br><span class="line"><span class="comment">#default_message:      </span></span><br><span class="line"><span class="comment">#  title: '{{ template "legacy.title" . }}'</span></span><br><span class="line"><span class="comment">#  text: '{{ template "legacy.content" . }}'</span></span><br><span class="line"><span class="comment">## Targets, previously was known as "profiles"</span></span><br><span class="line"><span class="comment">#    text: '{{ template "_dingtalk.link.content" . }}'</span></span><br><span class="line"><span class="params">targets:</span></span><br><span class="line"></span><br><span class="line">  <span class="params">webhook1:</span></span><br><span class="line">    <span class="params">url:</span> https:<span class="operator">//</span>oapi.dingtalk.com<span class="operator">/</span>robot<span class="operator">/</span>send<span class="operator">?</span>access_token<span class="operator">=</span><span class="number">92268</span>cd2c48db0ec2a10a753213dda6a11e4d54ea8fdbce356f217fa44925a7f</span><br><span class="line">    <span class="params">secret:</span> å¡«å†™ä½ çš„é’‰é’‰secret</span><br><span class="line">    </span><br><span class="line">  <span class="params">webhook-ide:</span></span><br><span class="line">    <span class="params">url:</span> https:<span class="operator">//</span>oapi.dingtalk.com<span class="operator">/</span>robot<span class="operator">/</span>send<span class="operator">?</span>access_token<span class="operator">=</span><span class="number">92268</span>cd2c48db0ec2a10a753213dda6a11e4d54ea8fdbce356f217fa44925a7f</span><br><span class="line">    <span class="params">secret:</span> å¡«å†™ä½ çš„é’‰é’‰secret</span><br><span class="line"> </span><br><span class="line">  <span class="params">webhook-stage:</span></span><br><span class="line">    <span class="params">url:</span> https:<span class="operator">//</span>oapi.dingtalk.com<span class="operator">/</span>robot<span class="operator">/</span>send<span class="operator">?</span>access_token<span class="operator">=</span><span class="number">9</span>d7172785d72f50ab335367bd7db8cb013073f62bd0fd7bfc9605020a6a4b95c</span><br><span class="line">    <span class="params">secret:</span> å¡«å†™ä½ çš„é’‰é’‰secret</span><br><span class="line"> </span><br><span class="line">  <span class="params">webhook-Pet:</span></span><br><span class="line">    <span class="params">url:</span> https:<span class="operator">//</span>oapi.dingtalk.com<span class="operator">/</span>robot<span class="operator">/</span>send<span class="operator">?</span>access_token<span class="operator">=</span><span class="number">89</span>b881f5798ec7cdff1538ecf3a7001dd30d19c7e5281e5e8329cb1e243b813e</span><br><span class="line">    <span class="params">secret:</span> ä½ çš„é’‰é’‰secret</span><br><span class="line">    </span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œè¿˜è‡ªå®šä¹‰äº†æŠ¥è­¦æ¨¡æ¿ï¼Œä¸Šè¿°æ–‡ä»¶ä¸­éœ€è¦å¼•å…¥ï¼š</p><figure class="highlight handlebars"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">cat &gt; dingding.tmpl &lt;&lt; EOF</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"__subject"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">[</span><span class="template-variable">{{ <span class="name">.Status</span> | toUpper }}</span><span class="template-variable">{{ <span class="name"><span class="built_in">if</span></span> eq .Status <span class="string">"firing"</span> }}</span><span class="language-xml">:</span><span class="template-variable">{{ <span class="name">.Alerts.Firing</span> | len }}</span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml">]</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"__alert_list"</span> }}</span><span class="template-variable">{{ <span class="name">range</span> . }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">---</span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦åç§°**: </span><span class="template-variable">{{ <span class="name">index</span> .Annotations <span class="string">"title"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦çº§åˆ«**: </span><span class="template-variable">{{ <span class="name">.Labels.severity</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦ä¸»æœºç»„**: </span><span class="template-variable">{{ <span class="name">.Labels.group</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦ä¸»æœº**: </span><span class="template-variable">{{ <span class="name">.Labels.instance</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å›¾è¡¨æ•°æ®**: [Click](</span><span class="template-variable">{{ <span class="name">.GeneratorURL</span> }}</span><span class="language-xml">)</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦ä¿¡æ¯**: </span><span class="template-variable">{{ <span class="name">index</span> .Annotations <span class="string">"description"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦æ—¶é—´**: </span><span class="template-variable">{{ <span class="name">dateInZone</span> <span class="string">"2006.01.02 15:04:05"</span> (<span class="name">.StartsAt</span>) <span class="string">"Asia/Shanghai"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**é¢„æ¡ˆé“¾æ¥**: [CONFæ–‡æ¡£](</span><span class="template-variable">{{ <span class="name">index</span> .Annotations <span class="string">"plan_url"</span> }}</span><span class="language-xml">)</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"__resolved_list"</span> }}</span><span class="template-variable">{{ <span class="name">range</span> . }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">---</span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦åç§°**: </span><span class="template-variable">{{ <span class="name">index</span> .Annotations <span class="string">"title"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦çº§åˆ«**: </span><span class="template-variable">{{ <span class="name">.Labels.severity</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦ä¸»æœº**: </span><span class="template-variable">{{ <span class="name">.Labels.instance</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å›¾è¡¨æ•°æ®**: [Click](</span><span class="template-variable">{{ <span class="name">.GeneratorURL</span> }}</span><span class="language-xml">)</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦ä¿¡æ¯**: </span><span class="template-variable">{{ <span class="name">index</span> .Annotations <span class="string">"description"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**å‘Šè­¦æ—¶é—´**: </span><span class="template-variable">{{ <span class="name">dateInZone</span> <span class="string">"2006.01.02 15:04:05"</span> (<span class="name">.StartsAt</span>) <span class="string">"Asia/Shanghai"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**æ¢å¤æ—¶é—´**: </span><span class="template-variable">{{ <span class="name">dateInZone</span> <span class="string">"2006.01.02 15:04:05"</span> (<span class="name">.EndsAt</span>) <span class="string">"Asia/Shanghai"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"default.title"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"__subject"</span> . }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"default.content"</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">if</span></span> gt (<span class="name">len</span> .Alerts.Firing) <span class="number">0</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**ğŸ’”ğŸ’”ğŸ’”ä¾¦æµ‹åˆ°</span><span class="template-variable">{{ <span class="name">.Alerts.Firing</span> | len  }}</span><span class="language-xml">ä¸ªå‘Šè­¦ğŸ’”ğŸ’”ğŸ’”**</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"__alert_list"</span> .Alerts.Firing }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">---</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">if</span></span> gt (<span class="name">len</span> .Alerts.Resolved) <span class="number">0</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">**ğŸ’šğŸ’šğŸ’šæ¢å¤</span><span class="template-variable">{{ <span class="name">.Alerts.Resolved</span> | len  }}</span><span class="language-xml">ä¸ªå‘Šè­¦ğŸ’šğŸ’šğŸ’š**</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"__resolved_list"</span> .Alerts.Resolved }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"ding.link.title"</span> }}</span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"default.title"</span> . }}</span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name">define</span> <span class="string">"ding.link.content"</span> }}</span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"default.content"</span> . }}</span><span class="template-variable">{{ <span class="name">end</span> }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"default.title"</span> . }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">{{ <span class="name"><span class="built_in">template</span></span> <span class="string">"default.content"</span> . }}</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">EOF</span></span><br></pre></td></tr></tbody></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ¨¡æ¿ä¸­æˆ‘ä»¬åŠ äº†è‡ªå®šä¹‰çš„ä¸€äº›è‡ªå·±æƒ³è¦çš„ä¸œè¥¿ï¼š</p><ul><li><p>éœ€è¦åœ¨å‘Šè­¦çš„æ—¶å€™åŠ ä¸Šé’ˆå¯¹æ¯ä¸ªå‘Šè­¦çš„æ—¥å¸¸å¤„ç†æ–¹å¼çš„ä¸€ä¸ªé¢„æ¡ˆï¼Œé‚£ä¹ˆè¿™ä¸ªå°±ç»™å‡ºä¸€ä¸ªæ–‡æ¡£çš„é“¾æ¥å°±è¡Œäº†ï¼Œæ—¥å¸¸è¿ç»´äººå‘˜çœ‹åˆ°å‘Šè­¦ä¹‹åï¼Œä¸€èˆ¬éƒ½ä¼šè¿›è¡Œä¸€ä¸ªæ•…éšœå¤„ç†è¿‡ç¨‹æˆ–è®°å½•å§ï¼Œè¿™æ ·èƒ½æ›´åŠ å‹å¥½ã€‚é‚£å¦‚ä½•å®šä¹‰ï¼Ÿ<br>é¦–å…ˆåœ¨å‘Šè­¦è§„åˆ™ä¸­å»å®šä¹‰å­—æ®µ,æ¯”å¦‚è¿™é‡Œæˆ‘æ·»åŠ äº†ä¸€ä¸ª <code>plan_url</code>:<br><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p15.png"><br>ç„¶åå†æ¨¡æ¿ä¸­å¼•ç”¨å³å¯.</p></li><li><p>Prometheusä¸­éœ€è¦å¼€å¯ å¤–éƒ¨url è®¿é—®ï¼Œå³åœ¨å¯åŠ¨çš„æ—¶å€™åŠ å…¥å‚æ•°<code>- '--web.external-url=http://192.168.18.178:9090'</code>, å¦åˆ™å‘Šè­¦æ¨¡æ¿ä¸­çš„ <code>.GeneratorURL </code>è¿™ä¸ªå€¼åº”ç”¨çš„æ˜¯prometheusçš„ä¸»æœºåï¼Œå³è¿è¡Œprometheusçš„é‚£ä¸ªå®¹å™¨çš„ä¸»æœºåï¼Œé‚£æ ·è®¿é—®æ˜¯è®¿é—®ä¸åˆ°çš„ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹</p></li></ul><p>å¦å¤–åœ¨éƒ¨ç½²prometheus æˆ‘ä»¬è¿˜éƒ¨ç½²äº†ä¸€ä¸ªå®¹å™¨ä¸Šæ˜¯githubä¸Šæœ‰äººå¼€æºäº†ä¸€ä¸ªæ¥å…¥alertmanager api çš„æ–¹å¼è·å–æŠ¥è­¦å†…å®¹å¹¶è¿›è¡Œå±•ç¤ºã€‚æ¯”èµ·alertmanagerè¿™ä¸ªç»„ä»¶è‡ªèº«çš„é‚£ä¸ªuiæ›´åŠ å¥½ç”¨ã€‚å‡ºå¤„ï¼š(<a href="https://github.com/prymitive/karma%EF%BC%89">https://github.com/prymitive/karmaï¼‰</a></p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p17.png"></p><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/p18.png"></p><p>è‡³æ­¤æ•´ä¸ªç›‘æ§ç³»ç»Ÿå°±æ­å»ºå®Œæ¯•ï¼Œè¿˜æ˜¯æœ‰æ¯”è¾ƒç»†èŠ‚çš„åœ°æ–¹éœ€è¦å¤„ç†æ¯”å¦‚å‘Šè­¦è§„åˆ™ã€å‘Šè­¦é¢‘ç‡è¿™äº›éœ€è¦å»ä¼˜åŒ–ã€‚</p><hr><p><img src="/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/111.jpeg"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ä¸€ã€èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#ä¸€ã€èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€èƒŒæ™¯&quot;&gt;&lt;/a&gt;ä¸€ã€èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;å› å…¬å¸å†å²é—ç•™åŸå› æœ‰ä¸ªåˆ«ç¯å¢ƒæš‚æ—¶æ²¡æœ‰ä½¿ç”¨kubernets, ç°åœ¨éœ€è¦å°†è¿™æ‰¹æœåŠ¡å™¨çš„ç›‘æ§ç³»ç»Ÿä»zabbixæ›¿æ¢åˆ°Prometheus, äºæ˜¯ä¹è¿™è¾¹æœ‰ä¸ªé—®é¢˜å°±æ˜¯éœ€è¦å°†æ‰€æœ‰æœåŠ¡å™¨ä¸Šé¢çš„æ‰€æœ‰çš„exporter merticsï¼ˆå³ targetï¼‰åœ°å€å†™åˆ°Prometheusé…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶ï¼Œä¼¼ä¹è¿˜ç®—å¯ä»¥ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘é‡‡ç”¨Prometheus+Consulçš„æ–¹å¼æ¥ç®¡ç†æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰exporterï¼Œ é‚£ä¹ˆè¿™æ ·åšçš„å¥½å¤„æ˜¯æˆ‘ä»¬èƒ½æ›´æ¸…æ™°çš„é€šè¿‡Consulæ¥ç®¡ç†ä¸Šé¢çš„æ¯ä¸ªexporter url , ä»¥åŠé€šè¿‡consulè‡ªå¸¦çš„è‡ªå®šä¹‰å…ƒæ•°æ®ï¼Œå†ç»“åˆPromethuesæ— ç–‘æ˜¯ä¸ªå¾ˆçµæ´»çš„æ–¹å¼ã€‚&lt;/p&gt;
&lt;h1 id=&quot;äºŒã€æ¶æ„&quot;&gt;&lt;a href=&quot;#äºŒã€æ¶æ„&quot; class=&quot;headerlink&quot; title=&quot;äºŒã€æ¶æ„&quot;&gt;&lt;/a&gt;äºŒã€æ¶æ„&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2022/09/12/Prometheus-Consul%E5%AE%9E%E7%8E%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%BF%E4%B8%BB%E6%9C%BA-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6/arch.png&quot;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;promtheusé…ç½®æ•°æ®æºä¸ºconsu_sd_configs åœ°å€æŒ‡å‘ä¸€ä¸ªconsulå®¢æˆ·ç«¯åœ°å€ï¼›&lt;/li&gt;
&lt;li&gt;é€šè¿‡è„šæœ¬è°ƒç”¨consulapiçš„æ–¹å¼å°†å®¿ä¸»æœºä¸Šé¢çš„cadvisor-exporter,node-exporter metricsçš„åœ°å€æ³¨å†Œåˆ°consulä¸­ï¼›&lt;/li&gt;
&lt;li&gt;promtheus æ£€æµ‹åˆ°äº†æ–°å¢æœåŠ¡åï¼Œä¼šé€šè¿‡è¿™ä¸ª&lt;a href=&quot;http://xxxxxx:xxx/metrics&quot;&gt;http://xxxxxx:xxx/metrics&lt;/a&gt; url æŠ“å–é‡‡é›†æ•°æ®ï¼›&lt;/li&gt;
&lt;li&gt;åç»­çš„æ•°æ®é‡‡é›†å°±è·Ÿå¹³å¸¸æˆ‘ä»¬ä½¿ç”¨çš„æ–¹å¼ä¸€æ ·äº†ï¼Œé‡‡é›†åˆ°çš„æ•°æ®æ—¶åºä¿å­˜åœ¨promtheusï¼›&lt;/li&gt;
&lt;li&gt;Grafanaä½œä¸ºé‡‡é›†æ•°æ®çš„ä¸€ä¸ªå±•ç¤º,é€šè¿‡å„ç§labelï¼Œæ›´åŠ æ–¹ä¾¿çš„å¯¹é¢æ¿è¿›è¡Œé…ç½®ï¼›&lt;/li&gt;
&lt;li&gt;æ·»åŠ node-exporterï¼Œ cadvisor-exporterçš„æŒ‡æ ‡æŠ¥è­¦è§„åˆ™ï¼Œé€šè¿‡Alertmanager å‘å‡ºä¸»æœºæˆ–å®¹å™¨çš„å‘Šè­¦ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;ä¸‰ã€å®ç°&quot;&gt;&lt;a href=&quot;#ä¸‰ã€å®ç°&quot; class=&quot;headerlink&quot; title=&quot;ä¸‰ã€å®ç°&quot;&gt;&lt;/a&gt;ä¸‰ã€å®ç°&lt;/h1&gt;&lt;h2 id=&quot;Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²&quot;&gt;&lt;a href=&quot;#Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²&quot; class=&quot;headerlink&quot; title=&quot;Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²&quot;&gt;&lt;/a&gt;Prometheusä»¥åŠå‘¨è¾¹ç»„ä»¶éƒ¨ç½²&lt;/h2&gt;&lt;p&gt;è¯¥ç¼–æ’æ–‡ä»¶ä¸­éƒ¨ç½²äº†&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Prometheus: ç›‘æ§ç³»ç»Ÿä¸»ç¨‹åº&lt;/li&gt;
&lt;li&gt;Alertmanager: å‘Šè­¦å‘é€&lt;/li&gt;
&lt;li&gt;Grafana: æ•°æ®å±•ç¤º&lt;/li&gt;
&lt;li&gt;Prometheus-dingding-webhook: é’‰é’‰å‘Šè­¦æ¨é€&lt;/li&gt;
&lt;li&gt;alertmanager-dashboard: ä¸»è¦ç”¨äºå‘Šè­¦æ¡ç›®å±•ç¤ºï¼Œè¯¥è½¯ä»¶æ˜¯å¼€æºé¡¹ç›®ï¼Œéšæ„ä¸‹è½½éƒ¨ç½²&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight nestedtext&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;cat &amp;gt; docker-compose.yaml &amp;lt;&amp;lt; EOF&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;3.7&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;services&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;punctuation&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;prometheus&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;prom/prometheus:latest&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;./prometheus/:/etc/prometheus/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/data/prometheus-data:/prometheus&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--config.file=/etc/prometheus/prometheus.yml&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--storage.tsdb.path=/prometheus&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--web.console.libraries=/usr/share/prometheus/console_libraries&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--web.console.templates=/usr/share/prometheus/consoles&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--web.enable-lifecycle&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--web.external-url=http://192.168.18.178:9090&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;9090:9090&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;links&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;alertmanager:alertmanager&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;always&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;resources&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attribute&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;cpus&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;1.0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;500M&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;alertmanager&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;prom/alertmanager&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;9093:9093&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;./alertmanager/:/etc/alertmanager/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;always&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--config.file=/etc/alertmanager/config.yml&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--storage.path=/alertmanager&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;resources&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attribute&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;cpus&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;1.0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;500M&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;grafana&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;grafana/grafana:8.4.0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;depends_on&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;prometheus&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;3000:3000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;/data/grafana-data:/var/lib/grafana&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;./grafana/provisioning/:/etc/grafana/provisioning/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;env_file&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;./grafana/config.monitoring&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;always&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;resources&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attribute&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;cpus&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;1.0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;500M&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;webhook&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;timonwong/prometheus-webhook-dingtalk&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;depends_on&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;prometheus&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;./prometheus-webhook-dingtalk/config.yml:/config/config.yml&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;./prometheus-webhook-dingtalk/dingding.tmpl:/config/dingding.tmpl&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;9060:8060&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--web.listen-address=:8060&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--config.file=/config/config.yml&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--web.enable-ui&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;--web.enable-lifecycle&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;always&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;resources&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attribute&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;cpus&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;1.0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;500M&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attribute&quot;&gt;alertmanager-dashboard&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ghcr.io/prymitive/karma:latest&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;9094:8080&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;always&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;ALERTMANAGER_URI=http://192.168.18.178:9093&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attribute&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;resources&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;attribute&quot;&gt;limits&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;cpus&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;1.0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attribute&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;500M&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EOF&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# runèµ·æ¥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;docker-compose up -d&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="monitor" scheme="https://blog.sctux.cc/categories/monitor/"/>
    
    
    <category term="Prometheus" scheme="https://blog.sctux.cc/tags/Prometheus/"/>
    
    <category term="Consul" scheme="https://blog.sctux.cc/tags/Consul/"/>
    
    <category term="Alertmanager" scheme="https://blog.sctux.cc/tags/Alertmanager/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºå®¹å™¨åŒ–éƒ¨ç½²Nacosé›†ç¾¤</title>
    <link href="https://blog.sctux.cc/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/"/>
    <id>https://blog.sctux.cc/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/</id>
    <published>2022-06-22T14:41:33.000Z</published>
    <updated>2025-09-01T01:59:08.862Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€æ­å»ºæ¶æ„"><a href="#ä¸€ã€æ­å»ºæ¶æ„" class="headerlink" title="ä¸€ã€æ­å»ºæ¶æ„"></a>ä¸€ã€æ­å»ºæ¶æ„</h1><p><img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/arch-1.png"><br>â— 3ä¸ªæˆ–3ä¸ªä»¥ä¸ŠNacosèŠ‚ç‚¹æ‰èƒ½æ„æˆé›†ç¾¤ï¼›<br>â— Nacos Nginx Proxyç”¨äºä»£ç†è½¬å‘ï¼›</p><hr><h1 id="äºŒã€å‡†å¤‡å·¥ä½œ"><a href="#äºŒã€å‡†å¤‡å·¥ä½œ" class="headerlink" title="äºŒã€å‡†å¤‡å·¥ä½œ"></a>äºŒã€å‡†å¤‡å·¥ä½œ</h1><p><em><strong>Nacos2.0ç‰ˆæœ¬ç›¸æ¯”1.Xæ–°å¢äº†gRPCçš„é€šä¿¡æ–¹å¼ï¼Œå› æ­¤éœ€è¦å¢åŠ 2ä¸ªç«¯å£ã€‚æ–°å¢ç«¯å£æ˜¯åœ¨é…ç½®çš„ä¸»ç«¯å£(server.port)åŸºç¡€ä¸Šï¼Œè¿›è¡Œä¸€å®šåç§»é‡è‡ªåŠ¨ç”Ÿæˆã€‚</strong></em></p><table><thead><tr><th>ç«¯å£</th><th>ä¸ä¸»ç«¯å£çš„åç§»é‡</th><th>æè¿°</th></tr></thead><tbody><tr><td>8848</td><td>0</td><td>Nacosç¨‹åºä¸»é…ç½®ç«¯å£</td></tr><tr><td>9848</td><td>+1000</td><td>å®¢æˆ·ç«¯gRPCè¯·æ±‚æœåŠ¡ç«¯ç«¯å£ï¼Œç”¨äºå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥å’Œè¯·æ±‚</td></tr><tr><td>9849</td><td>+1001</td><td>æœåŠ¡ç«¯gRPCè¯·æ±‚æœåŠ¡ç«¯ç«¯å£ï¼Œç”¨äºæœåŠ¡é—´åŒæ­¥ç­‰</td></tr><tr><td>7848</td><td>-1000</td><td>Nacos é›†ç¾¤é€šä¿¡ç«¯å£ï¼Œç”¨äºNacos é›†ç¾¤é—´è¿›è¡Œé€‰ä¸¾ï¼Œæ£€æµ‹ç­‰</td></tr></tbody></table><p><em><strong>ä½¿ç”¨VIP/nginxè¯·æ±‚æ—¶ï¼Œéœ€è¦é…ç½®æˆTCPè½¬å‘ï¼Œä¸èƒ½é…ç½®http2è½¬å‘ï¼Œå¦åˆ™è¿æ¥ä¼šè¢«nginxæ–­å¼€</strong></em><br><img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/arch-2.png"></p><p>æŒ‰ç…§ä¸Šè¿°å®˜æ–¹çš„ç«¯å£åˆ†é…è¦æ±‚ ï¼Œæ­¤å¤„éƒ¨ç½²çš„ä½¿ç”¨ä¸‰å°æœåŠ¡å™¨ä¸Šé¢åˆ›å»ºçš„Nacosé›†ç¾¤ç«¯å£åˆ†é…å¦‚ä¸‹ï¼š</p><table><thead><tr><th>èŠ‚ç‚¹</th><th>IP</th><th>ç«¯å£ï¼ˆæ‰€éœ€æš´éœ²ï¼‰</th><th>å¤‡æ³¨</th><th>ç‰ˆæœ¬</th><th>å½“å‰çº¿ä¸‹ç¯å¢ƒéƒ¨ç½²æ–‡ä»¶è·¯å¾„</th></tr></thead><tbody><tr><td>Nacos_1</td><td>192168.18.73</td><td>å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858  å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858</td><td>Nacos èŠ‚ç‚¹ä¸€</td><td>nacos/nacos-server:2.0.2</td><td>/root/nacos-deploy/</td></tr><tr><td>Nacos_2</td><td>192168.18.74</td><td>å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858  å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858</td><td>Nacos èŠ‚ç‚¹äºŒ</td><td>nacos/nacos-server:2.0.2</td><td>/root/nacos-deploy/</td></tr><tr><td>Nacos_3</td><td>192168.18.75</td><td>å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858  å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858</td><td>Nacos èŠ‚ç‚¹ä¸‰</td><td>nacos/nacos-server:2.0.2</td><td>/root/nacos-deploy/</td></tr><tr><td>Nacos DB</td><td>192168.18.75</td><td>å®¿ä¸»æœºï¼š3306 å®¹å™¨ï¼š3306</td><td>Nacosæ‰€éœ€æ•°æ®åº“</td><td>mysql:5.7.34</td><td>/root/nacos-mysql-deploy</td></tr><tr><td>Nacos  Nginx Proxy</td><td>192168.18.75</td><td>å®¿ä¸»æœºï¼š80  å®¹å™¨ï¼š80</td><td>Nacosä»£ç†</td><td>nginx:stable-alpine</td><td>/root/nacos-proxy-deploy</td></tr></tbody></table><h2 id="2-1-åˆ›å»ºNacosæ•°æ®åº“"><a href="#2-1-åˆ›å»ºNacosæ•°æ®åº“" class="headerlink" title="2.1  åˆ›å»ºNacosæ•°æ®åº“"></a>2.1  åˆ›å»ºNacosæ•°æ®åº“</h2><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯å®¹å™¨åŒ–è¿è¡Œnacosï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå¹¶ä»å®˜æ–¹å¯¹åº”çš„ç‰ˆæœ¬ä¸­å»å¯¼å…¥åŸºæœ¬æ•°æ®åº“ç»“æ„çš„æ•°æ®æ–‡ä»¶</p><h2 id="2-1-1-è·å–nacos-2-0-2-åŒ…æ–‡ä»¶ä¸­çš„åŸºç¡€è¡¨ç»“æ„æ•°æ®"><a href="#2-1-1-è·å–nacos-2-0-2-åŒ…æ–‡ä»¶ä¸­çš„åŸºç¡€è¡¨ç»“æ„æ•°æ®" class="headerlink" title="2.1.1 è·å–nacos 2.0.2 åŒ…æ–‡ä»¶ä¸­çš„åŸºç¡€è¡¨ç»“æ„æ•°æ®"></a>2.1.1 è·å–nacos 2.0.2 åŒ…æ–‡ä»¶ä¸­çš„åŸºç¡€è¡¨ç»“æ„æ•°æ®</h2><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/alibaba/nacos/releases/download/<span class="number">2.0</span><span class="number">.2</span>/nacos-<span class="keyword">server</span><span class="number">-2.0</span><span class="number">.2</span>.tar.gz</span><br><span class="line"></span><br><span class="line"># tar -xf nacos-<span class="keyword">server</span><span class="number">-2.0</span><span class="number">.2</span>.tar.gz</span><br><span class="line"># cd  nacos</span><br><span class="line"># tree -L <span class="number">2</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚   â”œâ”€â”€ shutdown.cmd</span><br><span class="line">â”‚   â”œâ”€â”€ shutdown.sh</span><br><span class="line">â”‚   â”œâ”€â”€ startup.cmd</span><br><span class="line">â”‚   â””â”€â”€ startup.sh</span><br><span class="line">â”œâ”€â”€ conf</span><br><span class="line">â”‚   â”œâ”€â”€ <span class="number">1.4</span><span class="number">.0</span>-ipv6_support-<span class="keyword">update</span>.<span class="keyword">sql</span></span><br><span class="line">â”‚   â”œâ”€â”€ application.properties</span><br><span class="line">â”‚   â”œâ”€â”€ application.properties.example</span><br><span class="line">â”‚   â”œâ”€â”€ <span class="keyword">cluster</span>.conf.example</span><br><span class="line">â”‚   â”œâ”€â”€ nacos-logback.xml</span><br><span class="line">â”‚   â”œâ”€â”€ nacos-mysql.<span class="keyword">sql</span></span><br><span class="line">â”‚   â””â”€â”€ <span class="keyword">schema</span>.<span class="keyword">sql</span></span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ <span class="keyword">NOTICE</span></span><br><span class="line">â””â”€â”€ target</span><br><span class="line">    â””â”€â”€ nacos-<span class="keyword">server</span>.jar</span><br><span class="line">ä»¥ä¸Šæ˜¯nacosçš„äºŒè¿›åˆ¶åŒ…æ–‡ä»¶ ï¼Œè¿™é‡Œåªç”¨åˆ°äº† nacos-mysql.<span class="keyword">sql</span>  è¿™ä¸ªæ–‡ä»¶</span><br></pre></td></tr></tbody></table></figure><h2 id="2-1-2-åˆ›å»ºmysqlæœåŠ¡"><a href="#2-1-2-åˆ›å»ºmysqlæœåŠ¡" class="headerlink" title="2.1.2 åˆ›å»ºmysqlæœåŠ¡"></a>2.1.2 åˆ›å»ºmysqlæœåŠ¡</h2><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.18.75</span></span><br><span class="line">sudo <span class="operator">-</span>i </span><br><span class="line">mkdir <span class="symbol">/data/mysql</span></span><br><span class="line">cat <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF <span class="operator">&gt;</span> <span class="symbol">/root/nacos-mysql-deploy/mysql.yaml</span></span><br><span class="line"><span class="params">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="params">services:</span></span><br><span class="line">  <span class="params">mysql-db:</span></span><br><span class="line">    <span class="params">container_name:</span> nacos-mysql</span><br><span class="line">    <span class="params">image:</span> mysql:<span class="number">5.7</span>.<span class="number">34</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"3306:3306"</span></span><br><span class="line">    <span class="params">environment:</span></span><br><span class="line">      <span class="params">MYSQL_ROOT_PASSWORD:</span> xxxxxxxxxxxx</span><br><span class="line">    <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"/data/mysql:/var/lib/mysql"</span></span><br><span class="line">    <span class="params">restart:</span> always</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">docker-compose <span class="operator">-</span>f  <span class="symbol">/root/nacos-mysql-deploy/mysql.yaml</span> up <span class="operator">-</span>d</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥å®˜æ–¹è¡¨æ•°æ®</span></span><br><span class="line">docker cp <span class="symbol">/root/nacos/conf/nacos-mysql.sql</span> nacos-mysql:<span class="symbol">/tmp</span></span><br><span class="line"></span><br><span class="line">docker exec <span class="operator">-</span>it nacos-mysql sh</span><br><span class="line"></span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>pxxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line">create database nacos;</span><br><span class="line"></span><br><span class="line">use nacos;</span><br><span class="line"></span><br><span class="line">source <span class="symbol">/tmp/nacos-mysql.sql</span>;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="2-2-NaocsæœåŠ¡"><a href="#2-2-NaocsæœåŠ¡" class="headerlink" title="2.2  NaocsæœåŠ¡"></a>2.2  NaocsæœåŠ¡</h2><h2 id="2-2-1-åˆ›å»ºã€ç¼–å†™yamlæ–‡ä»¶"><a href="#2-2-1-åˆ›å»ºã€ç¼–å†™yamlæ–‡ä»¶" class="headerlink" title="2.2.1 åˆ›å»ºã€ç¼–å†™yamlæ–‡ä»¶"></a>2.2.1 åˆ›å»ºã€ç¼–å†™yamlæ–‡ä»¶</h2><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">sudo -i</span><br><span class="line">mkdir /data/nacos2.0.2_1/logs -p</span><br><span class="line">mkdir /root/nacos-deploy/</span><br><span class="line">cat &lt;&lt; EOF &gt; /root/nacos-deploy/nacos1.yaml</span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line">  nacos1:</span><br><span class="line">    hostname: nacos2.0.2_1</span><br><span class="line">    container_name: nacos2.0.2_1</span><br><span class="line">    image: nacos/nacos-server:2.0.2</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/nacos2.0.2_1/logs:/home/nacos/logs</span><br><span class="line">      - /data/nacos2.0.2_1/custom.properties:/home/nacos/init.d/custom.properties</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8858:8858"</span></span><br><span class="line">      - <span class="string">"9858:9858"</span></span><br><span class="line">      - <span class="string">"9859:9859"</span></span><br><span class="line">      - <span class="string">"7858:7858"</span></span><br><span class="line">    environment:</span><br><span class="line">      - <span class="attribute">MODE</span>=cluster</span><br><span class="line">      - <span class="attribute">PREFER_HOST_MODE</span>=hostname</span><br><span class="line">      - <span class="attribute">NACOS_SERVER_IP</span>=192.168.18.73</span><br><span class="line">      - <span class="attribute">NACOS_APPLICATION_PORT</span>=8858</span><br><span class="line">      - <span class="attribute">NACOS_SERVERS</span>=192.168.18.73:8858 192.168.18.74:8858 192.168.18.75:8858</span><br><span class="line">      - <span class="attribute">SPRING_DATASOURCE_PLATFORM</span>=mysql</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_HOST</span>=192.168.18.75</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_DB_NAME</span>=nacos</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PORT</span>=3306</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_USER</span>=root</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PASSWORD</span>=xxxxxxxxxxx</span><br><span class="line">      - <span class="attribute">NACOS_AUTH_ENABLE</span>=<span class="literal">true</span></span><br><span class="line">      - <span class="attribute">MYSQL_DATABASE_NUM</span>=1</span><br><span class="line">    restart: always</span><br><span class="line">EOF</span><br><span class="line"><span class="comment">######################</span></span><br><span class="line">sudo -i</span><br><span class="line">mkdir /data/nacos2.0.2_2/logs -p</span><br><span class="line">mkdir /root/nacos-deploy/</span><br><span class="line">cat &lt;&lt; EOF &gt; /root/nacos-deploy/nacos2.yaml</span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line">  nacos2:</span><br><span class="line">    hostname: nacos2.0.2_2</span><br><span class="line">    container_name: nacos2.0.2_2</span><br><span class="line">    image: nacos/nacos-server:2.0.2</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/nacos2.0.2_2/logs:/home/nacos/logs</span><br><span class="line">      - /data/nacos2.0.2_2/custom.properties:/home/nacos/init.d/custom.properties</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8858:8858"</span></span><br><span class="line">      - <span class="string">"9858:9858"</span></span><br><span class="line">      - <span class="string">"9859:9859"</span></span><br><span class="line">      - <span class="string">"7858:7858"</span></span><br><span class="line">    environment:</span><br><span class="line">      - <span class="attribute">MODE</span>=cluster</span><br><span class="line">      - <span class="attribute">PREFER_HOST_MODE</span>=hostname</span><br><span class="line">      - <span class="attribute">NACOS_SERVER_IP</span>=192.168.18.74</span><br><span class="line">      - <span class="attribute">NACOS_APPLICATION_PORT</span>=8858</span><br><span class="line">      - <span class="attribute">NACOS_SERVERS</span>=192.168.18.73:8858 192.168.18.74:8858 192.168.18.75:8858</span><br><span class="line">      - <span class="attribute">SPRING_DATASOURCE_PLATFORM</span>=mysql</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_HOST</span>=192.168.18.75</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_DB_NAME</span>=nacos</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PORT</span>=3306</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_USER</span>=root</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PASSWORD</span>=xxxxxxxxxxx</span><br><span class="line">      - <span class="attribute">NACOS_AUTH_ENABLE</span>=<span class="literal">true</span></span><br><span class="line">      - <span class="attribute">MYSQL_DATABASE_NUM</span>=1</span><br><span class="line">    restart: always</span><br><span class="line">EOF</span><br><span class="line"><span class="comment">######################</span></span><br><span class="line">sudo -i</span><br><span class="line">mkdir /data/nacos2.0.2_3/logs -p</span><br><span class="line">mkdir /root/nacos-deploy/</span><br><span class="line">cat &lt;&lt; EOF &gt; /root/nacos-deploy/nacos3.yaml</span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line">  nacos3:</span><br><span class="line">    hostname: nacos2.0.2_3</span><br><span class="line">    container_name: nacos2.0.2_3</span><br><span class="line">    image: nacos/nacos-server:2.0.2</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/nacos2.0.2_3/logs:/home/nacos/logs</span><br><span class="line">      - /data/nacos2.0.2_3/custom.properties:/home/nacos/init.d/custom.properties</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8858:8858"</span></span><br><span class="line">      - <span class="string">"9858:9858"</span></span><br><span class="line">      - <span class="string">"9859:9859"</span></span><br><span class="line">      - <span class="string">"7858:7858"</span></span><br><span class="line">    environment:</span><br><span class="line">      - <span class="attribute">MODE</span>=cluster</span><br><span class="line">      - <span class="attribute">PREFER_HOST_MODE</span>=hostname</span><br><span class="line">      - <span class="attribute">NACOS_SERVER_IP</span>=192.168.18.75</span><br><span class="line">      - <span class="attribute">NACOS_APPLICATION_PORT</span>=8858</span><br><span class="line">      - <span class="attribute">NACOS_SERVERS</span>=192.168.18.73:8858 192.168.18.74:8858 192.168.18.75:8858</span><br><span class="line">      - <span class="attribute">SPRING_DATASOURCE_PLATFORM</span>=mysql</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_HOST</span>=192.168.18.75</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_DB_NAME</span>=nacos</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PORT</span>=3306</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_USER</span>=root</span><br><span class="line">      - <span class="attribute">MYSQL_SERVICE_PASSWORD</span>=xxxxxxxxxxx</span><br><span class="line">      - <span class="attribute">NACOS_AUTH_ENABLE</span>=<span class="literal">true</span></span><br><span class="line">      - <span class="attribute">MYSQL_DATABASE_NUM</span>=1</span><br><span class="line">    restart: always</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Š å„é…ç½®ä¸­çš„ç«¯å£éæ ‡å‡†ç«¯å£ï¼Œéœ€è¦æ³¨æ„ç¯å¢ƒå˜é‡ NACOS_APPLICATION_PORT  å¦‚æœä¸æŒ‡å®šä¸ºéç‰¹å®šç«¯å£ï¼Œé‚£ä¹ˆç¼ºçœåœ¨é…ç½®ä¸­çš„ç¯å¢ƒå˜é‡åˆ™ä¸º 8848 ï¼Œåœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œä¸‰ä¸ªèŠ‚ç‚¹ä¼šå‡ºç°é—®é¢˜ï¼</p><h2 id="2-2-2-è¿è¡ŒNacos"><a href="#2-2-2-è¿è¡ŒNacos" class="headerlink" title="2.2.2 è¿è¡ŒNacos"></a>2.2.2 è¿è¡ŒNacos</h2><p>å„èŠ‚ç‚¹è¿è¡Œå³å¯</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.18.73</span></span><br><span class="line">docker-compose -f <span class="regexp">/root/</span>nacos-deploy/nacos1.yaml up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.18.74</span></span><br><span class="line">docker-compose -f <span class="regexp">/root/</span>nacos-deploy/nacos2.yaml up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.18.75</span></span><br><span class="line">docker-compose -f <span class="regexp">/root/</span>nacos-deploy/nacos3.yaml up -d</span><br></pre></td></tr></tbody></table></figure><p><img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/3.png"></p><p>ä¸Šå›¾ ä¸‰ä¸ªèŠ‚ç‚¹å•ç‹¬è®¿é—®é¡µé¢æ­£å¸¸ï¼›é€šè¿‡ä»£ç†è®¿é—®æ­£å¸¸ï¼›</p><p>æ³¨æ„ï¼šwebé¡µé¢å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯gRPCè°ƒç”¨æœåŠ¡ï¼Œä½†æ˜¯åœ¨ç¨‹åºä¸­éœ€è¦è¯·æ±‚å¯¹åº”çš„ç«¯å£ï¼Œæ‰€ä»¥åŠ¡å¿…éœ€è¦æš´éœ²å‡ºæ¥ï¼Œå› ä¸ºä½¿ç”¨äº†éæ ‡å‡†ç«¯å£ï¼Œé‚£ä¹ˆåœ¨nginxåšä»£ç†æ—¶å°±ç›´æ¥(ä¼ªè£…)æ˜ å°„æˆæ ‡å‡†ç«¯å£å³å¯ã€‚</p><h2 id="2-3-Nginxä»£ç†é…ç½®"><a href="#2-3-Nginxä»£ç†é…ç½®" class="headerlink" title="2.3 Nginxä»£ç†é…ç½®"></a>2.3 Nginxä»£ç†é…ç½®</h2><p>æ­¤å¤„ä»ç„¶ä½¿ç”¨å®¹å™¨åŒ–æ–¹å¼è¿è¡Œã€‚<br>é…ç½®nginxä»£ç†</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/nacos-proxy-deploy</span><br><span class="line">cd /root/nacos-proxy-deploy</span><br><span class="line">cat &lt;&lt;EOF &gt; nginx.conf  </span><br><span class="line"><span class="keyword">user</span>  nginx;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"> </span><br><span class="line">error_log  /var/<span class="keyword">log</span>/nginx/error.<span class="keyword">log</span> <span class="keyword">notice</span>;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">events {</span><br><span class="line">    worker_connections  <span class="number">65535</span>;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">stream {</span><br><span class="line">    upstream nacos-<span class="keyword">server</span>-grpc9848 {</span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.73</span>:<span class="number">9858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.74</span>:<span class="number">9858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.75</span>:<span class="number">9858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s</span><br><span class="line">     }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">server</span> {</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">9848</span>;</span><br><span class="line">        proxy_pass nacos-<span class="keyword">server</span>-grpc9848;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    upstream nacos-<span class="keyword">server</span>-grpc9849 {</span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.73</span>:<span class="number">9859</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.74</span>:<span class="number">9859</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;      </span><br><span class="line">      <span class="keyword">server</span> <span class="number">192.168</span><span class="number">.18</span><span class="number">.75</span>:<span class="number">9859</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">     }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">server</span> {</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">9849</span>;</span><br><span class="line">        proxy_pass nacos-<span class="keyword">server</span>-grpc9849;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">http {</span><br><span class="line">    <span class="keyword">include</span>       /etc/nginx/mime.<span class="keyword">types</span>;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"> </span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"> </span><br><span class="line">    access_log  /var/<span class="keyword">log</span>/nginx/<span class="keyword">access</span>.<span class="keyword">log</span>  main;</span><br><span class="line"> </span><br><span class="line">    sendfile        <span class="keyword">on</span>;</span><br><span class="line">    #tcp_nopush     <span class="keyword">on</span>;</span><br><span class="line"> </span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"> </span><br><span class="line">    #gzip  <span class="keyword">on</span>;</span><br><span class="line"> </span><br><span class="line">    upstream NACOS {</span><br><span class="line">      <span class="keyword">server</span>  <span class="number">192.168</span><span class="number">.18</span><span class="number">.73</span>:<span class="number">8858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">      <span class="keyword">server</span>  <span class="number">192.168</span><span class="number">.18</span><span class="number">.74</span>:<span class="number">8858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">      <span class="keyword">server</span>  <span class="number">192.168</span><span class="number">.18</span><span class="number">.75</span>:<span class="number">8858</span> max_fails=<span class="number">1</span> fail_timeout=<span class="number">30</span>s;</span><br><span class="line">   }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">server</span> {</span><br><span class="line">      <span class="keyword">listen</span>       <span class="number">8848</span> default_server;</span><br><span class="line">      server_name  _;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">location</span> / {</span><br><span class="line">        proxy_pass http://NACOS;</span><br><span class="line">      }</span><br><span class="line"> </span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">include</span> /etc/nginx/conf.d<span class="comment">/*.conf;</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment">EOF</span></span><br></pre></td></tr></tbody></table></figure><p>ä»£ç†å®¹å™¨yamlæ–‡ä»¶ç¼–å†™</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">nacos-nginx-proxy.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span>  </span><br><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nacos_proxy:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos_nginx_proxy</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"nginx:stable-alpine"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">80:</span> <span class="number">8848</span>  <span class="comment">#è¿™é‡Œå®šä¹‰ä¸€ä¸ª80æ˜¯ä¸ºäº†å‰ç«¯è®¿é—®ï¼Œæˆ–å®¢æˆ·ç«¯é…ç½®å®šä¹‰æ—¶æ— éœ€å†åŠ ç«¯å£ï¼Œä¸€ä¸ªipæˆ–è€…åŸŸåå³å¯</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8848</span><span class="string">:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9848</span><span class="string">:9848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9849</span><span class="string">:9849</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/root/nacos-proxy-deploy/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¹å™¨è¿è¡Œ</span></span><br><span class="line"><span class="string">docker-compose</span> <span class="string">-f</span> <span class="string">nacos-proxy.yaml</span> <span class="string">up</span> <span class="string">-d</span></span><br></pre></td></tr></tbody></table></figure><p><img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/4.png"><br>è‡³æ­¤æ­å»ºå®Œæ¯•ï¼Œä½†æ˜¯å®¹å™¨è¿è¡Œæ­£å¸¸ä¸ä¸€å®šæœåŠ¡å°±æ˜¯æ­£å¸¸ï¼Œè¿™æ—¶éœ€è¦æµ‹è¯•å®ä¾‹æœåŠ¡æ³¨å†Œæ˜¯å¦æ­£å¸¸</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; nacos_check_status.py &lt;&lt; EOF</span><br><span class="line"><span class="comment"># author: maoqiu.guo</span></span><br><span class="line"><span class="comment"># desc: NacosæœåŠ¡æ³¨å†ŒåŠŸèƒ½æµ‹è¯•ã€çŠ¶æ€ç›‘æ§</span></span><br><span class="line"><span class="comment"># dateï¼š2022-06-11</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> logging.handlers <span class="keyword">import</span> RotatingFileHandler</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line"><span class="comment"># åˆ›å»ºæ—¥å¿—è®°å½•å™¨ï¼ŒæŒ‡æ˜æ—¥å¿—ä¿å­˜çš„è·¯å¾„ï¼Œæ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å€¼ï¼Œä¿å­˜çš„æ—¥å¿—æ–‡ä»¶ä¸ªæ•°ä¸Šé™</span></span><br><span class="line">log_handle = RotatingFileHandler(<span class="string">'./log.txt'</span>, maxBytes=<span class="number">1024</span>*<span class="number">1024</span>, backupCount=<span class="number">5</span>)</span><br><span class="line"><span class="comment"># åˆ›å»ºæ—¥å¿—è®°å½•çš„æ ¼å¼</span></span><br><span class="line">formatter = logging.Formatter(<span class="string">"format = '%(asctime)s - %(name)s - %(levelname)s - %(message)s-%(funcName)s',"</span>)</span><br><span class="line"><span class="comment"># ä¸ºåˆ›å»ºçš„æ—¥å¿—è®°å½•å™¨è®¾ç½®æ—¥å¿—è®°å½•æ ¼å¼</span></span><br><span class="line">log_handle.setFormatter(formatter)</span><br><span class="line"><span class="comment"># ä¸ºå…¨å±€çš„æ—¥å¿—å·¥å…·å¯¹è±¡æ·»åŠ æ—¥å¿—è®°å½•å™¨</span></span><br><span class="line">logging.getLogger().addHandler(log_handle)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›åº¦æ¡</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">progress_bar</span>(<span class="params">timmer</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">101</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\r"</span>, end=<span class="string">""</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Waiting: {}%: "</span>.<span class="built_in">format</span>(i), <span class="string">"â–‹"</span> * (i // <span class="number">2</span>), end=<span class="string">""</span>)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        time.sleep(timmer)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Nacos</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.webhookurl=<span class="string">"https://oapi.dingtalk.com/robot/send?access_token=1968dd11647dfd686c4e1107cf1ad3d0d21c3813a824ee632728327722d9fa82"</span></span><br><span class="line">        <span class="variable language_">self</span>.login_url = <span class="string">"/nacos/v1/auth/users/login"</span></span><br><span class="line">        <span class="variable language_">self</span>.accessToken=<span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.service_url =  <span class="string">"/nacos/v1/ns/catalog/services"</span></span><br><span class="line">        <span class="variable language_">self</span>.instance_url = <span class="string">"/nacos/v1/ns/instance"</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dingding</span>(<span class="params">self, content</span>):</span><br><span class="line">         </span><br><span class="line">        data = {</span><br><span class="line">            <span class="string">"msgtype"</span>: <span class="string">"text"</span>,</span><br><span class="line">            <span class="string">"text"</span>: {</span><br><span class="line">                <span class="string">"content"</span>: <span class="string">"Nacos-"</span> + content,</span><br><span class="line">            },</span><br><span class="line">        }</span><br><span class="line">        headers = {<span class="string">'Content-Type'</span>: <span class="string">'application/json;charset=utf-8'</span>}</span><br><span class="line">        response = requests.post(<span class="variable language_">self</span>.webhookurl, data=json.dumps(data), headers=headers)</span><br><span class="line">        <span class="built_in">print</span>(response.content)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_access_token</span>(<span class="params">self, nacos_server</span>):</span><br><span class="line">        logging.info(<span class="string">"\n\n************** NacosServer: {0} **************"</span>.<span class="built_in">format</span>(nacos_server))</span><br><span class="line">        <span class="string">"ç™»å½•è·å–nacos accessToken"</span></span><br><span class="line">        params= <span class="string">"username=nacos&amp;password=nacos"</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = json.loads(requests.post(params=params, url=<span class="string">"http://"</span> + nacos_server + <span class="variable language_">self</span>.login_url, timeout=<span class="number">5</span>).text)</span><br><span class="line">            accessToken = <span class="built_in">str</span>((r[<span class="string">'accessToken'</span>]))</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">"accessToken"</span>: accessToken, <span class="string">"result"</span>: <span class="literal">True</span>, <span class="string">"server"</span>: nacos_server, <span class="string">"msg"</span>: <span class="string">"Login Nacos Success...[{0}]"</span>.<span class="built_in">format</span>(nacos_server)}</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> {<span class="string">"accessToken"</span>: <span class="literal">None</span>, <span class="string">"result"</span>: <span class="literal">False</span>, <span class="string">"server"</span>: nacos_server, <span class="string">"msg"</span>: <span class="string">"Login Nacos Falied...[{0}] Error: {1}"</span>.<span class="built_in">format</span>(nacos_server, <span class="built_in">str</span>(e))}</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_test</span>(<span class="params">self, accessToken, nacos_server</span>):</span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        1. åˆ›å»ºå®ä¾‹</span></span><br><span class="line"><span class="string">        2. æ³¨å†ŒæœåŠ¡</span></span><br><span class="line"><span class="string">        3. åˆ é™¤å®ä¾‹</span></span><br><span class="line"><span class="string">        4. åˆ é™¤æœåŠ¡</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        data={</span><br><span class="line">            <span class="string">"serviceName"</span>: <span class="string">"test_service_instance"</span>,</span><br><span class="line">            <span class="string">"namespaceId"</span>: <span class="string">"public"</span>,</span><br><span class="line">            <span class="string">"accessToken"</span>: accessToken,</span><br><span class="line">            <span class="string">"ip"</span>: nacos_server.split(<span class="string">":"</span>)[<span class="number">0</span>],</span><br><span class="line">            <span class="string">"port"</span>: nacos_server.split(<span class="string">":"</span>)[<span class="number">1</span>],</span><br><span class="line">            <span class="string">"ephemeral"</span>: <span class="literal">False</span></span><br><span class="line">        }</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># åˆ›å»ºæœåŠ¡(æ³¨å†Œå®ä¾‹)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = (requests.post(params=data, url=<span class="string">"http://"</span> + nacos_server + <span class="variable language_">self</span>.instance_url, timeout=<span class="number">5</span>).text)</span><br><span class="line">            <span class="keyword">if</span> r == <span class="string">"ok"</span>:</span><br><span class="line">                msg = <span class="string">"[æ³¨å†Œå®ä¾‹&amp;åˆ›å»ºæœåŠ¡æˆåŠŸ] Service: {0} NameSpace: {1} {2} InstanceIP: {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, data[<span class="string">'ip'</span>])</span><br><span class="line">                logging.info(msg)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                msg = <span class="string">"[æ³¨å†Œå®ä¾‹&amp;åˆ›å»ºæœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                msg = <span class="string">"[æ³¨å†Œå®ä¾‹&amp;åˆ›å»ºæœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">            </span><br><span class="line">    <span class="comment"># åˆ é™¤å®ä¾‹</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_instance_service</span>(<span class="params">self, accessToken, nacos_server</span>):</span><br><span class="line">        data={</span><br><span class="line">            <span class="string">"serviceName"</span>: <span class="string">"test_service_instance"</span>,</span><br><span class="line">            <span class="string">"namespaceId"</span>: <span class="string">"public"</span>,</span><br><span class="line">            <span class="string">"accessToken"</span>: accessToken,</span><br><span class="line">            <span class="string">"ip"</span>: nacos_server.split(<span class="string">":"</span>)[<span class="number">0</span>],</span><br><span class="line">            <span class="string">"port"</span>: nacos_server.split(<span class="string">":"</span>)[<span class="number">1</span>],</span><br><span class="line">            <span class="string">"ephemeral"</span>: <span class="literal">False</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment"># æ³¨é”€å®ä¾‹</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = (requests.delete(params=data, url=<span class="string">"http://"</span> + nacos_server + <span class="variable language_">self</span>.instance_url, timeout=<span class="number">5</span>).text)           </span><br><span class="line">            <span class="keyword">if</span> r == <span class="string">"ok"</span>:</span><br><span class="line">                msg = <span class="string">"[æ³¨é”€å®ä¾‹æˆåŠŸ] Service: {0} NameSpace: {1} {2} "</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server)</span><br><span class="line">                logging.info(msg)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                msg = <span class="string">"[æ³¨é”€å®ä¾‹å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                msg = <span class="string">"[æ³¨é”€å®ä¾‹å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line"> </span><br><span class="line">        progress_bar(timmer=<span class="number">0.08</span>)</span><br><span class="line">        <span class="comment"># åˆ é™¤æœåŠ¡</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = (requests.delete(params=data, url=<span class="string">"http://"</span> + nacos_server + <span class="string">"/nacos/v1/ns/service"</span>, timeout=<span class="number">5</span>).text)</span><br><span class="line">            <span class="keyword">if</span> r == <span class="string">"ok"</span>:</span><br><span class="line">                msg = <span class="string">"[åˆ é™¤æœåŠ¡æˆåŠŸ] Service: {0} NameSpace: {1} {2} "</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server)</span><br><span class="line">                logging.info(msg)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                msg = <span class="string">"[åˆ é™¤æœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                msg = <span class="string">"[åˆ é™¤æœåŠ¡å¤±è´¥] Service: {0} NameSpace: {1} {2} {3}"</span>.<span class="built_in">format</span>(data[<span class="string">'serviceName'</span>], data[<span class="string">'namespaceId'</span>], nacos_server, r)</span><br><span class="line">                logging.error(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">        progress_bar(timmer=<span class="number">0.1</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_service_list</span>(<span class="params">self, accessToken, nacos_server</span>):</span><br><span class="line">        <span class="string">"è¯·æ±‚è®¿é—®æŸä¸ªç¯å¢ƒçš„æŸä¸€ä¸ªæœåŠ¡åˆ—è¡¨, æ£€æŸ¥è¿”å›æ•°æ®æ˜¯å¦ä¸ºç©º,ä¸ºç©ºåˆ™ä¸ºä¸æ­£å¸¸"</span></span><br><span class="line">        payload={</span><br><span class="line">            <span class="string">"accessToken"</span>: accessToken,</span><br><span class="line">            <span class="string">"pageNo"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">"pageSize"</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="string">"namespaceId"</span>: <span class="string">"stage"</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = json.loads(requests.get(params=payload, url=<span class="string">"http://"</span> + nacos_server + <span class="variable language_">self</span>.service_url).text)</span><br><span class="line">            <span class="keyword">if</span> r[<span class="string">'count'</span>] == <span class="number">0</span>:</span><br><span class="line">                msg = <span class="string">"[è·å–æ³¨å†ŒæœåŠ¡æ•°æ®å¤±è´¥] Nacos Server {0} å½“å‰StageæœåŠ¡åˆ—è¡¨ä¸ºç©º!"</span>.<span class="built_in">format</span>(nacos_server)</span><br><span class="line">                logging.info(msg)</span><br><span class="line">                <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># print("Nacos æ³¨å†ŒæœåŠ¡æ•°æ®æ­£å¸¸...[{0}]".format(nacos_server))</span></span><br><span class="line">                logging.info(<span class="string">"[è·å–æ³¨å†ŒæœåŠ¡æ•°æ®æˆåŠŸ] ServiceTotal {1} on {0} - SercieName: stage "</span>.<span class="built_in">format</span>(nacos_server,r[<span class="string">'count'</span>]))</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">letsgo</span>(<span class="params">self, nacos_server</span>):</span><br><span class="line">        <span class="comment"># ç™»å½•è·å–token</span></span><br><span class="line">        login_nacos_res = (<span class="variable language_">self</span>.get_access_token(nacos_server))</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span> login_nacos_res[<span class="string">"result"</span>]:</span><br><span class="line">            logging.info(<span class="string">"[ç™»å½•è·å–accessToken æˆåŠŸ] Nacos Server {0} "</span>.<span class="built_in">format</span>((login_nacos_res[<span class="string">'server'</span>])))</span><br><span class="line"> </span><br><span class="line">            <span class="variable language_">self</span>.get_service_list(login_nacos_res[<span class="string">'accessToken'</span>], login_nacos_res[<span class="string">'server'</span>] )</span><br><span class="line"> </span><br><span class="line">            <span class="comment"># åˆ›å»ºå®ä¾‹&amp;æœåŠ¡</span></span><br><span class="line">            <span class="variable language_">self</span>.register_test(login_nacos_res[<span class="string">'accessToken'</span>], login_nacos_res[<span class="string">'server'</span>] )</span><br><span class="line"> </span><br><span class="line">            <span class="comment">#time.sleep(60 * 2)</span></span><br><span class="line">            progress_bar(timmer=<span class="number">0.1</span>)</span><br><span class="line">            <span class="variable language_">self</span>.delete_instance_service(login_nacos_res[<span class="string">'accessToken'</span>], login_nacos_res[<span class="string">'server'</span>] )</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = <span class="string">"[ç™»å½•è·å–accessToken å¤±è´¥] {0} "</span>.<span class="built_in">format</span>((login_nacos_res[<span class="string">'msg'</span>]))</span><br><span class="line">            logging.info(msg)</span><br><span class="line">            <span class="variable language_">self</span>.dingding(<span class="variable language_">self</span>, content=msg)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        nacos_server_list=[</span><br><span class="line">        <span class="comment">#"nacos.axiba.com",</span></span><br><span class="line">            <span class="string">"192.168.18.75:80"</span>,</span><br><span class="line">            <span class="string">"192.168.18.75:8848"</span>,</span><br><span class="line">            <span class="string">"192.168.18.73:8858"</span>,</span><br><span class="line">            <span class="string">"192.168.18.74:8858"</span>,</span><br><span class="line">            <span class="string">"192.168.18.75:8858"</span>,</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nacos_server_list:</span><br><span class="line">            Nacos().letsgo(i)</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>è¿è¡Œåï¼š</p><p>ä»¥ä¸Šè„šæœ¬é€šè¿‡Nacosçš„OpenApiå¾ªç¯å¼é€šè¿‡ä»æ¯ä¸ªèŠ‚ç‚¹è®¿é—®åå‘èµ·ä»¥åŠé€šè¿‡Nginxä»£ç†å‘èµ·æœåŠ¡å®ä¾‹çš„æŸ¥è¯¢ã€æ³¨å†Œã€åˆ é™¤æ“ä½œã€‚<br><img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/5.png"></p><ol><li>ç™»å½•è·å–AccessToke(æ¯ä¸ªè¯·æ±‚éœ€è¦æºå¸¦)</li><li>åœ¨ è·å–stageç¯å¢ƒçš„æœåŠ¡åˆ—è¡¨æ•°æ®ï¼Œè¿™æ˜¯ä¸ºäº†ç›‘æµ‹è¿”å›æ•°æ®æ˜¯å¦æ­£å¸¸ï¼Œå› ä¸ºè¿™é‡Œåˆšæ­å»ºèµ·æ¥ï¼Œå¦‚æœé‡Œé¢æœåŠ¡æ•°æ®ä¸æ­£å¸¸åˆ™ä¼šå‡ºç°ä¸Šé¢æç¤ºï¼Œå¹¶å‘é€æ¶ˆæ¯åˆ°é’‰é’‰ï¼›</li></ol><p> <img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/6.png">  </p><p>ä¸Šå›¾æ˜¯é€šè¿‡ä»£ç†è®¿é—®è·å–stageä¸­çš„æœåŠ¡ä¸º0ï¼Œåå‘é€é€šçŸ¥ï¼Œè¯´æ˜æ­¤æ—¶å¯èƒ½(å› ä¸ºé€šè¿‡è´Ÿè½½å¹¶ä¸çŸ¥é“è¯¥è¯·æ±‚æ˜¯è½åœ¨äº†å“ªä¸€ä¸ªNacosèŠ‚ç‚¹)é›†ç¾¤ä¸­æŸä¸ªèŠ‚ç‚¹å‡ºç°æ•…éšœæ•°æ®ä¸æ­£å¸¸äº†ï¼Œä½†æ˜¯åœ¨æ£€æµ‹è„šæœ¬ä¸­ä¼šé€šè¿‡æ¯ä¸ªèŠ‚ç‚¹å»æ³¨å†Œï¼Œé‚£ä¹ˆä¸€å®šä¼šåœ¨å‡ºç°é€šçŸ¥æŸä¸ªèŠ‚ç‚¹æ•…éšœã€‚<br>4. åœ¨publicç¯å¢ƒä¸­é€šè¿‡è°ƒç”¨OpenApiæ–¹å¼åˆ›å»ºã€æ³¨å†Œä¸€ä¸ªå®ä¾‹ test_service_instance è·ŸæœåŠ¡ï¼Œç„¶åæ³¨é”€å®ä¾‹ï¼Œå¹¶åˆ é™¤æœåŠ¡ï¼Œè¿™æ˜¯ä¸ºäº†ç›‘æµ‹é›†ç¾¤æ˜¯å¦æ­£å¸¸ã€‚</p><h1 id="ä¸‰ã€å°è®°"><a href="#ä¸‰ã€å°è®°" class="headerlink" title="ä¸‰ã€å°è®°"></a>ä¸‰ã€å°è®°</h1><ol><li>è™½ç„¶æ–‡æ¡£ç»™å‡ºçš„æè¿°æ˜¯åªæœ‰å½“æœåŠ¡ä¸‹å®ä¾‹æ•°ä¸º0æ—¶å…è®¸åˆ é™¤ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶æ²¡æœ‰å¼ºåˆ¶æ£€æŸ¥æ ¡éªŒæœåŠ¡ä¸‹çš„å®ä¾‹æ•°æ˜¯å¦ä¸º0ã€‚Nacosçš„æœåŠ¡åˆ›å»ºæœ‰å¤šç§æ–¹å¼ï¼Œå¯ä»¥ä¸»åŠ¨åˆ›å»ºå¯ä»¥åœ¨æ³¨å†Œå®ä¾‹çš„æ—¶å€™åˆ›å»ºï¼Œå¯ä»¥åœ¨å®ä¾‹å‘é€å¿ƒè·³æ—¶åˆ›å»ºï¼Œæ‰€ä»¥å“ªæ€•ä¸»åŠ¨åˆ é™¤äº†è¿˜ä¼šè‡ªåŠ¨åˆ›å»ºå›æ¥ã€‚ï¼›</li><li>æ‰€æœ‰å·²æ³¨å†ŒæœåŠ¡åœ¨å®¹å™¨é‡å¯åä¼šä¸¢å¤±ï¼Œä½†æ˜¯åªè¦ä¿è¯é›†ç¾¤ä¸­æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ­£å¸¸ï¼Œé‚£ä¹ˆé‡å¯åçš„æœåŠ¡æ•°æ®ä¼šåŒæ­¥å…¶ä»–æ­£å¸¸èŠ‚ç‚¹çš„ï¼Œå³éœ€è¦å®¢æˆ·ç«¯é‡æ–°æ³¨å†Œï¼›</li><li>æ­£å¸¸æƒ…å†µåœ¨æŸä¸ªèŠ‚ç‚¹æ³¨å†Œäº†æœåŠ¡åä¼šåŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚</li><li>å„èŠ‚ç‚¹æ— æ³•é€‰ä¸¾ä¸€ä¸ªleaderæ—¶ æŸ¥çœ‹æ—¥å¿—ï¼š/data/nacos2.0.2_1/logs/alipay-jraft.log</li><li>å®ä¾‹æœåŠ¡ç›¸å…³æ—¥å¿—:  /data/nacos2.0.2_1/naming-raft.log</li><li>é€šè¿‡æ—¥å¿—å‘ç°ï¼Œæš´éœ²8848ç«¯å£æ˜¯ä¸ºäº†nacoså®¢æˆ·ç«¯ç™»é™†è·å–Tokenï¼Œåç»­æ“ä½œéƒ½ä¼šæºå¸¦Tokenè¿›è¡Œèµ„æºæ“ä½œï¼›ç„¶åæš´éœ²9848ç«¯å£æ˜¯å®¢æˆ·ç«¯ç”¨äºgRPCçš„è¯·æ±‚ï¼Œæ‰€ä»¥å¦‚æœæ˜¯è®¾ç½®äº†ä»£ç†è½¬å‘ï¼ŒåŠ¡å¿…å°†å…¶æš´éœ²ï¼Œå¦åˆ™è¿æ¥å¤±è´¥å¤±è´¥ã€‚</li></ol><h1 id="å››ã€åæ§½"><a href="#å››ã€åæ§½" class="headerlink" title="å››ã€åæ§½"></a>å››ã€åæ§½</h1><p>Nacos å®˜æ–¹ä¸ºäº†æ¨å•†ä¸šç‰ˆï¼Œç¤¾åŒºç‰ˆå‡ ä¹æ¯›ç—…ç™¾å‡ºï¼Œä¸ç®¡ä¸é¡¾ï¼Œæ–‡æ¡£ä¹Ÿæ˜¯å†™å¾—ä¸€å›¢ç³Ÿ~ æ— åŠ›åæ§½</p><p> <img src="/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/7.jpg">  </p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ä¸€ã€æ­å»ºæ¶æ„&quot;&gt;&lt;a href=&quot;#ä¸€ã€æ­å»ºæ¶æ„&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€æ­å»ºæ¶æ„&quot;&gt;&lt;/a&gt;ä¸€ã€æ­å»ºæ¶æ„&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/arch-1.png&quot;&gt;&lt;br&gt;â— 3ä¸ªæˆ–3ä¸ªä»¥ä¸ŠNacosèŠ‚ç‚¹æ‰èƒ½æ„æˆé›†ç¾¤ï¼›&lt;br&gt;â— Nacos Nginx Proxyç”¨äºä»£ç†è½¬å‘ï¼›&lt;/p&gt;
&lt;hr&gt;
&lt;h1 id=&quot;äºŒã€å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;a href=&quot;#äºŒã€å‡†å¤‡å·¥ä½œ&quot; class=&quot;headerlink&quot; title=&quot;äºŒã€å‡†å¤‡å·¥ä½œ&quot;&gt;&lt;/a&gt;äºŒã€å‡†å¤‡å·¥ä½œ&lt;/h1&gt;&lt;p&gt;&lt;em&gt;&lt;strong&gt;Nacos2.0ç‰ˆæœ¬ç›¸æ¯”1.Xæ–°å¢äº†gRPCçš„é€šä¿¡æ–¹å¼ï¼Œå› æ­¤éœ€è¦å¢åŠ 2ä¸ªç«¯å£ã€‚æ–°å¢ç«¯å£æ˜¯åœ¨é…ç½®çš„ä¸»ç«¯å£(server.port)åŸºç¡€ä¸Šï¼Œè¿›è¡Œä¸€å®šåç§»é‡è‡ªåŠ¨ç”Ÿæˆã€‚&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç«¯å£&lt;/th&gt;
&lt;th&gt;ä¸ä¸»ç«¯å£çš„åç§»é‡&lt;/th&gt;
&lt;th&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;8848&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;Nacosç¨‹åºä¸»é…ç½®ç«¯å£&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;9848&lt;/td&gt;
&lt;td&gt;+1000&lt;/td&gt;
&lt;td&gt;å®¢æˆ·ç«¯gRPCè¯·æ±‚æœåŠ¡ç«¯ç«¯å£ï¼Œç”¨äºå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥å’Œè¯·æ±‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;9849&lt;/td&gt;
&lt;td&gt;+1001&lt;/td&gt;
&lt;td&gt;æœåŠ¡ç«¯gRPCè¯·æ±‚æœåŠ¡ç«¯ç«¯å£ï¼Œç”¨äºæœåŠ¡é—´åŒæ­¥ç­‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;7848&lt;/td&gt;
&lt;td&gt;-1000&lt;/td&gt;
&lt;td&gt;Nacos é›†ç¾¤é€šä¿¡ç«¯å£ï¼Œç”¨äºNacos é›†ç¾¤é—´è¿›è¡Œé€‰ä¸¾ï¼Œæ£€æµ‹ç­‰&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;ä½¿ç”¨VIP/nginxè¯·æ±‚æ—¶ï¼Œéœ€è¦é…ç½®æˆTCPè½¬å‘ï¼Œä¸èƒ½é…ç½®http2è½¬å‘ï¼Œå¦åˆ™è¿æ¥ä¼šè¢«nginxæ–­å¼€&lt;/strong&gt;&lt;/em&gt;&lt;br&gt;&lt;img src=&quot;/2022/06/22/%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E5%8C%96%E9%83%A8%E7%BD%B2Nacos%E9%9B%86%E7%BE%A4/arch-2.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;æŒ‰ç…§ä¸Šè¿°å®˜æ–¹çš„ç«¯å£åˆ†é…è¦æ±‚ ï¼Œæ­¤å¤„éƒ¨ç½²çš„ä½¿ç”¨ä¸‰å°æœåŠ¡å™¨ä¸Šé¢åˆ›å»ºçš„Nacosé›†ç¾¤ç«¯å£åˆ†é…å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;èŠ‚ç‚¹&lt;/th&gt;
&lt;th&gt;IP&lt;/th&gt;
&lt;th&gt;ç«¯å£ï¼ˆæ‰€éœ€æš´éœ²ï¼‰&lt;/th&gt;
&lt;th&gt;å¤‡æ³¨&lt;/th&gt;
&lt;th&gt;ç‰ˆæœ¬&lt;/th&gt;
&lt;th&gt;å½“å‰çº¿ä¸‹ç¯å¢ƒéƒ¨ç½²æ–‡ä»¶è·¯å¾„&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;Nacos_1&lt;/td&gt;
&lt;td&gt;192168.18.73&lt;/td&gt;
&lt;td&gt;å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858  å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858&lt;/td&gt;
&lt;td&gt;Nacos èŠ‚ç‚¹ä¸€&lt;/td&gt;
&lt;td&gt;nacos/nacos-server:2.0.2&lt;/td&gt;
&lt;td&gt;/root/nacos-deploy/&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Nacos_2&lt;/td&gt;
&lt;td&gt;192168.18.74&lt;/td&gt;
&lt;td&gt;å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858  å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858&lt;/td&gt;
&lt;td&gt;Nacos èŠ‚ç‚¹äºŒ&lt;/td&gt;
&lt;td&gt;nacos/nacos-server:2.0.2&lt;/td&gt;
&lt;td&gt;/root/nacos-deploy/&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Nacos_3&lt;/td&gt;
&lt;td&gt;192168.18.75&lt;/td&gt;
&lt;td&gt;å®¿ä¸»æœºï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858  å®¹å™¨ï¼š8858ï¼Œ9858ï¼Œ9859ï¼Œ7858&lt;/td&gt;
&lt;td&gt;Nacos èŠ‚ç‚¹ä¸‰&lt;/td&gt;
&lt;td&gt;nacos/nacos-server:2.0.2&lt;/td&gt;
&lt;td&gt;/root/nacos-deploy/&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Nacos DB&lt;/td&gt;
&lt;td&gt;192168.18.75&lt;/td&gt;
&lt;td&gt;å®¿ä¸»æœºï¼š3306 å®¹å™¨ï¼š3306&lt;/td&gt;
&lt;td&gt;Nacosæ‰€éœ€æ•°æ®åº“&lt;/td&gt;
&lt;td&gt;mysql:5.7.34&lt;/td&gt;
&lt;td&gt;/root/nacos-mysql-deploy&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Nacos  Nginx Proxy&lt;/td&gt;
&lt;td&gt;192168.18.75&lt;/td&gt;
&lt;td&gt;å®¿ä¸»æœºï¼š80  å®¹å™¨ï¼š80&lt;/td&gt;
&lt;td&gt;Nacosä»£ç†&lt;/td&gt;
&lt;td&gt;nginx:stable-alpine&lt;/td&gt;
&lt;td&gt;/root/nacos-proxy-deploy&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;h2 id=&quot;2-1-åˆ›å»ºNacosæ•°æ®åº“&quot;&gt;&lt;a href=&quot;#2-1-åˆ›å»ºNacosæ•°æ®åº“&quot; class=&quot;headerlink&quot; title=&quot;2.1  åˆ›å»ºNacosæ•°æ®åº“&quot;&gt;&lt;/a&gt;2.1  åˆ›å»ºNacosæ•°æ®åº“&lt;/h2&gt;</summary>
    
    
    
    <category term="åŸºç¡€ç»„ä»¶" scheme="https://blog.sctux.cc/categories/%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/"/>
    
    <category term="éƒ¨ç½²" scheme="https://blog.sctux.cc/categories/%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/%E9%83%A8%E7%BD%B2/"/>
    
    
    <category term="nacos" scheme="https://blog.sctux.cc/tags/nacos/"/>
    
  </entry>
  
  <entry>
    <title>è¿ç»´å·¥ä½œä¸­è‡ªåŠ¨åŒ–å·¡æ£€çš„å¿…è¦æ€§ä»¥åŠé‡è¦æ€§</title>
    <link href="https://blog.sctux.cc/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/"/>
    <id>https://blog.sctux.cc/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/</id>
    <published>2022-05-12T02:42:13.000Z</published>
    <updated>2025-09-01T01:59:08.876Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€"><a href="#ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€" class="headerlink" title="ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€"></a>ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€</h1><ol><li>å½“å‰å¹³å°æ¶æ„å¤æ‚ï¼Œä¸­é—´ä»¶ç¹å¤šï¼Œç»„ä»¶ä¹‹é—´è€¦åˆåº¦é«˜ï¼Œå¾®æœåŠ¡è¿˜æœªè¾¾åˆ°æ•…éšœè‡ªæ„ˆæ°´å¹³ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å‘Šè­¦æˆ–å·¡æ£€ç­‰æ‰‹æ®µå‘ç°é—®é¢˜æ¥ä¿éšœå¹³å°æŒç»­ç¨³å®šè¿è¡Œã€‚</li><li>å½“å‰æœ‰å®¢æˆ·å¯¹å¹³å°åŠä¸Šå±‚åº”ç”¨ä½¿ç”¨é¢‘ç‡ä½ï¼Œä¾‹å¦‚ä¸‰å››å¤©ç™»å½•æŸ¥çœ‹ä¸€æ¬¡æ•°æ®ï¼Œä½†æ˜¯è®¾å¤‡æ˜¯æ­£å¸¸è¿è½¬çš„ï¼Œä¸€æ—¦å¹³å°å‡ºç°é—®é¢˜ï¼Œåˆšå¥½å®¢æˆ·å‘ç°é—®é¢˜ï¼Œè¿ç»´ æ‰å»è§£å†³å°±ä¸ºæ—¶å·²æ™šã€‚</li><li>å®šæœŸå·¡æ£€æ–¹æ¡ˆæ˜¯æ¨¡æ‹Ÿäººå·¥ç™»å½•å„ä¸šåŠ¡é¡µé¢ï¼Œè€Œéæ¥å£è°ƒç”¨ï¼Œæ›´èƒ½çœŸå®åœ°å‘ç°é—®é¢˜ï¼Œå¹¶é€šè¿‡æˆªå›¾çœŸå®ä¿ç•™å¹³å°è¿è¡ŒçŠ¶æ€ã€‚</li><li>Prometheuså¹³å°çš„ç›‘æ§æŠ¥è­¦åŠŸèƒ½è¿˜æœªè¦†ç›–åˆ°æ•´ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œéƒ¨åˆ†é—®é¢˜è¿˜æœªèƒ½å®æ—¶ç›‘æ§åˆ°ï¼Œå¯¼è‡´å¹³å°å‡ºç°å¼‚å¸¸åè€Œæ— æ³•æ„ŸçŸ¥ã€‚</li><li>å½“å‰å¹¶ä¸èƒ½ä¿è¯å®¢æˆ·ç¯å¢ƒçš„Prometheuså¹³å°æœ¬èº«ä¸å­˜åœ¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ç§ä¸ç¡®å®šæ€§ï¼Œå®šæœŸå·¡æ£€æ˜¯ä¸€ä¸ªä¿éšœå¹³å°ç¨³å®šæ€§çš„æ–¹æ¡ˆï¼Œå®ç°å¹³å°åŒä¿éšœã€‚</li><li>éƒ¨åˆ†å®¢æˆ·ç¯å¢ƒä¸èƒ½å¤Ÿè¿æ¥å¤–ç½‘ï¼ŒPrometheusçš„ç›‘æ§å‘Šè­¦ä¿¡æ¯æ— æ³•åŒæ­¥åˆ°å¾®ä¿¡ã€é£ä¹¦ç­‰ï¼Œä½†å¯ä»¥é€šè¿‡å®šæœŸå·¡æ£€æ–¹æ¡ˆæ¥ä¿éšœå¹³å°ç¨³å®šè¿è¡Œã€‚</li></ol><p>ç”±äºä»¥ä¸ŠåŸå› ï¼Œä¸ºäº†ä¿è¯SLAï¼Œå¿…é¡»è¿›è¡Œå®šæœŸå·¡æ£€ã€‚</p><h1 id="äºŒã€å·¡æ£€æ£€æŸ¥é¡¹"><a href="#äºŒã€å·¡æ£€æ£€æŸ¥é¡¹" class="headerlink" title="äºŒã€å·¡æ£€æ£€æŸ¥é¡¹"></a>äºŒã€å·¡æ£€æ£€æŸ¥é¡¹</h1><h2 id="2-1-æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯"><a href="#2-1-æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯" class="headerlink" title="2.1  æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯"></a>2.1  æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯</h2><pre><code>cpu åˆ©ç”¨ç‡ç£ç›˜åˆ©ç”¨ç‡å†…å­˜åˆ©ç”¨ç‡æœåŠ¡å™¨æ—¶é—´åŒæ­¥æ—¥å¸¸æ•°æ®å¤‡ä»½æ–‡ä»¶æ£€æŸ¥</code></pre><h2 id="2-2-k8sé›†ç¾¤çŠ¶æ€"><a href="#2-2-k8sé›†ç¾¤çŠ¶æ€" class="headerlink" title="2.2  k8sé›†ç¾¤çŠ¶æ€"></a>2.2  k8sé›†ç¾¤çŠ¶æ€</h2><pre><code>è¯ä¹¦è¿‡æœŸæ£€æŸ¥APIé€šä¿¡æ˜¯å¦æ­£å¸¸å„åç§°ç©ºé—´ä¸‹çš„podè¿è¡ŒçŠ¶æ€cephå…±äº«å­˜å‚¨æ˜¯å¦æ­£å¸¸</code></pre><h2 id="2-3-ä¸šåŠ¡çŠ¶æ€"><a href="#2-3-ä¸šåŠ¡çŠ¶æ€" class="headerlink" title="2.3  ä¸šåŠ¡çŠ¶æ€"></a>2.3  ä¸šåŠ¡çŠ¶æ€</h2><pre><code>ä¸šåŠ¡å¹³å°ç™»å½•æ˜¯å¦æ­£å¸¸kafkaæ˜¯å¦ç§¯å‹kafkaæ¶ˆè´¹é€Ÿç‡</code></pre><h1 id="ä¸‰ã€å®ç°æ–¹å¼"><a href="#ä¸‰ã€å®ç°æ–¹å¼" class="headerlink" title="ä¸‰ã€å®ç°æ–¹å¼"></a>ä¸‰ã€å®ç°æ–¹å¼</h1><p><strong>å‰æœŸ</strong>ï¼šå‰æœŸå·¡æ£€åŒäº‹ç™»å½•å„å®¢æˆ·ç¯å¢ƒè¿›è¡Œäººå·¥æ‰‹åŠ¨å·¡æ£€(ç™»å½•VPNã€è¿æ¥è·³æ¿æœºã€ç™»å½•ä¸šåŠ¡å¹³å°ã€ç™»å½•grafanaå¹³å°ç­‰ç­‰)ä¸€äº›åˆ—æ“ä½œä¸‹æ¥ï¼Œä¸€è½®å·¡æ£€å·¥ä½œå¤§çº¦åœ¨2-3hoursã€‚</p><p><strong>ç›®å‰</strong>ï¼šé€šè¿‡è‡ªåŠ¨åŒ–çš„æ–¹å¼(shell+python+webæ¡†æ¶flask)å®ç°äº†ï¼Œäººå·¥åœ¨windowsè·³æ¿æœºä¸Šã€LinuxæœåŠ¡å™¨ä¸­çš„æ¨¡æ‹Ÿäººå·¥æ“ä½œè¿æ¥VPNã€ç™»å½•ä¸šåŠ¡å¹³å°ã€ç™»å½•grafanaå¹³å°ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œå®šæœŸå®šæ—¶å°†å·¡æ£€ä»»åŠ¡ç»“æœå‘é€è‡³ä¼ä¸šå¾®ä¿¡ç¾¤å†…ï¼›ä»å•äººå•æ¬¡å·¡æ£€çš„2-3å°æ—¶ï¼Œç›´æ¥ææ•ˆåˆ°äº†5-10minï¼Œæå¤§ç¨‹åº¦ä¸Šæé«˜äº†æ—¥å¸¸å·¡æ£€çš„å·¥ä½œæ•ˆç‡ã€‚<br><img src="/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/1.png"><br><img src="/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/2.png"></p><p><img src="/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/3.png"></p><p>é‚£ä¹ˆï¼Œåœ¨å®¢æˆ·ç¯å¢ƒæ•°é‡è¾¾åˆ°ä¸€å®šä½“é‡æ—¶ï¼Œç¾¤æ¶ˆæ¯æ¥æ”¶ä¹Ÿä¼šé€ æˆå·¡æ£€é—æ¼çš„æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹éœ€è¦ä¸€ä¸ªé›†ä¸­åŒ–çš„å¹³å°ä½œä¸ºå±•ç¤ºï¼Œäºæ˜¯å°†å·¡æ£€ç»“æœå‘é€åˆ°ç¾¤å†…çš„åŒæ—¶ä¹Ÿä¼šå°†æ¶ˆæ¯æ ¼å¼åŒ–(æ³¨ï¼šå›¾ç‰‡æ˜¯é€šè¿‡Pythonæˆªå›¾ç”Ÿæˆåå°†å…¶è½¬æ¢ä¸ºbase64ç¼–ç ï¼Œç„¶åå°†å…¶ä»–å·¡æ£€ç»“æœå†…å®¹æ ¼å¼åŒ–ä¸ºjsonåpoståˆ°webåç«¯ï¼Œå†åœ¨webå‰ç«¯è¿›è¡Œå±•ç¤º)</p><p><img src="/2022/05/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A1%E6%A3%80%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7%E4%BB%A5%E5%8F%8A%E9%87%8D%E8%A6%81%E6%80%A7/4.png"></p><p>Detail: é€šè¿‡ç‚¹å‡»åå¼¹å‡ºæ•´ä¸ªå·¡æ£€è¿‡ç¨‹ä»¥åŠç»“æœä¿¡æ¯ï¼›</p><p>Screenshoot: é€šè¿‡ç‚¹å‡»åå°†ä¼šå¼¹å‡ºbase64ç¼–ç è½¬æ¢ä¸ºå›¾ç‰‡çš„ä¸šåŠ¡å¹³å°åŠgrafanaæˆªå›¾</p><p>æœ€åï¼Œå·¡æ£€äººå‘˜åªéœ€è¦å®šæœŸæµè§ˆæ­¤æ±‡æ€»å±•ç¤ºå¹³å°å³å¯ï¼</p><p>(äººå·¥æ“ä½œæ˜¯åŸºç¡€ï¼Œè‡ªåŠ¨åŒ–æ“ä½œæ‰æ˜¯ç‹é“ğŸ˜€ )</p><h3 id="æŠ€æœ¯ç‚¹"><a href="#æŠ€æœ¯ç‚¹" class="headerlink" title="æŠ€æœ¯ç‚¹"></a>æŠ€æœ¯ç‚¹</h3><ul><li>Pythonè‡ªåŠ¨åŒ–</li><li>Seleniumçˆ¬è™«æŠ€æœ¯(ç½‘é¡µå†…å®¹è·å–)</li><li>Windowsç«¯UIè‡ªåŠ¨åŒ–(ç”¨äºè‡ªåŠ¨å¯åŠ¨VPNç¨‹åºï¼Œå¹¶å¡«å†™è´¦å·å¯†ç åè¿›è¡Œç™»å½•æ“ä½œ)</li><li>Flaskå‰åç«¯å¼€å‘(å¹³å°å±•ç¤ºï¼Œå†…å®¹æ¥æ”¶å…¥åº“)</li><li>ä¼ä¸šå¾®ä¿¡æœºå™¨äººWebhooké›†æˆ</li></ul>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€&quot;&gt;&lt;a href=&quot;#ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€&quot;&gt;&lt;/a&gt;ä¸€ã€ä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¡æ£€&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;å½“å‰å¹³å°æ¶æ„å¤æ‚ï¼Œä¸­é—´ä»¶ç¹å¤šï¼Œç»„ä»¶ä¹‹é—´è€¦åˆåº¦é«˜ï¼Œå¾®æœåŠ¡è¿˜æœªè¾¾åˆ°æ•…éšœè‡ªæ„ˆæ°´å¹³ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å‘Šè­¦æˆ–å·¡æ£€ç­‰æ‰‹æ®µå‘ç°é—®é¢˜æ¥ä¿éšœå¹³å°æŒç»­ç¨³å®šè¿è¡Œã€‚&lt;/li&gt;
&lt;li&gt;å½“å‰æœ‰å®¢æˆ·å¯¹å¹³å°åŠä¸Šå±‚åº”ç”¨ä½¿ç”¨é¢‘ç‡ä½ï¼Œä¾‹å¦‚ä¸‰å››å¤©ç™»å½•æŸ¥çœ‹ä¸€æ¬¡æ•°æ®ï¼Œä½†æ˜¯è®¾å¤‡æ˜¯æ­£å¸¸è¿è½¬çš„ï¼Œä¸€æ—¦å¹³å°å‡ºç°é—®é¢˜ï¼Œåˆšå¥½å®¢æˆ·å‘ç°é—®é¢˜ï¼Œè¿ç»´ æ‰å»è§£å†³å°±ä¸ºæ—¶å·²æ™šã€‚&lt;/li&gt;
&lt;li&gt;å®šæœŸå·¡æ£€æ–¹æ¡ˆæ˜¯æ¨¡æ‹Ÿäººå·¥ç™»å½•å„ä¸šåŠ¡é¡µé¢ï¼Œè€Œéæ¥å£è°ƒç”¨ï¼Œæ›´èƒ½çœŸå®åœ°å‘ç°é—®é¢˜ï¼Œå¹¶é€šè¿‡æˆªå›¾çœŸå®ä¿ç•™å¹³å°è¿è¡ŒçŠ¶æ€ã€‚&lt;/li&gt;
&lt;li&gt;Prometheuså¹³å°çš„ç›‘æ§æŠ¥è­¦åŠŸèƒ½è¿˜æœªè¦†ç›–åˆ°æ•´ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œéƒ¨åˆ†é—®é¢˜è¿˜æœªèƒ½å®æ—¶ç›‘æ§åˆ°ï¼Œå¯¼è‡´å¹³å°å‡ºç°å¼‚å¸¸åè€Œæ— æ³•æ„ŸçŸ¥ã€‚&lt;/li&gt;
&lt;li&gt;å½“å‰å¹¶ä¸èƒ½ä¿è¯å®¢æˆ·ç¯å¢ƒçš„Prometheuså¹³å°æœ¬èº«ä¸å­˜åœ¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ç§ä¸ç¡®å®šæ€§ï¼Œå®šæœŸå·¡æ£€æ˜¯ä¸€ä¸ªä¿éšœå¹³å°ç¨³å®šæ€§çš„æ–¹æ¡ˆï¼Œå®ç°å¹³å°åŒä¿éšœã€‚&lt;/li&gt;
&lt;li&gt;éƒ¨åˆ†å®¢æˆ·ç¯å¢ƒä¸èƒ½å¤Ÿè¿æ¥å¤–ç½‘ï¼ŒPrometheusçš„ç›‘æ§å‘Šè­¦ä¿¡æ¯æ— æ³•åŒæ­¥åˆ°å¾®ä¿¡ã€é£ä¹¦ç­‰ï¼Œä½†å¯ä»¥é€šè¿‡å®šæœŸå·¡æ£€æ–¹æ¡ˆæ¥ä¿éšœå¹³å°ç¨³å®šè¿è¡Œã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ç”±äºä»¥ä¸ŠåŸå› ï¼Œä¸ºäº†ä¿è¯SLAï¼Œå¿…é¡»è¿›è¡Œå®šæœŸå·¡æ£€ã€‚&lt;/p&gt;
&lt;h1 id=&quot;äºŒã€å·¡æ£€æ£€æŸ¥é¡¹&quot;&gt;&lt;a href=&quot;#äºŒã€å·¡æ£€æ£€æŸ¥é¡¹&quot; class=&quot;headerlink&quot; title=&quot;äºŒã€å·¡æ£€æ£€æŸ¥é¡¹&quot;&gt;&lt;/a&gt;äºŒã€å·¡æ£€æ£€æŸ¥é¡¹&lt;/h1&gt;&lt;h2 id=&quot;2-1-æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#2-1-æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;2.1  æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯&quot;&gt;&lt;/a&gt;2.1  æœåŠ¡å™¨åŸºç¡€ä¿¡æ¯&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;	cpu åˆ©ç”¨ç‡
	ç£ç›˜åˆ©ç”¨ç‡
	å†…å­˜åˆ©ç”¨ç‡
	æœåŠ¡å™¨æ—¶é—´åŒæ­¥
	æ—¥å¸¸æ•°æ®å¤‡ä»½æ–‡ä»¶æ£€æŸ¥
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;2-2-k8sé›†ç¾¤çŠ¶æ€&quot;&gt;&lt;a href=&quot;#2-2-k8sé›†ç¾¤çŠ¶æ€&quot; class=&quot;headerlink&quot; title=&quot;2.2  k8sé›†ç¾¤çŠ¶æ€&quot;&gt;&lt;/a&gt;2.2  k8sé›†ç¾¤çŠ¶æ€&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;	è¯ä¹¦è¿‡æœŸæ£€æŸ¥
	APIé€šä¿¡æ˜¯å¦æ­£å¸¸
	å„åç§°ç©ºé—´ä¸‹çš„podè¿è¡ŒçŠ¶æ€
	cephå…±äº«å­˜å‚¨æ˜¯å¦æ­£å¸¸
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;2-3-ä¸šåŠ¡çŠ¶æ€&quot;&gt;&lt;a href=&quot;#2-3-ä¸šåŠ¡çŠ¶æ€&quot; class=&quot;headerlink&quot; title=&quot;2.3  ä¸šåŠ¡çŠ¶æ€&quot;&gt;&lt;/a&gt;2.3  ä¸šåŠ¡çŠ¶æ€&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;	ä¸šåŠ¡å¹³å°ç™»å½•æ˜¯å¦æ­£å¸¸
	kafkaæ˜¯å¦ç§¯å‹
	kafkaæ¶ˆè´¹é€Ÿç‡
&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="è‡ªåŠ¨åŒ–è¿ç»´" scheme="https://blog.sctux.cc/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="è‡ªåŠ¨åŒ–è¿ç»´" scheme="https://blog.sctux.cc/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/"/>
    
    <category term="Python" scheme="https://blog.sctux.cc/tags/Python/"/>
    
    <category term="Flask" scheme="https://blog.sctux.cc/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•è®©æ·»åŠ å®šæ—¶ä½œä¸šä»»åŠ¡å˜å¾—æ›´åŠ ä¼˜é›…</title>
    <link href="https://blog.sctux.cc/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/"/>
    <id>https://blog.sctux.cc/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/</id>
    <published>2019-03-19T06:32:01.000Z</published>
    <updated>2025-09-01T01:59:08.973Z</updated>
    
    <content type="html"><![CDATA[<p> <img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/info.png"></p><h1 id="åº-APSCheduler-ç®€ä»‹"><a href="#åº-APSCheduler-ç®€ä»‹" class="headerlink" title="åº APSCheduler ç®€ä»‹"></a>åº APSCheduler ç®€ä»‹</h1><p>åœ¨å¹³å¸¸çš„å·¥ä½œä¸­æœ‰äº›å·¥ä½œéƒ½éœ€è¦å®šæ—¶ä»»åŠ¡æ¥æ¨åŠ¨ï¼Œä¾‹å¦‚é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªå®šæ—¶åˆ·æ–°æ’è¡Œæ¦œçš„ç¨‹åºè„šæœ¬ã€å®šæ—¶çˆ¬å‡ºç½‘ç«™çš„URLç¨‹åºã€å®šæ—¶æ£€æµ‹é’“é±¼ç½‘ç«™çš„ç¨‹åºç­‰ç­‰ï¼Œéƒ½æ¶‰åŠåˆ°äº†å…³äºå®šæ—¶ä»»åŠ¡çš„é—®é¢˜ï¼›è™½ç„¶è¿™äº›å®šæ—¶ä»»åŠ¡åœ¨æœåŠ¡å™¨ä¸Šé¢éƒ½èƒ½é€šè¿‡crontabæ¥åšï¼›å…¶æ¬¡æƒ³åˆ°çš„æ˜¯åˆ©ç”¨timeæ¨¡å—çš„time.sleep()æ–¹æ³•ä½¿ç¨‹åºä¼‘çœ æ¥è¾¾åˆ°å®šæ—¶ä»»åŠ¡çš„ç›®çš„ï¼Œè™½ç„¶å‰ä¸¤è€…ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æ€»è§‰å¾—ä¸æ˜¯é‚£ä¹ˆçš„ä¸“ä¸šï¼ŒğŸ˜æ‰€ä»¥å°±æ‰¾åˆ°äº†pythonçš„å®šæ—¶ä»»åŠ¡æ¨¡å—APScheduler;</p><p><strong>APScheduleråŸºäºQuartzçš„ä¸€ä¸ªPythonå®šæ—¶ä»»åŠ¡æ¡†æ¶ï¼Œå®ç°äº†Quartzçš„æ‰€æœ‰åŠŸèƒ½ï¼Œä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ã€‚æä¾›äº†åŸºäºæ—¥æœŸã€å›ºå®šæ—¶é—´é—´éš”ä»¥åŠcrontabç±»å‹çš„ä»»åŠ¡ï¼Œå¹¶ä¸”å¯ä»¥æŒä¹…åŒ–ä»»åŠ¡ã€‚åŸºäºè¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ä¸€ä¸ªpythonå®šæ—¶ä»»åŠ¡ç³»ç»Ÿã€‚</strong></p><p>åŒæ—¶APSchedulerè¿˜æä¾›äº†Flaskçš„æ‰©å±•<code>Flask-Apscheduler</code>, é‚£æ­£å¥½å°±å¯ä»¥æ‹¿æ¥åšä¸€ä¸ªé›†æˆå®šæ—¶ä»»åŠ¡å¹³å°;</p><p><img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/liuchengtu.png" alt="APSchedulerå·¥ä½œåŸç†"></p><h1 id="APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†"><a href="#APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†" class="headerlink" title="APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†"></a>APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†</h1><ol><li><p><code>è§¦å‘å™¨(trigger)</code>åŒ…å«è°ƒåº¦é€»è¾‘ï¼Œæ¯ä¸€ä¸ªä½œä¸šæœ‰å®ƒè‡ªå·±çš„è§¦å‘å™¨ï¼Œç”¨äºå†³å®šæ¥ä¸‹æ¥å“ªä¸€ä¸ªä½œä¸šä¼šè¿è¡Œã€‚é™¤äº†ä»–ä»¬è‡ªå·±åˆå§‹é…ç½®æ„å¤–ï¼Œè§¦å‘å™¨å®Œå…¨æ˜¯æ— çŠ¶æ€çš„ã€‚</p> <figure class="highlight livecodeserver"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cron: ç±»linuxä¸‹çš„crontabæ ¼å¼,å±äºå®šæ—¶è°ƒåº¦</span><br><span class="line">interval:æ¯éš”å¤šä¹…è°ƒåº¦ä¸€æ¬¡</span><br><span class="line"><span class="built_in">date</span>:ä¸€æ¬¡æ€§è°ƒåº¦</span><br><span class="line"></span><br><span class="line"><span class="comment">#1. croné£æ ¼</span></span><br><span class="line">(int|str) è¡¨ç¤ºå‚æ•°æ—¢å¯ä»¥æ˜¯intç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯strç±»å‹</span><br><span class="line">(datetime | str) è¡¨ç¤ºå‚æ•°æ—¢å¯ä»¥æ˜¯datetimeç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯strç±»å‹</span><br><span class="line">year (int|str) â€“ <span class="number">4</span>-digit year -ï¼ˆè¡¨ç¤ºå››ä½æ•°çš„å¹´ä»½ï¼Œå¦‚<span class="number">2008</span>å¹´ï¼‰</span><br><span class="line">month (int|str) â€“ month (<span class="number">1</span><span class="number">-12</span>) -ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º<span class="number">1</span><span class="number">-12</span>æœˆï¼‰</span><br><span class="line">day (int|str) â€“ day <span class="keyword">of</span> <span class="keyword">the</span> (<span class="number">1</span><span class="number">-31</span>) -ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º<span class="number">1</span><span class="number">-31</span>æ—¥ï¼‰</span><br><span class="line">week (int|str) â€“ ISO week (<span class="number">1</span><span class="number">-53</span>) -ï¼ˆæ ¼é‡Œå†<span class="number">2006</span>å¹´<span class="number">12</span>æœˆ<span class="number">31</span>æ—¥å¯ä»¥å†™æˆ<span class="number">2006</span>å¹´-W52<span class="number">-7</span>ï¼ˆæ‰©å±•å½¢å¼ï¼‰æˆ–<span class="number">2006</span>W527ï¼ˆç´§å‡‘å½¢å¼ï¼‰ï¼‰</span><br><span class="line">day_of_week (int|str) â€“ <span class="built_in">number</span> <span class="keyword">or</span> name <span class="keyword">of</span> weekday (<span class="number">0</span><span class="number">-6</span> <span class="keyword">or</span> mon,tue,wed,thu,fri,sat,sun) - ï¼ˆè¡¨ç¤ºä¸€å‘¨ä¸­çš„ç¬¬å‡ å¤©ï¼Œæ—¢å¯ä»¥ç”¨<span class="number">0</span><span class="number">-6</span>è¡¨ç¤ºä¹Ÿå¯ä»¥ç”¨å…¶è‹±è¯­ç¼©å†™è¡¨ç¤ºï¼‰</span><br><span class="line">hour (int|str) â€“ hour (<span class="number">0</span><span class="number">-23</span>) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º<span class="number">0</span><span class="number">-23</span>æ—¶ï¼‰</span><br><span class="line">minute (int|str) â€“ minute (<span class="number">0</span><span class="number">-59</span>) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º<span class="number">0</span><span class="number">-59</span>åˆ†ï¼‰</span><br><span class="line"><span class="keyword">second</span> (int|str) â€“ <span class="keyword">second</span> (<span class="number">0</span><span class="number">-59</span>) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º<span class="number">0</span><span class="number">-59</span>ç§’ï¼‰</span><br><span class="line">start_date (datetime|str) â€“ earliest possible <span class="built_in">date</span>/<span class="built_in">time</span> <span class="built_in">to</span> trigger <span class="keyword">on</span> (<span class="title">inclusive</span>) - ï¼ˆè¡¨ç¤ºå¼€å§‹æ—¶é—´ï¼‰</span><br><span class="line">end_date (datetime|str) â€“ latest possible <span class="built_in">date</span>/<span class="built_in">time</span> <span class="built_in">to</span> trigger <span class="keyword">on</span> (<span class="title">inclusive</span>) - ï¼ˆè¡¨ç¤ºç»“æŸæ—¶é—´ï¼‰</span><br><span class="line">timezone (datetime.tzinfo|str) â€“ <span class="built_in">time</span> zone <span class="built_in">to</span> use <span class="keyword">for</span> <span class="keyword">the</span> <span class="built_in">date</span>/<span class="built_in">time</span> calculations (defaults <span class="built_in">to</span> scheduler timezone) -ï¼ˆè¡¨ç¤ºæ—¶åŒºå–å€¼ï¼‰</span><br><span class="line"><span class="comment">#å¦‚:åœ¨6,7,8,11,12æœˆä»½çš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”çš„00:00,01:00,02:00,03:00 æ‰§è¡Œè¯¥ç¨‹åº</span></span><br><span class="line">sched.add_job(my_job, <span class="string">'cron'</span>, month=<span class="string">'6-8,11-12'</span>, day=<span class="string">'3rd fri'</span>, hour=<span class="string">'0-3'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.intervalé£æ ¼</span></span><br><span class="line">weeks (int) â€“ <span class="built_in">number</span> <span class="keyword">of</span> weeks <span class="built_in">to</span> <span class="built_in">wait</span></span><br><span class="line">days (int) â€“ <span class="built_in">number</span> <span class="keyword">of</span> days <span class="built_in">to</span> <span class="built_in">wait</span></span><br><span class="line">hours (int) â€“ <span class="built_in">number</span> <span class="keyword">of</span> hours <span class="built_in">to</span> <span class="built_in">wait</span></span><br><span class="line">minutes (int) â€“ <span class="built_in">number</span> <span class="keyword">of</span> minutes <span class="built_in">to</span> <span class="built_in">wait</span></span><br><span class="line"><span class="built_in">seconds</span> (int) â€“ <span class="built_in">number</span> <span class="keyword">of</span> <span class="built_in">seconds</span> <span class="built_in">to</span> <span class="built_in">wait</span></span><br><span class="line">start_date (datetime|str) â€“ starting point <span class="keyword">for</span> <span class="keyword">the</span> interval calculation</span><br><span class="line">end_date (datetime|str) â€“ latest possible <span class="built_in">date</span>/<span class="built_in">time</span> <span class="built_in">to</span> trigger <span class="keyword">on</span></span><br><span class="line">timezone (datetime.tzinfo|str) â€“ <span class="built_in">time</span> zone <span class="built_in">to</span> use <span class="keyword">for</span> <span class="keyword">the</span> <span class="built_in">date</span>/<span class="built_in">time</span> calculations</span><br><span class="line"><span class="comment">#å¦‚:æ¯éš”2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">scheduler.add_job(myfunc, <span class="string">'interval'</span>, minutes=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.dateé£æ ¼</span></span><br><span class="line">run_date (datetime|str) â€“ <span class="keyword">the</span> <span class="built_in">date</span>/<span class="built_in">time</span> <span class="built_in">to</span> run <span class="keyword">the</span> job <span class="keyword">at</span>  -ï¼ˆä»»åŠ¡å¼€å§‹çš„æ—¶é—´ï¼‰</span><br><span class="line">timezone (datetime.tzinfo|str) â€“ <span class="built_in">time</span> zone <span class="keyword">for</span> run_date <span class="keyword">if</span> <span class="keyword">it</span> doesnâ€™t have <span class="literal">one</span> already</span><br><span class="line"><span class="comment">#å¦‚:åœ¨2009å¹´11æœˆ6å·16æ—¶30åˆ†5ç§’æ—¶æ‰§è¡Œ</span></span><br><span class="line">sched.add_job(my_job, <span class="string">'date'</span>, run_date=datetime(<span class="number">2009</span>, <span class="number">11</span>, <span class="number">6</span>, <span class="number">16</span>, <span class="number">30</span>, <span class="number">5</span>), args=[<span class="string">'text'</span>])</span><br></pre></td></tr></tbody></table></figure></li><li><p><code>ä½œä¸šå­˜å‚¨(job store)</code>å­˜å‚¨è¢«è°ƒåº¦çš„ä½œä¸šï¼Œé»˜è®¤çš„ä½œä¸šå­˜å‚¨æ˜¯ç®€å•åœ°æŠŠä½œä¸šä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå…¶ä»–çš„ä½œä¸šå­˜å‚¨æ˜¯å°†ä½œä¸šä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚ä¸€ä¸ªä½œä¸šçš„æ•°æ®è®²åœ¨ä¿å­˜åœ¨æŒä¹…åŒ–ä½œä¸šå­˜å‚¨æ—¶è¢«åºåˆ—åŒ–ï¼Œå¹¶åœ¨åŠ è½½æ—¶è¢«ååºåˆ—åŒ–ã€‚è°ƒåº¦å™¨ä¸èƒ½åˆ†äº«åŒä¸€ä¸ªä½œä¸šå­˜å‚¨ã€‚</p><p> jobstoreåˆ™æ˜¯æŒ‡çš„æ˜¯jobæŒä¹…åŒ–,é»˜è®¤jobè¿è¡Œåœ¨å†…å­˜ä¸­,å¯æŒä¹…åŒ–åœ¨æ•°æ®åº“,æŒ‡å®šä¸ºmongoçš„MongoDBJobStoreæˆ–è€…æ˜¯ä½¿ç”¨sqliteçš„SQLAlchemyJobStore,åŒæ—¶å¯æŒ‡å®šå¤šç§jobstore</p></li><li><p><code>æ‰§è¡Œå™¨(executor)</code>å¤„ç†ä½œä¸šçš„è¿è¡Œï¼Œä»–ä»¬é€šå¸¸é€šè¿‡åœ¨ä½œä¸šä¸­æäº¤åˆ¶å®šçš„å¯è°ƒç”¨å¯¹è±¡åˆ°ä¸€ä¸ªçº¿ç¨‹æˆ–è€…è¿›åŸæ± æ¥è¿›è¡Œã€‚å½“ä½œä¸šå®Œæˆæ—¶ï¼Œæ‰§è¡Œå™¨å°†ä¼šé€šçŸ¥è°ƒåº¦å™¨ã€‚</p><p> è¯´ç™½äº†å°±æ˜¯æŒ‡å®šä»»åŠ¡æ˜¯ä»¥çº¿ç¨‹æ± /è¿›ç¨‹æ± é‡Œè¿è¡Œ,è¿™åœ¨åˆå§‹åŒ–æ—¶å¯ä»¥æŒ‡å®š,åŒæ—¶å¯ä»¥æŒ‡å®šæœ€å¤§çš„å·¥ä½œæ± ,é»˜è®¤çš„ä¸ºdefault: ThreadPoolExecutor,max-workerä¸º20,å½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šä¸ºprocesspool,é»˜è®¤max-workerä¸º5</p></li><li><p><code>è°ƒåº¦å™¨(scheduler)</code>æ˜¯å…¶ä»–çš„ç»„æˆéƒ¨åˆ†ã€‚ä½ é€šå¸¸åœ¨åº”ç”¨åªæœ‰ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œåº”ç”¨çš„å¼€å‘è€…é€šå¸¸ä¸ä¼šç›´æ¥å¤„ç†ä½œä¸šå­˜å‚¨ã€è°ƒåº¦å™¨å’Œè§¦å‘å™¨ï¼Œç›¸åï¼Œè°ƒåº¦å™¨æä¾›äº†å¤„ç†è¿™äº›çš„åˆé€‚çš„æ¥å£ã€‚é…ç½®ä½œä¸šå­˜å‚¨å’Œæ‰§è¡Œå™¨å¯ä»¥åœ¨è°ƒåº¦å™¨ä¸­å®Œæˆï¼Œä¾‹å¦‚æ·»åŠ ã€ä¿®æ”¹å’Œç§»é™¤ä½œä¸šã€‚<br>è°ƒåº¦å™¨åˆ†ä¸ºä»¥ä¸‹å‡ ç§,å¯æ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯é€‰ç”¨ä¸åŒçš„è°ƒåº¦å™¨:</p> <figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">BlockingScheduler:</span> å¾ˆæ˜æ˜¾è¿™æ˜¯ç§é˜»å¡å‹,ä¸€èˆ¬ç”¨åœ¨æ²¡æœ‰å…¶å®ƒè¿›ç¨‹è¿è¡Œçš„åœºæ™¯ä¸‹</span><br><span class="line"><span class="symbol">BackGroundScheduler:</span> åå°å¼,ä¹Ÿå°±æ˜¯å•èµ·ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹è¿è¡Œè¯¥ä»»åŠ¡,ä¸å½±å“ä¸»ç¨‹åº</span><br><span class="line"><span class="symbol">ASyncIOScheduler:</span></span><br><span class="line"><span class="symbol">GeventScheduler:</span></span><br><span class="line"><span class="symbol">TornadoScheduler:</span></span><br><span class="line"><span class="symbol">TwistedScheduler:</span></span><br><span class="line"><span class="symbol">QtScheduler:</span></span><br></pre></td></tr></tbody></table></figure><p> æœ¬äººåªä½¿ç”¨è¿‡BlockingSchedulerè·ŸBackGroundScheduler,flask-schedulerä½¿ç”¨çš„å³ä¸ºBackGroundScheduler,å…¶å®ƒçš„åç»­å†ç ”ç©¶ç ”ç©¶<br> é€‰æ‹©ç±»å‹ä¹Ÿå¾ˆç®€å•,åˆå§‹åŒ–æ—¶ç›´æ¥å®ä¾‹åŒ–:</p> <figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from apscheduler.<span class="keyword">schedulers.background </span>import <span class="keyword">BackgroundScheduler</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">scheduler </span>= <span class="keyword">BackgroundScheduler()</span></span><br><span class="line"><span class="keyword"></span><span class="comment">#å¯åŠ¨</span></span><br><span class="line"><span class="keyword">scheduler.start()</span></span><br></pre></td></tr></tbody></table></figure></li></ol><p>ä»¥ä¸Šå°±æ˜¯apschedulerä¸»è¦ç»„æˆçš„å››ä¸ªæ–¹é¢ã€‚é‚£ä¹ˆæ—¢ç„¶æœ‰æä¾›flask-apschedulerè¿™ä¸ªæ‰©å±•ï¼Œé‚£ä¸€å®šæ˜¯æŠŠapschedulerå°è£…è¿‡åä¸ºæˆ‘ä»¬æä¾›æ›´åŠ æ–¹ä¾¿çš„é›†æˆå¼€å‘ï¼Œè¿™é‡Œæˆ‘çš„å­˜å‚¨é€‰æ‹©äº†MySQLä½œä¸ºä½œä¸šä»»åŠ¡å­˜å‚¨ï¼Œå› ä¸ºæˆ‘è¿™é‡Œçš„å¹³å°çš„ç”¨æˆ·æ˜¯ç”¨å®ƒæ¥å­˜å‚¨çš„ï¼›ä¸ºäº†æ–¹ä¾¿ç»Ÿä¸€ä½¿ç”¨äº†MySQL;</p><hr><p>ä»¥ä¸‹æ˜¯è¿™ä¸ªé¡¹ç›®çš„ç»“æ„:</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="symbol">/data/study/github_repo/JobCenter</span> $ tree <span class="operator">-</span>L <span class="number">2</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ Pipfile</span><br><span class="line">â”œâ”€â”€ Pipfile.lock</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ app</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ auth<span class="symbol">/</span>  <span class="comment"># å¹³å°ç™»å½•ç›¸å…³</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ commands.py</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ config.py  <span class="comment"># å¹³å°é…ç½®ç›¸å…³</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ decorators.py</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ email.py  <span class="comment"># é‚®ä»¶å‘é€</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ extensions.py</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ job<span class="symbol">/</span>  <span class="comment"># å®šæ—¶ä»»åŠ¡ä¸»è¦æ¨¡å—</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ main<span class="symbol">/</span>  <span class="comment"># ä¸»è¦ç”¨äºè·¯ç”±</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ models.py  <span class="comment"># æ•°æ®æ¨¡å‹</span></span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ static</span><br><span class="line">â”‚&nbsp;&nbsp; â”œâ”€â”€ templates</span><br><span class="line">â””â”€â”€ test.py       </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ç›®å‰ä¸»è¦å®ç°çš„åŠŸèƒ½æœ‰:</p><ul><li>å¯è§†åŒ–ç•Œé¢æ“ä½œ</li><li>å®šæ—¶ä»»åŠ¡ç»Ÿä¸€ç®¡ç†</li><li>å®Œå…¨å…¼å®¹Crontab</li><li>æ”¯æŒç§’çº§å®šæ—¶ä»»åŠ¡</li><li>ä½œä¸šä»»åŠ¡å¯æœç´¢ã€æš‚åœã€ç¼–è¾‘ã€åˆ é™¤</li><li>ä½œä¸šä»»åŠ¡æŒä¹…åŒ–å­˜å‚¨ã€ä¸‰ç§ä¸åŒè§¦å‘å™¨ç±»å‹ä½œä¸šåŠ¨æ€æ·»åŠ </li></ul><hr><p><img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/login.png" alt="æ¸…çˆ½çš„ç™»å½•ç•Œé¢"></p><p><img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/pausejob.png" alt="ä»»åŠ¡åˆ—è¡¨ä¸­æš‚åœã€æ¢å¤å·²æ·»åŠ ä»»åŠ¡"></p><p><img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/addjob.png" alt="é’ˆå¯¹ä¸åŒè§¦å‘å™¨åŠ¨æ€å¢åŠ ä»»åŠ¡"></p><p><img src="/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/stdout.png" alt="ä»»åŠ¡æ‰§è¡Œè¾“å‡ºæ—¥å¿—æŒä¹…åŒ–å­˜æ”¾å¹¶å±•ç¤º"></p><p>æ¬¢è¿star æ¬¢è¿æå»ºè®®~<br>é¡¹ç›®åœ°å€: <a href="https://github.com/guomaoqiu/JobCenter">https://github.com/guomaoqiu/JobCenter</a><br>Demoåœ°å€: <a href="https://jobcenter.sctux.cc/">https://jobcenter.sctux.cc</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt; &lt;img src=&quot;/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/info.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;åº-APSCheduler-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#åº-APSCheduler-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;åº APSCheduler ç®€ä»‹&quot;&gt;&lt;/a&gt;åº APSCheduler ç®€ä»‹&lt;/h1&gt;&lt;p&gt;åœ¨å¹³å¸¸çš„å·¥ä½œä¸­æœ‰äº›å·¥ä½œéƒ½éœ€è¦å®šæ—¶ä»»åŠ¡æ¥æ¨åŠ¨ï¼Œä¾‹å¦‚é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªå®šæ—¶åˆ·æ–°æ’è¡Œæ¦œçš„ç¨‹åºè„šæœ¬ã€å®šæ—¶çˆ¬å‡ºç½‘ç«™çš„URLç¨‹åºã€å®šæ—¶æ£€æµ‹é’“é±¼ç½‘ç«™çš„ç¨‹åºç­‰ç­‰ï¼Œéƒ½æ¶‰åŠåˆ°äº†å…³äºå®šæ—¶ä»»åŠ¡çš„é—®é¢˜ï¼›è™½ç„¶è¿™äº›å®šæ—¶ä»»åŠ¡åœ¨æœåŠ¡å™¨ä¸Šé¢éƒ½èƒ½é€šè¿‡crontabæ¥åšï¼›å…¶æ¬¡æƒ³åˆ°çš„æ˜¯åˆ©ç”¨timeæ¨¡å—çš„time.sleep()æ–¹æ³•ä½¿ç¨‹åºä¼‘çœ æ¥è¾¾åˆ°å®šæ—¶ä»»åŠ¡çš„ç›®çš„ï¼Œè™½ç„¶å‰ä¸¤è€…ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æ€»è§‰å¾—ä¸æ˜¯é‚£ä¹ˆçš„ä¸“ä¸šï¼ŒğŸ˜æ‰€ä»¥å°±æ‰¾åˆ°äº†pythonçš„å®šæ—¶ä»»åŠ¡æ¨¡å—APScheduler;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;APScheduleråŸºäºQuartzçš„ä¸€ä¸ªPythonå®šæ—¶ä»»åŠ¡æ¡†æ¶ï¼Œå®ç°äº†Quartzçš„æ‰€æœ‰åŠŸèƒ½ï¼Œä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ã€‚æä¾›äº†åŸºäºæ—¥æœŸã€å›ºå®šæ—¶é—´é—´éš”ä»¥åŠcrontabç±»å‹çš„ä»»åŠ¡ï¼Œå¹¶ä¸”å¯ä»¥æŒä¹…åŒ–ä»»åŠ¡ã€‚åŸºäºè¿™äº›åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ä¸€ä¸ªpythonå®šæ—¶ä»»åŠ¡ç³»ç»Ÿã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åŒæ—¶APSchedulerè¿˜æä¾›äº†Flaskçš„æ‰©å±•&lt;code&gt;Flask-Apscheduler&lt;/code&gt;, é‚£æ­£å¥½å°±å¯ä»¥æ‹¿æ¥åšä¸€ä¸ªé›†æˆå®šæ—¶ä»»åŠ¡å¹³å°;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2019/03/19/Flask%E7%BB%93%E5%90%88APScheduler%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%B9%B3%E5%8F%B0/liuchengtu.png&quot; alt=&quot;APSchedulerå·¥ä½œåŸç†&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†&quot;&gt;&lt;a href=&quot;#APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†&quot; class=&quot;headerlink&quot; title=&quot;APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†&quot;&gt;&lt;/a&gt;APScheduleræœ‰å››ä¸ªç»„æˆéƒ¨åˆ†&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;è§¦å‘å™¨(trigger)&lt;/code&gt;åŒ…å«è°ƒåº¦é€»è¾‘ï¼Œæ¯ä¸€ä¸ªä½œä¸šæœ‰å®ƒè‡ªå·±çš„è§¦å‘å™¨ï¼Œç”¨äºå†³å®šæ¥ä¸‹æ¥å“ªä¸€ä¸ªä½œä¸šä¼šè¿è¡Œã€‚é™¤äº†ä»–ä»¬è‡ªå·±åˆå§‹é…ç½®æ„å¤–ï¼Œè§¦å‘å™¨å®Œå…¨æ˜¯æ— çŠ¶æ€çš„ã€‚&lt;/p&gt;
 &lt;figure class=&quot;highlight livecodeserver&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cron: ç±»linuxä¸‹çš„crontabæ ¼å¼,å±äºå®šæ—¶è°ƒåº¦&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;interval:æ¯éš”å¤šä¹…è°ƒåº¦ä¸€æ¬¡&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;date&lt;/span&gt;:ä¸€æ¬¡æ€§è°ƒåº¦&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#1. croné£æ ¼&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(int|str) è¡¨ç¤ºå‚æ•°æ—¢å¯ä»¥æ˜¯intç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯strç±»å‹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(datetime | str) è¡¨ç¤ºå‚æ•°æ—¢å¯ä»¥æ˜¯datetimeç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯strç±»å‹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;year (int|str) â€“ &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;-digit year -ï¼ˆè¡¨ç¤ºå››ä½æ•°çš„å¹´ä»½ï¼Œå¦‚&lt;span class=&quot;number&quot;&gt;2008&lt;/span&gt;å¹´ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;month (int|str) â€“ month (&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-12&lt;/span&gt;) -ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-12&lt;/span&gt;æœˆï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;day (int|str) â€“ day &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; (&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-31&lt;/span&gt;) -ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-31&lt;/span&gt;æ—¥ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;week (int|str) â€“ ISO week (&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-53&lt;/span&gt;) -ï¼ˆæ ¼é‡Œå†&lt;span class=&quot;number&quot;&gt;2006&lt;/span&gt;å¹´&lt;span class=&quot;number&quot;&gt;12&lt;/span&gt;æœˆ&lt;span class=&quot;number&quot;&gt;31&lt;/span&gt;æ—¥å¯ä»¥å†™æˆ&lt;span class=&quot;number&quot;&gt;2006&lt;/span&gt;å¹´-W52&lt;span class=&quot;number&quot;&gt;-7&lt;/span&gt;ï¼ˆæ‰©å±•å½¢å¼ï¼‰æˆ–&lt;span class=&quot;number&quot;&gt;2006&lt;/span&gt;W527ï¼ˆç´§å‡‘å½¢å¼ï¼‰ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;day_of_week (int|str) â€“ &lt;span class=&quot;built_in&quot;&gt;number&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; name &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; weekday (&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-6&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;or&lt;/span&gt; mon,tue,wed,thu,fri,sat,sun) - ï¼ˆè¡¨ç¤ºä¸€å‘¨ä¸­çš„ç¬¬å‡ å¤©ï¼Œæ—¢å¯ä»¥ç”¨&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-6&lt;/span&gt;è¡¨ç¤ºä¹Ÿå¯ä»¥ç”¨å…¶è‹±è¯­ç¼©å†™è¡¨ç¤ºï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;hour (int|str) â€“ hour (&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-23&lt;/span&gt;) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-23&lt;/span&gt;æ—¶ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;minute (int|str) â€“ minute (&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-59&lt;/span&gt;) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-59&lt;/span&gt;åˆ†ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;second&lt;/span&gt; (int|str) â€“ &lt;span class=&quot;keyword&quot;&gt;second&lt;/span&gt; (&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-59&lt;/span&gt;) - ï¼ˆè¡¨ç¤ºå–å€¼èŒƒå›´ä¸º&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-59&lt;/span&gt;ç§’ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;start_date (datetime|str) â€“ earliest possible &lt;span class=&quot;built_in&quot;&gt;date&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;time&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; trigger &lt;span class=&quot;keyword&quot;&gt;on&lt;/span&gt; (&lt;span class=&quot;title&quot;&gt;inclusive&lt;/span&gt;) - ï¼ˆè¡¨ç¤ºå¼€å§‹æ—¶é—´ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;end_date (datetime|str) â€“ latest possible &lt;span class=&quot;built_in&quot;&gt;date&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;time&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; trigger &lt;span class=&quot;keyword&quot;&gt;on&lt;/span&gt; (&lt;span class=&quot;title&quot;&gt;inclusive&lt;/span&gt;) - ï¼ˆè¡¨ç¤ºç»“æŸæ—¶é—´ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;timezone (datetime.tzinfo|str) â€“ &lt;span class=&quot;built_in&quot;&gt;time&lt;/span&gt; zone &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; use &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;date&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;time&lt;/span&gt; calculations (defaults &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; scheduler timezone) -ï¼ˆè¡¨ç¤ºæ—¶åŒºå–å€¼ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#å¦‚:åœ¨6,7,8,11,12æœˆä»½çš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”çš„00:00,01:00,02:00,03:00 æ‰§è¡Œè¯¥ç¨‹åº&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sched.add_job(my_job, &lt;span class=&quot;string&quot;&gt;&#39;cron&#39;&lt;/span&gt;, month=&lt;span class=&quot;string&quot;&gt;&#39;6-8,11-12&#39;&lt;/span&gt;, day=&lt;span class=&quot;string&quot;&gt;&#39;3rd fri&#39;&lt;/span&gt;, hour=&lt;span class=&quot;string&quot;&gt;&#39;0-3&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#2.intervalé£æ ¼&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;weeks (int) â€“ &lt;span class=&quot;built_in&quot;&gt;number&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; weeks &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;wait&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;days (int) â€“ &lt;span class=&quot;built_in&quot;&gt;number&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; days &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;wait&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;hours (int) â€“ &lt;span class=&quot;built_in&quot;&gt;number&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; hours &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;wait&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;minutes (int) â€“ &lt;span class=&quot;built_in&quot;&gt;number&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; minutes &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;wait&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;seconds&lt;/span&gt; (int) â€“ &lt;span class=&quot;built_in&quot;&gt;number&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;seconds&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;wait&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;start_date (datetime|str) â€“ starting point &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; interval calculation&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;end_date (datetime|str) â€“ latest possible &lt;span class=&quot;built_in&quot;&gt;date&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;time&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; trigger &lt;span class=&quot;keyword&quot;&gt;on&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;timezone (datetime.tzinfo|str) â€“ &lt;span class=&quot;built_in&quot;&gt;time&lt;/span&gt; zone &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; use &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;date&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;time&lt;/span&gt; calculations&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#å¦‚:æ¯éš”2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;scheduler.add_job(myfunc, &lt;span class=&quot;string&quot;&gt;&#39;interval&#39;&lt;/span&gt;, minutes=&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#3.dateé£æ ¼&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;run_date (datetime|str) â€“ &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;date&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;time&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;to&lt;/span&gt; run &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; job &lt;span class=&quot;keyword&quot;&gt;at&lt;/span&gt;  -ï¼ˆä»»åŠ¡å¼€å§‹çš„æ—¶é—´ï¼‰&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;timezone (datetime.tzinfo|str) â€“ &lt;span class=&quot;built_in&quot;&gt;time&lt;/span&gt; zone &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; run_date &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;it&lt;/span&gt; doesnâ€™t have &lt;span class=&quot;literal&quot;&gt;one&lt;/span&gt; already&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#å¦‚:åœ¨2009å¹´11æœˆ6å·16æ—¶30åˆ†5ç§’æ—¶æ‰§è¡Œ&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sched.add_job(my_job, &lt;span class=&quot;string&quot;&gt;&#39;date&#39;&lt;/span&gt;, run_date=datetime(&lt;span class=&quot;number&quot;&gt;2009&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;), args=[&lt;span class=&quot;string&quot;&gt;&#39;text&#39;&lt;/span&gt;])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;ä½œä¸šå­˜å‚¨(job store)&lt;/code&gt;å­˜å‚¨è¢«è°ƒåº¦çš„ä½œä¸šï¼Œé»˜è®¤çš„ä½œä¸šå­˜å‚¨æ˜¯ç®€å•åœ°æŠŠä½œä¸šä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå…¶ä»–çš„ä½œä¸šå­˜å‚¨æ˜¯å°†ä½œä¸šä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚ä¸€ä¸ªä½œä¸šçš„æ•°æ®è®²åœ¨ä¿å­˜åœ¨æŒä¹…åŒ–ä½œä¸šå­˜å‚¨æ—¶è¢«åºåˆ—åŒ–ï¼Œå¹¶åœ¨åŠ è½½æ—¶è¢«ååºåˆ—åŒ–ã€‚è°ƒåº¦å™¨ä¸èƒ½åˆ†äº«åŒä¸€ä¸ªä½œä¸šå­˜å‚¨ã€‚&lt;/p&gt;
&lt;p&gt; jobstoreåˆ™æ˜¯æŒ‡çš„æ˜¯jobæŒä¹…åŒ–,é»˜è®¤jobè¿è¡Œåœ¨å†…å­˜ä¸­,å¯æŒä¹…åŒ–åœ¨æ•°æ®åº“,æŒ‡å®šä¸ºmongoçš„MongoDBJobStoreæˆ–è€…æ˜¯ä½¿ç”¨sqliteçš„SQLAlchemyJobStore,åŒæ—¶å¯æŒ‡å®šå¤šç§jobstore&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;æ‰§è¡Œå™¨(executor)&lt;/code&gt;å¤„ç†ä½œä¸šçš„è¿è¡Œï¼Œä»–ä»¬é€šå¸¸é€šè¿‡åœ¨ä½œä¸šä¸­æäº¤åˆ¶å®šçš„å¯è°ƒç”¨å¯¹è±¡åˆ°ä¸€ä¸ªçº¿ç¨‹æˆ–è€…è¿›åŸæ± æ¥è¿›è¡Œã€‚å½“ä½œä¸šå®Œæˆæ—¶ï¼Œæ‰§è¡Œå™¨å°†ä¼šé€šçŸ¥è°ƒåº¦å™¨ã€‚&lt;/p&gt;
&lt;p&gt; è¯´ç™½äº†å°±æ˜¯æŒ‡å®šä»»åŠ¡æ˜¯ä»¥çº¿ç¨‹æ± /è¿›ç¨‹æ± é‡Œè¿è¡Œ,è¿™åœ¨åˆå§‹åŒ–æ—¶å¯ä»¥æŒ‡å®š,åŒæ—¶å¯ä»¥æŒ‡å®šæœ€å¤§çš„å·¥ä½œæ± ,é»˜è®¤çš„ä¸ºdefault: ThreadPoolExecutor,max-workerä¸º20,å½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šä¸ºprocesspool,é»˜è®¤max-workerä¸º5&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;è°ƒåº¦å™¨(scheduler)&lt;/code&gt;æ˜¯å…¶ä»–çš„ç»„æˆéƒ¨åˆ†ã€‚ä½ é€šå¸¸åœ¨åº”ç”¨åªæœ‰ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œåº”ç”¨çš„å¼€å‘è€…é€šå¸¸ä¸ä¼šç›´æ¥å¤„ç†ä½œä¸šå­˜å‚¨ã€è°ƒåº¦å™¨å’Œè§¦å‘å™¨ï¼Œç›¸åï¼Œè°ƒåº¦å™¨æä¾›äº†å¤„ç†è¿™äº›çš„åˆé€‚çš„æ¥å£ã€‚é…ç½®ä½œä¸šå­˜å‚¨å’Œæ‰§è¡Œå™¨å¯ä»¥åœ¨è°ƒåº¦å™¨ä¸­å®Œæˆï¼Œä¾‹å¦‚æ·»åŠ ã€ä¿®æ”¹å’Œç§»é™¤ä½œä¸šã€‚&lt;br&gt;è°ƒåº¦å™¨åˆ†ä¸ºä»¥ä¸‹å‡ ç§,å¯æ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯é€‰ç”¨ä¸åŒçš„è°ƒåº¦å™¨:&lt;/p&gt;
 &lt;figure class=&quot;highlight avrasm&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;symbol&quot;&gt;BlockingScheduler:&lt;/span&gt; å¾ˆæ˜æ˜¾è¿™æ˜¯ç§é˜»å¡å‹,ä¸€èˆ¬ç”¨åœ¨æ²¡æœ‰å…¶å®ƒè¿›ç¨‹è¿è¡Œçš„åœºæ™¯ä¸‹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;symbol&quot;&gt;BackGroundScheduler:&lt;/span&gt; åå°å¼,ä¹Ÿå°±æ˜¯å•èµ·ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹è¿è¡Œè¯¥ä»»åŠ¡,ä¸å½±å“ä¸»ç¨‹åº&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;symbol&quot;&gt;ASyncIOScheduler:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;symbol&quot;&gt;GeventScheduler:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;symbol&quot;&gt;TornadoScheduler:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;symbol&quot;&gt;TwistedScheduler:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;symbol&quot;&gt;QtScheduler:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt; æœ¬äººåªä½¿ç”¨è¿‡BlockingSchedulerè·ŸBackGroundScheduler,flask-schedulerä½¿ç”¨çš„å³ä¸ºBackGroundScheduler,å…¶å®ƒçš„åç»­å†ç ”ç©¶ç ”ç©¶&lt;br&gt; é€‰æ‹©ç±»å‹ä¹Ÿå¾ˆç®€å•,åˆå§‹åŒ–æ—¶ç›´æ¥å®ä¾‹åŒ–:&lt;/p&gt;
 &lt;figure class=&quot;highlight mipsasm&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;from apscheduler.&lt;span class=&quot;keyword&quot;&gt;schedulers.background &lt;/span&gt;import &lt;span class=&quot;keyword&quot;&gt;BackgroundScheduler&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;&lt;/span&gt;&lt;span class=&quot;keyword&quot;&gt;scheduler &lt;/span&gt;= &lt;span class=&quot;keyword&quot;&gt;BackgroundScheduler()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;&lt;/span&gt;&lt;span class=&quot;comment&quot;&gt;#å¯åŠ¨&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;scheduler.start()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ä»¥ä¸Šå°±æ˜¯apschedulerä¸»è¦ç»„æˆçš„å››ä¸ªæ–¹é¢ã€‚é‚£ä¹ˆæ—¢ç„¶æœ‰æä¾›flask-apschedulerè¿™ä¸ªæ‰©å±•ï¼Œé‚£ä¸€å®šæ˜¯æŠŠapschedulerå°è£…è¿‡åä¸ºæˆ‘ä»¬æä¾›æ›´åŠ æ–¹ä¾¿çš„é›†æˆå¼€å‘ï¼Œè¿™é‡Œæˆ‘çš„å­˜å‚¨é€‰æ‹©äº†MySQLä½œä¸ºä½œä¸šä»»åŠ¡å­˜å‚¨ï¼Œå› ä¸ºæˆ‘è¿™é‡Œçš„å¹³å°çš„ç”¨æˆ·æ˜¯ç”¨å®ƒæ¥å­˜å‚¨çš„ï¼›ä¸ºäº†æ–¹ä¾¿ç»Ÿä¸€ä½¿ç”¨äº†MySQL;&lt;/p&gt;
&lt;hr&gt;</summary>
    
    
    
    <category term="å®šæ—¶ä»»åŠ¡" scheme="https://blog.sctux.cc/categories/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"/>
    
    
    <category term="Flask APScheduler" scheme="https://blog.sctux.cc/tags/Flask-APScheduler/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºHarboræ­å»ºä¼ä¸šçº§ç§æœ‰é•œåƒä»“åº“</title>
    <link href="https://blog.sctux.cc/2019/01/07/docker-harbor/"/>
    <id>https://blog.sctux.cc/2019/01/07/docker-harbor/</id>
    <published>2019-01-07T10:23:27.000Z</published>
    <updated>2025-09-01T01:59:08.881Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“"><a href="#åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“" class="headerlink" title="åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“"></a>åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“</h1><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>dockerä¸­è¦ä½¿ç”¨é•œåƒï¼Œä¸€èˆ¬ä¼šä»æœ¬åœ°ã€docker Hupå…¬å…±ä»“åº“å’Œå…¶å®ƒç¬¬ä¸‰æ–¹å…¬å…±ä»“åº“ä¸­ä¸‹è½½é•œåƒï¼Œä¸€èˆ¬å‡ºäºå®‰å…¨å’Œå¤–ç½‘(å¢™)èµ„æºä¸‹è½½é€Ÿç‡çš„åŸå› è€ƒè™‘ä¼ä¸šçº§ä¸Šä¸ä¼šè½»æ˜“ä½¿ç”¨ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§åŠæ³•å¯ä»¥å­˜å‚¨è‡ªå·±çš„é•œåƒåˆæœ‰å®‰å…¨è®¤è¯çš„ä»“åº“å‘¢? </p><pre><code>     â€”-&gt; ä¼ä¸šçº§ç¯å¢ƒä¸­åŸºäºHarboræ­å»ºè‡ªå·±çš„å®‰å…¨è®¤è¯ä»“åº“ã€‚</code></pre><p>Harboræ˜¯VMwareå…¬å¸æœ€è¿‘å¼€æºçš„ä¼ä¸šçº§Docker Registryé¡¹ç›®, å…¶ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·è¿…é€Ÿæ­å»ºä¸€ä¸ªä¼ä¸šçº§çš„Docker registryæœåŠ¡ã€‚</p><h2 id="å®‰è£…Harbor"><a href="#å®‰è£…Harbor" class="headerlink" title="å®‰è£…Harbor"></a>å®‰è£…Harbor</h2><p>harboréœ€è¦å®‰è£…dockerå’Œdocker-composeæ‰èƒ½ä½¿ç”¨ï¼Œå®‰è£…dockeræ­¥éª¤çœç•¥ï¼Œ</p><h3 id="å®‰è£…docker-dompose"><a href="#å®‰è£…docker-dompose" class="headerlink" title="å®‰è£…docker-dompose"></a>å®‰è£…docker-dompose</h3><p>docker-domposeå®‰è£…æ­¥éª¤å¦‚ä¸‹ï¼š </p><p>ä¸‹è½½æœ€æ–°ç‰ˆçš„docker-composeæ–‡ä»¶ </p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -L https:<span class="regexp">//gi</span>thub.com<span class="regexp">/docker/</span>compose<span class="regexp">/releases/</span>download<span class="regexp">/1.23.2/</span>docker-compose-$(uname -s)-$(uname -m) -o <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>docker-compose</span><br></pre></td></tr></tbody></table></figure><p>æ·»åŠ å¯æ‰§è¡Œæƒé™</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span></span><br></pre></td></tr></tbody></table></figure><p>éªŒè¯ç‰ˆæœ¬</p><figure class="highlight applescript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose -v</span><br><span class="line">docker-compose <span class="built_in">version</span> <span class="number">1.23</span><span class="number">.2</span>, build <span class="number">1110</span>ad01</span><br></pre></td></tr></tbody></table></figure><h3 id="è·å–Harborè½¯ä»¶åŒ…"><a href="#è·å–Harborè½¯ä»¶åŒ…" class="headerlink" title="è·å–Harborè½¯ä»¶åŒ…"></a>è·å–Harborè½¯ä»¶åŒ…</h3><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https</span>://storage.googleapis.com/harbor-releases/release-<span class="number">1</span>.<span class="number">7</span>.<span class="number">0</span>/harbor-offline-installer-v1.<span class="number">7</span>.<span class="number">1</span>.tgz</span><br></pre></td></tr></tbody></table></figure><p>è§£å‹</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tar</span> -xf harbor-offline-installer-v1.<span class="number">7</span>.<span class="number">1</span>.tgz -C /usr/local/</span><br></pre></td></tr></tbody></table></figure><p>ç¼–è¾‘é…ç½®æ–‡ä»¶</p><figure class="highlight makefile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/harbor</span><br><span class="line">$ vim harbor.cfg</span><br><span class="line">hostname = reg.for-k8s.com   <span class="comment"># æœ¬æœºå¤–ç½‘IPæˆ–åŸŸåï¼Œè¯¥åœ°å€ä¾›ç”¨æˆ·é€šè¿‡UIè¿›è¡Œè®¿é—®ï¼Œä¸è¦ä½¿ç”¨127.0.0.1</span></span><br><span class="line">ui_url_protocol = https             <span class="comment"># ç”¨æˆ·è®¿é—®ç§ä»“æ—¶ä½¿ç”¨çš„åè®®ï¼Œé»˜è®¤æ—¶httpï¼Œé…ç½®æˆhttps</span></span><br><span class="line">db_password = root123           ã€€ã€€ <span class="comment"># æŒ‡å®šmysqlæ•°æ®åº“ç®¡ç†å‘˜å¯†ç </span></span><br><span class="line">harbor_admin_passwordï¼šHarbor12345   <span class="comment"># harborçš„ç®¡ç†å‘˜è´¦æˆ·å¯†ç </span></span><br><span class="line">ssl_cert = /data/cert/reg.for-k8s.com.crt ã€€ã€€<span class="comment"># è®¾ç½®è¯ä¹¦æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">ssl_cert_key = /data/cert/reg.for-k8s.com.key  <span class="comment"># è®¾ç½®è¯ä¹¦å¯†é’¥æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶ä»–é…ç½®é€‰é¡¹æŒ‰éœ€å¡«å†™å³å¯</span></span><br></pre></td></tr></tbody></table></figure><h3 id="ç”Ÿæˆsslè¯ä¹¦"><a href="#ç”Ÿæˆsslè¯ä¹¦" class="headerlink" title="ç”Ÿæˆsslè¯ä¹¦"></a>ç”Ÿæˆsslè¯ä¹¦</h3><p>ç”Ÿæˆæ ¹è¯ä¹¦</p><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">cd</span> /dada/cert/</span><br><span class="line"></span><br><span class="line">$ openssl req  -newkey rs<span class="variable">a:4096</span> -nodes -<span class="built_in">sha256</span> -keyout <span class="keyword">ca</span>.key -x509 -days <span class="number">365</span> -out <span class="keyword">ca</span>.crt -subj <span class="string">"/C=CN/L=Shanghai/O=harbor/CN=harbor-registry"</span></span><br></pre></td></tr></tbody></table></figure><p>ç”Ÿæˆä¸€ä¸ªè¯ä¹¦ç­¾å, è®¾ç½®è®¿é—®åŸŸåä¸º reg.for-k8s.com</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -newkey rsa:<span class="number">4096</span> -nodes -sha256 -keyout reg<span class="selector-class">.for-k8s</span><span class="selector-class">.com</span><span class="selector-class">.key</span> -out server<span class="selector-class">.csr</span> -subj <span class="string">"/C=CN/L=Shanghai/O=harbor/CN=reg.for-k8s.com"</span></span><br></pre></td></tr></tbody></table></figure><p>ç”Ÿæˆä¸»æœºè¯ä¹¦</p><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -req -days 365 -<span class="keyword">in</span> server.csr -<span class="keyword">CA</span> <span class="keyword">ca</span>.crt -CAkey <span class="keyword">ca</span>.key -CAcreateserial -<span class="keyword">out</span> <span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.com.crt</span><br></pre></td></tr></tbody></table></figure><h3 id="é€šè¿‡è‡ªå¸¦è„šæœ¬ä¸€é”®å®‰è£…"><a href="#é€šè¿‡è‡ªå¸¦è„šæœ¬ä¸€é”®å®‰è£…" class="headerlink" title="é€šè¿‡è‡ªå¸¦è„šæœ¬ä¸€é”®å®‰è£…"></a>é€šè¿‡è‡ªå¸¦è„šæœ¬ä¸€é”®å®‰è£…</h3><figure class="highlight lasso"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/<span class="built_in">local</span>/harbor/</span><br><span class="line">./install.sh</span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line">âœ” ---<span class="params">-Harbor</span> has been installed <span class="literal">and</span> started successfully.----</span><br><span class="line"></span><br><span class="line">Now you should be able <span class="keyword">to</span> visit the admin <span class="keyword">portal</span> at https:<span class="comment">//reg.for-k8s.com.</span></span><br><span class="line">For more details, please visit https:<span class="comment">//github.com/goharbor/harbor .</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ç„¶åç»‘å®šhostsè®¿é—®å³å¯:<br><img src="/2019/01/07/docker-harbor/15468488877244.jpg"></p><p>é»˜è®¤è´¦å·å¯†ç <code>admin / Harbor12345</code><br><img src="/2019/01/07/docker-harbor/15468489958269.jpg"></p><p>ok é‚£ä¸Šé¢çš„ç§æœ‰ä»“åº“æœåŠ¡å·²ç»æ­å»ºå®Œæ¯•äº†ï¼Œè¯¥æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ</p><ol start="0"><li><p>é¦–å…ˆåœ¨harborä¸Šåˆ›å»ºä¸€ä¸ªé¡¹ç›®<code>myproject</code>(æˆ‘è¿™é‡Œä¸ä½¿ç”¨é»˜è®¤çš„libary)<br><img src="/2019/01/07/docker-harbor/15468494639235.jpg"><br>è¿™é‡Œæˆ‘é€‰æ‹©ç§æœ‰ä»“åº“, pull/pushéƒ½éœ€è¦åœ¨ä¸»æœºä¸Šé¢æ‰§è¡Œ<code>docker login</code>æ‰è¡Œ;</p></li><li><p>å½“æˆ‘é€šè¿‡Dockerfileæ„å»ºä¸€ä¸ªæ–°é•œåƒçš„æ—¶å€™, ç›´æ¥æŒ‡æ˜registryå’Œæ ‡ç­¾, æ¯”å¦‚:</p></li></ol><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t <span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mydocker-image:v1.<span class="number">0.1</span> .</span><br><span class="line">Sending build context <span class="keyword">to</span> Docker daemon  <span class="number">97.21</span>MB</span><br><span class="line">Step <span class="number">1</span>/<span class="number">12</span> : FROM  <span class="number">1</span>and1internet/ubuntu-<span class="number">16</span></span><br><span class="line"> ---&gt; dbf985f1f449</span><br><span class="line">Step <span class="number">2</span>/<span class="number">12</span> : MAINTAINER guomaoqiu &lt;guomaoqiu@gmail.<span class="keyword">com</span>&gt;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; <span class="number">598894333</span>db9</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">Successfully built b190966f3773</span><br><span class="line">Successfully tagged <span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mydocker-image:v1.<span class="number">0.1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ docker images | <span class="keyword">grep</span> myproject</span><br><span class="line"><span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mydocker-image  v1.<span class="number">0.1</span>   b190966f3773   <span class="number">44</span> seconds ago    <span class="number">482</span>MB</span><br></pre></td></tr></tbody></table></figure><ol start="2"><li>åŠ å…¥å½“ä½ ä»åˆ«å¤„è·å–çš„é•œåƒæƒ³ä¸Šä¼ åˆ°ç§æœ‰ä»“åº“å‘¢ï¼Ÿå°±æ˜¯æ‰“ä¸ªtagå°±è¡Œå•¦, æ¯”å¦‚æˆ‘æƒ³æŠŠä»å®˜ç½‘çš„è¿™ä¸ªnginxé•œåƒæ”¾åˆ°æˆ‘çš„ä»“åº“:</li></ol><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">tag</span> nginx <span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mynginx:latest</span><br><span class="line">$ docker images | <span class="keyword">grep</span> myproject</span><br><span class="line"><span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mydocker-image    v1.<span class="number">0.1</span> b190966f3773  <span class="number">2</span> minutes ago       <span class="number">482</span>MB</span><br><span class="line"><span class="keyword">reg</span>.<span class="keyword">for</span>-k8s.<span class="keyword">com</span>/myproject/mynginx           latest <span class="number">568</span>c4670fa80  <span class="number">5</span> weeks ago         <span class="number">109</span>MB</span><br></pre></td></tr></tbody></table></figure><ol start="3"><li>ç™»å½•ä»“åº“</li></ol><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ docker login -u admin -<span class="selector-tag">p</span> Harbor12345 reg<span class="selector-class">.for-k8s</span><span class="selector-class">.com</span></span><br><span class="line">Username: admin</span><br><span class="line">Password:</span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config<span class="selector-class">.json</span>.</span><br><span class="line">Configure <span class="selector-tag">a</span> credential helper to remove this warning. See</span><br><span class="line">https:<span class="comment">//docs.docker.com/engine/reference/commandline/login/#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><ol start="4"><li>æœ€åæŠŠæœ¬åœ°çš„é•œåƒpushåˆ°ä»“åº“<br>å½“æˆ‘æ‰§è¡Œè¿™ä¸ªçš„æ—¶å€™æŠ¥é”™äº†ï¼š</li></ol><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker push reg.for-k8s.com/myproject/mynginx:latest</span><br><span class="line"><span class="keyword">Error </span>response from daemon: Get https://reg.for-k8s.com/v2/: x509: certificate signed by unknown authority</span><br></pre></td></tr></tbody></table></figure><p>è§£å†³åŠæ³•å°±æ˜¯å¦‚æœä¸åœ¨å®¢æˆ·ç«¯éƒ¨ç½²è¯ä¹¦ï¼Œé‚£ä¹ˆåœ¨Dockerå¯åŠ¨æ—¶è®¾ç½®å‚æ•° â€œâ€“insecure-registry IP/ä»“åº“åŸŸåâ€,ç„¶åé‡è½½æœåŠ¡é‡å¯dockerè¿›ç¨‹ï¼›æ³¨æ„çš„æ˜¯æˆ‘è¿™é‡Œä½¿ç”¨çš„è¿™ä¸ªåŸŸåæ˜¯è‡ªå®šä¹‰çš„ï¼Œé‚£ä¹ˆéœ€è¦åœ¨éœ€è¦ä¸Šä¼ ä¸‹è½½é•œåƒçš„æœºå™¨ä¸Šï¼ŒåŒæ ·éœ€è¦ä¿®æ”¹dockerè¿›ç¨‹å‚æ•°ï¼Œå¹¶ä¸”ç»‘å®šhosts,å¦åˆ™å³ä½¿é…ç½®äº†å‚æ•°ï¼Œè¿™ä¸ªåŸŸåæ²¡æ³•è§£æä¹Ÿæ˜¯push/pullä¸åˆ°é•œåƒçš„ã€‚</p><ol start="5"><li>å†æ¬¡æ‰§è¡Œpushæ“ä½œ:</li></ol><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ docker push reg.for-k8s.com<span class="operator">/</span>myproject<span class="operator">/</span>mynginx:latest</span><br><span class="line">The push refers to repository [reg.for-k8s.com<span class="operator">/</span>myproject<span class="operator">/</span>mynginx]</span><br><span class="line"><span class="params">b7efe781401d:</span> Pushed</span><br><span class="line"><span class="params">c9c2a3696080:</span> Pushed</span><br><span class="line"><span class="number">7</span><span class="params">b4e562e58dc:</span> Pushed</span><br><span class="line"><span class="params">latest:</span> <span class="params">digest:</span> sha256:e2847e35d4e0e2d459a7696538cbfea42ea2d3b8a1ee8329ba7e68694950afd3 <span class="params">size:</span> <span class="number">948</span></span><br><span class="line"></span><br><span class="line">$ [root@k8s-m1 kubectl-terminal-ubuntu]<span class="comment"># docker push reg.for-k8s.com/myproject/mydocker-image:v1.0.1</span></span><br><span class="line">The push refers to repository [reg.for-k8s.com<span class="operator">/</span>myproject<span class="operator">/</span>mydocker-image]</span><br><span class="line"><span class="number">96</span><span class="params">dca48ee72c:</span> Pushed</span><br><span class="line"><span class="params">fa879b69764c:</span> Pushed</span><br><span class="line"><span class="number">4</span><span class="params">d823b00e6b7:</span> Pushed</span><br><span class="line"><span class="number">6</span><span class="params">bf6e96da4a0:</span> Pushed</span><br><span class="line"><span class="params">eedda540c6a8:</span> Pushed</span><br><span class="line"><span class="params">f2a971e53afa:</span> Pushed</span><br><span class="line"><span class="number">3</span><span class="params">ee1a3b3fd18:</span> Pushed</span><br><span class="line"><span class="number">8</span><span class="params">a225cfa6dea:</span> Pushed</span><br><span class="line"><span class="number">428</span><span class="params">c1ba11354:</span> Pushed</span><br><span class="line"><span class="params">b097f5edab7b:</span> Pushed</span><br><span class="line"><span class="number">27712</span><span class="params">caf4371:</span> Pushed</span><br><span class="line"><span class="number">8241</span><span class="params">afc74c6f:</span> Pushed</span><br><span class="line">v1.<span class="number">0.1</span>: <span class="params">digest:</span> sha256:a20629f62d73cff93bf73b31958878a1d76c2dd42e36ebb2cb6d0ac294a46da7 <span class="params">size:</span> <span class="number">2826</span></span><br></pre></td></tr></tbody></table></figure><p><img src="/2019/01/07/docker-harbor/15468535525128.jpg"></p><p>ä»¥ä¸ŠpushæˆåŠŸï¼›</p><p>æµ‹è¯•pull<br>é‚£ä¸ºäº†æµ‹è¯•pullå¹¶ä¸”èƒ½æˆåŠŸè¿è¡Œï¼Œæˆ‘è¿™é‡Œé€šè¿‡kuernetesè¿è¡Œä¸€ä¸ªDaemonSetï¼Œé•œåƒé‡‡ç”¨: <code>mynginx</code> ,å¹¶ä¸”è®¾ç½®é•œåƒpullç­–ç•¥ä¸º<code>Always</code>, ç„¶ååˆ›å»ºä¸€ä¸ªæœåŠ¡åœ¨é›†ç¾¤å†…éƒ¨é€šè¿‡ClusterIPèƒ½å¤Ÿè®¿é—®, yamlå¦‚ä¸‹:</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">&gt;&gt;</span> <span class="string">test.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mynginx-service</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">reg.for-k8s.com/myproject/mynginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span>  <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">daemonset.yaml</span></span><br><span class="line"><span class="string">service/mynginx-service</span> <span class="string">created</span></span><br><span class="line"><span class="string">daemonset.extensions/mynginx</span> <span class="string">create</span></span><br></pre></td></tr></tbody></table></figure><p>ç”±äºæˆ‘åˆšæ‰åˆ›å»ºä»“åº“çš„æ—¶å€™è®¾ç½®çš„ä»“åº“éšç§æ€§ä¸ºç§æœ‰çš„<br>éœ€è¦docker login ç™»å½•æˆåŠŸä¹‹åï¼Œk8s kubectl create å°±æ‹‰å–ä¸äº†é•œåƒï¼›<br>å¦‚æœè®¾ç½®ä¸ºå…¬å¼€ï¼Œé‚£ä¹ˆä¹…ä¸éœ€è¦é…ç½®è¿™ä¸€æ­¥éª¤ã€‚åªéœ€è¦docker login ç™»å½•æˆåŠŸä¹‹åï¼Œk8s kubectl create å°±å¯ä»¥æ‹‰å–é•œåƒ; ä½†æ˜¯æˆ‘ä¸æƒ³è®©å…¶ä¸ºå…¬å¼€çš„ï¼›æ‰€ä»¥è¿˜éœ€è¦é…ç½®å¦‚ä¸‹æ­¥éª¤ï¼š</p><p>é…ç½®ä¸€ä¸ªç§æœ‰ä»“åº“harborçš„secretï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create<span class="built_in"> secret </span>docker-registry registry-secret <span class="attribute">--namespace</span>=default \</span><br><span class="line"><span class="attribute">--docker-server</span>=https://reg.for-k8s.com <span class="attribute">--docker-username</span>=admin \</span><br><span class="line"><span class="attribute">--docker-password</span>=Harbor12345</span><br></pre></td></tr></tbody></table></figure><p>éƒ¨ç½²æ—¶æŒ‡å®šimagePullSecrets, ä¿®æ”¹åœ¨ä¸Šé¢çš„yamlä¸­æ·»åŠ è¿™ä¸ªé€‰é¡¹:</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">&gt;&gt;</span> <span class="string">test.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mynginx-service</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">mynginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">reg.for-k8s.com/myproject/mynginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mynginx</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">registry-secret</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span>  <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">daemonset.yaml</span></span><br><span class="line"><span class="string">service/mynginx-service</span> <span class="string">created</span></span><br><span class="line"><span class="string">daemonset.extensions/mynginx</span> <span class="string">create</span></span><br></pre></td></tr></tbody></table></figure><p><img src="/2019/01/07/docker-harbor/15468562743522.jpg"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“&quot;&gt;&lt;a href=&quot;#åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“&quot; class=&quot;headerlink&quot; title=&quot;åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“&quot;&gt;&lt;/a&gt;åŸºäºharboræ­å»ºä¼ä¸šdockeré•œåƒä»“åº“&lt;/h1&gt;&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;dockerä¸­è¦ä½¿ç”¨é•œåƒï¼Œä¸€èˆ¬ä¼šä»æœ¬åœ°ã€docker Hupå…¬å…±ä»“åº“å’Œå…¶å®ƒç¬¬ä¸‰æ–¹å…¬å…±ä»“åº“ä¸­ä¸‹è½½é•œåƒï¼Œä¸€èˆ¬å‡ºäºå®‰å…¨å’Œå¤–ç½‘(å¢™)èµ„æºä¸‹è½½é€Ÿç‡çš„åŸå› è€ƒè™‘ä¼ä¸šçº§ä¸Šä¸ä¼šè½»æ˜“ä½¿ç”¨ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§åŠæ³•å¯ä»¥å­˜å‚¨è‡ªå·±çš„é•œåƒåˆæœ‰å®‰å…¨è®¤è¯çš„ä»“åº“å‘¢? &lt;/p&gt;
&lt;pre&gt;&lt;code&gt;     â€”-&amp;gt; ä¼ä¸šçº§ç¯å¢ƒä¸­åŸºäºHarboræ­å»ºè‡ªå·±çš„å®‰å…¨è®¤è¯ä»“åº“ã€‚
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Harboræ˜¯VMwareå…¬å¸æœ€è¿‘å¼€æºçš„ä¼ä¸šçº§Docker Registryé¡¹ç›®, å…¶ç›®æ ‡æ˜¯å¸®åŠ©ç”¨æˆ·è¿…é€Ÿæ­å»ºä¸€ä¸ªä¼ä¸šçº§çš„Docker registryæœåŠ¡ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å®‰è£…Harbor&quot;&gt;&lt;a href=&quot;#å®‰è£…Harbor&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…Harbor&quot;&gt;&lt;/a&gt;å®‰è£…Harbor&lt;/h2&gt;&lt;p&gt;harboréœ€è¦å®‰è£…dockerå’Œdocker-composeæ‰èƒ½ä½¿ç”¨ï¼Œå®‰è£…dockeræ­¥éª¤çœç•¥ï¼Œ&lt;/p&gt;
&lt;h3 id=&quot;å®‰è£…docker-dompose&quot;&gt;&lt;a href=&quot;#å®‰è£…docker-dompose&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…docker-dompose&quot;&gt;&lt;/a&gt;å®‰è£…docker-dompose&lt;/h3&gt;&lt;p&gt;docker-domposeå®‰è£…æ­¥éª¤å¦‚ä¸‹ï¼š &lt;/p&gt;
&lt;p&gt;ä¸‹è½½æœ€æ–°ç‰ˆçš„docker-composeæ–‡ä»¶ &lt;/p&gt;</summary>
    
    
    
    <category term="docker" scheme="https://blog.sctux.cc/categories/docker/"/>
    
    
    <category term="docker-registry" scheme="https://blog.sctux.cc/tags/docker-registry/"/>
    
  </entry>
  
  <entry>
    <title>CKA(Certified Kubernetes Adminsitrator)è®¤è¯è·å–å†ç¨‹</title>
    <link href="https://blog.sctux.cc/2019/01/07/road-to-cka/"/>
    <id>https://blog.sctux.cc/2019/01/07/road-to-cka/</id>
    <published>2019-01-07T02:00:40.000Z</published>
    <updated>2025-09-01T01:59:08.876Z</updated>
    
    <content type="html"><![CDATA[<p><em>my experience with cka exam preparation</em></p><hr><h1 id="What-is-CKA"><a href="#What-is-CKA" class="headerlink" title="What is CKA?"></a>What is CKA?</h1><p>CKAå…¨ç§°å°±æ˜¯<code>Certified Kubernetes Adminsitrator</code>ï¼Œæ˜¯ç”±CNCF(Cloud Native Computing Foundation äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š)æä¾›çš„è®¤è¯é¡¹ç›®ï¼Œè€ƒè¯•è´¹ç”¨ä¸º<code>300</code>ç¾é‡‘ï¼Œå¿…é¡»è¦åŒå¸è¡Œç”¨å¡ï¼Œè€ƒè¯•è¿‡ç¨‹ä¸º<code>3</code>ä¸ªå°æ—¶ã€‚<br>æˆ‘åŠç†çš„æ˜¯æ‹›è¡Œçš„MasterCardï¼Œç»™äº†20å—åŠ æ€¥ï¼›ç¼´è€ƒè¯•è´¹åˆ°è€ƒå®Œæ•´ä¸ªæµç¨‹æ–¹é¢è¿˜æ˜¯éå¸¸ç®€å•çš„ã€‚</p><div style="width: 40%; margin: auto">![](road-to-cka/WechatIMG319.jpeg)</div>å¦‚æœè€ƒè¯•ç¬¬ä¸€æ¬¡è€ƒè¯•ä¸é€šè¿‡ï¼Œè´¦å·å†…ä¼šç”Ÿæˆä¸€ä¸ª`Free Retake`ï¼Œåœ¨ä¸€å¹´ä¹‹å†…æœ‰ä¸€æ¬¡å…è´¹é‡è€ƒçš„æœºä¼šã€‚ <h1 id="Why-should-obtain-certification"><a href="#Why-should-obtain-certification" class="headerlink" title="Why should obtain certification"></a>Why should obtain certification</h1><p>å¾ˆæœ‰å¹¸åœ¨æ˜¥èŠ‚å‰(2019/01/06)å®Œæˆäº†2018ä¸‹åŠå¹´æ—¢å®šçš„ç›®æ ‡ï¼Œå°†CKAé¡ºåˆ©æ‹¿ä¸‹ã€‚<br>å¾ˆå·§åˆçš„æ˜¯åœ¨6å¹´å‰ä¹Ÿå°±æ˜¯2013å¹´1æœˆ5å·æˆ‘é€šè¿‡äº†<a href="https://blog.sctux.com/Guo_Maoqiu_RHCE.pdf">RHCE</a>è®¤è¯è€ƒè¯•(è™½ç„¶æˆ‘çš„RHCEè®¤è¯æ—©å·²è¿‡æœŸï¼Œä½†æ˜¯æˆ‘æ›´æƒ³è¯´çš„æ˜¯: <em><strong>ä¸‡å˜ä¸ç¦»å…¶å®—</strong></em> )<br><img src="/2019/01/07/road-to-cka/CKA.png"></p><p><img src="/2019/01/07/road-to-cka/verification.png"><br>å½“K8Så·²ç»è¿›å…¥åˆ°å„è¡Œå„ä¸šï¼Œé‚£ä¹ˆä¸€å¥—å…¬æ­£æƒå¨çš„ç®¡ç†å‘˜æµ‹è¯„ä½“ç³»å¿…ç„¶å°±å‘¼ä¹‹æ¬²å‡ºäº†ã€‚<br>ä¹Ÿè®¸ä½ ä¼šè¯´äº’è”ç½‘ä¼ä¸šä¸ç›¸ä¿¡è®¤è¯ï¼Œç¡®å®ä¸€å¼ çº¸å¹¶ä¸èƒ½è¯´æ˜ä»€ä¹ˆã€‚è¿™äº›è®¤è¯çš„æ„ä¹‰ä½•åœ¨ï¼Œæˆ–è€…æ€ä¹ˆæ‰èƒ½å‘åˆ«äººè¯æ˜ä½ ä¼šç”¨å‘¢ï¼Ÿç­”æ¡ˆè‡ªç„¶å°±æ˜¯è€ƒè¯äº†ã€‚RHCEä¹Ÿå¥½ã€CKAä¹Ÿå¥½å¯¹æˆ‘è€Œè¨€å…¶å®æ›´å¤šçš„æ˜¯ä¸€ç§é­ç­–ï¼Œè®©è‡ªå·±å¿ƒé‡Œæœ‰ä¸ªå°ç›®æ ‡ï¼ŒåŒæ—¶èƒ½å¤Ÿä»¥è¿ç»´äººå‘˜çš„èº«ä»½å»ç³»ç»Ÿçš„å­¦ä¹ ã€ä½¿ç”¨ä»–ä»¬ã€‚</p><p>ç»è¿‡æˆ‘ä¸ªäººçš„å­¦ä¹ ï¼Œå‚è€ƒè¿‡ç¨‹ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªè®¤è¯çš„æ„ä¹‰å’Œä»·å€¼å¦‚ä¸‹ï¼š</p><ol><li>ä»è€ƒè¯•å¤§çº²å¯ä»¥çœ‹å‡ºè€ƒè¯•å†…å®¹æ¶µç›–çš„çŸ¥è¯†ç‚¹å¾ˆå…¨é¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ éœ€è¦å­¦ä¹ æˆ–è€…äº†è§£çš„çŸ¥è¯†ç‚¹ä¹Ÿå°±å¾ˆå¤š;</li><li>å¯¹äºè®¡åˆ’æ„å»ºè‡ªå·±k8sé›†ç¾¤çš„ä¸ªäººå’Œä¼ä¸šï¼Œæœ‰CKAåœ¨ä½ çš„å›¢é˜Ÿé‡Œèƒ½è®©ä½ æ›´å¿«æ›´ç¨³çš„å¼€å§‹ä½ çš„å®è·µã€‚æ¯•ç«Ÿè¿™å¸®äººæ˜¯ä»å¾’æ‰‹æ­é›†ç¾¤å¼€å§‹çš„ã€‚</li><li>å‚åŠ è¿™ä¸ªè€ƒè¯•çš„æ—¶é—´éå¸¸ç´§å¼ ï¼Œå‚åŠ äººå¿…é¡»å¯¹k8så¤§éƒ¨åˆ†èµ„æºçš„yamlå’Œå‘½ä»¤çƒ‚ç†Ÿäºå¿ƒã€‚ä½ éšä¾¿æ‰¾ä¸ªckaæ¥ï¼Œè®©ä»–å¾’æ‰‹ç»™ä½ å†™ä¸€ä¸ªåº”ç”¨çš„ç¼–æ’å‡ºæ¥ï¼Œä»deploy åˆ°pvåˆ°serviceï¼Œä¹Ÿè®¸ä»–ä¸ªåˆ«ç»†èŠ‚å’Œè¯æ³•å¯èƒ½ä¼šå†™é”™ï¼Œå¤§ä½“å†™å‡ºæ¥æ˜¯ä¸€ç‚¹é—®é¢˜éƒ½æ²¡æœ‰çš„ï¼ŒæœŸé—´å®Œå…¨ä¸ç”¨å‚è€ƒæ–‡æ¡£ã€‚æˆ‘è¦è¯´çš„æ˜¯ckaçš„åŸºæœ¬æŠ€èƒ½éå¸¸è¿‡ç¡¬ã€‚</li><li>æˆªè‡³åˆ°ç°åœ¨ï¼Œæˆ‘æ²¡æœ‰è§è¿‡ä»»ä½•ç»„ç»‡å’Œä¸ªäººæä¾›ckaå¿…è¿‡æ‰‹å†Œï¼ˆä¹Ÿå°±æ˜¯ä¼ è¯´ä¸­çš„bibleï¼‰ã€‚è¿™ä¸ªè®¤è¯è¯ç”Ÿä¹Ÿå°±ä¸€ã€ä¸¤å¹´çš„æ—¶é—´ï¼Œ å› æ­¤ç°åœ¨é€šè¿‡çš„äººéƒ½æ˜¯è´§çœŸä»·å®è€ƒå‡ºæ¥çš„ï¼ˆç›¸å¯¹äºå…¶ä»–å…¬å¸çš„æŸcmï¼ŒæŸæŸcaç­‰ç­‰ï¼‰ï¼Œè¿™ä¸ªä»·å€¼ä¼šä½“ç°åœ¨è¯ä¹¦ç¼–å·ä¸Šã€‚å†è¿‡å‡ å¹´ï¼Œä»¥æˆ‘ä»¬ä¸­å›½äººçš„è€ƒè¯•èƒ½åŠ›æ¥è¯´ï¼Œä½ æ‡‚çš„â€¦</li><li>æœ¬è€ƒè¯•ä»æŠ¥åè€ƒè¯•åˆ°æ¥æ´½å‚è€ƒï¼Œå…¨ç¨‹è‹±æ–‡äº¤æµï¼Œèƒ½è€ƒè¿‡çš„äººè‹±æ–‡æ°´å¹³è¿˜ç®—è¯´å¾—è¿‡å»å§ã€‚</li></ol><h1 id="æˆ‘çš„å­¦ä¹ è¿‡ç¨‹ã€é€”å¾„"><a href="#æˆ‘çš„å­¦ä¹ è¿‡ç¨‹ã€é€”å¾„" class="headerlink" title="æˆ‘çš„å­¦ä¹ è¿‡ç¨‹ã€é€”å¾„:"></a>æˆ‘çš„å­¦ä¹ è¿‡ç¨‹ã€é€”å¾„:</h1><ul><li>å…¶å®æ—©åœ¨2015å¹´å°±åœ¨æ¥è§¦å®¹å™¨æŠ€æœ¯ï¼Œä»LXCåˆ°Dockerå†åˆ°ç°åœ¨çš„kubernetes, æ—¥å¸¸å·¥ä½œä¸­çš„ä¹Ÿå°½é‡æŠŠä¸€äº›åº”ç”¨åšæˆdockerå»è·‘ï¼›çœä¸‹äº†ä¸å°‘ç²¾åŠ›æ—¶é—´å»åšä¸€äº›é‡å¤å¤æ‚æ€§çš„å·¥ä½œï¼›æ¯”å¦‚ä»¥å‰è·‘ä¸ªgitLabçš„ç¯å¢ƒï¼Œäº¦æˆ–æ˜¯æƒ³è¦ä¸ªPythonåº”ç”¨è¿è¡Œçš„ç¯å¢ƒï¼Œé™¤äº†è¦æŠŠæœåŠ¡å™¨åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œè¿˜éœ€è¦ä¸€äº›ç¹ççš„é…ç½®ï¼Œæœ‰äº†dockerä¹‹åï¼Œé€šè¿‡<code>dockerfile/docker-compose</code>å°±å¯ä»¥å¾ˆè½»æ¾çš„å®ç°ä¸€äº›åº”ç”¨è·‘åœ¨å®¹å™¨é‡Œé¢äº†ã€‚2018å¹´5æœˆä»½å¼€å§‹ç ”ç©¶å­¦ä¹ kubernetesç›¸å…³ä¸œè¥¿ï¼Œè™½ç„¶å­¦ä¹ å¾—ä¸æ˜¯å¾ˆç³»ç»Ÿï¼Œä½†æ˜¯è¿˜æ˜¯å®Œæˆäº†ä¸€ä¸ªå°å°çš„é¡¹ç›®ï¼Œæ„Ÿå…´è¶£çš„ç‚¹<a href="https://github.com/guomaoqiu/flask_kubernetes">è¿™é‡Œ</a> å¯ä»¥ä½œä¸ºå­¦ä¹ ç»ƒä¹ çš„é¡¹ç›®;æ—¢ç„¶å­¦äº†å°±è¦ç”¨ä¸Šï¼›ä¸ç„¶ä¹Ÿæ˜¯å¾’åŠ³ã€‚</li><li>K8s.ioé‡Œé¢tasksç›¸å…³çš„ä¸œè¥¿éƒ½éœ€è¦è‡ªå·±å®è·µä¸‹ï¼Œè¿˜æ˜¯æœ‰äº›æ—¥å¸¸æ²¡æ€ä¹ˆç”¨åˆ°çš„,æœ€å¥½æŠŠæ•´ä¸ªæ–‡æ¡£éƒ½çœ‹ä¸€éã€‚</li><li>å®‹å¤§ç¥çš„åšå®¢: <a href="https://jimmysong.io/kubernetes-handbook/">https://jimmysong.io/kubernetes-handbook/</a></li><li>å­¦ä¹ å®æ“ç¯å¢ƒåšæœ€å¥½æ˜¯é€šè¿‡äºŒè¿›åˆ¶çš„æ–¹å¼æ¥æ­å»ºï¼Œæ¯•ç«Ÿå¦‚æœä½ ä½¿ç”¨kubeadmæ¥æ­å»ºçš„è¯å¾ˆå¤šçš„äº‹æƒ…å®ƒå·²ç»å¸®ä½ å®Œæˆè®¾å®šäº†ï¼Œä¹Ÿå°±æ²¡ç†è§£ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšã€‚æ¯ä¸ªç»„ä»¶ç»“åˆèµ·æ¥ä¹‹åæ•´ä¸ªæ¶æ„åœ¨è„‘å­é‡Œé¢å°±ä¼šéå¸¸çš„æ¸…æ¥šï¼Œæ’é”™èµ·æ¥ä¹Ÿæ›´åŠ å®¹æ˜“ä¸€äº›ã€‚è€ƒè¯•ä¸éš¾ï¼Œåªè¦ç»è¿‡å¤§é‡çš„å®è·µç»ƒä¹ å°±å¯ä»¥å•¦~</li></ul><p><em><strong>æ³¨:</strong></em> è¿™æ¬¡CKAè€ƒè¯•ï¼Œæˆ‘æ²¡æœ‰å‚åŠ ä»»ä½•å›½å†…åŸ¹è®­ï¼Œä¸»è¦æ˜¯æ ¹æ®è€ƒè¯•å¤§çº²ã€å®˜æ–¹æ–‡æ¡£ä»¥åŠCNCFæ¨å‡ºçš„ä¸€å¥—<a href="https://www.edx.org/course/introduction-to-kubernetes">å…è´¹è¯¾ç¨‹</a>è¿›è¡Œè‡ªå­¦ã€‚</p><h1 id="è€ƒå‰æ³¨æ„äº‹é¡¹"><a href="#è€ƒå‰æ³¨æ„äº‹é¡¹" class="headerlink" title="è€ƒå‰æ³¨æ„äº‹é¡¹"></a>è€ƒå‰æ³¨æ„äº‹é¡¹</h1><ul><li>è€ƒè¯•å¹³å°æ˜¯ç”±CNCFå§”æ‰˜çš„ä¸€ä¸ªè®¡ç®—æœºæ–¹é¢éå¸¸ä¸“ä¸šçš„æœåŠ¡å•†<a href="https://www.examslocal.com/">PSI</a>æ¥è¿›è¡Œç›‘ç£è€ƒè¯•ï¼›</li><li>å®˜æ–¹è®¤è¯è¯ä»¶ï¼šéœ€è¦æœ‰ç…§ç‰‡å’ŒLatinå­—æ¯å†™çš„å…¨åï¼Œæˆ‘ç”¨çš„æ˜¯æŠ¤ç…§;</li><li>è€ƒè¯•ä¸­ä¸èƒ½å–æ°´ã€åƒä¸œè¥¿ï¼Œå¯ä»¥ç”³è¯·ä¼‘æ¯ï¼Œä½†æ˜¯ä¸æ¸…æ¥šèƒ½ä¸èƒ½ç¦»å¼€æ‘„åƒå¤´ç›‘è§†èŒƒå›´å†…ï¼Œæ²¡è¯·è¿‡ï¼Œåæ­£æˆ‘å…¨ç¨‹æ— å°¿ç‚¹ã€‚</li><li>è€ƒè¯•çš„ç½‘é¡µä¸€åŠæ˜¯è¯•é¢˜ã€ä¸€åŠæ˜¯GateOneçš„ç»ˆç«¯ç•Œé¢ï¼Œæœ€å¥½èƒ½æœ‰ä¸€å°macç”µè„‘ç„¶åå¤–æ¥æ˜¾ç¤ºå™¨ã€é”®ç›˜ï¼Œé¼ æ ‡ï¼Œmacç³»ç»Ÿæ¯”windowsæœ‰ä¼˜åŠ¿ï¼Œå†ä¸€ä¸ªå°±æ˜¯ç»ˆç«¯å°±æ˜¾å¾—ä¸æ˜¯å¾ˆå°äº†ï¼Œæ“ä½œä¹Ÿé¡ºæ‰‹; (å¦å¤–ä¸ºäº†æå‰ç†Ÿæ‚‰ä½¿ç”¨gateoneç»ˆç«¯æˆ‘è¿™é‡Œä¹Ÿåšäº†ä¸€ä¸ª<a href="https://github.com/guomaoqiu/kubectl-terminal">é•œåƒ</a>ï¼Œå…·ä½“é£Ÿç”¨æ–¹æ³•å‚è§README.md)</li><li>ä¸€ä¸ªæ²¡æœ‰å…¶ä»–äººçš„ç©ºæˆ¿é—´ï¼Œç©ºæ¡Œå­ï¼Œä¸èƒ½å¸¦æ‰‹æœºï¼Œä¸èƒ½æœ‰ä¹¦æœ¬ï¼Œç›‘è€ƒå®˜ä¼šè®©ä½ æ‹¿ç€ç”µè„‘å±•ç¤ºä½ å‘¨å›´çš„æ‰€æœ‰ç¯å¢ƒï¼Œæˆ‘çš„è€ƒè¯•æ˜¯é¢„çº¦åœ¨å‘¨æœ«ä¸‹åˆåœ¨å…¬å¸ä¸€ä¸ªä¼šè®®å®¤å®Œæˆçš„;</li><li>æŒ‰ç…§å®˜æ–¹è€ƒè¯•æµç¨‹æŒ‡å¯¼è¿˜éœ€è¦åšä¸€ä¸‹ç¡¬ä»¶è¦æ±‚æ€§çš„æµ‹è¯•: ä½¿ç”¨Chromeæµè§ˆå™¨è®¿é—®<a href="https://www.examslocal.com/ScheduleExam/Home/CompatibilityCheck">https://www.examslocal.com/ScheduleExam/Home/CompatibilityCheck</a> é€‰æ‹©â€Linux Foundationâ€ as the Exam Sponsor and â€œCKAâ€ as the Examæ ¹æ®æç¤ºå®‰è£…ä¸€ä¸ªchromeæ’ä»¶ï¼ˆå®æµ‹æœ‰é¡¹ç½‘é€Ÿçš„æ£€æŸ¥ï¼Œéœ€è¦æœ‰ä¸ªç¨³å®šçš„ç§‘å­¦ä¸Šç½‘å·¥å…·ï¼‰</li><li>180åˆ†é’Ÿï¼Œ24é“é¢˜(æ¶µç›–æ‰€æœ‰k8såŸºç¡€çŸ¥è¯†ç‚¹),å¹³å‡ä¸€é“é¢˜7.5åˆ†é’Ÿï¼Œæ—¶é—´æ˜¯éå¸¸ç´§çš„ï¼›ä¸€é“é¢˜åšå®Œè¦å»éªŒè¯ï¼Œæœ‰æŠŠæ¡æ²¡é—®é¢˜çš„å°±æœæ–­ä¸‹ä¸€é¢˜ï¼Œåƒä¸‡ä¸è¦çŠ¹è±«ï¼›æ‰“è„‘å£³çš„é‚£ç§é¢˜è®°ä½é¢˜å·ï¼Œåšå®Œç®€å•çš„åœ¨å›è¿‡å¤´æ¥æ•´ã€‚</li></ul><h1 id="è€ƒè¯•ç»“æŸæ³¨æ„äº‹é¡¹"><a href="#è€ƒè¯•ç»“æŸæ³¨æ„äº‹é¡¹" class="headerlink" title="è€ƒè¯•ç»“æŸæ³¨æ„äº‹é¡¹"></a>è€ƒè¯•ç»“æŸæ³¨æ„äº‹é¡¹</h1><p>åœ¨è€ƒè¯•ç»“æŸä¹‹åï¼Œ36ä¸ªå°æ—¶ä¹‹å†…ï¼ŒCNCFå°±ä¼šé€šè¿‡é‚®ä»¶å‘Šè¯‰ä½ è€ƒè¯•æˆç»©äº†ï¼Œå¦‚æœä½ çš„åˆ†æ•°å¤§äº74%ï¼Œé‚£ä¹ˆæ­å–œä½ é€šè¿‡äº†ï¼å¹¶ä¸”é™„ä»¶å°±ç›´æ¥ä¼šæœ‰ä½ çš„é€šè¿‡çš„è¯ä¹¦ã€‚å¦‚æœè€ƒè¯•ä¸é€šè¿‡ï¼Œä½ çš„è´¦å·ä¸Šå°±ä¼šç›´æ¥æœ‰ä¸€æ¬¡<code>Free Retake</code>è€ƒè¯•çš„æœºä¼šã€‚<br><img src="/2019/01/07/road-to-cka/score.png"></p><p>ğŸ˜¢ä¸¢äº†3åˆ†ï¼Œå®˜æ–¹ä¹Ÿä¸ä¼šå‘Šè¯‰ä½ åˆ°åº•é”™åœ¨å“ªé‡Œäº†ï¼›å°±åªæœ‰è¿™ä¹ˆä¸€ä¸ªæˆç»©è·Ÿè¯ä¹¦å‘è¿‡æ¥ã€‚</p><hr><p>ä»¥ä¸Šï¼Œå¸Œæœ›å¯ä»¥å¸®åˆ°ä½ ã€‚</p><p>ps: <em><del>_</del>è¯¥è€ƒè¯•ç­¾è®¢äº†ä¿å¯†åè®®ï¼ŒSo è€ƒè¯•åŸé¢˜æ— æ³•åˆ†äº«~~~_~~</em></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;em&gt;my experience with cka exam preparation&lt;/em&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h1 id=&quot;What-is-CKA&quot;&gt;&lt;a href=&quot;#What-is-CKA&quot; class=&quot;headerlink&quot; title=&quot;What is CKA?&quot;&gt;&lt;/a&gt;What is CKA?&lt;/h1&gt;&lt;p&gt;CKAå…¨ç§°å°±æ˜¯&lt;code&gt;Certified Kubernetes Adminsitrator&lt;/code&gt;ï¼Œæ˜¯ç”±CNCF(Cloud Native Computing Foundation äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š)æä¾›çš„è®¤è¯é¡¹ç›®ï¼Œè€ƒè¯•è´¹ç”¨ä¸º&lt;code&gt;300&lt;/code&gt;ç¾é‡‘ï¼Œå¿…é¡»è¦åŒå¸è¡Œç”¨å¡ï¼Œè€ƒè¯•è¿‡ç¨‹ä¸º&lt;code&gt;3&lt;/code&gt;ä¸ªå°æ—¶ã€‚&lt;br&gt;æˆ‘åŠç†çš„æ˜¯æ‹›è¡Œçš„MasterCardï¼Œç»™äº†20å—åŠ æ€¥ï¼›ç¼´è€ƒè¯•è´¹åˆ°è€ƒå®Œæ•´ä¸ªæµç¨‹æ–¹é¢è¿˜æ˜¯éå¸¸ç®€å•çš„ã€‚&lt;/p&gt;
&lt;div style=&quot;width: 40%; margin: auto&quot;&gt;![](road-to-cka/WechatIMG319.jpeg)&lt;/div&gt;
å¦‚æœè€ƒè¯•ç¬¬ä¸€æ¬¡è€ƒè¯•ä¸é€šè¿‡ï¼Œè´¦å·å†…ä¼šç”Ÿæˆä¸€ä¸ª`Free Retake`ï¼Œåœ¨ä¸€å¹´ä¹‹å†…æœ‰ä¸€æ¬¡å…è´¹é‡è€ƒçš„æœºä¼šã€‚ 

&lt;h1 id=&quot;Why-should-obtain-certification&quot;&gt;&lt;a href=&quot;#Why-should-obtain-certification&quot; class=&quot;headerlink&quot; title=&quot;Why should obtain certification&quot;&gt;&lt;/a&gt;Why should obtain certification&lt;/h1&gt;&lt;p&gt;å¾ˆæœ‰å¹¸åœ¨æ˜¥èŠ‚å‰(2019/01/06)å®Œæˆäº†2018ä¸‹åŠå¹´æ—¢å®šçš„ç›®æ ‡ï¼Œå°†CKAé¡ºåˆ©æ‹¿ä¸‹ã€‚&lt;br&gt;å¾ˆå·§åˆçš„æ˜¯åœ¨6å¹´å‰ä¹Ÿå°±æ˜¯2013å¹´1æœˆ5å·æˆ‘é€šè¿‡äº†&lt;a href=&quot;https://blog.sctux.com/Guo_Maoqiu_RHCE.pdf&quot;&gt;RHCE&lt;/a&gt;è®¤è¯è€ƒè¯•(è™½ç„¶æˆ‘çš„RHCEè®¤è¯æ—©å·²è¿‡æœŸï¼Œä½†æ˜¯æˆ‘æ›´æƒ³è¯´çš„æ˜¯: &lt;em&gt;&lt;strong&gt;ä¸‡å˜ä¸ç¦»å…¶å®—&lt;/strong&gt;&lt;/em&gt; )&lt;br&gt;&lt;img src=&quot;/2019/01/07/road-to-cka/CKA.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2019/01/07/road-to-cka/verification.png&quot;&gt;&lt;br&gt;å½“K8Så·²ç»è¿›å…¥åˆ°å„è¡Œå„ä¸šï¼Œé‚£ä¹ˆä¸€å¥—å…¬æ­£æƒå¨çš„ç®¡ç†å‘˜æµ‹è¯„ä½“ç³»å¿…ç„¶å°±å‘¼ä¹‹æ¬²å‡ºäº†ã€‚&lt;br&gt;ä¹Ÿè®¸ä½ ä¼šè¯´äº’è”ç½‘ä¼ä¸šä¸ç›¸ä¿¡è®¤è¯ï¼Œç¡®å®ä¸€å¼ çº¸å¹¶ä¸èƒ½è¯´æ˜ä»€ä¹ˆã€‚è¿™äº›è®¤è¯çš„æ„ä¹‰ä½•åœ¨ï¼Œæˆ–è€…æ€ä¹ˆæ‰èƒ½å‘åˆ«äººè¯æ˜ä½ ä¼šç”¨å‘¢ï¼Ÿç­”æ¡ˆè‡ªç„¶å°±æ˜¯è€ƒè¯äº†ã€‚RHCEä¹Ÿå¥½ã€CKAä¹Ÿå¥½å¯¹æˆ‘è€Œè¨€å…¶å®æ›´å¤šçš„æ˜¯ä¸€ç§é­ç­–ï¼Œè®©è‡ªå·±å¿ƒé‡Œæœ‰ä¸ªå°ç›®æ ‡ï¼ŒåŒæ—¶èƒ½å¤Ÿä»¥è¿ç»´äººå‘˜çš„èº«ä»½å»ç³»ç»Ÿçš„å­¦ä¹ ã€ä½¿ç”¨ä»–ä»¬ã€‚&lt;/p&gt;
&lt;p&gt;ç»è¿‡æˆ‘ä¸ªäººçš„å­¦ä¹ ï¼Œå‚è€ƒè¿‡ç¨‹ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ªè®¤è¯çš„æ„ä¹‰å’Œä»·å€¼å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä»è€ƒè¯•å¤§çº²å¯ä»¥çœ‹å‡ºè€ƒè¯•å†…å®¹æ¶µç›–çš„çŸ¥è¯†ç‚¹å¾ˆå…¨é¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ éœ€è¦å­¦ä¹ æˆ–è€…äº†è§£çš„çŸ¥è¯†ç‚¹ä¹Ÿå°±å¾ˆå¤š;&lt;/li&gt;
&lt;li&gt;å¯¹äºè®¡åˆ’æ„å»ºè‡ªå·±k8sé›†ç¾¤çš„ä¸ªäººå’Œä¼ä¸šï¼Œæœ‰CKAåœ¨ä½ çš„å›¢é˜Ÿé‡Œèƒ½è®©ä½ æ›´å¿«æ›´ç¨³çš„å¼€å§‹ä½ çš„å®è·µã€‚æ¯•ç«Ÿè¿™å¸®äººæ˜¯ä»å¾’æ‰‹æ­é›†ç¾¤å¼€å§‹çš„ã€‚&lt;/li&gt;
&lt;li&gt;å‚åŠ è¿™ä¸ªè€ƒè¯•çš„æ—¶é—´éå¸¸ç´§å¼ ï¼Œå‚åŠ äººå¿…é¡»å¯¹k8så¤§éƒ¨åˆ†èµ„æºçš„yamlå’Œå‘½ä»¤çƒ‚ç†Ÿäºå¿ƒã€‚ä½ éšä¾¿æ‰¾ä¸ªckaæ¥ï¼Œè®©ä»–å¾’æ‰‹ç»™ä½ å†™ä¸€ä¸ªåº”ç”¨çš„ç¼–æ’å‡ºæ¥ï¼Œä»deploy åˆ°pvåˆ°serviceï¼Œä¹Ÿè®¸ä»–ä¸ªåˆ«ç»†èŠ‚å’Œè¯æ³•å¯èƒ½ä¼šå†™é”™ï¼Œå¤§ä½“å†™å‡ºæ¥æ˜¯ä¸€ç‚¹é—®é¢˜éƒ½æ²¡æœ‰çš„ï¼ŒæœŸé—´å®Œå…¨ä¸ç”¨å‚è€ƒæ–‡æ¡£ã€‚æˆ‘è¦è¯´çš„æ˜¯ckaçš„åŸºæœ¬æŠ€èƒ½éå¸¸è¿‡ç¡¬ã€‚&lt;/li&gt;
&lt;li&gt;æˆªè‡³åˆ°ç°åœ¨ï¼Œæˆ‘æ²¡æœ‰è§è¿‡ä»»ä½•ç»„ç»‡å’Œä¸ªäººæä¾›ckaå¿…è¿‡æ‰‹å†Œï¼ˆä¹Ÿå°±æ˜¯ä¼ è¯´ä¸­çš„bibleï¼‰ã€‚è¿™ä¸ªè®¤è¯è¯ç”Ÿä¹Ÿå°±ä¸€ã€ä¸¤å¹´çš„æ—¶é—´ï¼Œ å› æ­¤ç°åœ¨é€šè¿‡çš„äººéƒ½æ˜¯è´§çœŸä»·å®è€ƒå‡ºæ¥çš„ï¼ˆç›¸å¯¹äºå…¶ä»–å…¬å¸çš„æŸcmï¼ŒæŸæŸcaç­‰ç­‰ï¼‰ï¼Œè¿™ä¸ªä»·å€¼ä¼šä½“ç°åœ¨è¯ä¹¦ç¼–å·ä¸Šã€‚å†è¿‡å‡ å¹´ï¼Œä»¥æˆ‘ä»¬ä¸­å›½äººçš„è€ƒè¯•èƒ½åŠ›æ¥è¯´ï¼Œä½ æ‡‚çš„â€¦&lt;/li&gt;
&lt;li&gt;æœ¬è€ƒè¯•ä»æŠ¥åè€ƒè¯•åˆ°æ¥æ´½å‚è€ƒï¼Œå…¨ç¨‹è‹±æ–‡äº¤æµï¼Œèƒ½è€ƒè¿‡çš„äººè‹±æ–‡æ°´å¹³è¿˜ç®—è¯´å¾—è¿‡å»å§ã€‚&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/tags/kubernetes/"/>
    
    <category term="CKA" scheme="https://blog.sctux.cc/tags/CKA/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Bootstrap Tokenå®ŒæˆTLS Bootstrapping</title>
    <link href="https://blog.sctux.cc/2018/12/30/kubernetes-bootstrapping/"/>
    <id>https://blog.sctux.cc/2018/12/30/kubernetes-bootstrapping/</id>
    <published>2018-12-30T10:24:10.000Z</published>
    <updated>2025-09-01T01:59:08.973Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦è®°å½•ä¸€ä¸‹æ­å»ºä¸€ä¸ªkubeletæ­å»ºåˆ°åŠ å…¥é›†ç¾¤åˆ°æ‰‹åŠ¨ã€è‡ªåŠ¨(è¯ä¹¦è½®æ¢çš„)è¯ä¹¦è®¤è¯è¿‡ç¨‹, é‚£ä¹ˆæˆ‘çš„ç¯å¢ƒæ˜¯ç”¨çš„v1.12.4ç‰ˆæœ¬ï¼Œæœ‰ä¸€å°master,é™¤äº†masterä¸Šé¢çš„ä¸€äº›ç»„ä»¶å·²ç»æ­å»ºå®Œæ¯•ï¼Œä¸»è¦é‡ç‚¹æ˜¯åœ¨kubeletä¸Šé¢ï¼Œæ‰€ä»¥ç°åœ¨å°±æ˜¯masterå·²ç»å·¥ä½œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼ŒåŠ å…¥æ–°çš„<code>kubelet(workerèŠ‚ç‚¹)</code>éœ€è¦åšä¸€äº›ä»€ä¹ˆæ ·çš„æ“ä½œã€‚<br>ç„¶åéœ€è¦å®ç°çš„æ˜¯:</p><ul><li>é€šè¿‡bootstrap tokenä»¥åŠboostrap.kubeconfigæ¥å¼•å¯¼workerèŠ‚ç‚¹ç”³è¯·è¯ä¹¦</li><li>å¦‚æœç¬¬ä¸€æ­¥ç”³è¯·å‘å‡ºå»ä¹‹åï¼Œåœ¨æ‰‹åŠ¨åœ¨masterç«¯è¿›è¡Œæ‰‹åŠ¨æ‰¹å‡†è¯ä¹¦ç”³è¯·ï¼Œç„¶åå‘æ”¾kubeletè¯ä¹¦</li><li>å®ç°kubeletè¯ä¹¦çš„è‡ªåŠ¨æ‰¹å‡†</li><li>å®ç°kubeletè¯ä¹¦çš„è‡ªåŠ¨è½®æ¢æ“ä½œ<br><img src="/2018/12/30/kubernetes-bootstrapping/start.png"></li></ul><p><strong>ç®€å•ç†ä¸€ä¸‹TLS Bootstrappingçš„ä¸€ä¸ªå¼•å¯¼è¿‡ç¨‹</strong></p><ol><li>masterç«¯åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯å³ç”Ÿæˆ <code>apiserver.pem/apiserver-key.pem/apiserver.csr</code>;</li><li>åœ¨é›†ç¾¤å†…åˆ›å»ºç‰¹å®šçš„ Bootstrap Token Secretï¼Œè¯¥ Secret å°†æ›¿ä»£ä»¥å‰çš„ token.csv å†…ç½®ç”¨æˆ·å£°æ˜æ–‡ä»¶;</li><li>åœ¨é›†ç¾¤å†…åˆ›å»ºé¦–æ¬¡ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„ ClusterRole å³<code>system:node-bootstrapper</code>,å¹¶å°†ä¸Šé¢çš„bootstrap token secretè¿›è¡Œç»‘å®šå³ clusterrolebinding <code>kubelet-bootstrap</code>ï¼Œè¿™æ ·é€šè¿‡ç»‘å®šå°±èƒ½ä»¥è¿™ä¸ªå†…ç½®ç”¨æˆ·ç»„ä¿¡æ¯å»å‘èµ·CSRè¯·æ±‚å•¦ï¼›</li><li>ç”Ÿæˆç‰¹å®šçš„åŒ…å« <code>TLS Bootstrapping Token</code> çš„ <code>bootstrap.kubeconfig</code>;</li><li>è°ƒæ•´kubeleteå¯åŠ¨å‚æ•°ï¼ŒæŒ‡å®šå¼•å¯¼æ–‡ä»¶<code>bootstrap.kubeconfig</code>;</li><li>é‡è½½é…ç½®ã€é‡å¯æœåŠ¡ï¼Œmasterç«¯æ‰‹åŠ¨æ‰¹å‡†å®ŒæˆworkerèŠ‚ç‚¹çš„CSRè¯·æ±‚;</li><li>åç»­å¦‚æœæ²¡æœ‰é…ç½®è¯ä¹¦è½®æ¢çš„è¯ï¼Œå°±ä¼šä¸€ç›´ä½¿ç”¨ç”±controller-manageræ‰¹å‡†é¢å‘çš„è¯ä¹¦æ–‡ä»¶äº†ï¼Œæœ‰æ•ˆæœŸæ˜¯ä¸€å¹´ã€‚(è‡ªåŠ¨æ‰¹å‡†&amp;è¯ä¹¦è½®æ¢ä¸‹é¢å†è¯´)</li></ol><p>å½“ç„¶ä»¥æˆ‘çš„ç†è§£è¦è¦å®ç°è¯ä¹¦è½®æ¢é‚£ä¹ˆè‚¯å®šæ˜¯æ²¡æœ‰å¤–ç•Œå¹²é¢„çš„æƒ…å†µä¸‹è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œé‚£è¿™ä¸ªåŠŸèƒ½ä¹Ÿè‚¯å®šæ˜¯éœ€è¦è‡ªåŠ¨æ‰¹å‡†è¿™ä¸ªåŠŸèƒ½çš„ã€‚</p><p>é‚£ä¹ˆè‡ªåŠ¨æ‰¹å‡†éœ€è¦åšçš„ä¸€äº›äº‹æƒ…å´æ˜¯åœ¨æ‰‹åŠ¨æ‰¹å‡†çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›æ“ä½œ:</p><ol><li>åˆ›å»ºCSRè¯·æ±‚çš„ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„renew Kubelet client/server çš„ ClusterRoleï¼Œä»¥åŠå…¶ç›¸å…³å¯¹åº”çš„ ClusterRoleBindingï¼›å¹¶ç»‘å®šåˆ°å¯¹åº”çš„ç»„æˆ–ç”¨æˆ·</li><li>è°ƒæ•´ Controller Manager é…ç½®ï¼Œä»¥ä½¿å…¶èƒ½è‡ªåŠ¨ç­¾ç½²ç›¸å…³è¯ä¹¦å’Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ TLS Bootstrapping Token</li><li>å¯é€‰çš„: é›†ç¾¤æ­å»ºæˆåŠŸåç«‹å³æ¸…é™¤ Bootstrap Token Secretï¼Œæˆ–ç­‰å¾… Controller Manager å¾…å…¶è¿‡æœŸååˆ é™¤ï¼Œä»¥é˜²æ­¢è¢«æ¶æ„åˆ©ç”¨</li></ol><h1 id="äºŒã€æ‰‹åŠ¨æ‰¹å‡†"><a href="#äºŒã€æ‰‹åŠ¨æ‰¹å‡†" class="headerlink" title="äºŒã€æ‰‹åŠ¨æ‰¹å‡†"></a>äºŒã€æ‰‹åŠ¨æ‰¹å‡†</h1><h2 id="2-1-åˆ›å»ºAPI-Serverå’ŒKubelet-Clienté€šä¿¡å‡­è¯"><a href="#2-1-åˆ›å»ºAPI-Serverå’ŒKubelet-Clienté€šä¿¡å‡­è¯" class="headerlink" title="2.1 åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯"></a>2.1 åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯</h2><p>æˆ‘è¿™é‡Œå·²ç»æœ‰caæ ¹è¯ä¹¦æ–‡ä»¶äº†ï¼Œé‚£å°±ä»åˆ›å»ºapiserverè¯ä¹¦å¼€å§‹</p><figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> <span class="built_in">cat</span> &gt;&gt; apiserver<span class="literal">-csr</span>.json &lt;&lt; EOF</span><br><span class="line">{</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kube-apiserver"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"10.96.0.1"</span>,</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"192.168.56.201"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: {</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  },</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"Hangzhou"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"Hangzhou"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"Kubernetes"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes-manual"</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘è¿™é‡Œå°±å•å°master,æ‰€ä»¥å°±å†™äº†ä¸ªè¿™ä¸€ä¸ªIPåœ°å€</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»º:</span></span><br><span class="line"><span class="variable">$cfssl</span> gencert \</span><br><span class="line">  -ca=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>ca.pem \</span><br><span class="line">  -ca-key=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>ca-key.pem \</span><br><span class="line">  -config=ca-config.json \</span><br><span class="line">  -profile=kubernetes \</span><br><span class="line">  apiserver-csr.json | cfssljson -bare <span class="variable">${PKI_DIR}</span>/apiserver</span><br><span class="line"></span><br><span class="line">ls <span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>apiserver*.pem</span><br><span class="line"><span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>apiserver-key.pem  <span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>apiserver.pem</span><br></pre></td></tr></tbody></table></figure><h2 id="2-2-åˆ›å»ºå¼•å¯¼é…ç½®æ–‡ä»¶-bootstrap-kubelet-kubeconfig"><a href="#2-2-åˆ›å»ºå¼•å¯¼é…ç½®æ–‡ä»¶-bootstrap-kubelet-kubeconfig" class="headerlink" title="2.2 åˆ›å»ºå¼•å¯¼é…ç½®æ–‡ä»¶ bootstrap-kubelet.kubeconfig"></a>2.2 åˆ›å»ºå¼•å¯¼é…ç½®æ–‡ä»¶ bootstrap-kubelet.kubeconfig</h2><h3 id="2-2-1-ç”Ÿæˆbootsrapâ€”token"><a href="#2-2-1-ç”Ÿæˆbootsrapâ€”token" class="headerlink" title="2.2.1 ç”Ÿæˆbootsrapâ€”token"></a>2.2.1 ç”Ÿæˆbootsrapâ€”token</h3><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">TOKEN_ID</span>=$(openssl rand 3 -hex)</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">TOKEN_SECRET</span>=$(openssl rand 8 -hex)</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">BOOTSTRAP_TOKEN</span>=<span class="variable">${TOKEN_ID}</span>.${TOKEN_SECRET}</span><br></pre></td></tr></tbody></table></figure><p>å…³äºè¿™ä¸ªtokençš„æ ¼å¼è¦æ±‚å‚è§<a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#token-format">è¿™é‡Œ</a></p><h3 id="2-2-2-åˆ›å»ºboostrap-token-secret"><a href="#2-2-2-åˆ›å»ºboostrap-token-secret" class="headerlink" title="2.2.2 åˆ›å»ºboostrap token secret"></a>2.2.2 åˆ›å»ºboostrap token secret</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> bootstrap-token-Secret.yml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Secret</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> bootstrap-token-{TOKEN_ID}</span><br><span class="line">  <span class="params">namespace:</span> kube-system</span><br><span class="line"><span class="params">type:</span> bootstrap.kubernetes.io<span class="symbol">/token</span></span><br><span class="line"><span class="params">stringData:</span></span><br><span class="line">  <span class="params">token-id:</span> {TOKEN_ID}</span><br><span class="line">  <span class="params">token-secret:</span> {TOKEN_SECRET}</span><br><span class="line">  <span class="params">usage-bootstrap-authentication:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="params">usage-bootstrap-signing:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="params">auth-extra-groups:</span> system:bootstrappers:default-node-token</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ä»¥ä¸Šå˜é‡èµ‹å€¼è¿›å»</span></span><br><span class="line">sed <span class="operator">-</span>ri <span class="string">"s#<span class="char escape_">\{</span>TOKEN_ID<span class="char escape_">\}</span>#<span class="subst">${TOKEN_ID}</span>#g"</span> bootstrap-token-Secret.yml</span><br><span class="line">sed <span class="operator">-</span>ri <span class="string">"/token-id/s#<span class="char escape_">\S</span>+<span class="char escape_">\$</span>#'&amp;'#"</span> resources<span class="symbol">/bootstrap-token-Secret.yml</span></span><br><span class="line">sed <span class="operator">-</span>ri <span class="string">"s#<span class="char escape_">\{</span>TOKEN_SECRET<span class="char escape_">\}</span>#<span class="subst">${TOKEN_SECRET}</span>#g"</span> resources<span class="symbol">/bootstrap-token-Secret.yml</span></span><br><span class="line">kubectl create <span class="operator">-</span>f resources<span class="symbol">/bootstrap-token-Secret.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¯¦æƒ…ï¼Œä¸€å®šè¦æ”¾åˆ°kube-systemè¿™ä¸ªnamespace</span></span><br><span class="line">$ kubectl describe secret  bootstrap-token-b8cf79 <span class="operator">-</span>n kube-system</span><br><span class="line"><span class="params">Name:</span>         bootstrap-token-b8cf79</span><br><span class="line"><span class="params">Namespace:</span>    kube-system</span><br><span class="line"><span class="params">Labels:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span></span><br><span class="line"><span class="params">Type:</span>         bootstrap.kubernetes.io<span class="symbol">/token</span></span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line"><span class="operator">==</span><span class="operator">==</span></span><br><span class="line"><span class="params">auth-extra-groups:</span>               <span class="number">39</span> bytes</span><br><span class="line"><span class="params">token-id:</span>                        <span class="number">6</span> bytes</span><br><span class="line"><span class="params">token-secret:</span>                    <span class="number">16</span> bytes</span><br><span class="line"><span class="params">usage-bootstrap-authentication:</span>  <span class="number">4</span> bytes</span><br><span class="line"><span class="params">usage-bootstrap-signing:</span>         <span class="number">4</span> bytes</span><br></pre></td></tr></tbody></table></figure><h3 id="2-2-2-åˆ›å»ºå¯åŠ¨å¼•å¯¼é…ç½®"><a href="#2-2-2-åˆ›å»ºå¯åŠ¨å¼•å¯¼é…ç½®" class="headerlink" title="2.2.2 åˆ›å»ºå¯åŠ¨å¼•å¯¼é…ç½®"></a>2.2.2 åˆ›å»ºå¯åŠ¨å¼•å¯¼é…ç½®</h3><figure class="highlight dsconfig"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bootstrap set cluster</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-cluster</span> <span class="string">kubernetes</span> \</span><br><span class="line">    <span class="built_in">--certificate-authority=/etc/kubernetes/pki/ca.pem</span> \</span><br><span class="line">    <span class="built_in">--embed-certs=true</span> \</span><br><span class="line">    <span class="built_in">--server=192.168.56.202</span> \</span><br><span class="line">    <span class="built_in">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bootstrap set credentials</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-credentials</span> <span class="string">tls-bootstrap-token-user</span> \</span><br><span class="line">    <span class="built_in">--token=${BOOTSTRAP_TOKEN}</span> \</span><br><span class="line">    <span class="built_in">--kubeconfig=/etc/kubernetes//bootstrap-kubelet.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bootstrap set context</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-context</span> <span class="string">tls-bootstrap-token-user</span>@<span class="string">kubernetes</span> \</span><br><span class="line">    <span class="built_in">--cluster=kubernetes</span> \</span><br><span class="line">    <span class="built_in">--user=tls-bootstrap-token-user</span> \</span><br><span class="line">    <span class="built_in">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bootstrap use default context</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="string">use-context</span> <span class="string">tls-bootstrap-token-user</span>@<span class="string">kubernetes</span> \</span><br><span class="line">    <span class="built_in">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span><br></pre></td></tr></tbody></table></figure><p>è¯¥æ–‡ä»¶ç”Ÿæˆä¹‹åéœ€è¦æ‹·è´è‡³workerèŠ‚ç‚¹ä¸Šé¢å»ï¼Œå¹¶ä¸”ä¿®æ”¹é…ç½®ï¼ŒæŒ‡å®šè¯¥å¼•å¯¼é…ç½®æ–‡ä»¶<br>è¿™ä¸ªæµç¨‹åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæœ‰æè¿°:<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/#bootstrap-initialization">bootstrapåˆå§‹åŒ–è¿‡ç¨‹</a></p><h3 id="2-2-3-è°ƒæ•´workerèŠ‚ç‚¹kubeletå¯åŠ¨é…ç½®æ–‡ä»¶åŠ ä¸Šè¿™ä¸ªå¼•å¯¼æ–‡ä»¶-å‚æ•°"><a href="#2-2-3-è°ƒæ•´workerèŠ‚ç‚¹kubeletå¯åŠ¨é…ç½®æ–‡ä»¶åŠ ä¸Šè¿™ä¸ªå¼•å¯¼æ–‡ä»¶-å‚æ•°" class="headerlink" title="2.2.3 è°ƒæ•´workerèŠ‚ç‚¹kubeletå¯åŠ¨é…ç½®æ–‡ä»¶åŠ ä¸Šè¿™ä¸ªå¼•å¯¼æ–‡ä»¶(å‚æ•°)"></a>2.2.3 è°ƒæ•´workerèŠ‚ç‚¹kubeletå¯åŠ¨é…ç½®æ–‡ä»¶åŠ ä¸Šè¿™ä¸ªå¼•å¯¼æ–‡ä»¶(å‚æ•°)</h3><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/kubelet</span><br><span class="line">  <span class="attr">--kubeconfig</span>=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  <span class="attr">--network-plugin</span>=cni \</span><br><span class="line">  <span class="attr">--cni-conf-dir</span>=/etc/cni/net.d \</span><br><span class="line">  <span class="attr">--cni-bin-dir</span>=/opt/cni/bin \</span><br><span class="line">  <span class="attr">--logtostderr</span>=<span class="literal">false</span> \</span><br><span class="line">  <span class="attr">--log-dir</span>=/etc/kubernetes/log \</span><br><span class="line">  <span class="attr">--config</span>=/etc/kubernetes/kubelet-conf.yml \</span><br><span class="line">  <span class="attr">--node-labels</span>=node-role.kubernetes.io/master=<span class="string">''</span> \</span><br><span class="line">  <span class="attr">--pod-infra-container-image</span>=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:<span class="number">3.1</span> \</span><br><span class="line">  <span class="attr">--v</span>=<span class="number">2</span></span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ—¶å¦‚æœå¯åŠ¨kubeletæœåŠ¡çš„è¯åœ¨apiserverå°†ä¼šæŠ¥é”™ï¼š<br><img src="/2018/12/30/kubernetes-bootstrapping/forbidden.jpg"></p><p>è¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œkubelet é€šè¿‡ bootstrap.kubeconfig ä¸­çš„é¢„è®¾ç”¨æˆ· Token å£°æ˜äº†è‡ªå·±çš„èº«ä»½ï¼Œç„¶ååˆ›å»º CSR è¯·æ±‚ï¼›ä½†æ˜¯ä¸è¦å¿˜è®°è¿™ä¸ªç”¨æˆ·åœ¨æˆ‘ä»¬ä¸å¤„ç†çš„æƒ…å†µä¸‹ä»–æ²¡ä»»ä½•æƒé™çš„ï¼ŒåŒ…æ‹¬åˆ›å»º CSR è¯·æ±‚ï¼›æ‰€ä»¥éœ€è¦å¦‚ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ª ClusterRoleBindingï¼Œå°†é¢„è®¾ç”¨æˆ· kubelet-bootstrap ä¸å†…ç½®çš„ ClusterRole system:node-bootstrapper ç»‘å®šåˆ°ä¸€èµ·ï¼Œä½¿å…¶èƒ½å¤Ÿå‘èµ· CSR è¯·æ±‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> kubelet-bootstrap-clusterrolebinding.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> kubelet-bootstrap</span><br><span class="line"><span class="params">roleRef:</span></span><br><span class="line">  <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line">  <span class="params">kind:</span> ClusterRole</span><br><span class="line">  <span class="params">name:</span> system:node-bootstrapper</span><br><span class="line"><span class="params">subjects:</span></span><br><span class="line"><span class="operator">-</span> <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line">  <span class="params">kind:</span> Group</span><br><span class="line">  <span class="params">name:</span> system:bootstrappers:default-node-token</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>å°†ä¸Šé¢åˆ›å»ºåå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡æ‰‹åŠ¨æ‰¹å‡†ä¹‹åworkerèŠ‚ç‚¹å°±åŠ å…¥åˆ°é›†ç¾¤å½“ä¸­æ¥äº†<br><img src="/2018/12/30/kubernetes-bootstrapping/result.jpg"><br>è€Œä¸”åœ¨workerèŠ‚ç‚¹çš„/var/lib/kubelet/pkiç›®å½•ä¸‹å·²ç»è·å¾—controller-manageré¢å‘ä¸‹æ¥çš„è¯ä¹¦,å¹¶ä¸”è¿˜åˆ†å‘äº†ä¸€ä¸ªkubelet.kubeconfigçš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶è™½ç„¶é…ç½®ä¸­æŒ‡å®šäº†ï¼Œä½†è¿™ä¸ªä¹Ÿæ˜¯ç”±controller-manageråˆ†å‘ç»™workerèŠ‚ç‚¹çš„ã€‚</p><figure class="highlight tap"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n0 kubernetes]<span class="comment"># ll /var/lib/kubelet/pki/</span></span><br><span class="line">total 12</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 1293 </span>Dec<span class="number"> 30 </span>10:14 kubelet-client-2018-12-30-10-14-50.pem</span><br><span class="line">lrwxrwxrwx<span class="number"> 1 </span>root root  <span class="number"> 59 </span>Dec<span class="number"> 30 </span>10:14 kubelet-client-current.pem -&gt; /var/lib/kubelet/pki/kubelet-client-2018-12-30-10-14-50.pem</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root<span class="number"> 2153 </span>Dec<span class="number"> 30 </span>10:14 kubelet.crt</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 1679 </span>Dec<span class="number"> 30 </span>10:14 kubelet.key</span><br></pre></td></tr></tbody></table></figure><p>è¿˜æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œé›†ç¾¤å·²ç»å®Œæˆï¼Œåœ¨æˆ‘æ‰§è¡Œexecæƒ³è¿›å…¥ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™å´å‡ºç°äº†forbiddençš„é—®é¢˜:</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m1 resources]# kubectl exec -it kubectl-terminal-ubuntu /bin/bash</span><br><span class="line">error: unable <span class="keyword">to</span><span class="built_in"> upgrade </span>connection: Forbidden (<span class="attribute">user</span>=kube-apiserver, <span class="attribute">verb</span>=create, <span class="attribute">resource</span>=nodes, <span class="attribute">subresource</span>=proxy)</span><br></pre></td></tr></tbody></table></figure><p>è¿™æ˜¯å› ä¸ºkube-apiserveruserå¹¶æ²¡æœ‰nodesçš„èµ„æºå­˜å–æƒé™,å±äºæ­£å¸¸ã€‚ç”±äº API æƒé™,æ•…éœ€è¦å»ºç«‹ä¸€ä¸ª RBAC Role æ¥è·å–å­˜å–æƒé™;</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> apiserver-to-kubelet-rbac.yml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> ClusterRole</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">annotations:</span></span><br><span class="line">    rbac.authorization.kubernetes.io<span class="operator">/</span><span class="params">autoupdate:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    kubernetes.io<span class="operator">/</span><span class="params">bootstrapping:</span> rbac-defaults</span><br><span class="line">  <span class="params">name:</span> system:kube-apiserver-to-kubelet</span><br><span class="line"><span class="params">rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">""</span></span><br><span class="line">    <span class="params">resources:</span></span><br><span class="line">      <span class="operator">-</span> nodes<span class="symbol">/proxy</span></span><br><span class="line">      <span class="operator">-</span> nodes<span class="symbol">/stats</span></span><br><span class="line">      <span class="operator">-</span> nodes<span class="symbol">/log</span></span><br><span class="line">      <span class="operator">-</span> nodes<span class="symbol">/spec</span></span><br><span class="line">      <span class="operator">-</span> nodes<span class="symbol">/metrics</span></span><br><span class="line">    <span class="params">verbs:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"*"</span></span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> system:kube-apiserver</span><br><span class="line">  <span class="params">namespace:</span> <span class="string">""</span></span><br><span class="line"><span class="params">roleRef:</span></span><br><span class="line">  <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line">  <span class="params">kind:</span> ClusterRole</span><br><span class="line">  <span class="params">name:</span> system:kube-apiserver-to-kubelet</span><br><span class="line"><span class="params">subjects:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line">    <span class="params">kind:</span> User</span><br><span class="line">    <span class="params">name:</span> kube-apiserver</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>åˆ›å»ºå¥½ä¹‹åå°±å¯ä»¥execå•¦~</p><p>ä»¥ä¸Šï¼ŒTLS Bootstrappingçš„æ‰‹åŠ¨æ‰¹å‡†å·²ç»å®Œæˆã€‚</p><h1 id="ä¸‰ã€è‡ªåŠ¨æ‰¹å‡†"><a href="#ä¸‰ã€è‡ªåŠ¨æ‰¹å‡†" class="headerlink" title="ä¸‰ã€è‡ªåŠ¨æ‰¹å‡†"></a>ä¸‰ã€è‡ªåŠ¨æ‰¹å‡†</h1><p>ä¸Šé¢å·²ç»å®Œæˆäº†æ‰‹åŠ¨æ‰¹å‡†çš„æ“ä½œï¼Œé‚£æ¥ä¸‹æ¥å°±æ˜¯å®ç°ä»¥ä¸‹è‡ªåŠ¨æ‰¹å‡†ä»¥åŠè¯ä¹¦è½®æ¢çš„å®ç°</p><p>ä¸Šé¢éœ€è¦çš„é…ç½®å…¶å®éƒ½å·®ä¸å¤šäº†ï¼Œåªéœ€è¦å†åšä¸€äº›é…ç½®å³å¯å®Œæˆï¼›</p><p>kubelet æ‰€å‘èµ·çš„ CSR è¯·æ±‚æ˜¯ç”± controller manager ç­¾ç½²çš„ï¼›å¦‚æœæƒ³è¦æ˜¯å®ç°è‡ªåŠ¨ç»­æœŸï¼Œå°±éœ€è¦è®© controller manager èƒ½å¤Ÿåœ¨ kubelet å‘èµ·è¯ä¹¦è¯·æ±‚çš„æ—¶å€™è‡ªåŠ¨å¸®åŠ©å…¶ç­¾ç½²è¯ä¹¦ï¼›é‚£ä¹ˆ controller manager ä¸å¯èƒ½å¯¹æ‰€æœ‰çš„ CSR è¯ä¹¦ç”³è¯·éƒ½è‡ªåŠ¨ç­¾ç½²ï¼Œè¿™æ—¶å€™å°±éœ€è¦é…ç½® RBAC è§„åˆ™ï¼Œä¿è¯ controller manager åªå¯¹ kubelet å‘èµ·çš„ç‰¹å®š CSR è¯·æ±‚è‡ªåŠ¨æ‰¹å‡†å³å¯ï¼›åœ¨ TLS bootstrapping å®˜æ–¹æ–‡æ¡£ä¸­ï¼ŒCSRæœ‰ä¸‰ç§è¯·æ±‚ç±»å‹:</p><ul><li>nodeclient: kubelet ä»¥ O=system:nodes å’Œ CN=system:node:(node name) å½¢å¼å‘èµ·çš„ CSR è¯·æ±‚</li><li>selfnodeclient: kubelet client renew è‡ªå·±çš„è¯ä¹¦å‘èµ·çš„ CSR è¯·æ±‚(ä¸ä¸Šä¸€ä¸ªè¯ä¹¦å°±æœ‰ç›¸åŒçš„ O å’Œ CN)</li><li>selfnodeserver: kubelet server renew è‡ªå·±çš„è¯ä¹¦å‘èµ·çš„ CSR è¯·æ±‚</li></ul><p>é€šä¿—ç‚¹è®²å°±æ˜¯:<br>nodeclient ç±»å‹çš„ CSR ä»…åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ä¼šäº§ç”Ÿï¼Œselfnodeclient ç±»å‹çš„ CSR è¯·æ±‚å®é™…ä¸Šå°±æ˜¯ kubelet renew è‡ªå·±ä½œä¸º client è·Ÿ apiserver é€šè®¯æ—¶ä½¿ç”¨çš„è¯ä¹¦äº§ç”Ÿçš„ï¼Œselfnodeserver ç±»å‹çš„ CSR è¯·æ±‚åˆ™æ˜¯ kubelet é¦–æ¬¡ç”³è¯·æˆ–åç»­ renew è‡ªå·±çš„ 10250 api ç«¯å£è¯ä¹¦æ—¶äº§ç”Ÿçš„</p><p>é‚£ä¹ˆé’ˆå¯¹ä»¥ä¸Š3ç§CSRè¯·æ±‚åˆ†åˆ«ç»™å‡ºäº†3ç§å¯¹åº”çš„ ClusterRoleï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a user requesting</span></span><br><span class="line"><span class="comment"># node client credentials.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:nodeclient</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">"certificates.k8s.io"</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">"certificatesigningrequests/nodeclient"</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">"create"</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node renewing its</span></span><br><span class="line"><span class="comment"># own client credentials.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">"certificates.k8s.io"</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">"certificatesigningrequests/selfnodeclient"</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">"create"</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span></span><br><span class="line"><span class="comment"># serving cert matching its client cert.</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">"certificates.k8s.io"</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">"certificatesigningrequests/selfnodeserver"</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">"create"</span>]</span><br></pre></td></tr></tbody></table></figure><p>å…¶ä¸­<code>selfnodeclient</code>,<code>nodeclient</code> å·²ç»æ˜¯é›†ç¾¤å†…ç½®çš„äº†;</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get clusterrole</span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">system:certificates.k8s.io:certificatesigningrequests:nodeclient       28h</span></span><br><span class="line"><span class="code">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   28h</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>ç„¶åæ˜¯ä¸‰ä¸ª ClusterRole å¯¹åº”çš„ ä¸‰ä¸ªClusterRoleBindingï¼›éœ€è¦æ³¨æ„çš„æ˜¯ åœ¨ä½¿ç”¨ Bootstrap Token è¿›è¡Œå¼•å¯¼æ—¶ï¼ŒKubelet ç»„ä»¶ä½¿ç”¨ Token å‘èµ·çš„è¯·æ±‚å…¶ç”¨æˆ·åä¸º<code>system:bootstrap:&lt;token id&gt;</code>ï¼Œç”¨æˆ·ç»„ä¸º system:bootstrappersï¼›æ‰€ä»¥ æˆ‘ä»¬åœ¨åˆ›å»º ClusterRoleBinding æ—¶è¦ç»‘å®šåˆ°è¿™ä¸ªç”¨æˆ·æˆ–è€…ç»„ä¸Šï¼›è¿™é‡Œæˆ‘é€‰æ‹©å…¨éƒ¨ç»‘å®šåˆ°ç»„ä¸Šï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; kubelet-bootstrap-rbac.yml &lt;&lt; EOF</span><br><span class="line"><span class="comment"># å…è®¸ system:bootstrappers ç»„ç”¨æˆ·åˆ›å»º CSR è¯·æ±‚</span></span><br><span class="line"><span class="comment"># (è¿™ä¸€æ­¥æˆ‘åœ¨ä¸Šé¢å·²ç»åšè¿‡å•¦)</span></span><br><span class="line">kubectl create clusterrolebinding kubelet-bootstrap <span class="attribute">--clusterrole</span>=system:node-bootstrapper <span class="attribute">--group</span>=system:bootstrappers</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</span></span><br><span class="line">kubectl create clusterrolebinding node-client-auto-approve-csr <span class="attribute">--clusterrole</span>=system:certificates.k8s.io:certificatesigningrequests:nodeclient <span class="attribute">--group</span>=system:bootstrappers</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</span></span><br><span class="line">kubectl create clusterrolebinding node-client-auto-renew-crt <span class="attribute">--clusterrole</span>=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient <span class="attribute">--group</span>=system:nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet 10250 api ç«¯å£è¯ä¹¦çš„ CSR è¯·æ±‚</span></span><br><span class="line">kubectl create clusterrolebinding node-server-auto-renew-crt <span class="attribute">--clusterrole</span>=system:certificates.k8s.io:certificatesigningrequests:selfnodeserver <span class="attribute">--group</span>=system:nodes</span><br></pre></td></tr></tbody></table></figure><p>å³: kubelet workerèŠ‚ç‚¹è¯ä¹¦æ‰‹åŠ¨æˆ–è‡ªåŠ¨æ‰¹å‡†éœ€è¦ç”¨åˆ°çš„è§’è‰²ä»¥åŠè§’è‰²ç»‘å®šæœ‰:</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># ClusterRole</span><br><span class="line">$ kubectl get clusterrole</span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">system:certificates.k8s.io:certificatesigningrequests:nodeclient       2d</span></span><br><span class="line"><span class="code">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   2d</span></span><br><span class="line"><span class="code">system:certificates.k8s.io:certificatesigningrequests:selfnodeserver   5m</span></span><br><span class="line"><span class="code">system:node-bootstrapper                                               2d</span></span><br><span class="line"><span class="code">system:kube-apiserver-to-kubelet                                       17h</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code"># ClusterRoleBinding</span></span><br><span class="line"><span class="code">$ kubectl get clusterrolebinding | grep auto</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">node-client-auto-approve-csr                           16h</span></span><br><span class="line"><span class="code">node-client-auto-renew-crt                             16h</span></span><br><span class="line"><span class="code">node-server-auto-renew-crt                             16h</span></span><br><span class="line"><span class="code">system:kube-apiserver                                  17h</span></span><br><span class="line"><span class="code">kubelet-bootstrap                                      18h</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>åˆ›å»ºå¥½å¯¹åº”çš„è§’è‰²åŠè§’è‰²ç»‘å®šä¹‹åå°±å¯ä»¥ä¿®æ”¹è¿™ä¸ªè¯ä¹¦çš„æœ‰æ•ˆæœŸå•¦ï¼›åªè¦åœ¨<code>Description=Kubernetes Controller Manager </code>æœåŠ¡çš„å¯åŠ¨é…ç½®å‚æ•°ä¸­åŠ å…¥:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">--experimental-cluster-signing-duration</span>=<span class="number">10</span>m0s \</span><br><span class="line"><span class="attr">--feature-gates</span>=RotateKubeletClientCertificate=<span class="literal">true</span> \</span><br><span class="line"><span class="attr">--feature-gates</span>=RotateKubeletServerCertificate=<span class="literal">true</span> </span><br></pre></td></tr></tbody></table></figure><p>ä»¥åŠkubeletæœåŠ¡å¯åŠ¨é…ç½®å‚æ•°ä¸­åŠ å…¥:</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">--feature-gates</span>=RotateKubeletClientCertificate=<span class="literal">true</span> \</span><br><span class="line"><span class="attr">--feature-gates</span>=RotateKubeletServerCertificate=<span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡æ–‡æ¡£äº†è§£åˆ°<code>--feature-gates</code> è¿™ä¸ªæ˜¯kubernetesä¸­ç‰¹æœ‰çš„ä¸€äº›åŠŸèƒ½ï¼Œæœ‰äº›åŠŸèƒ½æ˜¯å¤„äºå¼€å‘ç‰ˆæœ¬çš„ï¼Œå…·ä½“å¯ä»¥å‚çœ‹<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/">è¿™é‡Œ</a></p><p>ä»¥ä¸‹å°±æ˜¯kubeletè¿è¡Œä¸€æ®µæ—¶é—´åï¼Œé€šè¿‡åœ¨<code>controller-manager</code>è®¾ç½®çš„è¯ä¹¦æœ‰æ•ˆæœŸå¿«è¿‡æœŸçš„æ—¶å€™é€šè¿‡è‡ªåŠ¨ç”³è¯·å¹¶è‡ªåŠ¨æ‰¹å‡†çš„ç»“æœï¼›<br>å¯ä»¥çœ‹å‡ºæ¥<code>node-csr-ysGrNbyioCNnj3UUFiQGn5WwLGF1P6wJ4DTIib1IcqQ</code> è¿™ä¸ªCSRæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶çš„ç”¨æˆ·<code>system:bootstrap:fd2f4f</code>çš„è¯ä¹¦è¯·æ±‚ã€‚<br><img src="/2018/12/30/kubernetes-bootstrapping/result2.jpg"></p><p>å¹¶ä¸”åœ¨è¯ä¹¦è½®æ¢çš„è¿‡ç¨‹ä¹Ÿå¯ä»¥é€šè¿‡æ—¥å¿—å‘ç°</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Dec</span> <span class="number">31</span> <span class="number">04</span>:<span class="number">10</span>:<span class="number">06</span> k8s-n0 kubelet: I1231 <span class="number">17</span>:<span class="number">10</span>:<span class="number">06</span>.<span class="number">753064</span>   <span class="number">18294</span> transport.go:<span class="number">132</span>] certificate rotation detected, shutting down client connections to start using new credentials</span><br></pre></td></tr></tbody></table></figure><p>é‚£ä¹ˆä»¥ä¸Šå°±æ˜¯kubeletè¯ä¹¦çš„æ•´ä¸ªæ‰¹å‡†ä»¥åŠè¯ä¹¦è½®æ¢çš„è¿‡ç¨‹ã€‚</p><h1 id="å››ã€TLS-Bootstrappingæ€»ç»“"><a href="#å››ã€TLS-Bootstrappingæ€»ç»“" class="headerlink" title="å››ã€TLS Bootstrappingæ€»ç»“"></a>å››ã€TLS Bootstrappingæ€»ç»“</h1><p>æµç¨‹æ€»ç»“</p><ol><li><p>kubelet é¦–æ¬¡å¯åŠ¨é€šè¿‡åŠ è½½<code> bootstrap.kubeconfig</code> ä¸­çš„ç”¨æˆ· Token å’Œ apiserver CA è¯ä¹¦å‘èµ·é¦–æ¬¡ CSR è¯·æ±‚ï¼Œè¿™ä¸ª Token è¢«é¢„å…ˆå†…ç½®åœ¨ apiserver èŠ‚ç‚¹çš„ token.csv(æ–°ç‰ˆæœ¬ä¸­å·²ç»æ¨èä½¿ç”¨Bootstrap Token Secert) ä¸­ï¼Œå…¶èº«ä»½ä¸º <code>kubelet-bootstrap</code> ç”¨æˆ·å’Œ <code>system:bootstrappers</code> ç”¨æˆ·ç»„ï¼›æƒ³è¦é¦–æ¬¡ CSR è¯·æ±‚èƒ½æˆåŠŸ(æˆåŠŸæŒ‡çš„æ˜¯ä¸ä¼šè¢« apiserver 401 æ‹’ç»)ï¼Œåˆ™éœ€è¦å…ˆå°† <code>kubelet-bootstrap</code> ç”¨æˆ·å’Œ <code>system:node-bootstrapper</code> å†…ç½® ClusterRole ç»‘å®šï¼›</p></li><li><p>å¯¹äºé¦–æ¬¡ CSR è¯·æ±‚å¯ä»¥æ‰‹åŠ¨ç­¾å‘ï¼Œä¹Ÿå¯ä»¥å°† <code>system:bootstrappers</code> ç”¨æˆ·ç»„ä¸ <code>approve-node-client-csr</code> ClusterRole ç»‘å®šå®ç°è‡ªåŠ¨ç­¾å‘(1.8 ä¹‹å‰è¿™ä¸ª ClusterRole éœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼Œ1.8 å apiserver è‡ªåŠ¨åˆ›å»ºï¼Œå¹¶æ›´åä¸º <code>system:certificates.k8s.io:certificatesigningrequests:nodeclient</code>)</p></li><li><p>é»˜è®¤ç­¾ç½²çš„çš„è¯ä¹¦åªæœ‰ 1 å¹´æœ‰æ•ˆæœŸï¼Œå¦‚æœæƒ³è¦è°ƒæ•´è¯ä¹¦æœ‰æ•ˆæœŸå¯ä»¥é€šè¿‡è®¾ç½® kube-controller-manager çš„ <code>--experimental-cluster-signing-duration</code> å‚æ•°å®ç°ï¼Œè¯¥å‚æ•°é»˜è®¤å€¼ä¸º 8760h0m0s</p></li><li><p>å¯¹äºè¯ä¹¦è½®æ¢ï¼Œéœ€è¦é€šè¿‡åè°ƒä¸¤ä¸ªæ–¹é¢å®ç°ï¼›ç¬¬ä¸€ï¼Œæƒ³è¦ kubelet åœ¨è¯ä¹¦åˆ°æœŸåè‡ªåŠ¨å‘èµ·ç»­æœŸè¯·æ±‚ï¼Œåˆ™éœ€è¦åœ¨ kubelet å¯åŠ¨æ—¶å¢åŠ  <code>--feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true</code> æ¥å®ç°ï¼›ç¬¬äºŒï¼Œæƒ³è¦è®© controller manager è‡ªåŠ¨æ‰¹å‡†ç»­ç­¾çš„ CSR è¯·æ±‚éœ€è¦åœ¨ controller manager å¯åŠ¨æ—¶å¢åŠ  <code>--feature-gates=RotateKubeletServerCertificate=true</code> å‚æ•°ï¼Œå¹¶ç»‘å®šå¯¹åº”çš„ RBAC è§„åˆ™</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ä¸€ã€æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#ä¸€ã€æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€æ¦‚è¿°&quot;&gt;&lt;/a&gt;ä¸€ã€æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;æœ¬æ–‡ä¸»è¦è®°å½•ä¸€ä¸‹æ­å»ºä¸€ä¸ªkubeletæ­å»ºåˆ°åŠ å…¥é›†ç¾¤åˆ°æ‰‹åŠ¨ã€è‡ªåŠ¨(è¯ä¹¦è½®æ¢çš„)è¯ä¹¦è®¤è¯è¿‡ç¨‹, é‚£ä¹ˆæˆ‘çš„ç¯å¢ƒæ˜¯ç”¨çš„v1.12.4ç‰ˆæœ¬ï¼Œæœ‰ä¸€å°master,é™¤äº†masterä¸Šé¢çš„ä¸€äº›ç»„ä»¶å·²ç»æ­å»ºå®Œæ¯•ï¼Œä¸»è¦é‡ç‚¹æ˜¯åœ¨kubeletä¸Šé¢ï¼Œæ‰€ä»¥ç°åœ¨å°±æ˜¯masterå·²ç»å·¥ä½œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼ŒåŠ å…¥æ–°çš„&lt;code&gt;kubelet(workerèŠ‚ç‚¹)&lt;/code&gt;éœ€è¦åšä¸€äº›ä»€ä¹ˆæ ·çš„æ“ä½œã€‚&lt;br&gt;ç„¶åéœ€è¦å®ç°çš„æ˜¯:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é€šè¿‡bootstrap tokenä»¥åŠboostrap.kubeconfigæ¥å¼•å¯¼workerèŠ‚ç‚¹ç”³è¯·è¯ä¹¦&lt;/li&gt;
&lt;li&gt;å¦‚æœç¬¬ä¸€æ­¥ç”³è¯·å‘å‡ºå»ä¹‹åï¼Œåœ¨æ‰‹åŠ¨åœ¨masterç«¯è¿›è¡Œæ‰‹åŠ¨æ‰¹å‡†è¯ä¹¦ç”³è¯·ï¼Œç„¶åå‘æ”¾kubeletè¯ä¹¦&lt;/li&gt;
&lt;li&gt;å®ç°kubeletè¯ä¹¦çš„è‡ªåŠ¨æ‰¹å‡†&lt;/li&gt;
&lt;li&gt;å®ç°kubeletè¯ä¹¦çš„è‡ªåŠ¨è½®æ¢æ“ä½œ&lt;br&gt;&lt;img src=&quot;/2018/12/30/kubernetes-bootstrapping/start.png&quot;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ç®€å•ç†ä¸€ä¸‹TLS Bootstrappingçš„ä¸€ä¸ªå¼•å¯¼è¿‡ç¨‹&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;masterç«¯åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯å³ç”Ÿæˆ &lt;code&gt;apiserver.pem/apiserver-key.pem/apiserver.csr&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;åœ¨é›†ç¾¤å†…åˆ›å»ºç‰¹å®šçš„ Bootstrap Token Secretï¼Œè¯¥ Secret å°†æ›¿ä»£ä»¥å‰çš„ token.csv å†…ç½®ç”¨æˆ·å£°æ˜æ–‡ä»¶;&lt;/li&gt;
&lt;li&gt;åœ¨é›†ç¾¤å†…åˆ›å»ºé¦–æ¬¡ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„ ClusterRole å³&lt;code&gt;system:node-bootstrapper&lt;/code&gt;,å¹¶å°†ä¸Šé¢çš„bootstrap token secretè¿›è¡Œç»‘å®šå³ clusterrolebinding &lt;code&gt;kubelet-bootstrap&lt;/code&gt;ï¼Œè¿™æ ·é€šè¿‡ç»‘å®šå°±èƒ½ä»¥è¿™ä¸ªå†…ç½®ç”¨æˆ·ç»„ä¿¡æ¯å»å‘èµ·CSRè¯·æ±‚å•¦ï¼›&lt;/li&gt;
&lt;li&gt;ç”Ÿæˆç‰¹å®šçš„åŒ…å« &lt;code&gt;TLS Bootstrapping Token&lt;/code&gt; çš„ &lt;code&gt;bootstrap.kubeconfig&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;è°ƒæ•´kubeleteå¯åŠ¨å‚æ•°ï¼ŒæŒ‡å®šå¼•å¯¼æ–‡ä»¶&lt;code&gt;bootstrap.kubeconfig&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;é‡è½½é…ç½®ã€é‡å¯æœåŠ¡ï¼Œmasterç«¯æ‰‹åŠ¨æ‰¹å‡†å®ŒæˆworkerèŠ‚ç‚¹çš„CSRè¯·æ±‚;&lt;/li&gt;
&lt;li&gt;åç»­å¦‚æœæ²¡æœ‰é…ç½®è¯ä¹¦è½®æ¢çš„è¯ï¼Œå°±ä¼šä¸€ç›´ä½¿ç”¨ç”±controller-manageræ‰¹å‡†é¢å‘çš„è¯ä¹¦æ–‡ä»¶äº†ï¼Œæœ‰æ•ˆæœŸæ˜¯ä¸€å¹´ã€‚(è‡ªåŠ¨æ‰¹å‡†&amp;amp;è¯ä¹¦è½®æ¢ä¸‹é¢å†è¯´)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å½“ç„¶ä»¥æˆ‘çš„ç†è§£è¦è¦å®ç°è¯ä¹¦è½®æ¢é‚£ä¹ˆè‚¯å®šæ˜¯æ²¡æœ‰å¤–ç•Œå¹²é¢„çš„æƒ…å†µä¸‹è‡ªåŠ¨æ‰§è¡Œçš„ï¼Œé‚£è¿™ä¸ªåŠŸèƒ½ä¹Ÿè‚¯å®šæ˜¯éœ€è¦è‡ªåŠ¨æ‰¹å‡†è¿™ä¸ªåŠŸèƒ½çš„ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆè‡ªåŠ¨æ‰¹å‡†éœ€è¦åšçš„ä¸€äº›äº‹æƒ…å´æ˜¯åœ¨æ‰‹åŠ¨æ‰¹å‡†çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›æ“ä½œ:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åˆ›å»ºCSRè¯·æ±‚çš„ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„renew Kubelet client/server çš„ ClusterRoleï¼Œä»¥åŠå…¶ç›¸å…³å¯¹åº”çš„ ClusterRoleBindingï¼›å¹¶ç»‘å®šåˆ°å¯¹åº”çš„ç»„æˆ–ç”¨æˆ·&lt;/li&gt;
&lt;li&gt;è°ƒæ•´ Controller Manager é…ç½®ï¼Œä»¥ä½¿å…¶èƒ½è‡ªåŠ¨ç­¾ç½²ç›¸å…³è¯ä¹¦å’Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ TLS Bootstrapping Token&lt;/li&gt;
&lt;li&gt;å¯é€‰çš„: é›†ç¾¤æ­å»ºæˆåŠŸåç«‹å³æ¸…é™¤ Bootstrap Token Secretï¼Œæˆ–ç­‰å¾… Controller Manager å¾…å…¶è¿‡æœŸååˆ é™¤ï¼Œä»¥é˜²æ­¢è¢«æ¶æ„åˆ©ç”¨&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;äºŒã€æ‰‹åŠ¨æ‰¹å‡†&quot;&gt;&lt;a href=&quot;#äºŒã€æ‰‹åŠ¨æ‰¹å‡†&quot; class=&quot;headerlink&quot; title=&quot;äºŒã€æ‰‹åŠ¨æ‰¹å‡†&quot;&gt;&lt;/a&gt;äºŒã€æ‰‹åŠ¨æ‰¹å‡†&lt;/h1&gt;&lt;h2 id=&quot;2-1-åˆ›å»ºAPI-Serverå’ŒKubelet-Clienté€šä¿¡å‡­è¯&quot;&gt;&lt;a href=&quot;#2-1-åˆ›å»ºAPI-Serverå’ŒKubelet-Clienté€šä¿¡å‡­è¯&quot; class=&quot;headerlink&quot; title=&quot;2.1 åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯&quot;&gt;&lt;/a&gt;2.1 åˆ›å»ºAPI Serverå’ŒKubelet Clienté€šä¿¡å‡­è¯&lt;/h2&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/tags/kubernetes/"/>
    
    <category term="TLS bootstrapping" scheme="https://blog.sctux.cc/tags/TLS-bootstrapping/"/>
    
    <category term="è¯ä¹¦æ‰‹åŠ¨ç­¾å‘" scheme="https://blog.sctux.cc/tags/%E8%AF%81%E4%B9%A6%E6%89%8B%E5%8A%A8%E7%AD%BE%E5%8F%91/"/>
    
    <category term="è¯ä¹¦è‡ªåŠ¨ç­¾å‘" scheme="https://blog.sctux.cc/tags/%E8%AF%81%E4%B9%A6%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%8F%91/"/>
    
    <category term="è¯ä¹¦è½®æ¢(è‡ªåŠ¨ç»­æœŸ)" scheme="https://blog.sctux.cc/tags/%E8%AF%81%E4%B9%A6%E8%BD%AE%E6%8D%A2-%E8%87%AA%E5%8A%A8%E7%BB%AD%E6%9C%9F/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£Kuberneteså®‰å…¨çš„æŒä¹…åŒ–ä¿å­˜é”®å€¼-Etcd</title>
    <link href="https://blog.sctux.cc/2018/12/23/kubernetes-etcd-secret/"/>
    <id>https://blog.sctux.cc/2018/12/23/kubernetes-etcd-secret/</id>
    <published>2018-12-23T06:47:38.000Z</published>
    <updated>2025-09-01T01:59:08.942Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>etcdæ˜¯CoreOSå›¢é˜Ÿäº2013å¹´6æœˆå‘èµ·çš„å¼€æºé¡¹ç›®ï¼Œå®ƒçš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªé«˜å¯ç”¨çš„åˆ†å¸ƒå¼é”®å€¼(key-value)æ•°æ®åº“ã€‚etcdå†…éƒ¨é‡‡ç”¨raftåè®®ä½œä¸ºä¸€è‡´æ€§ç®—æ³•ï¼ŒetcdåŸºäºGoè¯­è¨€å®ç°ã€‚</p><p>etcdä½œä¸ºæœåŠ¡å‘ç°ç³»ç»Ÿï¼Œæœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š</p><p>ç®€å•ï¼šå®‰è£…é…ç½®ç®€å•ï¼Œè€Œä¸”æä¾›äº†HTTP APIè¿›è¡Œäº¤äº’ï¼Œä½¿ç”¨ä¹Ÿå¾ˆç®€å•<br>å®‰å…¨ï¼šæ”¯æŒSSLè¯ä¹¦éªŒè¯<br>å¿«é€Ÿï¼šæ ¹æ®å®˜æ–¹æä¾›çš„benchmarkæ•°æ®ï¼Œå•å®ä¾‹æ”¯æŒæ¯ç§’2k+è¯»æ“ä½œ<br>å¯é ï¼šé‡‡ç”¨raftç®—æ³•ï¼Œå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®çš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§</p><p>etcdé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/coreos/etcd/">https://github.com/coreos/etcd/</a></p><h2 id="kubernetesä¸­çš„ä½¿ç”¨"><a href="#kubernetesä¸­çš„ä½¿ç”¨" class="headerlink" title="kubernetesä¸­çš„ä½¿ç”¨"></a>kubernetesä¸­çš„ä½¿ç”¨</h2><p>ç›®å‰etcdæ˜¯ä½œä¸ºkubernetesé›†ç¾¤å½“ä¸­çš„å­˜å‚¨åç«¯</p><p>åœ¨kuernetesä¸­etcdæ¶‰åŠåˆ°çš„å®‰å…¨ç›¸å…³çš„ä¸»è¦æœ‰:</p><ul><li>etcdæ”¯æŒå¤‡ä»½æ¢å¤æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®è¢«è¯¯åˆ å¯¼è‡´æ•°æ®ä¸¢å¤±</li><li>ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯å»ºè®®æ”¾åœ¨secretç±»å‹çš„èµ„æºä¸­ï¼Œè¯¥ç±»å‹èµ„æºæ˜¯åŠ å¯†å­˜å‚¨åœ¨etcdä¸­çš„</li><li>etcdæ”¯æŒhttps, kube-apiserverè®¿é—®etcdä½¿ç”¨httpsåè®®</li></ul><p><img src="/2018/12/23/kubernetes-etcd-secret/etcd.png"></p><p>åœ¨kubernetesä¸­çš„é…ç½®:</p><h3 id="Client-Server"><a href="#Client-Server" class="headerlink" title="Client -> Server"></a>Client -&gt; Server</h3><figure class="highlight nsis"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">client-transport-security:</span><br><span class="line">  <span class="comment"># é€šé“ä»¥TLSåè®®åŠ å¯†</span></span><br><span class="line">  ca-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-ca.pem'</span></span><br><span class="line">  cert-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd.pem'</span> </span><br><span class="line">  key-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-key.pem'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æœåŠ¡ç«¯ä¼šè®¤è¯å®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦å—ä¿¡ä»»CAç­¾å‘</span></span><br><span class="line">  client-cert-auth: <span class="literal">true</span></span><br><span class="line">  trusted-ca-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-ca.pem'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ˜¯å¦ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆè¯ä¹¦</span></span><br><span class="line">  <span class="literal">auto</span>-tls: <span class="literal">true</span> </span><br></pre></td></tr></tbody></table></figure><h3 id="Server-Server"><a href="#Server-Server" class="headerlink" title="Server -> Server"></a>Server -&gt; Server</h3><figure class="highlight nsis"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">peer-transport-security:</span><br><span class="line">  <span class="comment"># é€šé“ä»¥TLSåè®®åŠ å¯†</span></span><br><span class="line">  ca-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-ca.pem'</span></span><br><span class="line">  cert-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd.pem'</span></span><br><span class="line">  key-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-key.pem'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æœåŠ¡ç«¯ä¼šè®¤è¯å®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦å—ä¿¡ä»»CAç­¾å‘</span></span><br><span class="line">  peer-client-cert-auth: <span class="literal">true</span></span><br><span class="line">  trusted-ca-<span class="keyword">file</span>: <span class="string">'/etc/etcd/ssl/etcd-ca.pem'</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ˜¯å¦ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆè¯ä¹¦</span></span><br><span class="line">  <span class="literal">auto</span>-tls: <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><h3 id="etcdçš„å¤‡ä»½"><a href="#etcdçš„å¤‡ä»½" class="headerlink" title="etcdçš„å¤‡ä»½"></a>etcdçš„å¤‡ä»½</h3><p>å¯¹äº API 3 å¤‡ä»½ä¸æ¢å¤æ–¹æ³•<br>å®˜æ–¹ v3 admin guide<br>åœ¨ä½¿ç”¨ API 3 æ—¶éœ€è¦ä½¿ç”¨ç¯å¢ƒå˜é‡ ETCDCTL_API æ˜ç¡®æŒ‡å®šã€‚<br>åœ¨å‘½ä»¤è¡Œè®¾ç½®ï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> <span class="attribute">ETCDCTL_API</span>=3</span><br></pre></td></tr></tbody></table></figure><p>å¤‡ä»½æ•°æ®ï¼š</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl <span class="attr">--endpoints</span>=<span class="selector-attr">[localhost:2379]</span> snapshot save snapshot<span class="selector-class">.db</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>æ¢å¤ï¼š</p><figure class="highlight pgsql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl <span class="keyword">snapshot</span> restore <span class="keyword">snapshot</span>.db <span class="comment">--name m3 --data-dir=/home/etcd_data</span></span><br></pre></td></tr></tbody></table></figure><p>æ¢å¤åçš„æ–‡ä»¶éœ€è¦ä¿®æ”¹æƒé™ä¸º etcd:etcd<br>â€“name:é‡æ–°æŒ‡å®šä¸€ä¸ªæ•°æ®ç›®å½•ï¼Œå¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤ä¸º default.etcd<br>â€“data-dirï¼šæŒ‡å®šæ•°æ®ç›®å½•<br>å»ºè®®ä½¿ç”¨æ—¶ä¸æŒ‡å®š name ä½†æŒ‡å®š data-dirï¼Œå¹¶å°† data-dir å¯¹åº”äº etcd æœåŠ¡ä¸­é…ç½®çš„ data-dir</p><p>etcd é›†ç¾¤éƒ½æ˜¯è‡³å°‘ 3 å°æœºå™¨ï¼Œå®˜æ–¹ä¹Ÿè¯´æ˜äº†é›†ç¾¤å®¹é”™ä¸º (N-1)/2ï¼Œæ‰€ä»¥å¤‡ä»½æ•°æ®ä¸€èˆ¬éƒ½æ˜¯ç”¨ä¸åˆ°ï¼Œä½†æ˜¯é‰´ä¸Šæ¬¡ gitlab å‡ºç°çš„é—®é¢˜ï¼Œå¯¹äºå¤‡ä»½æ•°æ®ä¹Ÿè¦éå¸¸é‡è§†ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;etcdæ˜¯CoreOSå›¢é˜Ÿäº2013å¹´6æœˆå‘èµ·çš„å¼€æºé¡¹ç›®ï¼Œå®ƒçš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªé«˜å¯ç”¨çš„åˆ†å¸ƒå¼é”®å€¼(key-value)æ•°æ®åº“ã€‚etcdå†…éƒ¨é‡‡ç”¨raftåè®®ä½œä¸ºä¸€è‡´æ€§ç®—æ³•ï¼ŒetcdåŸºäºGoè¯­è¨€å®ç°ã€‚&lt;/p&gt;
&lt;p&gt;etcdä½œä¸ºæœåŠ¡å‘ç°ç³»ç»Ÿï¼Œæœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š&lt;/p&gt;
&lt;p&gt;ç®€å•ï¼šå®‰è£…é…ç½®ç®€å•ï¼Œè€Œä¸”æä¾›äº†HTTP APIè¿›è¡Œäº¤äº’ï¼Œä½¿ç”¨ä¹Ÿå¾ˆç®€å•&lt;br&gt;å®‰å…¨ï¼šæ”¯æŒSSLè¯ä¹¦éªŒè¯&lt;br&gt;å¿«é€Ÿï¼šæ ¹æ®å®˜æ–¹æä¾›çš„benchmarkæ•°æ®ï¼Œå•å®ä¾‹æ”¯æŒæ¯ç§’2k+è¯»æ“ä½œ&lt;br&gt;å¯é ï¼šé‡‡ç”¨raftç®—æ³•ï¼Œå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®çš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§&lt;/p&gt;
&lt;p&gt;etcdé¡¹ç›®åœ°å€ï¼š&lt;a href=&quot;https://github.com/coreos/etcd/&quot;&gt;https://github.com/coreos/etcd/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;kubernetesä¸­çš„ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#kubernetesä¸­çš„ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;kubernetesä¸­çš„ä½¿ç”¨&quot;&gt;&lt;/a&gt;kubernetesä¸­çš„ä½¿ç”¨&lt;/h2&gt;&lt;p&gt;ç›®å‰etcdæ˜¯ä½œä¸ºkubernetesé›†ç¾¤å½“ä¸­çš„å­˜å‚¨åç«¯&lt;/p&gt;
&lt;p&gt;åœ¨kuernetesä¸­etcdæ¶‰åŠåˆ°çš„å®‰å…¨ç›¸å…³çš„ä¸»è¦æœ‰:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;etcdæ”¯æŒå¤‡ä»½æ¢å¤æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®è¢«è¯¯åˆ å¯¼è‡´æ•°æ®ä¸¢å¤±&lt;/li&gt;
&lt;li&gt;ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯å»ºè®®æ”¾åœ¨secretç±»å‹çš„èµ„æºä¸­ï¼Œè¯¥ç±»å‹èµ„æºæ˜¯åŠ å¯†å­˜å‚¨åœ¨etcdä¸­çš„&lt;/li&gt;
&lt;li&gt;etcdæ”¯æŒhttps, kube-apiserverè®¿é—®etcdä½¿ç”¨httpsåè®®&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;/2018/12/23/kubernetes-etcd-secret/etcd.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/tags/kubernetes/"/>
    
    <category term="etcd cluster" scheme="https://blog.sctux.cc/tags/etcd-cluster/"/>
    
    <category term="etcd secret" scheme="https://blog.sctux.cc/tags/etcd-secret/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£kubernetesä¸­çš„é™æ€Pod</title>
    <link href="https://blog.sctux.cc/2018/12/22/kubernetes-static-pod/"/>
    <id>https://blog.sctux.cc/2018/12/22/kubernetes-static-pod/</id>
    <published>2018-12-22T03:02:30.000Z</published>
    <updated>2025-09-01T01:59:08.872Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>ä»Šå„¿æ˜¯å†¬è‡³ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œå­¦ä¹ çš„è„šæ­¥è¿˜æ˜¯ä¸èƒ½åœä¸‹ï¼Œä»Šå¤©å­¦ä¹ å®è·µä¸€ä¸‹kubernetesä¸­çš„é™æ€podæ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“åœ¨å‰é¢Podçš„å£°æ˜å‘¨æœŸç®¡ç†éƒ½æ˜¯é€šè¿‡åƒDaemonSetã€StatefulSetã€Deploymentè¿™ç§æ–¹å¼åˆ›å»ºç®¡ç†çš„ï¼Œè€Œå®˜æ–¹æ–‡æ¡£ä»‹ç»äº†ä¸€ç§ç‰¹æ®Šçš„podå°±æ˜¯é™æ€Podï¼Œ</p><h2 id="ä»€ä¹ˆæ˜¯é™æ€Pod"><a href="#ä»€ä¹ˆæ˜¯é™æ€Pod" class="headerlink" title="ä»€ä¹ˆæ˜¯é™æ€Pod"></a>ä»€ä¹ˆæ˜¯é™æ€Pod</h2><p>é™æ€Podæ˜¯ç”±kubeletè¿›è¡Œç®¡ç†ï¼Œä»…å­˜åœ¨äºç‰¹å®šNodeä¸Šçš„Podã€‚å®ƒä»¬ä¸èƒ½é€šè¿‡API Serverè¿›è¡Œç®¡ç†ï¼Œæ— æ³•ä¸ReplicationControllerã€Deploymentæˆ–DaemonSetè¿›è¡Œå…³è”ï¼Œå¹¶ä¸”kubeletä¹Ÿæ— æ³•å¯¹å…¶å¥åº·æ£€æŸ¥ã€‚</p><h3 id="é™æ€Podçš„åˆ›å»º"><a href="#é™æ€Podçš„åˆ›å»º" class="headerlink" title="é™æ€Podçš„åˆ›å»º:"></a>é™æ€Podçš„åˆ›å»º:</h3><p>é™æ€podå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼åˆ›å»ºï¼šä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–HTTPã€‚</p><h4 id="é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º"><a href="#é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º" class="headerlink" title="é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º"></a>é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º</h4><p>é…ç½®æ–‡ä»¶åªæ˜¯ç‰¹å®šç›®å½•ä¸­jsonæˆ–yamlæ ¼å¼çš„æ ‡å‡†podå®šä¹‰ã€‚ä»–é€šè¿‡åœ¨kubeletå®ˆæŠ¤è¿›ç¨‹ä¸­æ·»åŠ é…ç½®å‚æ•°<code>--pod-manifest-path=&lt;the directory&gt;</code> æ¥è¿è¡Œé™æ€Podï¼Œkubeletç»å¸¸ä¼šå®ƒå®šæœŸæ‰«æç›®å½•ï¼›</p><p>ä¾‹å¦‚ï¼Œå¦‚ä½•å°†ä¸€ä¸ªç®€å•webæœåŠ¡ä½œä¸ºé™æ€podå¯åŠ¨</p><p>é€‰æ‹©è¿è¡Œé™æ€podçš„èŠ‚ç‚¹æœåŠ¡å™¨<br>ä¸ä¸€å®šæ˜¯nodeèŠ‚ç‚¹ï¼Œåªè¦æœ‰kubeletè¿›ç¨‹æ‰€åœ¨çš„èŠ‚ç‚¹éƒ½å¯ä»¥è¿è¡Œé™æ€pod</p><p>æˆ‘åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªæ”¾ç½®ä¸€ä¸ªWebæœåŠ¡å™¨podå®šä¹‰çš„æè¿°æ–‡ä»¶æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚/etc/kubelet.d/static-web.yaml</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir <span class="operator">/</span>etc<span class="operator">/</span>kubelet.d<span class="symbol">/</span></span><br><span class="line">$ cat <span class="operator">&lt;</span><span class="operator">&lt;</span>EOF <span class="operator">&gt;</span><span class="symbol">/etc/kubelet.d/static-web.yaml</span></span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> static-web</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">role:</span> myrole</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> web</span><br><span class="line">      <span class="params">image:</span> nginx</span><br><span class="line">      <span class="params">ports:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> web</span><br><span class="line">          <span class="params">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="params">protocol:</span> TCP</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ ls <span class="operator">/</span>etc<span class="operator">/</span>kubelet.d<span class="symbol">/</span></span><br><span class="line">static-web.yaml</span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡ä½¿ç”¨â€“pod-manifest-path=/etc/kubelet.d/å‚æ•°è¿è¡Œå®ƒï¼Œåœ¨èŠ‚ç‚¹ä¸Šé…ç½®æˆ‘çš„kubeletå®ˆæŠ¤ç¨‹åºä»¥ä½¿ç”¨æ­¤ç›®å½•ã€‚<br>æ¯”å¦‚æˆ‘è¿™é‡Œkubeletå¯åŠ¨å‚æ•°ä½äº/etc/systemd/system/kubelet.service.d/10-kubelet.conf, ä¿®æ”¹é…ç½®ï¼Œç„¶åå°†å‚æ•°åŠ å…¥åˆ°ç°æœ‰å‚æ•°é…ç½®é¡¹ä¸­(å®‰è£…æ–¹å¼ä¸å°½ç›¸åŒï¼Œä½†æ˜¯é“ç†ä¸€æ ·)</p><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">vim</span> /etc/systemd/<span class="built_in">system</span>/kubelet.service.d/<span class="number">10</span>-kubelet.<span class="keyword">conf</span></span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line">Environment=<span class="string">"KUBELET_EXTRA_ARGS=--cluster-dns=10.96.0.10 --cluster-domain=cluster.local --pod-manifest-path=/etc/kubelet.d/"</span></span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br></pre></td></tr></tbody></table></figure><p>ä¿å­˜é€€å‡ºï¼Œreloadä¸€ä¸‹systemd daeomon ,é‡å¯kubeletæœåŠ¡è¿›ç¨‹</p><figure class="highlight crystal"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>systemctl daemon-reload</span><br><span class="line"><span class="variable">$ </span>systemctl restart kubelet</span><br></pre></td></tr></tbody></table></figure><p>å‰é¢è¯´å•¦ï¼Œå½“kubeletå¯åŠ¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å¯åŠ¨åœ¨æŒ‡å®šçš„ç›®å½•â€“pod-manifest-path=æˆ–â€“manifest-url=å‚æ•°ä¸­å®šä¹‰çš„æ‰€æœ‰pod ï¼Œå³æˆ‘ä»¬çš„static-webã€‚<br>å†è¯¥èŠ‚ç‚¹ä¸Šæ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                READY     STATUS    RESTARTS   AGE       IP            <span class="keyword">NODE</span>    </span><br><span class="line"><span class="title">static-web-k8s-m1</span>   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">2m</span>        <span class="number">10.244</span>.<span class="number">2.32</span>   k8s-m1</span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢ä¹Ÿæåˆ°äº†ï¼Œä»–ä¸å½’ä»»ä½•éƒ¨ç½²æ–¹å¼æ¥ç®¡ç†ï¼Œå³ä½¿æˆ‘ä»¬å°è¯•kubeletå‘½ä»¤å»åˆ é™¤</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod static-web-k8s-m1</span><br><span class="line">pod <span class="string">"static-web-k8s-m1"</span> deleted</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                READY     STATUS    RESTARTS   AGE       IP        <span class="keyword">NODE</span>      <span class="title">NOMINATED</span> <span class="keyword">NODE</span></span><br><span class="line"><span class="title">static-web-k8s-m1</span>   <span class="number">0</span>/<span class="number">1</span>       Pending   <span class="number">0</span>          <span class="number">2s</span>        <span class="tag">&lt;none&gt;</span>    k8s-m1    <span class="tag">&lt;none&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹å‡ºé™æ€podé€šè¿‡è¿™ç§æ–¹å¼æ˜¯æ²¡æ³•åˆ é™¤çš„</p><p>é‚£æˆ‘å¦‚ä½•å»åˆ é™¤æˆ–è€…è¯´æ˜¯åŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªpodå‘¢ï¼Ÿ<br>è¿™ç§æœºåˆ¶å·²ç»çŸ¥é“ï¼Œkubeletè¿›ç¨‹ä¼šå®šæœŸæ‰«æé…ç½®çš„ç›®å½•ï¼ˆ/etc/kubelet.dåœ¨æˆ‘çš„ç¤ºä¾‹ï¼‰ä»¥è¿›è¡Œæ›´æ”¹ï¼Œå¹¶åœ¨æ–‡ä»¶å‡ºç°/æ¶ˆå¤±åœ¨æ­¤ç›®å½•ä¸­æ—¶æ·»åŠ /åˆ é™¤podã€‚</p><h4 id="é€šè¿‡urlæ¥åˆ›å»º"><a href="#é€šè¿‡urlæ¥åˆ›å»º" class="headerlink" title="é€šè¿‡urlæ¥åˆ›å»º:"></a>é€šè¿‡urlæ¥åˆ›å»º:</h4><p>ä¾‹å¦‚ï¼Œæˆ‘åœ¨è¿™ä¸ª<a href="https://blog.sctux.com/kubernetes/yaml/static-pod.json">url</a>æ”¾ç½®äº†ä¸€ä¸ªpodåˆ›å»ºçš„æè¿°æ–‡ä»¶</p><p>é‚£ä¹ˆä¸Šé¢æåˆ°äº†å¦‚ä½•ä¿®æ”¹ï¼Ÿé€šè¿‡urlæ¥åˆ›å»ºçš„ï¼Ÿå°±æ˜¯kubeletå¯åŠ¨é…ç½®å‚æ•°ä¸­é…ç½®<code>--manifest-url</code>æŒ‡å‘å³å¯</p><p><img src="/2018/12/22/kubernetes-static-pod/static-pod-from-url.png" alt="static-pod-from-url"></p><p>ok ä»¥ä¸Šå°±æ˜¯å¦‚ä½•åˆ›å»ºé™æ€Podçš„å…·ä½“é£Ÿç”¨æ–¹æ³•ï¼Œé‚£ä»€ä¹ˆåœºæ™¯éœ€è¦ç”¨åˆ°å®ƒï¼Œè¿™ä¸ªæˆ‘ä¸ªäººè§‰å¾—è¿˜æ˜¯å› äººæˆ–å› ç¯å¢ƒè€Œå·²ï¼Œæ¯•ç«Ÿkuberneteså¼€å‘å‡ºäº†è¿™ä¸ªåŠŸèƒ½ï¼Œå°±è¯´æ˜æœ‰ç”¨æ­¦ä¹‹åœ°çš„ã€‚</p><p>åŒæ—¶åœ¨kubelet-conf.ymlå¯ä»¥æŒ‡å®šç›´æ¥æŒ‡å®šè¿™ä¸ªStaticPodçš„æè¿°æ–‡ä»¶å­˜æ”¾ç›®å½•:</p><figure class="highlight asciidoc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat kubelet-conf.yml</span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line"><span class="code">staticPodPath: /etc/kubernetes/manifests</span></span><br><span class="line"><span class="code">......</span></span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>ä½†æ˜¯è¿˜æ˜¯éœ€è¦åœ¨å¯åŠ¨å‚æ•°ä¸­é…ç½® <code>--pod-manifest-path</code></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;ä»Šå„¿æ˜¯å†¬è‡³ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œå­¦ä¹ çš„è„šæ­¥è¿˜æ˜¯ä¸èƒ½åœä¸‹ï¼Œä»Šå¤©å­¦ä¹ å®è·µä¸€ä¸‹kubernetesä¸­çš„é™æ€podæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬çŸ¥é“åœ¨å‰é¢Podçš„å£°æ˜å‘¨æœŸç®¡ç†éƒ½æ˜¯é€šè¿‡åƒDaemonSetã€StatefulSetã€Deploymentè¿™ç§æ–¹å¼åˆ›å»ºç®¡ç†çš„ï¼Œè€Œå®˜æ–¹æ–‡æ¡£ä»‹ç»äº†ä¸€ç§ç‰¹æ®Šçš„podå°±æ˜¯é™æ€Podï¼Œ&lt;/p&gt;
&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯é™æ€Pod&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯é™æ€Pod&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯é™æ€Pod&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯é™æ€Pod&lt;/h2&gt;&lt;p&gt;é™æ€Podæ˜¯ç”±kubeletè¿›è¡Œç®¡ç†ï¼Œä»…å­˜åœ¨äºç‰¹å®šNodeä¸Šçš„Podã€‚å®ƒä»¬ä¸èƒ½é€šè¿‡API Serverè¿›è¡Œç®¡ç†ï¼Œæ— æ³•ä¸ReplicationControllerã€Deploymentæˆ–DaemonSetè¿›è¡Œå…³è”ï¼Œå¹¶ä¸”kubeletä¹Ÿæ— æ³•å¯¹å…¶å¥åº·æ£€æŸ¥ã€‚&lt;/p&gt;
&lt;h3 id=&quot;é™æ€Podçš„åˆ›å»º&quot;&gt;&lt;a href=&quot;#é™æ€Podçš„åˆ›å»º&quot; class=&quot;headerlink&quot; title=&quot;é™æ€Podçš„åˆ›å»º:&quot;&gt;&lt;/a&gt;é™æ€Podçš„åˆ›å»º:&lt;/h3&gt;&lt;p&gt;é™æ€podå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼åˆ›å»ºï¼šä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–HTTPã€‚&lt;/p&gt;
&lt;h4 id=&quot;é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º&quot;&gt;&lt;a href=&quot;#é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º&quot; class=&quot;headerlink&quot; title=&quot;é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º&quot;&gt;&lt;/a&gt;é€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»º&lt;/h4&gt;&lt;p&gt;é…ç½®æ–‡ä»¶åªæ˜¯ç‰¹å®šç›®å½•ä¸­jsonæˆ–yamlæ ¼å¼çš„æ ‡å‡†podå®šä¹‰ã€‚ä»–é€šè¿‡åœ¨kubeletå®ˆæŠ¤è¿›ç¨‹ä¸­æ·»åŠ é…ç½®å‚æ•°&lt;code&gt;--pod-manifest-path=&amp;lt;the directory&amp;gt;&lt;/code&gt; æ¥è¿è¡Œé™æ€Podï¼Œkubeletç»å¸¸ä¼šå®ƒå®šæœŸæ‰«æç›®å½•ï¼›&lt;/p&gt;
&lt;p&gt;ä¾‹å¦‚ï¼Œå¦‚ä½•å°†ä¸€ä¸ªç®€å•webæœåŠ¡ä½œä¸ºé™æ€podå¯åŠ¨&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/tags/kubernetes/"/>
    
    <category term="Static Pod" scheme="https://blog.sctux.cc/tags/Static-Pod/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£kubernetesä¸­çš„Secret</title>
    <link href="https://blog.sctux.cc/2018/12/20/kubernetes-secret/"/>
    <id>https://blog.sctux.cc/2018/12/20/kubernetes-secret/</id>
    <published>2018-12-20T14:50:30.000Z</published>
    <updated>2025-09-01T01:59:08.921Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>Secretå¯¹è±¡ä¸ConfigMapå¯¹è±¡ç±»ä¼¼ï¼Œä½†å®ƒä¸»è¦ç”¨äºå­˜å‚¨ä»¥ä¸‹æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ï¼ŒOAuth tokenå’ŒSSH keyç­‰ç­‰ã€‚å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨secretä¸­ï¼Œå’Œç›´æ¥å­˜å‚¨åœ¨Podçš„å®šä¹‰ä¸­ï¼Œæˆ–Dockeré•œåƒå®šä¹‰ä¸­ç›¸æ¯”ï¼Œæ›´åŠ å®‰å…¨å’Œçµæ´»ã€‚</p><p>kuberntesä¸­å†…ç½®äº†ä¸‰ç§secretç±»å‹:</p><ul><li><code>Opaque</code>ï¼šä½¿ç”¨base64ç¼–ç å­˜å‚¨ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡base64 â€“decodeè§£ç è·å¾—åŸå§‹æ•°æ®ï¼Œå› æ­¤å®‰å…¨æ€§å¼±ã€‚</li><li><code>kubernetes.io/dockerconfigjson</code>ï¼šç”¨äºå­˜å‚¨docker registryçš„è®¤è¯ä¿¡æ¯ã€‚</li><li><code>kubernetes.io/service-account-token</code>ï¼šç”¨äºè¢« serviceaccount å¼•ç”¨ã€‚serviceaccout åˆ›å»ºæ—¶ Kubernetes ä¼šé»˜è®¤åˆ›å»ºå¯¹åº”çš„ secretã€‚Pod å¦‚æœä½¿ç”¨äº† serviceaccountï¼Œå¯¹åº”çš„ secret ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„ /run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­ã€‚(<a href="https://blog.sctux.com/2018/12/16/kubernetes-auth/">å‰é¢åšæ–‡</a>è®°å½•è¿‡å®è·µåçš„é£Ÿç”¨æ–¹æ³•)</li></ul><h1 id="Opaque-Secret"><a href="#Opaque-Secret" class="headerlink" title="Opaque Secret"></a>Opaque Secret</h1><p>Opaqueç±»å‹çš„Secretï¼Œå…¶valueä¸ºbase64ç¼–ç åçš„å€¼ã€‚</p><h2 id="åˆ›å»ºæ–¹å¼"><a href="#åˆ›å»ºæ–¹å¼" class="headerlink" title="åˆ›å»ºæ–¹å¼"></a>åˆ›å»ºæ–¹å¼</h2><h3 id="ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret"><a href="#ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret" class="headerlink" title="ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret"></a>ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="string">"admin"</span> &gt; ./username.txt</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="string">"1f2d1e2e67df"</span> &gt; ./password.txt</span></span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨kubectl create secretå‘½ä»¤åˆ›å»ºsecretï¼š</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º</span></span><br><span class="line">$ kubectl create secret generic db-user-passwd <span class="operator">-</span>-from-file<span class="operator">=</span><span class="symbol">./username.txt</span> <span class="operator">-</span>-from-file<span class="operator">=</span><span class="symbol">./password.txt</span></span><br><span class="line">secret <span class="string">"db-user-passwd"</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åˆ›å»ºç»“æœ</span></span><br><span class="line">$ kubectl get secrets db-user-passwd</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  password.<span class="params">txt:</span> MWYyZDFlMmU2N2Rm</span><br><span class="line">  username.<span class="params">txt:</span> YWRtaW4<span class="operator">=</span></span><br><span class="line"><span class="params">kind:</span> Secret</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="number">201</span>8-<span class="number">1</span>2-<span class="number">21</span>T08:<span class="number">58</span>:<span class="number">33</span>Z</span><br><span class="line">  <span class="params">name:</span> db-user-passwd</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line">  <span class="params">resourceVersion:</span> <span class="string">"57310"</span></span><br><span class="line">  <span class="params">selfLink:</span> <span class="symbol">/api/v1/namespaces/default/secrets/db-user-passwd</span></span><br><span class="line">  <span class="params">uid:</span> <span class="number">9848894</span>7-<span class="number">04</span>fe-<span class="number">11</span>e9-<span class="number">97</span>cd-<span class="number">00505621</span>dd5b</span><br><span class="line"><span class="params">type:</span> Opaque</span><br></pre></td></tr></tbody></table></figure><h3 id="ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºSecret"><a href="#ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºSecret" class="headerlink" title="ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºSecret"></a>ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºSecret</h3><p>é¦–å…ˆä½¿ç”¨base64å¯¹æ•°æ®è¿›è¡Œç¼–ç ï¼š</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="string">"admin"</span> | <span class="built_in">base64</span></span></span><br><span class="line">YWRtaW4=</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="string">"1f2d1e2e67df"</span> | <span class="built_in">base64</span></span></span><br><span class="line">MWYyZDFlMmU2N2Rm</span><br></pre></td></tr></tbody></table></figure><p>åˆ›å»ºä¸€ä¸ªç±»å‹ä¸ºSecretçš„æè¿°æ–‡ä»¶ï¼š</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> secret.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Secret</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> mysecret</span><br><span class="line"><span class="params">type:</span> Opaque</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  <span class="params">username:</span> YWRtaW4<span class="operator">=</span></span><br><span class="line">  <span class="params">password:</span> MWYyZDFlMmU2N2Rm</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f secret.yaml </span><br><span class="line">secret<span class="symbol">/mysecret</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åˆ›å»ºç»“æœ</span></span><br><span class="line">$ kubectl get secrets mysecret <span class="operator">-</span>o yaml</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  <span class="params">password:</span> MWYyZDFlMmU2N2Rm</span><br><span class="line">  <span class="params">username:</span> YWRtaW4<span class="operator">=</span></span><br><span class="line"><span class="params">kind:</span> Secret</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="number">201</span>8-<span class="number">1</span>2-<span class="number">21</span>T09:<span class="number">03</span>:<span class="number">52</span>Z</span><br><span class="line">  <span class="params">name:</span> mysecret</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line">  <span class="params">resourceVersion:</span> <span class="string">"57767"</span></span><br><span class="line">  <span class="params">selfLink:</span> <span class="symbol">/api/v1/namespaces/default/secrets/mysecret</span></span><br><span class="line">  <span class="params">uid:</span> <span class="number">564</span>bd4da-<span class="number">04</span>ff-<span class="number">11</span>e9-<span class="number">97</span>cd-<span class="number">00505621</span>dd5b</span><br><span class="line"><span class="params">type:</span> Opaque</span><br></pre></td></tr></tbody></table></figure><h2 id="é£Ÿç”¨æ–¹å¼"><a href="#é£Ÿç”¨æ–¹å¼" class="headerlink" title="é£Ÿç”¨æ–¹å¼"></a>é£Ÿç”¨æ–¹å¼</h2><p>åˆ›å»ºå¥½Secretä¹‹åï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼é£Ÿç”¨ï¼š</p><ul><li>ä»¥Volumeæ–¹å¼</li><li>ä»¥ç¯å¢ƒå˜é‡æ–¹å¼</li></ul><h3 id="å°†-Secret-æŒ‚è½½åˆ°-Volume-ä¸­"><a href="#å°†-Secret-æŒ‚è½½åˆ°-Volume-ä¸­" class="headerlink" title="å°† Secret æŒ‚è½½åˆ° Volume ä¸­"></a>å°† Secret æŒ‚è½½åˆ° Volume ä¸­</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> redis-pod.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> redis</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> redis</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">nodeName:</span> k8s-m1</span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> container-<span class="number">0</span></span><br><span class="line">    <span class="params">image:</span> redis</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> foo</span><br><span class="line">        <span class="params">mountPath:</span> <span class="symbol">/etc/foo</span></span><br><span class="line">        <span class="params">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> foo</span><br><span class="line">      <span class="params">secret:</span></span><br><span class="line">        <span class="params">secretName:</span> db-user-passwd</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ åˆ›å»º:</span><br><span class="line">$ kubectl create <span class="operator">-</span>f redis-pod.yaml</span><br><span class="line">pod<span class="symbol">/redis</span> created</span><br></pre></td></tr></tbody></table></figure><p>è¿›å…¥å®¹å™¨æ£€æŸ¥</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l /etc/foo/</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 19 Dec 21 09:14 password.txt -&gt; ..data/password.txt</span><br><span class="line">lrwxrwxrwx 1 root root 19 Dec 21 09:14 username.txt -&gt; ..data/username.txt</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/foo/username.txt</span> </span><br><span class="line">admin</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/foo/password.txt</span> </span><br><span class="line">1f2d1e2e67df </span><br></pre></td></tr></tbody></table></figure><p>ä¹Ÿå¯ä»¥åªæŒ‚è½½Secretä¸­ç‰¹å®šçš„keyï¼š</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> redis-pod2.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> redis2</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> redis</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">nodeName:</span> k8s-m1</span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> redis</span><br><span class="line">    <span class="params">image:</span> redis</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> foo</span><br><span class="line">        <span class="params">mountPath:</span> <span class="symbol">/etc/foo</span></span><br><span class="line">        <span class="params">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> foo</span><br><span class="line">      <span class="params">secret:</span></span><br><span class="line">        <span class="params">secretName:</span> mysecret</span><br><span class="line">        <span class="params">items:</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">key:</span> username</span><br><span class="line">            <span class="params">path:</span> my-group<span class="symbol">/my-username</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f redis-pod2.yaml </span><br><span class="line">pod<span class="symbol">/redis2</span> created</span><br></pre></td></tr></tbody></table></figure><p>è¿›å…¥å®¹å™¨æ£€æŸ¥</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it redis5 /bin/bash</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l /etc/foo/my-group/my-username</span> </span><br><span class="line">-rw-r--r-- 1 root root 5 Dec 21 10:26 /etc/foo/my-group/my-username</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/foo/my-group/my-username</span></span><br><span class="line">admin</span><br></pre></td></tr></tbody></table></figure><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼š</p><p>username å­˜å‚¨åœ¨/etc/foo/my-group/my-usernameä¸­<br>passwordæœªè¢«æŒ‚è½½<br><code>æ³¨æ„</code>: æŒ‡å®škeyçš„è¿™ç§æŒ‚è½½æ–¹å¼åªé€‚ç”¨äºæ˜¯é€šè¿‡ä½¿ç”¨æè¿°æ–‡ä»¶åˆ›å»ºçš„Secret,ä»æ–‡ä»¶ä¸­åˆ›å»ºçš„é‚£ç§SecretæŒ‚è½½ä¼šæŠ¥é”™:</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ å½“æˆ‘æŒ‚è½½<span class="built_in"> Secret </span>db-user-passwd çš„æ—¶å€™podåˆ›å»ºäº‹ä»¶:</span><br><span class="line">Events:</span><br><span class="line"> <span class="built_in"> Type </span>    Reason       Age               <span class="keyword">From</span>             Message</span><br><span class="line">  ----     ------       ----              ----             -------</span><br><span class="line">  <span class="built_in">Warning</span>  FailedMount  5s (x5 over 12s)  kubelet, k8s-m1  MountVolume.SetUp failed <span class="keyword">for</span> volume <span class="string">"foo"</span> : references non-existent<span class="built_in"> secret </span>key</span><br></pre></td></tr></tbody></table></figure><p>å…·ä½“åŸå› ç›®å‰æ— è§£<del>,æœ‰çŸ¥é“çš„å¤§å“¥å¯ä»¥è¯„è®ºç•™è¨€å‘ŠçŸ¥ä¸€äºŒï¼Œè°¢è°¢</del></p><h3 id="å°†-Secret-å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸­"><a href="#å°†-Secret-å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸­" class="headerlink" title="å°† Secret å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸­"></a>å°† Secret å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ä¸­</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> redis3.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> redis3</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> redis</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">nodeName:</span> k8s-m1</span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> redis</span><br><span class="line">    <span class="params">image:</span> redis</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">env:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> SECRET_USERNAME</span><br><span class="line">      <span class="params">valueFrom:</span></span><br><span class="line">        <span class="params">secretKeyRef:</span></span><br><span class="line">          <span class="params">name:</span> mysecret</span><br><span class="line">          <span class="params">key:</span> username</span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> SECRET_PASSWORD</span><br><span class="line">      <span class="params">valueFrom:</span></span><br><span class="line">        <span class="params">secretKeyRef:</span></span><br><span class="line">          <span class="params">name:</span> mysecret</span><br><span class="line">          <span class="params">key:</span> password</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥å®¹å™¨æŸ¥çœ‹ç»“æœ</span></span><br><span class="line">$ kubectl exec <span class="operator">-</span>it redis3 <span class="symbol">/bin/bash</span></span><br><span class="line">$ echo $SECRET_USERNAME</span><br><span class="line">admin</span><br><span class="line">$ echo $SECRET_PASSWORD</span><br><span class="line"><span class="number">1</span>f2d1e2e67df</span><br></pre></td></tr></tbody></table></figure><p>ok , é€šè¿‡ä¸åŒæ–¹å¼æŒ‚è½½è¿›å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥æ‹¿æ¥ç”¨å•¦ï¼Œå…·ä½“é€‰æ‹©å“ªç§æ–¹å¼æŒ‚è½½è¿˜æ˜¯éœ€è¦çœ‹å®é™…ç¯å¢ƒï¼›<br>å¥½å•¦ï¼Œä»¥ä¸Šå°±æ˜¯Secretçš„ç®€å•é£Ÿç”¨æ–¹æ³•ï¼Œæ›´å¤šå¯ä»¥çœ‹<a href="https://kubernetes.io/docs/concepts/configuration/secret/">å®˜æ–¹æ–‡æ¡£</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;Secretå¯¹è±¡ä¸ConfigMapå¯¹è±¡ç±»ä¼¼ï¼Œä½†å®ƒä¸»è¦ç”¨äºå­˜å‚¨ä»¥ä¸‹æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ï¼ŒOAuth tokenå’ŒSSH keyç­‰ç­‰ã€‚å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨secretä¸­ï¼Œå’Œç›´æ¥å­˜å‚¨åœ¨Podçš„å®šä¹‰ä¸­ï¼Œæˆ–Dockeré•œåƒå®šä¹‰ä¸­ç›¸æ¯”ï¼Œæ›´åŠ å®‰å…¨å’Œçµæ´»ã€‚&lt;/p&gt;
&lt;p&gt;kuberntesä¸­å†…ç½®äº†ä¸‰ç§secretç±»å‹:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Opaque&lt;/code&gt;ï¼šä½¿ç”¨base64ç¼–ç å­˜å‚¨ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡base64 â€“decodeè§£ç è·å¾—åŸå§‹æ•°æ®ï¼Œå› æ­¤å®‰å…¨æ€§å¼±ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;kubernetes.io/dockerconfigjson&lt;/code&gt;ï¼šç”¨äºå­˜å‚¨docker registryçš„è®¤è¯ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;kubernetes.io/service-account-token&lt;/code&gt;ï¼šç”¨äºè¢« serviceaccount å¼•ç”¨ã€‚serviceaccout åˆ›å»ºæ—¶ Kubernetes ä¼šé»˜è®¤åˆ›å»ºå¯¹åº”çš„ secretã€‚Pod å¦‚æœä½¿ç”¨äº† serviceaccountï¼Œå¯¹åº”çš„ secret ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„ /run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­ã€‚(&lt;a href=&quot;https://blog.sctux.com/2018/12/16/kubernetes-auth/&quot;&gt;å‰é¢åšæ–‡&lt;/a&gt;è®°å½•è¿‡å®è·µåçš„é£Ÿç”¨æ–¹æ³•)&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;Opaque-Secret&quot;&gt;&lt;a href=&quot;#Opaque-Secret&quot; class=&quot;headerlink&quot; title=&quot;Opaque Secret&quot;&gt;&lt;/a&gt;Opaque Secret&lt;/h1&gt;&lt;p&gt;Opaqueç±»å‹çš„Secretï¼Œå…¶valueä¸ºbase64ç¼–ç åçš„å€¼ã€‚&lt;/p&gt;
&lt;h2 id=&quot;åˆ›å»ºæ–¹å¼&quot;&gt;&lt;a href=&quot;#åˆ›å»ºæ–¹å¼&quot; class=&quot;headerlink&quot; title=&quot;åˆ›å»ºæ–¹å¼&quot;&gt;&lt;/a&gt;åˆ›å»ºæ–¹å¼&lt;/h2&gt;&lt;h3 id=&quot;ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret&quot;&gt;&lt;a href=&quot;#ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret&quot; class=&quot;headerlink&quot; title=&quot;ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret&quot;&gt;&lt;/a&gt;ä»æ–‡ä»¶ä¸­åˆ›å»ºSecret&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;language-bash&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; -n &lt;span class=&quot;string&quot;&gt;&quot;admin&quot;&lt;/span&gt; &amp;gt; ./username.txt&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta prompt_&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;language-bash&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; -n &lt;span class=&quot;string&quot;&gt;&quot;1f2d1e2e67df&quot;&lt;/span&gt; &amp;gt; ./password.txt&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ä½¿ç”¨kubectl create secretå‘½ä»¤åˆ›å»ºsecretï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/categories/kubernetes/"/>
    
    
    <category term="kuberntes" scheme="https://blog.sctux.cc/tags/kuberntes/"/>
    
    <category term="secret" scheme="https://blog.sctux.cc/tags/secret/"/>
    
  </entry>
  
  <entry>
    <title>Kuberneteså®¹å™¨å­˜æ´»æ¢æµ‹&amp;åº”ç”¨è‡ªæ¢å¤</title>
    <link href="https://blog.sctux.cc/2018/12/18/kubernetes-liveness/"/>
    <id>https://blog.sctux.cc/2018/12/18/kubernetes-liveness/</id>
    <published>2018-12-18T15:12:40.000Z</published>
    <updated>2025-09-01T01:59:08.959Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>å½“ä½ ä½¿ç”¨kuberentesçš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰é‡åˆ°è¿‡Podåœ¨å¯åŠ¨åä¸€ä¼šå°±æŒ‚æ‰ç„¶ååˆé‡æ–°å¯åŠ¨è¿™æ ·çš„æ¶æ€§å¾ªç¯ï¼Ÿ<br>ä½ æœ‰æ²¡æœ‰æƒ³è¿‡kubernetesæ˜¯å¦‚ä½•æ£€æµ‹podæ˜¯å¦è¿˜å­˜æ´»ï¼Ÿ<br>è™½ç„¶å®¹å™¨å·²ç»å¯åŠ¨ï¼Œä½†æ˜¯kuberneteså¦‚ä½•çŸ¥é“å®¹å™¨çš„è¿›ç¨‹æ˜¯å¦å‡†å¤‡å¥½å¯¹å¤–æä¾›æœåŠ¡äº†å‘¢ï¼Ÿ</p><p>æœ¬åšæ–‡ä¸»è¦è®°å½•å®è·µå¦‚ä½•é…ç½®å®¹å™¨çš„å­˜æ´»å’Œå°±ç»ªæ¢é’ˆã€‚</p><p><strong>liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰</strong><br>ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå³Podæ˜¯å¦ä¸ºrunningçŠ¶æ€ï¼Œå¦‚æœLivenessProbeæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œåˆ™kubeletå°†killæ‰å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥æ˜¯å¦é‡å¯ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨ä¸åŒ…å«LivenessProbeæ¢é’ˆï¼Œåˆ™Kubeletè®¤ä¸ºå®¹å™¨çš„LivenessProbeæ¢é’ˆçš„è¿”å›å€¼æ°¸è¿œæˆåŠŸã€‚</p><p><strong>readiness probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰</strong><br>ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆï¼Œå³å®¹å™¨çš„Readyæ˜¯å¦ä¸ºTrueï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœReadinessProbeæ¢æµ‹å¤±è´¥ï¼Œåˆ™å®¹å™¨çš„Readyå°†ä¸ºFalseï¼Œæ§åˆ¶å™¨å°†æ­¤Podçš„Endpointä»å¯¹åº”çš„serviceçš„Endpointåˆ—è¡¨ä¸­ç§»é™¤ï¼Œä»æ­¤ä¸å†å°†ä»»ä½•è¯·æ±‚è°ƒåº¦æ­¤Podä¸Šï¼Œç›´åˆ°ä¸‹æ¬¡æ¢æµ‹æˆåŠŸã€‚</p><p><strong>æ¯ç±»æ¢é’ˆéƒ½æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹æ³•</strong></p><ul><li>execï¼šé€šè¿‡æ‰§è¡Œå‘½ä»¤æ¥æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œé’ˆå¯¹å¤æ‚æ£€æµ‹æˆ–æ— HTTPæ¥å£çš„æœåŠ¡ï¼Œå‘½ä»¤è¿”å›å€¼ä¸º0åˆ™è¡¨ç¤ºå®¹å™¨å¥åº·ã€‚</li><li>httpGetï¼šé€šè¿‡å‘é€httpè¯·æ±‚æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œè¿”å›200-399çŠ¶æ€ç åˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li><li>tcpSocketï¼šé€šè¿‡å®¹å™¨çš„IPå’ŒPortæ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</li></ul><p>æ¯ç§æ–¹å¼éƒ½å¯ä»¥å®šä¹‰åœ¨readiness æˆ–è€…liveness ä¸­ã€‚æ¯”å¦‚å®šä¹‰readiness ä¸­http get å°±æ˜¯æ„æ€è¯´å¦‚æœæˆ‘å®šä¹‰çš„è¿™ä¸ªpathçš„http get è¯·æ±‚è¿”å›200-400ä»¥å¤–çš„http code å°±æŠŠæˆ‘ä»æ‰€æœ‰æœ‰æˆ‘çš„æœåŠ¡é‡Œé¢åˆ äº†å§ï¼Œå¦‚æœå®šä¹‰åœ¨livenessé‡Œé¢å°±æ˜¯æŠŠæˆ‘kill äº†ã€‚<br>æ³¨æ„ï¼Œlivenessä¸ä¼šé‡å¯podï¼Œpodæ˜¯å¦ä¼šé‡å¯ç”±ä½ çš„restart policy æ§åˆ¶ã€‚</p><p><strong>æ¢é’ˆæ¢æµ‹çš„ç»“æœæœ‰ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€</strong></p><ul><li>Successï¼šContaineré€šè¿‡äº†æ£€æŸ¥ã€‚</li><li>Failureï¼šContaineræœªé€šè¿‡æ£€æŸ¥ã€‚</li><li>Unknownï¼šæœªèƒ½æ‰§è¡Œæ£€æŸ¥ï¼Œå› æ­¤ä¸é‡‡å–ä»»ä½•æªæ–½ã€‚</li></ul><p><strong>é‡å¯ç­–ç•¥</strong></p><ul><li>Always: æ€»æ˜¯é‡å¯</li><li>OnFailure: å¦‚æœå¤±è´¥å°±é‡å¯</li><li>Never: æ°¸è¿œä¸é‡å¯</li></ul><h2 id="LivenessProbeæ¢é’ˆé…ç½®"><a href="#LivenessProbeæ¢é’ˆé…ç½®" class="headerlink" title="LivenessProbeæ¢é’ˆé…ç½®"></a>LivenessProbeæ¢é’ˆé…ç½®</h2><h3 id="ç¤ºä¾‹ä¸€-é€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ç¤ºä¾‹ä¸€-é€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ç¤ºä¾‹ä¸€: é€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ç¤ºä¾‹ä¸€: é€šè¿‡execæ–¹å¼åšå¥åº·æ¢æµ‹</h3><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">exec-liveness.yaml  </span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">labels</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">test</span><span class="punctuation">:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">liveness-exec</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">containers</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">name: liveness</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">k8s.gcr.io/busybox  </span></span><br><span class="line">    <span class="attribute">args</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span></span><br><span class="line">    <span class="attribute">livenessProbe</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">exec</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">      <span class="attribute">initialDelaySeconds</span><span class="punctuation">:</span> <span class="string">5</span></span><br><span class="line">      <span class="attribute">periodSeconds</span><span class="punctuation">:</span> <span class="string">5</span></span><br></pre></td></tr></tbody></table></figure><p>åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯¹å®¹å™¨æ‰§è¡ŒlivenessProbeæ£€æŸ¥ï¼ŒperiodSecondså­—æ®µæŒ‡å®škubeletæ¯5sæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œæ£€æŸ¥çš„å‘½ä»¤ä¸ºcat /tmp/healthyï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletåº”è¯¥åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥ä¹‹å‰ç­‰å¾…5ç§’ï¼Œ<br>å¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›0ï¼Œé‚£ä¹ˆkubeletå°±è®¤ä¸ºå®¹å™¨æ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸ºé0ï¼Œåˆ™Kubeletä¼šKillæ‰å®¹å™¨å¹¶æ ¹æ®é‡å¯ç­–ç•¥æ¥å†³å®šæ˜¯å¦éœ€è¦é‡å¯(kubernetesé»˜è®¤ä¸ºPODé…ç½®çš„é‡å¯ç­–ç•¥ä¸ºAlways)</p><p>å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/bin/</span>sh -c <span class="string">"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"</span></span><br></pre></td></tr></tbody></table></figure><p>å¯¹äºå®¹å™¨çš„å‰30ç§’ï¼Œæœ‰ä¸€ä¸ª/tmp/healthyæ–‡ä»¶ã€‚å› æ­¤ï¼Œåœ¨å‰30ç§’å†…ï¼Œè¯¥å‘½ä»¤cat /tmp/healthyè¿”å›æˆåŠŸä»£ç ã€‚30ç§’åï¼Œcat /tmp/healthyè¿”å›å¤±è´¥ä»£ç ã€‚</p><p>åœ¨30ç§’å†…ï¼ŒæŸ¥çœ‹Podäº‹ä»¶ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">describe</span> pod liveness<span class="operator">-</span><span class="keyword">exec</span></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age               <span class="keyword">From</span>               Message</span><br><span class="line">  <span class="comment">----     ------     ----              ----               -------</span></span><br><span class="line">  Normal   Scheduled  <span class="number">15</span>m               <span class="keyword">default</span><span class="operator">-</span>scheduler  Successfully assigned <span class="keyword">default</span><span class="operator">/</span>liveness<span class="operator">-</span><span class="keyword">exec</span> <span class="keyword">to</span> k8s<span class="operator">-</span>m3</span><br><span class="line">  Normal   Pulled     <span class="number">3</span>m (x3 <span class="keyword">over</span> <span class="number">5</span>m)   kubelet, k8s<span class="operator">-</span>m3    Successfully pulled image "k8s.gcr.io/busybox"</span><br><span class="line">  Normal   Created    <span class="number">3</span>m (x3 <span class="keyword">over</span> <span class="number">5</span>m)   kubelet, k8s<span class="operator">-</span>m3    Created container</span><br><span class="line">  Normal   Started    <span class="number">3</span>m (x3 <span class="keyword">over</span> <span class="number">5</span>m)   kubelet, k8s<span class="operator">-</span>m3    Started container</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>åœ¨30ç§’åï¼ŒæŸ¥çœ‹Podäº‹ä»¶ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">describe</span> pod liveness<span class="operator">-</span><span class="keyword">exec</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age              <span class="keyword">From</span>               Message</span><br><span class="line">  <span class="comment">----     ------     ----             ----               -------</span></span><br><span class="line">  Normal   Scheduled  <span class="number">16</span>m              <span class="keyword">default</span><span class="operator">-</span>scheduler  Successfully assigned <span class="keyword">default</span><span class="operator">/</span>liveness<span class="operator">-</span><span class="keyword">exec</span> <span class="keyword">to</span> k8s<span class="operator">-</span>m3</span><br><span class="line">  Normal   Pulled     <span class="number">5</span>m (x3 <span class="keyword">over</span> <span class="number">7</span>m)  kubelet, k8s<span class="operator">-</span>m3    Successfully pulled image "k8s.gcr.io/busybox"</span><br><span class="line">  Normal   Created    <span class="number">5</span>m (x3 <span class="keyword">over</span> <span class="number">7</span>m)  kubelet, k8s<span class="operator">-</span>m3    Created container</span><br><span class="line">  Normal   Started    <span class="number">5</span>m (x3 <span class="keyword">over</span> <span class="number">7</span>m)  kubelet, k8s<span class="operator">-</span>m3    Started container</span><br><span class="line">  Warning  Unhealthy  <span class="number">4</span>m (x9 <span class="keyword">over</span> <span class="number">7</span>m)  kubelet, k8s<span class="operator">-</span>m3    Liveness probe failed: cat: can<span class="string">'t open '</span><span class="operator">/</span>tmp<span class="operator">/</span>healthy<span class="string">': No such file or directory</span></span><br><span class="line"><span class="string">  Normal   Pulling    4m (x4 over 7m)  kubelet, k8s-m3    pulling image "k8s.gcr.io/busybox"</span></span><br><span class="line"><span class="string">  Normal   Killing    2m (x4 over 6m)  kubelet, k8s-m3    Killing container with id docker://liveness:Container failed liveness probe.. Container will be killed and recreated.</span></span><br></pre></td></tr></tbody></table></figure><p>å†ç­‰30ç§’ï¼Œç¡®è®¤Containerå·²é‡æ–°å¯åŠ¨, ä¸‹é¢è¾“å‡ºä¸­RESTARTSçš„æ¬¡æ•°å·²å¢åŠ ï¼š</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">get</span> pod liveness<span class="operator">-</span><span class="keyword">exec</span></span><br><span class="line">NAME            READY     STATUS    RESTARTS   AGE</span><br><span class="line">liveness<span class="operator">-</span><span class="keyword">exec</span>   <span class="number">1</span><span class="operator">/</span><span class="number">1</span>       <span class="keyword">Running</span>   <span class="number">1</span>          <span class="number">1</span>m</span><br></pre></td></tr></tbody></table></figure><h3 id="ç¤ºä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ç¤ºä¾‹äºŒ-é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ç¤ºä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ç¤ºä¾‹äºŒ: é€šè¿‡HTTPæ–¹å¼åšå¥åº·æ¢æµ‹</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">test:</span> liveness</span><br><span class="line">  <span class="params">name:</span> liveness-http</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> liveness</span><br><span class="line">    <span class="params">image:</span> k8s.gcr.io<span class="symbol">/liveness</span> <span class="comment"># å®˜æ–¹ç”¨æˆ·æµ‹è¯•çš„demoé•œåƒ</span></span><br><span class="line">    <span class="params">args:</span></span><br><span class="line">    <span class="operator">-</span> <span class="symbol">/server</span></span><br><span class="line">    <span class="params">livenessProbe:</span></span><br><span class="line">      <span class="params">httpGet:</span></span><br><span class="line">        <span class="params">path:</span> <span class="symbol">/healthz</span></span><br><span class="line">        <span class="params">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="params">httpHeaders:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> X-Custom-Header</span><br><span class="line">          <span class="params">value:</span> Awesome</span><br><span class="line">      <span class="params">initialDelaySeconds:</span> <span class="number">3</span> </span><br><span class="line">      <span class="params">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></tbody></table></figure><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨k8s.gcr.io/livenessé•œåƒï¼Œåˆ›å»ºå‡ºä¸€ä¸ªPodï¼Œå…¶ä¸­periodSecondså­—æ®µæŒ‡å®škubeletæ¯3ç§’æ‰§è¡Œä¸€æ¬¡æ¢æµ‹ï¼ŒinitialDelaySecondså­—æ®µå‘Šè¯‰kubeletå»¶è¿Ÿç­‰å¾…3ç§’ï¼Œæ¢æµ‹æ–¹å¼ä¸ºå‘å®¹å™¨ä¸­è¿è¡Œçš„æœåŠ¡å‘é€HTTP GETè¯·æ±‚ï¼Œè¯·æ±‚8080ç«¯å£ä¸‹çš„/healthz, ä»»ä½•å¤§äºæˆ–ç­‰äº200ä¸”å°äº400çš„ä»£ç è¡¨ç¤ºæˆåŠŸã€‚ä»»ä½•å…¶ä»–ä»£ç è¡¨ç¤ºå¤±è´¥ã€‚</p><p>10ç§’åï¼ŒæŸ¥çœ‹Podäº‹ä»¶ä»¥éªŒè¯livenessæ¢æµ‹å¤±è´¥å¹¶ä¸”Containerå·²é‡æ–°å¯åŠ¨ï¼š</p><figure class="highlight fortran"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pod liveness-http</span><br><span class="line"><span class="keyword">NAME</span>            READY     <span class="keyword">STATUS</span>             RESTARTS   AGE</span><br><span class="line">liveness-http   <span class="number">1</span>/<span class="number">1</span>       RUNNING            <span class="number">1</span>          <span class="number">1</span>m</span><br></pre></td></tr></tbody></table></figure><p>httpGetæ¢æµ‹æ–¹å¼æœ‰å¦‚ä¸‹å¯é€‰çš„æ§åˆ¶å­—æ®µ</p><ul><li>hostï¼šè¦è¿æ¥çš„ä¸»æœºåï¼Œé»˜è®¤ä¸ºPod IPï¼Œå¯ä»¥åœ¨http request headä¸­è®¾ç½®hostå¤´éƒ¨ã€‚</li><li>scheme: ç”¨äºè¿æ¥hostçš„åè®®ï¼Œé»˜è®¤ä¸ºHTTPã€‚</li><li>pathï¼šhttpæœåŠ¡å™¨ä¸Šçš„è®¿é—®URIã€‚</li><li>httpHeadersï¼šè‡ªå®šä¹‰HTTPè¯·æ±‚headersï¼ŒHTTPå…è®¸é‡å¤headersã€‚</li><li>portï¼š å®¹å™¨ä¸Šè¦è®¿é—®ç«¯å£å·æˆ–åç§°ã€‚</li></ul><h3 id="ç¤ºä¾‹ä¸‰ï¼šé€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"><a href="#ç¤ºä¾‹ä¸‰ï¼šé€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹" class="headerlink" title="ç¤ºä¾‹ä¸‰ï¼šé€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹"></a>ç¤ºä¾‹ä¸‰ï¼šé€šè¿‡TCPæ–¹å¼åšå¥åº·æ¢æµ‹</h3><p>Kubeletå°†å°è¯•åœ¨æŒ‡å®šçš„ç«¯å£ä¸Šæ‰“å¼€å®¹å™¨ä¸Šçš„å¥—æ¥å­—ï¼Œå¦‚æœèƒ½å»ºç«‹è¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">goproxy</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">goproxy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">goproxy</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/goproxy:0.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">20</span></span><br></pre></td></tr></tbody></table></figure><p>TCPæ£€æŸ¥æ–¹å¼å’ŒHTTPæ£€æŸ¥æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œç¤ºä¾‹ä¸­ä¸¤ç§æ¢é’ˆéƒ½ä½¿ç”¨äº†ï¼Œåœ¨å®¹å™¨å¯åŠ¨5ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªreadinessProbeæ¢é’ˆï¼Œè¿™å°†è¿æ¥åˆ°å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœæ¢æµ‹æˆåŠŸï¼Œåˆ™è¯¥Podå°†è¢«æ ‡è¯†ä¸ºreadyï¼Œ10ç§’åï¼Œkubeletå°†è¿›è¡Œç¬¬äºŒæ¬¡è¿æ¥ã€‚<br>é™¤æ­¤ä¹‹åï¼Œæ­¤é…ç½®è¿˜åŒ…å«äº†livenessProbeæ¢é’ˆï¼Œåœ¨å®¹å™¨å¯åŠ¨15ç§’åï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªlivenessProbeæ¢é’ˆï¼Œä»ç„¶å°è¯•è¿æ¥å®¹å™¨çš„8080ç«¯å£ï¼Œå¦‚æœè¿æ¥å¤±è´¥åˆ™é‡å¯å®¹å™¨ã€‚</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-port</span></span><br><span class="line">  <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">hostPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">liveness-port</span></span><br></pre></td></tr></tbody></table></figure><h2 id="ReadinessProbeæ¢é’ˆé…ç½®ï¼š"><a href="#ReadinessProbeæ¢é’ˆé…ç½®ï¼š" class="headerlink" title="ReadinessProbeæ¢é’ˆé…ç½®ï¼š"></a>ReadinessProbeæ¢é’ˆé…ç½®ï¼š</h2><p>ReadinessProbeæ¢é’ˆçš„ä½¿ç”¨åœºæ™¯livenessProbeç¨æœ‰ä¸åŒï¼Œæœ‰çš„æ—¶å€™åº”ç”¨ç¨‹åºå¯èƒ½æš‚æ—¶æ— æ³•æ¥å—è¯·æ±‚ï¼Œæ¯”å¦‚Podå·²ç»Runningäº†ï¼Œä½†æ˜¯å®¹å™¨å†…åº”ç”¨ç¨‹åºå°šæœªå¯åŠ¨æˆåŠŸï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰ReadinessProbeï¼Œåˆ™Kubernetesè®¤ä¸ºå®ƒå¯ä»¥å¤„ç†è¯·æ±‚äº†ï¼Œç„¶è€Œæ­¤æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“ç¨‹åºè¿˜æ²¡å¯åŠ¨æˆåŠŸæ˜¯ä¸èƒ½æ¥æ”¶ç”¨æˆ·è¯·æ±‚çš„ï¼Œæ‰€ä»¥ä¸å¸Œæœ›kubernetesæŠŠè¯·æ±‚è°ƒåº¦ç»™å®ƒï¼Œåˆ™ä½¿ç”¨ReadinessProbeæ¢é’ˆã€‚<br>ReadinessProbeå’ŒlivenessProbeå¯ä»¥ä½¿ç”¨ç›¸åŒæ¢æµ‹æ–¹å¼ï¼Œåªæ˜¯å¯¹Podçš„å¤„ç½®æ–¹å¼ä¸åŒï¼ŒReadinessProbeæ˜¯å°†Pod IP:Portä»å¯¹åº”çš„EndPointåˆ—è¡¨ä¸­åˆ é™¤ï¼Œè€ŒlivenessProbeåˆ™Killå®¹å™¨å¹¶æ ¹æ®Podçš„é‡å¯ç­–ç•¥æ¥å†³å®šä½œå‡ºå¯¹åº”çš„æªæ–½ã€‚</p><p><strong>ReadinessProbe</strong>æ¢é’ˆæ¢æµ‹å®¹å™¨æ˜¯å¦å·²å‡†å¤‡å°±ç»ªï¼Œå¦‚æœæœªå‡†å¤‡å°±ç»ªåˆ™kubernetesä¸ä¼šå°†æµé‡è½¬å‘ç»™æ­¤Podã€‚</p><p>ReadinessProbeæ¢é’ˆä¸livenessProbeä¸€æ ·ä¹Ÿæ”¯æŒexecã€httpGetã€TCPçš„æ¢æµ‹æ–¹å¼ï¼Œé…ç½®æ–¹å¼ç›¸åŒï¼Œåªä¸è¿‡æ˜¯å°†livenessProbeå­—æ®µä¿®æ”¹ä¸ºReadinessProbeã€‚</p><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">readinessProbe</span><span class="punctuation">:</span></span><br><span class="line"> <span class="attribute">exec</span><span class="punctuation">:</span></span><br><span class="line">   <span class="attribute">command</span><span class="punctuation">:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line"> <span class="attribute">initialDelaySeconds</span><span class="punctuation">:</span> <span class="string">5</span></span><br><span class="line"> <span class="attribute">periodSeconds</span><span class="punctuation">:</span> <span class="string">5</span></span><br></pre></td></tr></tbody></table></figure><h3 id="ç¤ºä¾‹ä¸€-ReadinessProbeç¤ºä¾‹"><a href="#ç¤ºä¾‹ä¸€-ReadinessProbeç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹ä¸€: ReadinessProbeç¤ºä¾‹"></a>ç¤ºä¾‹ä¸€: ReadinessProbeç¤ºä¾‹</h3><p>ç°åœ¨æ¥çœ‹ä¸€ä¸ªåŠ å…¥ReadinessProbeæ¢é’ˆå’Œä¸€ä¸ªæ²¡æœ‰ReadinessProbeæ¢é’ˆçš„ç¤ºä¾‹ï¼š<br>è¯¥ç¤ºä¾‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªdeployï¼Œåä¸ºgogsï¼Œå¯åŠ¨çš„å®¹å™¨è¿è¡Œä¸€ä¸ªç±»ä¼¼äºgitlabçš„åº”ç”¨ç¨‹åºï¼Œç¨‹åºç›‘å¬ç«¯å£ä¸º3000ã€‚<br>è¿™é‡Œä¸ºäº†æ¨¡æ‹Ÿæ•ˆæœæˆ‘è¿™é‡ŒåŸé•œåƒåšäº†ä¸€ä¸‹ä¿®æ”¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†å»¶è¿Ÿä»–çš„å¯åŠ¨æ—¶é—´ä¸º40såå†å»å¯åŠ¨gogsçš„åº”ç”¨ç¨‹åºï¼Œæ­¤æ—¶å°±ä¼šå¼€å¯3000ç«¯å£ï¼Œ</p><p>(æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸€ä¸‹ï¼Œéå¸¸çˆ½çš„ä¸€ä¸ªè‡ªåŠ©gitwebå¹³å°<a href="https://gogs.io/">Gogs</a>)</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">         <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">k8s-m1</span></span><br></pre></td></tr></tbody></table></figure><div style="width: 50%; margin: auto">![Not add readinessProbe result](kubernetes-liveness/image1.png)</div>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œå½“æˆ‘åˆ›å»ºéƒ¨ç½²ä¹‹åï¼ŒPodå¯åŠ¨18sï¼Œè‡ªèº«çŠ¶æ€å·²Runningï¼Œå…¶READå­—æ®µï¼Œ1/1 è¡¨ç¤º1ä¸ªå®¹å™¨çŠ¶æ€å·²å‡†å¤‡å°±ç»ªäº†ï¼Œæ­¤æ—¶ï¼Œå¯¹äºkubernetesè€Œè¨€ï¼Œå®ƒå·²ç»å¯ä»¥æ¥æ”¶è¯·æ±‚äº†ï¼Œè€Œå®é™…ä¸Šæˆ‘åœ¨å»è®¿é—®çš„æ—¶å€™æœåŠ¡è¿˜æ— æ³•è®¿é—®ï¼Œå› ä¸ºGogoç¨‹åºè¿˜å°šå¯åŠ¨èµ·æ¥ï¼Œ40sä¹‹åæ–¹å¯æ­£å¸¸è®¿é—®ï¼Œæ‰€ä»¥é’ˆå¯¹äºæœåŠ¡å¯åŠ¨æ…¢æˆ–è€…å…¶ä»–åŸå› çš„æ­¤ç±»ç¨‹åºï¼Œå¿…é¡»é…ç½®ReadinessProbeã€‚<p>ä¸‹é¢æˆ‘åŠ å…¥readinessProbe</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">         <span class="attr">test:</span> <span class="string">gogs</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gogs</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">tcpSocket:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span> <span class="comment"># å¯åŠ¨å10ç§’å¼€å§‹æ¢æµ‹</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span>        <span class="comment"># æ¯5ç§’æ¢æµ‹ä¸€æ¬¡</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">k8s-m1</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><div style="width: 50%; margin: auto">![Add readinessProbe result](kubernetes-liveness/image1.png)</div>ä¸Šå›¾å¯ä»¥çœ‹å‡ºPodè™½ç„¶å·²å¤„äºRunnigçŠ¶æ€ï¼Œä½†æ˜¯ç”±äºç¬¬ä¸€æ¬¡æ¢æµ‹æ—¶é—´æœªåˆ°ï¼Œæ‰€ä»¥READYå­—æ®µä¸º0/1ï¼Œå³å®¹å™¨çš„çŠ¶æ€ä¸ºæœªå‡†å¤‡å°±ç»ªï¼Œåœ¨æœªå‡†å¤‡å°±ç»ªçš„æƒ…å†µä¸‹ï¼Œå…¶Podå¯¹åº”çš„Serviceä¸‹çš„Endpointä¹Ÿä¸ºç©ºï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ä»»ä½•è¯·æ±‚è¢«è°ƒåº¦è¿›æ¥ã€‚å½“é€šè¿‡ç¬¬ä¸€æ¬¡æ¢æµ‹çš„æ£€æŸ¥é€šè¿‡åï¼Œå®¹å™¨çš„çŠ¶æ€è‡ªç„¶ä¼šè½¬ä¸ºREADçŠ¶æ€ã€‚æ­¤åæ ¹æ®æŒ‡å®šçš„é—´éš”æ—¶é—´10såå†æ¬¡æ¢æµ‹ï¼Œå¦‚æœä¸é€šè¿‡ï¼Œåˆ™kuberneteså°±ä¼šå°†Pod IPä»EndPointåˆ—è¡¨ä¸­ç§»é™¤ã€‚<h2 id="é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§"><a href="#é…ç½®æ¢é’ˆ-Probe-ç›¸å…³å±æ€§" class="headerlink" title="é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§"></a>é…ç½®æ¢é’ˆ(Probe)ç›¸å…³å±æ€§</h2><p>æ¢é’ˆ(Probe)æœ‰è®¸å¤šå¯é€‰å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æ›´åŠ ç²¾ç¡®çš„æ§åˆ¶Livenesså’ŒReadinessä¸¤ç§æ¢é’ˆçš„è¡Œä¸º(Probe)ï¼š</p><p><code>initialDelaySeconds</code>ï¼šPodå¯åŠ¨åå»¶è¿Ÿå¤šä¹…æ‰è¿›è¡Œæ£€æŸ¥ï¼Œå•ä½ï¼šç§’ã€‚<br><code>periodSeconds</code>ï¼šæ£€æŸ¥çš„é—´éš”æ—¶é—´ï¼Œé»˜è®¤ä¸º10ï¼Œå•ä½ï¼šç§’ã€‚<br><code>timeoutSeconds</code>ï¼šæ¢æµ‹çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º1ï¼Œå•ä½ï¼šç§’ã€‚<br><code>successThreshold</code>ï¼šæ¢æµ‹å¤±è´¥åè®¤ä¸ºæˆåŠŸçš„æœ€å°è¿æ¥æˆåŠŸæ¬¡æ•°ï¼Œé»˜è®¤ä¸º1ï¼Œåœ¨Livenessæ¢é’ˆä¸­å¿…é¡»ä¸º1ï¼Œæœ€å°å€¼ä¸º1ã€‚<br><code>failureThreshold</code>ï¼šæ¢æµ‹å¤±è´¥çš„é‡è¯•æ¬¡æ•°ï¼Œé‡è¯•ä¸€å®šæ¬¡æ•°åå°†è®¤ä¸ºå¤±è´¥ï¼Œåœ¨readinessæ¢é’ˆä¸­ï¼ŒPodä¼šè¢«æ ‡è®°ä¸ºæœªå°±ç»ªï¼Œé»˜è®¤ä¸º3ï¼Œæœ€å°å€¼ä¸º1ã€‚</p><p>å‚è€ƒ:<br><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;å½“ä½ ä½¿ç”¨kuberentesçš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰é‡åˆ°è¿‡Podåœ¨å¯åŠ¨åä¸€ä¼šå°±æŒ‚æ‰ç„¶ååˆé‡æ–°å¯åŠ¨è¿™æ ·çš„æ¶æ€§å¾ªç¯ï¼Ÿ&lt;br&gt;ä½ æœ‰æ²¡æœ‰æƒ³è¿‡kubernetesæ˜¯å¦‚ä½•æ£€æµ‹podæ˜¯å¦è¿˜å­˜æ´»ï¼Ÿ&lt;br&gt;è™½ç„¶å®¹å™¨å·²ç»å¯åŠ¨ï¼Œä½†æ˜¯kuberneteså¦‚ä½•çŸ¥é“å®¹å™¨çš„è¿›ç¨‹æ˜¯å¦å‡†å¤‡å¥½å¯¹å¤–æä¾›æœåŠ¡äº†å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;æœ¬åšæ–‡ä¸»è¦è®°å½•å®è·µå¦‚ä½•é…ç½®å®¹å™¨çš„å­˜æ´»å’Œå°±ç»ªæ¢é’ˆã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰&lt;/strong&gt;&lt;br&gt;ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå³Podæ˜¯å¦ä¸ºrunningçŠ¶æ€ï¼Œå¦‚æœLivenessProbeæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œåˆ™kubeletå°†killæ‰å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥æ˜¯å¦é‡å¯ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨ä¸åŒ…å«LivenessProbeæ¢é’ˆï¼Œåˆ™Kubeletè®¤ä¸ºå®¹å™¨çš„LivenessProbeæ¢é’ˆçš„è¿”å›å€¼æ°¸è¿œæˆåŠŸã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;readiness probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰&lt;/strong&gt;&lt;br&gt;ç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆï¼Œå³å®¹å™¨çš„Readyæ˜¯å¦ä¸ºTrueï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœReadinessProbeæ¢æµ‹å¤±è´¥ï¼Œåˆ™å®¹å™¨çš„Readyå°†ä¸ºFalseï¼Œæ§åˆ¶å™¨å°†æ­¤Podçš„Endpointä»å¯¹åº”çš„serviceçš„Endpointåˆ—è¡¨ä¸­ç§»é™¤ï¼Œä»æ­¤ä¸å†å°†ä»»ä½•è¯·æ±‚è°ƒåº¦æ­¤Podä¸Šï¼Œç›´åˆ°ä¸‹æ¬¡æ¢æµ‹æˆåŠŸã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¯ç±»æ¢é’ˆéƒ½æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹æ³•&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;execï¼šé€šè¿‡æ‰§è¡Œå‘½ä»¤æ¥æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œé’ˆå¯¹å¤æ‚æ£€æµ‹æˆ–æ— HTTPæ¥å£çš„æœåŠ¡ï¼Œå‘½ä»¤è¿”å›å€¼ä¸º0åˆ™è¡¨ç¤ºå®¹å™¨å¥åº·ã€‚&lt;/li&gt;
&lt;li&gt;httpGetï¼šé€šè¿‡å‘é€httpè¯·æ±‚æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼Œè¿”å›200-399çŠ¶æ€ç åˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚&lt;/li&gt;
&lt;li&gt;tcpSocketï¼šé€šè¿‡å®¹å™¨çš„IPå’ŒPortæ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¯ç§æ–¹å¼éƒ½å¯ä»¥å®šä¹‰åœ¨readiness æˆ–è€…liveness ä¸­ã€‚æ¯”å¦‚å®šä¹‰readiness ä¸­http get å°±æ˜¯æ„æ€è¯´å¦‚æœæˆ‘å®šä¹‰çš„è¿™ä¸ªpathçš„http get è¯·æ±‚è¿”å›200-400ä»¥å¤–çš„http code å°±æŠŠæˆ‘ä»æ‰€æœ‰æœ‰æˆ‘çš„æœåŠ¡é‡Œé¢åˆ äº†å§ï¼Œå¦‚æœå®šä¹‰åœ¨livenessé‡Œé¢å°±æ˜¯æŠŠæˆ‘kill äº†ã€‚&lt;br&gt;æ³¨æ„ï¼Œlivenessä¸ä¼šé‡å¯podï¼Œpodæ˜¯å¦ä¼šé‡å¯ç”±ä½ çš„restart policy æ§åˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¢é’ˆæ¢æµ‹çš„ç»“æœæœ‰ä»¥ä¸‹ä¸‰è€…ä¹‹ä¸€&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Successï¼šContaineré€šè¿‡äº†æ£€æŸ¥ã€‚&lt;/li&gt;
&lt;li&gt;Failureï¼šContaineræœªé€šè¿‡æ£€æŸ¥ã€‚&lt;/li&gt;
&lt;li&gt;Unknownï¼šæœªèƒ½æ‰§è¡Œæ£€æŸ¥ï¼Œå› æ­¤ä¸é‡‡å–ä»»ä½•æªæ–½ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/categories/kubernetes/"/>
    
    
    <category term="liveness probe" scheme="https://blog.sctux.cc/tags/liveness-probe/"/>
    
    <category term="readiness probe" scheme="https://blog.sctux.cc/tags/readiness-probe/"/>
    
    <category term="restartPolicy" scheme="https://blog.sctux.cc/tags/restartPolicy/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£Kubernetesä¸­çš„è®¤è¯&amp;æˆæƒ&amp;å‡†å…¥æœºåˆ¶</title>
    <link href="https://blog.sctux.cc/2018/12/16/kubernetes-auth/"/>
    <id>https://blog.sctux.cc/2018/12/16/kubernetes-auth/</id>
    <published>2018-12-16T07:35:24.000Z</published>
    <updated>2025-09-01T01:59:08.920Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>é¦–å…ˆéœ€è¦äº†è§£è¿™ä¸‰ç§æœºåˆ¶çš„åŒºåˆ«ï¼š</p><ul><li>è®¤è¯(Authenticating)æ˜¯å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ï¼Œé€šä¿—ç‚¹å°±æ˜¯ç”¨æˆ·åå¯†ç éªŒè¯ï¼Œ</li><li>æˆæƒ(Authorization)æ˜¯å¯¹èµ„æºçš„æˆæƒï¼Œk8sä¸­çš„èµ„æºæ— éæ˜¯å®¹å™¨ï¼Œæœ€ç»ˆå…¶å®å°±æ˜¯å®¹å™¨çš„è®¡ç®—ï¼Œç½‘ç»œï¼Œå­˜å‚¨èµ„æºï¼Œå½“ä¸€ä¸ªè¯·æ±‚ç»è¿‡è®¤è¯åï¼Œéœ€è¦è®¿é—®æŸä¸€ä¸ªèµ„æºï¼ˆæ¯”å¦‚åˆ›å»ºä¸€ä¸ªpodï¼‰ï¼Œæˆæƒæ£€æŸ¥éƒ½ä¼šé€šè¿‡è®¿é—®ç­–ç•¥æ¯”è¾ƒè¯¥è¯·æ±‚ä¸Šä¸‹æ–‡çš„å±æ€§ï¼Œï¼ˆæ¯”å¦‚ç”¨æˆ·ï¼Œèµ„æºå’ŒNamespaceï¼‰ï¼Œæ ¹æ®æˆæƒè§„åˆ™åˆ¤å®šè¯¥èµ„æºï¼ˆæ¯”å¦‚æŸnamespaceä¸‹çš„podï¼‰æ˜¯å¦æ˜¯è¯¥å®¢æˆ·å¯è®¿é—®çš„ã€‚</li><li>å‡†å…¥(Admission Control)æœºåˆ¶æ˜¯ä¸€ç§åœ¨æ”¹å˜èµ„æºçš„æŒä¹…åŒ–ä¹‹å‰ï¼ˆæ¯”å¦‚æŸäº›èµ„æºçš„åˆ›å»ºæˆ–åˆ é™¤ï¼Œä¿®æ”¹ç­‰ä¹‹å‰ï¼‰çš„æœºåˆ¶ã€‚<br>åœ¨k8sä¸­ï¼Œè¿™ä¸‰ç§æœºåˆ¶å¦‚ä¸‹å›¾ï¼š<br><img src="/2018/12/16/kubernetes-auth/k8s-authorition.png" alt="k8s-authorition"><br>k8sçš„æ•´ä½“æ¶æ„ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡çš„æ¶æ„ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªGateWayï¼Œä¹Ÿå°±æ˜¯kube-apiserverè¿™ä¸ªç»„ä»¶ï¼ˆå¯¹å¤–æä¾›RESTæœåŠ¡ï¼‰ï¼Œç”±å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œk8sä¸­å®¢æˆ·ç«¯æœ‰ä¸¤ç±»ï¼Œä¸€ç§æ˜¯æ™®é€šç”¨æˆ·ï¼Œä¸€ç§æ˜¯é›†ç¾¤å†…çš„Podï¼Œè¿™ä¸¤ç§å®¢æˆ·ç«¯çš„è®¤è¯æœºåˆ¶ç•¥æœ‰ä¸åŒï¼Œåæ–‡ä¼šè¯¦è¿°ã€‚ä½†æ— è®ºæ˜¯å“ªä¸€ç§ï¼Œéƒ½éœ€è¦ä¾æ¬¡ç»è¿‡è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥è¿™ä¸‰ä¸ªæœºåˆ¶ã€‚<br><img src="/2018/12/16/kubernetes-auth/auththentication&amp;authorization.png" alt="æˆªå›¾æ¥è‡ªåä¸ºCCEäº‘è¯¾å ‚"></li></ul><h1 id="kubernetes-ä¸­çš„è®¤è¯æœºåˆ¶"><a href="#kubernetes-ä¸­çš„è®¤è¯æœºåˆ¶" class="headerlink" title="kubernetes ä¸­çš„è®¤è¯æœºåˆ¶"></a>kubernetes ä¸­çš„è®¤è¯æœºåˆ¶</h1><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œkubernetesè™½ç„¶æä¾›äº†å¤šç§è®¤è¯æœºåˆ¶ï¼Œä½†å¹¶æ²¡æœ‰æä¾›user å®ä½“ä¿¡æ¯çš„å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè´¦æˆ·ä½“ç³»éœ€è¦æˆ‘ä»¬è‡ªå·±å»åšç»´æŠ¤ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥æ¥å…¥ç¬¬ä¸‰æ–¹è´¦æˆ·ä½“ç³»ï¼ˆå¦‚è°·æ­Œè´¦æˆ·ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¼€æºçš„keystoneå»åšæ•´åˆã€‚kubernetes æ”¯æŒå¤šç§è®¤è¯æœºåˆ¶ï¼Œå¯ä»¥é…ç½®æˆå¤šä¸ªè®¤è¯ä½“åˆ¶å…±å­˜ï¼Œè¿™æ ·ï¼Œåªè¦æœ‰ä¸€ä¸ªè®¤è¯é€šè¿‡ï¼Œè¿™ä¸ªrequestå°±è®¤è¯é€šè¿‡äº†ã€‚ä¸‹é¢åˆ—ä¸¾çš„æ˜¯å®˜ç½‘å‡ ç§å¸¸è§è®¤è¯æœºåˆ¶ï¼š</p><ul><li>X509 Client Certs</li><li>Static Token File</li><li>Bootstrap Tokens</li><li>Static Password File</li><li>Service Account Tokens</li><li>OpenID Connect Tokens</li></ul><p>è¿™é‡Œæˆ‘ä¸»è¦è¿˜æ˜¯ç†è§£ä¸€ä¸‹å¸¸ç”¨è®¤è¯æ–¹å¼:</p><h2 id="X509-Client-Certs"><a href="#X509-Client-Certs" class="headerlink" title="X509 Client Certs"></a>X509 Client Certs</h2><p>ä¹Ÿå«ä½œåŒå‘æ•°å­—è¯ä¹¦è®¤è¯ï¼ŒHTTPSè¯ä¹¦è®¤è¯ï¼Œæ˜¯åŸºäºCAæ ¹è¯ä¹¦ç­¾åçš„åŒå‘æ•°å­—è¯ä¹¦è®¤è¯æ–¹å¼ï¼Œæ˜¯æ‰€æœ‰è®¤è¯æ–¹å¼ä¸­æœ€ä¸¥æ ¼çš„è®¤è¯ã€‚é»˜è®¤åœ¨kubeadmåˆ›å»ºçš„é›†ç¾¤ä¸­æ˜¯enabledçš„ï¼Œå¯ä»¥åœ¨master nodeä¸ŠæŸ¥çœ‹kube-apiserverçš„podé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/local/bin/kube-apiserver \</span><br><span class="line">      <span class="attribute">--v</span>=2  \</span><br><span class="line">      <span class="attribute">--logtostderr</span>=<span class="literal">true</span>  \</span><br><span class="line">      <span class="attribute">--allow-privileged</span>=<span class="literal">true</span>  \</span><br><span class="line">      <span class="attribute">--bind-address</span>=0.0.0.0  \</span><br><span class="line">      <span class="attribute">--secure-port</span>=6443  \</span><br><span class="line">      <span class="attribute">--insecure-port</span>=0  \</span><br><span class="line">      <span class="attribute">--advertise-address</span>=192.168.56.110 \</span><br><span class="line">      <span class="attribute">--service-cluster-ip-range</span>=10.96.0.0/12  \</span><br><span class="line">      <span class="attribute">--service-node-port-range</span>=30000-32767  \</span><br><span class="line">      <span class="attribute">--etcd-servers</span>=https://192.168.56.111:2379,https://192.168.56.112:2379,https://192.168.56.113:2379 \</span><br><span class="line">      <span class="attribute">--etcd-cafile</span>=/etc/etcd/ssl/etcd-ca.pem  \</span><br><span class="line">      <span class="attribute">--etcd-certfile</span>=/etc/etcd/ssl/etcd.pem  \</span><br><span class="line">      <span class="attribute">--etcd-keyfile</span>=/etc/etcd/ssl/etcd-key.pem  \</span><br><span class="line">      <span class="attribute">--client-ca-file</span>=/etc/kubernetes/pki/ca.pem  \</span><br><span class="line">      <span class="attribute">--tls-cert-file</span>=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      <span class="attribute">--tls-private-key-file</span>=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line">      <span class="attribute">--kubelet-client-certificate</span>=/etc/kubernetes/pki/apiserver.pem  \</span><br><span class="line">      <span class="attribute">--kubelet-client-key</span>=/etc/kubernetes/pki/apiserver-key.pem  \</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br></pre></td></tr></tbody></table></figure><p>ç›¸å…³çš„ä¸‰ä¸ªå¯åŠ¨å‚æ•°ï¼š</p><ul><li>client-ca-file: æŒ‡å®šCAæ ¹è¯ä¹¦æ–‡ä»¶ä¸º/etc/kubernetes/pki/ca.pem</li><li>tls-private-key-file: æŒ‡å®šApiServerç§é’¥æ–‡ä»¶ä¸º/etc/kubernetes/pki/apiserver-key.pem</li><li>tls-cert-fileï¼šæŒ‡å®šApiServerè¯ä¹¦æ–‡ä»¶ä¸º/etc/kubernetes/pki/apiserver.pem</li></ul><p>è¯·æ±‚ä¸­éœ€è¦å¸¦æœ‰ç”±è¯¥è¯ä¹¦ç­¾åçš„è¯ä¹¦ï¼Œæ‰èƒ½è®¤è¯é€šè¿‡ï¼Œå®¢æˆ·ç«¯ç­¾ç½²çš„è¯ä¹¦é‡ŒåŒ…å«user,groupä¿¡æ¯ï¼Œå…·ä½“ä¸ºè¯ä¹¦çš„subject.CommonName(username)ä»¥åŠsubject.Organization(group)</p><div style="width: 50%; margin: auto">![x509](kubernetes-auth/x509.png)</div><h2 id="Service-Account-Tokens"><a href="#Service-Account-Tokens" class="headerlink" title="Service Account Tokens"></a>Service Account Tokens</h2><p>Service Account Token æ˜¯ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„è®¤è¯æœºåˆ¶ï¼Œé€‚ç”¨äºä¸Šæ–‡ä¸­æåˆ°çš„podå†…éƒ¨æœåŠ¡éœ€è¦è®¿é—®apiserverçš„è®¤è¯æƒ…å†µï¼Œé»˜è®¤enabledã€‚<br>è¿˜æ˜¯çœ‹ä¸Šæ–‡ä¸­apiserver çš„å¯åŠ¨é…ç½®å‚æ•°æœ‰â€“service-account-key-fileï¼Œå¦‚æœæ²¡æœ‰æŒ‡æ˜æ–‡ä»¶ï¼Œé»˜è®¤ä½¿ç”¨â€“tls-private-key-fileçš„å€¼ï¼Œå³API Serverçš„ç§é’¥ã€‚</p><div style="width: 50%; margin: auto">![ServiceAccountå·¥ä½œæµç¨‹](kubernetes-auth/sa.png) </div><p>é€šè¿‡æ§åˆ¶å™¨ServiceAccountControllerä¼šå»list,watch k8s apiserverå¯¹äºå‘½åç©ºé—´çš„åˆ›å»ºã€åˆ é™¤ï¼›<br>å°±ä¼šåœ¨æ–°åˆ›å»ºçš„åç§°ç©ºé—´ä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºâ€defaultâ€çš„service account;</p><p>TokenController æ ¹æ®åˆ›å»ºçš„ServiceAccountä¸‹é¢å…³è”ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰Tokençš„secretã€‚<br>Admission æ˜¯åœ¨é€šè¿‡è®¤è¯è¿›è¡Œé‰´æƒçš„ä¸€ä¸ªé˜¶æ®µï¼Œé‚£ä¹ˆä»–ä¼šé»˜è®¤ç»™å½“å‰åç§°ç©ºé—´ä¸‹çš„podæ‰“ä¸Šï¼Œå½“å‰åç§°ç©ºé—´çš„é‚£ä¸ªServiceAccountã€‚</p><p>service accoutæœ¬èº«æ˜¯ä½œä¸ºä¸€ç§èµ„æºåœ¨k8sé›†ç¾¤ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè·å–</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get sa <span class="operator">-</span>-all-namespaces</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                 SECRETS   AGE</span><br><span class="line">default       default                              <span class="number">1</span>         <span class="number">16</span>d</span><br><span class="line">kube-system   default                              <span class="number">1</span>         <span class="number">16</span>d</span><br><span class="line">kube-public   default                              <span class="number">1</span>         <span class="number">16</span>d</span><br><span class="line">kube-system   attachdetach-controller              <span class="number">1</span>         <span class="number">16</span>d</span><br><span class="line">kube-system   bootstrap-signer                     <span class="number">1</span>         <span class="number">16</span>d</span><br><span class="line">kube-system   calico-node                          <span class="number">1</span>         <span class="number">16</span></span><br><span class="line">...........</span><br><span class="line">...........</span><br><span class="line"></span><br><span class="line">$ kubectl describe serviceaccount<span class="symbol">/default</span> <span class="operator">-</span>n kube-system</span><br><span class="line"><span class="params">Name:</span>                default</span><br><span class="line"><span class="params">Namespace:</span>           kube-system</span><br><span class="line"><span class="params">Labels:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>         <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Image pull <span class="params">secrets:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Mountable <span class="params">secrets:</span>   default-token-q9s9l</span><br><span class="line"><span class="params">Tokens:</span>              default-token-q9s9l</span><br><span class="line"><span class="params">Events:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line">$ kubectl get secret default-token-q9s9l <span class="operator">-</span>o yaml <span class="operator">-</span>n kube-system</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  ca.<span class="params">crt:</span> LS0tLS1CRUdJ ...............ç•¥</span><br><span class="line">  <span class="params">namespace:</span> a3ViZS1zeXN0ZW0<span class="operator">=</span></span><br><span class="line">  <span class="params">token:</span> ZXlKaGJHY2lPaUpTVX- ...............ç•¥</span><br><span class="line"><span class="params">kind:</span> Secret</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">annotations:</span></span><br><span class="line">    kubernetes.io<span class="operator">/</span>service-account.<span class="params">name:</span> default</span><br><span class="line">    kubernetes.io<span class="operator">/</span>service-account.<span class="params">uid:</span> a5568634-f445-<span class="number">11</span>e8-b4c4-<span class="number">000</span>c295134cf</span><br><span class="line">  <span class="params">creationTimestamp:</span> <span class="number">201</span>8-<span class="number">1</span>1-<span class="number">30</span>T02:<span class="number">14</span>:<span class="number">19</span>Z</span><br><span class="line">  <span class="params">name:</span> default-token-q9s9l</span><br><span class="line">  <span class="params">namespace:</span> kube-system</span><br><span class="line">  <span class="params">resourceVersion:</span> <span class="string">"337"</span></span><br><span class="line">  <span class="params">selfLink:</span> <span class="symbol">/api/v1/namespaces/kube-system/secrets/default-token-q9s9l</span></span><br><span class="line">  <span class="params">uid:</span> a56521fd-f445-<span class="number">11</span>e8-aa44-<span class="number">000</span>c29fe5618</span><br><span class="line"><span class="params">type:</span> kubernetes.io<span class="symbol">/service-account-token</span></span><br><span class="line">[root@k8s-m1 kubelet]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°service-account-tokençš„secretèµ„æºåŒ…å«çš„æ•°æ®æœ‰ä¸‰éƒ¨åˆ†ï¼š</p><ul><li>ca.crtï¼Œè¿™æ˜¯API Serverçš„CAå…¬é’¥è¯ä¹¦ï¼Œç”¨äºPodä¸­çš„Processå¯¹API Serverçš„æœåŠ¡ç«¯æ•°å­—è¯ä¹¦è¿›è¡Œæ ¡éªŒæ—¶ä½¿ç”¨çš„ï¼›</li><li>namespaceï¼Œè¿™æ˜¯Secretæ‰€åœ¨namespaceçš„å€¼çš„base64ç¼–ç ï¼š# echo -n â€œkube-systemâ€|base64 =&gt; â€œa3ViZS1zeXN0ZW0=â€</li><li>tokenï¼šè¯¥tokenå°±æ˜¯ç”±service-account-key-fileçš„å€¼ç­¾ç½²(sign)ç”Ÿæˆã€‚</li></ul><h3 id="API-Serverçš„service-account-authentication-èº«ä»½éªŒè¯"><a href="#API-Serverçš„service-account-authentication-èº«ä»½éªŒè¯" class="headerlink" title="API Serverçš„service account authentication(èº«ä»½éªŒè¯)"></a>API Serverçš„service account authentication(èº«ä»½éªŒè¯)</h3><p>å‰é¢è¯´è¿‡ï¼Œservice accountä¸ºPodä¸­çš„Processæä¾›äº†ä¸€ç§èº«ä»½æ ‡è¯†ï¼Œåœ¨Kubernetesçš„èº«ä»½æ ¡éªŒ(authenticating)ç¯èŠ‚ï¼Œä»¥æŸä¸ªservice accountæä¾›èº«ä»½çš„Podçš„ç”¨æˆ·åä¸ºï¼š</p><figure class="highlight vbnet"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">system:</span>serviceaccount:(<span class="keyword">NAMESPACE</span>):(SERVICEACCOUNT)</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šé¢é‚£ä¸ªkube-system namespaceä¸‹çš„<code>default</code> service accountä¸ºä¾‹ï¼Œä½¿ç”¨å®ƒçš„Podçš„usernameå…¨ç§°ä¸ºï¼š</p><figure class="highlight hsp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">system</span>:serviceaccount:kube-<span class="keyword">system</span>:<span class="keyword">default</span></span><br></pre></td></tr></tbody></table></figure><h3 id="é»˜è®¤çš„service-account"><a href="#é»˜è®¤çš„service-account" class="headerlink" title="é»˜è®¤çš„service account"></a>é»˜è®¤çš„service account</h3><p>Kubernetesä¼šä¸ºæ¯ä¸ªclusterä¸­çš„namespaceè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„service accountèµ„æºï¼Œå¹¶å‘½åä¸ºâ€defaultâ€.</p><p>å¦‚æœPodä¸­æ²¡æœ‰æ˜¾å¼æŒ‡å®šspec.serviceAccountå­—æ®µå€¼(è‡ªå®šä¹‰Admission)ï¼Œé‚£ä¹ˆKubernetesä¼šé»˜è®¤å°†è¯¥namespaceä¸‹çš„default service accountè‡ªåŠ¨mountåˆ°åœ¨è¿™ä¸ªnamespaceä¸­åˆ›å»ºçš„Podé‡Œï¼Œé‚£è¿™ä¸ªæ“ä½œå°±æ˜¯é€šè¿‡ä¸Šé¢æ‰€è¯´çš„ServiceAccountAdmissionæ¥å®ç°çš„ã€‚<br>æˆ‘ä»¬ä»¥namespace â€œdefaultâ€ä¸ºä¾‹ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹å…¶ä¸­çš„ä¸€ä¸ªPodçš„ä¿¡æ¯ï¼š</p><figure class="highlight lasso"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pod nginx<span class="number">-64</span>f497f8fd<span class="params">-lkmdr</span></span><br><span class="line">Name:           nginx<span class="number">-64</span>f497f8fd<span class="params">-lkmdr</span></span><br><span class="line">Namespace:      default</span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line">Containers:</span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line">      Mounts:</span><br><span class="line">      /<span class="built_in">var</span>/run/secrets/kubernetes.io/serviceaccount from default<span class="params">-token</span><span class="params">-d5d8g</span> (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  <span class="keyword">Type</span>              Status</span><br><span class="line">  Initialized       <span class="literal">True</span></span><br><span class="line">  Ready             <span class="literal">False</span></span><br><span class="line">  ContainersReady   <span class="literal">False</span></span><br><span class="line">  PodScheduled      <span class="literal">True</span></span><br><span class="line">Volumes:</span><br><span class="line"> <span class="params">...</span><span class="params">...</span></span><br><span class="line"> <span class="params">...</span><span class="params">...</span></span><br><span class="line">Events:</span><br><span class="line">  <span class="keyword">Type</span>    Reason     Age   From               Message</span><br><span class="line">  ----    ------     ----  ----               -------</span><br><span class="line">  Normal  Scheduled  <span class="number">27</span>s   default<span class="params">-scheduler</span>  Successfully assigned default/nginx<span class="number">-64</span>f497f8fd<span class="params">-lkmdr</span> <span class="keyword">to</span> k8s<span class="params">-m3</span></span><br><span class="line">  Normal  Pulling    <span class="number">17</span>s   kubelet, k8s<span class="params">-m3</span>    pulling image <span class="string">"nginx"</span></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œkuberneteså°†default namespaceä¸­çš„service account â€œdefaultâ€çš„service account tokenæŒ‚è½½(mount)åˆ°äº†Podä¸­å®¹å™¨çš„/var/run/secrets/kubernetes.io/serviceaccountè·¯å¾„ä¸‹ã€‚</p><p>æ·±å…¥å®¹å™¨å†…éƒ¨ï¼ŒæŸ¥çœ‹mountçš„serviceaccountè·¯å¾„ä¸‹çš„ç»“æ„ï¼š</p><figure class="highlight stata"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec nginx-64f497f8fd-lkmdr -- <span class="keyword">ls</span> /<span class="keyword">var</span>/<span class="keyword">run</span>/secrets/kubernetes.io/serviceaccount</span><br><span class="line"><span class="keyword">ca</span>.crt</span><br><span class="line">namespace</span><br><span class="line"><span class="keyword">token</span></span><br><span class="line"></span><br><span class="line"># è¿™ä¸‰ä¸ªæ–‡ä»¶ä¸ä¸Šé¢æåˆ°çš„service accountçš„<span class="keyword">token</span>ä¸­çš„æ•°æ®æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚</span><br></pre></td></tr></tbody></table></figure><h3 id="å¦‚ä½•åˆ›å»ºä¸€ä¸ªServiceAccount"><a href="#å¦‚ä½•åˆ›å»ºä¸€ä¸ªServiceAccount" class="headerlink" title="å¦‚ä½•åˆ›å»ºä¸€ä¸ªServiceAccount"></a>å¦‚ä½•åˆ›å»ºä¸€ä¸ªServiceAccount</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡å‘½ä»¤è¡Œç›´æ¥åˆ›å»º</span></span><br><span class="line">$ kubectl create sa myk8ssa</span><br><span class="line">serviceaccount<span class="symbol">/myk8ssa</span> created</span><br><span class="line">$ kubectl describe sa<span class="symbol">/myk8ssa</span></span><br><span class="line"><span class="params">Name:</span>                mysa</span><br><span class="line"><span class="params">Namespace:</span>           default</span><br><span class="line"><span class="params">Labels:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>         <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Image pull <span class="params">secrets:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Mountable <span class="params">secrets:</span>   mysa-token-kcwqm</span><br><span class="line"><span class="params">Tokens:</span>              mysa-token-kcwqm</span><br><span class="line"><span class="params">Events:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚ä½•ä½¿ç”¨ï¼Ÿä¸‹é¢æˆ‘åœ¨è®¨è®º</span></span><br></pre></td></tr></tbody></table></figure><h1 id="kubernetes-ä¸­çš„é‰´æƒæœºåˆ¶"><a href="#kubernetes-ä¸­çš„é‰´æƒæœºåˆ¶" class="headerlink" title="kubernetes ä¸­çš„é‰´æƒæœºåˆ¶"></a>kubernetes ä¸­çš„é‰´æƒæœºåˆ¶</h1><p>ç›®å‰ï¼Œk8s ä¸­ä¸€å…±æœ‰ 4 ç§é‰´æƒæƒé™æ¨¡å¼ï¼š</p><ul><li>Node: ä¸€ç§ç‰¹æ®Šç›®çš„çš„æˆæƒæ¨¡å¼ï¼Œä¸»è¦ç”¨æ¥è®© kubernetes éµä» node çš„ç¼–æ’è§„åˆ™ï¼Œå®é™…ä¸Šæ˜¯ RBAC çš„ä¸€éƒ¨åˆ†ï¼Œç›¸å½“äºåªå®šä¹‰äº† node è¿™ä¸ªè§’è‰²ä»¥åŠå®ƒçš„æƒé™ï¼›</li><li>ABAC: Attribute-based access controlï¼›</li><li>RBAC: Role-based access controlï¼›</li><li>Webhook: ä»¥ HTTP Callback çš„æ–¹å¼ï¼Œåˆ©ç”¨å¤–éƒ¨æˆæƒæ¥å£æ¥è¿›è¡Œæƒé™æ§åˆ¶ï¼›</li></ul><p>è¿™é‡Œæˆ‘ä¸»è¦å­¦ä¹ æ€»ç»“æœ€å¸¸ç”¨çš„é‰´æƒæ–¹å¼â€”<code>RBAC</code><br>RBACçš„é‰´æƒç­–ç•¥å¯ä»¥åˆ©ç”¨ kubectl æˆ–è€… Kubernetes API ç›´æ¥è¿›è¡Œé…ç½®ã€‚RBAC å¯ä»¥æˆæƒç»™ç”¨æˆ·ï¼Œè®©ç”¨æˆ·æœ‰æƒè¿›è¡Œæˆæƒç®¡ç†ï¼Œè¿™æ ·å°±å¯ä»¥æ— éœ€æ¥è§¦èŠ‚ç‚¹ï¼Œç›´æ¥è¿›è¡Œæˆæƒç®¡ç†ã€‚RBAC åœ¨ Kubernetes ä¸­è¢«æ˜ å°„ä¸º API èµ„æºå’Œæ“ä½œã€‚</p><div style="width: 50%; margin: auto">![RBAC](kubernetes-auth/RBAC.png)</div><p>éœ€è¦ç†è§£ RBAC ä¸€äº›åŸºç¡€çš„æ¦‚å¿µå’Œæ€è·¯ï¼ŒRBAC æ˜¯è®©ç”¨æˆ·èƒ½å¤Ÿè®¿é—® Kubernetes API èµ„æºçš„æˆæƒæ–¹å¼ã€‚</p><p><em><strong>role</strong></em><br>è§’è‰²æ˜¯ä¸€ç³»åˆ—æƒé™çš„é›†åˆï¼Œä¾‹å¦‚ä¸€ä¸ªè§’è‰²å¯ä»¥åŒ…å«è¯»å– Pod çš„æƒé™å’Œåˆ—å‡º Pod çš„æƒé™ï¼Œ ClusterRole è·Ÿ Role ç±»ä¼¼ï¼Œä½†æ˜¯å¯ä»¥åœ¨é›†ç¾¤ä¸­åˆ°å¤„ä½¿ç”¨ï¼ˆ Role æ˜¯ namespace ä¸€çº§çš„ï¼‰ã€‚<br><em><strong>role binding</strong></em><br>RoleBinding æŠŠè§’è‰²æ˜ å°„åˆ°ç”¨æˆ·ï¼Œä»è€Œè®©è¿™äº›ç”¨æˆ·ç»§æ‰¿è§’è‰²åœ¨ namespace ä¸­çš„æƒé™ã€‚ClusterRoleBinding è®©ç”¨æˆ·ç»§æ‰¿ ClusterRole åœ¨æ•´ä¸ªé›†ç¾¤ä¸­çš„æƒé™ã€‚</p><p>å¦å¤–è¿˜è¦è€ƒè™‘<code>cluster roles</code>å’Œ<code>cluster role binding</code>ã€‚cluster roleå’Œcluster role bindingæ–¹æ³•è·Ÿroleå’Œrole bindingä¸€æ ·ï¼Œå‡ºäº†å®ƒä»¬æœ‰æ›´å¹¿çš„scopeã€‚</p><p><em><strong>Kubernetesä¸­çš„RBAC</strong></em><br>RBAC ç°åœ¨è¢« Kubernetes æ·±åº¦é›†æˆï¼Œå¹¶ä½¿ç”¨ä»–ç»™ç³»ç»Ÿç»„ä»¶è¿›è¡Œæˆæƒã€‚System Roles ä¸€èˆ¬å…·æœ‰å‰ç¼€system:ï¼Œå¾ˆå®¹æ˜“è¯†åˆ«ï¼š</p><figure class="highlight x86asm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get clusterroles --namespace=kube-system</span><br><span class="line">NAME                                                                   AGE</span><br><span class="line">admin                                                                  <span class="number">16d</span></span><br><span class="line">anonymous-dashboard-proxy-role                                         <span class="number">16d</span></span><br><span class="line">calico-node                                                            <span class="number">16d</span></span><br><span class="line">calicoctl                                                              <span class="number">16d</span></span><br><span class="line">cluster-admin                                                          <span class="number">16d</span></span><br><span class="line">edit                                                                   <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>aggregate-to-admin                                              <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>aggregate-to-edit                                               <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>aggregate-to-view                                               <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>auth-delegator                                                  <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>aws-cloud-provider                                              <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>basic-user                                                      <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>certificates<span class="number">.</span>k8s<span class="number">.</span>io:certificatesigningrequests:nodeclient       <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>certificates<span class="number">.</span>k8s<span class="number">.</span>io:certificatesigningrequests:selfnodeclient   <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:attachdetach-controller                              <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:certificate-controller                               <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:clusterrole-aggregation-controller                   <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:cronjob-controller                                   <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:daemon-set-controller                                <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:deployment-controller                                <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:disruption-controller                                <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:endpoint-controller                                  <span class="number">16d</span></span><br><span class="line"><span class="symbol">system:</span>controller:expand-controller                                    <span class="number">16d</span></span><br><span class="line">......ç•¥</span><br></pre></td></tr></tbody></table></figure><p>ç¤ºä¾‹ï¼š</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> role.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">kind:</span> Role</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line">  <span class="params">name:</span> pod-reader</span><br><span class="line"><span class="params">rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">""</span>] <span class="comment"># "" indicates the core API group</span></span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"pods"</span>] <span class="comment"># å¯ç”¨æ“ä½œèµ„æºå¯¹è±¡</span></span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"get"</span>, <span class="string">"watch"</span>, <span class="string">"list"</span>] <span class="comment"># å¯¹ä¸Šé¢å®šä¹‰èµ„æºæœ‰å“ªäº›æ“ä½œæƒé™</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> rolebinding.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">kind:</span> RoleBinding</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> pod-reader-binding</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">subjects:</span>  </span><br><span class="line"><span class="operator">-</span> <span class="params">kind:</span> ServiceAccount </span><br><span class="line">  <span class="params">name:</span> mysa  </span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">roleRef:</span></span><br><span class="line">    <span class="params">kind:</span> Role</span><br><span class="line">    <span class="params">name:</span> pod-reader</span><br><span class="line">    <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»º</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f role.yaml</span><br><span class="line">role.rbac.authorization.k8s.io<span class="symbol">/pod-reader</span> created</span><br><span class="line">$ kubectl create <span class="operator">-</span>f rolebinding.yaml</span><br><span class="line">rolebinding.rbac.authorization.k8s.io<span class="symbol">/pod-reader-binding</span> created</span><br><span class="line"></span><br><span class="line">[root@k8s-m1 ~]<span class="comment"># kubectl get role</span></span><br><span class="line">NAME         AGE</span><br><span class="line">pod-reader   <span class="number">36</span>s</span><br><span class="line">[root@k8s-m1 ~]<span class="comment"># kubectl describe role pod-reader</span></span><br><span class="line"><span class="params">Name:</span>         pod-reader</span><br><span class="line"><span class="params">Labels:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">PolicyRule:</span></span><br><span class="line">  Resources  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  <span class="operator">-</span>--------  <span class="operator">-</span>----------------  <span class="operator">-</span>-------------  <span class="operator">-</span>----</span><br><span class="line">  pods       []                 []              [get watch list]</span><br><span class="line">$ kubectl describe rolebinding pod-reader-binding</span><br><span class="line"><span class="params">Name:</span>         pod-reader-binding</span><br><span class="line"><span class="params">Labels:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Role:</span></span><br><span class="line">  <span class="params">Kind:</span>  Role</span><br><span class="line">  <span class="params">Name:</span>  pod-reader</span><br><span class="line"><span class="params">Subjects:</span></span><br><span class="line">  Kind            Name  Namespace</span><br><span class="line">  <span class="operator">-</span>---            <span class="operator">-</span>---  <span class="operator">-</span>--------</span><br><span class="line">  ServiceAccount  mysa  default</span><br><span class="line"> </span><br></pre></td></tr></tbody></table></figure><p>ä¸Šé¢ï¼Œ</p><ol><li>æˆ‘å®šä¹‰äº†ä¸€ä¸ªpod-readerçš„role,å…¶ä¸­å®ƒçš„æƒé™å®šä¹‰å¦‚ä¸Šæ–¹å®šä¹‰çš„<code>get</code>,<code>watch</code>,<code>list</code>;</li><li>ç„¶åå®šä¹‰äº†ä¸€ä¸ªpod-reader-bindingçš„rolebinding<br>å‰é¢æåˆ°è¿‡ï¼›ç”¨æˆ·é€šè¿‡è®¤è¯ä¹‹åå°±æ˜¯é‰´æƒï¼Œé€šè¿‡SAçš„è®¤è¯æ–¹å¼ä¹‹åæ‹¿åˆ°userinfo,ç„¶åç»‘å®šåˆ°roleé‡Œé¢ï¼›é‚£ä¹ˆæ­¤æ—¶å¯¹åº”çš„ç”¨æˆ·æƒé™å°±æ˜¯roleé‡Œé¢å®šä¹‰çš„æƒé™ï¼Œsubjectsåº”ç”¨çš„å¯¹è±¡ç±»å‹ä¹Ÿå¯ä»¥æ˜¯User,Group;æ€»ä¹‹æ­¤æ—¶è¿™ä¸€æ­¥å°±æ˜¯è·å–åˆ°userinfoä¿¡æ¯ï¼Œç„¶åé€šè¿‡è§’è‰²ç»‘å®šã€‚ç›¸å¯¹åº”çš„æƒé™å°±ä¼šèµ‹äºˆè¯¥ç”¨æˆ·ã€‚é‚£ç”¨æˆ·ä»ä½•è€Œæ¥ï¼Ÿä¸‹é¢å°±éœ€è¦åˆ›å»ºä¸€ä¸ªç”¨æˆ·æ¥è®¿é—®æˆ‘ä»¬çš„é›†ç¾¤äº†ã€‚</li></ol><p>é‚£å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ServiceAccountæ¥ç™»å½•å¹¶ä¸”é€šè¿‡è‡ªå®šä¹‰çš„è¿™ä¸ªRBACæ¥é‰´æƒå‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°äº†kubeconfigæ–‡ä»¶ç”Ÿæˆçš„é—®é¢˜äº†</p><h2 id="åˆ›å»ºkubeconfig"><a href="#åˆ›å»ºkubeconfig" class="headerlink" title="åˆ›å»ºkubeconfig"></a>åˆ›å»ºkubeconfig</h2><h3 id="è·å–ä¸Šé¢å·²åˆ›å»ºçš„ServiceAccountçš„Seteråç§°"><a href="#è·å–ä¸Šé¢å·²åˆ›å»ºçš„ServiceAccountçš„Seteråç§°" class="headerlink" title="è·å–ä¸Šé¢å·²åˆ›å»ºçš„ServiceAccountçš„Seteråç§°"></a>è·å–ä¸Šé¢å·²åˆ›å»ºçš„ServiceAccountçš„Seteråç§°</h3><p>è¿™é‡Œæˆ‘æ˜¯åœ¨é»˜è®¤namespaceä¸‹é¢åˆ›å»ºçš„ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe sa<span class="symbol">/myk8ssa</span></span><br><span class="line"><span class="params">Name:</span>                myk8ssa</span><br><span class="line"><span class="params">Namespace:</span>           default</span><br><span class="line"><span class="params">Labels:</span>              <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>         <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Image pull <span class="params">secrets:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line">Mountable <span class="params">secrets:</span>   myk8ssa-token-<span class="number">2</span>kntd</span><br><span class="line"><span class="params">Tokens:</span>              myk8ssa-token-<span class="number">2</span>kntd</span><br><span class="line"><span class="params">Events:</span>              <span class="symbol">&lt;none&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="è·å–secretä¸‹çš„tokenï¼Œå¹¶base64è§£ç è·å–tokenæ˜æ–‡"><a href="#è·å–secretä¸‹çš„tokenï¼Œå¹¶base64è§£ç è·å–tokenæ˜æ–‡" class="headerlink" title="è·å–secretä¸‹çš„tokenï¼Œå¹¶base64è§£ç è·å–tokenæ˜æ–‡"></a>è·å–secretä¸‹çš„tokenï¼Œå¹¶base64è§£ç è·å–tokenæ˜æ–‡</h3><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="attribute">token</span>=`kubectl <span class="built_in">get</span><span class="built_in"> secret </span>myk8ssa-token-2kntd -oyaml |grep token: | awk <span class="string">'{print $2}'</span> | xargs echo -n | base64 -d`</span><br><span class="line">$ echo <span class="variable">$token</span></span><br><span class="line">eyJhbGciOiJSUzI1<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>ç•¥</span><br></pre></td></tr></tbody></table></figure><h3 id="æ–°å¢ç”¨æˆ·guomaoqiu"><a href="#æ–°å¢ç”¨æˆ·guomaoqiu" class="headerlink" title="æ–°å¢ç”¨æˆ·guomaoqiu"></a>æ–°å¢ç”¨æˆ·guomaoqiu</h3><figure class="highlight dsconfig"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-cluster</span> <span class="string">my-k8s</span> <span class="built_in">--server=https://192.168.56.110:8443</span> \</span><br><span class="line"><span class="built_in">--certificate-authority=/etc/kubernetes/pki/ca.pem</span> \</span><br><span class="line"><span class="built_in">--embed-certs=true</span></span><br><span class="line"><span class="string">Cluster</span> <span class="string">"my-k8s"</span> <span class="string">set</span>.</span><br><span class="line"></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-credentials</span> <span class="string">guomaoqiu</span> <span class="built_in">--token=$token</span></span><br><span class="line"><span class="string">User</span> <span class="string">"guomaoqiu"</span> <span class="string">set</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¸‹æ–‡</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-context</span> <span class="string">my-k8s</span> <span class="built_in">--cluster=kubernetes</span></span><br><span class="line"><span class="string">Context</span> <span class="string">"my-k8s"</span> <span class="string">created</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">$ <span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-context</span> <span class="string">my-k8s</span> <span class="built_in">--user=guomaoqiu</span></span><br><span class="line"><span class="string">Context</span> <span class="string">"my-k8s"</span> <span class="string">modified</span>.</span><br></pre></td></tr></tbody></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config get-contexts</span><br><span class="line">CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE</span><br><span class="line">          kubernetes-admin@kubernetes   kubernetes   kubernetes-admin</span><br><span class="line"><span class="operator">*</span>         my-k8s                        kubernetes   guomaoqiu</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å…¶è®¾ç½®ä¸ºå½“å‰é»˜è®¤ä¸Šä¸‹æ–‡:</span></span><br><span class="line">$ kubectl config use-context my-k8s</span><br><span class="line">Switched to context <span class="string">"my-k8s"</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–POD:</span></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                     READY     STATUS    RESTARTS   AGE</span><br><span class="line">nginx-<span class="number">64</span>f497f8fd-<span class="number">4</span>qdnt   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">10</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°è¯•åˆ é™¤POD:</span></span><br><span class="line">$ kubectl delete pod nginx-<span class="number">64</span>f497f8fd-<span class="number">4</span>qdnt</span><br><span class="line">Error from server (Forbidden): pods <span class="string">"nginx-64f497f8fd-4qdnt"</span> is <span class="params">forbidden:</span> User <span class="string">"system:serviceaccount:default:myk8ssa"</span> cannot delete pods <span class="keyword">in</span> the namespace <span class="string">"default"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯è§ï¼Œè¯¥ç”¨æˆ·çš„çš„æƒé™åªæœ‰å¯è¯»ï¼Œè€Œæ²¡æœ‰åˆ é™¤çš„æƒé™ï¼›</span></span><br><span class="line"><span class="comment"># è¯´æ˜é…ç½®æ˜¯æˆåŠŸäº†çš„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æµè§ˆä¸€ä¸‹å½“å‰æˆ‘ç¯å¢ƒä¸­æœ‰å“ªäº›kubeconfig?</span></span><br><span class="line">$ kubectl config view</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">clusters:</span></span><br><span class="line"><span class="operator">-</span> <span class="params">cluster:</span></span><br><span class="line">    <span class="params">certificate-authority-data:</span> REDACTED</span><br><span class="line">    <span class="params">server:</span> https:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">56.110</span>:<span class="number">8443</span></span><br><span class="line">  <span class="params">name:</span> kubernetes</span><br><span class="line"><span class="operator">-</span> <span class="params">cluster:</span></span><br><span class="line">    <span class="params">certificate-authority-data:</span> REDACTED</span><br><span class="line">    <span class="params">server:</span> https:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">56.110</span>:<span class="number">8443</span></span><br><span class="line">  <span class="params">name:</span> my-k8s</span><br><span class="line"><span class="params">contexts:</span></span><br><span class="line"><span class="operator">-</span> <span class="params">context:</span></span><br><span class="line">    <span class="params">cluster:</span> kubernetes</span><br><span class="line">    <span class="params">user:</span> kubernetes-admin</span><br><span class="line">  <span class="params">name:</span> kubernetes-admin@kubernetes</span><br><span class="line"><span class="operator">-</span> <span class="params">context:</span></span><br><span class="line">    <span class="params">cluster:</span> kubernetes</span><br><span class="line">    <span class="params">user:</span> guomaoqiu</span><br><span class="line">  <span class="params">name:</span> my-k8s</span><br><span class="line"><span class="params">current-context:</span> my-k8s  <span class="comment"># å½“å‰ç¯å¢ƒ</span></span><br><span class="line"><span class="params">kind:</span> Config</span><br><span class="line"><span class="params">preferences:</span> {}</span><br><span class="line"><span class="params">users:</span></span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> guomaoqiu</span><br><span class="line">  <span class="params">user:</span></span><br><span class="line">    token:......ç•¥</span><br><span class="line"><span class="operator">-</span> <span class="params">name:</span> kubernetes-admin</span><br><span class="line">  <span class="params">user:</span></span><br><span class="line">    <span class="params">client-certificate-data:</span> REDACTED</span><br><span class="line">    <span class="params">client-key-data:</span> REDACTED</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡namespaceæˆ‘ä»¬å¯ä»¥åšåˆ°ä¸åŒä¸šåŠ¡ä¹‹é—´çš„éš”ç¦»ï¼Œå¦‚æœå†åŠ ä¸Šå¦‚ä¸Šè¿™ç§æƒé™æ§åˆ¶å°†ä¼šæ›´åŠ ç»†åŒ–ã€ä»¥ä¸Šå®éªŒä¸»è¦æ˜¯åœ¨é»˜è®¤çš„namespaceä¸‹é¢æ“ä½œï¼Œé™¤æ­¤ä¹‹å¤–ä¹Ÿå¯ä»¥æ–°å»ºnamespaceç„¶åè¿›è¡ŒéªŒè¯æ“ä½œã€‚<code>kubeconfig</code>åˆ‡æ¢ä¸Šä¸‹æ–‡ä¹Ÿæ˜¯éå¸¸å®ç”¨çš„ä¸€ç§åŠŸèƒ½ã€‚<br>å¸¸ç”¨å‘½ä»¤ï¼š</p><figure class="highlight dsconfig"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> - ä½¿ç”¨<span class="string">kubectl</span>æ¥ç®¡ç†<span class="string">Kubernetes</span>é›†ç¾¤ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">set</span> - åœ¨<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªå•ç‹¬çš„å€¼ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-cluster</span> - åœ¨<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªé›†ç¾¤é¡¹ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-context</span> - åœ¨<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªç¯å¢ƒé¡¹ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="built_in">set-credentials</span> - åœ¨<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªç”¨æˆ·é¡¹ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">unset</span> - åœ¨<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ä¸­æ¸…é™¤ä¸€ä¸ªå•ç‹¬çš„å€¼ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">use-context</span> - ä½¿ç”¨<span class="string">kubeconfig</span>ä¸­çš„ä¸€ä¸ªç¯å¢ƒé¡¹ä½œä¸ºå½“å‰é…ç½®ã€‚</span><br><span class="line"><span class="string">kubectl</span> <span class="string">config</span> <span class="string">view</span> - æ˜¾ç¤ºåˆå¹¶åçš„<span class="string">kubeconfig</span>è®¾ç½®ï¼Œæˆ–è€…ä¸€ä¸ªæŒ‡å®šçš„<span class="string">kubeconfig</span>é…ç½®æ–‡ä»¶ã€‚</span><br></pre></td></tr></tbody></table></figure><h1 id="kubernetes-ä¸­çš„å‡†å…¥æœºåˆ¶"><a href="#kubernetes-ä¸­çš„å‡†å…¥æœºåˆ¶" class="headerlink" title="kubernetes ä¸­çš„å‡†å…¥æœºåˆ¶"></a>kubernetes ä¸­çš„å‡†å…¥æœºåˆ¶</h1><p>Kubernetesçš„Admission Controlå®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡†å…¥æ§åˆ¶å™¨(Admission Controller)æ’ä»¶åˆ—è¡¨ï¼Œå‘é€åˆ°APIServerçš„è¯·æ±‚éƒ½éœ€è¦ç»è¿‡è¿™ä¸ªåˆ—è¡¨ä¸­çš„æ¯ä¸ªå‡†å…¥æ§åˆ¶å™¨æ’ä»¶çš„æ£€æŸ¥ï¼Œå¦‚æœæŸä¸€ä¸ªæ§åˆ¶å™¨æ’ä»¶å‡†å…¥å¤±è´¥ï¼Œå°±å‡†å…¥å¤±è´¥ã€‚<br>æ›´å¤šå¯æŸ¥çœ‹: <a href="http://docs.kubernetes.org.cn/144.html">http://docs.kubernetes.org.cn/144.html</a><br>è¿™é‡Œæˆ‘ä»¬ä¸»è¦å­¦ä¹ <code>PodSecurityPolicy</code></p><h2 id="å®‰å…¨ä¸Šä¸‹æ–‡-Pod-SecurityContext"><a href="#å®‰å…¨ä¸Šä¸‹æ–‡-Pod-SecurityContext" class="headerlink" title="å®‰å…¨ä¸Šä¸‹æ–‡(Pod SecurityContext)"></a>å®‰å…¨ä¸Šä¸‹æ–‡(Pod SecurityContext)</h2><p>åˆ†ä¸ºPodçº§åˆ«å’Œå®¹å™¨çº§åˆ«ï¼Œå®¹å™¨çº§åˆ«çš„ä¼šè¦†ç›–Podçº§åˆ«çš„ç›¸åŒè®¾ç½®ã€‚<br>åœ¨æœ‰PodSecurityPolicyç­–ç•¥çš„æƒ…å†µä¸‹ï¼Œä¸¤è€…éœ€è¦é…åˆä½¿ç”¨;</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> pod-security-policy.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> test</span><br><span class="line">      <span class="params">emptyDir:</span> {}</span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> test-pod</span><br><span class="line">      <span class="params">image:</span> alpine</span><br><span class="line">      <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">      <span class="params">command:</span> ['sh', '-c', 'echo The app is running<span class="operator">!</span> <span class="operator">&amp;&amp;</span> sleep <span class="number">36000</span>']</span><br><span class="line">      <span class="params">volumeMounts:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> test</span><br><span class="line">          <span class="params">mountPath:</span> <span class="symbol">/data/test</span></span><br><span class="line">      <span class="params">securityContext:</span>    <span class="comment"># è®¾ç½®å®¹å™¨å®‰å…¨ä¸Šä¸‹æ–‡</span></span><br><span class="line">        <span class="params">readOnlyRootFilesystem:</span> <span class="literal">false</span>  <span class="comment"># å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æ˜¯åªè¯»</span></span><br><span class="line">        <span class="params">privileged:</span> <span class="literal">false</span> <span class="comment"># æ˜¯å¦ä¸ºç‰¹æƒå®¹å™¨</span></span><br><span class="line">        <span class="params">runAsUser:</span> <span class="number">1000</span>   <span class="comment"># è¿›ç¨‹è¿è¡Œç”¨æˆ·UID</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»º:</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f pod-security-policy.yaml</span><br><span class="line">pod<span class="symbol">/test-pod</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥å®¹å™¨éªŒè¯ï¼š</span></span><br><span class="line">$ kubectl exec <span class="operator">-</span>it test-pod sh</span><br><span class="line"><span class="symbol">/</span> $ id</span><br><span class="line">u<span class="attr">id</span><span class="operator">=</span><span class="number">1000</span> gid<span class="operator">=</span><span class="number">0</span>(root)</span><br><span class="line"><span class="symbol">/</span> $ ps <span class="operator">-</span>ef</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    <span class="number">1</span> <span class="number">1000</span>      <span class="number">0</span>:<span class="number">00</span> sleep <span class="number">36000</span></span><br><span class="line">    <span class="number">6</span> <span class="number">1000</span>      <span class="number">0</span>:<span class="number">00</span> sh</span><br><span class="line">   <span class="number">15</span> <span class="number">1000</span>      <span class="number">0</span>:<span class="number">00</span> sh</span><br><span class="line">   <span class="number">21</span> <span class="number">1000</span>      <span class="number">0</span>:<span class="number">00</span> ps <span class="operator">-</span>ef</span><br><span class="line"><span class="symbol">/</span> $ sysctl <span class="operator">-</span>w net.ipv4.tcp_recovery<span class="operator">=</span><span class="number">2</span></span><br><span class="line"><span class="params">sysctl:</span> error setting key 'net.ipv4.<span class="params">tcp_recovery':</span> Read-only file system</span><br><span class="line"><span class="symbol">/</span> $</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸Šæˆ‘è®¾ç½®é™åˆ¶äº†podæ˜¯å¦å¼€å¯ç‰¹æƒæ¨¡å¼ï¼Œå¹¶ä¸”è¿è¡Œç”¨æˆ·uidä¸º1000</span></span><br><span class="line"><span class="comment"># é‚£ä¹ˆå¦‚æœåœ¨podçº§åˆ«è®¾ç½®ä¸Šä¸‹æ–‡çš„è¯ï¼Œå®¹å™¨çº§åˆ«çš„ä¼šè¦†ç›–Podçº§åˆ«çš„ç›¸åŒè®¾ç½®(å·²éªŒè¯)</span></span><br></pre></td></tr></tbody></table></figure><p>å…¶ä»–æ›´å¤šå‚æ•°å‚è§: <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">https://kubernetes.io/docs/concepts/policy/pod-security-policy/</a></p><h1 id="è¿è¡Œæ€çš„å®‰å…¨æ§åˆ¶â€”ç½‘ç»œç­–ç•¥-NetworkPolicy"><a href="#è¿è¡Œæ€çš„å®‰å…¨æ§åˆ¶â€”ç½‘ç»œç­–ç•¥-NetworkPolicy" class="headerlink" title="è¿è¡Œæ€çš„å®‰å…¨æ§åˆ¶â€”ç½‘ç»œç­–ç•¥(NetworkPolicy)"></a>è¿è¡Œæ€çš„å®‰å…¨æ§åˆ¶â€”ç½‘ç»œç­–ç•¥(NetworkPolicy)</h1><p>Kubernetesè¦æ±‚é›†ç¾¤ä¸­æ‰€æœ‰podï¼Œæ— è®ºæ˜¯èŠ‚ç‚¹å†…è¿˜æ˜¯è·¨èŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥ç›´æ¥é€šä¿¡ï¼Œæˆ–è€…è¯´æ‰€æœ‰podå·¥ä½œåœ¨åŒä¸€è·¨èŠ‚ç‚¹ç½‘ç»œï¼Œæ­¤ç½‘ç»œä¸€èˆ¬æ˜¯äºŒå±‚è™šæ‹Ÿç½‘ç»œï¼Œç§°ä¸ºpodç½‘ç»œã€‚åœ¨å®‰è£…å¼•å¯¼kubernetesæ—¶ï¼Œç”±é€‰æ‹©å¹¶å®‰è£…çš„network pluginå®ç°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä¸­æ‰€æœ‰podä¹‹é—´ã€podä¸èŠ‚ç‚¹ä¹‹é—´å¯ä»¥äº’é€šã€‚</p><p>ç½‘ç»œä¸»è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯è¿é€šæ€§ï¼Œå®ä½“ä¹‹é—´èƒ½å¤Ÿé€šè¿‡ç½‘ç»œäº’é€šã€‚å¦ä¸€ä¸ªæ˜¯éš”ç¦»æ€§ï¼Œå‡ºäºå®‰å…¨ã€é™åˆ¶ç½‘ç»œæµé‡çš„ç›®çš„ï¼Œåˆè¦æ§åˆ¶å®ä½“ä¹‹é—´çš„è¿é€šæ€§ã€‚Network Policyç”¨æ¥å®ç°éš”ç¦»æ€§ï¼Œåªæœ‰åŒ¹é…è§„åˆ™çš„æµé‡æ‰èƒ½è¿›å…¥podï¼ŒåŒç†åªæœ‰åŒ¹é…è§„åˆ™çš„æµé‡æ‰å¯ä»¥ç¦»å¼€podã€‚</p><p>ä½†è¯·æ³¨æ„ï¼Œkubernetesæ”¯æŒçš„ç”¨ä»¥å®ç°podç½‘ç»œçš„network pluginæœ‰å¾ˆå¤šç§ï¼Œå¹¶ä¸æ˜¯å…¨éƒ¨éƒ½æ”¯æŒNetwork Policyï¼Œä¸ºkubernetesé€‰æ‹©network pluginæ—¶éœ€è¦è€ƒè™‘åˆ°è¿™ç‚¹ï¼Œæ˜¯å¦éœ€è¦éš”ç¦»ï¼Ÿå¯ç”¨network pluginåŠæ˜¯å¦æ”¯æŒNetwork Policyè¯·å‚è€ƒ<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/#networking-and-network-policy">è¿™é‡Œ</a>ã€‚</p><h2 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h2><p>Network Policyæ˜¯kubernetesä¸­çš„ä¸€ç§èµ„æºç±»å‹ï¼Œå®ƒä»å±äºæŸä¸ªnamespaceã€‚å…¶å†…å®¹ä»é€»è¾‘ä¸Šçœ‹åŒ…å«ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ï¼Œä¸€æ˜¯podé€‰æ‹©å™¨ï¼ŒåŸºäºæ ‡ç­¾é€‰æ‹©ç›¸åŒnamespaceä¸‹çš„podï¼Œå°†å…¶ä¸­å®šä¹‰çš„è§„åˆ™ä½œç”¨äºé€‰ä¸­çš„podã€‚å¦ä¸€ä¸ªå°±æ˜¯è§„åˆ™äº†ï¼Œå°±æ˜¯ç½‘ç»œæµé‡è¿›å‡ºpodçš„è§„åˆ™ï¼Œå…¶é‡‡ç”¨çš„æ˜¯ç™½åå•æ¨¡å¼ï¼Œç¬¦åˆè§„åˆ™çš„é€šè¿‡ï¼Œä¸ç¬¦åˆè§„åˆ™çš„æ‹’ç»ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> networking.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> NetworkPolicy</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-network-policy</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">podSelector:</span></span><br><span class="line">    <span class="params">matchLabels:</span>   <span class="comment"># è§„åˆ™é€‰æ‹©å™¨ï¼Œé€‰æ‹©åŒ¹é…çš„POD</span></span><br><span class="line">      <span class="params">role:</span> db</span><br><span class="line">  <span class="params">policyTypes:</span></span><br><span class="line">  <span class="operator">-</span> Ingress</span><br><span class="line">  <span class="operator">-</span> Egress</span><br><span class="line">  <span class="params">ingress:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">from:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">ipBlock:</span>     <span class="comment"># è¿œç«¯(è®¿é—®ç«¯)IPç™½åå•å¼€æ”¾</span></span><br><span class="line">        <span class="params">cidr:</span> <span class="number">172.17</span>.<span class="number">0.0</span><span class="symbol">/16</span></span><br><span class="line">        <span class="params">except:</span></span><br><span class="line">        <span class="operator">-</span> <span class="number">172.17</span>.<span class="number">1.0</span><span class="symbol">/24</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">namespaceSelector:</span>  <span class="comment"># è¿œç«¯(è®¿é—®ç«¯)namespacesç™½åå•å¼€æ”¾</span></span><br><span class="line">        <span class="params">matchLabels:</span></span><br><span class="line">          <span class="params">project:</span> myproject</span><br><span class="line">    <span class="operator">-</span> <span class="params">podSelector:</span>        <span class="comment"># è¿œç«¯(è®¿é—®ç«¯)Podç™½åå•å¼€æ”¾</span></span><br><span class="line">        <span class="params">matchLabels:</span></span><br><span class="line">          <span class="params">role:</span> frontend</span><br><span class="line">    <span class="params">ports:</span>     <span class="comment"># æœ¬ç«¯(è¢«è®¿é—®ç«¯)å…è®¸è¢«è®¿é—®çš„ç«¯å£å’Œåè®®</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">protocol:</span> TCP</span><br><span class="line">      <span class="params">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="params">egress:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">to:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">ipBlock:</span></span><br><span class="line">        <span class="params">cidr:</span> <span class="number">10.0</span>.<span class="number">0.0</span><span class="symbol">/24</span></span><br><span class="line">    <span class="params">ports:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">protocol:</span> TCP</span><br></pre></td></tr></tbody></table></figure><p>å¯¹è±¡åˆ›å»ºæ–¹æ³•ä¸å…¶å®ƒå¦‚ReplicaSetç›¸åŒã€‚apiVersionã€kindã€metadataä¸å…¶å®ƒç±»å‹å¯¹è±¡å«ä¹‰ç›¸åŒï¼Œä¸è¯¦ç»†æè¿°ã€‚</p><ul><li><p>.spec.PodSelector<br>é¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯podé€‰æ‹©å™¨ï¼ŒåŸºäºæ ‡ç­¾é€‰æ‹©ä¸Network Policyå¤„äºåŒä¸€namespaceä¸‹çš„podï¼Œå¦‚æœpodè¢«é€‰ä¸­ï¼Œåˆ™å¯¹å…¶åº”ç”¨Network Policyä¸­å®šä¹‰çš„è§„åˆ™ã€‚æ­¤ä¸ºå¯é€‰å­—æ®µï¼Œå½“æ²¡æœ‰æ­¤å­—æ®µæ—¶ï¼Œè¡¨ç¤ºé€‰ä¸­æ‰€æœ‰podã€‚</p></li><li><p>.spec.PolicyTypes<br>Network Policyå®šä¹‰çš„è§„åˆ™å¯ä»¥åˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯å…¥podçš„Ingressè§„åˆ™ï¼Œä¸€ç§æ˜¯å‡ºpodçš„Egressè§„åˆ™ã€‚æœ¬å­—æ®µå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå¼€å…³ï¼Œå¦‚æœå…¶ä¸­åŒ…å«Ingressï¼Œåˆ™Ingresséƒ¨åˆ†å®šä¹‰çš„è§„åˆ™ç”Ÿæ•ˆï¼Œå¦‚æœæ˜¯Egressåˆ™Egresséƒ¨åˆ†å®šä¹‰çš„è§„åˆ™ç”Ÿæ•ˆï¼Œå¦‚æœéƒ½åŒ…å«åˆ™å…¨éƒ¨ç”Ÿæ•ˆã€‚å½“ç„¶æ­¤å­—æ®µä¹Ÿå¯é€‰ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œåˆ™é»˜è®¤Ingressç”Ÿæ•ˆï¼Œå¦‚æœEgresséƒ¨åˆ†æœ‰å®šä¹‰çš„è¯ï¼ŒEgressæ‰ç”Ÿæ•ˆã€‚æ€ä¹ˆç†è§£è¿™å¥è¯ï¼Œä¸‹æ–‡ä¼šæåˆ°ï¼Œæ²¡æœ‰æ˜ç¡®å®šä¹‰Ingressã€Egresséƒ¨åˆ†ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ç§è§„åˆ™ï¼Œé»˜è®¤è§„åˆ™è€Œéæ²¡æœ‰è§„åˆ™ã€‚</p></li><li><p>.spec.ingressä¸.spec.egress<br>å‰è€…å®šä¹‰å…¥podè§„åˆ™ï¼Œåè€…å®šä¹‰å‡ºpodè§„åˆ™ï¼Œè¯¦ç»†å‚è€ƒè¿™é‡Œï¼Œè¿™é‡Œåªè®²ä¸€ä¸‹é‡ç‚¹ã€‚ä¸Šä¾‹ä¸­ingressä¸egresséƒ½åªåŒ…å«ä¸€æ¡è§„åˆ™ï¼Œä¸¤è€…éƒ½æ˜¯æ•°ç»„ï¼Œå¯ä»¥åŒ…å«å¤šæ¡è§„åˆ™ã€‚å½“åŒ…å«å¤šæ¡æ—¶ï¼Œæ¡ç›®ä¹‹é—´çš„é€»è¾‘å…³ç³»æ˜¯â€œæˆ–â€ï¼Œåªè¦åŒ¹é…å…¶ä¸­ä¸€æ¡å°±å¯ä»¥ã€‚.spec.ingress[].from<br>ä¹Ÿæ˜¯æ•°ç»„ï¼Œæ•°ç»„æˆå‘˜å¯¹è®¿é—®podçš„å¤–éƒ¨sourceè¿›è¡Œæè¿°ï¼Œç¬¦åˆæ¡ä»¶çš„sourceæ‰å¯ä»¥è®¿é—®podï¼Œæœ‰å¤šç§æ–¹æ³•ï¼Œå¦‚ç¤ºä¾‹ä¸­çš„ipåœ°å€å—ã€åç§°ç©ºé—´ã€podæ ‡ç­¾ç­‰ï¼Œæ•°ç»„ä¸­çš„æˆå‘˜ä¹Ÿæ˜¯é€»è¾‘æˆ–çš„å…³ç³»ã€‚spec.ingress[].from.protsè¡¨ç¤ºå…è®¸é€šè¿‡çš„åè®®åŠç«¯å£å·ã€‚</p></li><li><p>.spec.egress.to å®šä¹‰çš„æ˜¯podæƒ³è¦è®¿é—®çš„å¤–éƒ¨destinationï¼Œå…¶å®ƒä¸ingressç›¸åŒã€‚</p></li></ul><h3 id="kubernetes-é»˜è®¤NetworkPolicy"><a href="#kubernetes-é»˜è®¤NetworkPolicy" class="headerlink" title="kubernetes é»˜è®¤NetworkPolicy:"></a>kubernetes é»˜è®¤NetworkPolicy:</h3><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#é»˜è®¤ç¦æ­¢æ‰€æœ‰å‡ºå£è¯·æ±‚</span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">default-deny</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">podSelector</span><span class="punctuation">:</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">policyTypes</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤ç¦æ­¢æ‰€æœ‰å…¥å£è¯·æ±‚</span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">default-deny</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">podSelector</span><span class="punctuation">:</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">policyTypes</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤å…è®¸æ‰€æœ‰å‡ºå£è¯·æ±‚</span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">allow-all</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">podSelector</span><span class="punctuation">:</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">egress</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">policyTypes</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤å…è®¸æ‰€æœ‰å…¥å£è¯·æ±‚</span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">allow-all</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">podSelector</span><span class="punctuation">:</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">egress</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">{}</span></span><br><span class="line">  <span class="attribute">policyTypes</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br></pre></td></tr></tbody></table></figure><p>é»˜è®¤ç­–ç•¥ æ— éœ€è¯¦è§£ï¼Œä½†è¯·æ³¨æ„ï¼Œpodä¸æ‰€è¿è¡ŒèŠ‚ç‚¹ä¹‹é—´æµé‡ä¸å—Network Policyé™åˆ¶ã€‚</p><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªçœŸå®ç¤ºä¾‹å±•ç¤ºNetwork Policyæ™®é€šç”¨æ³•ã€‚</p><h4 id="ç”¨Deploymentåˆ›å»ºnginx-podå®ä¾‹å¹¶ç”¨serviceæš´éœ²"><a href="#ç”¨Deploymentåˆ›å»ºnginx-podå®ä¾‹å¹¶ç”¨serviceæš´éœ²" class="headerlink" title="ç”¨Deploymentåˆ›å»ºnginx podå®ä¾‹å¹¶ç”¨serviceæš´éœ²"></a>ç”¨Deploymentåˆ›å»ºnginx podå®ä¾‹å¹¶ç”¨serviceæš´éœ²</h4><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">run</span> nginx <span class="attribute">--image</span>=nginx <span class="attribute">--replicas</span>=3</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line">$ kubectl expose deployment nginx <span class="attribute">--port</span>=80</span><br><span class="line">service/nginx exposed</span><br></pre></td></tr></tbody></table></figure><h4 id="ç¡®è®¤åˆ›å»ºç»“æœ"><a href="#ç¡®è®¤åˆ›å»ºç»“æœ" class="headerlink" title="ç¡®è®¤åˆ›å»ºç»“æœ"></a>ç¡®è®¤åˆ›å»ºç»“æœ</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod,svc</span><br><span class="line">NAME                         READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod<span class="symbol">/nginx-64f497f8fd-9mfd7</span>   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">2</span>m</span><br><span class="line">pod<span class="symbol">/nginx-64f497f8fd-nss94</span>   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">2</span>m</span><br><span class="line">pod<span class="symbol">/nginx-64f497f8fd-zs926</span>   <span class="number">1</span><span class="symbol">/1</span>       Running   <span class="number">0</span>          <span class="number">2</span>m</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service<span class="symbol">/kubernetes</span>   ClusterIP   <span class="number">10.96</span>.<span class="number">0.1</span>        <span class="symbol">&lt;none&gt;</span>        <span class="number">443</span><span class="symbol">/TCP</span>   <span class="number">3</span>d</span><br><span class="line">service<span class="symbol">/nginx</span>        ClusterIP   <span class="number">10.111</span>.<span class="number">254.191</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">80</span><span class="symbol">/TCP</span>    <span class="number">14</span>s</span><br></pre></td></tr></tbody></table></figure><h4 id="æµ‹è¯•nginxæœåŠ¡è¿é€šæ€§"><a href="#æµ‹è¯•nginxæœåŠ¡è¿é€šæ€§" class="headerlink" title="æµ‹è¯•nginxæœåŠ¡è¿é€šæ€§"></a>æµ‹è¯•nginxæœåŠ¡è¿é€šæ€§</h4><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$  kubectl run busybox <span class="params">--rm</span> -it <span class="params">--image=busybox</span> <span class="string">/bin/sh</span></span><br><span class="line">If you don't see a <span class="keyword">command</span> prompt, <span class="keyword">try</span> pressing enter.</span><br><span class="line">/ <span class="comment"># wget --spider --timeout=3 nginx</span></span><br><span class="line">Connecting to nginx <span class="params">(10.111.254.191:80)</span>  <span class="comment"># è¯´æ˜é€šçš„</span></span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><h4 id="é€šè¿‡åˆ›å»ºNetwork-Policyå¯¹è±¡æ·»åŠ éš”ç¦»æ€§"><a href="#é€šè¿‡åˆ›å»ºNetwork-Policyå¯¹è±¡æ·»åŠ éš”ç¦»æ€§" class="headerlink" title="é€šè¿‡åˆ›å»ºNetwork Policyå¯¹è±¡æ·»åŠ éš”ç¦»æ€§"></a>é€šè¿‡åˆ›å»ºNetwork Policyå¯¹è±¡æ·»åŠ éš”ç¦»æ€§</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> pod-network-policy.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">kind:</span> NetworkPolicy</span><br><span class="line"><span class="params">apiVersion:</span> networking.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> access-nginx</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">podSelector:</span></span><br><span class="line">    <span class="params">matchLabels:</span> <span class="comment"># é»˜è®¤è¯¥podå°±æœ‰run=appè¿™ä¸ªæ ‡ç­¾äº†ï¼Œæˆ‘è¿™é‡Œæ— éœ€åœ¨ä»æ–°å®šä¹‰</span></span><br><span class="line">      <span class="params">run:</span> nginx  </span><br><span class="line">  <span class="params">ingress:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">from:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">podSelector:</span></span><br><span class="line">        <span class="params">matchLabels:</span></span><br><span class="line">          <span class="params">access:</span> <span class="string">"true"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»º</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f pod-network-policy.yaml</span><br><span class="line">networkpolicy.networking.k8s.io<span class="symbol">/access-nginx</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å…·ä½“éš”ç¦»ç­–ç•¥</span></span><br><span class="line">$ kubectl describe networkpolicy access-nginx</span><br><span class="line"><span class="params">Name:</span>         access-nginx</span><br><span class="line"><span class="params">Namespace:</span>    default</span><br><span class="line">Created <span class="params">on:</span>   <span class="number">201</span>8-<span class="number">1</span>2-<span class="number">17</span> <span class="number">01</span>:<span class="number">16</span>:<span class="number">57</span> <span class="operator">-</span><span class="number">0500</span> EST</span><br><span class="line"><span class="params">Labels:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Spec:</span></span><br><span class="line">  <span class="params">PodSelector:</span>     run<span class="operator">=</span>nginx</span><br><span class="line">  Allowing ingress <span class="params">traffic:</span></span><br><span class="line">    To <span class="params">Port:</span> <span class="symbol">&lt;any&gt;</span> (traffic allowed to all ports)</span><br><span class="line">    <span class="params">From:</span></span><br><span class="line">      <span class="params">PodSelector:</span> access<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">  Allowing egress <span class="params">traffic:</span></span><br><span class="line">    <span class="symbol">&lt;none&gt;</span> (Selected pods are isolated for egress connectivity)</span><br><span class="line">  Policy <span class="params">Types:</span> Ingress</span><br></pre></td></tr></tbody></table></figure><h4 id="æµ‹è¯•éš”ç¦»æ€§"><a href="#æµ‹è¯•éš”ç¦»æ€§" class="headerlink" title="æµ‹è¯•éš”ç¦»æ€§"></a>æµ‹è¯•éš”ç¦»æ€§</h4><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run busybox <span class="params">--rm</span> -it <span class="params">--image=busybox</span> <span class="string">/bin/sh</span></span><br><span class="line">If you don't see a <span class="keyword">command</span> prompt, <span class="keyword">try</span> pressing enter.</span><br><span class="line">/ <span class="comment"># wget --spider --timeout=3 nginx</span></span><br><span class="line">Connecting to nginx <span class="params">(10.111.254.191:80)</span></span><br><span class="line">wget: download timed out <span class="comment"># å·²ç»è¶…æ—¶ï¼Œè¯´æ˜å·²ç»ä¸èƒ½è®¿é—®äº†</span></span><br></pre></td></tr></tbody></table></figure><h4 id="ä¸ºpodæ·»åŠ access-â€œtrueâ€æ ‡ç­¾åå†æ¬¡æµ‹è¯•è¿é€šæ€§"><a href="#ä¸ºpodæ·»åŠ access-â€œtrueâ€æ ‡ç­¾åå†æ¬¡æµ‹è¯•è¿é€šæ€§" class="headerlink" title="ä¸ºpodæ·»åŠ access: â€œtrueâ€æ ‡ç­¾åå†æ¬¡æµ‹è¯•è¿é€šæ€§"></a>ä¸ºpodæ·»åŠ access: â€œtrueâ€æ ‡ç­¾åå†æ¬¡æµ‹è¯•è¿é€šæ€§</h4><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run busybox <span class="params">--rm</span> -it <span class="params">--labels=</span><span class="string">"access=true"</span> <span class="params">--image=busybox</span> <span class="string">/bin/sh</span></span><br><span class="line">If you don't see a <span class="keyword">command</span> prompt, <span class="keyword">try</span> pressing enter.</span><br><span class="line">/ <span class="comment"># wget --spider --timeout=3 nginx</span></span><br><span class="line">Connecting to nginx <span class="params">(10.111.254.191:80)</span></span><br></pre></td></tr></tbody></table></figure><p>å‚è€ƒ:<br><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/</a><br><a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/docs/reference/access-authn-authz/rbac/</a><br><a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">https://kubernetes.io/docs/concepts/services-networking/network-policies/</a><br><a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/</a><br><a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">https://kubernetes.io/docs/concepts/policy/pod-security-policy/</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;é¦–å…ˆéœ€è¦äº†è§£è¿™ä¸‰ç§æœºåˆ¶çš„åŒºåˆ«ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è®¤è¯(Authenticating)æ˜¯å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ï¼Œé€šä¿—ç‚¹å°±æ˜¯ç”¨æˆ·åå¯†ç éªŒè¯ï¼Œ&lt;/li&gt;
&lt;li&gt;æˆæƒ(Authorization)æ˜¯å¯¹èµ„æºçš„æˆæƒï¼Œk8sä¸­çš„èµ„æºæ— éæ˜¯å®¹å™¨ï¼Œæœ€ç»ˆå…¶å®å°±æ˜¯å®¹å™¨çš„è®¡ç®—ï¼Œç½‘ç»œï¼Œå­˜å‚¨èµ„æºï¼Œå½“ä¸€ä¸ªè¯·æ±‚ç»è¿‡è®¤è¯åï¼Œéœ€è¦è®¿é—®æŸä¸€ä¸ªèµ„æºï¼ˆæ¯”å¦‚åˆ›å»ºä¸€ä¸ªpodï¼‰ï¼Œæˆæƒæ£€æŸ¥éƒ½ä¼šé€šè¿‡è®¿é—®ç­–ç•¥æ¯”è¾ƒè¯¥è¯·æ±‚ä¸Šä¸‹æ–‡çš„å±æ€§ï¼Œï¼ˆæ¯”å¦‚ç”¨æˆ·ï¼Œèµ„æºå’ŒNamespaceï¼‰ï¼Œæ ¹æ®æˆæƒè§„åˆ™åˆ¤å®šè¯¥èµ„æºï¼ˆæ¯”å¦‚æŸnamespaceä¸‹çš„podï¼‰æ˜¯å¦æ˜¯è¯¥å®¢æˆ·å¯è®¿é—®çš„ã€‚&lt;/li&gt;
&lt;li&gt;å‡†å…¥(Admission Control)æœºåˆ¶æ˜¯ä¸€ç§åœ¨æ”¹å˜èµ„æºçš„æŒä¹…åŒ–ä¹‹å‰ï¼ˆæ¯”å¦‚æŸäº›èµ„æºçš„åˆ›å»ºæˆ–åˆ é™¤ï¼Œä¿®æ”¹ç­‰ä¹‹å‰ï¼‰çš„æœºåˆ¶ã€‚&lt;br&gt;åœ¨k8sä¸­ï¼Œè¿™ä¸‰ç§æœºåˆ¶å¦‚ä¸‹å›¾ï¼š&lt;br&gt;&lt;img src=&quot;/2018/12/16/kubernetes-auth/k8s-authorition.png&quot; alt=&quot;k8s-authorition&quot;&gt;&lt;br&gt;k8sçš„æ•´ä½“æ¶æ„ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡çš„æ¶æ„ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªGateWayï¼Œä¹Ÿå°±æ˜¯kube-apiserverè¿™ä¸ªç»„ä»¶ï¼ˆå¯¹å¤–æä¾›RESTæœåŠ¡ï¼‰ï¼Œç”±å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œk8sä¸­å®¢æˆ·ç«¯æœ‰ä¸¤ç±»ï¼Œä¸€ç§æ˜¯æ™®é€šç”¨æˆ·ï¼Œä¸€ç§æ˜¯é›†ç¾¤å†…çš„Podï¼Œè¿™ä¸¤ç§å®¢æˆ·ç«¯çš„è®¤è¯æœºåˆ¶ç•¥æœ‰ä¸åŒï¼Œåæ–‡ä¼šè¯¦è¿°ã€‚ä½†æ— è®ºæ˜¯å“ªä¸€ç§ï¼Œéƒ½éœ€è¦ä¾æ¬¡ç»è¿‡è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥è¿™ä¸‰ä¸ªæœºåˆ¶ã€‚&lt;br&gt;&lt;img src=&quot;/2018/12/16/kubernetes-auth/auththentication&amp;amp;authorization.png&quot; alt=&quot;æˆªå›¾æ¥è‡ªåä¸ºCCEäº‘è¯¾å ‚&quot;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;kubernetes-ä¸­çš„è®¤è¯æœºåˆ¶&quot;&gt;&lt;a href=&quot;#kubernetes-ä¸­çš„è®¤è¯æœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;kubernetes ä¸­çš„è®¤è¯æœºåˆ¶&quot;&gt;&lt;/a&gt;kubernetes ä¸­çš„è®¤è¯æœºåˆ¶&lt;/h1&gt;&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œkubernetesè™½ç„¶æä¾›äº†å¤šç§è®¤è¯æœºåˆ¶ï¼Œä½†å¹¶æ²¡æœ‰æä¾›user å®ä½“ä¿¡æ¯çš„å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè´¦æˆ·ä½“ç³»éœ€è¦æˆ‘ä»¬è‡ªå·±å»åšç»´æŠ¤ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥æ¥å…¥ç¬¬ä¸‰æ–¹è´¦æˆ·ä½“ç³»ï¼ˆå¦‚è°·æ­Œè´¦æˆ·ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¼€æºçš„keystoneå»åšæ•´åˆã€‚kubernetes æ”¯æŒå¤šç§è®¤è¯æœºåˆ¶ï¼Œå¯ä»¥é…ç½®æˆå¤šä¸ªè®¤è¯ä½“åˆ¶å…±å­˜ï¼Œè¿™æ ·ï¼Œåªè¦æœ‰ä¸€ä¸ªè®¤è¯é€šè¿‡ï¼Œè¿™ä¸ªrequestå°±è®¤è¯é€šè¿‡äº†ã€‚ä¸‹é¢åˆ—ä¸¾çš„æ˜¯å®˜ç½‘å‡ ç§å¸¸è§è®¤è¯æœºåˆ¶ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;X509 Client Certs&lt;/li&gt;
&lt;li&gt;Static Token File&lt;/li&gt;
&lt;li&gt;Bootstrap Tokens&lt;/li&gt;
&lt;li&gt;Static Password File&lt;/li&gt;
&lt;li&gt;Service Account Tokens&lt;/li&gt;
&lt;li&gt;OpenID Connect Tokens&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™é‡Œæˆ‘ä¸»è¦è¿˜æ˜¯ç†è§£ä¸€ä¸‹å¸¸ç”¨è®¤è¯æ–¹å¼:&lt;/p&gt;
&lt;h2 id=&quot;X509-Client-Certs&quot;&gt;&lt;a href=&quot;#X509-Client-Certs&quot; class=&quot;headerlink&quot; title=&quot;X509 Client Certs&quot;&gt;&lt;/a&gt;X509 Client Certs&lt;/h2&gt;&lt;p&gt;ä¹Ÿå«ä½œåŒå‘æ•°å­—è¯ä¹¦è®¤è¯ï¼ŒHTTPSè¯ä¹¦è®¤è¯ï¼Œæ˜¯åŸºäºCAæ ¹è¯ä¹¦ç­¾åçš„åŒå‘æ•°å­—è¯ä¹¦è®¤è¯æ–¹å¼ï¼Œæ˜¯æ‰€æœ‰è®¤è¯æ–¹å¼ä¸­æœ€ä¸¥æ ¼çš„è®¤è¯ã€‚é»˜è®¤åœ¨kubeadmåˆ›å»ºçš„é›†ç¾¤ä¸­æ˜¯enabledçš„ï¼Œå¯ä»¥åœ¨master nodeä¸ŠæŸ¥çœ‹kube-apiserverçš„podé…ç½®æ–‡ä»¶ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight routeros&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /usr/lib/systemd/system/kube-apiserver.service&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;ExecStart&lt;/span&gt;=/usr/local/bin/kube-apiserver &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--v&lt;/span&gt;=2  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--logtostderr&lt;/span&gt;=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--allow-privileged&lt;/span&gt;=&lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--bind-address&lt;/span&gt;=0.0.0.0  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--secure-port&lt;/span&gt;=6443  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--insecure-port&lt;/span&gt;=0  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--advertise-address&lt;/span&gt;=192.168.56.110 &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--service-cluster-ip-range&lt;/span&gt;=10.96.0.0/12  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--service-node-port-range&lt;/span&gt;=30000-32767  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--etcd-servers&lt;/span&gt;=https://192.168.56.111:2379,https://192.168.56.112:2379,https://192.168.56.113:2379 &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--etcd-cafile&lt;/span&gt;=/etc/etcd/ssl/etcd-ca.pem  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--etcd-certfile&lt;/span&gt;=/etc/etcd/ssl/etcd.pem  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--etcd-keyfile&lt;/span&gt;=/etc/etcd/ssl/etcd-key.pem  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--client-ca-file&lt;/span&gt;=/etc/kubernetes/pki/ca.pem  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--tls-cert-file&lt;/span&gt;=/etc/kubernetes/pki/apiserver.pem  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--tls-private-key-file&lt;/span&gt;=/etc/kubernetes/pki/apiserver-key.pem  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--kubelet-client-certificate&lt;/span&gt;=/etc/kubernetes/pki/apiserver.pem  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attribute&quot;&gt;--kubelet-client-key&lt;/span&gt;=/etc/kubernetes/pki/apiserver-key.pem  &#92;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;built_in&quot;&gt;..&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/tags/kubernetes/"/>
    
    <category term="ServiceAccount" scheme="https://blog.sctux.cc/tags/ServiceAccount/"/>
    
    <category term="Kubeconfig" scheme="https://blog.sctux.cc/tags/Kubeconfig/"/>
    
    <category term="RBAC" scheme="https://blog.sctux.cc/tags/RBAC/"/>
    
    <category term="Admission" scheme="https://blog.sctux.cc/tags/Admission/"/>
    
    <category term="PodSecurityContext" scheme="https://blog.sctux.cc/tags/PodSecurityContext/"/>
    
    <category term="NetworkPolicy" scheme="https://blog.sctux.cc/tags/NetworkPolicy/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£kubernetesä¸­çš„Storage</title>
    <link href="https://blog.sctux.cc/2018/12/15/kubernetes-storage/"/>
    <id>https://blog.sctux.cc/2018/12/15/kubernetes-storage/</id>
    <published>2018-12-15T00:27:08.000Z</published>
    <updated>2025-09-01T01:59:08.868Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·"><a href="#åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·" class="headerlink" title="åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·"></a>åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·</h1><p>å®¹å™¨éƒ¨ç½²è¿‡ç¨‹ä¸­ä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§æ•°æ®:</p><ul><li>å¯åŠ¨æ—¶éœ€è¦çš„åˆå§‹æ•°æ®ï¼Œå¯ä»¥æ˜¯é…ç½®æ–‡ä»¶</li><li>å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®ï¼Œè¯¥ä¸´æ—¶æ•°æ®éœ€è¦å¤šä¸ªå®¹å™¨é—´å…±äº«</li><li>å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æŒä¹…åŒ–æ•°æ®</li></ul><p>ä»¥ä¸Šä¸‰ç§æ•°æ®éƒ½ä¸å¸Œæœ›åœ¨å®¹å™¨é‡å¯æ—¶å°±æ¶ˆå¤±ï¼Œå­˜å‚¨å·ç”±æ­¤è€Œæ¥ï¼Œå®ƒå¯ä»¥æ ¹æ®ä¸åŒåœºæ™¯æä¾›ä¸åŒç±»å‹çš„å­˜å‚¨èƒ½åŠ›ã€‚<br>å„ç±»å·:</p><div style="width: 50%; margin: auto">![æˆªå›¾æ¥æºåä¸ºäº‘cceè¯¾å ‚](kubernetes-storage/volume.png)</div><ul><li>spec.volumesï¼šé€šè¿‡æ­¤å­—æ®µæä¾›æŒ‡å®šçš„å­˜å‚¨å·</li><li>spec.containers.volumeMountsï¼šé€šè¿‡æ­¤å­—æ®µå°†å­˜å‚¨å·æŒ‚æ¥åˆ°å®¹å™¨ä¸­</li></ul><h1 id="ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•"><a href="#ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•" class="headerlink" title="ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•:"></a>ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•:</h1><h2 id="å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®"><a href="#å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®" class="headerlink" title="å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®"></a>å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®</h2><h3 id="1-ConfigMap"><a href="#1-ConfigMap" class="headerlink" title="1. ConfigMap"></a>1. ConfigMap</h3><p>ä¸Šå›¾ä¹Ÿè¯´äº†å®ƒæ˜¯åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä»¥æ¥çš„æ•°æ®æ¥æº</p><h4 id="ç¤ºä¾‹ï¼š"><a href="#ç¤ºä¾‹ï¼š" class="headerlink" title="ç¤ºä¾‹ï¼š"></a>ç¤ºä¾‹ï¼š</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.åˆ›å»ºconfigmapé¢„åˆ¶æ•°æ®å·</span></span><br><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> configmap.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  <span class="params">guomaoqiu:</span> hello-world</span><br><span class="line"><span class="params">kind:</span> ConfigMap</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test</span><br><span class="line">EOF</span><br><span class="line">$ kubectl create <span class="operator">-</span>f configmap.yaml</span><br><span class="line">configmap<span class="symbol">/test</span> created</span><br><span class="line"><span class="comment"># 2. åˆ›å»ºpodæ¥ä½¿ç”¨è¿™ä¸ªconfigmap</span></span><br><span class="line"><span class="comment"># è¿™é‡Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªnginx pod è®©ä»–å¯åŠ¨æ˜¯æŒ‚è½½è¿™ä¸ªæ•°æ®</span></span><br><span class="line">$ cat nginx-deployment.yaml</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">image:</span> nginx</span><br><span class="line">        <span class="params">name:</span> nginx</span><br><span class="line">        <span class="params">resources:</span> {}</span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> test</span><br><span class="line">          <span class="params">mountPath:</span> <span class="symbol">/tmp</span>  <span class="comment"># æŒ‚è½½ç‚¹</span></span><br><span class="line">      <span class="params">volumes:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> test</span><br><span class="line">        <span class="params">configMap:</span> </span><br><span class="line">          <span class="params">name:</span> test       <span class="comment"># ConfigMap name</span></span><br><span class="line">          <span class="params">defaultMode:</span> <span class="number">420</span> <span class="comment"># æŒ‡å®šæŒ‚è½½åˆ°podæ–‡ä»¶çš„æƒé™</span></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.æ£€æŸ¥æ•°æ®æ˜¯å¦æŒ‚è½½è¿›pod</span></span><br><span class="line">kubectl exec  nginx-<span class="number">7</span>d8bb9c4fc-bxxkt <span class="operator">-</span>- ls <span class="symbol">/tmp</span></span><br><span class="line">guomaoqiu</span><br><span class="line">kubectl exec  nginx-<span class="number">7</span>d8bb9c4fc-bxxkt <span class="operator">-</span>- cat <span class="symbol">/tmp/guomaoqiu</span></span><br><span class="line">hello-world                                                                                                                                                                                                                                 $</span><br><span class="line"><span class="comment"># ä»¥ä¸Šå¯ä»¥çœ‹åˆ°å°†configmapçš„keyä½œä¸ºäº†æ–‡ä»¶åï¼Œå°†valueä½œä¸ºäº†æ–‡ä»¶çš„å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment"># ä»–çš„ä½œç”¨ä¹Ÿå°±æ˜¯å…è®¸æ‚¨å°†é…ç½®æ–‡ä»¶ä»å®¹å™¨é•œåƒä¸­è§£è€¦ï¼Œä»è€Œå¢å¼ºå®¹å™¨åº”ç”¨çš„å¯ç§»æ¤æ€§</span></span><br><span class="line"><span class="comment"># æ›´å¤šå¯æŸ¥çœ‹: https://k8smeetup.github.io/docs/tasks/configure-pod-container/configmap/</span></span><br></pre></td></tr></tbody></table></figure><h3 id="2-Serect"><a href="#2-Serect" class="headerlink" title="2. Serect"></a>2. Serect</h3><p>Secret æ˜¯ä¸€ç§åŒ…å«å°‘é‡æ•æ„Ÿä¿¡æ¯ä¾‹å¦‚å¯†ç ã€token æˆ– key çš„å¯¹è±¡ã€‚è¿™æ ·çš„ä¿¡æ¯å¯èƒ½ä¼šè¢«æ”¾åœ¨ Pod spec ä¸­æˆ–è€…é•œåƒä¸­ï¼›å°†å…¶æ”¾åœ¨ä¸€ä¸ª secret å¯¹è±¡ä¸­å¯ä»¥æ›´å¥½åœ°æ§åˆ¶å®ƒçš„ç”¨é€”ï¼Œå¹¶é™ä½æ„å¤–æš´éœ²çš„é£é™©ã€‚</p><p>ç”¨æˆ·å¯ä»¥åˆ›å»º secretï¼ŒåŒæ—¶ç³»ç»Ÿä¹Ÿåˆ›å»ºäº†ä¸€äº› secretã€‚<br>è¦ä½¿ç”¨ secretï¼Œpod éœ€è¦å¼•ç”¨ secretã€‚Pod å¯ä»¥ç”¨ä¸¤ç§æ–¹å¼ä½¿ç”¨ secretï¼šä½œä¸º volume ä¸­çš„æ–‡ä»¶è¢«æŒ‚è½½åˆ° pod ä¸­çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨é‡Œï¼Œæˆ–è€…å½“ kubelet ä¸º pod æ‹‰å–é•œåƒæ—¶ä½¿ç”¨ã€‚</p><h4 id="ç¤ºä¾‹ï¼š-1"><a href="#ç¤ºä¾‹ï¼š-1" class="headerlink" title="ç¤ºä¾‹ï¼š"></a>ç¤ºä¾‹ï¼š</h4><p>å‡è®¾æœ‰äº› pod éœ€è¦è®¿é—®æ•°æ®åº“ã€‚è¿™äº› pod éœ€è¦ä½¿ç”¨çš„ç”¨æˆ·åå’Œå¯†ç åœ¨æ‚¨æœ¬åœ°æœºå™¨çš„ ./username.txt å’Œ ./password.txt æ–‡ä»¶é‡Œã€‚</p><figure class="highlight jboss-cli"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create files needed for rest of example.</span></span><br><span class="line"><span class="keyword">echo</span> -n <span class="string">"admin"</span> &gt; <span class="string">./username.txt</span></span><br><span class="line"><span class="keyword">echo</span> -n <span class="string">"1f2d1e2e67df"</span> &gt; <span class="string">./password.txt</span></span><br></pre></td></tr></tbody></table></figure><p>kubectl create secret å‘½ä»¤å°†è¿™äº›æ–‡ä»¶æ‰“åŒ…åˆ°ä¸€ä¸ª Secret ä¸­å¹¶åœ¨ API server ä¸­åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create secret generic db-user-pass <span class="operator">-</span>-from-file<span class="operator">=</span><span class="symbol">./username.txt</span> <span class="operator">-</span>-from-file<span class="operator">=</span><span class="symbol">./password.txt</span></span><br><span class="line">secret<span class="symbol">/db-user-pass</span> created</span><br><span class="line"></span><br><span class="line">$ kubectl describe secret db-user-pass</span><br><span class="line"><span class="params">Name:</span>         db-user-pass</span><br><span class="line"><span class="params">Namespace:</span>    default</span><br><span class="line"><span class="params">Labels:</span>       <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Annotations:</span>  <span class="symbol">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="params">Type:</span>  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line"><span class="operator">==</span><span class="operator">==</span></span><br><span class="line">password.<span class="params">txt:</span>  <span class="number">12</span> bytes</span><br><span class="line">username.<span class="params">txt:</span>  <span class="number">5</span> bytes</span><br><span class="line"><span class="comment"># é»˜è®¤æƒ…å†µä¸‹ï¼Œget å’Œ describe å‘½ä»¤éƒ½ä¸ä¼šæ˜¾ç¤ºæ–‡ä»¶çš„å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment"># è¿™æ˜¯ä¸ºäº†é˜²æ­¢å°† secret ä¸­çš„å†…å®¹è¢«æ„å¤–æš´éœ²ç»™ä»ç»ˆç«¯æ—¥å¿—è®°å½•ä¸­åˆ»æ„å¯»æ‰¾å®ƒä»¬çš„äººã€‚</span></span><br></pre></td></tr></tbody></table></figure><p>åœ¨ Pod ä¸­ä½¿ç”¨ Secret æ–‡ä»¶<br>åœ¨æŒ‚è½½çš„ secret volume çš„å®¹å™¨å†…ï¼Œsecret key å°†ä½œä¸ºæ–‡ä»¶ï¼Œå¹¶ä¸” secret çš„å€¼ä½¿ç”¨ base-64 è§£ç å¹¶å­˜å‚¨åœ¨è¿™äº›æ–‡ä»¶ä¸­ã€‚è¿™æ˜¯åœ¨ä¸Šé¢çš„ç¤ºä¾‹å®¹å™¨å†…æ‰§è¡Œçš„å‘½ä»¤çš„ç»“æœï¼š</p><figure class="highlight swift"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> kubectl exec <span class="operator">-</span>it mypod <span class="regexp">/bin/</span>bash</span><br><span class="line">root<span class="meta">@mypod</span>:<span class="regexp">/# cat /</span>etc<span class="regexp">/foo/</span>username.txt</span><br><span class="line">admin</span><br><span class="line">root<span class="meta">@mypod</span>:<span class="regexp">/# cat /</span>etc<span class="regexp">/foo/</span>password.txt</span><br><span class="line">1f2d1e2e67df</span><br></pre></td></tr></tbody></table></figure><p>å®¹å™¨ä¸­çš„ç¨‹åºè´Ÿè´£ä»æ–‡ä»¶ä¸­è¯»å– secretã€‚<br>å…³äºsecretæŒ‚è½½ä½¿ç”¨æ–¹æ³• æ›´å¤šï¼š<a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-%E4%B8%8E-pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E8%81%94%E7%B3%BB">https://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-%E4%B8%8E-pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E8%81%94%E7%B3%BB</a></p><h2 id="ä¸´æ—¶æ•°æ®å­˜å‚¨"><a href="#ä¸´æ—¶æ•°æ®å­˜å‚¨" class="headerlink" title="ä¸´æ—¶æ•°æ®å­˜å‚¨"></a>ä¸´æ—¶æ•°æ®å­˜å‚¨</h2><h3 id="1-emptryDir"><a href="#1-emptryDir" class="headerlink" title="1. emptryDir"></a>1. emptryDir</h3><p>å½“ Pod è¢«åˆ†é…ç»™èŠ‚ç‚¹æ—¶ï¼Œé¦–å…ˆåˆ›å»º emptyDir å·ï¼Œå¹¶ä¸”åªè¦è¯¥ Pod åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œè¯¥å·å°±ä¼šå­˜åœ¨ã€‚æ­£å¦‚å·çš„åå­—æ‰€è¿°ï¼Œå®ƒæœ€åˆæ˜¯ç©ºçš„ã€‚Pod ä¸­çš„å®¹å™¨å¯ä»¥è¯»å–å’Œå†™å…¥ emptyDir å·ä¸­çš„ç›¸åŒæ–‡ä»¶ï¼Œå°½ç®¡è¯¥å·å¯ä»¥æŒ‚è½½åˆ°æ¯ä¸ªå®¹å™¨ä¸­çš„ç›¸åŒæˆ–ä¸åŒè·¯å¾„ä¸Šã€‚å½“å‡ºäºä»»ä½•åŸå› ä»èŠ‚ç‚¹ä¸­åˆ é™¤ Pod æ—¶ï¼ŒemptyDir ä¸­çš„æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚</p><p>æ³¨æ„ï¼šå®¹å™¨å´©æºƒä¸ä¼šä»èŠ‚ç‚¹ä¸­ç§»é™¤ podï¼Œå› æ­¤ emptyDir å·ä¸­çš„æ•°æ®åœ¨å®¹å™¨å´©æºƒæ—¶æ˜¯å®‰å…¨çš„ã€‚</p><p>ç¼ºçœæƒ…å†µä¸‹ï¼ŒEmptyDir æ˜¯ä½¿ç”¨ä¸»æœºç£ç›˜è¿›è¡Œå­˜å‚¨çš„ï¼Œä¹Ÿå¯ä»¥è®¾ç½®emptyDir.medium å­—æ®µçš„å€¼ä¸ºMemoryï¼Œæ¥æé«˜è¿è¡Œé€Ÿåº¦ï¼Œä½†æ˜¯è¿™ç§è®¾ç½®ï¼Œå¯¹è¯¥å·çš„å ç”¨ä¼šæ¶ˆè€—å®¹å™¨çš„å†…å­˜ä»½é¢ã€‚</p><p>emptyDir çš„ç”¨æ³•æœ‰ï¼š</p><ul><li>æš‚å­˜ç©ºé—´ï¼Œä¾‹å¦‚ç”¨äºåŸºäºç£ç›˜çš„åˆå¹¶æ’åº</li><li>ç”¨ä½œé•¿æ—¶é—´è®¡ç®—å´©æºƒæ¢å¤æ—¶çš„æ£€æŸ¥ç‚¹</li><li>WebæœåŠ¡å™¨å®¹å™¨æä¾›æ•°æ®æ—¶ï¼Œä¿å­˜å†…å®¹ç®¡ç†å™¨å®¹å™¨æå–çš„æ–‡ä»¶</li><li>å¯ä»¥åœ¨åŒä¸€ Pod å†…çš„ä¸åŒå®¹å™¨ä¹‹é—´å…±äº«å·¥ä½œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–‡ä»¶ã€‚</li></ul><h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-emptydir-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">image:</span> nginx</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">name:</span> test-emptydir-pod</span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/temp-data</span>      <span class="comment"># æŒ‚è½½ç‚¹</span></span><br><span class="line">      <span class="params">name:</span> temp-data</span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> temp-data</span><br><span class="line">    <span class="params">emptyDir:</span> {}</span><br></pre></td></tr></tbody></table></figure><p>åˆ›å»ºpod</p><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> kubectl create -f test-emptydir-pod.yaml</span><br><span class="line">pod/test-emptydir-pod created</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME                READY     STATUS    RESTARTS   AGE       IP            <span class="keyword">NODE</span>      <span class="title">NOMINATED</span> <span class="keyword">NODE</span></span><br><span class="line"><span class="title">test-emptydir-pod</span>   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">18s</span>       <span class="number">10.244</span>.<span class="number">0.23</span>   k8s-m3    <span class="tag">&lt;none&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ—¶Emptydirå·²ç»åˆ›å»ºæˆåŠŸï¼Œåœ¨å®¿ä¸»æœºä¸Šçš„è®¿é—®è·¯å¾„ä¸º/var/lib/kubelet/pods/<pod uid="">/volumes/kubernetes.io~empty-dir/temp-data,å¦‚æœåœ¨æ­¤ç›®å½•ä¸­åˆ›å»ºåˆ é™¤æ–‡ä»¶ï¼Œéƒ½å°†å¯¹å®¹å™¨ä¸­çš„/dataç›®å½•æœ‰å½±å“ï¼Œå¦‚æœåˆ é™¤Podï¼Œæ–‡ä»¶å°†å…¨éƒ¨åˆ é™¤ï¼Œå³ä½¿æ˜¯åœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºçš„æ–‡ä»¶ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œåœ¨å®¿ä¸»æœºä¸Šåˆ é™¤å®¹å™¨åˆ™k8sä¼šå†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œæ­¤æ—¶æ–‡ä»¶ä»ç„¶å­˜åœ¨ã€‚</pod></p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å– pod uid</span></span><br><span class="line"><span class="attribute">kubectl</span> get pod test-emptydir-pod -o yaml | grep -n uid</span><br><span class="line"><span class="attribute">11</span>:  uid: <span class="number">3328</span>c9e1-ff8f-<span class="number">11</span>e8-b6d6-<span class="number">00505621</span>dd5b</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½•åˆ°èŠ‚ç‚¹k8s-m3 æŸ¥çœ‹</span></span><br><span class="line"> <span class="attribute">ll</span> /var/lib/kubelet/pods/<span class="number">3328</span>c9e1-ff8f-<span class="number">11</span>e8-b6d6-<span class="number">00505621</span>dd5b/volumes/kubernetes.io~empty-dir/</span><br><span class="line"><span class="attribute">total</span> <span class="number">0</span></span><br><span class="line"><span class="attribute">drwxrwxrwx</span> <span class="number">2</span> root root <span class="number">6</span> Dec <span class="number">14</span> <span class="number">05</span>:<span class="number">58</span> temp-data</span><br></pre></td></tr></tbody></table></figure><h3 id="2-hostPath"><a href="#2-hostPath" class="headerlink" title="2. hostPath"></a>2. hostPath</h3><p>hostPath volumeæ˜ å°„nodeæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æˆ–è€…ç›®å½•åˆ°podé‡Œã€‚å¤§å¤šæ•°Podéƒ½ä¸éœ€è¦è¿™ä¸ªåŠŸèƒ½ï¼Œä½†å¯¹äºä¸€äº›ç‰¹å®šçš„åœºæ™¯ï¼Œè¯¥ç‰¹æ€§è¿˜æ˜¯å¾ˆæœ‰ä½œç”¨çš„ã€‚è¿™äº›åœºæ™¯åŒ…æ‹¬ï¼š </p><ul><li>è¿è¡Œçš„å®¹å™¨éœ€è¦è®¿é—®Dockerå†…éƒ¨ç»“æ„ï¼šä½¿ç”¨hostPathæ˜ å°„/var/lib/docker </li><li>åœ¨å®¹å™¨ä¸­è¿è¡ŒcAdvisorï¼Œä½¿ç”¨hostPathæ˜ å°„/dev/cgroups</li></ul><p>ä¸è¿‡ï¼Œä½¿ç”¨è¿™ç§volumeè¦å°å¿ƒï¼Œå› ä¸ºï¼š </p><ul><li>é…ç½®ç›¸åŒçš„podï¼ˆå¦‚é€šè¿‡podTemplateåˆ›å»ºï¼‰ï¼Œå¯èƒ½åœ¨ä¸åŒçš„Nodeä¸Šè¡¨ç°ä¸åŒï¼Œå› ä¸ºä¸åŒèŠ‚ç‚¹ä¸Šæ˜ å°„çš„æ–‡ä»¶å†…å®¹ä¸åŒ </li><li>å½“Kuberneteså¢åŠ äº†èµ„æºæ•æ„Ÿçš„è°ƒåº¦ç¨‹åºï¼ŒhostPathä½¿ç”¨çš„èµ„æºä¸ä¼šè¢«è®¡ç®—åœ¨å†… </li><li>å®¿ä¸»æœºä¸‹åˆ›å»ºçš„ç›®å½•åªæœ‰rootæœ‰å†™æƒé™ã€‚ä½ éœ€è¦è®©ä½ çš„ç¨‹åºè¿è¡Œåœ¨privileged containerä¸Šï¼Œæˆ–è€…ä¿®æ”¹å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶æƒé™ã€‚</li></ul><p>ã€€</p><h4 id="ç¤ºä¾‹ï¼š-2"><a href="#ç¤ºä¾‹ï¼š-2" class="headerlink" title="ç¤ºä¾‹ï¼š"></a>ç¤ºä¾‹ï¼š</h4><p>å‡è®¾æˆ‘ä»¬åœ¨åˆ›å»ºdockeré•œåƒçš„æ—¶å€™å¿˜è®°äº†æ›´æ”¹å®¹å™¨ä¸­çš„æ—¶åŒºæ–‡ä»¶ï¼›è¿™æ—¶å€™æƒ³æŠŠå®¿ä¸»æœºçš„/usr/share/zoneinfo/Asia/ShanghaiæŒ‚åˆ°podä¸­çš„å®¹å™¨å†…(è¿™é‡Œä¸ºäº†å­¦ä¹ æŒ‚è½½æ–¹å¼ï¼Œæš‚ä¸”ä¸è°ˆä¸åŒç³»ç»Ÿæˆ–ä¸åŒå®¿ä¸»æœºçš„ä¸€äº›é…ç½®æˆ–è·¯å¾„)</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-emptydir-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">image:</span> nginx</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">name:</span> test-emptydir-pod</span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> container-time</span><br><span class="line">      <span class="params">mountPath:</span> <span class="symbol">/etc/localtime</span>  <span class="comment"># æŒ‚è½½ç‚¹ï¼Œcontainerå¯åŠ¨åç›´æ¥æŒ‚è½½è¦†ç›–æ­¤æ–‡ä»¶</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> container-time</span><br><span class="line">    <span class="params">hostPath:</span> </span><br><span class="line">      <span class="params">path:</span> <span class="symbol">/usr/share/zoneinfo/Asia/Shanghai</span>  <span class="comment"># æŒ‚è½½æ—¶åŒºæ–‡ä»¶åˆ°containerä¸­</span></span><br></pre></td></tr></tbody></table></figure><p>é€šè¿‡åˆ›å»ºpodåç™»å½•æ£€æŸ¥æ—¶åŒºæ­£å¸¸.</p><h1 id="äºŒã€æŒä¹…å­˜å‚¨å·çš„ç”¨æ³•"><a href="#äºŒã€æŒä¹…å­˜å‚¨å·çš„ç”¨æ³•" class="headerlink" title="äºŒã€æŒä¹…å­˜å‚¨å·çš„ç”¨æ³•:"></a>äºŒã€æŒä¹…å­˜å‚¨å·çš„ç”¨æ³•:</h1><p>å­¦ä¹ æŒä¹…åŒ–å­˜å‚¨ä¹‹å‰éœ€è¦å­¦ä¹ ä¸€ä¸‹ä»¥ä¸‹æ¦‚å¿µï¼š<br>Volume æä¾›äº†éå¸¸å¥½çš„æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆï¼Œä¸è¿‡åœ¨å¯ç®¡ç†æ€§ä¸Šè¿˜æœ‰ä¸è¶³ã€‚<br>æ‹¿å‰é¢ AWS EBS çš„ä¾‹å­æ¥è¯´ï¼Œè¦ä½¿ç”¨ Volumeï¼ŒPod å¿…é¡»äº‹å…ˆçŸ¥é“å¦‚ä¸‹ä¿¡æ¯ï¼š</p><ul><li>å½“å‰ Volume æ¥è‡ª AWS EBSã€‚</li><li>EBS Volume å·²ç»æå‰åˆ›å»ºï¼Œå¹¶ä¸”çŸ¥é“ç¡®åˆ‡çš„ volume-idã€‚</li></ul><p>Pod é€šå¸¸æ˜¯ç”±åº”ç”¨çš„å¼€å‘äººå‘˜ç»´æŠ¤ï¼Œè€Œ Volume åˆ™é€šå¸¸æ˜¯ç”±å­˜å‚¨ç³»ç»Ÿçš„ç®¡ç†å‘˜ç»´æŠ¤ã€‚å¼€å‘äººå‘˜è¦è·å¾—ä¸Šé¢çš„ä¿¡æ¯ï¼š</p><ul><li>è¦ä¹ˆè¯¢é—®ç®¡ç†å‘˜ã€‚</li><li>è¦ä¹ˆè‡ªå·±å°±æ˜¯ç®¡ç†å‘˜ã€‚</li></ul><p>è¿™æ ·å°±å¸¦æ¥ä¸€ä¸ªç®¡ç†ä¸Šçš„é—®é¢˜ï¼šåº”ç”¨å¼€å‘äººå‘˜å’Œç³»ç»Ÿç®¡ç†å‘˜çš„èŒè´£è€¦åˆåœ¨ä¸€èµ·äº†ã€‚å¦‚æœç³»ç»Ÿè§„æ¨¡è¾ƒå°æˆ–è€…å¯¹äºå¼€å‘ç¯å¢ƒè¿™æ ·çš„æƒ…å†µè¿˜å¯ä»¥æ¥å—ã€‚ä½†å½“é›†ç¾¤è§„æ¨¡å˜å¤§ï¼Œç‰¹åˆ«æ˜¯å¯¹äºç”Ÿæˆç¯å¢ƒï¼Œè€ƒè™‘åˆ°æ•ˆç‡å’Œå®‰å…¨æ€§ï¼Œè¿™å°±æˆäº†å¿…é¡»è¦è§£å†³çš„é—®é¢˜ã€‚</p><p>Kubernetes ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯ PersistentVolume å’Œ PersistentVolumeClaimã€‚</p><p>PersistentVolume (PV) æ˜¯å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿä¸­çš„ä¸€å—å­˜å‚¨ç©ºé—´ï¼Œç”±ç®¡ç†å‘˜åˆ›å»ºå’Œç»´æŠ¤ã€‚ä¸ Volume ä¸€æ ·ï¼ŒPV å…·æœ‰æŒä¹…æ€§ï¼Œç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äº Podã€‚</p><p>PersistentVolumeClaim (PVC) æ˜¯å¯¹ PV çš„ç”³è¯· (Claim)ã€‚PVC é€šå¸¸ç”±æ™®é€šç”¨æˆ·åˆ›å»ºå’Œç»´æŠ¤ã€‚éœ€è¦ä¸º Pod åˆ†é…å­˜å‚¨èµ„æºæ—¶ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»ºä¸€ä¸ª PVCï¼ŒæŒ‡æ˜å­˜å‚¨èµ„æºçš„å®¹é‡å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼ˆæ¯”å¦‚åªè¯»ï¼‰ç­‰ä¿¡æ¯ï¼ŒKubernetes ä¼šæŸ¥æ‰¾å¹¶æä¾›æ»¡è¶³æ¡ä»¶çš„ PVã€‚</p><p>æœ‰äº† PersistentVolumeClaimï¼Œç”¨æˆ·åªéœ€è¦å‘Šè¯‰ Kubernetes éœ€è¦ä»€ä¹ˆæ ·çš„å­˜å‚¨èµ„æºï¼Œè€Œä¸å¿…å…³å¿ƒçœŸæ­£çš„ç©ºé—´ä»å“ªé‡Œåˆ†é…ï¼Œå¦‚ä½•è®¿é—®ç­‰åº•å±‚ç»†èŠ‚ä¿¡æ¯ã€‚è¿™äº› Storage Provider çš„åº•å±‚ä¿¡æ¯äº¤ç»™ç®¡ç†å‘˜æ¥å¤„ç†ï¼Œåªæœ‰ç®¡ç†å‘˜æ‰åº”è¯¥å…³å¿ƒåˆ›å»º PersistentVolume çš„ç»†èŠ‚ä¿¡æ¯ã€‚</p><p>Kubernetes æ”¯æŒå¤šç§ç±»å‹çš„ PersistentVolumeï¼Œæ¯”å¦‚ AWS EBSã€Cephã€NFS ç­‰ï¼Œå®Œæ•´åˆ—è¡¨è¯·å‚è€ƒ <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes</a></p><p>ä¸»è¦åŒ…æ‹¬:<code>NFS</code>/<code>GlusterFS</code>/<code>CephFS</code>/<code>AWS</code>/<code>GCE</code>ç­‰ç­‰<br>ä½œä¸ºä¸€ä¸ªå®¹å™¨é›†ç¾¤ï¼Œæ”¯æŒç½‘ç»œå­˜å‚¨è‡ªç„¶æ˜¯é‡ä¸­ä¹‹é‡äº†,Kubernetesæ”¯æŒä¸ºæ•°ä¼—å¤šçš„äº‘æä¾›å•†å’Œç½‘ç»œå­˜å‚¨æ–¹æ¡ˆã€‚<br>ä¸åŒå…¬å¸é€‰æ‹©çš„æ–¹æ¡ˆä¹Ÿæ˜¯ä¸ç›¸åŒã€‚</p><p>ä¸‹èŠ‚æˆ‘ç”¨ NFS æ¥ä½“ä¼šå®ƒå­˜å‚¨çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><h2 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h2><h3 id="NFSçš„æ­å»º"><a href="#NFSçš„æ­å»º" class="headerlink" title="NFSçš„æ­å»º"></a>NFSçš„æ­å»º</h3><h4 id="1-åœ¨NFSå­˜å‚¨çš„æœåŠ¡å™¨åˆ›å»ºå­˜å‚¨ç›®å½•"><a href="#1-åœ¨NFSå­˜å‚¨çš„æœåŠ¡å™¨åˆ›å»ºå­˜å‚¨ç›®å½•" class="headerlink" title="1. åœ¨NFSå­˜å‚¨çš„æœåŠ¡å™¨åˆ›å»ºå­˜å‚¨ç›®å½•:"></a>1. åœ¨NFSå­˜å‚¨çš„æœåŠ¡å™¨åˆ›å»ºå­˜å‚¨ç›®å½•:</h4><figure class="highlight autohotkey"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># è¿™é‡Œå…ˆåˆ›å»ºä¸‰ä¸ªå…±äº«ç›®å½•ç¨åä¼šç”¨åˆ°.</span><br><span class="line">$ mkdir /{nfs_dat<span class="built_in">a_1</span>,nfs_dat<span class="built_in">a_2</span>,nfs_dat<span class="built_in">a_3</span>}</span><br></pre></td></tr></tbody></table></figure><h4 id="2-å®‰è£…nfs"><a href="#2-å®‰è£…nfs" class="headerlink" title="2. å®‰è£…nfs:"></a>2. å®‰è£…nfs:</h4><figure class="highlight cmake"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y <span class="keyword">install</span> nfs-utils rpcbind</span><br></pre></td></tr></tbody></table></figure><h4 id="3-å†™å…¥é…ç½®"><a href="#3-å†™å…¥é…ç½®" class="headerlink" title="3. å†™å…¥é…ç½®"></a>3. å†™å…¥é…ç½®</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"/nfs_data_1 *(rw,sync,no_subtree_check,no_root_squash)"</span> &gt; /etc/exports</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/nfs_data_2 *(rw,sync,no_subtree_check,no_root_squash)"</span> &gt;&gt; /etc/exports</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/nfs_data_3 *(rw,sync,no_subtree_check,no_root_squash)"</span> &gt;&gt; /etc/exports</span><br></pre></td></tr></tbody></table></figure><h4 id="4-é‡å¯nfsæœåŠ¡éªŒè¯"><a href="#4-é‡å¯nfsæœåŠ¡éªŒè¯" class="headerlink" title="4. é‡å¯nfsæœåŠ¡éªŒè¯"></a>4. é‡å¯nfsæœåŠ¡éªŒè¯</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart nfs-server</span><br><span class="line">showmount -e 192.168.56.113  <span class="comment"># NFS Server</span></span><br><span class="line">Export list <span class="keyword">for</span> 192.168.56.113:</span><br><span class="line">/nfs_data_3 *</span><br><span class="line">/nfs_data_2 *</span><br><span class="line">/nfs_data_1 *</span><br><span class="line"></span><br><span class="line"><span class="comment"># nfså®‰è£…å¹¶ä¸”å…±äº«ç›®å½•å·²ç»åˆ›å»ºå®Œæ¯•</span></span><br></pre></td></tr></tbody></table></figure><h3 id="NFSä½œä¸ºæ™®é€šå­˜å‚¨å·"><a href="#NFSä½œä¸ºæ™®é€šå­˜å‚¨å·" class="headerlink" title="NFSä½œä¸ºæ™®é€šå­˜å‚¨å·"></a>NFSä½œä¸ºæ™®é€šå­˜å‚¨å·</h3><p>åœ¨Kubernetesä¸­ï¼Œå¯ä»¥é€šè¿‡nfsç±»å‹çš„å­˜å‚¨å·å°†ç°æœ‰çš„NFSï¼ˆç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼‰åˆ°çš„æŒ‚æ¥åˆ°Podä¸­ã€‚åœ¨ç§»é™¤Podæ—¶ï¼ŒNFSå­˜å‚¨å·ä¸­çš„å†…å®¹è¢«ä¸ä¼šè¢«åˆ é™¤ï¼Œåªæ˜¯å°†å­˜å‚¨å·å¸è½½è€Œå·²ã€‚è¿™æ„å‘³ç€åœ¨NFSå­˜å‚¨å·æ€»å¯ä»¥é¢„å…ˆå¡«å……æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨Podä¹‹é—´å…±äº«æ•°æ®ã€‚NFSå¯ä»¥è¢«åŒæ—¶æŒ‚æ¥åˆ°å¤šä¸ªPodä¸­ï¼Œå¹¶èƒ½åŒæ—¶è¿›è¡Œå†™å…¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨ä½¿ç”¨nfså­˜å‚¨å·ä¹‹å‰ï¼Œå¿…é¡»å·²æ­£ç¡®éƒ¨ç½²å’Œè¿è¡ŒNFSæœåŠ¡å™¨ï¼Œå¹¶å·²ç»è®¾ç½®äº†å…±äº«ç›®å½•ã€‚</p><h4 id="åˆ›å»ºä¸€ä¸ªpodï¼Œè®©å…¶æŒ‚è½½ä¸Šé¢åˆ›å»ºçš„å…±äº«ç›®å½•"><a href="#åˆ›å»ºä¸€ä¸ªpodï¼Œè®©å…¶æŒ‚è½½ä¸Šé¢åˆ›å»ºçš„å…±äº«ç›®å½•" class="headerlink" title="åˆ›å»ºä¸€ä¸ªpodï¼Œè®©å…¶æŒ‚è½½ä¸Šé¢åˆ›å»ºçš„å…±äº«ç›®å½•"></a>åˆ›å»ºä¸€ä¸ªpodï¼Œè®©å…¶æŒ‚è½½ä¸Šé¢åˆ›å»ºçš„å…±äº«ç›®å½•</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> nfs-busybox <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nfs-busybox-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> nfs-busybox-pod</span><br><span class="line">    <span class="params">image:</span> busybox</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">command:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"/bin/sh"</span></span><br><span class="line">    <span class="params">args:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"-c"</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> nfs-busybox-storage</span><br><span class="line">        <span class="params">mountPath:</span> <span class="string">"/mnt"</span></span><br><span class="line">  <span class="params">restartPolicy:</span> <span class="string">"Never"</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> nfs-busybox-storage</span><br><span class="line">      <span class="params">nfs:</span></span><br><span class="line">        <span class="params">path:</span> <span class="symbol">/nfs_data_1</span>       <span class="comment"># NFS å…±äº«ç›®å½•</span></span><br><span class="line">        <span class="params">server:</span> <span class="number">192.168</span>.<span class="number">56.113</span>  <span class="comment"># NFS Server</span></span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>å¯åŠ¨PODï¼Œä¸€ä¼šå„¿PODå°±æ˜¯completedçŠ¶æ€ï¼Œè¯´æ˜æ‰§è¡Œå®Œæ¯•ã€‚</p><figure class="highlight processing"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f <span class="built_in">nfs</span>-busybox.<span class="property">yaml</span></span><br><span class="line">pod/<span class="built_in">nfs</span>-busybox-pod created</span><br><span class="line">$ kubectl <span class="built_in">get</span> pods</span><br><span class="line">NAME              READY     STATUS      RESTARTS   AGE</span><br><span class="line"><span class="built_in">nfs</span>-busybox-pod   <span class="number">0</span>/<span class="number">1</span>       Completed   <span class="number">0</span>          <span class="number">7</span>s</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘ä»¬å»NFS Serverå…±äº«ç›®å½•æŸ¥çœ‹æœ‰æ²¡æœ‰SUCCESSæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /nfs_data_1/</span><br><span class="line">SUCCESS</span><br></pre></td></tr></tbody></table></figure><p>è¯´æ˜å½“NFSä½œä¸ºæ™®é€šå­˜å‚¨å·æ—¶æˆ‘ä»¬æŒ‚è½½åˆ°podå®¹å™¨ä¸­äº§ç”Ÿæ•°æ®å°†ä¼šä¿å­˜åˆ°è¿™ä¸ªå­˜å‚¨å·å½“ä¸­ï¼Œå¹¶ä¸”åˆ é™¤podä¸ä¼šå½±å“æ•°æ®ã€‚</p><hr><h3 id="å¦‚ä½•åŸºäºNFSæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ï¼Ÿ"><a href="#å¦‚ä½•åŸºäºNFSæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ï¼Ÿ" class="headerlink" title="å¦‚ä½•åŸºäºNFSæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ï¼Ÿ"></a>å¦‚ä½•åŸºäºNFSæ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ï¼Ÿ</h3><p>Provisioning: PVçš„é¢„åˆ¶åˆ›å»ºæœ‰ä¸¤ç§æ¨¡å¼ï¼š<code>é™æ€</code>å’Œ<code>åŠ¨æ€</code>ä¾›ç»™æ¨¡å¼ï¼Œä»–ä»¬çš„å«ä¹‰æ˜¯ï¼š</p><p><code>é™æ€ä¾›ç»™æ¨¡å¼</code>: éœ€è¦å…ˆæ‰‹åŠ¨åˆ›å»ºPV, ç„¶åé€šè¿‡ PVC ç”³è¯· PV å¹¶åœ¨ Pod ä¸­ä½¿ç”¨ï¼Œè¿™ç§æ–¹å¼å«åšé™æ€ä¾›ç»™ï¼ˆStatic Provisionï¼‰ã€‚<br><code>åŠ¨æ€ä¾›ç»™æ¨¡å¼</code>: åªéœ€è¦åˆ›å»ºPVCï¼Œç³»ç»Ÿæ ¹æ®PVCåˆ›å»ºPV, å¦‚æœæ²¡æœ‰æ»¡è¶³ PVC æ¡ä»¶çš„ PVï¼Œä¼šåŠ¨æ€åˆ›å»º PVã€‚ç›¸æ¯”é™æ€ä¾›ç»™ï¼ŒåŠ¨æ€ä¾›ç»™(Dynamical Provisionï¼‰æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ï¼šä¸éœ€è¦æå‰åˆ›å»º PVï¼Œå‡å°‘äº†ç®¡ç†å‘˜çš„å·¥ä½œé‡ï¼Œæ•ˆç‡é«˜.</p><p>åŠ¨æ€ä¾›ç»™æ˜¯é€šè¿‡ StorageClass å®ç°çš„ï¼ŒStorageClass å®šä¹‰äº†å¦‚ä½•åˆ›å»º PVã€‚<br><img src="/2018/12/15/kubernetes-storage/k8s-pvc.png" alt="k8s-pv"></p><p>ä¸‹é¢å°±åˆ†åˆ«å®è·µè¿™ä¸¤ç§æ¨¡å¼çš„åˆ›å»ºè·Ÿä½¿ç”¨:</p><h3 id="NFSä½œä¸ºé™æ€ä¾›ç»™æ¨¡å¼æŒä¹…åŒ–å­˜å‚¨å·"><a href="#NFSä½œä¸ºé™æ€ä¾›ç»™æ¨¡å¼æŒä¹…åŒ–å­˜å‚¨å·" class="headerlink" title="NFSä½œä¸ºé™æ€ä¾›ç»™æ¨¡å¼æŒä¹…åŒ–å­˜å‚¨å·"></a>NFSä½œä¸ºé™æ€ä¾›ç»™æ¨¡å¼æŒä¹…åŒ–å­˜å‚¨å·</h3><figure class="highlight brainfuck"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">æ‰‹åŠ¨åˆ›å»ºPV</span><span class="literal">---</span>&gt;<span class="comment">æ‰‹åŠ¨åˆ›å»ºPVC</span><span class="literal">---</span>&gt;<span class="comment">PODæŒ‚è½½ä½¿ç”¨</span></span><br></pre></td></tr></tbody></table></figure><h4 id="1-åˆ›å»ºPV"><a href="#1-åˆ›å»ºPV" class="headerlink" title="1. åˆ›å»ºPV"></a>1. åˆ›å»ºPV</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> nfs-test-pv.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> PersistentVolume</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nfs-test-pv</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> nfs-test-pv</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">capacity:</span></span><br><span class="line">    <span class="params">storage:</span> <span class="number">5</span>Gi   <span class="comment"># æŒ‡å®šPVå®¹é‡ä¸º5G</span></span><br><span class="line">  <span class="params">accessModes:</span></span><br><span class="line">    <span class="operator">-</span> ReadWriteOnce <span class="comment">#  æŒ‡å®šè®¿é—®æ¨¡å¼ä¸º ReadWriteOnce</span></span><br><span class="line">  <span class="params">persistentVolumeReclaimPolicy:</span> Recycle <span class="comment"># æŒ‡å®šå½“ PV çš„å›æ”¶ç­–ç•¥ä¸º Recycle</span></span><br><span class="line">  <span class="params">storageClassName:</span> nfs   <span class="comment"># å®š PV çš„ class ä¸º nfsã€‚ç›¸å½“äºä¸º PV è®¾ç½®äº†ä¸€ä¸ªåˆ†ç±»ï¼ŒPVC å¯ä»¥æŒ‡å®š class ç”³è¯·ç›¸åº” class çš„ PVã€‚</span></span><br><span class="line">  <span class="params">nfs:</span></span><br><span class="line">    <span class="params">path:</span> <span class="symbol">/nfs_data_2</span> <span class="comment"># æŒ‡å®š PV åœ¨ NFS æœåŠ¡å™¨ä¸Šå¯¹åº”çš„ç›®å½•</span></span><br><span class="line">    <span class="params">server:</span> <span class="number">192.168</span>.<span class="number">56.113</span> <span class="comment"># NFS Serveråœ°å€</span></span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p><img src="/2018/12/15/kubernetes-storage/create_pv.png" alt="create_pv"></p><p>STATUS ä¸º Availableï¼Œè¡¨ç¤º nfs-test-pv å°±ç»ªï¼Œå¯ä»¥è¢« PVC ç”³è¯·ã€‚<br>æ¥ä¸‹æ¥åˆ›å»º PVC nfs-test-pv-claimï¼š</p><h4 id="2-åˆ›å»ºPVC"><a href="#2-åˆ›å»ºPVC" class="headerlink" title="2. åˆ›å»ºPVC"></a>2. åˆ›å»ºPVC</h4><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="operator">&gt;</span><span class="operator">&gt;</span> nfs-test-pv-claim.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> PersistentVolumeClaim</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nfs-test-pv-claim</span><br><span class="line">  <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">accessModes:</span> <span class="comment"># å­˜å‚¨è®¿é—®æ¨¡å¼ï¼Œæ­¤èƒ½åŠ›ä¾èµ–å­˜å‚¨å‚å•†èƒ½åŠ›</span></span><br><span class="line">    <span class="operator">-</span> ReadWriteOnce</span><br><span class="line">  <span class="params">resources:</span></span><br><span class="line">    <span class="params">requests:</span></span><br><span class="line">      <span class="params">storage:</span> <span class="number">2</span>Gi <span class="comment"># è¯·æ±‚è·å¾—çš„pvcå­˜å‚¨å¤§å°</span></span><br><span class="line">  <span class="params">storageClassName:</span> nfs </span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p><img src="/2018/12/15/kubernetes-storage/create_pvc.png" alt="create_pvc"></p><p>ä» kubectl get pvc å’Œ kubectl get pv çš„è¾“å‡ºå¯ä»¥çœ‹åˆ° nfs-test-pv-claim å·²ç» Bound åˆ° nfs-test-pvï¼Œç”³è¯·æˆåŠŸã€‚<br>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨ Pod ä¸­ä½¿ç”¨å­˜å‚¨äº†ï¼š</p><h4 id="3-åˆ›å»ºPod"><a href="#3-åˆ›å»ºPod" class="headerlink" title="3. åˆ›å»ºPod"></a>3. åˆ›å»ºPod</h4><figure class="highlight nestedtext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cat &gt;&gt; nfs-test-pod.yaml &lt;&lt; EOF</span></span><br><span class="line"><span class="attribute">apiVersion</span><span class="punctuation">:</span> <span class="string">v1</span></span><br><span class="line"><span class="attribute">kind</span><span class="punctuation">:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attribute">metadata</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">name</span><span class="punctuation">:</span> <span class="string"> nfs-test-pod</span></span><br><span class="line"><span class="attribute">spec</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">containers</span><span class="punctuation">:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">name:  nfs-test-pod</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attribute">args</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep 30000</span></span><br><span class="line">    <span class="attribute">volumeMounts</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mountPath: "/nfs-data"</span></span><br><span class="line">      <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">nfs-data</span></span><br><span class="line">  <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">name: nfs-data</span></span><br><span class="line">      <span class="attribute">persistentVolumeClaim</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">claimName</span><span class="punctuation">:</span> <span class="string"> nfs-test-pv-claim</span></span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>ä¸ä½¿ç”¨æ™®é€š Volume çš„æ ¼å¼ç±»ä¼¼ï¼Œåœ¨ volumes ä¸­é€šè¿‡ persistentVolumeClaim æŒ‡å®šä½¿ç”¨ nfs-test-pv-claim ç”³è¯·çš„ Volumeã€‚<br><img src="/2018/12/15/kubernetes-storage/create_pod.png" alt="create_pod"><br>éªŒè¯ PV æ˜¯å¦å¯ç”¨ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> nfs-test-pod <span class="built_in">touch</span> /nfs-data/SUCCESS</span><br></pre></td></tr></tbody></table></figure><div style="width: 50%; margin: auto">![create_result](kubernetes-storage/create_result.png)</div><p>å¯è§ï¼Œåœ¨ Pod ä¸­åˆ›å»ºçš„æ–‡ä»¶ /nfs-data/SUCCESS ç¡®å®å·²ç»ä¿å­˜åˆ°äº† NFS æœåŠ¡å™¨ç›®å½• /nfs_data_2/ä¸­ã€‚<br>å¦‚æœä¸å†éœ€è¦ä½¿ç”¨ PVï¼Œå¯ç”¨åˆ é™¤ PVC å›æ”¶ PV:</p><h4 id="4-å›æ”¶PVC"><a href="#4-å›æ”¶PVC" class="headerlink" title="4. å›æ”¶PVC"></a>4. å›æ”¶PVC</h4><p><strong>æŒä¹…åŒ–å·å£°æ˜çš„ä¿æŠ¤</strong><br>PVC ä¿æŠ¤çš„ç›®çš„æ˜¯ç¡®ä¿ç”± pod æ­£åœ¨ä½¿ç”¨çš„ PVC ä¸ä¼šä»ç³»ç»Ÿä¸­ç§»é™¤ï¼Œå› ä¸ºå¦‚æœè¢«ç§»é™¤çš„è¯å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚<br>æ³¨æ„ï¼šå½“ pod çŠ¶æ€ä¸º Pending å¹¶ä¸” pod å·²ç»åˆ†é…ç»™èŠ‚ç‚¹æˆ– pod ä¸º Running çŠ¶æ€æ—¶ï¼ŒPVC å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚<br>å½“å¯ç”¨<a href="https://k8smeetup.github.io/docs/tasks/administer-cluster/pvc-protection/#lichuqiang">PVCä¿æŠ¤</a>åŠŸèƒ½æ—¶ï¼Œå¦‚æœç”¨æˆ·åˆ é™¤äº†ä¸€ä¸ª pod æ­£åœ¨ä½¿ç”¨çš„ PVCï¼Œåˆ™è¯¥ PVC ä¸ä¼šè¢«ç«‹å³åˆ é™¤ã€‚PVC çš„åˆ é™¤å°†è¢«æ¨è¿Ÿï¼Œç›´åˆ° PVC ä¸å†è¢«ä»»ä½• pod ä½¿ç”¨ã€‚<br>æ‚¨å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ç›´æ¥åˆ é™¤ä¸Šé¢PODæ­£åœ¨ä½¿ç”¨çš„PVCæ—¶å‘½ä»¤ç›´æ¥hangä½äº†ï¼Œæ­¤æ—¶è™½ç„¶ä¸º Teminatiingï¼Œä½†PVC å—åˆ°ä¿æŠ¤ï¼Œ<code>Finalizers</code> åˆ—è¡¨ä¸­åŒ…å« kubernetes.io/pvc-protectionï¼š</p><figure class="highlight maxima"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">delete</span> pvc nfs-test-<span class="built_in">pv</span>-claim</span><br></pre></td></tr></tbody></table></figure><p><img src="/2018/12/15/kubernetes-storage/pvc_delete_status.png" alt="pvc_delete_status"><br>ç­‰å¾… pod çŠ¶æ€å˜ä¸º Terminatedï¼ˆåˆ é™¤ pod æˆ–è€…ç­‰åˆ°å®ƒç»“æŸï¼‰ï¼Œç„¶åæ£€æŸ¥ï¼Œç¡®è®¤ PVC è¢«ç§»é™¤ã€‚</p><p>åä¹‹ï¼Œå¦‚æœä¸€ä¸ªPVCæ²¡æœ‰è¢«podä½¿ç”¨åˆ™å¯ä»¥ç›´æ¥åˆ é™¤ã€‚</p><p>ç”¨æˆ·ç”¨å®Œ volume åï¼Œå¯ä»¥ä»å…è®¸å›æ”¶èµ„æºçš„ API ä¸­åˆ é™¤ PVC å¯¹è±¡ã€‚PersistentVolume çš„å›æ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤åœ¨å­˜å‚¨å·å£°æ˜é‡Šæ”¾ååº”å¦‚ä½•å¤„ç†è¯¥å·ã€‚ç›®å‰ï¼Œvolume çš„å¤„ç†ç­–ç•¥æœ‰:</p><ul><li>Retainï¼Œä¸æ¸…ç†, ä¿ç•™ Volumeï¼ˆéœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼‰</li><li>Recycleï¼Œåˆ é™¤æ•°æ®ï¼Œå³ rm -rf /thevolume/*ï¼ˆåªæœ‰ NFS å’Œ HostPath æ”¯æŒï¼‰</li><li>Deleteï¼Œåˆ é™¤å­˜å‚¨èµ„æºï¼Œæ¯”å¦‚åˆ é™¤ AWS EBS å·ï¼ˆåªæœ‰ AWS EBS, GCE PD, Azure Disk å’Œ Cinder æ”¯æŒï¼‰</li></ul><p>OK ä»¥ä¸Šæ˜¯NFSåˆ›å»ºé™æ€æ¨¡å¼åˆ›å»ºPVC,ä»¥åŠPVCè·ŸPODç”Ÿå‘½å‘¨æœŸçš„ä¸€äº›å®è·µï¼Œä¸‹é¢å®è·µåŠ¨æ€æ¨¡å¼</p><h3 id="NFSä½œä¸ºåŠ¨æ€æŒä¹…åŒ–å­˜å‚¨å·"><a href="#NFSä½œä¸ºåŠ¨æ€æŒä¹…åŒ–å­˜å‚¨å·" class="headerlink" title="NFSä½œä¸ºåŠ¨æ€æŒä¹…åŒ–å­˜å‚¨å·"></a>NFSä½œä¸ºåŠ¨æ€æŒä¹…åŒ–å­˜å‚¨å·</h3><p>åˆ©ç”¨NFS client provisioneråŠ¨æ€æä¾›Kubernetesåç«¯å­˜å‚¨å·</p><p>æƒ³è¦åŠ¨æ€ç”ŸæˆPVï¼Œéœ€è¦è¿è¡Œä¸€ä¸ªNFS-ProvisioneræœåŠ¡ï¼Œå°†å·²é…ç½®å¥½çš„NFSç³»ç»Ÿç›¸å…³å‚æ•°å½•å…¥ï¼Œå¹¶å‘ç”¨æˆ·æä¾›åˆ›å»ºPVçš„æœåŠ¡ã€‚å®˜æ–¹æ¨èä½¿ç”¨Deploymentè¿è¡Œä¸€ä¸ªreplicaæ¥å®ç°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨Daemonsetç­‰å…¶ä»–æ–¹å¼ï¼Œè¿™äº›éƒ½åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æä¾›äº†ã€‚</p><p>å‰ææ¡ä»¶æ˜¯æœ‰å·²ç»å®‰è£…å¥½çš„NFSæœåŠ¡å™¨ï¼Œå¹¶ä¸”NFSæœåŠ¡å™¨ä¸Kubernetesçš„SlaveèŠ‚ç‚¹éƒ½èƒ½ç½‘ç»œè¿é€šã€‚ æ‰€æœ‰ä¸‹æ–‡ç”¨åˆ°çš„æ–‡ä»¶æ¥è‡ªäº<code>git clone https://github.com/kubernetes-incubator/external-storage.git</code> çš„nfs-clientç›®å½•</p><p>nfs-client-provisioner æ˜¯ä¸€ä¸ªKubernetesçš„ç®€æ˜“NFSçš„å¤–éƒ¨provisionerï¼Œæœ¬èº«ä¸æä¾›NFSï¼Œéœ€è¦ç°æœ‰çš„NFSæœåŠ¡å™¨æä¾›å­˜å‚¨</p><ul><li>PVä»¥ <code>${namespace}-${pvcName}-${pvName}</code>çš„å‘½åæ ¼å¼æä¾›ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li><li>PVå›æ”¶çš„æ—¶å€™ä»¥ <code>archieved-${namespace}-${pvcName}-${pvName}</code> çš„å‘½åæ ¼å¼ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰</li></ul><h4 id="1-è·å–nfs-client-provisioneré…ç½®æ–‡ä»¶"><a href="#1-è·å–nfs-client-provisioneré…ç½®æ–‡ä»¶" class="headerlink" title="1. è·å–nfs-client-provisioneré…ç½®æ–‡ä»¶"></a>1. è·å–nfs-client-provisioneré…ç½®æ–‡ä»¶</h4><figure class="highlight crmsh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/kubernetes-incubator/external-storage.git</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h4 id="2-å®‰è£…éƒ¨ç½²"><a href="#2-å®‰è£…éƒ¨ç½²" class="headerlink" title="2. å®‰è£…éƒ¨ç½²:"></a>2. å®‰è£…éƒ¨ç½²:</h4><h5 id="1-ä¿®æ”¹deploymentæ–‡ä»¶å¹¶éƒ¨ç½²-deploy-deployment-yaml"><a href="#1-ä¿®æ”¹deploymentæ–‡ä»¶å¹¶éƒ¨ç½²-deploy-deployment-yaml" class="headerlink" title="1. ä¿®æ”¹deploymentæ–‡ä»¶å¹¶éƒ¨ç½² deploy/deployment.yaml"></a>1. ä¿®æ”¹deploymentæ–‡ä»¶å¹¶éƒ¨ç½² deploy/deployment.yaml</h5><p>éœ€è¦ä¿®æ”¹çš„åœ°æ–¹åªæœ‰NFSæœåŠ¡å™¨æ‰€åœ¨çš„IPåœ°å€ï¼ˆ192.168.56.113ï¼‰ï¼Œä»¥åŠNFSæœåŠ¡å™¨å…±äº«çš„è·¯å¾„ï¼ˆ/nfs_data_3ï¼‰ï¼Œä¸¤å¤„éƒ½éœ€è¦ä¿®æ”¹ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨å’Œå…±äº«ç›®å½•</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">deploy/deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.113</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/nfs_data_3</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.113</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/nfs_data_3</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">deploy/deployment.yaml</span> <span class="comment"># æ‰§è¡Œéƒ¨ç½²</span></span><br><span class="line"><span class="string">serviceaccount/nfs-client-provisioner</span> <span class="string">created</span></span><br><span class="line"><span class="string">deployment.extensions/nfs-client-provisioner</span> <span class="string">created</span></span><br></pre></td></tr></tbody></table></figure><h5 id="2-ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²-deploy-class-yaml"><a href="#2-ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½²-deploy-class-yaml" class="headerlink" title="2. ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½² deploy/class.yaml"></a>2. ä¿®æ”¹StorageClassæ–‡ä»¶å¹¶éƒ¨ç½² deploy/class.yaml</h5><p>æ­¤å¤„å¯ä»¥ä¸ä¿®æ”¹ï¼Œæˆ–è€…ä¿®æ”¹provisionerçš„åå­—ï¼Œéœ€è¦ä¸ä¸Šé¢çš„deploymentçš„PROVISIONER_NAMEåå­—ä¸€è‡´ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat deploy<span class="symbol">/class.yaml</span></span><br><span class="line"><span class="params">apiVersion:</span> storage.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> StorageClass</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> managed-nfs-storage</span><br><span class="line"><span class="params">provisioner:</span> fuseim.pri<span class="symbol">/ifs</span> <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line"><span class="params">parameters:</span></span><br><span class="line">  <span class="params">archiveOnDelete:</span> <span class="string">"false"</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># æ‰§è¡Œéƒ¨ç½² </span></span><br><span class="line">kubectl apply <span class="operator">-</span>f deploy<span class="symbol">/class.yaml</span></span><br><span class="line">storageclass.storage.k8s.io<span class="symbol">/managed-nfs-storage</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹StorageClass</span></span><br><span class="line">kubectl get sc</span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri<span class="symbol">/ifs</span>   <span class="number">16</span>m</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è¿™ä¸ªmanaged-nfs-storageåå­—çš„SCä¸ºKubernetesçš„é»˜è®¤å­˜å‚¨åç«¯</span></span><br><span class="line">kubectl patch storageclass managed-nfs-storage <span class="operator">-</span>p '{<span class="string">"metadata"</span>: {<span class="string">"annotations"</span>:{<span class="string">"storageclass.kubernetes.io/is-default-class"</span>:<span class="string">"true"</span>}}}'</span><br><span class="line">$ kubectl get sc</span><br><span class="line">NAME                            PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage (default)   fuseim.pri<span class="symbol">/ifs</span>   <span class="number">19</span>m</span><br></pre></td></tr></tbody></table></figure><h5 id="3-æˆæƒ"><a href="#3-æˆæƒ" class="headerlink" title="3. æˆæƒ"></a>3. æˆæƒ</h5><p>å¦‚æœæ‚¨çš„é›†ç¾¤å¯ç”¨äº†RBACï¼Œæˆ–è€…æ‚¨æ­£åœ¨è¿è¡ŒOpenShiftï¼Œåˆ™å¿…é¡»æˆæƒprovisionerã€‚ å¦‚æœä½ åœ¨éé»˜è®¤çš„â€œdefaultâ€åç§°ç©ºé—´/é¡¹ç›®ä¹‹å¤–éƒ¨ç½²ï¼Œå¯ä»¥ç¼–è¾‘deploy/rbac.yamlæˆ–ç¼–è¾‘`oadm policyâ€œæŒ‡ä»¤ã€‚</p><p><em>å¦‚æœå¯ç”¨äº†RBAC</em><br>éœ€è¦æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤æ¥æˆæƒã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">cat deploy<span class="symbol">/rbac.yaml</span></span><br><span class="line"><span class="params">kind:</span> ClusterRole</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nfs-client-provisioner-runner</span><br><span class="line"><span class="params">rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"persistentvolumes"</span>]</span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"delete"</span>]</span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"persistentvolumeclaims"</span>]</span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"update"</span>]</span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">"storage.k8s.io"</span>]</span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"storageclasses"</span>]</span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"events"</span>]</span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">kind:</span> ClusterRoleBinding</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> run-nfs-client-provisioner</span><br><span class="line"><span class="params">subjects:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">kind:</span> ServiceAccount</span><br><span class="line">    <span class="params">name:</span> nfs-client-provisioner</span><br><span class="line">    <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">roleRef:</span></span><br><span class="line">  <span class="params">kind:</span> ClusterRole</span><br><span class="line">  <span class="params">name:</span> nfs-client-provisioner-runner</span><br><span class="line">  <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">kind:</span> Role</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> leader-locking-nfs-client-provisioner</span><br><span class="line"><span class="params">rules:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">apiGroups:</span> [<span class="string">""</span>]</span><br><span class="line">    <span class="params">resources:</span> [<span class="string">"endpoints"</span>]</span><br><span class="line">    <span class="params">verbs:</span> [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>, <span class="string">"create"</span>, <span class="string">"update"</span>, <span class="string">"patch"</span>]</span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">kind:</span> RoleBinding</span><br><span class="line"><span class="params">apiVersion:</span> rbac.authorization.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> leader-locking-nfs-client-provisioner</span><br><span class="line"><span class="params">subjects:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">kind:</span> ServiceAccount</span><br><span class="line">    <span class="params">name:</span> nfs-client-provisioner</span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="params">namespace:</span> default</span><br><span class="line"><span class="params">roleRef:</span></span><br><span class="line">  <span class="params">kind:</span> Role</span><br><span class="line">  <span class="params">name:</span> leader-locking-nfs-client-provisioner</span><br><span class="line">  <span class="params">apiGroup:</span> rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">kubectl create <span class="operator">-</span>f deploy<span class="symbol">/rbac.yaml</span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io<span class="symbol">/nfs-client-provisioner-runner</span> created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io<span class="symbol">/run-nfs-client-provisioner</span> created</span><br><span class="line">role.rbac.authorization.k8s.io<span class="symbol">/leader-locking-nfs-client-provisioner</span> created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io<span class="symbol">/leader-locking-nfs-client-provisioner</span> created</span><br></pre></td></tr></tbody></table></figure><h5 id="4-æ‰§è¡Œéƒ¨ç½²"><a href="#4-æ‰§è¡Œéƒ¨ç½²" class="headerlink" title="4. æ‰§è¡Œéƒ¨ç½²:"></a>4. æ‰§è¡Œéƒ¨ç½²:</h5><h6 id="æµ‹è¯•åˆ›å»ºPVC"><a href="#æµ‹è¯•åˆ›å»ºPVC" class="headerlink" title="æµ‹è¯•åˆ›å»ºPVC"></a>æµ‹è¯•åˆ›å»ºPVC</h6><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat deploy<span class="symbol">/test-claim.yaml</span></span><br><span class="line"><span class="params">kind:</span> PersistentVolumeClaim</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-claim</span><br><span class="line">  <span class="params">annotations:</span></span><br><span class="line">    volume.beta.kubernetes.io<span class="operator">/</span><span class="params">storage-class:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">accessModes:</span></span><br><span class="line">    <span class="operator">-</span> ReadWriteMany</span><br><span class="line">  <span class="params">resources:</span></span><br><span class="line">    <span class="params">requests:</span></span><br><span class="line">      <span class="params">storage:</span> <span class="number">1</span>Mi</span><br><span class="line"></span><br><span class="line">$ kubectl create <span class="operator">-</span>f deploy<span class="symbol">/test-claim.yaml</span></span><br><span class="line">persistentvolumeclaim<span class="symbol">/test-claim</span> created</span><br><span class="line"></span><br><span class="line">$ kubectl get pv,pvc</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                STORAGECLASS          REASON    AGE</span><br><span class="line">persistentvolume<span class="symbol">/pvc-137f0450-0048-11e9-af7a-00505621dd5b</span>   <span class="number">1</span>Mi        RWX            Delete           Bound     default<span class="symbol">/test-claim</span>   managed-nfs-storage             <span class="number">9</span>m</span><br><span class="line"></span><br><span class="line">NAME                               STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">persistentvolumeclaim<span class="symbol">/test-claim</span>   Bound     pvc-<span class="number">137</span>f0450-<span class="number">004</span>8-<span class="number">11</span>e9-af7a-<span class="number">00505621</span>dd5b   <span class="number">1</span>Mi        RWX            managed-nfs-storage   <span class="number">9</span>m</span><br><span class="line"><span class="comment"># ä»¥ä¸Šå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„pvcå·²ç»ç”³è¯·æˆåŠŸï¼Œç­‰å¾…PODæŒ‚è½½ä½¿ç”¨</span></span><br></pre></td></tr></tbody></table></figure><h6 id="æµ‹è¯•åˆ›å»ºPOD"><a href="#æµ‹è¯•åˆ›å»ºPOD" class="headerlink" title="æµ‹è¯•åˆ›å»ºPOD"></a>æµ‹è¯•åˆ›å»ºPOD</h6><p>PODæ–‡ä»¶å¦‚ä¸‹ï¼Œä½œç”¨å°±æ˜¯åœ¨test-claimçš„PVé‡Œtouchä¸€ä¸ªSUCCESSæ–‡ä»¶ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat deploy<span class="symbol">/test-pod.yaml</span></span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> test-pod</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> test-pod</span><br><span class="line">    <span class="params">image:</span> gcr.io<span class="operator">/</span>google_containers<span class="operator">/</span>busybox:<span class="number">1.24</span></span><br><span class="line">    <span class="params">command:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"/bin/sh"</span></span><br><span class="line">    <span class="params">args:</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"-c"</span></span><br><span class="line">      <span class="operator">-</span> <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> nfs-pvc</span><br><span class="line">        <span class="params">mountPath:</span> <span class="string">"/mnt"</span></span><br><span class="line">  <span class="params">restartPolicy:</span> <span class="string">"Never"</span></span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">name:</span> nfs-pvc</span><br><span class="line">      <span class="params">persistentVolumeClaim:</span></span><br><span class="line">        <span class="params">claimName:</span> test-claim</span><br><span class="line">        </span><br><span class="line">kubectl create <span class="operator">-</span>f deploy<span class="symbol">/test-pod.yaml</span></span><br><span class="line">pod<span class="symbol">/test-pod</span> created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨PODï¼Œä¸€ä¼šå„¿PODå°±æ˜¯completedçŠ¶æ€ï¼Œè¯´æ˜æ‰§è¡Œå®Œæ¯•ã€‚</span></span><br><span class="line">kubectl get pod | grep test-pod</span><br><span class="line">NAME                                      READY     STATUS      RESTARTS   AGE</span><br><span class="line">test-pod                                  <span class="number">0</span><span class="symbol">/1</span>       Completed   <span class="number">0</span>          <span class="number">18</span>s</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h6 id="åœ¨NFSæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ä¸‹çš„å·å­ç›®å½•ä¸­æ£€æŸ¥åˆ›å»ºçš„NFS-PVå·ä¸‹æ˜¯å¦æœ‰â€SUCCESSâ€-æ–‡ä»¶ã€‚"><a href="#åœ¨NFSæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ä¸‹çš„å·å­ç›®å½•ä¸­æ£€æŸ¥åˆ›å»ºçš„NFS-PVå·ä¸‹æ˜¯å¦æœ‰â€SUCCESSâ€-æ–‡ä»¶ã€‚" class="headerlink" title="åœ¨NFSæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ä¸‹çš„å·å­ç›®å½•ä¸­æ£€æŸ¥åˆ›å»ºçš„NFS PVå·ä¸‹æ˜¯å¦æœ‰â€SUCCESSâ€ æ–‡ä»¶ã€‚"></a>åœ¨NFSæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ä¸‹çš„å·å­ç›®å½•ä¸­æ£€æŸ¥åˆ›å»ºçš„NFS PVå·ä¸‹æ˜¯å¦æœ‰â€SUCCESSâ€ æ–‡ä»¶ã€‚</h6><p><img src="/2018/12/15/kubernetes-storage/SUCCESS.png" alt="SUCCESS"><br>ä»¥ä¸Šï¼Œè¯´æ˜æˆ‘ä»¬éƒ¨ç½²æ­£å¸¸ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡åŠ¨æ€åˆ†é…NFSçš„æŒä¹…å…±äº«å·</p><p><strong>å‚è€ƒ</strong><br><a href="https://k8smeetup.github.io/docs/concepts/storage/volumes/">https://k8smeetup.github.io/docs/concepts/storage/volumes/</a><br><a href="https://k8smeetup.github.io/docs/concepts/storage/persistent-volumes/#%E5%9B%9E%E6%94%B6-1">https://k8smeetup.github.io/docs/concepts/storage/persistent-volumes/#å›æ”¶-1</a><br><a href="https://k8smeetup.github.io/docs/tasks/administer-cluster/pvc-protection/#lichuqiang">https://k8smeetup.github.io/docs/tasks/administer-cluster/pvc-protection/#lichuqiang</a><br><a href="https://jimmysong.io/kubernetes-handbook/practice/using-nfs-for-persistent-storage.html">https://jimmysong.io/kubernetes-handbook/practice/using-nfs-for-persistent-storage.html</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·&quot;&gt;&lt;a href=&quot;#åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·&quot; class=&quot;headerlink&quot; title=&quot;åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·&quot;&gt;&lt;/a&gt;åºã€ä¸ºä½•éœ€è¦å­˜å‚¨å·&lt;/h1&gt;&lt;p&gt;å®¹å™¨éƒ¨ç½²è¿‡ç¨‹ä¸­ä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§æ•°æ®:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¯åŠ¨æ—¶éœ€è¦çš„åˆå§‹æ•°æ®ï¼Œå¯ä»¥æ˜¯é…ç½®æ–‡ä»¶&lt;/li&gt;
&lt;li&gt;å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®ï¼Œè¯¥ä¸´æ—¶æ•°æ®éœ€è¦å¤šä¸ªå®¹å™¨é—´å…±äº«&lt;/li&gt;
&lt;li&gt;å¯åŠ¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æŒä¹…åŒ–æ•°æ®&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»¥ä¸Šä¸‰ç§æ•°æ®éƒ½ä¸å¸Œæœ›åœ¨å®¹å™¨é‡å¯æ—¶å°±æ¶ˆå¤±ï¼Œå­˜å‚¨å·ç”±æ­¤è€Œæ¥ï¼Œå®ƒå¯ä»¥æ ¹æ®ä¸åŒåœºæ™¯æä¾›ä¸åŒç±»å‹çš„å­˜å‚¨èƒ½åŠ›ã€‚&lt;br&gt;å„ç±»å·:&lt;/p&gt;
&lt;div style=&quot;width: 50%; margin: auto&quot;&gt;![æˆªå›¾æ¥æºåä¸ºäº‘cceè¯¾å ‚](kubernetes-storage/volume.png)&lt;/div&gt;

&lt;ul&gt;
&lt;li&gt;spec.volumesï¼šé€šè¿‡æ­¤å­—æ®µæä¾›æŒ‡å®šçš„å­˜å‚¨å·&lt;/li&gt;
&lt;li&gt;spec.containers.volumeMountsï¼šé€šè¿‡æ­¤å­—æ®µå°†å­˜å‚¨å·æŒ‚æ¥åˆ°å®¹å™¨ä¸­&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•&quot;&gt;&lt;a href=&quot;#ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•:&quot;&gt;&lt;/a&gt;ä¸€ã€æ™®é€šå­˜å‚¨å·çš„ç”¨æ³•:&lt;/h1&gt;&lt;h2 id=&quot;å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®&quot;&gt;&lt;a href=&quot;#å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®&quot; class=&quot;headerlink&quot; title=&quot;å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®&quot;&gt;&lt;/a&gt;å®¹å™¨å¯åŠ¨æ—¶ä¾èµ–æ•°æ®&lt;/h2&gt;&lt;h3 id=&quot;1-ConfigMap&quot;&gt;&lt;a href=&quot;#1-ConfigMap&quot; class=&quot;headerlink&quot; title=&quot;1. ConfigMap&quot;&gt;&lt;/a&gt;1. ConfigMap&lt;/h3&gt;&lt;p&gt;ä¸Šå›¾ä¹Ÿè¯´äº†å®ƒæ˜¯åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä»¥æ¥çš„æ•°æ®æ¥æº&lt;/p&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/categories/kubernetes/"/>
    
    
    <category term="kubernets" scheme="https://blog.sctux.cc/tags/kubernets/"/>
    
    <category term="æŒä¹…åŒ–å­˜å‚¨" scheme="https://blog.sctux.cc/tags/%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/"/>
    
    <category term="Storage" scheme="https://blog.sctux.cc/tags/Storage/"/>
    
    <category term="NFS PVé™æ€ä¾›ç»™" scheme="https://blog.sctux.cc/tags/NFS-PV%E9%9D%99%E6%80%81%E4%BE%9B%E7%BB%99/"/>
    
    <category term="NFS PVåŠ¨æ€ä¾›ç»™" scheme="https://blog.sctux.cc/tags/NFS-PV%E5%8A%A8%E6%80%81%E4%BE%9B%E7%BB%99/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£kubernetesä¸­çš„æœ‰çŠ¶æ€æœåŠ¡StatefulSet</title>
    <link href="https://blog.sctux.cc/2018/12/14/kubernetes-statefulset/"/>
    <id>https://blog.sctux.cc/2018/12/14/kubernetes-statefulset/</id>
    <published>2018-12-14T07:10:56.000Z</published>
    <updated>2025-09-01T01:59:08.980Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>StatefulSet æ˜¯ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜ï¼ˆå¯¹åº” Deployments å’Œ ReplicaSets æ˜¯ä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡ï¼‰ï¼Œå…¶åº”ç”¨åœºæ™¯åŒ…æ‹¬</p><ul><li>ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå³ Pod é‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäº PVC æ¥å®ç°</li><li>ç¨³å®šçš„ç½‘ç»œæ ‡å¿—ï¼Œå³ Pod é‡æ–°è°ƒåº¦åå…¶ PodName å’Œ HostName ä¸å˜ï¼ŒåŸºäº Headless Serviceï¼ˆå³æ²¡æœ‰ Cluster IP çš„ Serviceï¼‰æ¥å®ç°</li><li>æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼Œå³ Pod æ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‰©å±•çš„æ—¶å€™è¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡ä¾åºè¿›è¡Œï¼ˆå³ä» 0 åˆ° N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ª Pod è¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„ Pod å¿…é¡»éƒ½æ˜¯ Running å’Œ Ready çŠ¶æ€ï¼‰ï¼ŒåŸºäº init containers æ¥å®ç°</li><li>æœ‰åºæ”¶ç¼©ï¼Œæœ‰åºåˆ é™¤ï¼ˆå³ä» N-1 åˆ° 0ï¼‰</li></ul><p>ä»ä¸Šé¢çš„åº”ç”¨åœºæ™¯å¯ä»¥å‘ç°ï¼ŒStatefulSet ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ul><li>ç”¨äºå®šä¹‰ç½‘ç»œæ ‡å¿—ï¼ˆDNS domainï¼‰çš„ Headless Service</li><li>ç”¨äºåˆ›å»º PersistentVolumes çš„ volumeClaimTemplates</li><li>å®šä¹‰å…·ä½“åº”ç”¨çš„ StatefulSet</li></ul><p>StatefulSet ä¸­æ¯ä¸ª Pod çš„ DNS æ ¼å¼ä¸º statefulSetName-{0..N-1}.serviceName.namespace.svc.cluster.localï¼Œå…¶ä¸­</p><ul><li>serviceName ä¸º Headless Service çš„åå­—</li><li>0..N-1 ä¸º Pod æ‰€åœ¨çš„åºå·ï¼Œä» 0 å¼€å§‹åˆ° N-1</li><li>statefulSetName ä¸º StatefulSet çš„åå­—</li><li>namespace ä¸ºæœåŠ¡æ‰€åœ¨çš„ namespaceï¼ŒHeadless Service å’Œ StatefulSet å¿…é¡»åœ¨ç›¸åŒçš„ namespace</li><li>.cluster.local ä¸º Cluster Domain</li></ul><h2 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h2><ul><li>ç»™å®š Pod çš„å­˜å‚¨å¿…é¡»ç”± PersistentVolume Provisioner æ ¹æ®è¯·æ±‚çš„ storage class è¿›è¡Œé…ç½®ï¼Œæˆ–ç”±ç®¡ç†å‘˜é¢„å…ˆé…ç½®ã€‚</li><li>åˆ é™¤æˆ– scale StatefulSet å°†ä¸ä¼šåˆ é™¤ä¸ StatefulSet ç›¸å…³è”çš„ volumeã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œè¿™é€šå¸¸æ¯”è‡ªåŠ¨æ¸…é™¤æ‰€æœ‰ç›¸å…³ StatefulSet èµ„æºæ›´æœ‰ä»·å€¼ã€‚</li><li>StatefulSets ç›®å‰è¦æ±‚ Headless Service è´Ÿè´£ Pod çš„ç½‘ç»œèº«ä»½ã€‚ æ‚¨æœ‰è´£ä»»åˆ›å»ºæ­¤æœåŠ¡ã€‚</li></ul><h1 id="éƒ¨ç½²StatefulsetæœåŠ¡"><a href="#éƒ¨ç½²StatefulsetæœåŠ¡" class="headerlink" title="éƒ¨ç½²StatefulsetæœåŠ¡"></a>éƒ¨ç½²StatefulsetæœåŠ¡</h1><p>é¦–å…ˆæˆ‘ä»¬ä¸‹é¢ä½¿ç”¨çš„æ˜¯ç”¨å‰é¢<a href="https://blog.sctux.com/2018/12/15/kubernetes-storage/#NFS%E4%BD%9C%E4%B8%BA%E5%8A%A8%E6%80%81%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%E5%8D%B7">åšæ–‡</a>ä¸­ä½¿ç”¨åˆ°çš„NFSåšåŠ¨æ€ä¾›ç»™PVCä½œä¸ºæŒä¹…åŒ–å­˜å‚¨ã€‚é‚£ä¹ˆä»–çš„åˆ›å»ºæ­¥éª¤è¿™é‡Œä¸åœ¨èµ˜è¿°ï¼Œæˆ‘ä»¬åœ¨ç¼–æ’yamlæ–‡ä»¶ä¸­ç”³è¯·å³å¯ã€‚</p><h2 id="è·å–åŠ¨æ€å·ä¿¡æ¯"><a href="#è·å–åŠ¨æ€å·ä¿¡æ¯" class="headerlink" title="è·å–åŠ¨æ€å·ä¿¡æ¯"></a>è·å–åŠ¨æ€å·ä¿¡æ¯</h2><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe storageclass managed-nfs-storage</span><br><span class="line"><span class="params">Name:</span>                  managed-nfs-storage</span><br><span class="line"><span class="params">IsDefaultClass:</span>        No</span><br><span class="line"><span class="params">Annotations:</span>           <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">Provisioner:</span>           fuseim.pri<span class="symbol">/ifs</span></span><br><span class="line"><span class="params">Parameters:</span>            archiveOnDelete<span class="operator">=</span><span class="literal">false</span></span><br><span class="line"><span class="params">AllowVolumeExpansion:</span>  <span class="symbol">&lt;unset&gt;</span></span><br><span class="line"><span class="params">MountOptions:</span>          <span class="symbol">&lt;none&gt;</span></span><br><span class="line"><span class="params">ReclaimPolicy:</span>         Delete</span><br><span class="line"><span class="params">VolumeBindingMode:</span>     Immediate</span><br><span class="line"><span class="params">Events:</span>                <span class="symbol">&lt;none&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="ç¼–å†™service"><a href="#ç¼–å†™service" class="headerlink" title="ç¼–å†™service"></a>ç¼–å†™service</h2><p>ä¸€ä¸ªåä¸º nginx çš„ headless serviceï¼Œç”¨äºæ§åˆ¶ç½‘ç»œåŸŸã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> statefulset_service.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nginx</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">app:</span> nginx</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">ports:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="params">name:</span> web</span><br><span class="line">  <span class="params">clusterIP:</span> None</span><br><span class="line">  <span class="params">selector:</span></span><br><span class="line">    <span class="params">app:</span> nginx</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œåˆ›å»º</span></span><br><span class="line">$ kubectl create <span class="operator">-</span>f statefulset_service.yaml</span><br><span class="line">service<span class="symbol">/nginx</span> created</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="ç¼–å†™statefulset-yaml"><a href="#ç¼–å†™statefulset-yaml" class="headerlink" title="ç¼–å†™statefulset yaml"></a>ç¼–å†™statefulset yaml</h2><ul><li>ä¸€ä¸ªåä¸º web çš„ StatefulSetï¼Œå®ƒçš„ Spec ä¸­æŒ‡å®šåœ¨æœ‰ 2 ä¸ªè¿è¡Œ nginx å®¹å™¨çš„ Podã€‚</li><li><code>volumeClaimTemplates</code> ä½¿ç”¨ PersistentVolume Provisioner æä¾›çš„ <code>PersistentVolumes</code> ä½œä¸ºç¨³å®šå­˜å‚¨ã€‚</li></ul><p>volumeClaimTemplates: è¡¨ç¤ºä¸€ç±»PVCçš„æ¨¡æ¿ï¼Œç³»ç»Ÿä¼šæ ¹æ®Statefulseté…ç½®çš„replicasæ•°é‡ï¼Œåˆ›å»ºç›¸åº”æ•°é‡çš„PVCã€‚è¿™äº›PVCé™¤äº†åå­—ä¸ä¸€æ ·ä¹‹å¤–å…¶ä»–é…ç½®éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p>ä¸‹é¢storageClassNameé…ç½®ä¸ºæˆ‘ä¹‹å‰é€šè¿‡NFSåˆ›å»ºçš„ã€‚</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="operator">&gt;</span><span class="operator">&gt;</span> statefulset.yaml <span class="operator">&lt;</span><span class="operator">&lt;</span> EOF</span><br><span class="line"><span class="params">apiVersion:</span> apps<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> StatefulSet</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> web</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">serviceName:</span> <span class="string">"nginx"</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">        <span class="params">app:</span> nginx</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> nginx</span><br><span class="line">        <span class="params">image:</span> nginx</span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="params">name:</span> web</span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> www-disk</span><br><span class="line">          <span class="params">mountPath:</span> <span class="symbol">/usr/share/nginx/html</span></span><br><span class="line">  <span class="params">volumeClaimTemplates:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">metadata:</span></span><br><span class="line">      <span class="params">name:</span> www-disk</span><br><span class="line">      <span class="params">annotations:</span></span><br><span class="line">        volume.beta.kubernetes.io<span class="operator">/</span><span class="params">storage-class:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">accessModes:</span> [ <span class="string">"ReadWriteOnce"</span> ]</span><br><span class="line">      <span class="params">storageClassName:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line">      <span class="params">resources:</span></span><br><span class="line">        <span class="params">requests:</span></span><br><span class="line">          <span class="params">storage:</span> <span class="number">1</span>Gi</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><h2 id="éªŒè¯æœåŠ¡ä¼¸ç¼©æ€§"><a href="#éªŒè¯æœåŠ¡ä¼¸ç¼©æ€§" class="headerlink" title="éªŒè¯æœåŠ¡ä¼¸ç¼©æ€§"></a>éªŒè¯æœåŠ¡ä¼¸ç¼©æ€§</h2><h3 id="åˆ›å»ºStatefulsetæœåŠ¡ï¼š"><a href="#åˆ›å»ºStatefulsetæœåŠ¡ï¼š" class="headerlink" title="åˆ›å»ºStatefulsetæœåŠ¡ï¼š"></a>åˆ›å»ºStatefulsetæœåŠ¡ï¼š</h3><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># æ‰§è¡Œåˆ›å»º</span><br><span class="line">$ kubectl create -f statefulset.yaml</span><br><span class="line">statefulset.apps/web created</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner<span class="string">-6</span>c6997c674-z7m9r   1/1       Running   0          18m</span><br><span class="line">pod/web<span class="string">-0</span>                                     1/1       Running   0          13m</span><br><span class="line">pod/web<span class="string">-1</span>                                     1/1       Running   0          12m</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME                                   STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-0</span>   Bound     pvc-a440540e<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   13m</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-1</span>   Bound     pvc-af5c7006<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   12m</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="æ‰©å®¹æœåŠ¡åˆ°3ä¸ªPodï¼Œæ˜¾ç¤ºä¼šåˆ›å»ºæ–°çš„äº‘ç›˜å·ï¼š"><a href="#æ‰©å®¹æœåŠ¡åˆ°3ä¸ªPodï¼Œæ˜¾ç¤ºä¼šåˆ›å»ºæ–°çš„äº‘ç›˜å·ï¼š" class="headerlink" title="æ‰©å®¹æœåŠ¡åˆ°3ä¸ªPodï¼Œæ˜¾ç¤ºä¼šåˆ›å»ºæ–°çš„äº‘ç›˜å·ï¼š"></a>æ‰©å®¹æœåŠ¡åˆ°3ä¸ªPodï¼Œæ˜¾ç¤ºä¼šåˆ›å»ºæ–°çš„äº‘ç›˜å·ï¼š</h3><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale sts web --replicas=3</span><br><span class="line">statefulset.apps/web scaled</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner<span class="string">-6</span>c6997c674-z7m9r   1/1       Running   0          19m</span><br><span class="line">web<span class="string">-0</span>                                     1/1       Running   0          14m</span><br><span class="line">web<span class="string">-1</span>                                     1/1       Running   0          14m</span><br><span class="line">web<span class="string">-2</span>                                     1/1       Running   0          40s</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME             STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">www-disk-web<span class="string">-0</span>   Bound     pvc-a440540e<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   14m</span><br><span class="line">www-disk-web<span class="string">-1</span>   Bound     pvc-af5c7006<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   14m</span><br><span class="line">www-disk-web<span class="string">-2</span>   Bound     pvc<span class="string">-97</span>afce59<span class="string">-01</span>df<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   38s</span><br></pre></td></tr></tbody></table></figure><h3 id="ç¼©å®¹æœåŠ¡åˆ°1ä¸ªPodï¼Œæ˜¾ç¤ºpvc-pvå¹¶ä¸ä¼šä¸€åŒåˆ é™¤ï¼š"><a href="#ç¼©å®¹æœåŠ¡åˆ°1ä¸ªPodï¼Œæ˜¾ç¤ºpvc-pvå¹¶ä¸ä¼šä¸€åŒåˆ é™¤ï¼š" class="headerlink" title="ç¼©å®¹æœåŠ¡åˆ°1ä¸ªPodï¼Œæ˜¾ç¤ºpvc/pvå¹¶ä¸ä¼šä¸€åŒåˆ é™¤ï¼š"></a>ç¼©å®¹æœåŠ¡åˆ°1ä¸ªPodï¼Œæ˜¾ç¤ºpvc/pvå¹¶ä¸ä¼šä¸€åŒåˆ é™¤ï¼š</h3><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale sts web --replicas=1</span><br><span class="line">statefulset.apps/web scaled</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner<span class="string">-6</span>c6997c674-z7m9r   1/1       Running   0          21m</span><br><span class="line">web<span class="string">-0</span>                                     1/1       Running   0          16m</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME             STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">www-disk-web<span class="string">-0</span>   Bound     pvc-a440540e<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   16m</span><br><span class="line">www-disk-web<span class="string">-1</span>   Bound     pvc-af5c7006<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   16m</span><br><span class="line">www-disk-web<span class="string">-2</span>   Bound     pvc<span class="string">-97</span>afce59<span class="string">-01</span>df<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   2m</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="å†æ¬¡æ‰©å®¹åˆ°3ä¸ªPodï¼Œæ–°çš„podä¼šå¤ç”¨åŸæ¥çš„PVC-PVï¼š"><a href="#å†æ¬¡æ‰©å®¹åˆ°3ä¸ªPodï¼Œæ–°çš„podä¼šå¤ç”¨åŸæ¥çš„PVC-PVï¼š" class="headerlink" title="å†æ¬¡æ‰©å®¹åˆ°3ä¸ªPodï¼Œæ–°çš„podä¼šå¤ç”¨åŸæ¥çš„PVC/PVï¼š"></a>å†æ¬¡æ‰©å®¹åˆ°3ä¸ªPodï¼Œæ–°çš„podä¼šå¤ç”¨åŸæ¥çš„PVC/PVï¼š</h3><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale sts web --replicas=3</span><br><span class="line">statefulset.apps/web scaled</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner<span class="string">-6</span>c6997c674-z7m9r   1/1       Running   1          46m</span><br><span class="line">pod/web<span class="string">-0</span>                                     1/1       Running   0          3m</span><br><span class="line">pod/web<span class="string">-1</span>                                     1/1       Running   0          1m</span><br><span class="line">pod/web<span class="string">-2</span>                                     1/1       Running   0          18s</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME                                   STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-0</span>   Bound     pvc-a440540e<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   41m</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-1</span>   Bound     pvc-af5c7006<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   40m</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-2</span>   Bound     pvc<span class="string">-97</span>afce59<span class="string">-01</span>df<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   27m</span><br></pre></td></tr></tbody></table></figure><h3 id="åˆ é™¤ä¸€ä¸ªpod-web0å‰ï¼ŒPodå¼•ç”¨PVCï¼šwww-disk-web-0"><a href="#åˆ é™¤ä¸€ä¸ªpod-web0å‰ï¼ŒPodå¼•ç”¨PVCï¼šwww-disk-web-0" class="headerlink" title="åˆ é™¤ä¸€ä¸ªpod/web0å‰ï¼ŒPodå¼•ç”¨PVCï¼šwww-disk-web-0"></a>åˆ é™¤ä¸€ä¸ªpod/web0å‰ï¼ŒPodå¼•ç”¨PVCï¼šwww-disk-web-0</h3><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">kubectl</span> describe pod/web-<span class="number">0</span> | grep ClaimName</span><br><span class="line">    <span class="attribute">ClaimName</span>:  www-disk-web-<span class="number">0</span></span><br></pre></td></tr></tbody></table></figure><h3 id="åˆ é™¤Podåï¼Œé‡æ–°åˆ›å»ºçš„Podåå­—ä¸åˆ é™¤çš„ä¸€è‡´ï¼Œä¸”ä½¿ç”¨åŒä¸€ä¸ªPVCï¼š"><a href="#åˆ é™¤Podåï¼Œé‡æ–°åˆ›å»ºçš„Podåå­—ä¸åˆ é™¤çš„ä¸€è‡´ï¼Œä¸”ä½¿ç”¨åŒä¸€ä¸ªPVCï¼š" class="headerlink" title="åˆ é™¤Podåï¼Œé‡æ–°åˆ›å»ºçš„Podåå­—ä¸åˆ é™¤çš„ä¸€è‡´ï¼Œä¸”ä½¿ç”¨åŒä¸€ä¸ªPVCï¼š"></a>åˆ é™¤Podåï¼Œé‡æ–°åˆ›å»ºçš„Podåå­—ä¸åˆ é™¤çš„ä¸€è‡´ï¼Œä¸”ä½¿ç”¨åŒä¸€ä¸ªPVCï¼š</h3><figure class="highlight subunit"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod/web<span class="string">-0</span></span><br><span class="line">pod "web<span class="string">-0</span>" deleted</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner<span class="string">-6</span>c6997c674-z7m9r   1/1       Running   1          49m</span><br><span class="line">pod/web<span class="string">-0</span>                                     1/1       Running   0          10s</span><br><span class="line">pod/web<span class="string">-1</span>                                     1/1       Running   0          4m</span><br><span class="line">pod/web<span class="string">-2</span>                                     1/1       Running   0          3m</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod/web<span class="string">-0</span> | grep ClaimName</span><br><span class="line">    ClaimName:  www-disk-web<span class="string">-0</span></span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">NAME                                   STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-0</span>   Bound     pvc-a440540e<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   44m</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-1</span>   Bound     pvc-af5c7006<span class="string">-01</span>dd<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   43m</span><br><span class="line">persistentvolumeclaim/www-disk-web<span class="string">-2</span>   Bound     pvc<span class="string">-97</span>afce59<span class="string">-01</span>df<span class="string">-11</span>e9-b006<span class="string">-00505621</span>dd5b   1Gi        RWO            managed-nfs-storage   30m</span><br></pre></td></tr></tbody></table></figure><h2 id="éªŒè¯æœåŠ¡é«˜å¯ç”¨æ€§"><a href="#éªŒè¯æœåŠ¡é«˜å¯ç”¨æ€§" class="headerlink" title="éªŒè¯æœåŠ¡é«˜å¯ç”¨æ€§"></a>éªŒè¯æœåŠ¡é«˜å¯ç”¨æ€§</h2><h3 id="å…±äº«æŒä¹…å·ä¸­æ–°å»ºæ–‡ä»¶"><a href="#å…±äº«æŒä¹…å·ä¸­æ–°å»ºæ–‡ä»¶" class="headerlink" title="å…±äº«æŒä¹…å·ä¸­æ–°å»ºæ–‡ä»¶"></a>å…±äº«æŒä¹…å·ä¸­æ–°å»ºæ–‡ä»¶</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> web-1 <span class="built_in">ls</span> /usr/share/nginx/html</span></span><br><span class="line">statefulset</span><br></pre></td></tr></tbody></table></figure><h3 id="åˆ é™¤Podï¼ŒéªŒè¯æ•°æ®æŒä¹…æ€§ï¼š"><a href="#åˆ é™¤Podï¼ŒéªŒè¯æ•°æ®æŒä¹…æ€§ï¼š" class="headerlink" title="åˆ é™¤Podï¼ŒéªŒè¯æ•°æ®æŒä¹…æ€§ï¼š"></a>åˆ é™¤Podï¼ŒéªŒè¯æ•°æ®æŒä¹…æ€§ï¼š</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete pod web-1</span></span><br><span class="line">pod "web-1" deleted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¾…æ–°çš„podåˆ›å»ºä¹‹åå†æ¬¡æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿˜åœ¨</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> web-1 <span class="built_in">ls</span> /usr/share/nginx/html</span></span><br><span class="line">statefulset</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»¥ä¸Šè¯´æ˜åˆ é™¤podå¯¹pvcæ²¡æœ‰ä»»ä½•çš„å½±å“ï¼Œæˆ‘ä»¬çš„æ•°æ®è¿˜æ˜¯ä¿å­˜ç€çš„ã€‚</span></span><br></pre></td></tr></tbody></table></figure><h3 id="æ•°æ®ä¿å­˜"><a href="#æ•°æ®ä¿å­˜" class="headerlink" title="æ•°æ®ä¿å­˜:"></a>æ•°æ®ä¿å­˜:</h3><p>ä¸Šé¢ä¹Ÿè¯´å•¦, åˆ é™¤æˆ– scale StatefulSet å°†ä¸ä¼šåˆ é™¤ä¸ StatefulSet ç›¸å…³è”çš„ volumeã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œè¿™é€šå¸¸æ¯”è‡ªåŠ¨æ¸…é™¤æ‰€æœ‰ç›¸å…³ StatefulSet èµ„æºæ›´æœ‰ä»·å€¼ã€‚</p><p>æ‰€ä»¥æˆ‘åˆ°NFS Serverä¸Šé¢checkä¸€ä¸‹:<br><img src="/2018/12/14/kubernetes-statefulset/nfs.png"></p><p>å¯è§ æˆ‘ä»¬åœ¨pod/web-1ä¸Šåˆ›å»ºçš„æ–‡ä»¶è¿˜æ˜¯ä¿å­˜ç€çš„ã€‚</p><h3 id="é™„"><a href="#é™„" class="headerlink" title="é™„:"></a>é™„:</h3><p>è¯¥yamlä¸ºåä¸ºäº‘é‚£è¾¹çš„PVç”³è¯·ï¼Œä»¥åŠStatefulSetåº”ç”¨çš„åˆ›å»º</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># PVCå­˜å‚¨ç”³è¯·</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-evs-auto-example</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">volume.beta.kubernetes.io/storage-class:</span> <span class="string">sata</span></span><br><span class="line">    <span class="attr">volume.beta.kubernetes.io/storage-provisioner:</span> <span class="string">flexvolume-huawei.com/fuxivol</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">failure-domain.beta.kubernetes.io/region:</span> <span class="string">cn-north-1</span></span><br><span class="line">    <span class="attr">failure-domain.beta.kubernetes.io/zone:</span> <span class="string">cn-north-1a</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># StatefulSetåº”ç”¨åˆ›å»º</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cce21days-app11-guomaoqiu</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">cce21days-app11-guomaoqiu</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span>  </span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">cce21days-app11-guomaoqiu</span></span><br><span class="line">      <span class="attr">failure-domain.beta.kubernetes.io/region:</span> <span class="string">cn-north-1</span></span><br><span class="line">      <span class="attr">failure-domain.beta.kubernetes.io/zone:</span> <span class="string">cn-north-1a</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">cce21days-app11-guomaoqiu</span></span><br><span class="line">        <span class="attr">failure-domain.beta.kubernetes.io/region:</span> <span class="string">cn-north-1</span></span><br><span class="line">        <span class="attr">failure-domain.beta.kubernetes.io/zone:</span> <span class="string">cn-north-1a</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> {}</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="number">100.125</span><span class="number">.0</span><span class="number">.198</span><span class="string">:20202/guomaoqiu/tank:1.0.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">container-0</span></span><br><span class="line">        <span class="attr">resources:</span> {}</span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">pvc-evs-example</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> {}</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pvc-evs-example</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">pvc-evs-auto-example</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h1&gt;&lt;h2 id=&quot;æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚å¿µ&quot;&gt;&lt;/a&gt;æ¦‚å¿µ&lt;/h2&gt;&lt;p&gt;StatefulSet æ˜¯ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜ï¼ˆå¯¹åº” Deployments å’Œ ReplicaSets æ˜¯ä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡ï¼‰ï¼Œå…¶åº”ç”¨åœºæ™¯åŒ…æ‹¬&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå³ Pod é‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼ŒåŸºäº PVC æ¥å®ç°&lt;/li&gt;
&lt;li&gt;ç¨³å®šçš„ç½‘ç»œæ ‡å¿—ï¼Œå³ Pod é‡æ–°è°ƒåº¦åå…¶ PodName å’Œ HostName ä¸å˜ï¼ŒåŸºäº Headless Serviceï¼ˆå³æ²¡æœ‰ Cluster IP çš„ Serviceï¼‰æ¥å®ç°&lt;/li&gt;
&lt;li&gt;æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼Œå³ Pod æ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‰©å±•çš„æ—¶å€™è¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡ä¾åºè¿›è¡Œï¼ˆå³ä» 0 åˆ° N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ª Pod è¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„ Pod å¿…é¡»éƒ½æ˜¯ Running å’Œ Ready çŠ¶æ€ï¼‰ï¼ŒåŸºäº init containers æ¥å®ç°&lt;/li&gt;
&lt;li&gt;æœ‰åºæ”¶ç¼©ï¼Œæœ‰åºåˆ é™¤ï¼ˆå³ä» N-1 åˆ° 0ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»ä¸Šé¢çš„åº”ç”¨åœºæ™¯å¯ä»¥å‘ç°ï¼ŒStatefulSet ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç”¨äºå®šä¹‰ç½‘ç»œæ ‡å¿—ï¼ˆDNS domainï¼‰çš„ Headless Service&lt;/li&gt;
&lt;li&gt;ç”¨äºåˆ›å»º PersistentVolumes çš„ volumeClaimTemplates&lt;/li&gt;
&lt;li&gt;å®šä¹‰å…·ä½“åº”ç”¨çš„ StatefulSet&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;StatefulSet ä¸­æ¯ä¸ª Pod çš„ DNS æ ¼å¼ä¸º statefulSetName-{0..N-1}.serviceName.namespace.svc.cluster.localï¼Œå…¶ä¸­&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;serviceName ä¸º Headless Service çš„åå­—&lt;/li&gt;
&lt;li&gt;0..N-1 ä¸º Pod æ‰€åœ¨çš„åºå·ï¼Œä» 0 å¼€å§‹åˆ° N-1&lt;/li&gt;
&lt;li&gt;statefulSetName ä¸º StatefulSet çš„åå­—&lt;/li&gt;
&lt;li&gt;namespace ä¸ºæœåŠ¡æ‰€åœ¨çš„ namespaceï¼ŒHeadless Service å’Œ StatefulSet å¿…é¡»åœ¨ç›¸åŒçš„ namespace&lt;/li&gt;
&lt;li&gt;.cluster.local ä¸º Cluster Domain&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;é™åˆ¶&quot;&gt;&lt;a href=&quot;#é™åˆ¶&quot; class=&quot;headerlink&quot; title=&quot;é™åˆ¶&quot;&gt;&lt;/a&gt;é™åˆ¶&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;ç»™å®š Pod çš„å­˜å‚¨å¿…é¡»ç”± PersistentVolume Provisioner æ ¹æ®è¯·æ±‚çš„ storage class è¿›è¡Œé…ç½®ï¼Œæˆ–ç”±ç®¡ç†å‘˜é¢„å…ˆé…ç½®ã€‚&lt;/li&gt;
&lt;li&gt;åˆ é™¤æˆ– scale StatefulSet å°†ä¸ä¼šåˆ é™¤ä¸ StatefulSet ç›¸å…³è”çš„ volumeã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œè¿™é€šå¸¸æ¯”è‡ªåŠ¨æ¸…é™¤æ‰€æœ‰ç›¸å…³ StatefulSet èµ„æºæ›´æœ‰ä»·å€¼ã€‚&lt;/li&gt;
&lt;li&gt;StatefulSets ç›®å‰è¦æ±‚ Headless Service è´Ÿè´£ Pod çš„ç½‘ç»œèº«ä»½ã€‚ æ‚¨æœ‰è´£ä»»åˆ›å»ºæ­¤æœåŠ¡ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/categories/kubernetes/"/>
    
    
    <category term="StatefulSet" scheme="https://blog.sctux.cc/tags/StatefulSet/"/>
    
    <category term="æœ‰çŠ¶æ€" scheme="https://blog.sctux.cc/tags/%E6%9C%89%E7%8A%B6%E6%80%81/"/>
    
    <category term="æŒä¹…åŒ–å­˜å‚¨" scheme="https://blog.sctux.cc/tags/%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/"/>
    
  </entry>
  
  <entry>
    <title>ç®¡ç†Kubernetesæ—¥å¿—</title>
    <link href="https://blog.sctux.cc/2018/12/13/kubernetes-logs/"/>
    <id>https://blog.sctux.cc/2018/12/13/kubernetes-logs/</id>
    <published>2018-12-13T12:47:40.000Z</published>
    <updated>2025-09-01T01:59:08.984Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>æ—¥å¿—æ˜¯æˆ‘ä»¬åœ¨è¿ç»´éƒ¨ç½²å½“ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªä¸œè¥¿ï¼Œå¯¹äºæˆ‘ä¸ªäººå·¥ä½œç»éªŒè€Œè¨€ï¼Œä¸€èˆ¬å‡ºç°é—®é¢˜ï¼Œç¬¬ä¸€æ­¥äº‹æƒ…å°±æ˜¯æŸ¥çœ‹æ—¥å¿—ï¼Œå…¶æ¬¡æ˜¯æœåŠ¡å™¨èµ„æºæŸ¥çœ‹è¿™æ ·å»å®šä½é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨kubernetsé›†ç¾¤å½“ä¸­å‘¢ï¼Œæˆ‘ä¸»è¦ç»™å…¶åˆ†äº†ä¸¤ç§ç±»å‹:</p><ul><li>kubernetesç»„ä»¶æ—¥å¿—</li><li>è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—</li></ul><h2 id="kubernetesç»„ä»¶æ—¥å¿—"><a href="#kubernetesç»„ä»¶æ—¥å¿—" class="headerlink" title="kubernetesç»„ä»¶æ—¥å¿—"></a>kubernetesç»„ä»¶æ—¥å¿—</h2><p>æˆ‘ä»¬çŸ¥é“åœ¨kubernetesé›†ç¾¤æ˜¯æœ‰å¤šä¸ªç»„ä»¶ç»„æˆï¼ŒååŒä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªè¿è¡Œå®¹å™¨çš„ç¯å¢ƒã€‚å½“è¿è¡Œå½“ä¸­å‡ºç°é—®é¢˜ï¼Œä¹Ÿæ˜¯éœ€è¦æŸ¥çœ‹å¯¹åº”ç»„ä»¶çš„æ—¥å¿—ï¼Œè¿›è¡Œé—®é¢˜æ’æŸ¥ã€å¤„ç†ã€‚é‚£ä¹ˆå¸¸è§çš„æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight arcade"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/kube-apiserver.<span class="built_in">log</span></span><br><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/kube-proxy.<span class="built_in">log</span></span><br><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/kube-controller-manager.<span class="built_in">log</span></span><br><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/kube-scheduler.<span class="built_in">log</span></span><br><span class="line">/<span class="keyword">var</span>/<span class="built_in">log</span>/kubelet.<span class="built_in">log</span></span><br></pre></td></tr></tbody></table></figure><p>å½“ç„¶æ ¹æ®æ­å»ºé›†ç¾¤çš„æ–¹å¼ä¸åŒï¼Œæˆ‘ä»¬é…ç½®çš„æ—¥å¿—ç›®å½•ä¹Ÿä¸å°½ç›¸åŒï¼Œæ‰€ä»¥åªæ˜¯åˆ—ä¸¾ä¸€ä¸‹ï¼›<br>å¦‚æœç»„ä»¶çš„å®‰è£…æ–¹å¼ç”±systemdæ¥ç®¡ç†çš„è¯ æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ’é”™</p><figure class="highlight fortran"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">journalctl -u kubelet</span><br><span class="line">æˆ–</span><br><span class="line">systemctl <span class="keyword">status</span> kubelet -l</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœä½¿ç”¨çš„æ˜¯kuernetesæ’ä»¶å¼æ–¹å¼éƒ¨ç½²çš„ç»„ä»¶åˆ™ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -f <span class="tag">&lt;<span class="name">ç»„ä»¶åç§°</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—"><a href="#è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—" class="headerlink" title="è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—"></a>è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—</h2><p>è¿è¡Œäºkubernetesä¸Šçš„ï¼Œæ¯”å¦‚ä¸€ä¸ªnginxå®¹å™¨ï¼›æˆ‘ä»¬å¦‚ä½•æŸ¥çœ‹è¿™ä¸ªåº”ç”¨çš„æ—¥å¿—å‘¢ï¼Ÿ</p><h3 id="ä»å®¹å™¨æ ‡å‡†è¾“å‡ºæˆªè·"><a href="#ä»å®¹å™¨æ ‡å‡†è¾“å‡ºæˆªè·" class="headerlink" title="ä»å®¹å™¨æ ‡å‡†è¾“å‡ºæˆªè·"></a>ä»å®¹å™¨æ ‡å‡†è¾“å‡ºæˆªè·</h3><p>ç”¨æ³•ç±»ä¼¼äºdocker</p><figure class="highlight dust"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">kubectl logs -f </span><span class="template-variable">{POD_NAME}</span><span class="language-xml"> -c </span><span class="template-variable">{Container_NAME}</span></span><br></pre></td></tr></tbody></table></figure><h3 id="è¿›å…¥å®¹å™¨è¿›è¡ŒæŸ¥çœ‹"><a href="#è¿›å…¥å®¹å™¨è¿›è¡ŒæŸ¥çœ‹" class="headerlink" title="è¿›å…¥å®¹å™¨è¿›è¡ŒæŸ¥çœ‹"></a>è¿›å…¥å®¹å™¨è¿›è¡ŒæŸ¥çœ‹</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it {POD_NAME} -c {Container_NAME} /bin/sh</span><br><span class="line">docker <span class="built_in">exec</span> -it {Container_NAME} /bin/sh</span><br></pre></td></tr></tbody></table></figure><h3 id="å°†æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°ä¸»æœºç›®å½•"><a href="#å°†æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°ä¸»æœºç›®å½•" class="headerlink" title="å°†æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°ä¸»æœºç›®å½•"></a>å°†æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°ä¸»æœºç›®å½•</h3><p>æ¯”å¦‚æˆ‘è¦æŠŠnginxçš„æ—¥å¿—æŒ‚è½½åˆ°è¿è¡Œäºè¯¥PODçš„å®¿ä¸»æœºçš„æŸä¸ªç›®å½•</p><figure class="highlight nix"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–å†™yamlæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># è¿™é‡Œæˆ‘ä»¬çŸ¥é“æ‰‹å†™ä¸€ä¸ªyamlæ˜¯å¾ˆçƒ¦çš„ï¼Œè€Œä¸”é‚£ä¹ˆå¤šå…³é”®è¯ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“è®°ä½ï¼Œ</span></span><br><span class="line"><span class="comment"># é‚£ä¹ˆæ­¤æ—¶å°±éœ€è¦åœ¨ç°æœ‰ç¯å¢ƒä¸­æ‰¾ä¸€ä¸ªpodç„¶åæŠŠä»–çš„yamlå¯¼å‡ºå†åšä¿®æ”¹</span></span><br><span class="line"><span class="comment"># å¦‚æœç¯å¢ƒä¸­è¿˜æ˜¯æ²¡æœ‰podï¼Œé‚£å°±ç›´æ¥runä¸€ä¸ª</span></span><br><span class="line"></span><br><span class="line">$ kubectl get pod nginx-<span class="number">67</span>ccc95d8c-fd5nk <span class="operator">-</span>o yaml <span class="operator">-</span>-export <span class="operator">&gt;</span> nginx.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ä¸€äº›ä¸å¿…è¦çš„å­—æ®µ</span></span><br><span class="line">$ vim nginx.yaml </span><br><span class="line"></span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Pod</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> nginx</span><br><span class="line">  <span class="params">labels:</span></span><br><span class="line">    <span class="params">run:</span> nginx</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">containers:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">image:</span> nginx:latest</span><br><span class="line">    <span class="params">imagePullPolicy:</span> IfNotPresent</span><br><span class="line">    <span class="params">name:</span> nginx</span><br><span class="line">    <span class="params">volumeMounts:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/var/log/nginx</span>  <span class="comment"># nginxåº”ç”¨é»˜è®¤æ—¥å¿—ç›®å½•</span></span><br><span class="line">      <span class="params">name:</span> nginx-log-volume     </span><br><span class="line">  <span class="params">volumes:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> nginx-log-volume</span><br><span class="line">    <span class="params">hostPath:</span></span><br><span class="line">      <span class="params">path:</span> <span class="symbol">/var/k8s/log</span>         <span class="comment"># å®¿ä¸»æœºç›®å½•</span></span><br><span class="line">      </span><br><span class="line">$ kubectl create <span class="operator">-</span>f nginx.yaml</span><br><span class="line">pod <span class="string">"nginx"</span> created</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å®¿ä¸»æœºï¼Œè¿™æ ·å®¹å™¨çš„æ—¥å¿—ç›®å½•æˆ‘å°±æŒ‚åˆ°äº†å®¿ä¸»</span></span><br><span class="line"><span class="comment"># è€Œä¸ç”¨åœ¨è¿›å…¥å®¹å™¨ä¸­æŸ¥çœ‹äº†</span></span><br><span class="line">$ ll <span class="operator">/</span>var<span class="operator">/</span>k8s<span class="operator">/</span>log<span class="symbol">/</span> </span><br><span class="line">total <span class="number">0</span></span><br><span class="line"><span class="operator">-</span>rw-r----- <span class="number">1</span> root root <span class="number">0</span> Dec <span class="number">18</span> <span class="number">15</span>:<span class="number">17</span> access.log</span><br><span class="line"><span class="operator">-</span>rw-r----- <span class="number">1</span> root root <span class="number">0</span> Dec <span class="number">18</span> <span class="number">15</span>:<span class="number">17</span> error.log</span><br></pre></td></tr></tbody></table></figure><p>æ³¨æ„ç‚¹: å†™yamlçš„æ—¶å€™ä¸€å®šè¦å…»æˆå¯¼å‡ºç°æœ‰èµ„æºç±»å‹çš„yamlçš„ä¹ æƒ¯å†å»ä¿®æ”¹ï¼›è¿™æ ·èƒ½é¿å…æ‰‹åŠ¨ç¼–å†™æ—¶æ ¼å¼çš„ä¸€äº›é—®é¢˜ï¼Œå¦‚æœå…³é”®å­—è®°ä¸ä½é‚£å°±ä¸€å®šè¦ç”¨<code>kubectl explain</code>è·å–èµ„æºæ–‡æ¡£</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;æ—¥å¿—æ˜¯æˆ‘ä»¬åœ¨è¿ç»´éƒ¨ç½²å½“ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªä¸œè¥¿ï¼Œå¯¹äºæˆ‘ä¸ªäººå·¥ä½œç»éªŒè€Œè¨€ï¼Œä¸€èˆ¬å‡ºç°é—®é¢˜ï¼Œç¬¬ä¸€æ­¥äº‹æƒ…å°±æ˜¯æŸ¥çœ‹æ—¥å¿—ï¼Œå…¶æ¬¡æ˜¯æœåŠ¡å™¨èµ„æºæŸ¥çœ‹è¿™æ ·å»å®šä½é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨kubernetsé›†ç¾¤å½“ä¸­å‘¢ï¼Œæˆ‘ä¸»è¦ç»™å…¶åˆ†äº†ä¸¤ç§ç±»å‹:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;kubernetesç»„ä»¶æ—¥å¿—&lt;/li&gt;
&lt;li&gt;è¿è¡Œäºkubernetesä¸Šçš„å®¹å™¨åº”ç”¨æ—¥å¿—&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;kubernetesç»„ä»¶æ—¥å¿—&quot;&gt;&lt;a href=&quot;#kubernetesç»„ä»¶æ—¥å¿—&quot; class=&quot;headerlink&quot; title=&quot;kubernetesç»„ä»¶æ—¥å¿—&quot;&gt;&lt;/a&gt;kubernetesç»„ä»¶æ—¥å¿—&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬çŸ¥é“åœ¨kubernetesé›†ç¾¤æ˜¯æœ‰å¤šä¸ªç»„ä»¶ç»„æˆï¼ŒååŒä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªè¿è¡Œå®¹å™¨çš„ç¯å¢ƒã€‚å½“è¿è¡Œå½“ä¸­å‡ºç°é—®é¢˜ï¼Œä¹Ÿæ˜¯éœ€è¦æŸ¥çœ‹å¯¹åº”ç»„ä»¶çš„æ—¥å¿—ï¼Œè¿›è¡Œé—®é¢˜æ’æŸ¥ã€å¤„ç†ã€‚é‚£ä¹ˆå¸¸è§çš„æ—¥å¿—å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight arcade&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;/kube-apiserver.&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;/kube-proxy.&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;/kube-controller-manager.&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;/kube-scheduler.&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;/kubelet.&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å½“ç„¶æ ¹æ®æ­å»ºé›†ç¾¤çš„æ–¹å¼ä¸åŒï¼Œæˆ‘ä»¬é…ç½®çš„æ—¥å¿—ç›®å½•ä¹Ÿä¸å°½ç›¸åŒï¼Œæ‰€ä»¥åªæ˜¯åˆ—ä¸¾ä¸€ä¸‹ï¼›&lt;br&gt;å¦‚æœç»„ä»¶çš„å®‰è£…æ–¹å¼ç”±systemdæ¥ç®¡ç†çš„è¯ æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ’é”™&lt;/p&gt;
&lt;figure class=&quot;highlight fortran&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;journalctl -u kubelet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;æˆ–&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl &lt;span class=&quot;keyword&quot;&gt;status&lt;/span&gt; kubelet -l&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;å¦‚æœä½¿ç”¨çš„æ˜¯kuernetesæ’ä»¶å¼æ–¹å¼éƒ¨ç½²çš„ç»„ä»¶åˆ™ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;kubectl logs -f &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;ç»„ä»¶åç§°&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.sctux.cc/tags/kubernetes/"/>
    
    <category term="log" scheme="https://blog.sctux.cc/tags/log/"/>
    
  </entry>
  
</feed>
